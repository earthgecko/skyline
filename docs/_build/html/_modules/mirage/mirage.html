<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mirage.mirage &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mirage.mirage</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mirage.mirage</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">mirage.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="c1"># from redis import StrictRedis</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">strftime</span><span class="p">,</span> <span class="n">gmtime</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
<span class="c1"># Use Redis sets in place of Manager().list() to reduce memory and number of</span>
<span class="c1"># processes</span>
<span class="c1"># from multiprocessing import Process, Manager, Queue</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>
<span class="c1"># from os import kill, getpid</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="c1"># imports required for surfacing graphite JSON formatted timeseries for use in</span>
<span class="c1"># Mirage</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># import errno</span>
<span class="c1"># import imp</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="c1"># import os.path</span>
<span class="kn">import</span> <span class="nn">resource</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">isfile</span>

<span class="c1"># @added 20220722 - Task #4624: Change all dict copy to deepcopy</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="c1"># @added 20220414 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1">#                   Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1"># Added Unpacker</span>
<span class="kn">from</span> <span class="nn">msgpack</span> <span class="kn">import</span> <span class="n">Unpacker</span><span class="p">,</span> <span class="n">packb</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">urlparse</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># @modified 20191113 - Branch #3262: py3</span>
    <span class="c1"># import urllib.parse</span>
    <span class="kn">import</span> <span class="nn">urllib.parse</span> <span class="k">as</span> <span class="nn">urlparse</span>

<span class="kn">import</span> <span class="nn">settings</span>
<span class="c1"># @modified 20160922 - Branch #922: Ionosphere</span>
<span class="c1"># Added the send_anomalous_metric_to skyline_functions.py</span>
<span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">write_data_to_file</span><span class="p">,</span> <span class="n">fail_check</span><span class="p">,</span> <span class="n">send_anomalous_metric_to</span><span class="p">,</span>
    <span class="c1"># @modified 20220726 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                      Branch #4300: prometheus</span>
    <span class="c1"># Moved send_graphite_metric</span>
    <span class="c1"># mkdir_p, send_graphite_metric, filesafe_metricname,</span>
    <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">filesafe_metricname</span><span class="p">,</span>
    <span class="c1"># @added 20170603 - Feature #2034: analyse_derivatives</span>
    <span class="n">nonNegativeDerivative</span><span class="p">,</span> <span class="n">in_list</span><span class="p">,</span>
    <span class="c1"># @added 20191030 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                   Branch #3262: py3</span>
    <span class="c1"># Added a single functions to deal with Redis connection and the</span>
    <span class="c1"># charset=&#39;utf-8&#39;, decode_responses=True arguments required in py3</span>
    <span class="n">get_redis_conn</span><span class="p">,</span> <span class="n">get_redis_conn_decoded</span><span class="p">,</span>
    <span class="c1"># @added 20201009 - Feature #3780: skyline_functions - sanitise_graphite_url</span>
    <span class="c1">#                   Bug #3778: Handle single encoded forward slash requests to Graphite</span>
    <span class="c1"># sanitise_graphite_url,</span>
    <span class="c1"># @added 20201013 - Feature #3780: skyline_functions - sanitise_graphite_url</span>
    <span class="n">encode_graphite_metric_name</span><span class="p">,</span>
    <span class="c1"># @added 20220406 - Feature #4518: settings - LAST_KNOWN_VALUE_NAMESPACES</span>
    <span class="c1">#                   Feature #4520: settings - ZERO_FILL_NAMESPACES</span>
    <span class="n">get_graphite_metric</span><span class="p">,</span>
    <span class="c1"># @added 20220414 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
    <span class="c1">#                   Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
    <span class="n">sort_timeseries</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># @added 20200425 - Feature #3512: matched_or_regexed_in_list function</span>
<span class="c1">#                   Feature #3508: ionosphere.untrainable_metrics</span>
<span class="c1">#                   Feature #3486: analyzer_batch</span>
<span class="kn">from</span> <span class="nn">matched_or_regexed_in_list</span> <span class="kn">import</span> <span class="n">matched_or_regexed_in_list</span>

<span class="kn">from</span> <span class="nn">mirage_alerters</span> <span class="kn">import</span> <span class="n">trigger_alert</span>
<span class="kn">from</span> <span class="nn">negaters</span> <span class="kn">import</span> <span class="n">trigger_negater</span>
<span class="kn">from</span> <span class="nn">mirage_algorithms</span> <span class="kn">import</span> <span class="n">run_selected_algorithm</span>
<span class="kn">from</span> <span class="nn">algorithm_exceptions</span> <span class="kn">import</span> <span class="n">TooShort</span><span class="p">,</span> <span class="n">Stale</span><span class="p">,</span> <span class="n">Boring</span>

<span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
<span class="kn">from</span> <span class="nn">functions.redis.get_test_alerts</span> <span class="kn">import</span> <span class="n">get_test_alerts</span>

<span class="c1"># @added 20220414 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1">#                   Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.determine_data_frequency</span> <span class="kn">import</span> <span class="n">determine_data_frequency</span>
<span class="kn">from</span> <span class="nn">functions.mirage.downsample_full_duration_and_merge_graphite</span> <span class="kn">import</span> <span class="n">downsample_full_duration_and_merge_graphite</span>
<span class="c1"># @modified 20230430 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
<span class="c1"># Not required as downsample_full_duration_and_merge_graphite uses it</span>
<span class="c1"># from functions.timeseries.downsample import downsample_timeseries</span>

<span class="c1"># @added 20220504 - Feature #2580: illuminance</span>
<span class="kn">from</span> <span class="nn">functions.illuminance.add_illuminance_entries</span> <span class="kn">import</span> <span class="n">add_illuminance_entries</span>

<span class="c1"># @added 20220726 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.graphite.send_graphite_metric</span> <span class="kn">import</span> <span class="n">send_graphite_metric</span>

<span class="c1"># @added 20220805 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.metrics.get_base_name_from_labelled_metrics_name</span> <span class="kn">import</span> <span class="n">get_base_name_from_labelled_metrics_name</span>
<span class="kn">from</span> <span class="nn">functions.metrics.get_metric_id_from_base_name</span> <span class="kn">import</span> <span class="n">get_metric_id_from_base_name</span>

<span class="c1"># @added 20221105 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
<span class="kn">from</span> <span class="nn">custom_algorithms</span> <span class="kn">import</span> <span class="n">run_custom_algorithm_on_timeseries</span>

<span class="c1"># @added 20230418 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.normalized_variance</span> <span class="kn">import</span> <span class="n">normalized_variance</span>

<span class="n">LOCAL_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># ENABLE_MEMORY_PROFILING - DEVELOPMENT ONLY</span>
<span class="c1"># @added 20160806 - Bug #1558: Memory leak in Analyzer</span>
<span class="c1"># Added all the memory profiling blocks - mem_top, pympler, objgraph, gc</span>
<span class="c1"># Garbage collection et al, should not be run in anything but development model,</span>
<span class="c1"># therefore these variables are hard coded and not accessible via settings.py,</span>
<span class="c1"># if you are in here reading this then knock yourself out.  gc and dump_garbage</span>
<span class="c1"># can be useful for getting an idea about what all the objects in play are, but</span>
<span class="c1"># garbage collection will just take longer and longer to run.</span>
<span class="n">ENABLE_MEMORY_PROFILING</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">garbage_collection_enabled</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">ENABLE_MEMORY_PROFILING</span><span class="p">:</span>
    <span class="c1"># @added 20160806 - Bug #1558: Memory leak in Analyzer</span>
    <span class="c1"># As per http://stackoverflow.com/a/1641280</span>
    <span class="c1"># This got useable understandable data</span>
    <span class="k">if</span> <span class="n">garbage_collection_enabled</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">gc</span> <span class="kn">import</span> <span class="n">get_objects</span>
        <span class="c1"># Debug with garbage collection - http://code.activestate.com/recipes/65333/</span>
        <span class="kn">import</span> <span class="nn">gc</span>

<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;mirage&#39;</span>
<span class="n">skyline_app_logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Log&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
<span class="n">skyline_app_logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
<span class="n">skyline_app_loglock</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">skyline_app_logwait</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wait&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>

<span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">this_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
    <span class="k">if</span> <span class="n">SERVER_METRIC_PATH</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">MIRAGE_PERIODIC_CHECK</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_PERIODIC_CHECK</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MIRAGE_PERIODIC_CHECK</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20200413 - Feature #3486: analyzer_batch</span>
<span class="c1">#                   Feature #3480: batch_processing</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="n">BATCH_PROCESSING</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">BATCH_PROCESSING</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20200606 - Bug #3572: Apply list to settings import</span>
    <span class="n">BATCH_PROCESSING_NAMESPACES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BATCH_PROCESSING_NAMESPACES</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">BATCH_PROCESSING_NAMESPACES</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
<span class="c1"># Determine if any metrcs have negatives values some they can be</span>
<span class="c1"># added to the ionosphere.untrainable_metrics Redis set</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20200606 - Bug #3572: Apply list to settings import</span>
    <span class="c1"># from settings import KNOWN_NEGATIVE_METRICS</span>
    <span class="n">KNOWN_NEGATIVE_METRICS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">KNOWN_NEGATIVE_METRICS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">KNOWN_NEGATIVE_METRICS</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20200604 - Mirage - populate_redis</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="n">MIRAGE_AUTOFILL_TOOSHORT</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MIRAGE_AUTOFILL_TOOSHORT</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20200607 - Feature #3566: custom_algorithms</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">CUSTOM_ALGORITHMS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">DEBUG_CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG_CUSTOM_ALGORITHMS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">DEBUG_CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20200723 - Feature #3472: ionosphere.training_data Redis set</span>
<span class="c1">#                   Feature #3566: custom_algorithms</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">MIRAGE_ALWAYS_METRICS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_ALWAYS_METRICS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MIRAGE_ALWAYS_METRICS</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20200610 - Feature #3560: External alert config</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">EXTERNAL_ALERTS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_ALERTS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">EXTERNAL_ALERTS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">if</span> <span class="n">EXTERNAL_ALERTS</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">external_alert_configs</span> <span class="kn">import</span> <span class="n">get_external_alert_configs</span>

<span class="c1"># @added 20200913 - Branch #3068: SNAB</span>
<span class="c1">#                   Task #3744: POC matrixprofile</span>
<span class="c1">#                   Info #1792: Shapelet extraction</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">SNAB_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SNAB_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SNAB_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
    <span class="c1"># SNAB_CHECKS = settings.SNAB_CHECKS.copy()</span>
    <span class="n">SNAB_CHECKS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SNAB_CHECKS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SNAB_CHECKS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
<span class="c1">#                   Task #3744: POC matrixprofile</span>
<span class="n">mirage_snab_only_checks_redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.snab_only_checks&#39;</span>

<span class="c1"># @added 20201026 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
<span class="c1"># Handle feedback metrics in a similar style to Ionosphere</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_FEEDBACK_NAMESPACES</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># Let us take a guess</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">graphite_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">)</span>
        <span class="n">graphite_hostname</span> <span class="o">=</span> <span class="n">graphite_host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span><span class="p">,</span> <span class="n">graphite_hostname</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">=</span> <span class="p">[</span><span class="n">this_host</span><span class="p">]</span>

<span class="c1"># @added 20210701 - Feature #4152: DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20201208 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1">#                   Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1"># @modified 20220414 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1">#                   Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1"># Not introduced as a settings, making this the default behaviour</span>
<span class="c1"># try:</span>
<span class="c1">#     MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS = settings.MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1"># except:</span>
<span class="c1">#     MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS = False</span>
<span class="n">MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># @added 20210323 - Feature #3642: Anomaly type classification</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20221105 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># @added 20221206 - Feature #4734: mirage_vortex</span>
<span class="c1">#                   Feature #4732: flux vortex</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">VORTEX_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VORTEX_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">skyline_app_graphite_namespace</span> <span class="o">=</span> <span class="s1">&#39;skyline.</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">SERVER_METRIC_PATH</span><span class="p">)</span>
<span class="n">failed_checks_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_failed&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span>
<span class="c1"># @added 20191107 - Branch #3262: py3</span>
<span class="n">alert_test_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_alert_test.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>


<div class="viewcode-block" id="Mirage"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage.Mirage">[docs]</a><span class="k">class</span> <span class="nc">Mirage</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Mirage thread</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_pid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Mirage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
        <span class="c1"># super(Mirage, self).__init__()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span> <span class="o">=</span> <span class="n">parent_pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
        <span class="c1">#                      Task #3032: Debug number of Python processes and memory use</span>
        <span class="c1">#                      Branch #3002: docker</span>
        <span class="c1"># Reduce amount of Manager instances that are used as each requires a</span>
        <span class="c1"># copy of entire memory to be copied into each subprocess so this</span>
        <span class="c1"># results in a python process per Manager instance, using as much</span>
        <span class="c1"># memory as the parent.  OK on a server, not so much in a container.</span>
        <span class="c1"># Disabled all the Manager().list() below and replaced with Redis sets</span>
        <span class="c1"># self.anomalous_metrics = Manager().list()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirage_exceptions_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirage_anomaly_breakdown_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="c1"># self.not_anomalous_metrics = Manager().list()</span>
        <span class="c1"># self.metric_variables = Manager().list()</span>
        <span class="c1"># self.ionosphere_metrics = Manager().list()</span>
        <span class="c1"># self.sent_to_crucible = Manager().list()</span>
        <span class="c1"># self.sent_to_panorama = Manager().list()</span>
        <span class="c1"># self.sent_to_ionosphere = Manager().list()</span>
        <span class="c1"># @added 20170603 - Feature #2034: analyse_derivatives</span>
        <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># @modified 20191030 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># Use get_redis_conn and get_redis_conn_decoded to use on Redis sets when the bytes</span>
        <span class="c1"># types need to be decoded as utf-8 to str</span>
        <span class="c1"># if settings.REDIS_PASSWORD:</span>
        <span class="c1">#     self.redis_conn = StrictRedis(</span>
        <span class="c1">#         password=settings.REDIS_PASSWORD,</span>
        <span class="c1">#         unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self.redis_conn = StrictRedis(</span>
        <span class="c1">#         unix_socket_path=settings.REDIS_SOCKET_PATH)</span>

        <span class="c1"># @added 20191030 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                   Branch #3262: py3</span>
        <span class="c1"># Added a single functions to deal with Redis connection and the</span>
        <span class="c1"># charset=&#39;utf-8&#39;, decode_responses=True arguments required in py3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>

<div class="viewcode-block" id="Mirage.check_if_parent_is_alive"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage.Mirage.check_if_parent_is_alive">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_parent_is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Self explanatory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># @added 20201203 - Bug #3856: Handle boring sparsely populated metrics in derivative_metrics</span>
            <span class="c1"># Log warning</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: parent or current process dead&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

    <span class="c1"># @modified 20210304 - Feature #3642: Anomaly type classification</span>
    <span class="c1">#                      Feature #3970: custom_algorithm - adtk_level_shift</span>
    <span class="c1"># Added triggered_algorithms</span>
<div class="viewcode-block" id="Mirage.spawn_alerter_process"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage.Mirage.spawn_alerter_process">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_alerter_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a process to trigger an alert.  This is used by smtp alerters so</span>
<span class="sd">        that matplotlib objects are cleared down and the alerter cannot create</span>
<span class="sd">        a memory leak in this manner and plt.savefig keeps the object in memory</span>
<span class="sd">        until the process terminates.  Seeing as data is being surfaced and</span>
<span class="sd">        processed in the alert_smtp context, multiprocessing the alert creation</span>
<span class="sd">        and handling prevents any memory leaks in the parent.</span>
<span class="sd">        # @added 20160814 - Bug #1558: Memory leak in Analyzer</span>
<span class="sd">        #                   Issue #21 Memory leak in Analyzer</span>
<span class="sd">        # https://github.com/earthgecko/skyline/issues/21</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># @modified 20210304 - Feature #3642: Anomaly type classification</span>
        <span class="c1">#                      Feature #3970: custom_algorithm - adtk_level_shift</span>
        <span class="c1"># Added triggered_algorithms</span>
        <span class="n">trigger_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span></div>

    <span class="c1"># @modified 20201208 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
    <span class="c1">#                      Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
    <span class="c1"># def surface_graphite_metric_data(self, metric_name, graphite_from, graphite_until):</span>
    <span class="c1"># @modified 20201208 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
    <span class="c1">#                      Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
    <span class="c1"># Deprecating self.surface_graphite_metric_data in all mirage functions</span>
    <span class="c1"># (EXCEPT for in populate_redis) so that the same function can be used</span>
    <span class="c1"># for all graphite requests.  get_graphite_metric does the derivative,</span>
    <span class="c1"># zero_fill and last_known_value functions so no longer required here.</span>
    <span class="c1"># @modified 20220414 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
    <span class="c1">#                      Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
    <span class="c1"># Removed high_res parameter and will no longer be used not that the</span>
    <span class="c1"># FULL_DURATION data is being backwards resampled</span>
    <span class="c1"># def surface_graphite_metric_data(self, metric_name, graphite_from, graphite_until, high_res=False):</span>
<div class="viewcode-block" id="Mirage.surface_graphite_metric_data"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage.Mirage.surface_graphite_metric_data">[docs]</a>    <span class="k">def</span> <span class="nf">surface_graphite_metric_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">graphite_from</span><span class="p">,</span> <span class="n">graphite_until</span><span class="p">):</span>

        <span class="c1"># @added 20160803 - Unescaped Graphite target - https://github.com/earthgecko/skyline/issues/20</span>
        <span class="c1">#                   bug1546: Unescaped Graphite target</span>
        <span class="c1"># @modified 20191107 - Branch #3263: py3</span>
        <span class="c1"># Commented out colon</span>
        <span class="c1"># new_metric_namespace = metric_name.replace(&#39;:&#39;, &#39;\:&#39;)</span>
        <span class="c1"># metric_namespace = new_metric_namespace.replace(&#39;(&#39;, &#39;\(&#39;)</span>
        <span class="n">metric_namespace</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">(&#39;</span><span class="p">)</span>
        <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_namespace</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20201013 - Feature #3780: skyline_functions - sanitise_graphite_url</span>
        <span class="n">encoded_graphite_metric_name</span> <span class="o">=</span> <span class="n">encode_graphite_metric_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># We use absolute time so that if there is a lag in mirage the correct</span>
            <span class="c1"># timeseries data is still surfaced relevant to the anomalous datapoint</span>
            <span class="c1"># timestamp</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="c1"># @modified 20190520 - Branch #3002: docker</span>
                <span class="c1"># Use GRAPHITE_RENDER_URI</span>
                <span class="c1"># url = &#39;%s://%s:%s/render/?from=%s&amp;until=%s&amp;target=%s&amp;format=json&#39; % (</span>
                <span class="c1">#     settings.GRAPHITE_PROTOCOL, settings.GRAPHITE_HOST,</span>
                <span class="c1">#     str(settings.GRAPHITE_PORT), graphite_from, graphite_until,</span>
                <span class="c1">#     metric_name)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/?from=</span><span class="si">%s</span><span class="s1">&amp;until=</span><span class="si">%s</span><span class="s1">&amp;target=</span><span class="si">%s</span><span class="s1">&amp;format=json&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span><span class="p">),</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_RENDER_URI</span><span class="p">,</span>
                    <span class="c1"># @modified 20201013 - Feature #3780: skyline_functions - sanitise_graphite_url</span>
                    <span class="c1"># graphite_from, graphite_until, metric_name)</span>
                    <span class="n">graphite_from</span><span class="p">,</span> <span class="n">graphite_until</span><span class="p">,</span> <span class="n">encoded_graphite_metric_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># @modified 20190520 - Branch #3002: docker</span>
                <span class="c1"># Use GRAPHITE_RENDER_URI</span>
                <span class="c1"># url = &#39;%s://%s/render/?from=%s&amp;until=%s&amp;target=%s&amp;format=json&#39; % (</span>
                <span class="c1">#     settings.GRAPHITE_PROTOCOL, settings.GRAPHITE_HOST,</span>
                <span class="c1">#     graphite_from, graphite_until, metric_name)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/?from=</span><span class="si">%s</span><span class="s1">&amp;until=</span><span class="si">%s</span><span class="s1">&amp;target=</span><span class="si">%s</span><span class="s1">&amp;format=json&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">,</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_RENDER_URI</span><span class="p">,</span> <span class="n">graphite_from</span><span class="p">,</span> <span class="n">graphite_until</span><span class="p">,</span>
                    <span class="c1"># @modified 20201013 - Feature #3780: skyline_functions - sanitise_graphite_url</span>
                    <span class="c1"># metric_name)</span>
                    <span class="n">encoded_graphite_metric_name</span><span class="p">)</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">js</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">datapoints</span> <span class="o">=</span> <span class="n">js</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datapoints&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: surface_graphite_metric_data :: failed to get data from Graphite&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">converted</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">datapoint</span> <span class="ow">in</span> <span class="n">datapoints</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_datapoint</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                    <span class="n">converted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_datapoint</span><span class="p">)</span>
                <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
                <span class="c1"># Added nosec to exclude from bandit tests</span>
                <span class="k">except</span><span class="p">:</span>  <span class="c1"># nosec</span>
                    <span class="k">continue</span>

            <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">query</span><span class="p">)[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">metric_data_folder</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_DATA_FOLDER</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">target</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">metric_data_folder</span><span class="p">)</span>

            <span class="c1"># @added 20201208 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
            <span class="c1">#                   Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
            <span class="c1"># @modified 20220414 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
            <span class="c1">#                      Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
            <span class="c1"># No longer used</span>
            <span class="c1"># if high_res:</span>
            <span class="c1">#     with open(metric_data_folder + &quot;/&quot; + target + &#39;.high_res&#39;, &#39;w&#39;) as f:</span>
            <span class="c1">#         f.write(json.dumps(converted))</span>
            <span class="c1">#         f.close()</span>
            <span class="c1">#         return True</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_data_folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">converted</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: surface_graphite_metric_data :: failed to convert Graphite data and write to file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1"># @added 20170127 - Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
    <span class="c1">#                   Bug #1460: panorama check file fails</span>
    <span class="c1">#                   Panorama check file fails #24</span>
    <span class="c1"># Get rid of the skyline_functions imp as imp is deprecated in py3 anyway</span>
<div class="viewcode-block" id="Mirage.mirage_load_metric_vars"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage.Mirage.mirage_load_metric_vars">[docs]</a>    <span class="k">def</span> <span class="nf">mirage_load_metric_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_vars_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the metric variables for a check from a metric check variables file</span>

<span class="sd">        :param metric_vars_file: the path and filename to the metric variables files</span>
<span class="sd">        :type metric_vars_file: str</span>
<span class="sd">        :return: the metric_vars list or ``False``</span>
<span class="sd">        :rtype: list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;loading metric variables from metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: loading metric variables from metric_check_file - file not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">metric_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">no_new_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">no_equal_line</span> <span class="o">=</span> <span class="n">no_new_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; = &#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">array</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">no_equal_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">add_line</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                <span class="n">metric_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_line</span><span class="p">)</span>

        <span class="c1"># @added 20200429 - Feature #3486: analyzer_batch</span>
        <span class="c1">#                   Feature #3480: batch_processing</span>
        <span class="c1"># Allow the check file to already hold a valid python list on one line</span>
        <span class="c1"># so that a check can be added by simply echoing to debug metric_vars</span>
        <span class="c1"># line from to log for any failed checks into a new Mirage check file</span>
        <span class="c1"># The original above pattern is still the default, this is for the check</span>
        <span class="c1"># files to be added by the operator from the log or for debugging.</span>
        <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">metric_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_vars is not a list, set to try_literal_eval&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_vars</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_vars is not a list of lists, set to try_literal_eval&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_vars is not defined, set to try_literal_eval&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">try_literal_eval</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">metric_vars</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metric_vars</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metric_vars not loaded with literal_eval&#39;</span><span class="p">)</span>
                <span class="n">metric_vars</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">string_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
        <span class="n">float_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">int_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_timestamp&#39;</span><span class="p">]</span>
        <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
        <span class="c1">#                   Task #3744: POC matrixprofile</span>
        <span class="n">boolean_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snab_only_check&#39;</span><span class="p">]</span>

        <span class="c1"># @added 20210304 - Feature #3642: Anomaly type classification</span>
        <span class="c1">#                   Feature #3970: custom_algorithm - adtk_level_shift</span>
        <span class="c1"># Added triggered_algorithms to mirage_check_file</span>
        <span class="n">list_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">]</span>

        <span class="n">metric_vars_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars</span><span class="p">:</span>
            <span class="c1"># @modified 20181023 - Feature #2618: alert_slack</span>
            <span class="c1"># Wrapped in try except for debugging issue where the</span>
            <span class="c1"># hours_to_resolve was interpolating to hours_to_resolve = &quot;t&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">string_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_value_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">float_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_value_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">int_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_value_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">))</span>
                <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
                <span class="c1">#                   Task #3744: POC matrixprofile</span>
                <span class="c1"># Handle new snab_only_check boolean</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">boolean_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;debug :: boolean key - key: </span><span class="si">%s</span><span class="s1">, value: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;&quot;True&quot;&#39;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20210304 - Feature #3642: Anomaly type classification</span>
                <span class="c1">#                   Feature #3970: custom_algorithm - adtk_level_shift</span>
                <span class="c1"># Added triggered_algorithms to mirage_check_file</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">list_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;debug :: list key - key: </span><span class="si">%s</span><span class="s1">, value: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                    <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;error :: loading metric variables - failed to literal_eval list for </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">e</span><span class="p">))</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">metric_vars_array</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_vars_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;error :: loading metric variables - none found from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load metric variables from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_vars_file</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric_vars for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_array</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">metric_vars_array</span></div>

<div class="viewcode-block" id="Mirage.dump_garbage"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage.Mirage.dump_garbage">[docs]</a>    <span class="k">def</span> <span class="nf">dump_garbage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DEVELOPMENT ONLY</span>

<span class="sd">        # @added 20160806 - Bug #1558: Memory leak in Analyzer</span>
<span class="sd">        # Debug with garbage collection - http://code.activestate.com/recipes/65333/</span>

<span class="sd">        show us what&#39;s the garbage about</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ENABLE_MEMORY_PROFILING</span> <span class="ow">and</span> <span class="n">garbage_collection_enabled</span><span class="p">:</span>
            <span class="c1"># force collection</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span> <span class="ow">or</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: GARBAGE&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="n">gc_collect_ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: gc.collect failed&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">gc_collect_ok</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">gc_collect_ok</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span> <span class="ow">or</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: GARBAGE OBJECTS&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gc</span><span class="o">.</span><span class="n">garbage</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="mi">80</span><span class="p">]</span>
                    <span class="c1"># print type(x), &quot;\n  &quot;, s</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">log_string</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="p">,</span> <span class="n">s</span>
                        <span class="n">log_string</span> <span class="o">=</span> <span class="s1">&#39;unused variable for testing only&#39;</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: print x and s&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span> <span class="ow">or</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<span class="c1"># @added 20200604 - Mirage - populate_redis</span>
<div class="viewcode-block" id="Mirage.populate_redis"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage.Mirage.populate_redis">[docs]</a>    <span class="k">def</span> <span class="nf">populate_redis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get FULL_DURATION data from Graphite for a metric and populate Redis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if it has been done via the mirage.redis_populate key</span>
        <span class="n">redis_populated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">redis_populated_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.redis_populated.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">redis_populated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_populated_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: populate_redis :: could not query cache_key - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">redis_populated_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">redis_populated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Do not handle batch processing metrics</span>
        <span class="n">batch_processing_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20220113 - Feature #4328: BATCH_METRICS_CUSTOM_FULL_DURATIONS</span>
            <span class="c1"># Use aet.analyzer.batch_processing_metrics</span>
            <span class="c1"># batch_processing_metrics = list(self.redis_conn_decoded.smembers(&#39;analyzer.batch_processing_metrics&#39;))</span>
            <span class="n">batch_processing_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.batch_processing_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed to get analyzer.batch_processing_metrics from Redis&#39;</span><span class="p">)</span>
            <span class="n">batch_processing_metrics</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">batch_processing_metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">batch_processing_metrics</span><span class="p">:</span>
                <span class="n">redis_populated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: </span><span class="si">%s</span><span class="s1"> is a batch processing metric, not handling, creating Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="n">redis_populated_key</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_populated_key</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: created Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_populated_key</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed to create Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_populated_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">redis_populated</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: the Redis key </span><span class="si">%s</span><span class="s1"> already exists, it has been done&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_populated_key</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;mirage.populate_redis&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: removed item - </span><span class="si">%s</span><span class="s1"> - from Redis set mirage.populate_redis&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed to remove item </span><span class="si">%s</span><span class="s1"> from Redis set mirage.populate_redis&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">time_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
        <span class="n">time_from</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_now</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">)</span>
        <span class="c1"># Calculate graphite from and until parameters from the metric timestamp</span>
        <span class="n">graphite_until</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">time_now</span><span class="p">)))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">graphite_from</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time_from</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Remove any old json file related to the metric</span>
        <span class="n">metric_data_folder</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_DATA_FOLDER</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="n">metric_json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_folder</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Get data from graphite</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: surfacing </span><span class="si">%s</span><span class="s1"> time series from Graphite&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20220406 - Feature #4518: settings - LAST_KNOWN_VALUE_NAMESPACES</span>
            <span class="c1">#                      Feature #4520: settings - ZERO_FILL_NAMESPACES</span>
            <span class="c1"># The self.surface_graphite_metric_data is used here because the</span>
            <span class="c1"># get_graphite_metric function automatically applies</span>
            <span class="c1"># nonNegativeDerivative to a metric if it is a derivative_metric and</span>
            <span class="c1"># in the context of populating Redis, that is not desired</span>
            <span class="c1"># @modified 20230616</span>
            <span class="c1"># Deprecate self.surface_graphite_metric_data in mirage so that the</span>
            <span class="c1"># same function can be used for all graphite requests</span>
            <span class="c1"># self.surface_graphite_metric_data(metric, graphite_from, graphite_until)</span>
            <span class="n">metric_json_file_saved</span> <span class="o">=</span> <span class="n">get_graphite_metric</span><span class="p">(</span>
                <span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">graphite_from</span><span class="p">,</span>
                <span class="n">graphite_until</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">metric_json_file</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: get_graphite_metric failed to surface_graphite_metric_data to populate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">)))</span>
        <span class="c1"># Check there is a json timeseries file to use</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: populate_redis :: retrieve failed - failed to surface </span><span class="si">%s</span><span class="s1"> time series from graphite&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_populated_key</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">,</span> <span class="n">time_now</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: created Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_populated_key</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed to create Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_populated_key</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;mirage.populate_redis&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: removed item - </span><span class="si">%s</span><span class="s1"> - from Redis set mirage.populate_redis&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed to remove item </span><span class="si">%s</span><span class="s1"> from Redis set mirage.populate_redis&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: retrieved data :: for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">metric</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_if_parent_is_alive</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">((</span><span class="n">metric_json_file</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed to get timeseries from json - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_json_file</span><span class="p">)</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: no timeseries data for </span><span class="si">%s</span><span class="s1">, setting redis_populated_key and removing from mirage.populate_redis&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_populated_key</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">,</span> <span class="n">time_now</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: created Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_populated_key</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed to create Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_populated_key</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;mirage.populate_redis&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: removed item - </span><span class="si">%s</span><span class="s1"> - from Redis set mirage.populate_redis&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed to remove item </span><span class="si">%s</span><span class="s1"> from Redis set mirage.populate_redis&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">FULL_NAMESPACE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span>
        <span class="n">pipe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: time series data for </span><span class="si">%s</span><span class="s1">, populating Redis with </span><span class="si">%s</span><span class="s1"> data points&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">))))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: error on Redis pipe: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">redis_populated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric_data</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pipe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">packb</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: error on pipe.append: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">redis_populated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: error on pipe.execute: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">redis_populated</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">timeseries</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_populated_key</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">,</span> <span class="n">time_now</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: created Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_populated_key</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed to create Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_populated_key</span><span class="p">)</span>
            <span class="c1"># Add to Redis set so that Analyzer sorts and deduplicates the data</span>
            <span class="c1"># on the next run</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;mirage.filled&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: add </span><span class="si">%s</span><span class="s1"> to Redis set mirage.filled for Analyzer to sort and deduplicate the Redis data&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed add metric to Redis set mirage.filled: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_populated_key</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">,</span> <span class="n">time_now</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: created Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_populated_key</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed to create Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_populated_key</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;mirage.populate_redis&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis :: removed item - </span><span class="si">%s</span><span class="s1"> - from Redis set mirage.populate_redis&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: populate_redis :: failed to remove item </span><span class="si">%s</span><span class="s1"> from Redis set mirage.populate_redis&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">return</span></div>

    <span class="c1"># @modified 20200909 - Task #3730: Validate Mirage running multiple processes</span>
    <span class="c1"># def spin_process(self, i, run_timestamp):</span>
    <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
    <span class="c1"># def spin_process(self, i, run_timestamp, metric_check_filename):</span>
<div class="viewcode-block" id="Mirage.spin_process"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage.Mirage.spin_process">[docs]</a>    <span class="k">def</span> <span class="nf">spin_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">run_timestamp</span><span class="p">,</span> <span class="n">processing_check_files</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign a metric for a process to analyze.</span>
<span class="sd">        &quot;&quot;&quot;</span>

<span class="c1">#        if int(i) &gt; 1:</span>
<span class="c1">#            i_less_one = int(i) - 1</span>
<span class="c1">#            sleep_for_str = &#39;0.%s&#39; % str(i_less_one)</span>
<span class="c1">#            logger.info(&#39;process %s sleeping for %s&#39; % (str(i), sleep_for_str))</span>
<span class="c1">#            sleep(float(sleep_for_str))</span>

        <span class="c1"># Discover metric to analyze</span>
<span class="c1">#        metric_var_files = [f for f in listdir(settings.MIRAGE_CHECK_PATH) if isfile(join(settings.MIRAGE_CHECK_PATH, f))]</span>

        <span class="c1"># Check if this process is unnecessary</span>
<span class="c1">#        if len(metric_var_files) == 0:</span>
<span class="c1">#            logger.info(&#39;no check files found, nothing to do&#39;)</span>
<span class="c1">#            return</span>

        <span class="c1"># metric_var_files_sorted = sorted(metric_var_files)</span>

        <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
        <span class="c1"># Ensure the process locks the check</span>
<span class="c1">#        metric_check_filename = None</span>
<span class="c1">#        for i_metric_check_file in metric_var_files_sorted:</span>
<span class="c1">#            check_assigned = False</span>
<span class="c1">#            cache_key = &#39;mirage.check.lock.%s&#39; % str(i_metric_check_file)</span>
<span class="c1">#            try:</span>
<span class="c1">#                check_assigned = self.redis_conn.get(cache_key)</span>
<span class="c1">#                if not check_assigned:</span>
<span class="c1">#                    try:</span>
<span class="c1">#                        self.redis_conn.setex(cache_key, 120, int(time()))</span>
<span class="c1">#                        metric_check_filename = str(i_metric_check_file)</span>
<span class="c1">#                        logger.info(&#39;assigned self check file and set Redis key - %s&#39; % (cache_key))</span>
<span class="c1">#                        self.redis_conn.sadd(&#39;mirage.checks.done&#39;, metric_check_filename)</span>
<span class="c1">#                        break</span>
<span class="c1">#                    except:</span>
<span class="c1">#                        logger.error(traceback.format_exc())</span>
<span class="c1">#                        logger.error(&#39;error :: failed to set Redis key - %s&#39; % cache_key)</span>
<span class="c1">#                else:</span>
<span class="c1">#                    logger.info(&#39;already assigned, Redis key exists - %s&#39; % (cache_key))</span>
<span class="c1">#</span>
<span class="c1">#            except:</span>
<span class="c1">#                logger.error(traceback.format_exc())</span>
<span class="c1">#                logger.error(&#39;error :: failed to check if Redis key exists - %s&#39; % cache_key)</span>

        <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
        <span class="c1"># if not metric_check_filename:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">processing_check_files</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no check to assign to process, nothing to do&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;assigned </span><span class="si">%s</span><span class="s1"> checks to process&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processing_check_files</span><span class="p">)))</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">mirage_periodic_check_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">MIRAGE_PERIODIC_CHECK</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mirage_periodic_check_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage.periodic_check.metrics&#39;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get mirage_periodic_check_metrics from Redis&#39;</span><span class="p">)</span>
                <span class="n">mirage_periodic_check_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">non_derivative_monotonic_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">NON_DERIVATIVE_MONOTONIC_METRICS</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">non_derivative_monotonic_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.unique_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
        <span class="k">for</span> <span class="n">metric_check_filename</span> <span class="ow">in</span> <span class="n">processing_check_files</span><span class="p">:</span>
            <span class="n">metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># settings.MIRAGE_CHECK_PATH, str(metric_var_files_sorted[0]))</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">,</span> <span class="n">metric_check_filename</span><span class="p">)</span>

            <span class="n">check_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">check_file_timestamp</span> <span class="o">=</span> <span class="n">check_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">check_file_metricname_txt</span> <span class="o">=</span> <span class="n">check_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">check_file_metricname</span> <span class="o">=</span> <span class="n">check_file_metricname_txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">check_file_metricname_dir</span> <span class="o">=</span> <span class="n">check_file_metricname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">metric_failed_check_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">failed_checks_dir</span><span class="p">,</span> <span class="n">check_file_metricname_dir</span><span class="p">,</span> <span class="n">check_file_timestamp</span><span class="p">)</span>

            <span class="c1"># Load metric variables</span>
            <span class="c1"># @modified 20160822 - Bug #1460: panorama check file fails</span>
            <span class="c1"># Changed to panorama style skyline_functions load_metric_vars</span>
            <span class="c1"># self.load_metric_vars(metric_check_file)</span>
            <span class="c1"># Load and validate metric variables</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20170127 - Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
                <span class="c1">#                      Bug #1460: panorama check file fails</span>
                <span class="c1">#                      Panorama check file fails #24</span>
                <span class="c1"># Get rid of the skyline_functions imp as imp is deprecated in py3 anyway</span>
                <span class="c1"># metric_vars = load_metric_vars(skyline_app, str(metric_check_file))</span>
                <span class="n">metric_vars_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirage_load_metric_vars</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load metric variables from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># return</span>
                <span class="k">continue</span>

            <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20200106 - Branch #3262: py3</span>
            <span class="c1">#                   Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
            <span class="c1"># redis_set_to_delete = &#39;mirage.metric_variables&#39;</span>
            <span class="n">redis_metric_variables_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.</span><span class="si">%s</span><span class="s1">.metric_variables&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">redis_set_to_delete</span> <span class="o">=</span> <span class="n">redis_metric_variables_set</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">redis_set_to_delete</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;deleted Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to delete Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;metric&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metric_name&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">]</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.metric_variables.append(metric_name)</span>
                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.metric_variables&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># self.redis_conn.sadd(redis_set, data)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_metric_variables_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: added metric_name </span><span class="si">%s</span><span class="s1"> from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read metric variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># return</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load metric variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># return</span>
                <span class="k">continue</span>

            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">metric_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metric_value&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.metric_variables.append(metric_value)</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.metric_variables&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># self.redis_conn.sadd(redis_set, data)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_metric_variables_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read value variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># return</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="c1"># @modified 20181119 - Bug #2708: Failing to load metric vars</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load value variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                    <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                    <span class="c1"># return</span>
                    <span class="k">continue</span>

            <span class="n">hours_to_resolve</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;hours_to_resolve&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">hours_to_resolve</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">hours_to_resolve_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">,</span> <span class="n">hours_to_resolve</span><span class="p">]</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.metric_variables.append(hours_to_resolve_list)</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.metric_variables&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hours_to_resolve_list</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># self.redis_conn.sadd(redis_set, data)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_metric_variables_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read hours_to_resolve variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># return</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hours_to_resolve</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load hours_to_resolve variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># return</span>
                <span class="k">continue</span>

            <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;metric_timestamp&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">metric_timestamp_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metric_timestamp&#39;</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">]</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.metric_variables.append(metric_timestamp_list)</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.metric_variables&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp_list</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># self.redis_conn.sadd(redis_set, data)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_metric_variables_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read metric_timestamp variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># return</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load metric_timestamp variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># return</span>
                <span class="k">continue</span>

            <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
            <span class="c1">#                   Task #3744: POC matrixprofile</span>
            <span class="n">snab_only_check</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;snab_only_check&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">snab_only_check</span> <span class="o">=</span> <span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">snab_only_check</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">snab_only_check_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snab_only_check&#39;</span><span class="p">,</span> <span class="n">snab_only_check</span><span class="p">]</span>
            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.metric_variables&#39;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_only_check_list</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_metric_variables_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

            <span class="c1"># @added 20210304 - Feature #3642: Anomaly type classification</span>
            <span class="c1">#                   Feature #3970: custom_algorithm - adtk_level_shift</span>
            <span class="c1"># Added triggered_algorithms to mirage_check_file</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;triggered_algorithms&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>

            <span class="c1"># Ignore any metric check with a timestamp greater than MIRAGE_STALE_SECONDS</span>
            <span class="n">int_metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span>
            <span class="n">int_run_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">run_timestamp</span><span class="p">)</span>
            <span class="n">metric_timestamp_age</span> <span class="o">=</span> <span class="n">int_run_timestamp</span> <span class="o">-</span> <span class="n">int_metric_timestamp</span>

            <span class="n">periodic_mirage_check</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">MIRAGE_PERIODIC_CHECK</span><span class="p">:</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># Only call once</span>
                <span class="c1"># try:</span>
                <span class="c1">#     mirage_periodic_check_metrics = list(self.redis_conn_decoded.smembers(&#39;mirage.periodic_check.metrics&#39;))</span>
                <span class="c1"># except:</span>
                <span class="c1">#     logger.error(&#39;error :: failed to get mirage_periodic_check_metrics from Redis&#39;)</span>
                <span class="c1">#     mirage_periodic_check_metrics = []</span>
                <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">mirage_periodic_check_metrics</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;this is a periodic Mirage check for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                    <span class="n">periodic_mirage_check</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># @added 20200413 - Feature #3486: analyzer_batch</span>
            <span class="c1">#                   Feature #3480: batch_processing</span>
            <span class="c1"># Do not evaluate batch metrics against MIRAGE_STALE_SECONDS</span>
            <span class="k">if</span> <span class="n">BATCH_PROCESSING</span><span class="p">:</span>
                <span class="c1"># Is this a analyzer_batch related anomaly</span>
                <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">analyzer_batch_metric_anomaly_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_batch.anomaly.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># analyzer_batch_anomaly = self.redis_conn.get(analyzer_batch_metric_anomaly_key)</span>
                    <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;error :: could not query cache_key - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">analyzer_batch_anomaly</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;batch processing - identified as an analyzer_batch triggered anomaly from the presence of the Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;batch processing - not identified as an analyzer_batch triggered anomaly as no Redis key found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">analyzer_batch_anomaly</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;batch processing - setting metric_timestamp_age from </span><span class="si">%s</span><span class="s1"> to 1 so that will not be discarded as stale on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp_age</span><span class="p">),</span> <span class="n">metric</span><span class="p">))</span>
                    <span class="n">metric_timestamp_age</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">metric_timestamp_age</span> <span class="o">&gt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_STALE_SECONDS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;stale check :: </span><span class="si">%s</span><span class="s1"> check request is </span><span class="si">%s</span><span class="s1"> seconds old - discarding&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp_age</span><span class="p">)))</span>
                <span class="c1"># Remove metric check file</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;could not remove check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>

                <span class="c1"># Remove the metric directory</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rmtree</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed data dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to rmtree - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>

                <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.stale_check_discarded&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># return</span>
                <span class="k">continue</span>

            <span class="c1"># Calculate hours second order resolution to seconds</span>
            <span class="n">second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hours_to_resolve</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>

            <span class="c1"># Calculate graphite from and until parameters from the metric timestamp</span>
            <span class="n">graphite_until</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">int_second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">))</span>
            <span class="n">second_resolution_timestamp</span> <span class="o">=</span> <span class="n">int_metric_timestamp</span> <span class="o">-</span> <span class="n">int_second_order_resolution_seconds</span>
            <span class="n">graphite_from</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">second_resolution_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Remove any old json file related to the metric</span>
            <span class="n">metric_json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Get data from graphite</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;retrieve data :: surfacing </span><span class="si">%s</span><span class="s1"> time series from graphite for </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">)))</span>

            <span class="c1"># @modified 20191113 - Branch #3262: py3</span>
            <span class="c1"># Wrapped in try</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20220406 - Feature #4518: settings - LAST_KNOWN_VALUE_NAMESPACES</span>
                <span class="c1">#                      Feature #4520: settings - ZERO_FILL_NAMESPACES</span>
                <span class="c1"># Deprecate self.surface_graphite_metric_data in mirage so that the</span>
                <span class="c1"># same function can be used for all graphite requests</span>
                <span class="c1"># self.surface_graphite_metric_data(metric, graphite_from, graphite_until)</span>
                <span class="n">metric_json_file_saved</span> <span class="o">=</span> <span class="n">get_graphite_metric</span><span class="p">(</span>
                    <span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">second_resolution_timestamp</span><span class="p">,</span>
                    <span class="n">metric_timestamp</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">metric_json_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_json_file_saved</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> time series data saved&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_graphite_metric failed to surface_graphite_metric_data to populate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">)))</span>

            <span class="c1"># Check there is a json timeseries file to test</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: retrieve failed - failed to surface </span><span class="si">%s</span><span class="s1"> time series from graphite&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">metric</span><span class="p">))</span>

                <span class="c1"># @added 20200905 - Feature #3734: waterfall alerts</span>
                <span class="c1"># Try a metric 3 times before removing the check file</span>
                <span class="n">remove_check_file</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">check_failed_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.check.data_retrieval_failed.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fail_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">check_failed_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fail_count</span><span class="p">:</span>
                    <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">fail_count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">remove_check_file</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">check_failed_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="n">fail_count</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;updated fail_count to </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fail_count</span><span class="p">),</span> <span class="n">check_failed_key</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to set Redis key </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">check_failed_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fail_count</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: fail_count is </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">, removing check file&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fail_count</span><span class="p">),</span> <span class="n">check_failed_key</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">remove_check_file</span><span class="p">:</span>
                    <span class="c1"># Remove metric check file</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Remove the metric directory</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rmtree</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed data dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to rmtree </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>

                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># return</span>
                <span class="k">continue</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;retrieved data :: for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">)))</span>

            <span class="c1"># Make process-specific dicts</span>
            <span class="n">exceptions</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">anomaly_breakdown</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">check_if_parent_is_alive</span><span class="p">()</span>

            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">((</span><span class="n">metric_json_file</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;data points surfaced :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">))))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to create timeseries from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># @added 20170212 - Feature #1886: Ionosphere learn</span>
            <span class="c1"># Only process if the metric has sufficient data</span>
            <span class="n">first_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">first_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not determine first timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">timestamp_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="n">valid_if_before_timestamp</span> <span class="o">=</span> <span class="n">timestamp_now</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">)</span>
            <span class="n">valid_mirage_timeseries</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">first_timestamp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">first_timestamp</span> <span class="o">&gt;</span> <span class="n">valid_if_before_timestamp</span><span class="p">:</span>
                    <span class="n">valid_mirage_timeseries</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">valid_mirage_timeseries</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: no first_timestamp, valid_mirage_timeseries: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">valid_mirage_timeseries</span><span class="p">))</span>

            <span class="c1"># @added 20170603 - Feature #2034: analyse_derivatives</span>
            <span class="c1"># Convert the values of metrics strictly increasing monotonically</span>
            <span class="c1"># to their deriative products</span>
            <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
            <span class="c1"># Only call once</span>
            <span class="c1"># try:</span>
            <span class="c1">#     # @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#     #                      Branch #3262: py3</span>
            <span class="c1">#     # derivative_metrics = list(self.redis_conn.smembers(&#39;derivative_metrics&#39;))</span>
            <span class="c1">#     # @modified 20211012 - Feature #4280: aet.metrics_manager.derivative_metrics Redis hash</span>
            <span class="c1">#     # derivative_metrics = list(self.redis_conn_decoded.smembers(&#39;derivative_metrics&#39;))</span>
            <span class="c1">#     derivative_metrics = list(self.redis_conn_decoded.smembers(&#39;aet.metrics_manager.derivative_metrics&#39;))</span>
            <span class="c1"># except:</span>
            <span class="c1">#     derivative_metrics = []</span>
            <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">derivative_metrics</span><span class="p">:</span>
                <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># Only call once</span>
                <span class="c1"># try:</span>
                <span class="c1">#     # @modified 20200606 - Bug #3572: Apply list to settings import</span>
                <span class="c1">#     non_derivative_monotonic_metrics = list(settings.NON_DERIVATIVE_MONOTONIC_METRICS)</span>
                <span class="c1"># except:</span>
                <span class="c1">#     non_derivative_monotonic_metrics = []</span>
                <span class="n">skip_derivative</span> <span class="o">=</span> <span class="n">in_list</span><span class="p">(</span><span class="n">redis_metric_name</span><span class="p">,</span> <span class="n">non_derivative_monotonic_metrics</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">skip_derivative</span><span class="p">:</span>
                    <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># @modified 20220406 - Feature #4518: settings - LAST_KNOWN_VALUE_NAMESPACES</span>
            <span class="c1">#                      Feature #4520: settings - ZERO_FILL_NAMESPACES</span>
            <span class="c1"># Deprecate self.surface_graphite_metric_data in mirage so that the</span>
            <span class="c1"># same function can be used for all graphite requests.</span>
            <span class="c1"># get_graphite_metric does the derivative, zero_fill and last_known_value</span>
            <span class="c1"># functions so no longer required here.</span>
            <span class="n">check_for_derivative</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">check_for_derivative</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">known_derivative_metric</span> <span class="ow">and</span> <span class="n">valid_mirage_timeseries</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">derivative_timeseries</span> <span class="o">=</span> <span class="n">nonNegativeDerivative</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">derivative_timeseries</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: nonNegativeDerivative failed&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
            <span class="c1">#                   Task #3744: POC matrixprofile</span>
            <span class="k">if</span> <span class="n">snab_only_check</span><span class="p">:</span>
                <span class="n">snab_recheck_key</span> <span class="o">=</span> <span class="s1">&#39;snab.recheck.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>
                <span class="n">snab_recheck_key_exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">snab_recheck_key_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">snab_recheck_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">snab_recheck_key</span><span class="p">))</span>
                <span class="n">original_added_at</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">snab_recheck_key_exists</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;snab recheck key exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">snab_recheck_key</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">original_added_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">snab_recheck_key_exists</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="c1"># The key expired</span>
                        <span class="n">original_added_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="mi">300</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;snab recheck key does not exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">snab_recheck_key</span><span class="p">)</span>

                <span class="n">snab_recheck_original_anomaly_timestamp_key</span> <span class="o">=</span> <span class="s1">&#39;snab.recheck.anomaly_timestamp.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>
                <span class="n">snab_recheck_original_anomaly_timestamp_key_exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">snab_recheck_original_anomaly_timestamp_key_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">snab_recheck_original_anomaly_timestamp_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">snab_recheck_key</span><span class="p">))</span>
                <span class="n">original_anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">snab_recheck_original_anomaly_timestamp_key_exists</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;snab.recheck.anomaly_timestamp key exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">snab_recheck_original_anomaly_timestamp_key</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">original_anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">snab_recheck_original_anomaly_timestamp_key_exists</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="c1"># The key expired</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;snab.recheck.anomaly_timestamp key does not exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">snab_recheck_original_anomaly_timestamp_key</span><span class="p">)</span>

                <span class="n">snab_json_file_created</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">snab_recheck_key_exists</span> <span class="ow">and</span> <span class="n">snab_recheck_original_anomaly_timestamp_key_exists</span><span class="p">:</span>
                    <span class="c1"># Create timeseries json file with the timeseries</span>
                    <span class="n">use_snab_timestamp</span> <span class="o">=</span> <span class="n">metric_timestamp</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">use_snab_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">snab_json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="c1"># settings.SNAB_DATA_DIR, str(int(metric_timestamp)), str(metric))</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">SNAB_DATA_DIR</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">use_snab_timestamp</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                    <span class="n">timeseries_json</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">snab_data_last_datapoint</span> <span class="o">=</span> <span class="p">[</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">snab_data_last_datapoint</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;there was no timeseries data&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">timeseries_json</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">write_data_to_file</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">snab_json_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">timeseries_json</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added snab timeseries file with last entry - </span><span class="si">%s</span><span class="s1"> :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">snab_data_last_datapoint</span><span class="p">),</span> <span class="n">snab_json_file</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="s1">&#39;error :: failed to add snab timeseries file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                <span class="n">snab_json_file</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">snab_json_file</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - the snab_json_file was not created - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">snab_json_file</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;snab_json_file exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">snab_json_file</span><span class="p">)</span>
                            <span class="n">snab_json_file_created</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;error :: no timeseries_json to add snab timeseries file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="n">snab_json_file</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not adding snab_json_file as snab recheck keys no longer not exist&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">snab_json_file_created</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                        <span class="s1">&#39;anomaly_data&#39;</span><span class="p">:</span> <span class="n">snab_json_file</span><span class="p">,</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="s1">&#39;original_anomaly_timestamp&#39;</span><span class="p">:</span> <span class="n">original_anomaly_timestamp</span><span class="p">,</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s1">&#39;original_added_at&#39;</span><span class="p">:</span> <span class="n">original_added_at</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">mirage_snab_only_checks_redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mirage_snab_only_checks_redis_set</span><span class="p">)))</span>
                <span class="c1"># Remove metric check file</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># Remove the metric directory</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rmtree</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed data dir for snab_check_only - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to rmtree for snab_check_only - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># return</span>
                <span class="k">continue</span>

            <span class="c1"># @added 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
            <span class="c1"># Determine if any metrcs have negatives values some they can be</span>
            <span class="c1"># added to the ionosphere.untrainable_metrics Redis set</span>
            <span class="n">run_negatives_present</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_ENABLED</span> <span class="ow">and</span> <span class="n">valid_mirage_timeseries</span><span class="p">:</span>
                <span class="n">run_negatives_present</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">known_negative_metric</span><span class="p">,</span> <span class="n">known_negative_metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">KNOWN_NEGATIVE_METRICS</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">known_negative_metric</span><span class="p">:</span>
                    <span class="n">run_negatives_present</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will not check </span><span class="si">%s</span><span class="s1"> for negative values&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will check </span><span class="si">%s</span><span class="s1"> for negative values&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">known_negative_metric_matched_by</span>

            <span class="c1"># @added 20201001 - Branch #3068: SNAB</span>
            <span class="c1">#                   Task #3748: POC SNAB</span>
            <span class="c1"># Add timings</span>
            <span class="n">snab_check_namespace</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">SNAB_ENABLED</span> <span class="ow">and</span> <span class="n">SNAB_CHECKS</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">app</span> <span class="o">==</span> <span class="n">skyline_app</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">snab_context</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">snab_check_namespace</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">snab_check_namespace</span><span class="p">:</span>
                                    <span class="k">break</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]:</span>
                                        <span class="k">if</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">redis_metric_name</span><span class="p">:</span>
                                            <span class="n">snab_check_namespace</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">break</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to check if </span><span class="si">%s</span><span class="s1"> is a snab_check_metric&#39;</span> <span class="o">%</span> <span class="n">redis_metric_name</span><span class="p">)</span>

            <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
            <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
            <span class="c1"># metric</span>
            <span class="n">test_alerts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">test_alert_and_trigger</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_alerts</span> <span class="o">=</span> <span class="n">get_test_alerts</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_test_alerts failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">test_alerts</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">test_alert_timestamp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_alerts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test_metric</span> <span class="o">=</span> <span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">test_metric</span> <span class="o">!=</span> <span class="n">metric</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">trigger_anomaly</span> <span class="o">=</span> <span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">][</span><span class="s1">&#39;trigger_anomaly&#39;</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">trigger_anomaly</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">trigger_anomaly</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test_alert found for </span><span class="si">%s</span><span class="s1"> with trigger_anomaly: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">test_metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trigger_anomaly</span><span class="p">)))</span>
                        <span class="n">test_alert_and_trigger</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed determine test_alert details from test_alerts: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">]),</span> <span class="n">err</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">test_alert_and_trigger</span><span class="p">:</span>
                <span class="n">alert_tested_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.test_alerts.done.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">alert_tested_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test_alert created Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">alert_tested_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to create Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">alert_tested_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20200607 - Feature #3566: custom_algorithms</span>
            <span class="n">algorithms_run</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_ALGORITHMS</span><span class="p">)</span>

            <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
            <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20201001 - Branch #3068: SNAB</span>
            <span class="c1">#                   Task #3748: POC SNAB</span>
            <span class="c1"># Add timings</span>
            <span class="n">analysis_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="c1"># @added 20230608 - </span>
            <span class="n">MIRAGE_NAMESPACE_MINIMUM_RESOLUTIONS</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">downsample_namespace</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">original_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">namespace_minimum_resolution</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">MIRAGE_NAMESPACE_MINIMUM_RESOLUTIONS</span> <span class="ow">and</span> <span class="n">valid_mirage_timeseries</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">MIRAGE_NAMESPACE_MINIMUM_RESOLUTIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="p">[</span><span class="n">namespace</span><span class="p">])</span>
                            <span class="k">del</span> <span class="n">metric_matched_by</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: matched_or_regexed_in_list failed checking to downsample_namespace for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">base_name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="n">downsample_namespace</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">original_timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                            <span class="n">namespace_minimum_resolution</span> <span class="o">=</span> <span class="n">MIRAGE_NAMESPACE_MINIMUM_RESOLUTIONS</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;downsampling </span><span class="si">%s</span><span class="s1"> to namespace_minimum_resolution: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_minimum_resolution</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed checking to downsample_namespace for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">base_name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">downsample_namespace</span> <span class="ow">and</span> <span class="n">namespace_minimum_resolution</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;would downsample </span><span class="si">%s</span><span class="s1"> to namespace_minimum_resolution: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_minimum_resolution</span><span class="p">)))</span>
                <span class="c1"># Determine resolution</span>
                <span class="c1"># downsample_timeseries(skyline_app, timeseries, resolution, namespace_minimum_resolution, method=&#39;mean&#39;, origin=&#39;end&#39;)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">valid_mirage_timeseries</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzing :: </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">))</span>
                    <span class="c1"># @modified 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
                    <span class="c1"># Added run_negatives_present and negatives_found</span>
                    <span class="c1"># anomalous, ensemble, datapoint = run_selected_algorithm(timeseries, metric, second_order_resolution_seconds)</span>
                    <span class="c1"># @modified 20200607 - Feature #3566: custom_algorithms</span>
                    <span class="c1"># Added algorithms_run</span>
                    <span class="c1"># @modified 20210304 - Feature #3642: Anomaly type classification</span>
                    <span class="c1">#                      Feature #3970: custom_algorithm - adtk_level_shift</span>
                    <span class="c1"># Added triggered_algorithms</span>
                    <span class="c1"># anomalous, ensemble, datapoint, negatives_found, algorithms_run = run_selected_algorithm(timeseries, metric, second_order_resolution_seconds, run_negatives_present, triggered_algorithms)</span>
                    <span class="c1"># @modified 20230118 - Task #4786: Switch from matrixprofile to stumpy</span>
                    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                    <span class="c1"># Added current_func</span>
                    <span class="c1"># anomalous, ensemble, datapoint, negatives_found, algorithms_run = run_selected_algorithm(timeseries, metric, second_order_resolution_seconds, run_negatives_present, triggered_algorithms)</span>
                    <span class="n">anomalous</span><span class="p">,</span> <span class="n">ensemble</span><span class="p">,</span> <span class="n">datapoint</span><span class="p">,</span> <span class="n">negatives_found</span><span class="p">,</span> <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">run_selected_algorithm</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">run_negatives_present</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">current_func</span><span class="o">=</span><span class="s1">&#39;mirage&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not analyzing :: </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> seconds as there is not sufficiently older datapoints in the timeseries - not valid_mirage_timeseries&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">))</span>
                    <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">timeseries</span><span class="p">:</span>
                        <span class="n">datapoint</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">datapoint</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">ensemble</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                    <span class="c1"># Allow to test on sparse metrics</span>
                    <span class="k">if</span> <span class="n">test_alert_and_trigger</span><span class="p">:</span>
                        <span class="n">ensemble</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;histogram_bins&#39;</span><span class="p">]</span>
                        <span class="n">algorithms_run</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;histogram_bins&#39;</span><span class="p">]</span>
                        <span class="n">negatives_found</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># It could have been deleted by the Roomba</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># @added 20200430 - Feature #3480: batch_processing</span>
                <span class="c1"># Added logging here as the DeletedByRoomba exception is</span>
                <span class="c1"># generally not related to that but related to some other fail</span>
                <span class="c1"># in the processing of the run algorithms phase.</span>
                <span class="c1"># It could have been deleted by the Roomba, but Mirage does not use</span>
                <span class="c1"># Redis data so probably, definitely was not :)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: added as DeletedByRoomba but possibly not see traceback above&#39;</span><span class="p">)</span>

                <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;DeletedByRoomba&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exceptions        :: DeletedByRoomba&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">TooShort</span><span class="p">:</span>
                <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;TooShort&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exceptions        :: TooShort&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Stale</span><span class="p">:</span>
                <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Stale&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exceptions        :: Stale&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Boring</span><span class="p">:</span>
                <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Boring&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exceptions        :: Boring&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Other&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exceptions        :: Other&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: unhandled error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># @added 20220414 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
            <span class="c1">#                   Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
            <span class="c1"># To overcome the Graphite unfilled last bucket problem, the FULL_DURATION</span>
            <span class="c1"># data is downsampled using the Pandas origin=&#39;end&#39; backwards resample</span>
            <span class="c1"># method and then aligning to the resolution and this data replaces the</span>
            <span class="c1"># FULL_DURATION period in the Graphite timeseries data for analysis only.</span>
            <span class="c1"># This solves the problem of false positive alerts being generated by</span>
            <span class="c1"># unfilled buckets where the data in the bucket would &#39;normalise&#39; over</span>
            <span class="c1"># the duration of the bucket.  However often times occur where the</span>
            <span class="c1"># bucket data only has one or two very high or very low values and then</span>
            <span class="c1"># the average for that unfilled bucket is skewed, causing an outlier.</span>
            <span class="c1"># When the the rest of the bucket is filled the outlier is flattened.</span>
            <span class="c1"># This preprocessing method resolves that issue and removes any</span>
            <span class="c1"># requirement for extending the Graphite first retention period to a</span>
            <span class="c1"># value &gt; 7days, which resolves this issue but creates an issue in the</span>
            <span class="c1"># Ionosphere context where features extraction takes a long time and is</span>
            <span class="c1"># not suitable for high production workload.  Thanks to Pandas for</span>
            <span class="c1"># introducing backswards resampling in version 1.3.</span>
            <span class="n">downsampled_timeseries</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">anomalous</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checking if Graphite data and FULL_DURATION data are different if so will check against realigned downsampled data - anomalous - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                    <span class="n">downsampled_timeseries</span> <span class="o">=</span> <span class="n">downsample_full_duration_and_merge_graphite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="n">known_derivative_metric</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: downsample_full_duration_and_merge_graphite for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">downsampled_timeseries</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checking realigned downsampled data for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                    <span class="c1"># @modified 20230118 - Task #4786: Switch from matrixprofile to stumpy</span>
                    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                    <span class="c1"># Added current_func</span>
                    <span class="n">anomalous</span><span class="p">,</span> <span class="n">ensemble</span><span class="p">,</span> <span class="n">datapoint</span><span class="p">,</span> <span class="n">negatives_found</span><span class="p">,</span> <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">run_selected_algorithm</span><span class="p">(</span><span class="n">downsampled_timeseries</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">run_negatives_present</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">current_func</span><span class="o">=</span><span class="s1">&#39;mirage&#39;</span><span class="p">)</span>
                    <span class="c1"># Replace the datapoint variable from the preprocessed</span>
                    <span class="c1"># downsampled_timeseries with the actual data point from the</span>
                    <span class="c1"># Graphite data</span>
                    <span class="n">datapoint</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Other&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exceptions        :: Other&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: unhandled error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># @added 20230418 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
                <span class="n">low_variance</span> <span class="o">=</span> <span class="mf">0.009</span>
                <span class="n">irregular_unstable_timeseries</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">anomalous</span><span class="p">:</span>
                    <span class="n">start_normalized_var</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="n">normalized_var</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">normalized_var</span> <span class="o">=</span> <span class="n">normalized_variance</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: normalized_variance failed on timeseries for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">normalized_var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">normalized_var</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: normalized_variance reported an error with timeseries for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">normalized_var</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">normalized_var</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">normalized_var</span> <span class="o">&lt;=</span> <span class="n">low_variance</span><span class="p">:</span>
                            <span class="n">irregular_unstable_timeseries</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage :: normalized_variance ran with result: </span><span class="si">%s</span><span class="s1"> (took </span><span class="si">%.6f</span><span class="s1"> seconds), for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">normalized_var</span><span class="p">),</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_normalized_var</span><span class="p">),</span> <span class="n">metric</span><span class="p">))</span>

                <span class="c1"># @added 20221105 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
                <span class="c1"># Determine if an anomaly is a normal peak value of normal magnitude</span>
                <span class="c1"># that occurs daily in a 7 day period</span>
                <span class="k">if</span> <span class="n">anomalous</span> <span class="ow">and</span> <span class="n">downsampled_timeseries</span> <span class="ow">and</span> <span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage :: checking anomalous_daily_peak </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">metric</span><span class="p">))</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">start_anomalous_daily_peak</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;anomalous_daily_peak&#39;</span>
                        <span class="n">custom_algorithms_to_run</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">custom_algorithms_to_run</span><span class="p">[</span><span class="n">custom_algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;namespaces&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;labelled_metrics&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;algorithm_source&#39;</span><span class="p">:</span> <span class="s1">&#39;/opt/skyline/github/skyline/skyline/custom_algorithms/anomalous_daily_peak.py&#39;</span><span class="p">,</span>
                            <span class="c1"># @modified 20230411 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
                            <span class="c1"># &#39;algorithm_parameters&#39;: {},</span>
                            <span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;number_of_daily_peaks&#39;</span><span class="p">:</span> <span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span><span class="p">,</span>
                                <span class="s1">&#39;within_percent_of_normal_peaks&#39;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>
                                <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="p">},</span>
                            <span class="c1"># &#39;max_execution_time&#39;: 1.0,</span>
                            <span class="s1">&#39;max_execution_time&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                            <span class="s1">&#39;consensus&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="s1">&#39;algorithms_allowed_in_consensus&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;anomalous_daily_peak&#39;</span><span class="p">],</span>
                            <span class="c1"># &#39;debug_logging&#39;: False,</span>
                            <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s1">&#39;run_3sigma_algorithms&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;run_before_3sigma&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;run_only_if_consensus&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;trigger_history_override&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;use_with&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mirage&#39;</span><span class="p">],</span>
                        <span class="p">}</span>
                        <span class="c1"># use_debug_logging_here = False</span>
                        <span class="n">use_debug_logging_here</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">result</span><span class="p">,</span> <span class="n">anomalyScore</span> <span class="o">=</span> <span class="n">run_custom_algorithm_on_timeseries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">metric</span><span class="p">,</span> <span class="n">downsampled_timeseries</span><span class="p">,</span> <span class="s1">&#39;anomalous_daily_peak&#39;</span><span class="p">,</span> <span class="n">custom_algorithms_to_run</span><span class="p">[</span><span class="n">custom_algorithm</span><span class="p">],</span> <span class="n">use_debug_logging_here</span><span class="p">)</span>
                        <span class="n">algorithms_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">custom_algorithm</span><span class="p">)</span>
                        <span class="n">ensemble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">DEBUG_CUSTOM_ALGORITHMS</span> <span class="ow">or</span> <span class="n">use_debug_logging_here</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: mirage :: run_custom_algorithm_on_timeseries run anomalous_daily_peak with result - </span><span class="si">%s</span><span class="s1">, anomalyScore - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalyScore</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage :: run_custom_algorithm_on_timeseries anomalous_daily_peak failed on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage :: anomalous_daily_peak ran with result: </span><span class="si">%s</span><span class="s1"> (took </span><span class="si">%.6f</span><span class="s1"> seconds), for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_anomalous_daily_peak</span><span class="p">),</span> <span class="n">metric</span><span class="p">))</span>
                    <span class="c1"># Although fine in a notebook does not have the desired effect</span>
                    <span class="c1"># in the runtime so convert to a str and check</span>
                    <span class="c1"># if result is False:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage :: anomalous_daily_peak is overrriding anomalous result for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric</span><span class="p">))</span>
                        <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20220506 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
                <span class="c1">#                   Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
                <span class="c1"># If the downsampled data is not anomalous, remove the entry from</span>
                <span class="c1"># the mirage.trigger_history</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">anomalous</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;realigned downsampled data not anomalous removing entry from mirage.trigger_history for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                    <span class="n">trigger_history</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">raw_trigger_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;mirage.trigger_history&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">raw_trigger_history</span><span class="p">:</span>
                            <span class="n">trigger_history</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">raw_trigger_history</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_algorithms :: failed to evaluate data from mirage.trigger_history Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                    <span class="n">new_trigger_history</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">last_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">history_removed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">history_timestamp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">trigger_history</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">history_timestamp</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">history_removed</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removing entry for </span><span class="si">%s</span><span class="s1"> from mirage.trigger_history - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">trigger_history</span><span class="p">[</span><span class="n">history_timestamp</span><span class="p">])))</span>
                            <span class="k">continue</span>
                        <span class="n">new_trigger_history</span><span class="p">[</span><span class="n">history_timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">trigger_history</span><span class="p">[</span><span class="n">history_timestamp</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">history_removed</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;mirage.trigger_history&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_trigger_history</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;updated mirage.trigger_history for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to set key in mirage.trigger_history Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

                    <span class="c1"># @added 20230616</span>
                    <span class="c1"># Remove the metric directory</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">rmtree</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed data dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to rmtree - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>

            <span class="c1"># @added 20220420 - Feature #4530: namespace.analysed_events</span>
            <span class="n">parent_namespace</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">date_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">gmtime</span><span class="p">()))</span>
            <span class="n">namespace_analysed_events_hash</span> <span class="o">=</span> <span class="s1">&#39;namespace.analysed_events.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">date_string</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hincrby</span><span class="p">(</span><span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">parent_namespace</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to increment </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">15</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;updated </span><span class="si">%s</span><span class="s1"> Redis hash&#39;</span> <span class="o">%</span> <span class="n">namespace_analysed_events_hash</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to set expire </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20201001 - Branch #3068: SNAB</span>
            <span class="c1">#                   Task #3748: POC SNAB</span>
            <span class="c1"># Add timings</span>
            <span class="n">analysis_run_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">analysis_start_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;algorithms analysis completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">analysis_run_time</span><span class="p">))</span>

            <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
            <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
            <span class="c1"># metric</span>
            <span class="k">if</span> <span class="n">test_alert_and_trigger</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test_alert triggering anomaly on </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
                <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">datapoint</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># @added 20210309 - Task #3730: Validate Mirage running multiple processes</span>
            <span class="c1"># Reimplement mirage.checks.done count</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snab_only_check</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s1">&#39;mirage.checks.done&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to increment mirage.checks.done Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

            <span class="c1"># @modified 20200728 - Bug #3652: Handle multiple metrics in base_name conversion</span>
            <span class="c1"># base_name = metric.replace(settings.FULL_NAMESPACE, &#39;&#39;, 1)</span>
            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span>

            <span class="c1"># @added 20210505 - Bug #4048: Mirage - removing feedback metrics to be processed</span>
            <span class="n">feedback_cache_key_exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">feedback_cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.feedback_metric.checked.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">feedback_cache_key_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feedback_cache_key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get </span><span class="si">%s</span><span class="s1"> key from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">feedback_cache_key</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">feedback_cache_key_exists</span><span class="p">:</span>
                <span class="n">feedback_processed_cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.feedback_metric.processed.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;feedback metric processed adding Redis key with 600 TTL - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">feedback_processed_cache_key</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">feedback_processed_cache_key</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">analysis_start_time</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> key to Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">feedback_processed_cache_key</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

            <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
            <span class="c1"># Remove the metric from the waterfall_alerts Redis set</span>
            <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp]</span>
            <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp. waterfall_panorama_data]</span>
            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
            <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">literal_waterfall_alert</span> <span class="ow">in</span> <span class="n">literal_analyzer_waterfall_alerts</span><span class="p">:</span>
                <span class="n">waterfall_alert</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">literal_waterfall_alert</span><span class="p">)</span>
                <span class="n">analyzer_waterfall_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)</span>


            <span class="c1"># @added 20220504 - Feature #2580: illuminance</span>
            <span class="c1"># @modified 20230419 - Feature #2580: illuminance</span>
            <span class="c1"># Moved out of the if anomalous block.  Record illuminance for all</span>
            <span class="c1"># Get the anomaly breakdown - who returned True?</span>
            <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">boolean_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ensemble</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">boolean_value</span><span class="p">:</span>
                    <span class="c1"># @modified 20200607 - Feature #3566: custom_algorithms</span>
                    <span class="c1"># algorithm = settings.MIRAGE_ALGORITHMS[index]</span>
                    <span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithms_run</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

                    <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">triggered_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">triggered_algorithms</span><span class="p">:</span>
                <span class="n">illuminance_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">illuminance_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span>
                    <span class="s1">&#39;triggered_algorithms_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;calling add_illuminance_entries with </span><span class="si">%s</span><span class="s1"> entries to add&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">illuminance_dict</span><span class="p">))))</span>
                <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="n">add_illuminance_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">run_timestamp</span><span class="p">),</span> <span class="n">illuminance_dict</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: add_illuminance_entries failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;illuminance Redis hash now has </span><span class="si">%s</span><span class="s1"> entries&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_illuminance_dict</span><span class="p">))))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">anomalous</span><span class="p">:</span>

                <span class="n">not_anomalous_metric</span> <span class="o">=</span> <span class="p">[</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">base_name</span><span class="p">]</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.not_anomalous_metrics.append(not_anomalous_metric)</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.not_anomalous_metrics&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">not_anomalous_metric</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
                <span class="c1"># Remove the metric from the waterfall_alerts Redis set</span>
                <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp]</span>
                <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp, waterfall_panorama_data]</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
                <span class="k">for</span> <span class="n">waterfall_alert</span> <span class="ow">in</span> <span class="n">analyzer_waterfall_alerts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed waterfall alert item from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                        <span class="c1"># @added 20201128 - Feature #3734: waterfall alerts</span>
                        <span class="c1"># If the check just done is new than an existing analyzer</span>
                        <span class="c1"># waterfall alert metric timestamp remove those keys as well</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed waterfall alert item with older timestamp from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>

                <span class="c1"># @added 20210330 - Feature #3994: Panorama - mirage not anomalous</span>
                <span class="c1"># A hash is added to the mirage.panorama.not_anomalous_metrics for</span>
                <span class="c1"># every metric that is found to be not anomalous.  This provides</span>
                <span class="c1"># data for /panorama?not_anomalous and /panorama?not_anomalous_metric</span>
                <span class="c1"># method which are used for plots in the webapp and json response.</span>
                <span class="c1"># The mirage.panorama.not_anomalous_metrics Redis hash is managed in</span>
                <span class="c1"># analyzer/metrics_manager</span>
                <span class="n">not_anomalous_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">not_anomalous_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">not_anomalous_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span>
                <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;mirage.panorama.not_anomalous_metrics&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">base_name</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">not_anomalous_timestamp</span><span class="p">,</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">datapoint</span><span class="p">,</span>
                            <span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">hours_to_resolve</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="n">time</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis hash </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">)))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not anomalous :: </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> (at full duration), </span><span class="si">%s</span><span class="s1"> (at SECOND_ORDER_RESOLUTION_HOURS)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">)))</span>

            <span class="c1"># If it&#39;s anomalous, add it to list</span>
            <span class="k">if</span> <span class="n">anomalous</span><span class="p">:</span>
                <span class="c1"># @modified 20200728 - Bug #3652: Handle multiple metrics in base_name conversion</span>
                <span class="c1"># base_name = metric.replace(settings.FULL_NAMESPACE, &#39;&#39;, 1)</span>
                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span>
                <span class="c1"># metric_timestamp = int(timeseries[-1][0])</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">int_metric_timestamp</span>

                <span class="c1"># Get the anomaly breakdown - who returned True?</span>
                <span class="c1"># @modified 20230419 - Feature #2580: illuminance</span>
                <span class="c1"># Moved out of the if anomalous block.  Determine</span>
                <span class="c1"># triggered_algorithms for all to record illuminance</span>
                <span class="c1"># triggered_algorithms = []</span>
                <span class="c1"># for index, boolean_value in enumerate(ensemble):</span>
                <span class="c1">#     if boolean_value:</span>
                <span class="c1">#         # @modified 20200607 - Feature #3566: custom_algorithms</span>
                <span class="c1">#         # algorithm = settings.MIRAGE_ALGORITHMS[index]</span>
                <span class="c1">#         algorithm = algorithms_run[index]</span>
                <span class="c1">#         anomaly_breakdown[algorithm] += 1</span>
                <span class="c1">#         triggered_algorithms.append(algorithm)</span>

                <span class="c1"># @modified 20201007 - Feature #3772: Add the anomaly_id to the http_alerter json</span>
                <span class="c1">#                      Branch #3068: SNAB</span>
                <span class="c1"># Added second_order_resolution_seconds, triggered_algorithms and algorithms_run</span>
                <span class="c1"># anomalous_metric = [datapoint, base_name, metric_timestamp]</span>
                <span class="n">anomalous_metric</span> <span class="o">=</span> <span class="p">[</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">algorithms_run</span><span class="p">]</span>

                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.anomalous_metrics.append(anomalous_metric)</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.anomalous_metrics&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalous_metric</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to mirage.anomalous_metrics Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>

                <span class="c1"># @added 20220504 - Feature #2580: illuminance</span>
                <span class="c1"># @modified 20230419 - Feature #2580: illuminance</span>
                <span class="c1"># Moved out of the if anomalous block to above.  Determine</span>
                <span class="c1"># triggered_algorithms and record illuminance for all that</span>
                <span class="c1"># triggered</span>
                <span class="c1"># illuminance_dict = {}</span>
                <span class="c1"># illuminance_dict[base_name] = {</span>
                <span class="c1">#     &#39;timestamp&#39;: int(metric_timestamp),</span>
                <span class="c1">#     &#39;value&#39;: float(datapoint),</span>
                <span class="c1">#     &#39;triggered_algorithms_count&#39;: len(triggered_algorithms)}</span>
                <span class="c1"># logger.info(&#39;calling add_illuminance_entries with %s entries to add&#39; % (</span>
                <span class="c1">#     str(len(illuminance_dict))))</span>
                <span class="c1"># current_illuminance_dict = {}</span>
                <span class="c1"># try:</span>
                <span class="c1">#     current_illuminance_dict = add_illuminance_entries(self, skyline_app, int(run_timestamp), illuminance_dict)</span>
                <span class="c1"># except Exception as err:</span>
                <span class="c1">#     logger.error(&#39;error :: add_illuminance_entries failed - %s&#39; % (</span>
                <span class="c1">#         err))</span>
                <span class="c1"># logger.info(&#39;illuminance Redis hash now has %s entries&#39; % (</span>
                <span class="c1">#     str(len(current_illuminance_dict))))</span>

                <span class="c1"># @modified 20201001 - Branch #3068: SNAB</span>
                <span class="c1">#                      Task #3748: POC SNAB</span>
                <span class="c1"># Added analysis_run_time</span>
                <span class="k">if</span> <span class="n">snab_check_namespace</span><span class="p">:</span>
                    <span class="n">redis_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.analysis_run_time.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_key</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">analysis_run_time</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add snab analysis_run_time Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">redis_key</span><span class="p">))</span>
                    <span class="c1"># @added 20230427 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
                    <span class="c1"># Use downsampled_timeseries data</span>
                    <span class="k">if</span> <span class="n">downsampled_timeseries</span><span class="p">:</span>
                        <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                        <span class="n">training_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">timeseries_dir</span><span class="p">))</span>
                        <span class="c1"># snab_json_file = &#39;%s/%s.%s.downsampled.json&#39; % (</span>
                        <span class="c1">#     settings.IONOSPHERE_DATA_FOLDER, str(int(metric_timestamp)), str(metric))</span>
                        <span class="n">snab_json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.downsampled.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">training_dir</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                        <span class="n">timeseries_json</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">downsampled_timeseries</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">timeseries_json</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">write_data_to_file</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">snab_json_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">timeseries_json</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added snab downsampled timeseries file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">snab_json_file</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                    <span class="s1">&#39;error :: failed to add snab timeseries file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                    <span class="n">snab_json_file</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">snab_json_file</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - the snab_json_file was not created - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">snab_json_file</span><span class="p">)))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;snab_json_file exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">snab_json_file</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="s1">&#39;error :: no timeseries_json to add snab timeseries file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                <span class="n">snab_json_file</span><span class="p">)</span>                        

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;anomaly detected :: </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1">  (at SECOND_ORDER_RESOLUTION_HOURS), </span><span class="si">%s</span><span class="s1"> (at FULL_DURATION)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="c1"># It runs so fast, this allows us to process 30 anomalies/min</span>
                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># Removed limit</span>
                <span class="c1"># sleep(2)</span>

                <span class="c1"># @added 20170206 - Bug #1904: Handle non filesystem friendly metric names in check files</span>
                <span class="n">sane_metricname</span> <span class="o">=</span> <span class="n">filesafe_metricname</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>

                <span class="c1"># @added 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
                <span class="c1"># Determine if any metrcs have negatives values some they can be</span>
                <span class="c1"># added to the ionosphere.untrainable_metrics Redis set</span>
                <span class="k">if</span> <span class="n">run_negatives_present</span> <span class="ow">and</span> <span class="n">negatives_found</span><span class="p">:</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.untrainable_metrics&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">last_negative_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">negatives_found</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">last_negative_value</span> <span class="o">=</span> <span class="n">negatives_found</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">remove_after_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_negative_timestamp</span> <span class="o">+</span> <span class="n">second_order_resolution_seconds</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">([</span><span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">datapoint</span><span class="p">,</span> <span class="n">last_negative_timestamp</span><span class="p">,</span> <span class="n">last_negative_value</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">remove_after_timestamp</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                <span class="c1"># If Crucible or Panorama are enabled determine details</span>
                <span class="n">determine_anomaly_details</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_CRUCIBLE</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CRUCIBLE_ENABLED</span><span class="p">:</span>
                    <span class="n">determine_anomaly_details</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">:</span>
                    <span class="n">determine_anomaly_details</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># If Ionosphere is enabled determine details</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ionosphere_enabled</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_ENABLED</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_ENABLED</span><span class="p">:</span>
                        <span class="n">determine_anomaly_details</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">ionosphere_enabled</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">determine_anomaly_details</span><span class="p">:</span>
                    <span class="c1"># metric_timestamp = str(int(timeseries[-1][0]))</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

                <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.last_alert.smtp.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="n">last_alert</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200805 - Task #3662: Change mirage.last_check keys to timestamp value</span>
                    <span class="c1">#                      Feature #3486: analyzer_batch</span>
                    <span class="c1">#                      Feature #3480: batch_processing</span>
                    <span class="c1"># Changed the last_alert cache key to hold the last</span>
                    <span class="c1"># anomaly timestamp</span>
                    <span class="c1"># last_alert = self.redis_conn.get(cache_key)</span>
                    <span class="n">last_alert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not query Redis for cache_key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

                <span class="c1"># @added 20200805 - Task #3662: Change mirage.last_check keys to timestamp value</span>
                <span class="c1">#                   Feature #3486: analyzer_batch</span>
                <span class="c1">#                   Feature #3480: batch_processing</span>
                <span class="c1"># Evaluate the reported anomaly timestamp to determine whether</span>
                <span class="c1"># EXPIRATION_TIME should be applied to a batch metric</span>
                <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">last_alert</span><span class="p">:</span>
                    <span class="c1"># Is this a analyzer_batch related anomaly</span>
                    <span class="n">analyzer_batch_metric_anomaly_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_batch.anomaly.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;error :: could not query cache_key - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">analyzer_batch_anomaly</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;identified as an analyzer_batch triggered anomaly from the presence of the Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not identified as an analyzer_batch triggered anomaly as no Redis key found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">last_alert</span> <span class="ow">and</span> <span class="n">analyzer_batch_anomaly</span><span class="p">:</span>
                        <span class="c1"># @modified 20201107 - Feature #3830: metrics_manager</span>
                        <span class="c1"># Optimise to use metrics_manager HGETALL rather than</span>
                        <span class="c1"># iterating the list of lists</span>
                        <span class="c1"># mirage_metrics_expiration_times = []</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     mirage_metrics_expiration_times = list(self.redis_conn_decoded.smembers(&#39;mirage.metrics_expiration_times&#39;))</span>
                        <span class="c1">#     if LOCAL_DEBUG:</span>
                        <span class="c1">#         logger.info(&#39;debug :: fetched the mirage.metrics_expiration_times Redis set&#39;)</span>
                        <span class="c1"># except:</span>
                        <span class="c1">#     logger.info(&#39;failed to fetch the mirage.metrics_expiration_times Redis set&#39;)</span>
                        <span class="c1">#     mirage_metrics_expiration_times = []</span>
                        <span class="c1"># metric_expiration_time = 3600</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     for item_list_string in mirage_metrics_expiration_times:</span>
                        <span class="c1">#         mirage_alert_expiration_data = literal_eval(item_list_string)</span>
                        <span class="c1">#         if mirage_alert_expiration_data[0] == base_name:</span>
                        <span class="c1">#             metric_expiration_time = int(mirage_alert_expiration_data[1])</span>
                        <span class="c1">#             break</span>
                        <span class="c1"># except:</span>
                        <span class="c1">#     if LOCAL_DEBUG:</span>
                        <span class="c1">#         logger.error(&#39;error :: failed to determine mirage_alert_expiration_data for %s from the mirage.metrics_expiration_times Redis set&#39; % str(base_name))</span>
                        <span class="c1">#     metric_expiration_time = 3600</span>
                        <span class="n">mirage_metrics_expiration_times</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">mirage_metrics_expiration_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;mirage.hash_key.metrics_expiration_times&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> entries in mirage.hash_key.metrics_expiration_times Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mirage_metrics_expiration_times</span><span class="p">)))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get Redis hash key mirage.hash_key.metrics_expiration_times&#39;</span><span class="p">)</span>
                            <span class="n">mirage_metrics_expiration_times</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> entries in mirage.hash_key.metrics_expiration_times Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mirage_metrics_expiration_times</span><span class="p">)))</span>
                            <span class="n">metric_expiration_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mirage_metrics_expiration_times</span><span class="p">[</span><span class="n">base_name</span><span class="p">])</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> has expiration time of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_expiration_time</span><span class="p">)))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine mirage_alert_expiration_data for </span><span class="si">%s</span><span class="s1"> from the mirage.hash_key.metrics_expiration_times Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                            <span class="n">metric_expiration_time</span> <span class="o">=</span> <span class="mi">3600</span>

                        <span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">last_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_alert</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine last_timestamp from the last Mirage alert key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                            <span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">seconds_between_batch_anomalies</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">last_timestamp</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">seconds_between_batch_anomalies</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine seconds_between_batch_anomalies for batch metric Panorama key- </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                                <span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">seconds_between_batch_anomalies</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">seconds_between_batch_anomalies</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_expiration_time</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the difference between the last anomaly timestamp (</span><span class="si">%s</span><span class="s1">) and the batch anomaly timestamp (</span><span class="si">%s</span><span class="s1">) for batch metric </span><span class="si">%s</span><span class="s1"> is greater than the metric EXPIRATION_TIME of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_expiration_time</span><span class="p">)))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;alerting on anomaly for batch metric </span><span class="si">%s</span><span class="s1">, so setting last_alert to None&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">metric</span><span class="p">))</span>
                                <span class="n">last_alert</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the difference between the last anomaly timestamp (</span><span class="si">%s</span><span class="s1">) and the batch anomaly timestamp (</span><span class="si">%s</span><span class="s1">) for batch metric </span><span class="si">%s</span><span class="s1"> is less than the metric EXPIRATION_TIME of </span><span class="si">%s</span><span class="s1">, not alerting&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_expiration_time</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">last_timestamp</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;batch anomaly timestamp (</span><span class="si">%s</span><span class="s1">) less than the last_check timestamp (</span><span class="si">%s</span><span class="s1">), alerting on anomaly for batch metric </span><span class="si">%s</span><span class="s1">, so setting last_alert to None&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">))</span>
                                <span class="n">last_alert</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># @added 20170308 - Feature #1960: ionosphere_layers</span>
                <span class="c1"># Allow Ionosphere to send Panorama checks, it is an ionosphere_metric</span>
                <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="c1"># Only call once</span>
                <span class="c1"># try:</span>
                <span class="c1">#     # @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#     #                      Branch #3262: py3</span>
                <span class="c1">#     # ionosphere_unique_metrics = list(self.redis_conn.smembers(&#39;ionosphere.unique_metrics&#39;))</span>
                <span class="c1">#     ionosphere_unique_metrics = list(self.redis_conn_decoded.smembers(&#39;ionosphere.unique_metrics&#39;))</span>
                <span class="c1"># except:</span>
                <span class="c1">#     ionosphere_unique_metrics = []</span>

                <span class="n">added_at</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                <span class="c1"># If Panorama is enabled - create a Panorama check</span>
                <span class="c1"># @modified 20170308 - Feature #1960: ionosphere_layers</span>
                <span class="c1"># Allow Ionosphere to send Panorama checks for ionosphere_metrics</span>
                <span class="c1"># if settings.PANORAMA_ENABLED:</span>
                <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">:</span>
                    <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                    <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
                <span class="c1"># metric</span>
                <span class="k">if</span> <span class="n">test_alert_and_trigger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test_alert sending triggered anomaly on </span><span class="si">%s</span><span class="s1"> to Panorama&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">metric</span><span class="p">))</span>
                    <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Panorama must have at least one triggered algorithm</span>
                    <span class="n">original_triggered_algorithms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="n">algorithms_run</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                <span class="k">if</span> <span class="n">send_to_panorama</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">):</span>
                        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">analyzer_batch_anomaly</span><span class="p">:</span>
                        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">int_metric_timestamp</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">)</span>
                        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">)</span>

                    <span class="c1"># Note:</span>
                    <span class="c1"># The values are enclosed is single quoted intentionally</span>
                    <span class="c1"># as the imp.load_source used results in a shift in the</span>
                    <span class="c1"># decimal position when double quoted, e.g.</span>
                    <span class="c1"># value = &quot;5622.0&quot; gets imported as</span>
                    <span class="c1"># 2016-03-02 12:53:26 :: 28569 :: metric variable - value - 562.2</span>
                    <span class="c1"># single quoting results in the desired,</span>
                    <span class="c1"># 2016-03-02 13:16:17 :: 1515 :: metric variable - value - 5622.0</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;graphite&#39;</span>
                    <span class="n">panoroma_anomaly_data</span> <span class="o">=</span> <span class="s1">&#39;metric = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;value = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;from_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;metric_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;triggered_algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;app = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;source = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;added_by = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;added_at = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span> <span class="n">from_timestamp</span><span class="p">,</span>
                           <span class="c1"># @modified 20200607 - Feature #3566: custom_algorithms</span>
                           <span class="c1"># str(int_metric_timestamp), str(settings.MIRAGE_ALGORITHMS),</span>
                           <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithms_run</span><span class="p">),</span>
                           <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span>
                           <span class="n">this_host</span><span class="p">,</span> <span class="n">added_at</span><span class="p">)</span>

                    <span class="c1"># Create an anomaly file with details about the anomaly</span>
                    <span class="n">panoroma_anomaly_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">,</span> <span class="n">added_at</span><span class="p">,</span> <span class="n">sane_metricname</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">write_data_to_file</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">panoroma_anomaly_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                            <span class="n">panoroma_anomaly_data</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added panorama anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">panoroma_anomaly_file</span><span class="p">))</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># Move to Redis set block below</span>
                        <span class="c1"># self.sent_to_panorama.append(base_name)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add panorama anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">panoroma_anomaly_file</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                    <span class="c1"># Moved from the above self.sent_to_panorama</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.sent_to_panorama&#39;</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                    <span class="c1"># @added 20210323 - Feature #3642: Anomaly type classification</span>
                    <span class="k">if</span> <span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span><span class="p">:</span>
                        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;luminosity.classify_anomalies&#39;</span>
                        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">int_metric_timestamp</span><span class="p">,</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">datapoint</span><span class="p">,</span>
                            <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="n">algorithms_run</span><span class="p">,</span>
                            <span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">:</span> <span class="n">triggered_algorithms</span><span class="p">,</span>
                            <span class="s1">&#39;app&#39;</span><span class="p">:</span> <span class="n">skyline_app</span><span class="p">,</span>
                            <span class="s1">&#39;added_at&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">added_at</span><span class="p">),</span>
                        <span class="p">}</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span><span class="p">,</span> <span class="n">int_metric_timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">added_at</span><span class="p">),</span> <span class="n">data_dict</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                    <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                    <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
                    <span class="c1"># metric</span>
                    <span class="k">if</span> <span class="n">test_alert_and_trigger</span><span class="p">:</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_triggered_algorithms</span><span class="p">)</span>

                    <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
                    <span class="c1"># Remove the metric from the waterfall_alerts Redis set</span>
                    <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp]</span>
                    <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp, waterfall_panorama_data]</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
                    <span class="k">for</span> <span class="n">waterfall_alert</span> <span class="ow">in</span> <span class="n">analyzer_waterfall_alerts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_name</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed waterfall alert item from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>

                <span class="c1"># If crucible is enabled - save timeseries and create a</span>
                <span class="c1"># crucible check</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_CRUCIBLE</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CRUCIBLE_ENABLED</span><span class="p">:</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="n">crucible_anomaly_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CRUCIBLE_DATA_FOLDER</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">timeseries_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">metric_timestamp</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">crucible_anomaly_dir</span><span class="p">):</span>
                        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">crucible_anomaly_dir</span><span class="p">)</span>

                    <span class="c1"># Note:</span>
                    <span class="c1"># The value is enclosed is single quoted intentionally</span>
                    <span class="c1"># as the imp.load_source used in crucible results in a</span>
                    <span class="c1"># shift in the decimal position when double quoted, e.g.</span>
                    <span class="c1"># value = &quot;5622.0&quot; gets imported as</span>
                    <span class="c1"># 2016-03-02 12:53:26 :: 28569 :: metric variable - value - 562.2</span>
                    <span class="c1"># single quoting results in the desired,</span>
                    <span class="c1"># 2016-03-02 13:16:17 :: 1515 :: metric variable - value - 5622.0</span>

                    <span class="n">crucible_anomaly_data</span> <span class="o">=</span> <span class="s1">&#39;metric = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;value = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;from_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;metric_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;triggered_algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;anomaly_dir = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;graphite_metric = True</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;run_crucible_tests = False</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;added_by = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;added_at = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span> <span class="n">from_timestamp</span><span class="p">,</span>
                           <span class="c1"># @modified 20200607 - Feature #3566: custom_algorithms</span>
                           <span class="c1"># str(int_metric_timestamp), str(settings.MIRAGE_ALGORITHMS),</span>
                           <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithms_run</span><span class="p">),</span>
                           <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">crucible_anomaly_dir</span><span class="p">,</span>
                           <span class="n">skyline_app</span><span class="p">,</span> <span class="n">added_at</span><span class="p">)</span>

                    <span class="c1"># Create an anomaly file with details about the anomaly</span>
                    <span class="n">crucible_anomaly_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_anomaly_dir</span><span class="p">,</span> <span class="n">sane_metricname</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">write_data_to_file</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">crucible_anomaly_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                            <span class="n">crucible_anomaly_data</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added crucible anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_anomaly_file</span><span class="p">))</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># self.sent_to_crucible.append(base_name)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add crucible anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_anomaly_file</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

                    <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                    <span class="c1"># Moved from the above self.sent_to_crucible</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.sent_to_crucible&#39;</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                    <span class="c1"># Create timeseries json file with the timeseries</span>
                    <span class="n">json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_anomaly_dir</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                    <span class="n">timeseries_json</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">write_data_to_file</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">timeseries_json</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added crucible timeseries file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add crucible timeseries file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

                    <span class="c1"># Create a crucible check file</span>
                    <span class="n">crucible_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CRUCIBLE_CHECK_PATH</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">sane_metricname</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">write_data_to_file</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">crucible_check_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                            <span class="n">crucible_anomaly_data</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added crucible check :: </span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add crucible check file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_check_file</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

                <span class="c1"># @added 20230510 - Feature #4902: Prevent training on metrics newer than 7 days</span>
                <span class="n">new_metric_added_at</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">ionosphere_enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">last_alert</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_metric_added_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;metrics_manager.untrainable_new_metrics&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to hget on metrics_manager.untrainable_new_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">new_metric_added_at</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_until</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">new_metric_added_at</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
                            <span class="n">new_until_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">new_until</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not sending </span><span class="si">%s</span><span class="s1"> to Ionosphere as still a new metric until </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">base_name</span><span class="p">,</span> <span class="n">new_until_date</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine when </span><span class="si">%s</span><span class="s1"> matures - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">ionosphere_enabled</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20160922 - Branch #922: Ionosphere</span>
                <span class="c1"># Also added the send_anomalous_metric_to skyline_functions.py</span>
                <span class="c1"># function</span>
                <span class="k">if</span> <span class="n">ionosphere_enabled</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_alert</span><span class="p">:</span>
                        <span class="c1"># @modified 20161228 Feature #1830: Ionosphere alerts</span>
                        <span class="c1"># Added full_duration which needs to be recorded to allow Mirage metrics</span>
                        <span class="c1"># to be profiled on Redis timeseries data at FULL_DURATION</span>
                        <span class="c1"># e.g. mirage.redis.24h.json</span>
                        <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">)</span>
                        <span class="c1"># @modified 20170127 - Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
                        <span class="c1"># Added ionosphere_parent_id, always zero from Analyzer and Mirage</span>
                        <span class="n">ionosphere_parent_id</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">send_anomalous_metric_to</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;ionosphere&#39;</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span>
                            <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span>
                            <span class="n">full_duration</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_parent_id</span><span class="p">),</span>
                            <span class="c1"># @added 20201001 - Task #3748: POC SNAB</span>
                            <span class="c1"># Added algorithms_run required to determine the anomalyScore</span>
                            <span class="c1"># so this needs to be sent to Ionosphere so Ionosphere</span>
                            <span class="c1"># can send it back on an alert</span>
                            <span class="n">algorithms_run</span><span class="p">)</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># Moved to the mirage.sent_to_ionosphere Redis set Redis set</span>
                        <span class="c1"># block below</span>
                        <span class="c1"># self.sent_to_ionosphere.append(base_name)</span>

                        <span class="c1"># @added 20200804 - Feature #3462: Add IONOSPHERE_MANAGE_PURGE</span>
                        <span class="c1">#                   Feature #3472: ionosphere.training_data Redis set</span>
                        <span class="c1">#                   Feature #3474: webapp api - training_data</span>
                        <span class="c1"># Add training data to the ionosphere.training_data so that</span>
                        <span class="c1"># the ionosphere purge_old_data_dirs can happen less</span>
                        <span class="c1"># frequently for reduced I/O</span>
                        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.training_data&#39;</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="n">second_order_resolution_seconds</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding to Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;alert expiry key exists not sending to Ionosphere :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>

                    <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
                    <span class="c1"># Remove the metric from the waterfall_alerts Redis set</span>
                    <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp]</span>
                    <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp, waterfall_panorama_data]</span>
                    <span class="c1"># Do not remove if this is only for training_data creation</span>
                    <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
                        <span class="n">mirage_waterfall_data</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">waterfall_alert</span> <span class="ow">in</span> <span class="n">analyzer_waterfall_alerts</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_name</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                                    <span class="n">mirage_waterfall_data</span> <span class="o">=</span> <span class="n">waterfall_alert</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed waterfall alert item from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>

                    <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                    <span class="c1"># Moved from the above self.sent_to_ionosphere</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_alert</span><span class="p">:</span>
                        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.sent_to_ionosphere&#39;</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                        <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                        <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
                        <span class="c1"># metric</span>
                        <span class="k">if</span> <span class="n">test_alert_and_trigger</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test_alert not sending anomaly on </span><span class="si">%s</span><span class="s1"> to ionosphere&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">metric</span><span class="p">))</span>
                            <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
                        <span class="c1"># Add mirage waterfall alert</span>
                        <span class="c1"># Only add if this is an ionosphere_enabled metric_check_file</span>
                        <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">mirage_waterfall_data</span><span class="p">:</span>
                                <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp, waterfall_panorama_data]</span>
                                <span class="n">waterfall_data</span> <span class="o">=</span> <span class="n">mirage_waterfall_data</span>

                                <span class="c1"># @added 20201008 - Bug #3776: waterfall_alert - no analyzer triggered_algorithms in waterfall_panorama_data on MIRAGE_ALWAYS_METRICS</span>
                                <span class="c1"># When a MIRAGE_ALWAYS_METRICS on metric is sent</span>
                                <span class="c1"># through to Mirage from Analyzer the sometimes has</span>
                                <span class="c1"># no algorithms that triggered_algorithms as the</span>
                                <span class="c1"># metric is sent every run, this can be expected.</span>
                                <span class="c1"># However if the Mirage three-sigma check does</span>
                                <span class="c1"># trigger algorithms they need to be added here so</span>
                                <span class="c1"># that when metric and event are sent to Panorama</span>
                                <span class="c1"># the triggered_algorithms is populated</span>
                                <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">MIRAGE_ALWAYS_METRICS</span><span class="p">:</span>
                                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                                    <span class="n">waterfall_panorama_data</span> <span class="o">=</span> <span class="p">[</span>
                                        <span class="n">base_name</span><span class="p">,</span> <span class="n">datapoint</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">algorithms_run</span><span class="p">,</span>
                                        <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span>
                                        <span class="n">skyline_app</span><span class="p">,</span> <span class="n">this_host</span><span class="p">,</span>
                                        <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span>
                                    <span class="p">]</span>
                                    <span class="c1"># Use the original added_to_waterfall_timestamp</span>
                                    <span class="n">added_to_waterfall_timestamp</span> <span class="o">=</span> <span class="n">waterfall_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                                    <span class="c1"># @modified 20201009 - Bug #3776: waterfall_alert - no analyzer triggered_algorithms in waterfall_panorama_data on MIRAGE_ALWAYS_METRICS</span>
                                    <span class="c1"># corrected datapoint, timestamp order</span>
                                    <span class="n">waterfall_data</span> <span class="o">=</span> <span class="p">[</span>
                                        <span class="n">base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">datapoint</span><span class="p">,</span>
                                        <span class="n">added_to_waterfall_timestamp</span><span class="p">,</span> <span class="n">waterfall_panorama_data</span>
                                    <span class="p">]</span>

                                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.waterfall_alerts.sent_to_ionosphere&#39;</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_data</span><span class="p">))</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added to Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_data</span><span class="p">)))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

            <span class="c1"># Add values to the queue so the parent process can collate</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ab_value</span> <span class="ow">in</span> <span class="n">anomaly_breakdown</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mirage_anomaly_breakdown_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">ab_value</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">e_value</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mirage_exceptions_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">e_value</span><span class="p">))</span>

            <span class="n">metric_var_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">):</span>
                <span class="c1"># Remove metric check file</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>

            <span class="c1"># Remove the metric directory</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rmtree</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed data dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to rmtree </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>

            <span class="c1"># @added 20200723 - Feature #3472: ionosphere.training_data Redis set</span>
            <span class="c1">#                   Feature #3566: custom_algorithms</span>
            <span class="c1"># Optimize for MIRAGE_ALWAYS_METRICS which can create a lot</span>
            <span class="c1"># of training_data dirs a Analyzer always hands them off to</span>
            <span class="c1"># mirage.</span>
            <span class="n">remove_ionosphere_data_dir</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">anomalous</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">MIRAGE_ALWAYS_METRICS</span><span class="p">:</span>
                    <span class="n">remove_ionosphere_data_dir</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">anomalous</span> <span class="ow">and</span> <span class="n">periodic_mirage_check</span><span class="p">:</span>
                <span class="n">remove_ionosphere_data_dir</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># @added 20190408 - Feature #2882: Mirage - periodic_check</span>
            <span class="c1"># Remove the training_dir for mirage_periodic_check_metrics if not</span>
            <span class="c1"># anomalous</span>
            <span class="c1"># @modified 20200723 - Feature #3472: ionosphere.training_data Redis set</span>
            <span class="c1">#                   Feature #3566: custom_algorithms</span>
            <span class="c1"># if not anomalous and periodic_mirage_check:</span>
            <span class="k">if</span> <span class="n">remove_ionosphere_data_dir</span><span class="p">:</span>
                <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">training_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">timeseries_dir</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">training_dir</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rmtree</span><span class="p">(</span><span class="n">training_dir</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed Mirage always or periodic check training_data dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">training_dir</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to rmtree Mirage always or periodic check training_dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">training_dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">anomalous</span> <span class="ow">and</span> <span class="n">periodic_mirage_check</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">mirage_periodic_check_metrics</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;processed </span><span class="si">%s</span><span class="s1"> checks in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processing_check_files</span><span class="p">)),</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Mirage.run"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage.Mirage.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the process intializes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Log management to prevent overwriting</span>
        <span class="c1"># Allow the bin/&lt;skyline_app&gt;.d to manage the log</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logwait</span><span class="p">)</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">log_wait_for</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="k">while</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">log_wait_for</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">log_wait_for</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting </span><span class="si">%s</span><span class="s1"> run&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - bin/</span><span class="si">%s</span><span class="s1">.d log management seems to have failed, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;log lock file removed&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app_loglock</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bin/</span><span class="si">%s</span><span class="s1">.d log management done&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>

        <span class="c1"># @modified 20210304 - Feature #3642: Anomaly type classification</span>
        <span class="c1">#                      Feature #3970: custom_algorithm - adtk_level_shift</span>
        <span class="c1"># Added triggered_algorithms</span>
        <span class="k">def</span> <span class="nf">smtp_trigger_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">):</span>
            <span class="c1"># Spawn processes</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20210304 - Feature #3642: Anomaly type classification</span>
                <span class="c1">#                      Feature #3970: custom_algorithm - adtk_level_shift</span>
                <span class="c1"># Added triggered_algorithms</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spawn_alerter_process</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">))</span>
                <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to spawn_alerter_process&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                    <span class="c1"># Just to avoid hogging the CPU</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># All the processes are done, break now.</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: timed out, killing the spawn_trigger_alert process&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="c1"># p.join()</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: stopping spawn_alerter_process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># DEVELOPMENT ONLY</span>
        <span class="c1"># @added 20160806 - Bug #1558: Memory leak in Analyzer</span>
        <span class="c1"># Debug with garbage collection - http://code.activestate.com/recipes/65333/</span>
        <span class="k">if</span> <span class="n">ENABLE_MEMORY_PROFILING</span> <span class="ow">and</span> <span class="n">garbage_collection_enabled</span><span class="p">:</span>
            <span class="c1"># Debug with garbage collection - http://code.activestate.com/recipes/65333/</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_LEAK</span><span class="p">)</span>

            <span class="c1"># As per http://stackoverflow.com/a/1641280</span>
            <span class="c1"># This got useable understandable data with gc</span>
            <span class="n">before</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">after</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">get_objects</span><span class="p">():</span>
                <span class="n">before</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: Memory usage in run at start: </span><span class="si">%s</span><span class="s1"> (kb)&#39;</span> <span class="o">%</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)</span>

        <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
        <span class="n">last_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

        <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
        <span class="n">filesafe_names_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># @added 20230609 - Task #4806: Manage NUMBA_CACHE_DIR</span>
        <span class="c1">#                   Feature #4702: numba optimisations</span>
        <span class="c1"># Use start up key and allow numba cache files to be created</span>
        <span class="n">starting</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">start_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.starting&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">start_key</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Analyzer could not create Redis </span><span class="si">%s</span><span class="s1"> key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">start_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="c1"># DEVELOPMENT ONLY</span>
            <span class="c1"># @added 20160806 - Bug #1558: Memory leak in Analyzer</span>
            <span class="c1"># Debug with garbage collection - http://code.activestate.com/recipes/65333/</span>
            <span class="k">if</span> <span class="n">ENABLE_MEMORY_PROFILING</span> <span class="ow">and</span> <span class="n">garbage_collection_enabled</span><span class="p">:</span>
                <span class="c1"># As per http://stackoverflow.com/a/1641280</span>
                <span class="c1"># This got useable understandable data with gc</span>
                <span class="n">before</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">after</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">get_objects</span><span class="p">():</span>
                    <span class="n">before</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: Memory usage before looking for checks: </span><span class="si">%s</span><span class="s1"> (kb)&#39;</span> <span class="o">%</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)</span>

            <span class="c1"># Make sure Redis is up</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: skyline can not connect to redis at socket path </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;attempting to connect to redis at socket path </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
                <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
                <span class="c1"># @modified 20191113 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># if settings.REDIS_PASSWORD:</span>
                <span class="c1">#     self.redis_conn = StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="c1"># else:</span>
                <span class="c1">#     self.redis_conn = StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="c1"># @modified 20220429 - Feature #4536: Handle Redis failure</span>
                <span class="c1"># if self.redis_conn.ping():</span>
                <span class="c1">#     logger.info(&#39;connected to redis&#39;)</span>
                <span class="c1"># continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;connected to redis&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to ping Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># Determine if any metric to analyze or Ionosphere alerts to be sent</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

                <span class="c1"># Report app up</span>
                <span class="c1"># @modified 20210524 - Branch #1444: thunder</span>
                <span class="c1"># Report app AND Redis as up</span>
                <span class="c1"># self.redis_conn.setex(skyline_app, 120, now)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_is_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">redis_is_up</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not update the Redis redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">e</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to update Redis key for </span><span class="si">%s</span><span class="s1"> up - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

                <span class="c1"># @added 20200604 - Mirage - populate_redis</span>
                <span class="c1"># This functionality enables Mirage to populate the Skyline</span>
                <span class="c1"># Redis instance with FULL_DURATION data from Graphite if</span>
                <span class="c1"># Analyzer flags the time series as TooShort and adds it too the</span>
                <span class="c1"># mirage.populate_redis Redis set. Or possibly if there are</span>
                <span class="c1"># airgaps in the Redis data due to a network partition.  It will</span>
                <span class="c1"># fill a metric about every 10 seconds or so, unless there are</span>
                <span class="c1"># Mirage checks or ionosphere_alerts to send</span>
                <span class="n">populate_redis_with_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">MIRAGE_AUTOFILL_TOOSHORT</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">populate_redis_with_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage.populate_redis&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get Redis set mirage.populate_redis&#39;</span><span class="p">)</span>
                        <span class="n">populate_redis_with_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">metric_to_populate_redis</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">populate_redis_with_metrics_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">populate_redis_with_metrics</span><span class="p">:</span>
                    <span class="n">populate_redis_with_metrics_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">populate_redis_with_metrics</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> metrics found in mirage.populate_redis Redis set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">populate_redis_with_metrics_count</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_to_populate_redis</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">populate_redis_with_metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">populate_redis_with_metrics</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;processing </span><span class="si">%s</span><span class="s1"> from mirage.populate_redis Redis set&#39;</span> <span class="o">%</span> <span class="n">metric_to_populate_redis</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine metric to populate_redis&#39;</span><span class="p">)</span>
                        <span class="n">metric_to_populate_redis</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">metric_to_populate_redis</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Spawn a populate_redis processes</span>
                        <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">populate_redis</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">metric_to_populate_redis</span><span class="p">))</span>
                        <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting populate_redis process&#39;</span><span class="p">)</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                        <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                        <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                        <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                                <span class="c1"># Just to avoid hogging the CPU</span>
                                <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># All the processes are done, break now.</span>
                                <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;populate_redis process completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">time_to_run</span><span class="p">))</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;timed out, killing populate_redis process&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                                <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                                <span class="c1"># p.join()</span>
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;stopping populate_redis process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())))</span>
                                <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to spawn populate_redis process&#39;</span><span class="p">)</span>

                <span class="c1"># @added 20161228 - Feature #1828: ionosphere - mirage Redis data features</span>
                <span class="c1"># If Ionosphere is going to pass alerts back to the app</span>
                <span class="c1"># here we are going to have break out and force a alerting</span>
                <span class="c1"># only run.</span>
                <span class="n">ionosphere_alerts</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ionosphere_alerts_returned</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
                <span class="c1"># metric</span>
                <span class="n">test_alerts</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">test_alert_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_alerts</span> <span class="o">=</span> <span class="n">get_test_alerts</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_test_alerts failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">test_alerts</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">test_alert_timestamp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_alerts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">use_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">test_alert_timestamp</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test_alert found: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">])))</span>
                        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">anomaly_check_file</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                            <span class="n">use_metric</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="n">alert_tested_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.test_alerts.done.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>
                            <span class="n">alert_tested</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">alert_tested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alert_tested_key</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">alert_tested_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">alert_tested</span> <span class="ow">and</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                                        <span class="n">use_metric</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_metric_id_from_base_name failed for test alert metric </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">use_metric</span><span class="p">:</span>
                                    <span class="n">alert_tested_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.test_alerts.done.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">use_metric</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">alert_tested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alert_tested_key</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">alert_tested_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">alert_tested</span><span class="p">:</span>
                                <span class="n">test_alert_redis_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.test_alerts&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">test_alert_redis_key</span><span class="p">,</span> <span class="n">test_alert_timestamp</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed test_alert for </span><span class="si">%s</span><span class="s1"> from Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_alert_redis_key</span><span class="p">)))</span>
                                <span class="n">test_alert_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">use_metric</span><span class="p">:</span>
                                    <span class="n">test_alert_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">use_metric</span><span class="p">)</span>
                                <span class="k">continue</span>

                            <span class="n">use_metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
                                <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: test_alert - get_metric_id_from_base_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                                <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                                <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                                <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">trigger_anomaly</span> <span class="o">=</span> <span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">][</span><span class="s1">&#39;trigger_anomaly&#39;</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">trigger_anomaly</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">trigger_anomaly</span><span class="p">:</span>
                                <span class="n">test_alert_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test_alert found for </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">])))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed determine test_alert details from test_alerts: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">test_alerts</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">sane_metricname</span> <span class="o">=</span> <span class="n">filesafe_metricname</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                                <span class="n">anomaly_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">sane_metricname</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine name of test_alert anomaly_check_file for: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">]),</span> <span class="n">err</span><span class="p">))</span>
                                <span class="n">anomaly_check_file</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">mirage_anomaly_check_file_created</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">use_hours_to_resolve</span> <span class="o">=</span> <span class="mi">168</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">snab_check_only</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">anomaly_check_file</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anomaly_check_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;metric = &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">value = &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">hours_to_resolve = &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">metric_timestamp = &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">snab_only_check = &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">triggered_algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">metric</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_hours_to_resolve</span><span class="p">),</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_check_only</span><span class="p">),</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)))</span>
                                <span class="n">mirage_anomaly_check_file_created</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added test_alert anomaly_check_file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_check_file</span><span class="p">)))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to write test_alert anomaly_check_file for: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">]),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">mirage_anomaly_check_file_created</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">anomaly_check_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o644</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                            <span class="n">metric_data</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">use_metric</span><span class="p">,</span>
                                <span class="s1">&#39;metric_id&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span>
                                <span class="s1">&#39;metric_dict&#39;</span><span class="p">:</span> <span class="p">{},</span>
                                <span class="s1">&#39;from_timestamp&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">use_timestamp</span> <span class="o">-</span> <span class="p">(</span><span class="n">use_hours_to_resolve</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)),</span>
                                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">use_timestamp</span><span class="p">,</span>
                                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;testing&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;algorithms_run&#39;</span><span class="p">:</span> <span class="n">triggered_algorithms</span><span class="p">,</span>
                                <span class="s1">&#39;snab_only_check&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="s1">&#39;test_alert&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="s1">&#39;trigger_anomaly&#39;</span><span class="p">:</span> <span class="n">trigger_anomaly</span><span class="p">,</span>
                                <span class="s1">&#39;processed_by&#39;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s1">&#39;analyzer_labelled_metrics&#39;</span><span class="p">:</span> <span class="p">{</span>
                                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()),</span>
                                        <span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;testing&#39;</span><span class="p">],</span>
                                        <span class="s1">&#39;algorithms_run&#39;</span><span class="p">:</span> <span class="n">triggered_algorithms</span><span class="p">,</span>
                                        <span class="s1">&#39;waterfall_panorama_data&#39;</span><span class="p">:</span> <span class="p">[],</span>
                                        <span class="s1">&#39;process_number&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="p">},</span>
                                <span class="p">},</span>
                            <span class="p">}</span>
                            <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.mirage_check&#39;</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added mirage check for </span><span class="si">%s</span><span class="s1"> with metric_data: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">([</span><span class="n">labelled_metric_name</span><span class="p">,</span> <span class="s1">&#39;sadd analyzer_labelled_metrics.anomalous_metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)]))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added test_alert anomaly check key to analyzer_labelled_metrics.anomalous_metrics&#39;</span><span class="p">)</span>
                            <span class="c1"># try:</span>
                            <span class="c1">#     self.redis_conn_decoded.hdel(&#39;mirage.test_alerts&#39;, str(test_alert_timestamp))</span>
                            <span class="c1"># except Exception as err:</span>
                            <span class="c1">#     logger.error(&#39;error :: failed to delete %s from mirage.test_alerts&#39; % str(test_alert_timestamp))</span>

                <span class="n">metric_var_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
                <span class="c1"># @modified 20190408 - Bug #2904: Initial Ionosphere echo load and Ionosphere feedback</span>
                <span class="c1">#                      Feature #2484: FULL_DURATION feature profiles</span>
                <span class="c1"># Do not pospone the Ionosphere alerts check on based on whether</span>
                <span class="c1"># there are checks on not</span>
                <span class="c1"># if len(metric_var_files) == 0:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_alerts_returned</span><span class="p">:</span>
                    <span class="c1"># @modified 20161228 - Feature #1830: Ionosphere alerts</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20200430 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># ionosphere_alerts = list(self.redis_conn.scan_iter(match=&#39;ionosphere.mirage.alert.*&#39;))</span>
                        <span class="n">ionosphere_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scan_iter</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="s1">&#39;ionosphere.mirage.alert.*&#39;</span><span class="p">))</span>
                        <span class="n">ionosphere_alerts_returned</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to scan ionosphere.mirage.alert.* from Redis&#39;</span><span class="p">)</span>
                        <span class="n">ionosphere_alerts</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ionosphere_alerts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ionosphere_alerts_returned</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ionosphere alert requested :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_alerts</span><span class="p">))</span>

                    <span class="c1"># @modified 20190408 - Bug #2904: Initial Ionosphere echo load and Ionosphere feedback</span>
                    <span class="c1">#                      Feature #2484: FULL_DURATION feature profiles</span>
                    <span class="c1"># Do not pospone the Ionosphere alerts check</span>
                    <span class="c1"># if not ionosphere_alerts_returned:</span>
                    <span class="c1">#     logger.info(&#39;sleeping no metrics...&#39;)</span>
                    <span class="c1">#     sleep(10)</span>

                <span class="c1"># @added 20191106 - Branch #3262: py3</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">alert_test_file</span><span class="p">):</span>
                    <span class="n">test_alert</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">((</span><span class="n">alert_test_file</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                            <span class="n">raw_test_alert</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">test_alert</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">raw_test_alert</span><span class="p">)</span>
                        <span class="c1"># [metric, alerter]</span>
                        <span class="c1"># e.g. [&#39;server-1.cpu.user&#39;, &#39;smtp&#39;]</span>
                        <span class="c1"># e.g. [&#39;server-1.cpu.user&#39;, &#39;slack&#39;]</span>
                        <span class="c1"># e.g. [&#39;skyline_test.alerters.test&#39;, &#39;smtp&#39;]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not evaluate test_alert from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">alert_test_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">test_alert</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test alert metric found - alerting on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">((</span><span class="n">test_alert</span><span class="p">)))</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">test_alerter</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">alerter_id</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">alerter_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_alert</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                            <span class="n">alert</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">test_alerter</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">alerter_id</span><span class="p">:</span>
                                <span class="n">alert</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">test_alerter</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;external&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">alerter_id</span><span class="p">})</span>

                            <span class="c1"># @added 20210304 - Feature #3642: Anomaly type classification</span>
                            <span class="c1">#                   Feature #3970: custom_algorithm - adtk_level_shift</span>
                            <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;testing&#39;</span><span class="p">]</span>

                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">SLACK_ENABLED</span> <span class="ow">and</span> <span class="n">test_alerter</span> <span class="o">==</span> <span class="s1">&#39;slack&#39;</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test alert to slack for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">))</span>
                                <span class="c1"># @modified 20210304 - Feature #3642: Anomaly type classification</span>
                                <span class="c1">#                      Feature #3970: custom_algorithm - adtk_level_shift</span>
                                <span class="c1"># Added triggered_algorithms</span>
                                <span class="n">trigger_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="mi">604800</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>
                            <span class="c1"># @added 20220301 - Feature #4482: Test alerts</span>
                            <span class="c1"># Allow all alert types to be tested</span>
                            <span class="k">if</span> <span class="n">test_alerter</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http_alerter&#39;</span><span class="p">):</span>
                                <span class="n">trigger_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="mi">604800</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">test_alerter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sms&#39;</span><span class="p">,</span> <span class="s1">&#39;pagerduty&#39;</span><span class="p">]:</span>
                                <span class="n">trigger_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="mi">604800</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">test_alerter</span> <span class="o">==</span> <span class="s1">&#39;smtp&#39;</span><span class="p">:</span>
                                <span class="c1"># @modified 20210304 - Feature #3642: Anomaly type classification</span>
                                <span class="c1">#                      Feature #3970: custom_algorithm - adtk_level_shift</span>
                                <span class="c1"># Added triggered_algorithms</span>
                                <span class="n">smtp_trigger_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="mi">604800</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: test trigger_alert - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to test trigger_alert :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">alert_test_file</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">alert_test_file</span><span class="p">)</span>

                <span class="c1"># @modified 20190408 - Bug #2904: Initial Ionosphere echo load and Ionosphere feedback</span>
                <span class="c1">#                      Feature #2484: FULL_DURATION feature profiles</span>
                <span class="c1"># Move this len(metric_var_files) from above and apply the</span>
                <span class="c1"># appropriatte sleep</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_alerts_returned</span><span class="p">:</span>
                        <span class="c1"># @modified 20200604 - Mirage - populate_redis</span>
                        <span class="c1"># Do not sleep if there are metrics to populate in Redis</span>
                        <span class="k">if</span> <span class="n">populate_redis_with_metrics_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                            <span class="n">sleep_for</span> <span class="o">=</span> <span class="mi">10</span>
                            <span class="n">next_send_to_graphite</span> <span class="o">=</span> <span class="n">last_sent_to_graphite</span> <span class="o">+</span> <span class="mi">60</span>
                            <span class="n">seconds_to_next_send_to_graphite</span> <span class="o">=</span> <span class="n">next_send_to_graphite</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                            <span class="k">if</span> <span class="n">seconds_to_next_send_to_graphite</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">seconds_to_next_send_to_graphite</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">sleep_for</span> <span class="o">=</span> <span class="n">seconds_to_next_send_to_graphite</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">break</span>

                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sleeping no metrics...&#39;</span><span class="p">)</span>
                            <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                            <span class="c1"># sleep(10)</span>
                            <span class="n">sleep</span><span class="p">(</span><span class="n">sleep_for</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no checks or alerts, continuing to process populate_redis metrics&#39;</span><span class="p">)</span>
                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># Removed sleep, no delay</span>
                <span class="c1"># else:</span>
                <span class="c1">#    sleep(1)</span>

                <span class="c1"># @added 20220113 - Feature #3486: analyzer_batch</span>
                <span class="c1">#                   Feature #3480: batch_processing</span>
                <span class="c1"># Do not remove batch_processing checks</span>
                <span class="n">batch_processing_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">batch_processing_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.batch_processing_metrics&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get aet.analyzer.batch_processing_metrics from Redis&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

                <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">filesafe_names_dict</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">filesafe_names_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.filesafe_base_names&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: hgetall metrics_manager.filesafe_base_names failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># Clean up old files</span>
                <span class="n">now_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="n">stale_age</span> <span class="o">=</span> <span class="n">now_timestamp</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_STALE_SECONDS</span>
                <span class="k">for</span> <span class="n">current_file</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">):</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">)</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">st_ctime</span>

                        <span class="c1"># @added 20220113 - Feature #3486: analyzer_batch</span>
                        <span class="c1">#                   Feature #3480: batch_processing</span>
                        <span class="c1"># Do not remove batch_processing checks</span>
                        <span class="k">for</span> <span class="n">b_metric</span> <span class="ow">in</span> <span class="n">batch_processing_metrics</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">b_metric</span> <span class="ow">in</span> <span class="n">current_file</span><span class="p">:</span>
                                <span class="k">continue</span>

                        <span class="c1"># delete file if older than a week</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">stale_age</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed stale check - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_file</span><span class="p">))</span>
                            <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.stale_check_discarded&#39;</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_file</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">current_file</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                <span class="c1"># Handle filesafe names</span>
                <span class="n">filesafe_names_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">filesafe_names_dict</span><span class="p">:</span>
                    <span class="n">filesafe_names_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filesafe_names_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
                <span class="n">mute_alerts_on_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mute_alerts_on_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.mute_alerts_on&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to hgetall metrics_manager.mute_alerts_on - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="n">mute_alerts_on</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_metric</span> <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mute_alerts_on_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">mute_alerts_on</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding </span><span class="si">%s</span><span class="s1"> mute_alert_on metrics to SKYLINE_FEEDBACK_NAMESPACES&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mute_alerts_on</span><span class="p">)))</span>

                <span class="n">CURRENT_SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">+</span> <span class="n">mute_alerts_on</span><span class="p">))</span>

                <span class="c1"># @added 20201026 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                <span class="c1"># Handle feedback metrics in a similar style to Ionosphere</span>
                <span class="c1"># Do not run checks if namespace has matched multiple times in</span>
                <span class="c1"># the last 10 minutes.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">feedback_metric_loop_error_logged</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">current_file</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">):</span>
                        <span class="n">feedback_metric</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">remove_feedback_metric_check</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">remove_alerted_on_metric_check</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">current_file_no_extension</span> <span class="o">=</span> <span class="n">current_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="n">current_file_no_extension_elements</span> <span class="o">=</span> <span class="n">current_file_no_extension</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                            <span class="n">base_name</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_file_no_extension_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                            <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_file_no_extension_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="c1"># @modified 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                        <span class="c1"># Handle filesafe names</span>
                        <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">filesafe_names_list</span><span class="p">:</span>
                            <span class="n">use_base_name</span> <span class="o">=</span> <span class="n">filesafe_names_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_namespace_elements</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                            <span class="c1"># @modified 20230605 - Feature #4932: mute_alerts_on</span>
                            <span class="c1"># for to_skip in SKYLINE_FEEDBACK_NAMESPACES:</span>
                            <span class="k">for</span> <span class="n">to_skip</span> <span class="ow">in</span> <span class="n">CURRENT_SKYLINE_FEEDBACK_NAMESPACES</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">to_skip</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                                    <span class="n">feedback_metric</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">break</span>
                                <span class="n">to_skip_namespace_elements</span> <span class="o">=</span> <span class="n">to_skip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                                <span class="n">elements_matched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metric_namespace_elements</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_skip_namespace_elements</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements_matched</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_skip_namespace_elements</span><span class="p">):</span>
                                    <span class="n">feedback_metric</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">break</span>
                            <span class="n">feedback_cache_key_exists</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">feedback_cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.feedback_metric.checked.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">)</span>

                            <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                            <span class="c1"># Handle filesafe names</span>
                            <span class="k">if</span> <span class="n">use_base_name</span> <span class="o">!=</span> <span class="n">base_name</span><span class="p">:</span>
                                <span class="n">feedback_cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.feedback_metric.checked.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">use_base_name</span><span class="p">)</span>

                            <span class="n">feedback_metric_process_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

                            <span class="c1"># @added 20210701 - Feature #4152: DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span>
                            <span class="k">if</span> <span class="n">feedback_metric</span><span class="p">:</span>
                                <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span><span class="p">)</span>
                                    <span class="k">del</span> <span class="n">metric_matched_by</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: matched_or_regexed_in_list failed checking </span><span class="si">%s</span><span class="s1"> in DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                                    <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                                    <span class="n">feedback_metric</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> matched DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES, will analyse&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">feedback_metric</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">feedback_cache_key_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feedback_cache_key</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get </span><span class="si">%s</span><span class="s1"> key from Redis&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">feedback_cache_key</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">feedback_cache_key_exists</span><span class="p">:</span>
                                    <span class="n">feedback_metric_last_processed_seconds_ago</span> <span class="o">=</span> <span class="n">feedback_metric_process_time</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">feedback_cache_key_exists</span><span class="p">)</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;feedback metric identified as last processed </span><span class="si">%s</span><span class="s1"> seconds ago via Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">feedback_metric_last_processed_seconds_ago</span><span class="p">),</span> <span class="n">feedback_cache_key</span><span class="p">))</span>
                                    <span class="n">remove_feedback_metric_check</span> <span class="o">=</span> <span class="kc">True</span>

                                    <span class="c1"># @added 20210505 - Bug #4048: Mirage - removing feedback metrics to be processed</span>
                                    <span class="n">feedback_processed_cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.feedback_metric.processed.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">)</span>

                                    <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                                    <span class="c1"># Handle filesafe names</span>
                                    <span class="k">if</span> <span class="n">use_base_name</span> <span class="o">!=</span> <span class="n">base_name</span><span class="p">:</span>
                                        <span class="n">feedback_processed_cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.feedback_metric.processed.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">use_base_name</span><span class="p">)</span>

                                    <span class="n">feedback_processed_cache_key_exists</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">feedback_processed_cache_key_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feedback_processed_cache_key</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get </span><span class="si">%s</span><span class="s1"> key from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">feedback_processed_cache_key</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">feedback_processed_cache_key_exists</span><span class="p">:</span>
                                        <span class="n">remove_feedback_metric_check</span> <span class="o">=</span> <span class="kc">False</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;feedback metric Redis key </span><span class="si">%s</span><span class="s1"> does not exist, not removing metric&#39;</span> <span class="o">%</span> <span class="n">feedback_processed_cache_key</span><span class="p">)</span>

                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">feedback_cache_key_exists</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Mirage is busy removing feedback metric check&#39;</span><span class="p">)</span>
                                    <span class="n">remove_feedback_metric_check</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="c1"># @modified 20201128 - Feature #3734: waterfall alerts</span>
                                <span class="c1"># Only add if does not exist and always add</span>
                                <span class="c1"># else:</span>
                                <span class="c1">#        try:</span>
                                <span class="c1">#            self.redis_conn.setex(feedback_cache_key, 600, feedback_metric_process_time)</span>
                                <span class="c1"># if not feedback_cache_key_exists:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">feedback_cache_key_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">remove_feedback_metric_check</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;feedback metric identified as not processed in last 600 seconds adding Redis key with 600 TTL and processing - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">feedback_cache_key</span><span class="p">)</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">feedback_cache_key</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="n">feedback_metric_process_time</span><span class="p">)</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> key to Redis&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">feedback_cache_key</span><span class="p">)))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">feedback_metric_loop_error_logged</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to check feedback and alerted on metrics&#39;</span><span class="p">)</span>
                                <span class="n">feedback_metric_loop_error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># Remove checks that have been alerted on by Mirage or</span>
                        <span class="c1"># via an Analyzer waterfall alert</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">remove_feedback_metric_check</span><span class="p">:</span>
                            <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.last_alert.smtp.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">)</span>

                            <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                            <span class="c1"># Handle filesafe names</span>
                            <span class="k">if</span> <span class="n">use_base_name</span> <span class="o">!=</span> <span class="n">base_name</span><span class="p">:</span>
                                <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.last_alert.smtp.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">use_base_name</span><span class="p">)</span>

                            <span class="n">alerted_on</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">alerted_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not query Redis for cache_key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">alerted_on</span><span class="p">:</span>
                                <span class="c1"># Check for Analyzer alert key from waterfall alert</span>
                                <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;last_alert.smtp.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">)</span>

                                <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                                <span class="c1"># Handle filesafe names</span>
                                <span class="k">if</span> <span class="n">use_base_name</span> <span class="o">!=</span> <span class="n">base_name</span><span class="p">:</span>
                                    <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;last_alert.smtp.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">use_base_name</span><span class="p">)</span>

                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">alerted_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not query Redis for cache_key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">alerted_on</span><span class="p">:</span>
                                <span class="n">remove_alerted_on_metric_check</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="c1"># Unless is it older than PANORAMA_EXPIRY_TIME</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">alerted_on_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">alerted_on</span><span class="p">)</span>
                                    <span class="n">alerted_on_seconds_ago</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="n">alerted_on_at</span>
                                    <span class="k">if</span> <span class="n">alerted_on_seconds_ago</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_EXPIRY_TIME</span><span class="p">:</span>
                                        <span class="n">remove_alerted_on_metric_check</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed determining if alerted more than PANORAMA_EXPIRY_TIME seconds ago - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                                    <span class="n">remove_alerted_on_metric_check</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">remove_feedback_metric_check</span> <span class="ow">or</span> <span class="n">remove_alerted_on_metric_check</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">remove_feedback_metric_check</span><span class="p">:</span>
                                <span class="n">log_str</span> <span class="o">=</span> <span class="s1">&#39;feedback metric&#39;</span>
                            <span class="k">if</span> <span class="n">remove_alerted_on_metric_check</span><span class="p">:</span>
                                <span class="n">log_str</span> <span class="o">=</span> <span class="s1">&#39;alerted on metric&#39;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removing </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> check file and from analyzer.waterfall_alerts.sent_to_mirage Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">log_str</span><span class="p">,</span> <span class="n">base_name</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">log_str</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">current_file</span><span class="p">))</span>
                            <span class="c1"># Remove the metric from the waterfall_alerts Redis set</span>
                            <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp. waterfall_panorama_data]</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">analyzer_waterfall_alerts</span><span class="p">:</span>
                                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
                                <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">literal_waterfall_alert</span> <span class="ow">in</span> <span class="n">literal_analyzer_waterfall_alerts</span><span class="p">:</span>
                                    <span class="n">waterfall_alert</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">literal_waterfall_alert</span><span class="p">)</span>
                                    <span class="n">analyzer_waterfall_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)</span>

                            <span class="k">for</span> <span class="n">waterfall_alert</span> <span class="ow">in</span> <span class="n">analyzer_waterfall_alerts</span><span class="p">:</span>

                                <span class="c1"># @modified 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                                <span class="c1"># Handle filesafe names</span>
                                <span class="c1"># if waterfall_alert[0] == base_name:</span>
                                <span class="k">if</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">use_base_name</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed waterfall alert item for </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="n">log_str</span><span class="p">,</span> <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                                            <span class="c1"># @modified 20201128 - Feature #3734: waterfall alerts</span>
                                            <span class="c1"># Do not break, check and remove</span>
                                            <span class="c1"># waterfall_alert items with older</span>
                                            <span class="c1"># timestamps as well</span>
                                            <span class="c1"># break</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="n">log_str</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                                    <span class="c1"># @added 20201128 - Feature #3734: waterfall alerts</span>
                                    <span class="c1"># If the check just done is new than an existing analyzer</span>
                                    <span class="c1"># waterfall alert metric timestamp remove those keys as well</span>
                                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed waterfall alert item with older timestamp for </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="n">log_str</span><span class="p">,</span> <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="n">log_str</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>

                <span class="c1"># Discover metric to analyze</span>
                <span class="n">metric_var_files</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="c1"># @added 20161228 - Feature #1830: Ionosphere alerts</span>
                <span class="c1"># Prioritises Ionosphere alerts</span>
                <span class="k">if</span> <span class="n">ionosphere_alerts_returned</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="n">metric_var_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">process_metric_check_files</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @modified 20161228 - Feature #1830: Ionosphere alerts</span>
            <span class="c1"># Only spawn process if this is not an Ionosphere alert</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_alerts_returned</span><span class="p">:</span>
                <span class="n">metric_var_files_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span>
                <span class="c1"># metric_check_file = settings.MIRAGE_CHECK_PATH + &quot;/&quot; + metric_var_files_sorted[0]</span>
                <span class="k">if</span> <span class="n">metric_var_files_sorted</span><span class="p">:</span>
                    <span class="n">process_metric_check_files</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Grab data from the queue and populate dictionaries</span>
            <span class="n">exceptions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">anomaly_breakdown</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">process_metric_check_files</span><span class="p">:</span>

                <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="n">check_files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files_sorted</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> checks to process&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">check_files_to_process</span><span class="p">))</span>

                <span class="c1"># Remove any existing algorithm.error files from any previous runs</span>
                <span class="c1"># that did not cleanup for any reason</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.*.algorithm.error&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cleaning up old error file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>
                            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                <span class="k">pass</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to cleanup mirage_algorithm.error files - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>

                <span class="c1"># Spawn processes</span>
                <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># MIRAGE_PROCESSES = 1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_PROCESSES</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIRAGE_PROCESSES</span><span class="p">:</span>
                            <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># processing_check_file = metric_var_files_sorted[0]</span>
                <span class="c1"># logger.info(&#39;processing %s&#39; % processing_check_file)</span>
                <span class="c1"># @modified 20200909 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># for i in range(1, MIRAGE_PROCESSES + 1):</span>
                <span class="c1">#     up_to = i - 1</span>
                <span class="c1">#     processing_check_file = metric_var_files_sorted[up_to]</span>
                <span class="c1">#     logger.info(&#39;processing %s&#39; % processing_check_file)</span>

                <span class="c1"># @added 20221014 - Feature #4576: mirage - process multiple metrics</span>
                <span class="n">max_metrics</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">MIRAGE_PROCESSES</span>
                <span class="n">multiple_check_files</span> <span class="o">=</span> <span class="n">metric_var_files_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_metrics</span><span class="p">]</span>
                <span class="n">last_index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">process_index_range</span> <span class="o">=</span> <span class="mi">29</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiple_check_files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
                    <span class="n">process_index_range</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">multiple_check_files</span><span class="p">)</span> <span class="o">/</span> <span class="n">MIRAGE_PROCESSES</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiple_check_files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="n">process_index_range</span> <span class="o">=</span> <span class="mi">30</span>
                    <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">process_single_check_mode</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @modified 20161224 - send mirage metrics to graphite</span>
                <span class="c1"># run_timestamp = int(now)</span>
                <span class="n">run_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">MIRAGE_PROCESSES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

                    <span class="c1"># @added 20200909 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="n">up_to</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="c1"># processing_check_file = metric_var_files_sorted[up_to]</span>
                    <span class="c1"># logger.info(&#39;processing %s&#39; % processing_check_file)</span>

                    <span class="c1"># @modified 20200909 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># p = Process(target=self.spin_process, args=(i, run_timestamp, metric_var_files_sorted))</span>
                    <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                    <span class="c1"># p = Process(target=self.spin_process, args=(i, run_timestamp, processing_check_file))</span>
                    <span class="n">end_index</span> <span class="o">=</span> <span class="n">last_index</span> <span class="o">+</span> <span class="n">process_index_range</span>
                    <span class="n">processing_check_files</span> <span class="o">=</span> <span class="n">multiple_check_files</span><span class="p">[</span><span class="n">last_index</span><span class="p">:</span><span class="n">end_index</span><span class="p">]</span>
                    <span class="n">last_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_index</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;process </span><span class="si">%s</span><span class="s1"> - processing </span><span class="si">%s</span><span class="s1"> checks&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processing_check_files</span><span class="p">))))</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin_process</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">run_timestamp</span><span class="p">,</span> <span class="n">processing_check_files</span><span class="p">))</span>

                    <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> spin_process/es&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pid_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">MIRAGE_PROCESSES</span><span class="p">)))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># spawned_pids.append(p.pid)</span>
                    <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;started spin_process </span><span class="si">%s</span><span class="s1"> with pid </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pid_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)))</span>

                <span class="c1"># @added 20230609 - Task #4806: Manage NUMBA_CACHE_DIR</span>
                <span class="c1">#                   Feature #4702: numba optimisations</span>
                <span class="c1"># Use start up key and allow numba cache files to be created</span>
                <span class="n">start_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.starting&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
                <span class="n">max_analyzer_process_runtime</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAX_ANALYZER_PROCESS_RUNTIME</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">starting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">start_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">starting</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage is starting max_analyzer_process_runtime set to 300&#39;</span><span class="p">)</span>
                        <span class="n">max_analyzer_process_runtime</span> <span class="o">=</span> <span class="mi">300</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">starting</span> <span class="o">=</span> <span class="kc">False</span>                
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: exists failed on Redis </span><span class="si">%s</span><span class="s1"> key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">start_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="c1"># Send wait signal to zombie processes</span>
                <span class="c1"># for p in pids:</span>
                <span class="c1">#     p.join()</span>
                <span class="c1"># Self monitor processes and terminate if any spin_process has run</span>
                <span class="c1"># for longer than 180 seconds - 20160512 @earthgecko</span>
                <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="c1"># @modified 20230609 - Task #4806: Manage NUMBA_CACHE_DIR</span>
                <span class="c1">#                      Feature #4702: numba optimisations</span>
                <span class="c1"># Use start up key and allow numba cache files to be created</span>
                <span class="c1"># while time() - p_starts &lt;= settings.MAX_ANALYZER_PROCESS_RUNTIME:</span>
                <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="n">max_analyzer_process_runtime</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                        <span class="c1"># Just to avoid hogging the CPU</span>
                        <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># All the processes are done, break now.</span>
                        <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: </span><span class="si">%s</span><span class="s1"> spin_process/es completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">MIRAGE_PROCESSES</span><span class="p">),</span> <span class="n">time_to_run</span><span class="p">))</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: timed out, killing all spin_process processes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                        <span class="c1"># p.join()</span>

                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: stopping spin_process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())))</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                <span class="c1"># @added 20200607 - Feature #3508: ionosphere.untrainable_metrics</span>
                <span class="c1"># Check to non 3sigma algorithm errors too</span>
                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: adding negatives_present to check_algorithm_errors&#39;</span><span class="p">)</span>
                <span class="n">check_algorithm_errors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;negatives_present&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_ALGORITHMS</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">LOCAL_DEBUG</span> <span class="ow">or</span> <span class="n">DEBUG_CUSTOM_ALGORITHMS</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: adding </span><span class="si">%s</span><span class="s1"> to check_algorithm_errors&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">algorithm</span><span class="p">))</span>
                    <span class="n">check_algorithm_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
                <span class="c1"># @added 20200607 - Feature #3566: custom_algorithms</span>
                <span class="k">if</span> <span class="n">CUSTOM_ALGORITHMS</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">custom_algorithm</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">CUSTOM_ALGORITHMS</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span> <span class="ow">or</span> <span class="n">DEBUG_CUSTOM_ALGORITHMS</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: adding custom_algorithm </span><span class="si">%s</span><span class="s1"> to check_algorithm_errors&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">custom_algorithm</span><span class="p">))</span>
                        <span class="n">check_algorithm_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">custom_algorithm</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span> <span class="ow">or</span> <span class="n">DEBUG_CUSTOM_ALGORITHMS</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: checking for algorithm error files&#39;</span><span class="p">)</span>

                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># for completed_pid in spawned_pids:</span>
                <span class="k">for</span> <span class="n">completed_pid</span><span class="p">,</span> <span class="n">mirage_process</span> <span class="ow">in</span> <span class="n">spawned_pids</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;spin_process with pid </span><span class="si">%s</span><span class="s1"> completed&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">completed_pid</span><span class="p">)))</span>
                    <span class="c1"># @modified 20200607 - Feature #3566: custom_algorithms</span>
                    <span class="c1">#                      Feature #3508: ionosphere.untrainable_metrics</span>
                    <span class="c1"># Check to non 3sigma algorithm errors too and wrapped in try</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># for algorithm in settings.MIRAGE_ALGORITHMS:</span>
                        <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">check_algorithm_errors</span><span class="p">:</span>
                            <span class="n">algorithm_error_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.algorithm.error&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">completed_pid</span><span class="p">),</span> <span class="n">algorithm</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">algorithm_error_file</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s1">&#39;error :: spin_process with pid </span><span class="si">%s</span><span class="s1"> has reported an error with the </span><span class="si">%s</span><span class="s1"> algorithm&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">completed_pid</span><span class="p">),</span> <span class="n">algorithm</span><span class="p">))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">algorithm_error_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                        <span class="n">error_string</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read </span><span class="si">%s</span><span class="s1"> error file&#39;</span> <span class="o">%</span> <span class="n">algorithm</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">algorithm_error_file</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to check algorithm errors&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">LOCAL_DEBUG</span> <span class="ow">or</span> <span class="n">DEBUG_CUSTOM_ALGORITHMS</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: checked for algorithm error files&#39;</span><span class="p">)</span>

                    <span class="c1"># Grab data from the queue and populate dictionaries</span>
                    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirage_anomaly_breakdown_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">anomaly_breakdown</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                            <span class="c1"># @added 20191113 - Branch #3262: py3</span>
                            <span class="c1"># Log</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;anomaly_breakdown.keys are empty&#39;</span><span class="p">)</span>
                            <span class="k">break</span>

                    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirage_exceptions_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="n">exceptions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">exceptions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                            <span class="c1"># @added 20191113 - Branch #3262: py3</span>
                            <span class="c1"># Log</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exceptions.keys are empty&#39;</span><span class="p">)</span>
                            <span class="k">break</span>

                    <span class="c1"># @added 20191021 - Bug #3288: Always send anomaly_breakdown and exception metrics</span>
                    <span class="c1">#                   Branch #3262: py3</span>
                    <span class="n">exceptions_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Boring&#39;</span><span class="p">,</span> <span class="s1">&#39;Stale&#39;</span><span class="p">,</span> <span class="s1">&#39;TooShort&#39;</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i_exception</span> <span class="ow">in</span> <span class="n">exceptions_metrics</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i_exception</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">exceptions</span><span class="p">[</span><span class="n">i_exception</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># @modified 20200607 - Feature #3566: custom_algorithms</span>
                    <span class="c1"># for i_anomaly_breakdown in settings.MIRAGE_ALGORITHMS:</span>
                    <span class="k">for</span> <span class="n">i_anomaly_breakdown</span> <span class="ow">in</span> <span class="n">check_algorithm_errors</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i_anomaly_breakdown</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">anomaly_breakdown</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">i_anomaly_breakdown</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                    <span class="c1"># Use Redis set and not self.metric_variables</span>

                    <span class="c1"># @modified 20221014 - Feature #4576: mirage - process multiple metrics</span>
                    <span class="k">if</span> <span class="n">process_single_check_mode</span><span class="p">:</span>

                        <span class="n">metric_variables</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># literal_metric_variables = list(self.redis_conn.smembers(&#39;mirage.metric_variables&#39;))</span>
                        <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                        <span class="c1"># Handle per process</span>
                        <span class="c1"># literal_metric_variables = list(self.redis_conn_decoded.smembers(&#39;mirage.metric_variables&#39;))</span>
                        <span class="n">metric_variable_redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.</span><span class="si">%s</span><span class="s1">.metric_variables&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">mirage_process</span><span class="p">)</span>
                        <span class="n">literal_metric_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">metric_variable_redis_set</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">item_list_string</span> <span class="ow">in</span> <span class="n">literal_metric_variables</span><span class="p">:</span>
                            <span class="n">list_item</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">item_list_string</span><span class="p">)</span>
                            <span class="n">metric_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_item</span><span class="p">)</span>

                        <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                        <span class="c1"># Handle per process</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">metric_variable_redis_set</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;deleted Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_variable_redis_set</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to delete Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_variable_redis_set</span><span class="p">)</span>

                        <span class="c1"># @added 20191113 - Branch #3262: py3</span>
                        <span class="c1"># Set default values</span>
                        <span class="n">metric_name</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">metric_value</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">hours_to_resolve</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># for metric_variable in self.metric_variables:</span>
                        <span class="k">for</span> <span class="n">metric_variable</span> <span class="ow">in</span> <span class="n">metric_variables</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metric_name&#39;</span><span class="p">:</span>
                                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metric_value&#39;</span><span class="p">:</span>
                                <span class="n">metric_value</span> <span class="o">=</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">:</span>
                                <span class="n">hours_to_resolve</span> <span class="o">=</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="c1"># if metric_variable[0] == &#39;metric_timestamp&#39;:</span>
                            <span class="c1">#     metric_timestamp = metric_variable[1]</span>
                            <span class="c1"># @added 20221014 - Feature #4576: mirage - process multiple metrics</span>
                            <span class="k">if</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metric_timestamp&#39;</span><span class="p">:</span>
                                <span class="n">metric_check_timestamp</span> <span class="o">=</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analysis done - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">))</span>

                        <span class="c1"># Send alerts</span>
                        <span class="c1"># Calculate hours second order resolution to seconds</span>
                        <span class="c1"># @modified 20191113 - Branch #3262: py3</span>
                        <span class="c1"># Only if set</span>
                        <span class="k">if</span> <span class="n">hours_to_resolve</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzed at </span><span class="si">%s</span><span class="s1"> hours resolution&#39;</span> <span class="o">%</span> <span class="n">hours_to_resolve</span><span class="p">)</span>
                            <span class="n">second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hours_to_resolve</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzed at </span><span class="si">%s</span><span class="s1"> seconds resolution&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">))</span>

                        <span class="c1"># @added 20221014 - Feature #4576: mirage - process multiple metrics</span>
                        <span class="n">processing_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_timestamp</span><span class="p">),</span> <span class="n">metric_name</span><span class="p">)</span>

                        <span class="c1"># Remove metric check file</span>
                        <span class="n">metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">,</span> <span class="n">processing_check_file</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: interpolated metric_check_file to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to interpolate metric_check_file&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: no metric_check_file to remove OK - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>

                        <span class="c1"># Remove the metric directory</span>
                        <span class="c1"># @modified 20191113 - Branch #3262: py3</span>
                        <span class="c1"># Convert None to str</span>
                        <span class="c1"># timeseries_dir = metric_name.replace(&#39;.&#39;, &#39;/&#39;)</span>
                        <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                            <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">metric_name_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                            <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: metric_data_dir interpolated to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to interpolate metric_data_dir&#39;</span><span class="p">)</span>
                            <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>

                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">rmtree</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to rmtree </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: metric_data_dir does not exist - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">))</span>

                <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_ENABLE_ALERTS</span><span class="p">:</span>
                    <span class="c1"># @added 20161228 - Feature #1830: Ionosphere alerts</span>
                    <span class="c1">#                   Branch #922: Ionosphere</span>
                    <span class="c1"># Bringing Ionosphere online - do alert on Ionosphere metrics</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># ionosphere_unique_metrics = list(self.redis_conn.smembers(&#39;ionosphere.unique_metrics&#39;))</span>
                        <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get ionosphere.unique_metrics from Redis&#39;</span><span class="p">)</span>
                        <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: settings.MIRAGE_ENABLE_ALERTS is not True&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20161228 - Feature #1830: Ionosphere alerts</span>
            <span class="c1">#                   Branch #922: Ionosphere</span>
            <span class="c1"># Send alerts for Ionosphere</span>
            <span class="n">alert_context</span> <span class="o">=</span> <span class="s1">&#39;Mirage&#39;</span>
            <span class="k">if</span> <span class="n">ionosphere_alerts_returned</span><span class="p">:</span>
                <span class="n">alert_context</span> <span class="o">=</span> <span class="s1">&#39;Ionosphere&#39;</span>
                <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ionosphere alerts requested emptying ionosphere_unique_metrics so Mirage will alert&#39;</span><span class="p">)</span>
                <span class="n">exceptions</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># @modified 20190524 - Branch #3002</span>
                <span class="c1"># Wrapped in try except</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">run_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="c1"># @modified 20200430 - Bug #3266: py3 Redis binary objects not strings</span>
                    <span class="c1">#                      Branch #3262: py3</span>
                    <span class="c1"># ionosphere_alert_on = list(self.redis_conn.scan_iter(match=&#39;ionosphere.mirage.alert.*&#39;))</span>
                    <span class="n">ionosphere_alert_on</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scan_iter</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="s1">&#39;ionosphere.mirage.alert.*&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get ionosphere.mirage.alert.* from Redis key scan&#39;</span><span class="p">)</span>
                    <span class="n">ionosphere_alert_on</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="n">ionosphere_alert_on</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20200322 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># alert_on = self.redis_conn.get(cache_key)</span>
                        <span class="n">alert_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                        <span class="n">send_alert_for</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">alert_on</span><span class="p">)</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">send_alert_for</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">send_alert_for</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">send_alert_for</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="n">send_alert_for</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="c1"># @added 20201001 - Task #3748: POC SNAB</span>
                        <span class="c1"># Added algorithms_run required to determine the anomalyScore</span>
                        <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">send_alert_for</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

                        <span class="n">second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">send_alert_for</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

                        <span class="c1"># @modified 20201007 - Feature #3772: Add the anomaly_id to the http_alerter json</span>
                        <span class="c1">#                      Branch #3068: SNAB</span>
                        <span class="c1"># Added triggered_algorithms and algorithms_run</span>
                        <span class="c1"># anomalous_metric = [value, base_name, metric_timestamp, second_order_resolution_seconds]</span>
                        <span class="n">anomalous_metric</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">algorithms_run</span><span class="p">]</span>

                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># self.anomalous_metrics.append(anomalous_metric)</span>
                        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.anomalous_metrics&#39;</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalous_metric</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                        <span class="c1"># @added 20210323 - Feature #3642: Anomaly type classification</span>
                        <span class="k">if</span> <span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span><span class="p">:</span>
                            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;luminosity.classify_anomalies&#39;</span>
                            <span class="n">added_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">base_name</span><span class="p">,</span>
                                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                                <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="n">algorithms_run</span><span class="p">,</span>
                                <span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">:</span> <span class="n">triggered_algorithms</span><span class="p">,</span>
                                <span class="s1">&#39;app&#39;</span><span class="p">:</span> <span class="n">skyline_app</span><span class="p">,</span>
                                <span class="s1">&#39;added_at&#39;</span><span class="p">:</span> <span class="n">added_at</span><span class="p">,</span>
                            <span class="p">}</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">added_at</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                        <span class="n">anomaly_breakdown</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">triggered_algorithms</span><span class="p">:</span>
                            <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="c1"># @modified 20200322 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># logger.error(&#39;error :: failed to add an Ionosphere anomalous_metric for %s&#39; % base_name)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add an Ionosphere anomalous_metric for cache key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: no ionosphere_alerts_returned - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_alerts_returned</span><span class="p">))</span>

            <span class="c1"># @added 20181114 - Bug #2682: Reduce mirage ionosphere alert loop</span>
            <span class="c1"># To reduce the amount of I/O used by Mirage in this loop check</span>
            <span class="c1"># and reduce the number of log entries for &#39;not alerting - Ionosphere metric&#39;</span>
            <span class="c1"># a check is made if the metric_name has already been check, if</span>
            <span class="c1"># so continue</span>
            <span class="n">not_alerting_for_ionosphere</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

            <span class="c1"># @added 20221015 - Bug #2682: Reduce mirage ionosphere alert loop</span>
            <span class="n">not_alerting_logged</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># @added 20190408 - Bug #2904: Initial Ionosphere echo load and Ionosphere feedback</span>
            <span class="c1">#                   Feature #2484: FULL_DURATION feature profiles</span>
            <span class="c1"># Only check Ionosphere is up once per cycle</span>
            <span class="n">ionosphere_up</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="n">mirage_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># literal_mirage_anomalous_metrics = list(self.redis_conn.smembers(&#39;mirage.anomalous_metrics&#39;))</span>
                <span class="n">literal_mirage_anomalous_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage.anomalous_metrics&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">metric_list_string</span> <span class="ow">in</span> <span class="n">literal_mirage_anomalous_metrics</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">metric_list_string</span><span class="p">)</span>
                    <span class="n">mirage_anomalous_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine list from mirage.anomalous_metrics Redis set&#39;</span><span class="p">)</span>
                <span class="n">mirage_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># @added 20221206 - Feature #4734: mirage_vortex</span>
            <span class="c1">#                   Feature #4732: flux vortex</span>
            <span class="c1"># Add any anomalies discovered by mirage_vortex to be alerted on</span>
            <span class="n">mirage_vortex_anomalous_basenames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">VORTEX_ENABLED</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ionosphere_alerts_returned</span><span class="p">:</span>
                <span class="n">mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">literal_mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage_vortex.anomalous_metrics&#39;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">metric_list_string</span> <span class="ow">in</span> <span class="n">literal_mirage_vortex_anomalous_metrics</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">metric_list_string</span><span class="p">)</span>
                        <span class="n">mirage_vortex_anomalous_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                        <span class="n">mirage_vortex_anomalous_basenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine list from mirage_vortex.anomalous_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;mirage_vortex.anomalous_metrics&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to delete mirage_vortex.anomalous_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">mirage_vortex_anomalous_metrics</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding </span><span class="si">%s</span><span class="s1"> metrics to mirage_anomalous_metrics for mirage_vortex_anomalous_metrics to alert on&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mirage_vortex_anomalous_metrics</span><span class="p">))))</span>
                    <span class="n">mirage_anomalous_metrics</span> <span class="o">=</span> <span class="n">mirage_anomalous_metrics</span> <span class="o">+</span> <span class="n">mirage_vortex_anomalous_metrics</span>

            <span class="c1"># @added 20200907 - Feature #3734: waterfall alerts</span>
            <span class="c1"># Add alert for expired waterfall_alert items</span>
            <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp]</span>
            <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp, waterfall_panorama_data]</span>
            <span class="n">waterfall_alert_check_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="n">waterfall_alerts_to_alert_on</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># A list to add a metric,timestamp string to in order to override</span>
            <span class="c1"># the ionosphere_metric in the alerting block</span>
            <span class="n">alerting_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">waterfall_redis_sets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;mirage.waterfall_alerts.sent_to_ionosphere&#39;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">waterfall_redis_set</span> <span class="ow">in</span> <span class="n">waterfall_redis_sets</span><span class="p">:</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="n">waterfall_redis_set</span>
                <span class="n">literal_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">literal_waterfall_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">literal_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checking for expired checks in </span><span class="si">%s</span><span class="s1"> waterfall alerts in Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">literal_waterfall_alerts</span><span class="p">)),</span> <span class="n">redis_set</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">literal_waterfall_alert</span> <span class="ow">in</span> <span class="n">literal_waterfall_alerts</span><span class="p">:</span>
                    <span class="n">waterfall_alert</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">literal_waterfall_alert</span><span class="p">)</span>
                    <span class="n">waterfall_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">waterfall_alert</span> <span class="ow">in</span> <span class="n">waterfall_alerts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">waterfall_alert_check_timestamp</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="mi">300</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                            <span class="c1"># @modified 20221104 - Bug #4722: Handle alert and waterfall alert overlap</span>
                            <span class="c1"># Added more context to log to enable debugging</span>
                            <span class="c1"># logger.info(&#39;removed waterfall alert item to alert on from Redis set %s - %s&#39; % (</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;appending to waterfall_alerts_to_alert_on and removed waterfall alert item to alert on from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                            <span class="n">waterfall_alerts_to_alert_on</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove feedback metric waterfall alert item for </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">base_name</span><span class="p">,</span> <span class="n">redis_set</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">waterfall_alert</span> <span class="ow">in</span> <span class="n">waterfall_alerts_to_alert_on</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># @added 20201008 - Feature #3734: waterfall alerts</span>
                    <span class="c1">#                   Branch #3068: SNAB</span>
                    <span class="c1"># Added triggered_algorithms and algorithms_run</span>
                    <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>

                    <span class="c1"># @modified 20201008 - Feature #3734: waterfall alerts</span>
                    <span class="c1">#                      Branch #3068: SNAB</span>
                    <span class="c1"># Added triggered_algorithms and algorithms_run</span>
                    <span class="c1"># anomalous_metric = [value, base_name, metric_timestamp]</span>
                    <span class="c1"># mirage_anomalous_metrics.append([value, base_name, metric_timestamp])</span>
                    <span class="n">anomalous_metric</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">algorithms_run</span><span class="p">]</span>
                    <span class="n">mirage_anomalous_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anomalous_metric</span><span class="p">)</span>

                    <span class="n">waterfall_alert_check_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
                    <span class="n">alerting_waterfall_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waterfall_alert_check_string</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;waterfall alerting on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
                    <span class="n">redis_waterfall_alert_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.waterfall.alert.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">waterfall_alert_check_string</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_waterfall_alert_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="n">waterfall_alert_check_timestamp</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add Redis key - </span><span class="si">%s</span><span class="s1"> for waterfall alert&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">redis_waterfall_alert_key</span><span class="p">))</span>

                    <span class="c1"># @added 20200929 - Feature #3734: waterfall alerts</span>
                    <span class="c1">#                   Task #3748: POC SNAB</span>
                    <span class="c1">#                   Branch #3068: SNAB</span>
                    <span class="c1"># Added Panorama anomaly details for waterfall alerts</span>
                    <span class="c1"># Note:</span>
                    <span class="c1"># The values are enclosed is single quoted intentionally</span>
                    <span class="c1"># as the imp.load_source used results in a shift in the</span>
                    <span class="c1"># decimal position when double quoted, e.g.</span>
                    <span class="c1"># value = &quot;5622.0&quot; gets imported as</span>
                    <span class="c1"># 2016-03-02 12:53:26 :: 28569 :: metric variable - value - 562.2</span>
                    <span class="c1"># single quoting results in the desired,</span>
                    <span class="c1"># 2016-03-02 13:16:17 :: 1515 :: metric variable - value - 5622.0</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding panorama anomaly file for waterfall alert on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
                    <span class="n">panorama_data</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">panorama_data</span> <span class="o">=</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">panorama_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                        <span class="n">int_metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">panorama_data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">panorama_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="n">panorama_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="n">panorama_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                        <span class="n">added_at</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                        <span class="n">panoroma_anomaly_data</span> <span class="o">=</span> <span class="s1">&#39;metric = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                                <span class="s1">&#39;value = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                                <span class="s1">&#39;from_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                                <span class="s1">&#39;metric_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                                <span class="s1">&#39;algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                                <span class="s1">&#39;triggered_algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                                <span class="s1">&#39;app = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                                <span class="s1">&#39;source = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                                <span class="s1">&#39;added_by = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                                <span class="s1">&#39;added_at = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">from_timestamp</span><span class="p">,</span>
                               <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithms_run</span><span class="p">),</span>
                               <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span>
                               <span class="n">this_host</span><span class="p">,</span> <span class="n">added_at</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;panorama anomaly data for waterfall alert - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">panorama_data</span><span class="p">))</span>
                        <span class="c1"># Create an anomaly file with details about the anomaly</span>
                        <span class="n">sane_metricname</span> <span class="o">=</span> <span class="n">filesafe_metricname</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                        <span class="n">panoroma_anomaly_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">,</span> <span class="n">added_at</span><span class="p">,</span> <span class="n">sane_metricname</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">write_data_to_file</span><span class="p">(</span>
                                <span class="n">skyline_app</span><span class="p">,</span> <span class="n">panoroma_anomaly_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                                <span class="n">panoroma_anomaly_data</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added panorama anomaly file for waterfall alert :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">panoroma_anomaly_file</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add panorama anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">panoroma_anomaly_file</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.sent_to_panorama&#39;</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add panorama anomaly data file for waterfall alert&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add waterfall alert to alert on to mirage_anomalous_metrics&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20200913 - Branch #3068: SNAB</span>
            <span class="c1">#                   Task #3744: POC matrixprofile</span>
            <span class="c1">#                   Info #1792: Shapelet extraction</span>
            <span class="n">snab_checks_sent</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">added_to_snab_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

            <span class="c1"># @added 20200929 - Task #3748: POC SNAB</span>
            <span class="c1">#                   Branch #3068: SNAB</span>
            <span class="c1"># Added three-sigma snab.panorama items</span>
            <span class="n">panorama_added_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="n">panorama_three_sigma_snab_added</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># @added 20200610 - Feature #3560: External alert config</span>
            <span class="n">external_alerts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">external_from_cache</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">internal_alerts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">internal_from_cache</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">all_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ALERTS</span><span class="p">)</span>
            <span class="n">all_from_cache</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">EXTERNAL_ALERTS</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">external_alerts</span><span class="p">,</span> <span class="n">external_from_cache</span><span class="p">,</span> <span class="n">internal_alerts</span><span class="p">,</span> <span class="n">internal_from_cache</span><span class="p">,</span> <span class="n">all_alerts</span><span class="p">,</span> <span class="n">all_from_cache</span> <span class="o">=</span> <span class="n">get_external_alert_configs</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not determine external alert configs&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;retrieved </span><span class="si">%s</span><span class="s1"> external_alerts configurations from_cache </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> internal_alerts from_cache </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> all_alerts from_cache </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">external_alerts</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">external_from_cache</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">internal_alerts</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">internal_from_cache</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_alerts</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_from_cache</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: all_alerts :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_alerts</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">all_alerts</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: all_alerts is not set, so creating from settings.ALERTS&#39;</span><span class="p">)</span>
                <span class="n">all_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ALERTS</span><span class="p">)</span>

            <span class="c1"># @added 20220316 - Feature #4482: Test alerts</span>
            <span class="c1"># Add test_alerts http_alerters to all_alerts because any new</span>
            <span class="c1"># external_settings alerters may not have been updated/added yet</span>
            <span class="k">if</span> <span class="n">test_alerts</span><span class="p">:</span>
                <span class="n">test_all_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">test_alert_timestamp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_alerts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test_alerter</span> <span class="o">=</span> <span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">][</span><span class="s1">&#39;alerter&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_alerter</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http_alerter&#39;</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="n">test_metric</span> <span class="o">=</span> <span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                        <span class="n">test_id</span> <span class="o">=</span> <span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">][</span><span class="s1">&#39;alerter_id&#39;</span><span class="p">]</span>
                        <span class="n">external_alert_id</span> <span class="o">=</span> <span class="s1">&#39;external-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_id</span><span class="p">)</span>
                        <span class="n">test_alert_setting</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">test_metric</span><span class="p">,</span> <span class="n">test_alerter</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span>
                            <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">external_alert_id</span><span class="p">,</span> <span class="s1">&#39;alerter&#39;</span><span class="p">:</span> <span class="n">test_alerter</span><span class="p">,</span>
                             <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="n">test_metric</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;external&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;expiration&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">&#39;second_order_resolution&#39;</span><span class="p">:</span> <span class="mi">604800</span><span class="p">}</span>
                        <span class="p">]</span>
                        <span class="n">test_all_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_alert_setting</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding test_alert setting: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_alert_setting</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add test_alert to test_all_alerts </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">]),</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">all_alerts</span><span class="p">:</span>
                    <span class="n">test_all_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">all_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_all_alerts</span><span class="p">)</span>

            <span class="n">not_ionosphere_metrics</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># @modified 20200610 - Feature #3560: External alert config</span>
            <span class="c1"># for alert in settings.ALERTS:</span>
            <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">all_alerts</span><span class="p">:</span>

                <span class="c1"># @added 20181114 - Bug #2682: Reduce mirage ionosphere alert loop</span>
                <span class="n">not_an_ionosphere_metric_check_done</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: </span><span class="si">%s</span><span class="s1"> metrics in mirage_anomalous_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mirage_anomalous_metrics</span><span class="p">)))</span>

                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># for metric in self.anomalous_metrics:</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">mirage_anomalous_metrics</span><span class="p">:</span>
                    <span class="c1"># @added 20161228 - Feature #1830: Ionosphere alerts</span>
                    <span class="c1">#                   Branch #922: Ionosphere</span>
                    <span class="c1"># Bringing Ionosphere online - do alert on Ionosphere</span>
                    <span class="c1"># metrics if Ionosphere is up</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                        <span class="c1"># @added 20220805 - Task #2732: Prometheus to Skyline</span>
                        <span class="c1">#                   Branch #4300: prometheus</span>
                        <span class="k">if</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="c1"># if metric_name in ionosphere_unique_metrics:</span>
                            <span class="c1">#     ionosphere_unique_metrics.remove(metric_name)</span>

                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: metric_name interpolated to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: failed to interpolate metric_name&#39;</span><span class="p">)</span>

                    <span class="c1"># @added 20200907 - Feature #3734: waterfall alerts</span>
                    <span class="n">waterfall_alert_check_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                        <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                    <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
                    <span class="c1"># metric</span>
                    <span class="k">if</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">test_alert_metrics</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                            <span class="n">ionosphere_unique_metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>

                    <span class="c1"># @added 20221206 - Feature #4734: mirage_vortex</span>
                    <span class="c1">#                   Feature #4732: flux vortex</span>
                    <span class="c1"># Remove mirage_vortex metrics from ionosphere_unique_metrics</span>
                    <span class="c1"># so that they get alerted on</span>
                    <span class="k">if</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mirage_vortex_anomalous_basenames</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                            <span class="n">ionosphere_unique_metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                        <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># @modified 20200907 - Feature #3734: waterfall alerts</span>
                    <span class="c1"># if metric_name in ionosphere_unique_metrics:</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">ionosphere_unique_metrics</span> <span class="ow">and</span> <span class="n">waterfall_alert_check_string</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">alerting_waterfall_alerts</span><span class="p">:</span>
                        <span class="c1"># @added 20181114 - Bug #2682: Reduce mirage ionosphere alert loop</span>
                        <span class="k">if</span> <span class="n">not_alerting_for_ionosphere</span> <span class="o">==</span> <span class="n">metric_name</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="c1"># @added 20221015 - Bug #2682: Reduce mirage ionosphere alert loop</span>
                        <span class="k">if</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">not_alerting_logged</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># @modified 20190408 - Bug #2904: Initial Ionosphere echo load and Ionosphere feedback</span>
                        <span class="c1">#                      Feature #2484: FULL_DURATION feature profiles</span>
                        <span class="c1"># Only check Ionosphere is up once per cycle</span>
                        <span class="c1"># ionosphere_up = False</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_up</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">ionosphere_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ionosphere&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not query Redis for ionosphere key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">ionosphere_up</span><span class="p">:</span>
                            <span class="c1"># @modified 20190408 - Bug #2904: Initial Ionosphere echo load and Ionosphere feedback</span>
                            <span class="c1">#                      Feature #2484: FULL_DURATION feature profiles</span>
                            <span class="c1"># Wrapped this block up on conditional based on</span>
                            <span class="c1"># ionosphere_alerts_returned</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_alerts_returned</span><span class="p">:</span>
                                <span class="c1"># @modified 20221015 - Bug #2682: Reduce mirage ionosphere alert loop</span>
                                <span class="c1"># Check if in not_alerting_logged</span>
                                <span class="k">if</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">not_alerting_logged</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not alerting - Ionosphere metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                    <span class="c1"># @added 20181114 - Bug #2682: Reduce mirage ionosphere alert loop</span>
                                    <span class="n">not_alerting_for_ionosphere</span> <span class="o">=</span> <span class="n">metric_name</span>
                                    <span class="c1"># @added 20221015 - Bug #2682: Reduce mirage ionosphere alert loop</span>
                                    <span class="n">not_alerting_logged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                    <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Ionosphere not reporting up&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;taking over alerting from Ionosphere if alert is matched on - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># @modified 20181114 - Bug #2682: Reduce mirage ionosphere alert loop</span>
                        <span class="c1"># logger.info(&#39;not an Ionosphere metric checking whether to alert - %s&#39; % str(metric[1]))</span>
                        <span class="k">if</span> <span class="n">not_an_ionosphere_metric_check_done</span> <span class="o">==</span> <span class="n">metric_name</span><span class="p">:</span>
                            <span class="c1"># Do not log multiple times for this either</span>
                            <span class="n">not_an_ionosphere_metric_check_done</span> <span class="o">=</span> <span class="n">metric_name</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_alerts_returned</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">not_ionosphere_metrics</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not an Ionosphere metric checking whether to alert - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                    <span class="n">not_an_ionosphere_metric_check_done</span> <span class="o">=</span> <span class="n">metric_name</span>
                                    <span class="n">not_ionosphere_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                    <span class="c1"># ALERT_MATCH_PATTERN = alert[0]</span>
                    <span class="c1"># METRIC_PATTERN = metric[1]</span>
                    <span class="c1"># @modified 20200622 - Task #3586: Change all alert pattern checks to matched_or_regexed_in_list</span>
                    <span class="c1">#                      Feature #3512: matched_or_regexed_in_list function</span>
                    <span class="c1"># Changed original alert matching pattern to use new</span>
                    <span class="c1"># method</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># @added 20220805 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                        <span class="n">use_base_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">,</span> <span class="p">[</span><span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span> <span class="ow">and</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: </span><span class="si">%s</span><span class="s1"> matched alert - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">use_base_name</span><span class="p">,</span> <span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">metric_matched_by</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>

                        <span class="c1"># @added 20200610 - Feature #3560: External alert config</span>
                        <span class="c1"># @modified 20200624 - Feature #3560: External alert config</span>
                        <span class="c1"># Set the alert key to the external alerter id</span>
                        <span class="c1"># external_alerter_alerter = None</span>
                        <span class="n">external_alerter_id</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">alert</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;external&#39;</span><span class="p">:</span>
                                <span class="c1"># @modified 20200624 - Feature #3560: External alert config</span>
                                <span class="c1"># Set the alert key to the external alerter id</span>
                                <span class="c1"># external_alerter_alerter = alert[4][&#39;alerter&#39;]</span>
                                <span class="n">external_alerter_id</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;external-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">external_alerter_id</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="c1"># @modified 20200610 - Feature #3560: External alert config</span>
                        <span class="c1"># Use the all_alerts list which includes external alert configs</span>
                        <span class="c1"># cache_key = &#39;mirage.last_alert.%s.%s&#39; % (alert[1], metric[1])</span>
                        <span class="c1"># @modified 20200624 - Feature #3560: External alert config</span>
                        <span class="c1"># Set the alert key to the external alerter id</span>
                        <span class="c1"># if external_alerter_alerter:</span>
                        <span class="c1">#     cache_key = &#39;mirage.last_alert.%s.%s.%s&#39; % (str(external_alerter_alerter), alert[1], metric[1])</span>
                        <span class="k">if</span> <span class="n">external_alerter_id</span><span class="p">:</span>
                            <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.last_alert.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">external_alerter_id</span><span class="p">),</span> <span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.last_alert.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20200805 - Task #3662: Change mirage.last_check keys to timestamp value</span>
                            <span class="c1">#                      Feature #3486: analyzer_batch</span>
                            <span class="c1">#                      Feature #3480: batch_processing</span>
                            <span class="c1"># Changed the last_alert cache key to hold the last</span>
                            <span class="c1"># anomaly timestamp</span>
                            <span class="c1"># last_alert = self.redis_conn.get(cache_key)</span>
                            <span class="n">last_alert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

                            <span class="c1"># @added 20200805 - Task #3662: Change mirage.last_check keys to timestamp value</span>
                            <span class="c1">#                   Feature #3486: analyzer_batch</span>
                            <span class="c1">#                   Feature #3480: batch_processing</span>
                            <span class="c1"># Evaluate the reported anomaly timestamp to determine whether</span>
                            <span class="c1"># EXPIRATION_TIME should be applied to a batch metric</span>
                            <span class="k">if</span> <span class="n">last_alert</span><span class="p">:</span>
                                <span class="c1"># Is this a analyzer_batch related anomaly</span>
                                <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                <span class="n">analyzer_batch_metric_anomaly_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_batch.anomaly.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                        <span class="s1">&#39;error :: could not query cache_key - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                                    <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="n">analyzer_batch_anomaly</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;identified as an analyzer_batch triggered anomaly from the presence of the Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not identified as an analyzer_batch triggered anomaly as no Redis key found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">last_alert</span> <span class="ow">and</span> <span class="n">analyzer_batch_anomaly</span><span class="p">:</span>
                                    <span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">last_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_alert</span><span class="p">)</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine last_timestamp from the last Mirage alert key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                                        <span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">seconds_between_batch_anomalies</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">if</span> <span class="n">last_timestamp</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">seconds_between_batch_anomalies</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">)</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine seconds_between_batch_anomalies for batch metric Panorama key- </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                                            <span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">if</span> <span class="n">seconds_between_batch_anomalies</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">seconds_between_batch_anomalies</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the difference between the last anomaly timestamp (</span><span class="si">%s</span><span class="s1">) and the batch anomaly timestamp (</span><span class="si">%s</span><span class="s1">) for batch metric </span><span class="si">%s</span><span class="s1"> is greater than the metric EXPIRATION_TIME of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;alerting on anomaly for batch metric </span><span class="si">%s</span><span class="s1">, so setting last_alert to None&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="n">metric</span><span class="p">))</span>
                                            <span class="n">last_alert</span> <span class="o">=</span> <span class="kc">None</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the difference between the last anomaly timestamp (</span><span class="si">%s</span><span class="s1">) and the batch anomaly timestamp (</span><span class="si">%s</span><span class="s1">) for batch metric </span><span class="si">%s</span><span class="s1"> is less than the metric EXPIRATION_TIME of </span><span class="si">%s</span><span class="s1">, not alerting&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

                                        <span class="c1"># @added 20200805 - Task #3662: Change mirage.last_check keys to timestamp value</span>
                                        <span class="c1">#                   Task #3562: Change panorama.last_check keys to timestamp value</span>
                                        <span class="c1">#                   Feature #3486: analyzer_batch</span>
                                        <span class="c1">#                   Feature #3480: batch_processing</span>
                                        <span class="c1"># If the metric is a batch processing metric and the anomaly</span>
                                        <span class="c1"># timestamp is less than the last_check timestamp, insert</span>
                                        <span class="c1"># the anomaly</span>
                                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">last_timestamp</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;batch anomaly timestamp (</span><span class="si">%s</span><span class="s1">) less than the last_check timestamp (</span><span class="si">%s</span><span class="s1">), alerting on anomaly for batch metric </span><span class="si">%s</span><span class="s1">, so setting last_alert to None&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">))</span>
                                            <span class="n">last_alert</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="n">last_alert</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">ionosphere_alerts_returned</span><span class="p">:</span>
                                    <span class="c1"># @modified 20190410 - Feature #2882: Mirage - periodic_check</span>
                                    <span class="c1"># Only set if not set</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">second_order_resolution_seconds</span> <span class="o">+</span> <span class="mi">1</span>
                                        <span class="n">set_second_order_resolution_seconds</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">set_second_order_resolution_seconds</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">if</span> <span class="n">set_second_order_resolution_seconds</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3600</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine full_duration from the Ionosphere alert for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;using settings.FULL_DURATION - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">)))</span>
                                            <span class="n">second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">)</span>
                                <span class="c1"># @modified 20190524 - Branch #3002</span>
                                <span class="c1"># Wrapped in try except</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># @modified 20200805 - Task #3662: Change mirage.last_check keys to timestamp value</span>
                                    <span class="c1">#                      Feature #3486: analyzer_batch</span>
                                    <span class="c1">#                      Feature #3480: batch_processing</span>
                                    <span class="c1"># Change the last_alert cache key to hold the</span>
                                    <span class="c1"># the anomaly timestamp for which the alert</span>
                                    <span class="c1"># was sent, not the packb anomaly value.</span>
                                    <span class="c1"># Using the timestamp of the anomaly allows</span>
                                    <span class="c1"># it to be used to determine if a batch</span>
                                    <span class="c1"># anomaly should be alerted on based on the</span>
                                    <span class="c1"># comparison of the timestamps rather than</span>
                                    <span class="c1"># just the presence of the last_alert key</span>
                                    <span class="c1"># based on it not having reach its TTL as</span>
                                    <span class="c1"># analyzer_batch could send multiple</span>
                                    <span class="c1"># anomalies in one batch that might be</span>
                                    <span class="c1"># EXPIRATION_TIME apart.</span>
                                    <span class="c1"># self.redis_conn.setex(cache_key, alert[2], packb(metric[0]))</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to set Redis key </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">cache_key</span><span class="p">),</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                                <span class="c1"># @added 20200929 - Task #3748: POC SNAB</span>
                                <span class="c1">#                   Branch #3068: SNAB</span>
                                <span class="c1"># Determine if this is a snab_check_metric so</span>
                                <span class="c1"># that info can be passed to the alerter</span>
                                <span class="n">snab_check_metric</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">SNAB_ENABLED</span><span class="p">:</span>
                                    <span class="c1"># @added 20230419 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
                                    <span class="c1"># Added snab custom_algorithms to run</span>
                                    <span class="n">snab_algorithms_to_run</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">snab_algorithms_to_run</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">snab_algorithms_to_run</span> <span class="o">=</span> <span class="p">[]</span>

                                    <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">app</span> <span class="o">==</span> <span class="n">skyline_app</span><span class="p">:</span>
                                            <span class="k">for</span> <span class="n">snab_context</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">]:</span>
                                                <span class="k">if</span> <span class="n">snab_check_metric</span><span class="p">:</span>
                                                    <span class="k">break</span>
                                                <span class="k">if</span> <span class="n">snab_context</span> <span class="o">==</span> <span class="s1">&#39;testing&#39;</span><span class="p">:</span>
                                                    <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">]:</span>
                                                        <span class="c1"># @added 20230419 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
                                                        <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                                                            <span class="k">if</span> <span class="n">algorithm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">snab_algorithms_to_run</span><span class="p">:</span>
                                                                <span class="k">continue</span>
                                                        <span class="k">try</span><span class="p">:</span>
                                                            <span class="n">algorithm_source</span> <span class="o">=</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;algorithm_source&#39;</span><span class="p">]</span>
                                                        <span class="k">except</span><span class="p">:</span>
                                                            <span class="k">break</span>
                                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">algorithm_source</span><span class="p">):</span>
                                                            <span class="k">break</span>
                                                        <span class="k">try</span><span class="p">:</span>
                                                            <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]:</span>
                                                                <span class="c1"># @modified 20230419 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
                                                                <span class="c1">#                      Task #2732: Prometheus to Skyline</span>
                                                                <span class="c1">#                      Branch #4300: prometheus</span>
                                                                <span class="c1"># if namespace in base_name:</span>
                                                                <span class="k">if</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">use_base_name</span><span class="p">:</span>
                                                                    <span class="n">snab_check_metric</span> <span class="o">=</span> <span class="kc">True</span>
                                                                    <span class="k">break</span>
                                                        <span class="k">except</span><span class="p">:</span>
                                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to check if </span><span class="si">%s</span><span class="s1"> is a snab_check_metric&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">snab_check_metric</span><span class="p">:</span>
                                            <span class="n">algorithm_group</span> <span class="o">=</span> <span class="s1">&#39;three-sigma&#39;</span>

                                            <span class="c1"># @added 20201007 - Feature #3772: Add the anomaly_id to the http_alerter json</span>
                                            <span class="c1">#                   Branch #3068: SNAB</span>
                                            <span class="c1"># Added second_order_resolution_seconds, triggered_algorithms and algorithms_run</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                                                <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
                                                <span class="n">algorithms_run</span> <span class="o">=</span> <span class="p">[]</span>

                                            <span class="c1"># @added 20201001 - Task #3748: POC SNAB</span>
                                            <span class="c1"># Added anomalyScore</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="n">triggered_algorithms</span> <span class="ow">and</span> <span class="n">algorithms_run</span><span class="p">:</span>
                                                    <span class="n">anomalyScore</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">algorithms_run</span><span class="p">)</span>
                                                <span class="k">else</span><span class="p">:</span>
                                                    <span class="n">anomalyScore</span> <span class="o">=</span> <span class="mf">1.0</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine anomalyScore for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
                                                <span class="n">anomalyScore</span> <span class="o">=</span> <span class="mf">1.0</span>
                                            <span class="c1"># @added 20201001 - Branch #3068: SNAB</span>
                                            <span class="c1">#                      Task #3748: POC SNAB</span>
                                            <span class="c1"># Added analysis_run_time</span>
                                            <span class="n">analysis_run_time</span> <span class="o">=</span> <span class="mi">0</span>
                                            <span class="n">redis_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.analysis_run_time.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">analysis_run_time_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>
                                                <span class="k">if</span> <span class="n">analysis_run_time_data</span><span class="p">:</span>
                                                    <span class="n">analysis_run_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">analysis_run_time_data</span><span class="p">)</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine analysis_run_time from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                    <span class="n">redis_key</span><span class="p">))</span>

                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">snab_panorama_details</span> <span class="o">=</span> <span class="p">{</span>
                                                    <span class="c1"># @modified 20230419 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
                                                    <span class="c1">#                      Task #2732: Prometheus to Skyline</span>
                                                    <span class="c1">#                      Branch #4300: prometheus</span>
                                                    <span class="c1"># &#39;metric&#39;: base_name,</span>
                                                    <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">use_base_name</span><span class="p">,</span>
                                                    <span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">:</span> <span class="n">labelled_metric_name</span><span class="p">,</span> 
                                                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                                    <span class="c1"># @added 20201001 - Task #3748: POC SNAB</span>
                                                    <span class="c1"># Added anomalyScore and analysis_run_time</span>
                                                    <span class="s1">&#39;anomalyScore&#39;</span><span class="p">:</span> <span class="n">anomalyScore</span><span class="p">,</span>
                                                    <span class="s1">&#39;analysis_run_time&#39;</span><span class="p">:</span> <span class="n">analysis_run_time</span><span class="p">,</span>
                                                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">skyline_app</span><span class="p">,</span>
                                                    <span class="s1">&#39;algorithm_group&#39;</span><span class="p">:</span> <span class="n">algorithm_group</span><span class="p">,</span>
                                                    <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                    <span class="s1">&#39;added_at&#39;</span><span class="p">:</span> <span class="n">panorama_added_at</span><span class="p">,</span>
                                                <span class="p">}</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to create snab_panorama_details dict </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
                                                <span class="n">snab_panorama_details</span> <span class="o">=</span> <span class="kc">None</span>

                                            <span class="c1"># Only send once for a metric and timestamp</span>
                                            <span class="k">if</span> <span class="n">snab_panorama_details</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">panorama_three_sigma_snab_added</span><span class="p">:</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;snab.panorama&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_panorama_details</span><span class="p">))</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added snab.panorama three-sigma item - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                    <span class="nb">str</span><span class="p">(</span><span class="n">snab_panorama_details</span><span class="p">)))</span>
                                                <span class="n">panorama_three_sigma_snab_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snab_panorama_details</span><span class="p">)</span>

                                <span class="c1"># @added 20210801 - Feature #4214: alert.paused</span>
                                <span class="n">alert_paused</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;alert.paused.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base_name</span><span class="p">)</span>
                                    <span class="n">alert_paused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: alert_paused check failed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                                    <span class="n">alert_paused</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">alert_paused</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;alert_paused for </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> until </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert_paused</span><span class="p">)))</span>

                                <span class="c1"># @added 20221206 - Feature #4734: mirage_vortex</span>
                                <span class="c1">#                   Feature #4732: flux vortex</span>
                                <span class="c1"># Remove mirage_vortex metrics from ionosphere_unique_metrics</span>
                                <span class="c1"># so that they get alerted on</span>
                                <span class="k">if</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mirage_vortex_anomalous_basenames</span><span class="p">:</span>
                                    <span class="n">alert_context</span> <span class="o">=</span> <span class="s1">&#39;Vortex&#39;</span>

                                <span class="c1"># trigger_alert(alert, metric, second_order_resolution_seconds, context)</span>
                                <span class="k">try</span><span class="p">:</span>

                                    <span class="c1"># @added 20210409 - Feature #3642: Anomaly type classification</span>
                                    <span class="c1">#                   Feature #3970: custom_algorithm - adtk_level_shift</span>
                                    <span class="c1"># Always determine triggered_algorithms and</span>
                                    <span class="c1"># calculate anomalyScore</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                                        <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
                                        <span class="n">algorithms_run</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">triggered_algorithms</span> <span class="ow">and</span> <span class="n">algorithms_run</span><span class="p">:</span>
                                            <span class="n">anomalyScore</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">algorithms_run</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">anomalyScore</span> <span class="o">=</span> <span class="mf">1.0</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine anomalyScore for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
                                        <span class="n">anomalyScore</span> <span class="o">=</span> <span class="mf">1.0</span>

                                    <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                                    <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
                                    <span class="c1"># metric</span>
                                    <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">test_alert_metrics</span><span class="p">:</span>
                                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;testing&#39;</span><span class="p">]</span>
                                        <span class="n">second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test alert set second_order_resolution_seconds to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">))</span>

                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">second_order_resolution_seconds</span> <span class="o">+</span> <span class="mi">1</span>
                                        <span class="n">set_second_order_resolution_seconds</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">set_second_order_resolution_seconds</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">if</span> <span class="n">set_second_order_resolution_seconds</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: failed to determine full_duration for alert on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;using settings.FULL_DURATION * 7 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">)))</span>
                                            <span class="n">second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>

                                    <span class="k">if</span> <span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;smtp&#39;</span><span class="p">:</span>

                                        <span class="n">new_alert</span> <span class="o">=</span> <span class="kc">None</span>

                                        <span class="c1"># @added 20201007 - Feature #3772: Add the anomaly_id to the http_alerter json</span>
                                        <span class="k">if</span> <span class="s1">&#39;http_alerter&#39;</span> <span class="ow">in</span> <span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                            <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
                                            <span class="n">anomaly_id_redis_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.anomaly_id.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="n">base_name</span><span class="p">)</span>
                                            <span class="n">try_get_anomaly_id_redis_key_count</span> <span class="o">=</span> <span class="mi">0</span>
                                            <span class="k">while</span> <span class="n">try_get_anomaly_id_redis_key_count</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
                                                <span class="n">try_get_anomaly_id_redis_key_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                                <span class="k">try</span><span class="p">:</span>
                                                    <span class="n">anomaly_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">anomaly_id_redis_key</span><span class="p">))</span>
                                                    <span class="k">break</span>
                                                <span class="k">except</span><span class="p">:</span>
                                                    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="ow">not</span> <span class="n">anomaly_id</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine anomaly_id from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">anomaly_id_redis_key</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;determined anomaly_id as </span><span class="si">%s</span><span class="s1">, appending to alert&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
                                            <span class="c1"># Do not modify the alert list object, create a new one</span>
                                            <span class="n">new_alert</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
                                            <span class="n">new_alert</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;anomaly_id&#39;</span><span class="p">,</span> <span class="n">anomaly_id</span><span class="p">])</span>

                                            <span class="c1"># @added 20201130 - Feature #3772: Add the anomaly_id to the http_alerter json</span>
                                            <span class="c1"># Determine the triggered_algorithms</span>
                                            <span class="c1"># and algorithms_run</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                                                <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
                                                <span class="n">algorithms_run</span> <span class="o">=</span> <span class="p">[]</span>

                                            <span class="c1"># @added 20201111 - Feature #3772: Add the anomaly_id to the http_alerter json</span>
                                            <span class="c1"># Add the real anomalyScore</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="n">triggered_algorithms</span> <span class="ow">and</span> <span class="n">algorithms_run</span><span class="p">:</span>
                                                    <span class="n">anomalyScore</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">algorithms_run</span><span class="p">)</span>
                                                <span class="k">else</span><span class="p">:</span>
                                                    <span class="n">anomalyScore</span> <span class="o">=</span> <span class="mf">1.0</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine anomalyScore for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
                                                <span class="n">anomalyScore</span> <span class="o">=</span> <span class="mf">1.0</span>
                                            <span class="n">new_alert</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;anomalyScore&#39;</span><span class="p">,</span> <span class="n">anomalyScore</span><span class="p">])</span>

                                            <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">test_alert_metrics</span><span class="p">:</span>
                                                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;testing&#39;</span><span class="p">]</span>
                                                <span class="n">new_alert</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;test_alert&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>

                                        <span class="c1"># @added 20200929 - Task #3748: POC SNAB</span>
                                        <span class="c1">#                   Branch #3068: SNAB</span>
                                        <span class="c1"># Determine if this is a snab_check_metric so</span>
                                        <span class="c1"># that info can be passed to the alerter</span>
                                        <span class="k">if</span> <span class="n">SNAB_ENABLED</span> <span class="ow">and</span> <span class="n">snab_check_metric</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;slack&#39;</span><span class="p">:</span>
                                                <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
                                                <span class="n">snab_id</span> <span class="o">=</span> <span class="kc">None</span>
                                                <span class="n">snab_details</span> <span class="o">=</span> <span class="kc">None</span>
                                                <span class="n">anomaly_id_redis_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.anomaly_id.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                    <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="n">base_name</span><span class="p">)</span>
                                                <span class="n">try_get_anomaly_id_redis_key_count</span> <span class="o">=</span> <span class="mi">0</span>
                                                <span class="k">while</span> <span class="n">try_get_anomaly_id_redis_key_count</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
                                                    <span class="n">try_get_anomaly_id_redis_key_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                                    <span class="k">try</span><span class="p">:</span>
                                                        <span class="n">anomaly_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">anomaly_id_redis_key</span><span class="p">))</span>
                                                        <span class="k">break</span>
                                                    <span class="k">except</span><span class="p">:</span>
                                                        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                                <span class="k">if</span> <span class="ow">not</span> <span class="n">anomaly_id</span><span class="p">:</span>
                                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine anomaly_id from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">anomaly_id_redis_key</span><span class="p">)</span>
                                                <span class="k">if</span> <span class="n">anomaly_id</span><span class="p">:</span>
                                                    <span class="c1"># snab_id_redis_key = &#39;snab.id.%s.%s.%s.%s&#39; % (algorithm_group, str(metric_timestamp), base_name, panorama_added_at)</span>
                                                    <span class="n">snab_id_redis_key</span> <span class="o">=</span> <span class="s1">&#39;snab.id.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">algorithm_group</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">panorama_added_at</span><span class="p">)</span>
                                                    <span class="n">try_get_snab_id_redis_key_count</span> <span class="o">=</span> <span class="mi">0</span>
                                                    <span class="k">while</span> <span class="n">try_get_snab_id_redis_key_count</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
                                                        <span class="n">try_get_snab_id_redis_key_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                                        <span class="k">try</span><span class="p">:</span>
                                                            <span class="n">snab_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">snab_id_redis_key</span><span class="p">))</span>
                                                            <span class="k">break</span>
                                                        <span class="k">except</span><span class="p">:</span>
                                                            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">snab_id</span><span class="p">:</span>
                                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine snab_id from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">snab_id_redis_key</span><span class="p">)</span>
                                                <span class="n">snab_details</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snab_details&#39;</span><span class="p">,</span> <span class="n">snab_id</span><span class="p">,</span> <span class="n">anomaly_id</span><span class="p">,</span> <span class="n">anomalyScore</span><span class="p">]</span>
                                                <span class="c1"># Do not modify the alert list object, create a new one</span>
                                                <span class="n">new_alert</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
                                                <span class="n">new_alert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snab_details</span><span class="p">)</span>

                                        <span class="c1"># @modified 20201008 - Feature #3772: Add the anomaly_id to the http_alerter json</span>
                                        <span class="c1">#                      Feature #3734: waterfall alerts</span>
                                        <span class="c1">#                      Branch #3068: SNAB</span>
                                        <span class="c1"># Use the appropriate alert context</span>
                                        <span class="k">if</span> <span class="n">new_alert</span><span class="p">:</span>
                                            <span class="c1"># @added 20210801 - Feature #4214: alert.paused</span>
                                            <span class="k">if</span> <span class="ow">not</span> <span class="n">alert_paused</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;trigger_alert :: alert: </span><span class="si">%s</span><span class="s1">, metric: </span><span class="si">%s</span><span class="s1">, second_order_resolution_seconds: </span><span class="si">%s</span><span class="s1">, context: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                    <span class="nb">str</span><span class="p">(</span><span class="n">new_alert</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span>
                                                    <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">),</span>
                                                    <span class="nb">str</span><span class="p">(</span><span class="n">alert_context</span><span class="p">)))</span>
                                                <span class="c1"># @modified 20210304 - Feature #3642: Anomaly type classification</span>
                                                <span class="c1">#                      Feature #3970: custom_algorithm - adtk_level_shift</span>
                                                <span class="c1"># Added triggered_algorithms</span>
                                                <span class="n">trigger_alert</span><span class="p">(</span><span class="n">new_alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">alert_context</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="c1"># @added 20210801 - Feature #4214: alert.paused</span>
                                            <span class="k">if</span> <span class="ow">not</span> <span class="n">alert_paused</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;trigger_alert :: alert: </span><span class="si">%s</span><span class="s1">, metric: </span><span class="si">%s</span><span class="s1">, second_order_resolution_seconds: </span><span class="si">%s</span><span class="s1">, context: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                    <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span>
                                                    <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">),</span>
                                                    <span class="nb">str</span><span class="p">(</span><span class="n">alert_context</span><span class="p">)))</span>
                                                <span class="c1"># @modified 20210304 - Feature #3642: Anomaly type classification</span>
                                                <span class="c1">#                      Feature #3970: custom_algorithm - adtk_level_shift</span>
                                                <span class="c1"># Added triggered_algorithms</span>
                                                <span class="n">trigger_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">alert_context</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># @added 20210801 - Feature #4214: alert.paused</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">alert_paused</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;smtp_trigger_alert :: alert: </span><span class="si">%s</span><span class="s1">, metric: </span><span class="si">%s</span><span class="s1">, second_order_resolution_seconds: </span><span class="si">%s</span><span class="s1">, context: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">),</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">alert_context</span><span class="p">)))</span>
                                            <span class="c1"># @modified 20210304 - Feature #3642: Anomaly type classification</span>
                                            <span class="c1">#                      Feature #3970: custom_algorithm - adtk_level_shift</span>
                                            <span class="c1"># Added triggered_algorithms</span>
                                            <span class="n">smtp_trigger_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">alert_context</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">alert_paused</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sent </span><span class="si">%s</span><span class="s1"> alert: For </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                                        <span class="c1"># @added 20221105 - Bug #4308: matrixprofile - fN on big drops</span>
                                        <span class="c1"># Flush trigger history so that</span>
                                        <span class="c1"># skyline_matrixprofile can be evaluated</span>
                                        <span class="c1"># again.</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">del_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;mirage.trigger_history&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">del_result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cleared mirage.trigger_history entry for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to del trigger history for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not send </span><span class="si">%s</span><span class="s1"> alert for </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">e</span><span class="p">))</span>

                                <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                                <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
                                <span class="c1"># metric</span>
                                <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">test_alert_metrics</span> <span class="ow">or</span> <span class="n">use_base_name</span> <span class="ow">in</span> <span class="n">test_alert_metrics</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">test_alert_timestamp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_alerts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">test_metric</span> <span class="o">=</span> <span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                                            <span class="k">if</span> <span class="n">test_metric</span> <span class="o">!=</span> <span class="n">base_name</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="n">test_metric</span> <span class="o">!=</span> <span class="n">use_base_name</span><span class="p">:</span>
                                                    <span class="k">continue</span>
                                            <span class="n">test_alert_redis_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.test_alerts&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">test_alert_redis_key</span><span class="p">,</span> <span class="n">test_alert_timestamp</span><span class="p">)</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed test_alert for </span><span class="si">%s</span><span class="s1"> from Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">test_metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_alert_redis_key</span><span class="p">)))</span>
                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove test_alert for </span><span class="si">%s</span><span class="s1"> from Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">test_metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_alert_redis_key</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                                            <span class="k">continue</span>

                                <span class="c1"># @added 20200913 - Branch #3068: SNAB</span>
                                <span class="c1">#                   Task #3744: POC matrixprofile</span>
                                <span class="c1">#                   Info #1792: Shapelet extraction</span>
                                <span class="k">if</span> <span class="n">SNAB_ENABLED</span><span class="p">:</span>
                                    <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                                    <span class="n">training_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">timeseries_dir</span><span class="p">))</span>
                                    <span class="n">anomaly_data</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">training_dir</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                                    
                                    <span class="c1"># @added 20230429 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
                                    <span class="c1"># Use downsampled_timeseries data</span>
                                    <span class="n">downsampled_anomaly_data</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.downsampled.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">training_dir</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                                    <span class="n">use_downsampled_data</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">downsampled_anomaly_data</span><span class="p">):</span>
                                        <span class="n">anomaly_data</span> <span class="o">=</span> <span class="n">downsampled_anomaly_data</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;using downsampled data for snab on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">base_name</span><span class="p">))</span>
                                        <span class="n">use_downsampled_data</span> <span class="o">=</span> <span class="kc">True</span>

                                    <span class="n">check_full_duration</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

                                    <span class="c1"># TODO:</span>
                                    <span class="c1"># Due to how the matrixprofile identifies</span>
                                    <span class="c1"># discords, if a metric triggers as</span>
                                    <span class="c1"># anomalous with 3sigma it must be checked</span>
                                    <span class="c1"># for at x window periods thereafter as</span>
                                    <span class="c1"># matrixprofile may only identify a discord</span>
                                    <span class="c1"># later when the time series changes again.</span>

                                    <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">app</span> <span class="o">==</span> <span class="n">skyline_app</span> <span class="ow">and</span> <span class="n">check_full_duration</span><span class="p">:</span>
                                            <span class="k">for</span> <span class="n">snab_context</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">]:</span>
                                                <span class="k">if</span> <span class="n">snab_context</span> <span class="o">==</span> <span class="s1">&#39;testing&#39;</span><span class="p">:</span>
                                                    <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">]:</span>
                                                        <span class="k">try</span><span class="p">:</span>
                                                            <span class="n">alert_slack_channel</span> <span class="o">=</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;alert_slack_channel&#39;</span><span class="p">]</span>
                                                        <span class="k">except</span><span class="p">:</span>
                                                            <span class="n">alert_slack_channel</span> <span class="o">=</span> <span class="kc">None</span>
                                                        <span class="k">try</span><span class="p">:</span>
                                                            <span class="n">algorithm_source</span> <span class="o">=</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;algorithm_source&#39;</span><span class="p">]</span>
                                                        <span class="k">except</span><span class="p">:</span>
                                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to verify algorithm_source for </span><span class="si">%s</span><span class="s1"> for the </span><span class="si">%s</span><span class="s1"> context&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                                <span class="n">algorithm</span><span class="p">,</span> <span class="n">snab_context</span><span class="p">))</span>
                                                            <span class="k">break</span>
                                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">algorithm_source</span><span class="p">):</span>
                                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: algorithm_source file </span><span class="si">%s</span><span class="s1"> does not exist for </span><span class="si">%s</span><span class="s1"> for the </span><span class="si">%s</span><span class="s1"> context&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                                <span class="n">algorithm_source</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">snab_context</span><span class="p">))</span>
                                                            <span class="k">break</span>
                                                        <span class="k">try</span><span class="p">:</span>
                                                            <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">]</span>
                                                        <span class="k">except</span><span class="p">:</span>
                                                            <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="p">{}</span>
                                                        <span class="k">try</span><span class="p">:</span>
                                                            <span class="n">max_execution_time</span> <span class="o">=</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;max_execution_time&#39;</span><span class="p">]</span>
                                                        <span class="k">except</span><span class="p">:</span>
                                                            <span class="n">max_execution_time</span> <span class="o">=</span> <span class="mf">1.0</span>
                                                        <span class="k">try</span><span class="p">:</span>
                                                            <span class="n">algo_debug_logging</span> <span class="o">=</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;debug_logging&#39;</span><span class="p">]</span>
                                                        <span class="k">except</span><span class="p">:</span>
                                                            <span class="n">algo_debug_logging</span> <span class="o">=</span> <span class="kc">False</span>
                                                        <span class="k">try</span><span class="p">:</span>
                                                            <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]:</span>
                                                                <span class="c1"># if namespace in base_name:</span>
                                                                <span class="k">if</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">use_base_name</span><span class="p">:</span>
                                                                    <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_base_name</span>
                                                                    <span class="c1"># @added 20230429 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
                                                                    <span class="c1"># Use downsampled_timeseries data</span>
                                                                    <span class="k">if</span> <span class="n">use_downsampled_data</span><span class="p">:</span>
                                                                        <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;anomaly_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomaly_data</span>

                                                                    <span class="n">snab_check_details</span> <span class="o">=</span> <span class="p">{</span>
                                                                        <span class="c1"># &#39;metric&#39;: base_name,</span>
                                                                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">use_base_name</span><span class="p">,</span>
                                                                        <span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">:</span> <span class="n">labelled_metric_name</span><span class="p">,</span>
                                                                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                                                        <span class="s1">&#39;original_anomaly_timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                                                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                        <span class="s1">&#39;full_duration&#39;</span><span class="p">:</span> <span class="n">check_full_duration</span><span class="p">,</span>
                                                                        <span class="s1">&#39;anomaly_data&#39;</span><span class="p">:</span> <span class="n">anomaly_data</span><span class="p">,</span>
                                                                        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;mirage&#39;</span><span class="p">,</span>
                                                                        <span class="s1">&#39;added_at&#39;</span><span class="p">:</span> <span class="n">added_to_snab_at</span><span class="p">,</span>
                                                                        <span class="s1">&#39;original_added_at&#39;</span><span class="p">:</span> <span class="n">added_to_snab_at</span><span class="p">,</span>
                                                                        <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">snab_context</span><span class="p">,</span>
                                                                        <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="n">algorithm</span><span class="p">,</span>
                                                                        <span class="s1">&#39;algorithm_source&#39;</span><span class="p">:</span> <span class="n">algorithm_source</span><span class="p">,</span>
                                                                        <span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">:</span> <span class="n">algorithm_parameters</span><span class="p">,</span>
                                                                        <span class="s1">&#39;max_execution_time&#39;</span><span class="p">:</span> <span class="n">max_execution_time</span><span class="p">,</span>
                                                                        <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="n">algo_debug_logging</span><span class="p">,</span>
                                                                        <span class="s1">&#39;alert_slack_channel&#39;</span><span class="p">:</span> <span class="n">alert_slack_channel</span><span class="p">,</span>
                                                                        <span class="s1">&#39;processed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                        <span class="s1">&#39;analysed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                        <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                        <span class="s1">&#39;anomalyScore&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                        <span class="s1">&#39;snab_only&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                                    <span class="p">}</span>
                                                                    <span class="n">add_snab_check</span> <span class="o">=</span> <span class="kc">True</span>
                                                                    <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">snab_checks_sent</span><span class="p">:</span>
                                                                        <span class="n">add_snab_check</span> <span class="o">=</span> <span class="kc">False</span>
                                                                        <span class="k">break</span>
                                                                    <span class="k">if</span> <span class="n">add_snab_check</span><span class="p">:</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;snab.work&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_check_details</span><span class="p">))</span>
                                                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added snab check for </span><span class="si">%s</span><span class="s1"> with algorithm </span><span class="si">%s</span><span class="s1"> for alerter </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                                            <span class="n">base_name</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                                                                        <span class="n">snab_checks_sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                                                                    <span class="k">break</span>
                                                        <span class="k">except</span><span class="p">:</span>
                                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to check and add check_details to snab.work Redis set if required&#39;</span><span class="p">)</span>

                                <span class="c1"># Remove the metric from the waterfall_alerts Redis set</span>
                                <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp]</span>
                                <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp, waterfall_panorama_data]</span>
                                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.waterfall_alerts.sent_to_ionosphere&#39;</span>

                                <span class="c1"># @added 20200905 - Feature #3734: waterfall alerts</span>
                                <span class="c1"># Remove the metric from the waterfall_alerts Redis set</span>
                                <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp]</span>
                                <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp, waterfall_panorama_data]</span>
                                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.waterfall_alerts.sent_to_ionosphere&#39;</span>
                                <span class="n">literal_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">literal_waterfall_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">literal_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">literal_waterfall_alert</span> <span class="ow">in</span> <span class="n">literal_waterfall_alerts</span><span class="p">:</span>
                                    <span class="n">waterfall_alert</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">literal_waterfall_alert</span><span class="p">)</span>
                                    <span class="n">waterfall_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">waterfall_alert</span> <span class="ow">in</span> <span class="n">waterfall_alerts</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed waterfall alert item from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                    <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                    <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                            <span class="c1"># TODO - Add anomaly to Panorama when a waterfall alert triggers</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;alert Redis key </span><span class="si">%s</span><span class="s1"> exists not alerting for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cache_key</span><span class="p">),</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                                <span class="c1"># @added 20230430 - Task #2732: Prometheus to Skyline</span>
                                <span class="c1">#                   Branch #4300: prometheus</span>
<span class="c1"># TODO add to list and remove all in one as an alert may not exist for another alerter???</span>
                                <span class="c1"># If a redis alert key exists, handle removing the entry from</span>
                                <span class="c1"># mirage.anomalous_metrics due to the fact that if labelled_metrics</span>
                                <span class="c1"># can add up and fail to be removed if the alert is sent but mirage</span>
                                <span class="c1"># is restart BEFORE the mirage.anomalous_metrics set is deleted.</span>
                                <span class="c1"># When this occurs Mirage continues to do all the loop work on these</span>
                                <span class="c1"># and from that point they never get removed because the alert has been</span>
                                <span class="c1"># sent and the loops continue.  This ensures that if an anomalous metric has</span>
                                <span class="c1"># been alerted on, it is removed.</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">removed_a_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;mirage.anomalous_metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="n">removed_a_item</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed item from mirage.anomalous_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: could not remove item from mirage.anomalous_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)))</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to srem item from mirage.anomalous_metrics </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not query Redis for cache_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
            <span class="c1">#                   Task #3744: POC matrixprofile</span>
            <span class="n">snab_only_checks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">SNAB_ENABLED</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">literal_mirage_snab_only_checks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">mirage_snab_only_checks_redis_set</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">snab_only_check_string</span> <span class="ow">in</span> <span class="n">literal_mirage_snab_only_checks</span><span class="p">:</span>
                        <span class="n">snab_only_check</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">snab_only_check_string</span><span class="p">)</span>
                        <span class="n">snab_only_checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snab_only_check</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine list from mirage.not_anomalous_metrics Redis set&#39;</span><span class="p">)</span>
                    <span class="n">snab_only_checks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snab_only_checks</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;there are no snab_only_checks&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">snab_only_checks</span><span class="p">:</span>
                <span class="n">snab_only_checks_sent</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">all_alerts</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">snab_check</span> <span class="ow">in</span> <span class="n">snab_only_checks</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="n">snab_check</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                            <span class="n">anomaly_data</span> <span class="o">=</span> <span class="n">snab_check</span><span class="p">[</span><span class="s1">&#39;anomaly_data&#39;</span><span class="p">]</span>
                            <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="n">snab_check</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                            <span class="n">original_anomaly_timestamp</span> <span class="o">=</span> <span class="n">snab_check</span><span class="p">[</span><span class="s1">&#39;original_anomaly_timestamp&#39;</span><span class="p">]</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">snab_check</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                            <span class="n">original_added_at</span> <span class="o">=</span> <span class="n">snab_check</span><span class="p">[</span><span class="s1">&#39;original_added_at&#39;</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to details from snab_only_checks snab_check dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_check</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="p">[</span><span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span> <span class="ow">and</span> <span class="n">pattern_match</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: </span><span class="si">%s</span><span class="s1"> matched alert - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">metric_matched_by</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="n">check_full_duration</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">app</span> <span class="o">==</span> <span class="n">skyline_app</span> <span class="ow">and</span> <span class="n">check_full_duration</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">snab_context</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">]:</span>
                                        <span class="k">if</span> <span class="n">snab_context</span> <span class="o">==</span> <span class="s1">&#39;testing&#39;</span><span class="p">:</span>
                                            <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">]:</span>
                                                <span class="k">try</span><span class="p">:</span>
                                                    <span class="n">alert_slack_channel</span> <span class="o">=</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;alert_slack_channel&#39;</span><span class="p">]</span>
                                                <span class="k">except</span><span class="p">:</span>
                                                    <span class="n">alert_slack_channel</span> <span class="o">=</span> <span class="kc">None</span>
                                                <span class="k">try</span><span class="p">:</span>
                                                    <span class="n">algorithm_source</span> <span class="o">=</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;algorithm_source&#39;</span><span class="p">]</span>
                                                <span class="k">except</span><span class="p">:</span>
                                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to verify algorithm_source for </span><span class="si">%s</span><span class="s1"> for the </span><span class="si">%s</span><span class="s1"> context&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                        <span class="n">algorithm</span><span class="p">,</span> <span class="n">snab_context</span><span class="p">))</span>
                                                    <span class="k">break</span>
                                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">algorithm_source</span><span class="p">):</span>
                                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: algorithm_source file </span><span class="si">%s</span><span class="s1"> does not exist for </span><span class="si">%s</span><span class="s1"> for the </span><span class="si">%s</span><span class="s1"> context&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                        <span class="n">algorithm_source</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">snab_context</span><span class="p">))</span>
                                                    <span class="k">break</span>
                                                <span class="k">try</span><span class="p">:</span>
                                                    <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">]</span>
                                                <span class="k">except</span><span class="p">:</span>
                                                    <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="p">{}</span>
                                                <span class="k">try</span><span class="p">:</span>
                                                    <span class="n">max_execution_time</span> <span class="o">=</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;max_execution_time&#39;</span><span class="p">]</span>
                                                <span class="k">except</span><span class="p">:</span>
                                                    <span class="n">max_execution_time</span> <span class="o">=</span> <span class="mf">1.0</span>
                                                <span class="k">try</span><span class="p">:</span>
                                                    <span class="n">algo_debug_logging</span> <span class="o">=</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;debug_logging&#39;</span><span class="p">]</span>
                                                <span class="k">except</span><span class="p">:</span>
                                                    <span class="n">algo_debug_logging</span> <span class="o">=</span> <span class="kc">False</span>
                                                <span class="k">try</span><span class="p">:</span>
                                                    <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">SNAB_CHECKS</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">snab_context</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]:</span>
                                                        <span class="k">if</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
                                                            <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
                                                            <span class="n">snab_check_details</span> <span class="o">=</span> <span class="p">{</span>
                                                                <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                                                                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">),</span>
                                                                <span class="s1">&#39;original_anomaly_timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">original_anomaly_timestamp</span><span class="p">),</span>
                                                                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                                                                <span class="s1">&#39;full_duration&#39;</span><span class="p">:</span> <span class="n">check_full_duration</span><span class="p">,</span>
                                                                <span class="s1">&#39;anomaly_data&#39;</span><span class="p">:</span> <span class="n">anomaly_data</span><span class="p">,</span>
                                                                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;mirage&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;added_at&#39;</span><span class="p">:</span> <span class="n">added_to_snab_at</span><span class="p">,</span>
                                                                <span class="s1">&#39;original_added_at&#39;</span><span class="p">:</span> <span class="n">original_added_at</span><span class="p">,</span>
                                                                <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">snab_context</span><span class="p">,</span>
                                                                <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="n">algorithm</span><span class="p">,</span>
                                                                <span class="s1">&#39;algorithm_source&#39;</span><span class="p">:</span> <span class="n">algorithm_source</span><span class="p">,</span>
                                                                <span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">:</span> <span class="n">algorithm_parameters</span><span class="p">,</span>
                                                                <span class="s1">&#39;max_execution_time&#39;</span><span class="p">:</span> <span class="n">max_execution_time</span><span class="p">,</span>
                                                                <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="n">algo_debug_logging</span><span class="p">,</span>
                                                                <span class="s1">&#39;alert_slack_channel&#39;</span><span class="p">:</span> <span class="n">alert_slack_channel</span><span class="p">,</span>
                                                                <span class="s1">&#39;processed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                <span class="s1">&#39;analysed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                <span class="s1">&#39;anomalyScore&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                <span class="s1">&#39;snab_only&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                            <span class="p">}</span>
                                                            <span class="n">add_snab_check</span> <span class="o">=</span> <span class="kc">True</span>
                                                            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">snab_only_checks_sent</span><span class="p">:</span>
                                                                <span class="n">add_snab_check</span> <span class="o">=</span> <span class="kc">False</span>
                                                                <span class="k">break</span>
                                                            <span class="k">if</span> <span class="n">add_snab_check</span><span class="p">:</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;snab.work&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_check_details</span><span class="p">))</span>
                                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added snab_only check for </span><span class="si">%s</span><span class="s1"> with algorithm </span><span class="si">%s</span><span class="s1"> for alerter </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                                    <span class="n">metric</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                                                                <span class="n">snab_only_checks_sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                                            <span class="k">break</span>
                                                <span class="k">except</span><span class="p">:</span>
                                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to check and add check_details to snab.work Redis set if required&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="n">mirage_not_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># literal_mirage_not_anomalous_metrics = list(self.redis_conn.smembers(&#39;mirage.not_anomalous_metrics&#39;))</span>
                <span class="n">literal_mirage_not_anomalous_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage.not_anomalous_metrics&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">metric_list_string</span> <span class="ow">in</span> <span class="n">literal_mirage_not_anomalous_metrics</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">metric_list_string</span><span class="p">)</span>
                    <span class="n">mirage_not_anomalous_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine list from mirage.not_anomalous_metrics Redis set&#39;</span><span class="p">)</span>
                <span class="n">mirage_not_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">NEGATE_ANALYZER_ALERTS</span><span class="p">:</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># if len(self.anomalous_metrics) == 0:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mirage_anomalous_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># @modified 20200610 - Feature #3560: External alert config</span>
                    <span class="c1"># for negate_alert in settings.ALERTS:</span>
                    <span class="k">for</span> <span class="n">negate_alert</span> <span class="ow">in</span> <span class="n">all_alerts</span><span class="p">:</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># for not_anomalous_metric in self.not_anomalous_metrics:</span>
                        <span class="k">for</span> <span class="n">not_anomalous_metric</span> <span class="ow">in</span> <span class="n">mirage_not_anomalous_metrics</span><span class="p">:</span>
                            <span class="n">NEGATE_ALERT_MATCH_PATTERN</span> <span class="o">=</span> <span class="n">negate_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">NOT_ANOMALOUS_METRIC_PATTERN</span> <span class="o">=</span> <span class="n">not_anomalous_metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">alert_match_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">NEGATE_ALERT_MATCH_PATTERN</span><span class="p">)</span>
                            <span class="n">negate_pattern_match</span> <span class="o">=</span> <span class="n">alert_match_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">NOT_ANOMALOUS_METRIC_PATTERN</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">negate_pattern_match</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;negate alert sent: For </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">not_anomalous_metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                    <span class="n">trigger_negater</span><span class="p">(</span><span class="n">negate_alert</span><span class="p">,</span> <span class="n">not_anomalous_metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">metric_value</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not send alert: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># @added 20220316 - Feature #4482: Test alerts</span>
            <span class="c1"># Remove test_alert key if metric has been done and anything went wrong</span>
            <span class="c1"># so that mirage does not loop continuosly on the metric failing</span>
            <span class="k">if</span> <span class="n">test_alerts</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">test_alert_timestamp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_alerts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test_metric</span> <span class="o">=</span> <span class="n">test_alerts</span><span class="p">[</span><span class="n">test_alert_timestamp</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                        <span class="n">alert_tested_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.test_alerts.done.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">test_metric</span>
                        <span class="n">alert_tested</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">alert_tested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alert_tested_key</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">alert_tested_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">alert_tested</span> <span class="ow">and</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">test_metric</span><span class="p">:</span>
                            <span class="n">use_metric</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">test_metric</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                                    <span class="n">use_metric</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_labelled_metrics_name failed for test alert metric </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">test_metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">use_metric</span><span class="p">:</span>
                                <span class="n">alert_tested_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.test_alerts.done.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">use_metric</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">alert_tested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alert_tested_key</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">alert_tested_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">alert_tested</span><span class="p">:</span>
                            <span class="n">test_alert_redis_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.test_alerts&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">test_alert_redis_key</span><span class="p">,</span> <span class="n">test_alert_timestamp</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed test_alert for </span><span class="si">%s</span><span class="s1"> from Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">test_metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_alert_redis_key</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove test_alert for </span><span class="si">%s</span><span class="s1"> from Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">test_metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_alert_redis_key</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># Log progress</span>
            <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="c1"># if len(self.anomalous_metrics) &gt; 0:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mirage_anomalous_metrics</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;seconds since last anomaly :: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">))</span>
                    <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                    <span class="c1"># logger.info(&#39;total anomalies    :: %d&#39; % len(self.anomalous_metrics))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;total anomalies    :: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">mirage_anomalous_metrics</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exception stats    :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exceptions</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;anomaly breakdown  :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_breakdown</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to log stats - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># Log to Graphite</span>
            <span class="k">if</span> <span class="n">process_metric_check_files</span><span class="p">:</span>
                <span class="n">run_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">run_timestamp</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;seconds to run    :: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">run_time</span><span class="p">)</span>
                <span class="n">graphite_run_time</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">run_time</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="n">skyline_app_graphite_namespace</span> <span class="o">+</span> <span class="s1">&#39;.run_time&#39;</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="n">graphite_run_time</span><span class="p">)</span>

            <span class="c1"># @added 20200805 - Task #3662: Change mirage.last_check keys to timestamp value</span>
            <span class="c1">#                   Feature #3486: analyzer_batch</span>
            <span class="c1">#                   Feature #3480: batch_processing</span>
            <span class="c1"># Add the mirage metric and its EXPIRATION_TIME to</span>
            <span class="c1"># the mirage.metrics_expiration_times so that Mirage</span>
            <span class="c1"># can determine the metric EXPIRATION_TIME without</span>
            <span class="c1"># having to create and iterate the all_alerts</span>
            <span class="c1"># object in the Mirage analysis phase so that the</span>
            <span class="c1"># reported anomaly timestamp can be used to determine</span>
            <span class="c1"># whether the EXPIRATION_TIME should be applied to a</span>
            <span class="c1"># batch metric in the alerting and Ionosphere contexts</span>
            <span class="c1"># @modified 20201107 - Feature #3830: metrics_manager</span>
            <span class="c1"># Use metrics_manager data, now managed there</span>
            <span class="c1"># mirage_metrics_expiration_times = []</span>
            <span class="c1"># try:</span>
            <span class="c1">#     mirage_metrics_expiration_times = list(self.redis_conn_decoded.smembers(&#39;mirage.metrics_expiration_times&#39;))</span>
            <span class="c1">#     if LOCAL_DEBUG:</span>
            <span class="c1">#         logger.info(&#39;debug :: fetched the mirage.metrics_expiration_times Redis set&#39;)</span>
            <span class="c1"># except:</span>
            <span class="c1">#     logger.info(&#39;failed to fetch the mirage.metrics_expiration_times Redis set&#39;)</span>
            <span class="c1">#     mirage_metrics_expiration_times = []</span>
            <span class="c1"># try:</span>
            <span class="c1">#     mirage_unique_metrics = list(self.redis_conn_decoded.smembers(&#39;mirage.unique_metrics&#39;))</span>
            <span class="c1">#     mirage_unique_metrics_count = len(mirage_unique_metrics)</span>
            <span class="c1">#     logger.info(&#39;mirage.unique_metrics Redis set count - %s&#39; % str(mirage_unique_metrics_count))</span>
            <span class="c1">#     if LOCAL_DEBUG:</span>
            <span class="c1">#         logger.info(&#39;debug :: fetched the mirage.unique_metrics Redis set&#39;)</span>
            <span class="c1">#         logger.info(&#39;debug :: %s&#39; % str(mirage_unique_metrics))</span>
            <span class="c1"># except:</span>
            <span class="c1">#     logger.info(&#39;failed to fetch the mirage.unique_metrics Redis set&#39;)</span>
            <span class="c1">#     mirage_unique_metrics == []</span>
            <span class="c1"># for metric in mirage_unique_metrics:</span>
            <span class="c1">#     if metric.startswith(settings.FULL_NAMESPACE):</span>
            <span class="c1">#         base_name = metric.replace(settings.FULL_NAMESPACE, &#39;&#39;, 1)</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         base_name = metric</span>
            <span class="c1">#     mirage_alert_expiration_data = [base_name, int(alert[2])]</span>
            <span class="c1">#     if str(mirage_alert_expiration_data) not in mirage_metrics_expiration_times:</span>
            <span class="c1">#         try:</span>
            <span class="c1">#             self.redis_conn.sadd(&#39;mirage.metrics_expiration_times&#39;, str(mirage_alert_expiration_data))</span>
            <span class="c1">#             if LOCAL_DEBUG:</span>
            <span class="c1">#                 logger.info(&#39;debug :: added %s to mirage.metrics_expiration_times&#39; % str(mirage_alert_expiration_data))</span>
            <span class="c1">#         except:</span>
            <span class="c1">#             if LOCAL_DEBUG:</span>
            <span class="c1">#                 logger.error(&#39;error :: failed to add %s to mirage.metrics_expiration_times set&#39; % str(mirage_alert_expiration_data))</span>

            <span class="c1"># Reset counters</span>
            <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="c1"># Use Redis sets instead of Manager().list()</span>
            <span class="c1"># self.anomalous_metrics[:] = []</span>
            <span class="c1"># self.not_anomalous_metrics[:] = []</span>

            <span class="c1"># Reset metric_variables</span>
            <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="c1"># Use Redis sets instead of Manager().list()</span>
            <span class="c1"># self.metric_variables[:] = []</span>
            <span class="c1"># self.sent_to_crucible[:] = []</span>
            <span class="c1"># self.sent_to_panorama[:] = []</span>
            <span class="c1"># self.sent_to_ionosphere[:] = []</span>

            <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="c1"># Use Redis sets instead of Manager().list()</span>
            <span class="n">delete_redis_sets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;mirage.anomalous_metrics&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mirage.not_anomalous_metrics&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mirage.metric_variables&#39;</span><span class="p">,</span>
                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># Handle once per minute</span>
                <span class="c1"># &#39;mirage.sent_to_crucible&#39;,</span>
                <span class="c1"># &#39;mirage.sent_to_panorama&#39;,</span>
                <span class="c1"># &#39;mirage.sent_to_ionosphere&#39;,</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">i_redis_set</span> <span class="ow">in</span> <span class="n">delete_redis_sets</span><span class="p">:</span>
                <span class="n">redis_set_to_delete</span> <span class="o">=</span> <span class="n">i_redis_set</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">redis_set_to_delete</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;deleted Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to delete Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>

            <span class="c1"># DEVELOPMENT ONLY</span>
            <span class="c1"># @added 20160806 - Bug #1558: Memory leak in Analyzer</span>
            <span class="c1"># Debug with garbage collection - http://code.activestate.com/recipes/65333/</span>
            <span class="k">if</span> <span class="n">ENABLE_MEMORY_PROFILING</span> <span class="ow">and</span> <span class="n">garbage_collection_enabled</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span> <span class="ow">or</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">get_objects</span><span class="p">():</span>
                        <span class="n">after</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">gc_results</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">after</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">before</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">after</span> <span class="k">if</span> <span class="n">after</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">before</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">gc_result</span> <span class="ow">in</span> <span class="n">gc_results</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">gc_result</span><span class="p">))</span>

                <span class="c1"># @added 20160806 - Bug #1558: Memory leak in Analyzer</span>
                <span class="c1"># Debug with garbage collection - http://code.activestate.com/recipes/65333/</span>
                <span class="c1"># show the dirt ;-)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;garbage collecting&#39;</span><span class="p">)</span>
                    <span class="n">all_the_garbage</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_garbage</span><span class="p">())</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: during garbage collecting&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">all_the_garbage</span> <span class="o">=</span> <span class="s1">&#39;gc errored&#39;</span>

                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span> <span class="ow">or</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">all_the_garbage</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;garbage collected&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: Memory usage end of run: </span><span class="si">%s</span><span class="s1"> (kb)&#39;</span> <span class="o">%</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)</span>

            <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
            <span class="c1"># Send checks.stale_discarded and checks.pending metrics</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">last_sent_to_graphite</span> <span class="o">+</span> <span class="mi">60</span><span class="p">):</span>
                <span class="n">stale_check_discarded</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stale_check_discarded</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage.stale_check_discarded&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get mirage.stale_check_discarded set from Redis&#39;</span><span class="p">)</span>
                    <span class="n">stale_check_discarded</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">stale_check_discarded_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stale_check_discarded</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checks.stale_discarded   :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">stale_check_discarded_count</span><span class="p">))</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.checks.stale_discarded&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">stale_check_discarded_count</span><span class="p">))</span>
                <span class="n">checks_pending</span> <span class="o">=</span> <span class="p">[</span><span class="n">f_pending</span> <span class="k">for</span> <span class="n">f_pending</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span><span class="p">,</span> <span class="n">f_pending</span><span class="p">))]</span>
                <span class="n">checks_pending_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">checks_pending</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checks.pending   :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">checks_pending_count</span><span class="p">))</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.checks.pending&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">checks_pending_count</span><span class="p">))</span>

                <span class="c1"># @modified 20210309 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># Reimplement mirage.checks.done count as increment key</span>
                <span class="c1"># checks_done = []</span>
                <span class="c1"># try:</span>
                <span class="c1">#     checks_done = list(self.redis_conn_decoded.smembers(&#39;mirage.checks.done&#39;))</span>
                <span class="n">checks_done</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20230205 - Task #4844: Replace Redis getset with set with get</span>
                    <span class="c1"># As of Redis version 6.2.0, this command is regarded as deprecated.</span>
                    <span class="c1"># It can be replaced by SET with the GET argument when migrating or writing new code.</span>
                    <span class="c1"># checks_done_str = self.redis_conn_decoded.getset(&#39;mirage.checks.done&#39;, 0)</span>
                    <span class="n">checks_done_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;mirage.checks.done&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">checks_done_str</span><span class="p">:</span>
                        <span class="n">checks_done</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">checks_done_str</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get mirage.checks.done key from Redis&#39;</span><span class="p">)</span>
                    <span class="n">checks_done</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># checks_done_count = len(checks_done)</span>
                <span class="c1"># logger.info(&#39;checks.done   :: %s&#39; % str(checks_done_count))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checks.done   :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">checks_done</span><span class="p">))</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.checks.done&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                <span class="c1"># send_graphite_metric(self, skyline_app, send_metric_name, str(checks_done_count))</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">checks_done</span><span class="p">))</span>
                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># Only send panorama, ionosphere and crucible metrics once a minute</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_CRUCIBLE</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CRUCIBLE_ENABLED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># sent_to_crucible = str(len(self.sent_to_crucible))#</span>
                        <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># sent_to_crucible = str(len(list(self.redis_conn.smembers(&#39;mirage.sent_to_crucible&#39;))))</span>
                        <span class="n">sent_to_crucible</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage.sent_to_crucible&#39;</span><span class="p">))))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">sent_to_crucible</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sent_to_crucible   :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sent_to_crucible</span><span class="p">)</span>
                    <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.sent_to_crucible&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                    <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="n">sent_to_crucible</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># sent_to_panorama = str(len(self.sent_to_panorama))</span>
                        <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># sent_to_panorama = str(len(list(self.redis_conn.smembers(&#39;mirage.sent_to_panorama&#39;))))</span>
                        <span class="n">sent_to_panorama</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage.sent_to_panorama&#39;</span><span class="p">))))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">sent_to_panorama</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sent_to_panorama   :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sent_to_panorama</span><span class="p">)</span>
                    <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.sent_to_panorama&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                    <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="n">sent_to_panorama</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_ENABLED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># sent_to_ionosphere = str(len(self.sent_to_ionosphere))</span>
                        <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># sent_to_ionosphere = str(len(list(self.redis_conn.smembers(&#39;mirage.sent_to_ionosphere&#39;))))</span>
                        <span class="n">sent_to_ionosphere</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage.sent_to_ionosphere&#39;</span><span class="p">))))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not determine sent_to_ionosphere: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">sent_to_ionosphere</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sent_to_ionosphere :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sent_to_ionosphere</span><span class="p">)</span>
                    <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.sent_to_ionosphere&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                    <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="n">sent_to_ionosphere</span><span class="p">)</span>
                <span class="n">last_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="n">delete_redis_sets</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;mirage.sent_to_crucible&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;mirage.sent_to_panorama&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;mirage.sent_to_ionosphere&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;mirage.stale_check_discarded&#39;</span><span class="p">,</span>
                    <span class="c1"># @modified 20210309 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># Reimplement mirage.checks.done count as increment key</span>
                    <span class="c1"># &#39;mirage.checks.done&#39;,</span>
                    <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
                    <span class="c1">#                   Task #3744: POC matrixprofile</span>
                    <span class="n">mirage_snab_only_checks_redis_set</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">i_redis_set</span> <span class="ow">in</span> <span class="n">delete_redis_sets</span><span class="p">:</span>
                    <span class="n">redis_set_to_delete</span> <span class="o">=</span> <span class="n">i_redis_set</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">redis_set_to_delete</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;deleted Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to delete Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>

                <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                <span class="c1"># Refresh</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">filesafe_names_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.filesafe_base_names&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: hgetall metrics_manager.filesafe_base_names failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># @added 20230609 - Task #4806: Manage NUMBA_CACHE_DIR</span>
            <span class="c1">#                   Feature #4702: numba optimisations</span>
            <span class="c1"># Use start up key and allow numba cache files to be created</span>
            <span class="k">if</span> <span class="n">starting</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">start_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: delete failed on Redis </span><span class="si">%s</span><span class="s1"> key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">start_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># Sleep if it went too fast</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sleeping due to low run time...&#39;</span><span class="p">)</span>
<span class="c1">#                sleep(10)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>