<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mirage.mirage_labelled_metrics &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mirage.mirage_labelled_metrics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mirage.mirage_labelled_metrics</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">mirage_labelled_metrics.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="c1"># from redis import StrictRedis</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">strftime</span><span class="p">,</span> <span class="n">gmtime</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
<span class="c1"># Use Redis sets in place of Manager().list() to reduce memory and number of</span>
<span class="c1"># processes</span>
<span class="c1"># from multiprocessing import Process, Manager, Queue</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="c1"># imports required for surfacing graphite JSON formatted timeseries for use in</span>
<span class="c1"># Mirage</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># @added 20220722 - Task #4624: Change all dict copy to deepcopy</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">settings</span>
<span class="c1"># @modified 20160922 - Branch #922: Ionosphere</span>
<span class="c1"># Added the send_anomalous_metric_to skyline_functions.py</span>
<span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">write_data_to_file</span><span class="p">,</span> <span class="n">fail_check</span><span class="p">,</span> <span class="n">send_anomalous_metric_to</span><span class="p">,</span>
    <span class="c1"># @modified 20220726 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                      Branch #4300: prometheus</span>
    <span class="c1"># Moved send_graphite_metric</span>
    <span class="c1"># mkdir_p, send_graphite_metric, filesafe_metricname,</span>
    <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">filesafe_metricname</span><span class="p">,</span>
    <span class="c1"># @added 20191030 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                   Branch #3262: py3</span>
    <span class="c1"># Added a single functions to deal with Redis connection and the</span>
    <span class="c1"># charset=&#39;utf-8&#39;, decode_responses=True arguments required in py3</span>
    <span class="n">get_redis_conn</span><span class="p">,</span> <span class="n">get_redis_conn_decoded</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">mirage_algorithms</span> <span class="kn">import</span> <span class="n">run_selected_algorithm</span>
<span class="kn">from</span> <span class="nn">algorithm_exceptions</span> <span class="kn">import</span> <span class="n">TooShort</span><span class="p">,</span> <span class="n">Stale</span><span class="p">,</span> <span class="n">Boring</span>

<span class="c1"># @added 20220504 - Feature #2580: illuminance</span>
<span class="kn">from</span> <span class="nn">functions.illuminance.add_illuminance_entries</span> <span class="kn">import</span> <span class="n">add_illuminance_entries</span>

<span class="c1"># @added 20220715 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.victoriametrics.get_victoriametrics_metric</span> <span class="kn">import</span> <span class="n">get_victoriametrics_metric</span>
<span class="kn">from</span> <span class="nn">functions.prometheus.metric_name_labels_parser</span> <span class="kn">import</span> <span class="n">metric_name_labels_parser</span>

<span class="c1"># @added 20220726 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.graphite.send_graphite_metric</span> <span class="kn">import</span> <span class="n">send_graphite_metric</span>

<span class="kn">from</span> <span class="nn">functions.metrics.get_base_name_from_labelled_metrics_name</span> <span class="kn">import</span> <span class="n">get_base_name_from_labelled_metrics_name</span>

<span class="c1"># @added 20221105 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
<span class="kn">from</span> <span class="nn">custom_algorithms</span> <span class="kn">import</span> <span class="n">run_custom_algorithm_on_timeseries</span>

<span class="c1"># @added 20230419 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.normalized_variance</span> <span class="kn">import</span> <span class="n">normalized_variance</span>

<span class="c1"># @added 20230522 - metric_type.longterm_expire</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.strictly_increasing_monotonicity</span> <span class="kn">import</span> <span class="n">strictly_increasing_monotonicity</span>

<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;mirage&#39;</span>
<span class="n">skyline_app_logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Log&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
<span class="n">skyline_app_logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
<span class="n">skyline_app_loglock</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">skyline_app_logwait</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wait&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>

<span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">this_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
    <span class="k">if</span> <span class="n">SERVER_METRIC_PATH</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20200606 - Bug #3572: Apply list to settings import</span>
    <span class="n">BATCH_PROCESSING_NAMESPACES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BATCH_PROCESSING_NAMESPACES</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">BATCH_PROCESSING_NAMESPACES</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
<span class="c1"># Determine if any metrcs have negatives values some they can be</span>
<span class="c1"># added to the ionosphere.untrainable_metrics Redis set</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20200606 - Bug #3572: Apply list to settings import</span>
    <span class="c1"># from settings import KNOWN_NEGATIVE_METRICS</span>
    <span class="n">KNOWN_NEGATIVE_METRICS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">KNOWN_NEGATIVE_METRICS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">KNOWN_NEGATIVE_METRICS</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20200607 - Feature #3566: custom_algorithms</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">CUSTOM_ALGORITHMS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">DEBUG_CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG_CUSTOM_ALGORITHMS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">DEBUG_CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20200913 - Branch #3068: SNAB</span>
<span class="c1">#                   Task #3744: POC matrixprofile</span>
<span class="c1">#                   Info #1792: Shapelet extraction</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">SNAB_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SNAB_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SNAB_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
    <span class="c1"># SNAB_CHECKS = settings.SNAB_CHECKS.copy()</span>
    <span class="n">SNAB_CHECKS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SNAB_CHECKS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SNAB_CHECKS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
<span class="c1">#                   Task #3744: POC matrixprofile</span>
<span class="n">mirage_snab_only_checks_redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.snab_only_checks&#39;</span>

<span class="c1"># @added 20201026 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
<span class="c1"># Handle feedback metrics in a similar style to Ionosphere</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_FEEDBACK_NAMESPACES</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># Let us take a guess</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">graphite_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">)</span>
        <span class="n">graphite_hostname</span> <span class="o">=</span> <span class="n">graphite_host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span><span class="p">,</span> <span class="n">graphite_hostname</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">=</span> <span class="p">[</span><span class="n">this_host</span><span class="p">]</span>

<span class="c1"># @added 20210701 - Feature #4152: DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20201208 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1">#                   Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1"># @modified 20220414 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1">#                   Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1"># Not introduced as a settings, making this the default behaviour</span>
<span class="c1"># try:</span>
<span class="c1">#     MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS = settings.MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="c1"># except:</span>
<span class="c1">#     MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS = False</span>
<span class="n">MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># @added 20210323 - Feature #3642: Anomaly type classification</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20221105 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># @added 20230424 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
<span class="c1"># Added expiry to record metrics identified as normal by anomalous_daily_peaks</span>
<span class="c1"># to allow Mirage to set a key in a hash and to allow Analyzer labelled_metrics</span>
<span class="c1"># to skip analysis of those metrics for the expiry period.  This is to reduce</span>
<span class="c1"># metrics that are experiencing a normal anomalous daily peak to not have to</span>
<span class="c1"># be analysed by Analyzer every run and pushed to Mirage to check as this</span>
<span class="c1"># results in Mirage getting lots of unnecessary checks which caused feedback</span>
<span class="c1"># for the period in question.</span>
<span class="n">anomalous_daily_peak_expiry</span> <span class="o">=</span> <span class="mi">180</span>

<span class="n">skyline_app_graphite_namespace</span> <span class="o">=</span> <span class="s1">&#39;skyline.</span><span class="si">%s%s</span><span class="s1">.labelled_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">SERVER_METRIC_PATH</span><span class="p">)</span>
<span class="n">failed_checks_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_failed&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span>
<span class="c1"># @added 20191107 - Branch #3262: py3</span>
<span class="n">alert_test_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_alert_test.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>

<span class="c1"># In Skyline a metric is either a counter (derivative) or a gauge</span>
<span class="n">skyline_metric_types</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">skyline_metric_types_by_id</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">o_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">skyline_metric_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">skyline_metric_types_by_id</span><span class="p">[</span><span class="n">skyline_metric_types</span><span class="p">[</span><span class="n">o_key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">o_key</span>

<span class="n">MIRAGE_LABELLED_CHECK_PATH</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_labelled_metrics&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span>


<div class="viewcode-block" id="MirageLabelledMetrics"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_labelled_metrics.MirageLabelledMetrics">[docs]</a><span class="k">class</span> <span class="nc">MirageLabelledMetrics</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The MirageLabelledMetrics thread</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_pid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Mirage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span> <span class="o">=</span> <span class="n">parent_pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirage_labelled_metrics_exceptions_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirage_labelled_metrics_anomaly_breakdown_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>

<div class="viewcode-block" id="MirageLabelledMetrics.check_if_parent_is_alive"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_labelled_metrics.MirageLabelledMetrics.check_if_parent_is_alive">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_parent_is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Self explanatory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># @added 20201203 - Bug #3856: Handle boring sparsely populated metrics in derivative_metrics</span>
            <span class="c1"># Log warning</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: parent or current process dead&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

    <span class="c1"># @added 20170127 - Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
    <span class="c1">#                   Bug #1460: panorama check file fails</span>
    <span class="c1">#                   Panorama check file fails #24</span>
    <span class="c1"># Get rid of the skyline_functions imp as imp is deprecated in py3 anyway</span>
<div class="viewcode-block" id="MirageLabelledMetrics.mirage_load_metric_vars"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_labelled_metrics.MirageLabelledMetrics.mirage_load_metric_vars">[docs]</a>    <span class="k">def</span> <span class="nf">mirage_load_metric_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_vars_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the metric variables for a check from a metric check variables file</span>

<span class="sd">        :param metric_vars_file: the path and filename to the metric variables files</span>
<span class="sd">        :type metric_vars_file: str</span>
<span class="sd">        :return: the metric_vars list or ``False``</span>
<span class="sd">        :rtype: list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;loading metric variables from metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: loading metric variables from metric_check_file - file not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">metric_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">no_new_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">no_equal_line</span> <span class="o">=</span> <span class="n">no_new_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; = &#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">array</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">no_equal_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">add_line</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                <span class="n">metric_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_line</span><span class="p">)</span>

        <span class="c1"># @added 20200429 - Feature #3486: analyzer_batch</span>
        <span class="c1">#                   Feature #3480: batch_processing</span>
        <span class="c1"># Allow the check file to already hold a valid python list on one line</span>
        <span class="c1"># so that a check can be added by simply echoing to debug metric_vars</span>
        <span class="c1"># line from to log for any failed checks into a new Mirage check file</span>
        <span class="c1"># The original above pattern is still the default, this is for the check</span>
        <span class="c1"># files to be added by the operator from the log or for debugging.</span>
        <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">metric_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: metric_vars is not a list, set to try_literal_eval&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_vars</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: metric_vars is not a list of lists, set to try_literal_eval&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: metric_vars is not defined, set to try_literal_eval&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">try_literal_eval</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">metric_vars</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metric_vars</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metric_vars not loaded with literal_eval&#39;</span><span class="p">)</span>
                <span class="n">metric_vars</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">string_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
        <span class="n">float_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">int_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_timestamp&#39;</span><span class="p">]</span>
        <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
        <span class="c1">#                   Task #3744: POC matrixprofile</span>
        <span class="n">boolean_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snab_only_check&#39;</span><span class="p">]</span>

        <span class="c1"># @added 20210304 - Feature #3642: Anomaly type classification</span>
        <span class="c1">#                   Feature #3970: custom_algorithm - adtk_level_shift</span>
        <span class="c1"># Added triggered_algorithms to mirage_check_file</span>
        <span class="n">list_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">]</span>

        <span class="n">metric_vars_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars</span><span class="p">:</span>
            <span class="c1"># @modified 20181023 - Feature #2618: alert_slack</span>
            <span class="c1"># Wrapped in try except for debugging issue where the</span>
            <span class="c1"># hours_to_resolve was interpolating to hours_to_resolve = &quot;t&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">string_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_value_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">float_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_value_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">int_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_value_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">))</span>
                <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
                <span class="c1">#                   Task #3744: POC matrixprofile</span>
                <span class="c1"># Handle new snab_only_check boolean</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">boolean_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;debug :: boolean key - key: </span><span class="si">%s</span><span class="s1">, value: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;&quot;True&quot;&#39;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20210304 - Feature #3642: Anomaly type classification</span>
                <span class="c1">#                   Feature #3970: custom_algorithm - adtk_level_shift</span>
                <span class="c1"># Added triggered_algorithms to mirage_check_file</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">list_keys</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;debug :: list key - key: </span><span class="si">%s</span><span class="s1">, value: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                    <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;error :: loading metric variables - failed to literal_eval list for </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">e</span><span class="p">))</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">metric_vars_array</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_vars_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;error :: loading metric variables - none found from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to load metric variables from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_vars_file</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: debug :: metric_vars for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: debug :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_array</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">metric_vars_array</span></div>

<div class="viewcode-block" id="MirageLabelledMetrics.create_check_file_from_hash_key"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_labelled_metrics.MirageLabelledMetrics.create_check_file_from_hash_key">[docs]</a>    <span class="k">def</span> <span class="nf">create_check_file_from_hash_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a check file from an analyzer_labelled_metrics.mirage_check key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.mirage_check&#39;</span>
        <span class="n">metric_prefix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">check_item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.mirage_check.&#39;</span><span class="p">):</span>
            <span class="n">hash_key</span> <span class="o">=</span> <span class="n">check_item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.mirage_check.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">metric_prefix</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics&#39;</span>
        <span class="n">metric_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_data_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric_data_str</span><span class="p">:</span>
                <span class="n">metric_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">metric_data_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: create_check_file_from_hash_key :: failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> from Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">hash_key</span><span class="p">),</span> <span class="n">redis_hash</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">metric_data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: create_check_file_from_hash_key :: removed </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> from Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">hash_key</span><span class="p">),</span> <span class="n">redis_hash</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: create_check_file_from_hash_key :: failed to hdel </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> from Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">hash_key</span><span class="p">),</span> <span class="n">redis_hash</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">metric_prefix</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">use_hours_to_resolve</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">use_hours_to_resolve</span> <span class="o">=</span> <span class="mi">168</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">snab_only_check</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;snab_only_check&#39;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">snab_only_check</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">metric_prefix</span> <span class="o">==</span> <span class="s1">&#39;labelled_metrics&#39;</span><span class="p">:</span>
                    <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;victoriametrics&#39;</span>

                <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_dict</span> <span class="o">=</span> <span class="n">metric_name_labels_parser</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: create_check_file_from_hash_key :: metric_name_labels_parser failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric_dict&#39;</span><span class="p">][</span><span class="n">i_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="n">i_key</span><span class="p">]</span>

                <span class="n">anomaly_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MIRAGE_LABELLED_CHECK_PATH</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anomaly_check_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;metric = &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">value = &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">hours_to_resolve = &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">metric_timestamp = &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">snab_only_check = &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">triggered_algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_hours_to_resolve</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_only_check</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)))</span>
                    <span class="n">mirage_anomaly_check_file_created</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to write anomaly_check_file </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">anomaly_check_file</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">mirage_anomaly_check_file_created</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">anomaly_check_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o644</span><span class="p">)</span>
                <span class="n">check</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to create anomaly check file from metric_data: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">check</span><span class="p">,</span> <span class="n">metric_data</span></div>

    <span class="c1"># @added 20221105 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
<div class="viewcode-block" id="MirageLabelledMetrics.clear_trigger_history"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_labelled_metrics.MirageLabelledMetrics.clear_trigger_history">[docs]</a>    <span class="k">def</span> <span class="nf">clear_trigger_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear last item from the trigger history</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trigger_history</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_trigger_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;mirage.trigger_history&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raw_trigger_history</span><span class="p">:</span>
                <span class="n">trigger_history</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">raw_trigger_history</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to evaluate data from mirage.trigger_history Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">trigger_history</span><span class="p">:</span>
            <span class="n">last_history_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trigger_history</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">new_trigger_history</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">history_timestamp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">trigger_history</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">history_timestamp</span> <span class="o">!=</span> <span class="n">last_history_key</span><span class="p">:</span>
                    <span class="n">new_trigger_history</span><span class="p">[</span><span class="n">history_timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">trigger_history</span><span class="p">[</span><span class="n">history_timestamp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_trigger_history</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;mirage.trigger_history&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_trigger_history</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed last event for </span><span class="si">%s</span><span class="s1"> from mirage.trigger_history&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to set key in mirage.trigger_history Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="c1"># @modified 20200909 - Task #3730: Validate Mirage running multiple processes</span>
    <span class="c1"># def spin_process(self, i, run_timestamp):</span>
<div class="viewcode-block" id="MirageLabelledMetrics.spin_process"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_labelled_metrics.MirageLabelledMetrics.spin_process">[docs]</a>    <span class="k">def</span> <span class="nf">spin_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">run_timestamp</span><span class="p">,</span> <span class="n">assigned_checks</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign a metrics for a process to analyze.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">assigned_checks</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: no checks to assign to process, nothing to do&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">process_start_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

        <span class="c1"># Make process-specific dicts</span>
        <span class="n">exceptions</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">anomaly_breakdown</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># TODO - testing</span>
        <span class="n">redis_metrics_processed_key</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.</span><span class="si">%s</span><span class="s1">.metrics_processed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">redis_metrics_processed_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                <span class="n">last_redis_metrics_processed_key</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.</span><span class="si">%s</span><span class="s1">.metrics_processed.last&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">redis_metrics_processed_key</span><span class="p">,</span> <span class="n">last_redis_metrics_processed_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to rename </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">redis_metrics_processed_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
        <span class="n">feedback_labelled_metric_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">feedback_labelled_metric_ids_skipped</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">analyzer_labelled_metrics_busy</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_FEEDBACK_NAMESPACES</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">analyzer_labelled_metrics_busy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.busy&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to get analyzer_labelled_metrics.busy Redis key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>

        <span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
        <span class="n">mute_alerts_on</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analyzer_labelled_metrics_busy</span><span class="p">:</span>
            <span class="n">mute_alerts_on_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mute_alerts_on_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.mute_alerts_on&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to hgetall metrics_manager.mute_alerts_on - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
            <span class="n">mute_alerts_on</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_metric</span> <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mute_alerts_on_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">i_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">mute_alerts_on</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: there are </span><span class="si">%s</span><span class="s1"> mute_alert_on labelled_metrics currently which shall be add to feedback_labelled_metric_ids if not set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mute_alerts_on</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">analyzer_labelled_metrics_busy</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: analyzer_labelled_metrics_busy found&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">feedback_labelled_metric_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.feedback.labelled_metric_ids&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: smembers failed on Redis set aet.metrics_manager.feedback.labelled_metric_ids - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>

        <span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">feedback_labelled_metric_ids</span> <span class="ow">and</span> <span class="n">mute_alerts_on</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">mute_alerts_on</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">labelled_metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">feedback_labelled_metric_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: added </span><span class="si">%s</span><span class="s1"> mute_alert_on metric ids to feedback_labelled_metric_ids if not set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mute_alerts_on</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">analyzer_labelled_metrics_busy</span><span class="p">:</span>
                <span class="n">analyzer_labelled_metrics_busy</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: analyzer_labelled_metrics_busy set to True because mute_alert_on labelled_metrics were found&#39;</span><span class="p">)</span>

        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
        <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">literal_waterfall_alert</span> <span class="ow">in</span> <span class="n">literal_analyzer_waterfall_alerts</span><span class="p">:</span>
            <span class="n">waterfall_alert</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">literal_waterfall_alert</span><span class="p">)</span>
            <span class="n">analyzer_waterfall_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)</span>

        <span class="c1"># @added 20230424 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
        <span class="c1"># Added expiry to record metrics identified as normal by anomalous_daily_peaks</span>
        <span class="n">current_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
        <span class="n">current_aligned_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">process_start_timestamp</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">normal_daily_peaks_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">key_ts</span> <span class="o">=</span> <span class="n">current_aligned_ts</span> <span class="o">-</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;mirage.normal_daily_peak_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_ts</span><span class="p">)</span>
            <span class="n">normal_daily_peaks_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">normal_daily_peak_metrics_expiry</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">normal_daily_peaks_key</span> <span class="ow">in</span> <span class="n">normal_daily_peaks_keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_key_data</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">normal_daily_peaks_key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: hgetall failed on Redis hash </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">normal_daily_peaks_key</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_key_data</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">current_now</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">current_key_data</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">])):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">normal_daily_peaks_key</span><span class="p">,</span> <span class="n">labelled_metric</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to remove </span><span class="si">%s</span><span class="s1"> from Redis hash </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">labelled_metric</span><span class="p">,</span> <span class="n">normal_daily_peaks_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">normal_daily_peak_metrics_expiry</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">current_key_data</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]))</span>

        <span class="n">checks_processed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">check_item</span> <span class="ow">in</span> <span class="n">assigned_checks</span><span class="p">:</span>
            <span class="n">check</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">check_item</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">process_start_timestamp</span> <span class="o">+</span> <span class="mi">50</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: run time limit reached - stopping&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">checks_processed</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">metric_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;graphite&#39;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">is_labelled_metric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">check_item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.mirage_check.&#39;</span><span class="p">):</span>
                <span class="n">is_labelled_metric</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">is_labelled_metric</span><span class="p">:</span>
                <span class="c1"># Create a check file for backwards compatibility</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">check</span><span class="p">,</span> <span class="n">metric_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_check_file_from_hash_key</span><span class="p">(</span><span class="n">check_item</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: create_check_file_from_hash_key failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">check_item</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: checking metric_data: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>

            <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to determine metric_id from metric_data for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">check_item</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># TODO - testing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">redis_metrics_processed_key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add metric to </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_metrics_processed_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="n">metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># settings.MIRAGE_CHECK_PATH, str(metric_var_files_sorted[0]))</span>
                <span class="n">MIRAGE_LABELLED_CHECK_PATH</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span>

            <span class="n">check_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">check_file_timestamp</span> <span class="o">=</span> <span class="n">check_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">check_file_metricname_txt</span> <span class="o">=</span> <span class="n">check_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">check_file_metricname</span> <span class="o">=</span> <span class="n">check_file_metricname_txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">check_file_metricname_dir</span> <span class="o">=</span> <span class="n">check_file_metricname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">metric_failed_check_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">failed_checks_dir</span><span class="p">,</span> <span class="n">check_file_metricname_dir</span><span class="p">,</span> <span class="n">check_file_timestamp</span><span class="p">)</span>

            <span class="c1"># Load metric variables</span>
            <span class="c1"># @modified 20160822 - Bug #1460: panorama check file fails</span>
            <span class="c1"># Changed to panorama style skyline_functions load_metric_vars</span>
            <span class="c1"># self.load_metric_vars(metric_check_file)</span>
            <span class="c1"># Load and validate metric variables</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20170127 - Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
                <span class="c1">#                      Bug #1460: panorama check file fails</span>
                <span class="c1">#                      Panorama check file fails #24</span>
                <span class="c1"># Get rid of the skyline_functions imp as imp is deprecated in py3 anyway</span>
                <span class="c1"># metric_vars = load_metric_vars(skyline_app, str(metric_check_file))</span>
                <span class="n">metric_vars_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirage_load_metric_vars</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to load metric variables from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20200106 - Branch #3262: py3</span>
            <span class="c1">#                   Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
            <span class="c1"># redis_set_to_delete = &#39;mirage.metric_variables&#39;</span>
            <span class="n">redis_metric_variables_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.</span><span class="si">%s</span><span class="s1">.metric_variables&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">redis_set_to_delete</span> <span class="o">=</span> <span class="n">redis_metric_variables_set</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">redis_set_to_delete</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: deleted Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to delete Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;metric&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metric_name&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">]</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.metric_variables.append(metric_name)</span>
                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.metric_variables&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># self.redis_conn.sadd(redis_set, data)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_metric_variables_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: debug :: added metric_name </span><span class="si">%s</span><span class="s1"> from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to read metric variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to load metric variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">metric_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metric_value&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.metric_variables.append(metric_value)</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.metric_variables&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># self.redis_conn.sadd(redis_set, data)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_metric_variables_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to read value variable from check file - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="c1"># @modified 20181119 - Bug #2708: Failing to load metric vars</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to load value variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                    <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                    <span class="k">continue</span>

            <span class="n">hours_to_resolve</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;hours_to_resolve&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">hours_to_resolve</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">hours_to_resolve_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">,</span> <span class="n">hours_to_resolve</span><span class="p">]</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.metric_variables.append(hours_to_resolve_list)</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.metric_variables&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hours_to_resolve_list</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># self.redis_conn.sadd(redis_set, data)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_metric_variables_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to read hours_to_resolve variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hours_to_resolve</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to load hours_to_resolve variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;metric_timestamp&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">metric_timestamp_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metric_timestamp&#39;</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">]</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.metric_variables.append(metric_timestamp_list)</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.metric_variables&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp_list</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># self.redis_conn.sadd(redis_set, data)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_metric_variables_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to read metric_timestamp variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to load metric_timestamp variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
            <span class="c1">#                   Task #3744: POC matrixprofile</span>
            <span class="n">snab_only_check</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;snab_only_check&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">snab_only_check</span> <span class="o">=</span> <span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">snab_only_check</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">snab_only_check_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snab_only_check&#39;</span><span class="p">,</span> <span class="n">snab_only_check</span><span class="p">]</span>
            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.metric_variables&#39;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_only_check_list</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_metric_variables_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

            <span class="c1"># @added 20210304 - Feature #3642: Anomaly type classification</span>
            <span class="c1">#                   Feature #3970: custom_algorithm - adtk_level_shift</span>
            <span class="c1"># Added triggered_algorithms to mirage_check_file</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;triggered_algorithms&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>

            <span class="c1"># Ignore any metric check with a timestamp greater than MIRAGE_STALE_SECONDS</span>
            <span class="n">int_metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span>
            <span class="n">int_run_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">run_timestamp</span><span class="p">)</span>
            <span class="n">metric_timestamp_age</span> <span class="o">=</span> <span class="n">int_run_timestamp</span> <span class="o">-</span> <span class="n">int_metric_timestamp</span>

            <span class="k">if</span> <span class="n">metric_timestamp_age</span> <span class="o">&gt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_STALE_SECONDS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: stale check :: </span><span class="si">%s</span><span class="s1"> check request is </span><span class="si">%s</span><span class="s1"> seconds old - discarding&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp_age</span><span class="p">)))</span>
                <span class="c1"># Remove metric check file</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: could not remove check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>

                <span class="c1"># Remove the metric directory</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rmtree</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed data dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to rmtree - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>

                <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.stale_check_discarded&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>
                <span class="k">continue</span>

            <span class="c1"># Calculate hours second order resolution to seconds</span>
            <span class="n">second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hours_to_resolve</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>
            <span class="n">int_second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">))</span>
            <span class="n">second_resolution_timestamp</span> <span class="o">=</span> <span class="n">int_metric_timestamp</span> <span class="o">-</span> <span class="n">int_second_order_resolution_seconds</span>

            <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">labelled_metric_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

            <span class="n">trigger_anomaly</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">test_alert_and_trigger</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">test_alert</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;test_alert&#39;</span> <span class="ow">in</span> <span class="n">metric_data</span><span class="p">:</span>
                <span class="n">test_alert</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;test_alert&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;trigger_anomaly&#39;</span> <span class="ow">in</span> <span class="n">metric_data</span><span class="p">:</span>
                <span class="n">trigger_anomaly</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;trigger_anomaly&#39;</span><span class="p">]</span>
                <span class="n">test_alert_and_trigger</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">test_alert</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test_alert found for </span><span class="si">%s</span><span class="s1"> set trigger_anomaly: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trigger_anomaly</span><span class="p">)))</span>
                <span class="n">alert_tested_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.test_alerts.done.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">alert_tested_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test_alert created Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">alert_tested_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to create Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">alert_tested_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># Remove any old json file related to the metric</span>
            <span class="n">metric_json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
            <span class="n">feedback_metric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">feedback_key</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.feedback.expiry.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">analyzer_labelled_metrics_busy</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">feedback_labelled_metric_ids</span><span class="p">:</span>
                    <span class="n">feedback_metric</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">feedback_metric_expiry</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">feedback_metric</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">feedback_metric_expiry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feedback_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to get Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">feedback_key</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">feedback_metric_expiry</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">feedback_metric_expiry</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: feedback metric expiry exists, removing check :: </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                <span class="c1"># Remove metric check file</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: could not remove check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="c1"># Remove the metric directory</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rmtree</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed data dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to rmtree - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
                <span class="k">for</span> <span class="n">waterfall_alert</span> <span class="ow">in</span> <span class="n">analyzer_waterfall_alerts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed waterfall alert item from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">data_source</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>

            <span class="c1"># Get data from graphite</span>
            <span class="k">if</span> <span class="n">data_source</span> <span class="o">==</span> <span class="s1">&#39;graphite&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: data_source set to graphite for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">))</span>

            <span class="c1"># Get data from victoriametrics</span>
            <span class="k">if</span> <span class="n">data_source</span> <span class="o">==</span> <span class="s1">&#39;victoriametrics&#39;</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;retrieve data :: surfacing </span><span class="si">%s</span><span class="s1"> time series from victoriametrics for </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">)))</span>

                <span class="c1"># @added 20230522 - metric_type.longterm_expire</span>
                <span class="c1"># Check that monotonicity of the metric at second_order_resolution_seconds</span>
                <span class="c1"># to determine whether it is different from the recorded longterm type</span>
                <span class="n">current_metric_type</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_metric_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to determine metric_type from skyline.labelled_metrics.id.type - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="n">test_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">update_metric_type</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">save_test_data</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">current_metric_type</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test_timeseries</span> <span class="o">=</span> <span class="n">get_victoriametrics_metric</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">second_resolution_timestamp</span><span class="p">,</span>
                            <span class="n">metric_timestamp</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="n">metric_data</span><span class="o">=</span><span class="p">{},</span>
                            <span class="n">plot_parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">do_not_type</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: get_victoriametrics_metric failed getting test_timeseries for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">test_timeseries</span><span class="p">:</span>
                    <span class="n">is_strictly_increasing_monotonic</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_strictly_increasing_monotonic</span> <span class="o">=</span> <span class="n">strictly_increasing_monotonicity</span><span class="p">(</span><span class="n">test_timeseries</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: get_victoriametrics_metric failed getting test_timeseries for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">determined_metric_type</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">is_strictly_increasing_monotonic</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">is_strictly_increasing_monotonic</span><span class="p">:</span>
                            <span class="n">determined_metric_type</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">determined_metric_type</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">determined_metric_type</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">current_metric_type</span> <span class="o">!=</span> <span class="n">determined_metric_type</span><span class="p">:</span>
                            <span class="n">update_metric_type</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">determined_metric_type</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                                <span class="n">save_test_data</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">update_metric_type</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: detected change in metric_type updating from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">current_metric_type</span><span class="p">,</span> <span class="n">determined_metric_type</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="n">determined_metric_type</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to determine update skyline.labelled_metrics.id.type with metric_type - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="c1"># Set a new expire in the longterm_expire hash to have metrics_manager</span>
                    <span class="c1"># recheck the metric at 30 days.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_expire</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3600</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type.longterm_expire&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_expire</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to update skyline.labelled_metrics.id.type.longterm_expire with new expire value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">save_test_data</span><span class="p">:</span>
                    <span class="n">output_object_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">metric_json_file_saved</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_object_path</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">output_object_path</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s1">&#39;output_object_path - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_object_path</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="s1">&#39;error :: failed to create output_object_path - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">output_object_path</span><span class="p">,),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_json_file_saved</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">test_timeseries</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">metric_json_file_saved</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o644</span><span class="p">)</span>

                <span class="c1"># @modified 20230522 - metric_type.longterm_expire</span>
                <span class="c1"># Only surface if the test data was not saved</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">save_test_data</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># get_victoriametrics_metric automatically applies the rate and</span>
                        <span class="c1"># step required no downsampling or nonNegativeDerivative is</span>
                        <span class="c1"># required.</span>
                        <span class="n">metric_json_file_saved</span> <span class="o">=</span> <span class="n">get_victoriametrics_metric</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">second_resolution_timestamp</span><span class="p">,</span>
                            <span class="n">metric_timestamp</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">metric_json_file</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metric_json_file_saved</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: </span><span class="si">%s</span><span class="s1"> time series data saved to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_json_file_saved</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: get_victoriametrics_metric failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># Check there is a json timeseries file to test</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: retrieve failed - failed to surface </span><span class="si">%s</span><span class="s1"> time series from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">metric</span><span class="p">,</span> <span class="n">data_source</span><span class="p">))</span>

                <span class="c1"># @added 20200905 - Feature #3734: waterfall alerts</span>
                <span class="c1"># Try a metric 3 times before removing the check file</span>
                <span class="n">remove_check_file</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">check_failed_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.check.data_retrieval_failed.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fail_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">check_failed_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fail_count</span><span class="p">:</span>
                    <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">fail_count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">remove_check_file</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">check_failed_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="n">fail_count</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: updated fail_count to </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fail_count</span><span class="p">),</span> <span class="n">check_failed_key</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to set Redis key </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">check_failed_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fail_count</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: fail_count is </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">, removing check file&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fail_count</span><span class="p">),</span> <span class="n">check_failed_key</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">remove_check_file</span><span class="p">:</span>
                    <span class="c1"># Remove metric check file</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Remove the metric directory</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rmtree</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed data dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to rmtree </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: retrieved data :: for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">)))</span>

            <span class="c1"># Make process-specific dicts</span>
            <span class="c1"># exceptions = defaultdict(int)</span>
            <span class="c1"># anomaly_breakdown = defaultdict(int)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">check_if_parent_is_alive</span><span class="p">()</span>

            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">((</span><span class="n">metric_json_file</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: data points surfaced :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">))))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to create timeseries from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_json_file</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># @added 20170212 - Feature #1886: Ionosphere learn</span>
            <span class="c1"># Only process if the metric has sufficient data</span>
            <span class="n">first_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">first_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: could not determine first timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">timestamp_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="n">valid_if_before_timestamp</span> <span class="o">=</span> <span class="n">timestamp_now</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">)</span>
            <span class="n">valid_mirage_timeseries</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">first_timestamp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">first_timestamp</span> <span class="o">&gt;</span> <span class="n">valid_if_before_timestamp</span><span class="p">:</span>
                    <span class="n">valid_mirage_timeseries</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">valid_mirage_timeseries</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: no first_timestamp, valid_mirage_timeseries: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">valid_mirage_timeseries</span><span class="p">))</span>

            <span class="n">valid_mirage_timeseries</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">is_labelled_metric</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>
                <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>

            <span class="c1"># @added 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
            <span class="c1"># Determine if any metrcs have negatives values some they can be</span>
            <span class="c1"># added to the ionosphere.untrainable_metrics Redis set</span>
            <span class="n">run_negatives_present</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20200607 - Feature #3566: custom_algorithms</span>
            <span class="n">algorithms_run</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_ALGORITHMS</span><span class="p">)</span>

            <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
            <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20201001 - Branch #3068: SNAB</span>
            <span class="c1">#                   Task #3748: POC SNAB</span>
            <span class="c1"># Add timings</span>
            <span class="n">analysis_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">valid_mirage_timeseries</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: analyzing :: </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">))</span>
                    <span class="c1"># @modified 20230118 - Task #4786: Switch from matrixprofile to stumpy</span>
                    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                    <span class="c1"># Added current_func</span>
                    <span class="n">anomalous</span><span class="p">,</span> <span class="n">ensemble</span><span class="p">,</span> <span class="n">datapoint</span><span class="p">,</span> <span class="n">negatives_found</span><span class="p">,</span> <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">run_selected_algorithm</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">run_negatives_present</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">current_func</span><span class="o">=</span><span class="s1">&#39;mirage_labelled_metrics&#39;</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: analysed :: </span><span class="si">%s</span><span class="s1"> - anomalous: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalous</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: not analyzing :: </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> seconds as there is not sufficiently older datapoints in the timeseries - not valid_mirage_timeseries&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">))</span>
                    <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">timeseries</span><span class="p">:</span>
                        <span class="n">datapoint</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">datapoint</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                    <span class="c1"># Allow to test on sparse metrics</span>
                    <span class="k">if</span> <span class="n">test_alert</span> <span class="ow">or</span> <span class="n">test_alert_and_trigger</span><span class="p">:</span>
                        <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: test_alert - setting anomalous to True for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                        <span class="n">ensemble</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;testing&#39;</span><span class="p">]</span>
                        <span class="n">algorithms_run</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;histogram_bins&#39;</span><span class="p">]</span>
                        <span class="n">negatives_found</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># It could have been deleted by the Roomba</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># @added 20200430 - Feature #3480: batch_processing</span>
                <span class="c1"># Added logging here as the DeletedByRoomba exception is</span>
                <span class="c1"># generally not related to that but related to some other fail</span>
                <span class="c1"># in the processing of the run algorithms phase.</span>
                <span class="c1"># It could have been deleted by the Roomba, but Mirage does not use</span>
                <span class="c1"># Redis data so probably, definitely was not :)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: added as DeletedByRoomba but possibly not see traceback above&#39;</span><span class="p">)</span>

                <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;DeletedByRoomba&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: exceptions        :: DeletedByRoomba&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">TooShort</span><span class="p">:</span>
                <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;TooShort&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: exceptions        :: TooShort&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Stale</span><span class="p">:</span>
                <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Stale&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: exceptions        :: Stale&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Boring</span><span class="p">:</span>
                <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Boring&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: exceptions        :: Boring&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Other&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: exceptions        :: Other&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: unhandled error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>


            <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
            <span class="k">if</span> <span class="n">feedback_metric</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">feedback_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: setex failed on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">feedback_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20220420 - Feature #4530: namespace.analysed_events</span>
            <span class="n">parent_namespace</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">is_labelled_metric</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parent_namespace</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric_dict&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;_tenant_id&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to determine parent_namespace from metric_data: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

            <span class="n">date_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">gmtime</span><span class="p">()))</span>
            <span class="n">namespace_analysed_events_hash</span> <span class="o">=</span> <span class="s1">&#39;namespace.analysed_events.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">date_string</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hincrby</span><span class="p">(</span><span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">parent_namespace</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to increment </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">15</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: updated </span><span class="si">%s</span><span class="s1"> Redis hash&#39;</span> <span class="o">%</span> <span class="n">namespace_analysed_events_hash</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to set expire </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20201001 - Branch #3068: SNAB</span>
            <span class="c1">#                   Task #3748: POC SNAB</span>
            <span class="c1"># Add timings</span>
            <span class="n">analysis_run_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">analysis_start_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: algorithms analysis completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">analysis_run_time</span><span class="p">))</span>

            <span class="c1"># @added 20210309 - Task #3730: Validate Mirage running multiple processes</span>
            <span class="c1"># Reimplement mirage.checks.done count</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.checks.done&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to increment mirage_labelled_metrics.checks.done Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

            <span class="c1"># @modified 20200728 - Bug #3652: Handle multiple metrics in base_name conversion</span>
            <span class="c1"># base_name = metric.replace(settings.FULL_NAMESPACE, &#39;&#39;, 1)</span>
            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span>

            <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
            <span class="c1"># Remove the metric from the waterfall_alerts Redis set</span>
            <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp]</span>
            <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp. waterfall_panorama_data]</span>
            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
            <span class="n">get_waterfall_alerts_once</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">get_waterfall_alerts_once</span><span class="p">:</span>
                <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">literal_analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">analyzer_waterfall_alerts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">literal_waterfall_alert</span> <span class="ow">in</span> <span class="n">literal_analyzer_waterfall_alerts</span><span class="p">:</span>
                    <span class="n">waterfall_alert</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">literal_waterfall_alert</span><span class="p">)</span>
                    <span class="n">analyzer_waterfall_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">test_alert</span> <span class="ow">or</span> <span class="n">test_alert_and_trigger</span><span class="p">:</span>
                <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: test_alert - setting anomalous to True for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">ensemble</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>
                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;testing&#39;</span><span class="p">]</span>
                <span class="n">algorithms_run</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;histogram_bins&#39;</span><span class="p">]</span>
                <span class="n">negatives_found</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20230419 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
            <span class="n">irregular_unstable_timeseries</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">anomalous</span><span class="p">:</span>
                <span class="n">low_variance</span> <span class="o">=</span> <span class="mf">0.009</span>
                <span class="n">normalized_var</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">start_normalized_var</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">normalized_var</span> <span class="o">=</span> <span class="n">normalized_variance</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: normalized_variance failed on timeseries for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">normalized_var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">normalized_var</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: normalized_variance reported an error with timeseries for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">normalized_var</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">normalized_var</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">normalized_var</span> <span class="o">&lt;=</span> <span class="n">low_variance</span><span class="p">:</span>
                        <span class="n">irregular_unstable_timeseries</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: normalized_variance ran with result: </span><span class="si">%s</span><span class="s1"> (took </span><span class="si">%.6f</span><span class="s1"> seconds), for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">normalized_var</span><span class="p">),</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_normalized_var</span><span class="p">),</span> <span class="n">metric</span><span class="p">))</span>

            <span class="c1"># @added 20230515 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
            <span class="k">if</span> <span class="n">anomalous</span> <span class="ow">and</span> <span class="n">irregular_unstable_timeseries</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: checking irregular_unstable </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">start_irregular_unstable</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;irregular_unstable&#39;</span>
                    <span class="n">custom_algorithms_to_run</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">custom_algorithms_to_run</span><span class="p">[</span><span class="n">custom_algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;namespaces&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;labelled_metrics&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;algorithm_source&#39;</span><span class="p">:</span> <span class="s1">&#39;/opt/skyline/github/skyline/skyline/custom_algorithms/irregular_unstable.py&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;low_variance&#39;</span><span class="p">:</span> <span class="mf">0.009</span><span class="p">,</span> <span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">:</span> <span class="n">labelled_metric_name</span><span class="p">,</span>
                            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">labelled_metric_base_name</span><span class="p">,</span>
                            <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="s1">&#39;max_execution_time&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                        <span class="s1">&#39;consensus&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s1">&#39;algorithms_allowed_in_consensus&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;irregular_unstable&#39;</span><span class="p">],</span>
                        <span class="c1"># &#39;debug_logging&#39;: False,</span>
                        <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;run_3sigma_algorithms&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;run_before_3sigma&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;run_only_if_consensus&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;trigger_history_override&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;use_with&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mirage&#39;</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="c1"># use_debug_logging_here = False</span>
                    <span class="n">use_debug_logging_here</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">result</span><span class="p">,</span> <span class="n">anomalyScore</span> <span class="o">=</span> <span class="n">run_custom_algorithm_on_timeseries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="s1">&#39;irregular_unstable&#39;</span><span class="p">,</span> <span class="n">custom_algorithms_to_run</span><span class="p">[</span><span class="n">custom_algorithm</span><span class="p">],</span> <span class="n">use_debug_logging_here</span><span class="p">,</span> <span class="n">current_func</span><span class="o">=</span><span class="s1">&#39;mirage_labelled_metrics&#39;</span><span class="p">)</span>
                    <span class="n">algorithms_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">custom_algorithm</span><span class="p">)</span>
                    <span class="n">ensemble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">DEBUG_CUSTOM_ALGORITHMS</span> <span class="ow">or</span> <span class="n">use_debug_logging_here</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: mirage_labelled_metrics :: run_custom_algorithm_on_timeseries run irregular_unstable with result - </span><span class="si">%s</span><span class="s1">, anomalyScore - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalyScore</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: run_custom_algorithm_on_timeseries irregular_unstable failed on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: irregular_unstable ran with result: </span><span class="si">%s</span><span class="s1"> (took </span><span class="si">%.6f</span><span class="s1"> seconds), for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_irregular_unstable</span><span class="p">),</span> <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="n">labelled_metric_base_name</span><span class="p">))</span>
                <span class="c1"># Although fine in a notebook does not have the desired effect</span>
                <span class="c1"># in the runtime so convert to a str and check</span>
                <span class="c1"># if result is False:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: irregular_unstable is overrriding anomalous result for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">labelled_metric_name</span><span class="p">))</span>
                    <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># Clear last item from the trigger history as anomalous_daily_peak</span>
                    <span class="c1"># is a 3sigma method after all</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cleared_trigger_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_trigger_history</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: clear_trigger_history failed on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20221105 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
            <span class="c1"># Determine if an anomaly is a normal peak value of normal magnitude</span>
            <span class="c1"># that occurs daily in a 7 day period</span>
            <span class="k">if</span> <span class="n">anomalous</span> <span class="ow">and</span> <span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: checking anomalous_daily_peak </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">start_anomalous_daily_peak</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;anomalous_daily_peak&#39;</span>
                    <span class="n">custom_algorithms_to_run</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">custom_algorithms_to_run</span><span class="p">[</span><span class="n">custom_algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;namespaces&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;labelled_metrics&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;algorithm_source&#39;</span><span class="p">:</span> <span class="s1">&#39;/opt/skyline/github/skyline/skyline/custom_algorithms/anomalous_daily_peak.py&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;number_of_daily_peaks&#39;</span><span class="p">:</span> <span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span><span class="p">,</span>
                            <span class="s1">&#39;within_percent_of_normal_peaks&#39;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>
                            <span class="c1"># @added 20230424 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
                            <span class="c1"># Added expiry to record metrics identified as normal by anomalous_daily_peaks</span>
                            <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="n">anomalous_daily_peak_expiry</span><span class="p">,</span>
                            <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="s1">&#39;max_execution_time&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                        <span class="s1">&#39;consensus&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s1">&#39;algorithms_allowed_in_consensus&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;anomalous_daily_peak&#39;</span><span class="p">],</span>
                        <span class="c1"># &#39;debug_logging&#39;: False,</span>
                        <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;run_3sigma_algorithms&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;run_before_3sigma&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;run_only_if_consensus&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;trigger_history_override&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;use_with&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mirage&#39;</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="c1"># use_debug_logging_here = False</span>
                    <span class="n">use_debug_logging_here</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># @modified 20230118 - Task #4786: Switch from matrixprofile to stumpy</span>
                    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                    <span class="c1"># Added current_func</span>
                    <span class="n">result</span><span class="p">,</span> <span class="n">anomalyScore</span> <span class="o">=</span> <span class="n">run_custom_algorithm_on_timeseries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="s1">&#39;anomalous_daily_peak&#39;</span><span class="p">,</span> <span class="n">custom_algorithms_to_run</span><span class="p">[</span><span class="n">custom_algorithm</span><span class="p">],</span> <span class="n">use_debug_logging_here</span><span class="p">,</span> <span class="n">current_func</span><span class="o">=</span><span class="s1">&#39;mirage_labelled_metrics&#39;</span><span class="p">)</span>
                    <span class="n">algorithms_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">custom_algorithm</span><span class="p">)</span>
                    <span class="n">ensemble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">DEBUG_CUSTOM_ALGORITHMS</span> <span class="ow">or</span> <span class="n">use_debug_logging_here</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: mirage_labelled_metrics :: run_custom_algorithm_on_timeseries run anomalous_daily_peak with result - </span><span class="si">%s</span><span class="s1">, anomalyScore - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalyScore</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: run_custom_algorithm_on_timeseries anomalous_daily_peak failed on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: anomalous_daily_peak ran with result: </span><span class="si">%s</span><span class="s1"> (took </span><span class="si">%.6f</span><span class="s1"> seconds), for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_anomalous_daily_peak</span><span class="p">),</span> <span class="n">metric</span><span class="p">))</span>
                <span class="c1"># Although fine in a notebook does not have the desired effect</span>
                <span class="c1"># in the runtime so convert to a str and check</span>
                <span class="c1"># if result is False:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: anomalous_daily_peak is overrriding anomalous result for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">metric</span><span class="p">))</span>
                    <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># Clear last item from the trigger history as anomalous_daily_peak</span>
                    <span class="c1"># is a 3sigma method after all</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cleared_trigger_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_trigger_history</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: clear_trigger_history failed on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

                    <span class="c1"># @added 20230424 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
                    <span class="c1"># Added expiry to record metrics identified as normal by anomalous_daily_peaks</span>
                    <span class="n">current_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">current_aligned_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">process_start_timestamp</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                    <span class="n">expire_at</span> <span class="o">=</span> <span class="n">current_now</span> <span class="o">+</span> <span class="n">anomalous_daily_peak_expiry</span>
                    <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;mirage.normal_daily_peak_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="n">redis_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">expire_at</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalous_daily_peak_expiry</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis hash </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">redis_metric_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20220504 - Feature #2580: illuminance</span>
            <span class="c1"># @modified 20230419 - Feature #2580: illuminance</span>
            <span class="c1"># Moved out of the if anomalous block.  Record illuminance for all</span>
            <span class="c1"># Get the anomaly breakdown - who returned True?</span>
            <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">boolean_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ensemble</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">boolean_value</span><span class="p">:</span>
                    <span class="c1"># @modified 20200607 - Feature #3566: custom_algorithms</span>
                    <span class="c1"># algorithm = settings.MIRAGE_ALGORITHMS[index]</span>
                    <span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithms_run</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">triggered_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">test_alert</span><span class="p">:</span>
                <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;testing&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">triggered_algorithms</span><span class="p">:</span>
                <span class="n">illuminance_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">use_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_labelled_metric</span><span class="p">:</span>
                    <span class="n">use_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                <span class="n">illuminance_dict</span><span class="p">[</span><span class="n">use_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span>
                    <span class="s1">&#39;triggered_algorithms_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: calling add_illuminance_entries with </span><span class="si">%s</span><span class="s1"> entries to add&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">illuminance_dict</span><span class="p">))))</span>
                <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="n">add_illuminance_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">run_timestamp</span><span class="p">),</span> <span class="n">illuminance_dict</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: add_illuminance_entries failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: illuminance Redis hash now has </span><span class="si">%s</span><span class="s1"> entries&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_illuminance_dict</span><span class="p">))))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">anomalous</span><span class="p">:</span>

                <span class="n">not_anomalous_metric</span> <span class="o">=</span> <span class="p">[</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">base_name</span><span class="p">]</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.not_anomalous_metrics.append(not_anomalous_metric)</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.not_anomalous_metrics&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">not_anomalous_metric</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
                <span class="c1"># Remove the metric from the waterfall_alerts Redis set</span>
                <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp]</span>
                <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp, waterfall_panorama_data]</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
                <span class="k">for</span> <span class="n">waterfall_alert</span> <span class="ow">in</span> <span class="n">analyzer_waterfall_alerts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed waterfall alert item from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                        <span class="c1"># @added 20201128 - Feature #3734: waterfall alerts</span>
                        <span class="c1"># If the check just done is new than an existing analyzer</span>
                        <span class="c1"># waterfall alert metric timestamp remove those keys as well</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed waterfall alert item with older timestamp from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>

                <span class="c1"># @added 20210330 - Feature #3994: Panorama - mirage not anomalous</span>
                <span class="c1"># A hash is added to the mirage.panorama.not_anomalous_metrics for</span>
                <span class="c1"># every metric that is found to be not anomalous.  This provides</span>
                <span class="c1"># data for /panorama?not_anomalous and /panorama?not_anomalous_metric</span>
                <span class="c1"># method which are used for plots in the webapp and json response.</span>
                <span class="c1"># The mirage.panorama.not_anomalous_metrics Redis hash is managed in</span>
                <span class="c1"># analyzer/metrics_manager</span>
                <span class="n">not_anomalous_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">not_anomalous_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">not_anomalous_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span>
                <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.panorama.not_anomalous_metrics&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">base_name</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">not_anomalous_timestamp</span><span class="p">,</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">datapoint</span><span class="p">,</span>
                            <span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">hours_to_resolve</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="n">time</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis hash </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">)))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: not anomalous :: </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> (at full duration), </span><span class="si">%s</span><span class="s1"> (at SECOND_ORDER_RESOLUTION_HOURS)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">)))</span>

            <span class="c1"># If it&#39;s anomalous, add it to list</span>
            <span class="k">if</span> <span class="n">anomalous</span><span class="p">:</span>
                <span class="c1"># @modified 20200728 - Bug #3652: Handle multiple metrics in base_name conversion</span>
                <span class="c1"># base_name = metric.replace(settings.FULL_NAMESPACE, &#39;&#39;, 1)</span>
                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span>
                <span class="c1"># metric_timestamp = int(timeseries[-1][0])</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">int_metric_timestamp</span>

                <span class="c1"># Get the anomaly breakdown - who returned True?</span>
                <span class="c1"># @modified 20230419 - Feature #2580: illuminance</span>
                <span class="c1"># Moved out of the if anomalous block.  Determine</span>
                <span class="c1"># triggered_algorithms for all to record illuminance</span>
                <span class="c1"># triggered_algorithms = []</span>
                <span class="c1"># for index, boolean_value in enumerate(ensemble):</span>
                <span class="c1">#     if boolean_value:</span>
                <span class="c1">#         # @modified 20200607 - Feature #3566: custom_algorithms</span>
                <span class="c1">#         # algorithm = settings.MIRAGE_ALGORITHMS[index]</span>
                <span class="c1">#         algorithm = algorithms_run[index]</span>
                <span class="c1">#         anomaly_breakdown[algorithm] += 1</span>
                <span class="c1">#         triggered_algorithms.append(algorithm)</span>
                <span class="c1"># if test_alert:</span>
                <span class="c1">#     triggered_algorithms = [&#39;testing&#39;]</span>

                <span class="c1"># @modified 20201007 - Feature #3772: Add the anomaly_id to the http_alerter json</span>
                <span class="c1">#                      Branch #3068: SNAB</span>
                <span class="c1"># Added second_order_resolution_seconds, triggered_algorithms and algorithms_run</span>
                <span class="c1"># anomalous_metric = [datapoint, base_name, metric_timestamp]</span>
                <span class="c1"># @modified 20230419 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
                <span class="c1"># Added snab_algorithms_to_run</span>
                <span class="n">snab_algorithms_to_run</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">SNAB_ENABLED</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">irregular_unstable_timeseries</span><span class="p">:</span>
                        <span class="n">snab_algorithms_to_run</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;irregular_unstable&#39;</span><span class="p">]</span>

                <span class="n">anomalous_metric</span> <span class="o">=</span> <span class="p">[</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">algorithms_run</span><span class="p">,</span> <span class="n">snab_algorithms_to_run</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># self.anomalous_metrics.append(anomalous_metric)</span>
                <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.anomalous_metrics&#39;</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalous_metric</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: add </span><span class="si">%s</span><span class="s1"> to mirage.anomalous_metrics Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to mirage.anomalous_metrics Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.anomalous_metrics&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalous_metric</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to mirage.anomalous_metrics Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>

                <span class="c1"># @added 20220504 - Feature #2580: illuminance</span>
                <span class="c1"># @modified 20230419 - Feature #2580: illuminance</span>
                <span class="c1"># Moved out of the if anomalous block to above.  Determine</span>
                <span class="c1"># triggered_algorithms and record illuminance for all that</span>
                <span class="c1"># triggered</span>
                <span class="c1"># illuminance_dict = {}</span>
                <span class="c1"># use_key = str(base_name)</span>
                <span class="c1"># if is_labelled_metric:</span>
                <span class="c1">#     use_key = str(metric_id)</span>
                <span class="c1"># illuminance_dict[use_key] = {</span>
                <span class="c1">#     &#39;timestamp&#39;: int(metric_timestamp),</span>
                <span class="c1">#     &#39;value&#39;: float(datapoint),</span>
                <span class="c1">#     &#39;triggered_algorithms_count&#39;: len(triggered_algorithms)}</span>
                <span class="c1"># logger.info(&#39;mirage_labelled_metrics :: calling add_illuminance_entries with %s entries to add&#39; % (</span>
                <span class="c1">#     str(len(illuminance_dict))))</span>
                <span class="c1"># current_illuminance_dict = {}</span>
                <span class="c1"># try:</span>
                <span class="c1">#     current_illuminance_dict = add_illuminance_entries(self, skyline_app, int(run_timestamp), illuminance_dict)</span>
                <span class="c1"># except Exception as err:</span>
                <span class="c1">#     logger.error(&#39;error :: mirage_labelled_metrics :: add_illuminance_entries failed - %s&#39; % (</span>
                <span class="c1">#         err))</span>
                <span class="c1"># logger.info(&#39;mirage_labelled_metrics :: illuminance Redis hash now has %s entries&#39; % (</span>
                <span class="c1">#     str(len(current_illuminance_dict))))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: anomaly detected :: </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> (at SECOND_ORDER_RESOLUTION_HOURS), </span><span class="si">%s</span><span class="s1"> (at FULL_DURATION)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="c1"># It runs so fast, this allows us to process 30 anomalies/min</span>
                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># Removed limit</span>
                <span class="c1"># sleep(2)</span>

                <span class="c1"># @added 20170206 - Bug #1904: Handle non filesystem friendly metric names in check files</span>
                <span class="n">sane_metricname</span> <span class="o">=</span> <span class="n">filesafe_metricname</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>

                <span class="c1"># @added 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
                <span class="c1"># Determine if any metrcs have negatives values some they can be</span>
                <span class="c1"># added to the ionosphere.untrainable_metrics Redis set</span>
                <span class="k">if</span> <span class="n">run_negatives_present</span> <span class="ow">and</span> <span class="n">negatives_found</span><span class="p">:</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.untrainable_metrics&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">last_negative_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">negatives_found</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">last_negative_value</span> <span class="o">=</span> <span class="n">negatives_found</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">remove_after_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_negative_timestamp</span> <span class="o">+</span> <span class="n">second_order_resolution_seconds</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">([</span><span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">datapoint</span><span class="p">,</span> <span class="n">last_negative_timestamp</span><span class="p">,</span> <span class="n">last_negative_value</span><span class="p">,</span> <span class="n">second_order_resolution_seconds</span><span class="p">,</span> <span class="n">remove_after_timestamp</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                <span class="c1"># If Crucible or Panorama are enabled determine details</span>
                <span class="n">determine_anomaly_details</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_CRUCIBLE</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CRUCIBLE_ENABLED</span><span class="p">:</span>
                    <span class="n">determine_anomaly_details</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">:</span>
                    <span class="n">determine_anomaly_details</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># If Ionosphere is enabled determine details</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ionosphere_enabled</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_ENABLED</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_ENABLED</span><span class="p">:</span>
                        <span class="n">determine_anomaly_details</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">ionosphere_enabled</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">determine_anomaly_details</span><span class="p">:</span>
                    <span class="c1"># metric_timestamp = str(int(timeseries[-1][0]))</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

                <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;mirage.last_alert.smtp.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="n">last_alert</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200805 - Task #3662: Change mirage.last_check keys to timestamp value</span>
                    <span class="c1">#                      Feature #3486: analyzer_batch</span>
                    <span class="c1">#                      Feature #3480: batch_processing</span>
                    <span class="c1"># Changed the last_alert cache key to hold the last</span>
                    <span class="c1"># anomaly timestamp</span>
                    <span class="c1"># last_alert = self.redis_conn.get(cache_key)</span>
                    <span class="n">last_alert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: could not query Redis for cache_key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

                <span class="c1"># @added 20170308 - Feature #1960: ionosphere_layers</span>
                <span class="c1"># Allow Ionosphere to send Panorama checks, it is an ionosphere_metric</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># ionosphere_unique_metrics = list(self.redis_conn.smembers(&#39;ionosphere.unique_metrics&#39;))</span>
                        <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">added_at</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                <span class="c1"># If Panorama is enabled - create a Panorama check</span>
                <span class="c1"># @modified 20170308 - Feature #1960: ionosphere_layers</span>
                <span class="c1"># Allow Ionosphere to send Panorama checks for ionosphere_metrics</span>
                <span class="c1"># if settings.PANORAMA_ENABLED:</span>
                <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>

                <span class="c1"># TODO - testing</span>
                <span class="k">if</span> <span class="n">is_labelled_metric</span><span class="p">:</span>
                    <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">:</span>
                    <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                    <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
                <span class="c1"># metric</span>
                <span class="k">if</span> <span class="n">test_alert</span> <span class="ow">or</span> <span class="n">test_alert_and_trigger</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: test_alert sending triggered anomaly on </span><span class="si">%s</span><span class="s1"> to Panorama&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">metric</span><span class="p">))</span>
                    <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Panorama must have at least one triggered algorithm</span>
                    <span class="n">original_triggered_algorithms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="n">algorithms_run</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                <span class="k">if</span> <span class="n">send_to_panorama</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">):</span>
                        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">)</span>

                    <span class="c1"># Note:</span>
                    <span class="c1"># The values are enclosed is single quoted intentionally</span>
                    <span class="c1"># as the imp.load_source used results in a shift in the</span>
                    <span class="c1"># decimal position when double quoted, e.g.</span>
                    <span class="c1"># value = &quot;5622.0&quot; gets imported as</span>
                    <span class="c1"># 2016-03-02 12:53:26 :: 28569 :: metric variable - value - 562.2</span>
                    <span class="c1"># single quoting results in the desired,</span>
                    <span class="c1"># 2016-03-02 13:16:17 :: 1515 :: metric variable - value - 5622.0</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;graphite&#39;</span>
                    <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;victoriametrics&#39;</span>
                    <span class="n">panaroma_anomaly_data</span> <span class="o">=</span> <span class="s1">&#39;metric = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;value = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;from_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;metric_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;triggered_algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;app = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;source = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;added_by = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;added_at = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span> <span class="n">from_timestamp</span><span class="p">,</span>
                           <span class="c1"># @modified 20200607 - Feature #3566: custom_algorithms</span>
                           <span class="c1"># str(int_metric_timestamp), str(settings.MIRAGE_ALGORITHMS),</span>
                           <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithms_run</span><span class="p">),</span>
                           <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span>
                           <span class="n">this_host</span><span class="p">,</span> <span class="n">added_at</span><span class="p">)</span>

                    <span class="c1"># Create an anomaly file with details about the anomaly</span>
                    <span class="n">panaroma_anomaly_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">,</span> <span class="n">added_at</span><span class="p">,</span> <span class="n">sane_metricname</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">write_data_to_file</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">panaroma_anomaly_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                            <span class="n">panaroma_anomaly_data</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: added panorama anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">panaroma_anomaly_file</span><span class="p">))</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># Move to Redis set block below</span>
                        <span class="c1"># self.sent_to_panorama.append(base_name)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add panorama anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">panaroma_anomaly_file</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                    <span class="c1"># Moved from the above self.sent_to_panorama</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.sent_to_panorama&#39;</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                    <span class="c1"># @added 20210323 - Feature #3642: Anomaly type classification</span>
                    <span class="k">if</span> <span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span><span class="p">:</span>
                        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;luminosity.classify_anomalies&#39;</span>
                        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">int_metric_timestamp</span><span class="p">,</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">datapoint</span><span class="p">,</span>
                            <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="n">algorithms_run</span><span class="p">,</span>
                            <span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">:</span> <span class="n">triggered_algorithms</span><span class="p">,</span>
                            <span class="s1">&#39;app&#39;</span><span class="p">:</span> <span class="n">skyline_app</span><span class="p">,</span>
                            <span class="s1">&#39;added_at&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">added_at</span><span class="p">),</span>
                        <span class="p">}</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span><span class="p">,</span> <span class="n">int_metric_timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">added_at</span><span class="p">),</span> <span class="n">data_dict</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                    <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                    <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
                    <span class="c1"># metric</span>
                    <span class="k">if</span> <span class="n">test_alert</span> <span class="ow">or</span> <span class="n">test_alert_and_trigger</span><span class="p">:</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_triggered_algorithms</span><span class="p">)</span>

                    <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
                    <span class="c1"># Remove the metric from the waterfall_alerts Redis set</span>
                    <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp]</span>
                    <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp, waterfall_panorama_data]</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
                    <span class="k">for</span> <span class="n">waterfall_alert</span> <span class="ow">in</span> <span class="n">analyzer_waterfall_alerts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_name</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed waterfall alert item from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>

                <span class="c1"># If crucible is enabled - save timeseries and create a</span>
                <span class="c1"># crucible check</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_CRUCIBLE</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CRUCIBLE_ENABLED</span><span class="p">:</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="n">crucible_anomaly_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CRUCIBLE_DATA_FOLDER</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">timeseries_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">metric_timestamp</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">crucible_anomaly_dir</span><span class="p">):</span>
                        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">crucible_anomaly_dir</span><span class="p">)</span>

                    <span class="c1"># Note:</span>
                    <span class="c1"># The value is enclosed is single quoted intentionally</span>
                    <span class="c1"># as the imp.load_source used in crucible results in a</span>
                    <span class="c1"># shift in the decimal position when double quoted, e.g.</span>
                    <span class="c1"># value = &quot;5622.0&quot; gets imported as</span>
                    <span class="c1"># 2016-03-02 12:53:26 :: 28569 :: metric variable - value - 562.2</span>
                    <span class="c1"># single quoting results in the desired,</span>
                    <span class="c1"># 2016-03-02 13:16:17 :: 1515 :: metric variable - value - 5622.0</span>

                    <span class="n">crucible_anomaly_data</span> <span class="o">=</span> <span class="s1">&#39;metric = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;value = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;from_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;metric_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;triggered_algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;anomaly_dir = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;graphite_metric = True</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;run_crucible_tests = False</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;added_by = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                            <span class="s1">&#39;added_at = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span> <span class="n">from_timestamp</span><span class="p">,</span>
                           <span class="c1"># @modified 20200607 - Feature #3566: custom_algorithms</span>
                           <span class="c1"># str(int_metric_timestamp), str(settings.MIRAGE_ALGORITHMS),</span>
                           <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithms_run</span><span class="p">),</span>
                           <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">crucible_anomaly_dir</span><span class="p">,</span>
                           <span class="n">skyline_app</span><span class="p">,</span> <span class="n">added_at</span><span class="p">)</span>

                    <span class="c1"># Create an anomaly file with details about the anomaly</span>
                    <span class="n">crucible_anomaly_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_anomaly_dir</span><span class="p">,</span> <span class="n">sane_metricname</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">write_data_to_file</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">crucible_anomaly_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                            <span class="n">crucible_anomaly_data</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: added crucible anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_anomaly_file</span><span class="p">))</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># self.sent_to_crucible.append(base_name)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add crucible anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_anomaly_file</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

                    <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                    <span class="c1"># Moved from the above self.sent_to_crucible</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.sent_to_crucible&#39;</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                    <span class="c1"># Create timeseries json file with the timeseries</span>
                    <span class="n">json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_anomaly_dir</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                    <span class="n">timeseries_json</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">write_data_to_file</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">timeseries_json</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: added crucible timeseries file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add crucible timeseries file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

                    <span class="c1"># Create a crucible check file</span>
                    <span class="n">crucible_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CRUCIBLE_CHECK_PATH</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">sane_metricname</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">write_data_to_file</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">crucible_check_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                            <span class="n">crucible_anomaly_data</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: added crucible check :: </span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add crucible check file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_check_file</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

                <span class="c1"># @added 20230510 - Feature #4902: Prevent training on metrics newer than 7 days</span>
                <span class="n">new_metric_added_at</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">ionosphere_enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">last_alert</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_metric_added_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;metrics_manager.untrainable_new_metrics&#39;</span><span class="p">,</span> <span class="n">labelled_metric_base_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to hget from metrics_manager.untrainable_new_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">new_metric_added_at</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_until</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">new_metric_added_at</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
                            <span class="n">new_until_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">new_until</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not sending </span><span class="si">%s</span><span class="s1"> to Ionosphere as still a new metric until </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">labelled_metric_base_name</span><span class="p">,</span> <span class="n">new_until_date</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine when </span><span class="si">%s</span><span class="s1"> matures - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">labelled_metric_base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">ionosphere_enabled</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20160922 - Branch #922: Ionosphere</span>
                <span class="c1"># Also added the send_anomalous_metric_to skyline_functions.py</span>
                <span class="c1"># function</span>
                <span class="k">if</span> <span class="n">ionosphere_enabled</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_alert</span><span class="p">:</span>
                        <span class="c1"># @modified 20161228 Feature #1830: Ionosphere alerts</span>
                        <span class="c1"># Added full_duration which needs to be recorded to allow Mirage metrics</span>
                        <span class="c1"># to be profiled on Redis timeseries data at FULL_DURATION</span>
                        <span class="c1"># e.g. mirage.redis.24h.json</span>
                        <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">)</span>
                        <span class="c1"># @modified 20170127 - Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
                        <span class="c1"># Added ionosphere_parent_id, always zero from Analyzer and Mirage</span>
                        <span class="n">ionosphere_parent_id</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">send_anomalous_metric_to</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;ionosphere&#39;</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span>
                            <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span>
                            <span class="n">full_duration</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_parent_id</span><span class="p">),</span>
                            <span class="c1"># @added 20201001 - Task #3748: POC SNAB</span>
                            <span class="c1"># Added algorithms_run required to determine the anomalyScore</span>
                            <span class="c1"># so this needs to be sent to Ionosphere so Ionosphere</span>
                            <span class="c1"># can send it back on an alert</span>
                            <span class="n">algorithms_run</span><span class="p">)</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># Moved to the mirage.sent_to_ionosphere Redis set Redis set</span>
                        <span class="c1"># block below</span>
                        <span class="c1"># self.sent_to_ionosphere.append(base_name)</span>

                        <span class="c1"># @added 20200804 - Feature #3462: Add IONOSPHERE_MANAGE_PURGE</span>
                        <span class="c1">#                   Feature #3472: ionosphere.training_data Redis set</span>
                        <span class="c1">#                   Feature #3474: webapp api - training_data</span>
                        <span class="c1"># Add training data to the ionosphere.training_data so that</span>
                        <span class="c1"># the ionosphere purge_old_data_dirs can happen less</span>
                        <span class="c1"># frequently for reduced I/O</span>
                        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.training_data&#39;</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">int_metric_timestamp</span><span class="p">),</span> <span class="n">second_order_resolution_seconds</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: adding to Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: alert expiry key exists not sending to Ionosphere :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>

                    <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
                    <span class="c1"># Remove the metric from the waterfall_alerts Redis set</span>
                    <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp]</span>
                    <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp, waterfall_panorama_data]</span>
                    <span class="c1"># Do not remove if this is only for training_data creation</span>
                    <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
                        <span class="n">mirage_waterfall_data</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">waterfall_alert</span> <span class="ow">in</span> <span class="n">analyzer_waterfall_alerts</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_name</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                                    <span class="n">mirage_waterfall_data</span> <span class="o">=</span> <span class="n">waterfall_alert</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">))</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed waterfall alert item from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_alert</span><span class="p">)))</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to remove waterfall alert item for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>

                    <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                    <span class="c1"># Moved from the above self.sent_to_ionosphere</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_alert</span><span class="p">:</span>
                        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.sent_to_ionosphere&#39;</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                        <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                        <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
                        <span class="c1"># metric</span>
                        <span class="k">if</span> <span class="n">test_alert</span> <span class="ow">or</span> <span class="n">test_alert_and_trigger</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: test_alert not sending anomaly on </span><span class="si">%s</span><span class="s1"> to ionosphere&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">metric</span><span class="p">))</span>
                            <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
                        <span class="c1"># Add mirage waterfall alert</span>
                        <span class="c1"># Only add if this is an ionosphere_enabled metric_check_file</span>
                        <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">ionosphere_unique_metrics</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">mirage_waterfall_data</span><span class="p">:</span>
                                <span class="c1"># waterfall_data = [metric[1], metric[2], metric[0], added_to_waterfall_timestamp, waterfall_panorama_data]</span>
                                <span class="n">waterfall_data</span> <span class="o">=</span> <span class="n">mirage_waterfall_data</span>
                                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.waterfall_alerts.sent_to_ionosphere&#39;</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_data</span><span class="p">))</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: added to Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_data</span><span class="p">)))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

            <span class="n">metric_var_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">):</span>
                <span class="c1"># Remove metric check file</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to remove check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>

            <span class="c1"># Remove the metric directory</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rmtree</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed data dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to rmtree </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>

        <span class="c1"># Add values to the queue so the parent process can collate</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ab_value</span> <span class="ow">in</span> <span class="n">anomaly_breakdown</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mirage_labelled_metrics_anomaly_breakdown_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">ab_value</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed iterate to self.mirage_labelled_metrics_anomaly_breakdown_q - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">e_value</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mirage_labelled_metrics_exceptions_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">e_value</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed iterate to self.mirage_labelled_metrics_exceptions_q - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MirageLabelledMetrics.run"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_labelled_metrics.MirageLabelledMetrics.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the process intializes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Log management to prevent overwriting</span>
        <span class="c1"># Allow the bin/&lt;skyline_app&gt;.d to manage the log</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logwait</span><span class="p">)</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">log_wait_for</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="k">while</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">log_wait_for</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">log_wait_for</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: starting </span><span class="si">%s</span><span class="s1"> run&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - bin/</span><span class="si">%s</span><span class="s1">.d log management seems to have failed, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: log lock file removed&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app_loglock</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: bin/</span><span class="si">%s</span><span class="s1">.d log management done&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">MIRAGE_LABELLED_CHECK_PATH</span><span class="p">):</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">MIRAGE_LABELLED_CHECK_PATH</span><span class="p">)</span>

        <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
        <span class="n">last_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

        <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
        <span class="n">filesafe_names_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">last_redis_self_key_update</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="c1"># Make sure Redis is up</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: skyline can not connect to redis at socket path </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: attempting to connect to redis at socket path </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to connect to Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: connected to redis&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to ping Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># Determine if any metric to analyze or Ionosphere alerts to be sent</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="c1"># Report app up</span>
                <span class="n">update_redis_self_key</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">last_redis_self_key_update</span><span class="p">:</span>
                    <span class="n">update_redis_self_key</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">last_redis_self_key_update</span> <span class="ow">and</span> <span class="n">now</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">last_redis_self_key_update</span> <span class="o">+</span> <span class="mi">20</span><span class="p">):</span>
                    <span class="n">update_redis_self_key</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">update_redis_self_key</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># redis_is_up = self.redis_conn.setex(skyline_app, 120, now)</span>
                        <span class="n">redis_is_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                        <span class="n">last_redis_self_key_update</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">redis_is_up</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: could not update the Redis redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">err</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to update Redis key for mirage_labelled_metrics up - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># @added 20161228 - Feature #1828: ionosphere - mirage Redis data features</span>
                <span class="c1"># If Ionosphere is going to pass alerts back to the app</span>
                <span class="c1"># here we are going to have break out and force a alerting</span>
                <span class="c1"># only run.</span>
                <span class="n">ionosphere_alerts_returned</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
                <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
                <span class="c1"># metric</span>
                <span class="n">test_alerts</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">test_alert_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">metric_var_files</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ionosphere_alerts_returned</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @modified 20190408 - Bug #2904: Initial Ionosphere echo load and Ionosphere feedback</span>
                <span class="c1">#                      Feature #2484: FULL_DURATION feature profiles</span>
                <span class="c1"># Move this len(metric_var_files) from above and apply the</span>
                <span class="c1"># appropriatte sleep</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sleep_for</span> <span class="o">=</span> <span class="mi">10</span>
                    <span class="n">next_send_to_graphite</span> <span class="o">=</span> <span class="n">last_sent_to_graphite</span> <span class="o">+</span> <span class="mi">60</span>
                    <span class="n">seconds_to_next_send_to_graphite</span> <span class="o">=</span> <span class="n">next_send_to_graphite</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">seconds_to_next_send_to_graphite</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">seconds_to_next_send_to_graphite</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">sleep_for</span> <span class="o">=</span> <span class="n">seconds_to_next_send_to_graphite</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: sleeping no metrics...&#39;</span><span class="p">)</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># sleep(10)</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="n">sleep_for</span><span class="p">)</span>

                <span class="n">batch_processing_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># Clean up old files</span>
                <span class="n">now_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="n">stale_age</span> <span class="o">=</span> <span class="n">now_timestamp</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_STALE_SECONDS</span>
                <span class="k">for</span> <span class="n">current_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">MIRAGE_LABELLED_CHECK_PATH</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">MIRAGE_LABELLED_CHECK_PATH</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">):</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">MIRAGE_LABELLED_CHECK_PATH</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">)</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">st_ctime</span>

                        <span class="c1"># @added 20220113 - Feature #3486: analyzer_batch</span>
                        <span class="c1">#                   Feature #3480: batch_processing</span>
                        <span class="c1"># Do not remove batch_processing checks</span>
                        <span class="k">for</span> <span class="n">b_metric</span> <span class="ow">in</span> <span class="n">batch_processing_metrics</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">b_metric</span> <span class="ow">in</span> <span class="n">current_file</span><span class="p">:</span>
                                <span class="k">continue</span>

                        <span class="c1"># delete file if older than a week</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">stale_age</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">MIRAGE_LABELLED_CHECK_PATH</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">current_file</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed stale check - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_file</span><span class="p">))</span>
                            <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.stale_check_discarded&#39;</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_file</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">current_file</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

                <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                <span class="c1"># Handle filesafe names</span>
                <span class="n">filesafe_names_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">filesafe_names_dict</span><span class="p">:</span>
                    <span class="n">filesafe_names_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filesafe_names_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="c1"># Discover metric to analyze</span>
                <span class="n">metric_var_files</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">labelled_metrics_to_check_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">labelled_metrics_to_check_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.mirage_check&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to cleanup mirage_algorithm.error files - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>
                <span class="k">if</span> <span class="n">labelled_metrics_to_check_dict</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">labelled_metrics_to_check_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">check_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.mirage_check.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span>
                        <span class="n">metric_var_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">check_key</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">process_metric_check_files</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">metric_var_files_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span>
            <span class="c1"># metric_check_file = settings.MIRAGE_CHECK_PATH + &quot;/&quot; + metric_var_files_sorted[0]</span>
            <span class="k">if</span> <span class="n">metric_var_files_sorted</span><span class="p">:</span>
                <span class="n">process_metric_check_files</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># @added 20221014 - Bug #4696: analyzer - anomalous metrics sets not flushing</span>
            <span class="c1">#                   Task #4614: Support labelled metrics</span>
            <span class="c1"># Set the default dicts before the if as it was not being set inside</span>
            <span class="c1"># at times causing the log entries to hang.</span>
            <span class="n">exceptions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">anomaly_breakdown</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">process_metric_check_files</span><span class="p">:</span>

                <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="n">check_files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files_sorted</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: </span><span class="si">%s</span><span class="s1"> checks to process&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">check_files_to_process</span><span class="p">))</span>

                <span class="c1"># Remove any existing algorithm.error files from any previous runs</span>
                <span class="c1"># that did not cleanup for any reason</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.*.algorithm.error&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: cleaning up old error file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>
                            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                <span class="k">pass</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to cleanup mirage_algorithm.error files - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>

                <span class="c1"># Spawn processes</span>
                <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># MIRAGE_PROCESSES = 1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_PROCESSES</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIRAGE_PROCESSES</span><span class="p">:</span>
                            <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># Was testing just 1 process</span>
                <span class="c1"># MIRAGE_PROCESSES = 1</span>
                <span class="c1"># @modified 20230120 - Task #4786: Switch from matrixprofile to stumpy</span>
                <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Removed this limitation because mirage_labelled_metrics can be</span>
                <span class="c1"># assigned 100s of checks and with the change to stumpy analysis</span>
                <span class="c1"># with skyline_matrixprofile has increased the run time.</span>
                <span class="c1"># With matrixprofile being run with skyline_matrixprofile via</span>
                <span class="c1"># run_custom_algorithm_on_timeseries was achieving around 91</span>
                <span class="c1"># checks in 41 seconds, now running skyline_matrixproile direct</span>
                <span class="c1"># with &quot;stumpy-mp.stump&quot; is taking around 65 seconds to do 88</span>
                <span class="c1"># checks.  Do not limit to 1 process unless there are under 10</span>
                <span class="c1"># checks.  The reason being that initialisation of stumpy.stump</span>
                <span class="c1"># even with jit caching takes between 1 and 3 seconds,</span>
                <span class="c1"># thereafter any further metrics analysed with stump in the run</span>
                <span class="c1"># take between 0.02 and 0.6 seconds (no init required), this is</span>
                <span class="c1"># more on the 0.6 second side when busy.  Therefore if there are</span>
                <span class="c1"># less than 6 checks (ballpark figure, depends on load) it is</span>
                <span class="c1"># more efficient and quicker to just use 1 process rather than</span>
                <span class="c1"># more.</span>
                <span class="c1"># MIRAGE_PROCESSES = 1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">run_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">MIRAGE_PROCESSES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

                    <span class="n">checks_per_processor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files_sorted</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">MIRAGE_PROCESSES</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">MIRAGE_PROCESSES</span><span class="p">:</span>
                        <span class="n">assigned_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files_sorted</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">assigned_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_var_files_sorted</span><span class="p">),</span> <span class="n">i</span> <span class="o">*</span> <span class="n">checks_per_processor</span><span class="p">)</span>
                    <span class="n">assigned_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">checks_per_processor</span>
                    <span class="n">assigned_keys</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">assigned_min</span><span class="p">,</span> <span class="n">assigned_max</span><span class="p">)</span>

                    <span class="c1"># Compile assigned metrics</span>
                    <span class="n">assigned_checks</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric_var_files_sorted</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">assigned_keys</span><span class="p">]</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: processing </span><span class="si">%s</span><span class="s1"> checks&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_checks</span><span class="p">)))</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin_process</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">run_timestamp</span><span class="p">,</span> <span class="n">assigned_checks</span><span class="p">))</span>

                    <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: starting </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> spin_process/es&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pid_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">MIRAGE_PROCESSES</span><span class="p">)))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># spawned_pids.append(p.pid)</span>
                    <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: started spin_process </span><span class="si">%s</span><span class="s1"> with pid </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pid_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)))</span>

                <span class="c1"># Self monitor processes and terminate if any spin_process has run</span>
                <span class="c1"># for longer than 180 seconds - 20160512 @earthgecko</span>
                <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAX_ANALYZER_PROCESS_RUNTIME</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                        <span class="c1"># Just to avoid hogging the CPU</span>
                        <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># All the processes are done, break now.</span>
                        <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: </span><span class="si">%s</span><span class="s1"> :: </span><span class="si">%s</span><span class="s1"> spin_process/es completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">MIRAGE_PROCESSES</span><span class="p">),</span> <span class="n">time_to_run</span><span class="p">))</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: </span><span class="si">%s</span><span class="s1"> :: timed out, killing all spin_process processes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20230410 - moved p.join before p.terminate</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                            <span class="c1"># @modified 20221125 - added join back</span>
                            <span class="c1"># p.join()</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: </span><span class="si">%s</span><span class="s1"> :: error terminating pid - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_app</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: </span><span class="si">%s</span><span class="s1"> :: stopping spin_process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())))</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: </span><span class="si">%s</span><span class="s1"> :: error joining pid - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20200607 - Feature #3508: ionosphere.untrainable_metrics</span>
                <span class="c1"># Check to non 3sigma algorithm errors too</span>
                <span class="n">check_algorithm_errors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;negatives_present&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_ALGORITHMS</span><span class="p">):</span>
                    <span class="n">check_algorithm_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
                <span class="c1"># @added 20200607 - Feature #3566: custom_algorithms</span>
                <span class="k">if</span> <span class="n">CUSTOM_ALGORITHMS</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">custom_algorithm</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">CUSTOM_ALGORITHMS</span><span class="p">:</span>
                        <span class="n">check_algorithm_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">custom_algorithm</span><span class="p">)</span>

                <span class="c1"># Grab data from the queue and populate dictionaries</span>
                <span class="n">exceptions</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">anomaly_breakdown</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirage_labelled_metrics_anomaly_breakdown_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">anomaly_breakdown</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                    <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                        <span class="c1"># @added 20191113 - Branch #3262: py3</span>
                        <span class="c1"># Log</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: anomaly_breakdown.keys are empty&#39;</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: grabbing data from the queue and populating anomaly_breakdown - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="k">break</span>

                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirage_labelled_metrics_exceptions_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">exceptions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">exceptions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                    <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                        <span class="c1"># @added 20191113 - Branch #3262: py3</span>
                        <span class="c1"># Log</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: exceptions.keys are empty&#39;</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: grabbing data from the queue and populating exceptions - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="k">break</span>

                <span class="c1"># @added 20191021 - Bug #3288: Always send anomaly_breakdown and exception metrics</span>
                <span class="c1">#                   Branch #3262: py3</span>
                <span class="n">exceptions_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Boring&#39;</span><span class="p">,</span> <span class="s1">&#39;Stale&#39;</span><span class="p">,</span> <span class="s1">&#39;TooShort&#39;</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i_exception</span> <span class="ow">in</span> <span class="n">exceptions_metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i_exception</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">exceptions</span><span class="p">[</span><span class="n">i_exception</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># @modified 20200607 - Feature #3566: custom_algorithms</span>
                <span class="c1"># for i_anomaly_breakdown in settings.MIRAGE_ALGORITHMS:</span>
                <span class="k">for</span> <span class="n">i_anomaly_breakdown</span> <span class="ow">in</span> <span class="n">check_algorithm_errors</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i_anomaly_breakdown</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">anomaly_breakdown</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">i_anomaly_breakdown</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># for completed_pid in spawned_pids:</span>
                <span class="k">for</span> <span class="n">completed_pid</span><span class="p">,</span> <span class="n">mirage_process</span> <span class="ow">in</span> <span class="n">spawned_pids</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: spin_process with pid </span><span class="si">%s</span><span class="s1"> completed&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">completed_pid</span><span class="p">)))</span>
                    <span class="c1"># @modified 20200607 - Feature #3566: custom_algorithms</span>
                    <span class="c1">#                      Feature #3508: ionosphere.untrainable_metrics</span>
                    <span class="c1"># Check to non 3sigma algorithm errors too and wrapped in try</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># for algorithm in settings.MIRAGE_ALGORITHMS:</span>
                        <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">check_algorithm_errors</span><span class="p">:</span>
                            <span class="n">algorithm_error_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.algorithm.error&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">completed_pid</span><span class="p">),</span> <span class="n">algorithm</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">algorithm_error_file</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s1">&#39;error :: spin_process with pid </span><span class="si">%s</span><span class="s1"> has reported an error with the </span><span class="si">%s</span><span class="s1"> algorithm&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">completed_pid</span><span class="p">),</span> <span class="n">algorithm</span><span class="p">))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">algorithm_error_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                        <span class="n">error_string</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to read </span><span class="si">%s</span><span class="s1"> error file&#39;</span> <span class="o">%</span> <span class="n">algorithm</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">algorithm_error_file</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to check algorithm errors&#39;</span><span class="p">)</span>

                    <span class="n">redis_metrics_processed_key</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.</span><span class="si">%s</span><span class="s1">.metrics_processed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">mirage_process</span><span class="p">)</span>
                    <span class="n">redis_metrics_processed</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_metrics_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_metrics_processed_key</span><span class="p">)</span>
                        <span class="c1"># if redis_metrics_processed:</span>
                        <span class="c1">#     self.redis_conn_decoded.delete(redis_metrics_processed_key)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: </span><span class="si">%s</span><span class="s1"> Redis hash operation failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_metrics_processed_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                    <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                    <span class="c1"># Use Redis set and not self.metric_variables</span>

                    <span class="n">metric_variables</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                    <span class="c1">#                      Branch #3262: py3</span>
                    <span class="c1"># literal_metric_variables = list(self.redis_conn.smembers(&#39;mirage.metric_variables&#39;))</span>
                    <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># Handle per process</span>
                    <span class="c1"># literal_metric_variables = list(self.redis_conn_decoded.smembers(&#39;mirage.metric_variables&#39;))</span>
                    <span class="n">metric_variable_redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.</span><span class="si">%s</span><span class="s1">.metric_variables&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">mirage_process</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">literal_metric_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">metric_variable_redis_set</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: smembers failed on Redis </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric_variable_redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">literal_metric_variables</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">item_list_string</span> <span class="ow">in</span> <span class="n">literal_metric_variables</span><span class="p">:</span>
                        <span class="n">list_item</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">item_list_string</span><span class="p">)</span>
                        <span class="n">metric_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_item</span><span class="p">)</span>

                    <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># Handle per process</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">metric_variable_redis_set</span><span class="p">)</span>
                        <span class="c1"># logger.info(&#39;mirage_labelled_metrics :: deleted Redis set - %s&#39; % metric_variable_redis_set)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to delete Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_variable_redis_set</span><span class="p">)</span>

                    <span class="c1"># @added 20191113 - Branch #3262: py3</span>
                    <span class="c1"># Set default values</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">metric_value</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">hours_to_resolve</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                    <span class="c1"># for metric_variable in self.metric_variables:</span>
                    <span class="k">for</span> <span class="n">metric_variable</span> <span class="ow">in</span> <span class="n">metric_variables</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metric_name&#39;</span><span class="p">:</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metric_value&#39;</span><span class="p">:</span>
                            <span class="n">metric_value</span> <span class="o">=</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">:</span>
                            <span class="n">hours_to_resolve</span> <span class="o">=</span> <span class="n">metric_variable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># if metric_variable[0] == &#39;metric_timestamp&#39;:</span>
                        <span class="c1">#     metric_timestamp = metric_variable[1]</span>

                    <span class="c1"># logger.info(&#39;mirage_labelled_metrics :: analysis done - %s&#39; % str(metric_name))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: process </span><span class="si">%s</span><span class="s1"> checked </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">mirage_process</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">redis_metrics_processed</span><span class="p">))))</span>

                    <span class="c1"># Send alerts</span>
                    <span class="c1"># Calculate hours second order resolution to seconds</span>
                    <span class="c1"># @modified 20191113 - Branch #3262: py3</span>
                    <span class="c1"># Only if set</span>
                    <span class="k">if</span> <span class="n">hours_to_resolve</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: analyzed at </span><span class="si">%s</span><span class="s1"> hours resolution&#39;</span> <span class="o">%</span> <span class="n">hours_to_resolve</span><span class="p">)</span>
                        <span class="n">second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hours_to_resolve</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: analyzed at </span><span class="si">%s</span><span class="s1"> seconds resolution&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">))</span>

                    <span class="c1"># Remove metric check files</span>
                    <span class="k">for</span> <span class="n">check_item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">redis_metrics_processed</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">redis_metrics_processed</span><span class="p">[</span><span class="n">check_item</span><span class="p">])</span>
                            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                            <span class="n">processing_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                            <span class="n">metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MIRAGE_LABELLED_CHECK_PATH</span><span class="p">,</span> <span class="n">processing_check_file</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to interpolate metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to remove metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>

                        <span class="c1"># Remove the metric directory</span>
                        <span class="c1"># @modified 20191113 - Branch #3262: py3</span>
                        <span class="c1"># Convert None to str</span>
                        <span class="c1"># timeseries_dir = metric_name.replace(&#39;.&#39;, &#39;/&#39;)</span>
                        <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                            <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">metric_name_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                            <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MIRAGE_LABELLED_CHECK_PATH</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to interpolate metric_data_dir&#39;</span><span class="p">)</span>
                            <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>

                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">rmtree</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: removed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to rmtree </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_data_dir</span><span class="p">)</span>

            <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="n">mirage_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># literal_mirage_anomalous_metrics = list(self.redis_conn.smembers(&#39;mirage.anomalous_metrics&#39;))</span>
                <span class="n">literal_mirage_anomalous_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.anomalous_metrics&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">metric_list_string</span> <span class="ow">in</span> <span class="n">literal_mirage_anomalous_metrics</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">metric_list_string</span><span class="p">)</span>
                    <span class="n">mirage_anomalous_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to determine list from mirage_labelled_metrics.anomalous_metrics Redis set&#39;</span><span class="p">)</span>
                <span class="n">mirage_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="n">mirage_not_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># literal_mirage_not_anomalous_metrics = list(self.redis_conn.smembers(&#39;mirage.not_anomalous_metrics&#39;))</span>
                <span class="n">literal_mirage_not_anomalous_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.not_anomalous_metrics&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">metric_list_string</span> <span class="ow">in</span> <span class="n">literal_mirage_not_anomalous_metrics</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">metric_list_string</span><span class="p">)</span>
                    <span class="n">mirage_not_anomalous_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to determine list from mirage_labelled_metrics.not_anomalous_metrics Redis set&#39;</span><span class="p">)</span>
                <span class="n">mirage_not_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Log progress</span>
            <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="c1"># if len(self.anomalous_metrics) &gt; 0:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mirage_anomalous_metrics</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: seconds since last anomaly :: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">))</span>
                <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                <span class="c1"># logger.info(&#39;mirage_labelled_metrics :: total anomalies    :: %d&#39; % len(self.anomalous_metrics))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: total anomalies    :: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">mirage_anomalous_metrics</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: exception stats    :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exceptions</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: anomaly breakdown  :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_breakdown</span><span class="p">))</span>

            <span class="c1"># Log to Graphite</span>
            <span class="k">if</span> <span class="n">process_metric_check_files</span><span class="p">:</span>
                <span class="n">n_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="n">run_time</span> <span class="o">=</span> <span class="n">n_time</span> <span class="o">-</span> <span class="n">run_timestamp</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: process took </span><span class="si">%.2f</span><span class="s1"> seconds to run&#39;</span> <span class="o">%</span> <span class="n">run_time</span><span class="p">)</span>
                <span class="c1"># graphite_run_time = &#39;%.2f&#39; % run_time</span>
                <span class="c1"># send_metric_name = skyline_app_graphite_namespace + &#39;.run_time&#39;</span>
                <span class="c1"># send_graphite_metric(self, skyline_app, send_metric_name, graphite_run_time)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.run_times&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_time</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_time</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add run_time to mirage_labelled_metrics.run_times Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># @added 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
            <span class="c1"># Use Redis sets instead of Manager().list()</span>
            <span class="n">delete_redis_sets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;mirage_labelled_metrics.anomalous_metrics&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mirage_labelled_metrics.not_anomalous_metrics&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mirage_labelled_metrics.metric_variables&#39;</span><span class="p">,</span>
                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># Handle once per minute</span>
                <span class="c1"># &#39;mirage.sent_to_crucible&#39;,</span>
                <span class="c1"># &#39;mirage.sent_to_panorama&#39;,</span>
                <span class="c1"># &#39;mirage.sent_to_ionosphere&#39;,</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">i_redis_set</span> <span class="ow">in</span> <span class="n">delete_redis_sets</span><span class="p">:</span>
                <span class="n">redis_set_to_delete</span> <span class="o">=</span> <span class="n">i_redis_set</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">redis_set_to_delete</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: deleted Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to delete Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>

            <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
            <span class="c1"># Send checks.stale_discarded and checks.pending metrics</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">last_sent_to_graphite</span> <span class="o">+</span> <span class="mi">60</span><span class="p">):</span>
                <span class="n">stale_check_discarded</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stale_check_discarded</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.stale_check_discarded&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to get mirage_labelled_metrics.stale_check_discarded set from Redis&#39;</span><span class="p">)</span>
                    <span class="n">stale_check_discarded</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">stale_check_discarded_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stale_check_discarded</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: checks.stale_discarded   :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">stale_check_discarded_count</span><span class="p">))</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.checks.stale_discarded&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">stale_check_discarded_count</span><span class="p">))</span>
                <span class="n">checks_pending</span> <span class="o">=</span> <span class="p">[</span><span class="n">f_pending</span> <span class="k">for</span> <span class="n">f_pending</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">MIRAGE_LABELLED_CHECK_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MIRAGE_LABELLED_CHECK_PATH</span><span class="p">,</span> <span class="n">f_pending</span><span class="p">))]</span>
                <span class="n">checks_pending_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">checks_pending</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: checks.pending   :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">checks_pending_count</span><span class="p">))</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.checks.pending&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">checks_pending_count</span><span class="p">))</span>

                <span class="n">run_times</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">run_times_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.run_times&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.run_times&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">run_times_dict</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">n_time</span><span class="p">,</span> <span class="n">run_time_str</span> <span class="ow">in</span> <span class="n">run_times_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">run_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">run_time_str</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to determine run_times from mirage_labelled_metrics.run_times Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">run_times</span><span class="p">:</span>
                    <span class="n">run_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">run_times</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">run_time</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: seconds to run    :: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">run_time</span><span class="p">)</span>
                <span class="n">graphite_run_time</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">run_time</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="n">skyline_app_graphite_namespace</span> <span class="o">+</span> <span class="s1">&#39;.run_time&#39;</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="n">graphite_run_time</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.run_time&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.run_time&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_time</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to add keys to mirage_labelled_metrics.run_time Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># @modified 20210309 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># Reimplement mirage.checks.done count as increment key</span>
                <span class="c1"># checks_done = []</span>
                <span class="c1"># try:</span>
                <span class="c1">#     checks_done = list(self.redis_conn_decoded.smembers(&#39;mirage.checks.done&#39;))</span>
                <span class="n">checks_done</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20230205 - Task #4844: Replace Redis getset with set with get</span>
                    <span class="c1"># As of Redis version 6.2.0, this command is regarded as deprecated.</span>
                    <span class="c1"># It can be replaced by SET with the GET argument when migrating or writing new code.</span>
                    <span class="c1"># checks_done_str = self.redis_conn_decoded.getset(&#39;mirage_labelled_metrics.checks.done&#39;, 0)</span>
                    <span class="n">checks_done_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.checks.done&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">checks_done_str</span><span class="p">:</span>
                        <span class="n">checks_done</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">checks_done_str</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to get mirage_labelled_metrics.checks.done key from Redis&#39;</span><span class="p">)</span>
                    <span class="n">checks_done</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># checks_done_count = len(checks_done)</span>
                <span class="c1"># logger.info(&#39;mirage_labelled_metrics :: checks.done   :: %s&#39; % str(checks_done_count))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: checks.done   :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">checks_done</span><span class="p">))</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.checks.done&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                <span class="c1"># send_graphite_metric(self, skyline_app, send_metric_name, str(checks_done_count))</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">checks_done</span><span class="p">))</span>
                <span class="c1"># @modified 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="c1"># Only send panorama, ionosphere and crucible metrics once a minute</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_CRUCIBLE</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CRUCIBLE_ENABLED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># sent_to_crucible = str(len(self.sent_to_crucible))#</span>
                        <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># sent_to_crucible = str(len(list(self.redis_conn.smembers(&#39;mirage.sent_to_crucible&#39;))))</span>
                        <span class="n">sent_to_crucible</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage.sent_to_crucible&#39;</span><span class="p">))))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">sent_to_crucible</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: sent_to_crucible   :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sent_to_crucible</span><span class="p">)</span>
                    <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.sent_to_crucible&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                    <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="n">sent_to_crucible</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># sent_to_panorama = str(len(self.sent_to_panorama))</span>
                        <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># sent_to_panorama = str(len(list(self.redis_conn.smembers(&#39;mirage.sent_to_panorama&#39;))))</span>
                        <span class="n">sent_to_panorama</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.sent_to_panorama&#39;</span><span class="p">))))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">sent_to_panorama</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: sent_to_panorama   :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sent_to_panorama</span><span class="p">)</span>
                    <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.sent_to_panorama&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                    <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="n">sent_to_panorama</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_ENABLED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
                        <span class="c1"># sent_to_ionosphere = str(len(self.sent_to_ionosphere))</span>
                        <span class="c1"># @modified 20191022 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># sent_to_ionosphere = str(len(list(self.redis_conn.smembers(&#39;mirage.sent_to_ionosphere&#39;))))</span>
                        <span class="n">sent_to_ionosphere</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics.sent_to_ionosphere&#39;</span><span class="p">))))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: could not determine sent_to_ionosphere: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">sent_to_ionosphere</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: sent_to_ionosphere :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sent_to_ionosphere</span><span class="p">)</span>
                    <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.sent_to_ionosphere&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                    <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="n">sent_to_ionosphere</span><span class="p">)</span>
                <span class="n">last_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="n">delete_redis_sets</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;mirage_labelled_metrics.sent_to_crucible&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;mirage_labelled_metrics.sent_to_panorama&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;mirage_labelled_metrics.sent_to_ionosphere&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;mirage_labelled_metrics.stale_check_discarded&#39;</span><span class="p">,</span>
                    <span class="c1"># @modified 20210309 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># Reimplement mirage.checks.done count as increment key</span>
                    <span class="c1"># &#39;mirage.checks.done&#39;,</span>
                    <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
                    <span class="c1">#                   Task #3744: POC matrixprofile</span>
                    <span class="c1"># The main mirage process deletes this set not mirage_labelled_metrics</span>
                    <span class="c1"># mirage_snab_only_checks_redis_set,</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">i_redis_set</span> <span class="ow">in</span> <span class="n">delete_redis_sets</span><span class="p">:</span>
                    <span class="n">redis_set_to_delete</span> <span class="o">=</span> <span class="n">i_redis_set</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">redis_set_to_delete</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: deleted Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to delete Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set_to_delete</span><span class="p">)</span>

                <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                <span class="c1"># Refresh</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">filesafe_names_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.filesafe_base_names&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: hgetall metrics_manager.filesafe_base_names failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># Sleep if it went too fast</span>
            <span class="c1"># if time() - now &lt; 1:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="mi">59</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_labelled_metrics :: sleeping due to low run time...&#39;</span><span class="p">)</span>
<span class="c1">#                sleep(10)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>