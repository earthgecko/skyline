<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mirage.mirage_vortex &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mirage.mirage_vortex</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mirage.mirage_vortex</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">mirage_vortex.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">strftime</span><span class="p">,</span> <span class="n">gmtime</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">settings</span>
<span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">write_data_to_file</span><span class="p">,</span> <span class="n">send_anomalous_metric_to</span><span class="p">,</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">filesafe_metricname</span><span class="p">,</span>
    <span class="n">get_redis_conn</span><span class="p">,</span> <span class="n">get_redis_conn_decoded</span><span class="p">,</span> <span class="n">nonNegativeDerivative</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">functions.metrics.get_metric_id_from_base_name</span> <span class="kn">import</span> <span class="n">get_metric_id_from_base_name</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.insert_new_metric</span> <span class="kn">import</span> <span class="n">insert_new_metric</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.get_ionosphere_fp_ids_for_full_duration</span> <span class="kn">import</span> <span class="n">get_ionosphere_fp_ids_for_full_duration</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.determine_data_frequency</span> <span class="kn">import</span> <span class="n">determine_data_frequency</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.downsample</span> <span class="kn">import</span> <span class="n">downsample_timeseries</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.strictly_increasing_monotonicity</span> <span class="kn">import</span> <span class="n">strictly_increasing_monotonicity</span>

<span class="c1"># @added 20220504 - Feature #2580: illuminance</span>
<span class="kn">from</span> <span class="nn">functions.illuminance.add_illuminance_entries</span> <span class="kn">import</span> <span class="n">add_illuminance_entries</span>

<span class="kn">from</span> <span class="nn">functions.graphite.send_graphite_metric</span> <span class="kn">import</span> <span class="n">send_graphite_metric</span>
<span class="kn">from</span> <span class="nn">custom_algorithms</span> <span class="kn">import</span> <span class="n">run_custom_algorithm_on_timeseries</span>

<span class="c1"># from custom_algorithm_sources.sigma.sigma import run_sigma_algorithms</span>

<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;mirage_vortex&#39;</span>
<span class="c1"># skyline_app_logger = &#39;%sLog&#39; % skyline_app</span>
<span class="n">skyline_app_logger</span> <span class="o">=</span> <span class="s1">&#39;mirageLog&#39;</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
<span class="n">skyline_app_logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
<span class="n">skyline_app_loglock</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">skyline_app_logwait</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wait&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>

<span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">this_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
    <span class="k">if</span> <span class="n">SERVER_METRIC_PATH</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MIRAGE_CHECK_REPETITIVE_DAILY_PEAKS</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">VORTEX_ALGORITHMS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_ALGORITHMS</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex CRITICAL error failed to load VORTEX_ALGORITHMS from settings - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outer_err</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">MIRAGE_VORTEX_DEFAULT_ALGORITHMS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_ALGORITHMS</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">])</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MIRAGE_VORTEX_DEFAULT_ALGORITHMS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;consensus&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CONSENSUS</span><span class="p">},</span>
        <span class="s1">&#39;spectral_residual&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;consensus&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;spectral_residual&#39;</span><span class="p">]],</span>
    <span class="p">}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">MIRAGE_VORTEX_DEFAULT_CONSENSUS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_ALGORITHMS</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">][</span><span class="s1">&#39;consensus&#39;</span><span class="p">]</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MIRAGE_VORTEX_DEFAULT_CONSENSUS</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;spectral_residual&#39;</span><span class="p">]]</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">VORTEX_TIMESERIES_JSON_TO_DISK</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_TIMESERIES_JSON_TO_DISK</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VORTEX_TIMESERIES_JSON_TO_DISK</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">VORTEX_SAVE_RESULTS_FOR</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_SAVE_RESULTS_FOR</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VORTEX_SAVE_RESULTS_FOR</span> <span class="o">=</span> <span class="mi">86400</span>

<span class="c1"># Force downsampling which is requires to ensure speed and that features</span>
<span class="c1"># profiles are effective</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">VORTEX_FULL_DURATION_RESOLUTIONS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_FULL_DURATION_RESOLUTIONS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VORTEX_FULL_DURATION_RESOLUTIONS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">86400</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="mi">604800</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">HORIZON_SHARDS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">HORIZON_SHARDS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">HORIZON_SHARDS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">HORIZON_SHARD_DEBUG</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">HORIZON_SHARD_DEBUG</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">HORIZON_SHARD_DEBUG</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">number_of_horizon_shards</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">this_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">HORIZON_SHARD</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
    <span class="n">number_of_horizon_shards</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">HORIZON_SHARDS</span><span class="p">)</span>
    <span class="n">HORIZON_SHARD</span> <span class="o">=</span> <span class="n">HORIZON_SHARDS</span><span class="p">[</span><span class="n">this_host</span><span class="p">]</span>

<span class="n">ALLOWED_ALGORITHMS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">VORTEX_ALGORITHMS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="n">skyline_app_graphite_namespace</span> <span class="o">=</span> <span class="s1">&#39;skyline.mirage</span><span class="si">%s</span><span class="s1">.vortex&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SERVER_METRIC_PATH</span><span class="p">)</span>
<span class="n">failed_checks_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_vortex_failed&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_CHECK_PATH</span>


<div class="viewcode-block" id="MirageVortex"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex">[docs]</a><span class="k">class</span> <span class="nc">MirageVortex</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The MirageVortex thread</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_pid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the MirageVortex</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span> <span class="o">=</span> <span class="n">parent_pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirage_vortex_exceptions_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirage_vortex_anomaly_breakdown_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>

<div class="viewcode-block" id="MirageVortex.check_if_parent_is_alive"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.check_if_parent_is_alive">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_parent_is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Self explanatory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: parent or current process dead&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="MirageVortex.check_valid_algorithms"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.check_valid_algorithms">[docs]</a>    <span class="k">def</span> <span class="nf">check_valid_algorithms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consensus</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the algortihms are valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unknown_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">consensus</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i_item</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i_item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_ALGORITHMS</span><span class="p">:</span>
                        <span class="n">unknown_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_ALGORITHMS</span><span class="p">:</span>
                    <span class="n">unknown_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unknown_algorithms</span></div>

<div class="viewcode-block" id="MirageVortex.check_consensus"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.check_consensus">[docs]</a>    <span class="k">def</span> <span class="nf">check_consensus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consensus</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">algorithms_run</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check is consensus is achieved and still possible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">consensus_impossible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">consensus</span><span class="p">:</span>
            <span class="n">consensus_reached</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">algo</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">algo</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">triggered_algorithms</span><span class="p">:</span>
                    <span class="n">consensus_reached</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">consensus_reached</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">item</span><span class="p">,</span> <span class="n">consensus_impossible</span>
        <span class="n">consensus_possibles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">consensus</span><span class="p">:</span>
            <span class="n">consensus_possible</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">algo</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">algo</span> <span class="ow">in</span> <span class="n">algorithms_run</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">algorithms_run</span><span class="p">[</span><span class="n">algo</span><span class="p">]:</span>
                        <span class="n">consensus_possible</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">consensus_possible</span><span class="p">:</span>
                <span class="n">consensus_possibles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">consensus_possibles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">consensus_impossible</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="n">consensus_impossible</span></div>

<div class="viewcode-block" id="MirageVortex.create_echo_timeseries"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.create_echo_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">create_echo_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vortex_metric_data</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add timeseries for echo</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">use_base_name</span> <span class="o">=</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">]</span>
        <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;metric_timestamp&#39;</span><span class="p">]</span>
        <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">use_base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span>
            <span class="n">timeseries_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to create dir - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">echo_json</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.mirage.redis.24h.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">)</span>
        <span class="n">echo_timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
        <span class="n">start_timestamp</span> <span class="o">=</span> <span class="n">metric_timestamp</span> <span class="o">-</span> <span class="mi">86400</span>
        <span class="n">echo_timeseries</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">timeseries</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">start_timestamp</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">echo_timeseries</span> <span class="o">=</span> <span class="n">downsample_timeseries</span><span class="p">(</span><span class="s1">&#39;mirage&#39;</span><span class="p">,</span> <span class="n">echo_timeseries</span><span class="p">,</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">],</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: downsample_timeseries failed for echo data for request_id </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">],</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Convert the timeseries to json and save</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">echo_json</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">echo_timeseries</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to dump echo_timeseries to echo_json </span><span class="si">%s</span><span class="s1"> for request_id </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">echo_json</span><span class="p">,</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">],</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: dumped echo_timeseries to echo_json </span><span class="si">%s</span><span class="s1"> for request_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">echo_json</span><span class="p">,</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">echo_json</span></div>

<div class="viewcode-block" id="MirageVortex.add_training_data"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.add_training_data">[docs]</a>    <span class="k">def</span> <span class="nf">add_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">vortex_metric_data</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="n">ionosphere_enabled</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add training_data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">use_base_name</span> <span class="o">=</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;internal_metric_name&#39;</span><span class="p">]</span>
        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
            <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>
        <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;metric_timestamp&#39;</span><span class="p">]</span>
        <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">use_base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span>
            <span class="n">timeseries_dir</span><span class="p">)</span>
        <span class="n">anomaly_json</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">)</span>
        <span class="n">check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: saving data for request_id </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data_dir</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">metric_data_dir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to create dir - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># if not ionosphere_enabled:</span>
        <span class="c1"># Add a metric vars file</span>
        <span class="n">anomaly_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">]</span>
            <span class="n">algorithms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">full_duration</span> <span class="o">=</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;nearest_full_duration&#39;</span><span class="p">]</span>
            <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms_run&#39;</span><span class="p">]</span>
            <span class="n">anomaly_data</span> <span class="o">=</span> <span class="s1">&#39;metric = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;value = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;from_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;metric_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;triggered_algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;anomaly_dir = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;graphite_metric = False</span><span class="se">\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;run_crucible_tests = False</span><span class="se">\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;added_by = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;added_at = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;full_duration = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;ionosphere_parent_id = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                           <span class="s1">&#39;algorithms_run = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">use_base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;metric_timestamp&#39;</span><span class="p">]),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">algorithms</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">),</span>
                    <span class="n">metric_data_dir</span><span class="p">,</span> <span class="s1">&#39;mirage_vortex&#39;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())),</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_duration</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">parent_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithms_run</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to create anomaly_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">anomaly_data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">write_data_to_file</span><span class="p">(</span><span class="s1">&#39;mirage&#39;</span><span class="p">,</span> <span class="n">check_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">anomaly_data</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: added check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to add check_file </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">check_file</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">VORTEX_TIMESERIES_JSON_TO_DISK</span> <span class="ow">and</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;downsampled&#39;</span><span class="p">]:</span>
            <span class="n">jsonfile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gzip_jsonfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/undownsampled.</span><span class="si">%s</span><span class="s1">.json.gz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jsonfile</span> <span class="o">=</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: no timeseries (jsonfile) in vortex_metric_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gzip_jsonfile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: added undownsampled timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gzip_jsonfile</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to gzip jsonfile </span><span class="si">%s</span><span class="s1"> for request_id </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">jsonfile</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">jsonfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/vortex.metric_data.</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
        <span class="n">gzip_jsonfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.gz&#39;</span> <span class="o">%</span> <span class="n">jsonfile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">vortex_metric_data</span><span class="p">,</span> <span class="n">fw</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to save metric_data for request_id </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">request_id</span><span class="p">,</span> <span class="n">jsonfile</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gzip_jsonfile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to gzip jsonfile </span><span class="si">%s</span><span class="s1"> for request_id </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">jsonfile</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">gzip_jsonfile</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: listen :: mirage_vortex - failed to remove file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">jsonfile</span><span class="p">)</span>
        <span class="c1"># Convert the timeseries to json and save</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anomaly_json</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">timeseries</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to dump timeseries to anomaly_json </span><span class="si">%s</span><span class="s1"> for request_id </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">anomaly_json</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.training_data&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">use_base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;nearest_full_duration&#39;</span><span class="p">]]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding to Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to add </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">metric_data_dir</span></div>

<div class="viewcode-block" id="MirageVortex.add_results"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.add_results">[docs]</a>    <span class="k">def</span> <span class="nf">add_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add result to the mirage.vortex Redis hash</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">added_results</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">request_id_elements</span> <span class="o">=</span> <span class="n">request_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">request_id_timestamp</span> <span class="o">=</span> <span class="n">request_id_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">request_id_time</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">request_id_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">request_id_timestamp_aligned</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request_id_timestamp</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">3600</span>

        <span class="n">vortex_save_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">VORTEX_SAVE_RESULTS_FOR</span><span class="p">:</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">request_id_timestamp_aligned</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id_time</span><span class="p">))</span>
            <span class="n">vortex_save_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/flux/vortex/results/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_DIR</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id_timestamp_aligned</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">request_id_time</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">vortex_save_path</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: saving data for request_id </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">request_id</span><span class="p">,</span> <span class="n">vortex_save_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vortex_save_path</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mkdir_p</span><span class="p">(</span><span class="n">vortex_save_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: flux :: failed to create dir - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">vortex_save_path</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">jsonfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/vortex.</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vortex_save_path</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
            <span class="n">gzip_jsonfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.gz&#39;</span> <span class="o">%</span> <span class="n">jsonfile</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metric_data</span><span class="p">,</span> <span class="n">fw</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to save metric_data for request_id </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="n">jsonfile</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gzip_jsonfile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to gzip jsonfile </span><span class="si">%s</span><span class="s1"> for request_id </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">jsonfile</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">gzip_jsonfile</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex - failed to remove file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">jsonfile</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">added_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;mirage.vortex_saved&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">added_save</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: added key for </span><span class="si">%s</span><span class="s1"> to mirage.vortex_saved&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">request_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hset key for </span><span class="si">%s</span><span class="s1"> in mirage.vortex_saved - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">VORTEX_TIMESERIES_JSON_TO_DISK</span><span class="p">:</span>
            <span class="n">jsonfile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jsonfile</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: no timeseries in metric_data for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex - failed to remove file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">jsonfile</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">analysis_runtime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">analysis_start_time</span>
        <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;total_analysis_runtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_runtime</span>

        <span class="c1"># Remove results AFTER saving if return_results is not declared</span>
        <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">return_results</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">return_results</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;return_results&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">return_results</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;source_app&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flux&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;mirage.vortex&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: added results for </span><span class="si">%s</span><span class="s1"> to mirage.vortex, analysis_runtime: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">analysis_runtime</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hest results for </span><span class="si">%s</span><span class="s1"> to mirage.vortex - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">added_results</span></div>

<div class="viewcode-block" id="MirageVortex.return_shard_test"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.return_shard_test">[docs]</a>    <span class="k">def</span> <span class="nf">return_shard_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a shard test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: SHARD_TEST returning results&#39;</span><span class="p">)</span>
        <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">added_results</span></div>

<div class="viewcode-block" id="MirageVortex.shard_host"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.shard_host">[docs]</a>    <span class="k">def</span> <span class="nf">shard_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">check_horizon_shards</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the shard host to which a metric belongs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_horizon_shards</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HORIZON_SHARD</span>
        <span class="n">metric_as_bytes</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">adler32</span><span class="p">(</span><span class="n">metric_as_bytes</span><span class="p">)</span>
        <span class="n">modulo_result</span> <span class="o">=</span> <span class="n">value</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_horizon_shards</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">shost</span> <span class="ow">in</span> <span class="n">check_horizon_shards</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">modulo_result</span> <span class="o">==</span> <span class="n">check_horizon_shards</span><span class="p">[</span><span class="n">shost</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">shost</span></div>

<div class="viewcode-block" id="MirageVortex.is_labelled_metric"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.is_labelled_metric">[docs]</a>    <span class="k">def</span> <span class="nf">is_labelled_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a metric is a labelled_metric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labelled_metric</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">):</span>
                <span class="n">labelled_metric</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">labelled_metric</span></div>

<div class="viewcode-block" id="MirageVortex.generate_labelled_metric_name"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.generate_labelled_metric_name">[docs]</a>    <span class="k">def</span> <span class="nf">generate_labelled_metric_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_namespace_prefix</span><span class="p">,</span> <span class="n">server_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">server_id</span><span class="p">:</span>
            <span class="n">server_id_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">server_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">server_id_str</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="k">if</span> <span class="n">metric_namespace_prefix</span><span class="p">:</span>
            <span class="n">skyline_labels</span> <span class="o">=</span> <span class="s1">&#39;{_tenant_id=&quot;</span><span class="si">%s</span><span class="s1">&quot;,_server_id=&quot;</span><span class="si">%s</span><span class="s1">&quot;,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">),</span> <span class="n">server_id_str</span><span class="p">)</span>
            <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="n">skyline_labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">labelled_metric_name</span></div>

<div class="viewcode-block" id="MirageVortex.get_metric_data_from_archive"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.get_metric_data_from_archive">[docs]</a>    <span class="k">def</span> <span class="nf">get_metric_data_from_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">):</span>
        <span class="n">metric_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span>
                <span class="n">timeseries_dir</span><span class="p">)</span>
            <span class="n">metric_data_archive</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/vortex.metric_data.</span><span class="si">%s</span><span class="s1">.json.gz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">metric_data_archive</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">file_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">metric_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed ungzip and load metric_data from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">metric_data_archive</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">metric_data</span></div>

<div class="viewcode-block" id="MirageVortex.process_ionosphere_results"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.process_ionosphere_results">[docs]</a>    <span class="k">def</span> <span class="nf">process_ionosphere_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_timestamp</span><span class="p">,</span> <span class="n">ionosphere_results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process results from Ionosphere.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">processed_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_ionosphere_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">all_ionosphere_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;ionosphere.vortex_results&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hgetall ionosphere.vortex_results - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: ionosphere.vortex_results has </span><span class="si">%s</span><span class="s1"> items&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_ionosphere_results</span><span class="p">))))</span>

        <span class="n">mirage_vortex_sent_to_ionosphere</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mirage_vortex_sent_to_ionosphere</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;mirage_vortex.sent_to_ionosphere&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hgetall ionosphere.vortex_results - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i_result</span> <span class="ow">in</span> <span class="n">ionosphere_results</span><span class="p">:</span>
            <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results_dict_str</span> <span class="o">=</span> <span class="n">all_ionosphere_results</span><span class="p">[</span><span class="n">i_result</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">results_dict_str</span><span class="p">:</span>
                    <span class="n">results_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">results_dict_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to literal_eval </span><span class="si">%s</span><span class="s1"> in all_ionosphere_results - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">i_result</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;ionosphere.vortex_results&#39;</span><span class="p">,</span> <span class="n">i_result</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hdel </span><span class="si">%s</span><span class="s1"> from ionosphere.vortex_results - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">i_result</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">results_dict</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: not results_dict for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">i_result</span><span class="p">)))</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                <span class="n">anomalous</span> <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;metric_timestamp&#39;</span><span class="p">]</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;matched&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to interpolate data from </span><span class="si">%s</span><span class="s1"> results_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">i_result</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">sent_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">request_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mirage_vortex_sent_to_ionosphere</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">sent_dict_str</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sent_dict_str</span> <span class="o">=</span> <span class="n">mirage_vortex_sent_to_ionosphere</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sent_dict_str</span><span class="p">:</span>
                        <span class="n">i_sent_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">sent_dict_str</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="n">i_sent_dict</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_sent_dict</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]):</span>
                            <span class="n">sent_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">i_sent_dict</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: error iterating </span><span class="si">%s</span><span class="s1"> from mirage_vortex_sent_to_ionosphere - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">i_result</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sent_dict</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to find metric: </span><span class="si">%s</span><span class="s1"> and metric_timestamp: </span><span class="si">%s</span><span class="s1"> in any item in mirage_vortex.sent_to_ionosphere, cannot reconcile&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)))</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">request_id</span> <span class="o">=</span> <span class="n">sent_dict</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to determine request_id for </span><span class="si">%s</span><span class="s1"> from sent_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">i_result</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">metric_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metric_data_from_archive</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: get_metric_data_from_archive failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">added_results</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">metric_data</span><span class="p">:</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;matched&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalous</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalous</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;matched&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched</span>
                <span class="c1"># Resave the metric_data_archive with the Ionosphere results</span>
                <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span>
                    <span class="n">timeseries_dir</span><span class="p">)</span>
                <span class="n">jsonfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/vortex.metric_data.</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="n">gzip_jsonfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.gz&#39;</span> <span class="o">%</span> <span class="n">jsonfile</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metric_data</span><span class="p">,</span> <span class="n">fw</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: process_ionosphere_results - failed to save metric_data for request_id </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">request_id</span><span class="p">,</span> <span class="n">jsonfile</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gzip_jsonfile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: process_ionosphere_results - failed to gzip jsonfile </span><span class="si">%s</span><span class="s1"> for request_id </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">jsonfile</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">gzip_jsonfile</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex - process_ionosphere_results - failed to remove file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">jsonfile</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">analysis_start_time</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;begin_analysis&#39;</span><span class="p">]</span>
                    <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: add_results failed for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: results added with Ionosphere results of anomalous: </span><span class="si">%s</span><span class="s1">, matched: </span><span class="si">%s</span><span class="s1"> and removed </span><span class="si">%s</span><span class="s1"> from mirage_vortex.sent_to_ionosphere&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">anomalous</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched</span><span class="p">),</span> <span class="n">request_id</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;mirage_vortex.sent_to_ionosphere&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hdel </span><span class="si">%s</span><span class="s1"> from mirage_vortex.sent_to_ionosphere - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">anomalous</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: anomaly detected - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
                    <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_illuminance</span><span class="p">(</span><span class="n">run_timestamp</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: add_illuminance_entries failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">current_illuminance_dict</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: added </span><span class="si">%s</span><span class="s1"> anomaly to illuminance&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: adding </span><span class="si">%s</span><span class="s1"> to mirage_vortex.anomalous_metrics to be alerted on by mirage&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">added_to_mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">added_to_mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_mirage_vortex_anomalous_metrics</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hdel </span><span class="si">%s</span><span class="s1"> from mirage_vortex.sent_to_ionosphere - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: added mirage_vortex.anomalous_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">added_to_mirage_vortex_anomalous_metrics</span><span class="p">))</span>

            <span class="n">processed_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">processed_results</span></div>

<div class="viewcode-block" id="MirageVortex.return_request_results"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.return_request_results">[docs]</a>    <span class="k">def</span> <span class="nf">return_request_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_timestamp</span><span class="p">,</span> <span class="n">return_results_for</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign a metrics for a process to analyze.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">processed_results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">request_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">return_results_for</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">sent_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sent_dict_str</span> <span class="o">=</span> <span class="n">return_results_for</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sent_dict_str</span><span class="p">:</span>
                    <span class="n">sent_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">sent_dict_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to literal_eval </span><span class="si">%s</span><span class="s1"> in return_results_for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;mirage_vortex.sent_to_ionosphere&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hdel </span><span class="si">%s</span><span class="s1"> from imirage_vortex.sent_to_ionosphere - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sent_dict</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: no sent_dict for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)))</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">request_id</span> <span class="o">=</span> <span class="n">sent_dict</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">]</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">sent_dict</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">sent_dict</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to interpolate data from </span><span class="si">%s</span><span class="s1"> results_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">metric_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metric_data_from_archive</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: get_metric_data_from_archive failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomalous</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">anomalous</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to determine if </span><span class="si">%s</span><span class="s1"> is anomalous from metric_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

            <span class="n">added_results</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;matched&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;matched&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">analysis_start_time</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;begin_analysis&#39;</span><span class="p">]</span>
                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: add_results failed for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: results added with anomalous: </span><span class="si">%s</span><span class="s1">, matched: None&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">anomalous</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">anomalous</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: anomaly detected - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">:</span>
                    <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">send_to_panorama</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">]</span>
                        <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms_run&#39;</span><span class="p">]</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
                        <span class="n">sent_to_panorama</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_anomaly_to_panorama</span><span class="p">(</span>
                            <span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span>
                            <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">algorithms_run</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: send_anomaly_to_panorama failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">sent_to_panorama</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: sent </span><span class="si">%s</span><span class="s1"> anomaly to panorama&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_illuminance</span><span class="p">(</span><span class="n">run_timestamp</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: add_illuminance_entries failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">current_illuminance_dict</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: added </span><span class="si">%s</span><span class="s1"> anomaly to illuminance&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: adding </span><span class="si">%s</span><span class="s1"> to mirage_vortex.anomalous_metrics to be alerted on by mirage&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">added_to_mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">added_to_mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_mirage_vortex_anomalous_metrics</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hdel </span><span class="si">%s</span><span class="s1"> from mirage_vortex.sent_to_ionosphere - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: added mirage_vortex.anomalous_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">added_to_mirage_vortex_anomalous_metrics</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">processed_results</span></div>

<div class="viewcode-block" id="MirageVortex.add_to_mirage_vortex_anomalous_metrics"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.add_to_mirage_vortex_anomalous_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">add_to_mirage_vortex_anomalous_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">):</span>
        <span class="n">added</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="n">algo</span> <span class="k">for</span> <span class="n">algo</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">][</span><span class="n">algo</span><span class="p">]]</span>
            <span class="n">anomalous_metric</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;internal_metric_name&#39;</span><span class="p">]),</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric_timestamp&#39;</span><span class="p">],</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;nearest_full_duration&#39;</span><span class="p">],</span>
                <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms_run&#39;</span><span class="p">]]</span>
            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage_vortex.anomalous_metrics&#39;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalous_metric</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">added</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to mirage_vortex.anomalous_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to interpolate metric_data to add to mirage_vortex.anomalous_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">added</span></div>

<div class="viewcode-block" id="MirageVortex.add_to_illuminance"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.add_to_illuminance">[docs]</a>    <span class="k">def</span> <span class="nf">add_to_illuminance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_timestamp</span><span class="p">,</span> <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">):</span>
        <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">illuminance_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">illuminance_dict</span><span class="p">[</span><span class="n">labelled_metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
                <span class="s1">&#39;triggered_algorithms_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: calling add_illuminance_entries with </span><span class="si">%s</span><span class="s1"> entries to add&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">illuminance_dict</span><span class="p">))))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="n">add_illuminance_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">run_timestamp</span><span class="p">),</span> <span class="n">illuminance_dict</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: add_illuminance_entries failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: illuminance Redis hash now has </span><span class="si">%s</span><span class="s1"> entries&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_illuminance_dict</span><span class="p">))))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: add_to_illuminance failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">current_illuminance_dict</span></div>

<div class="viewcode-block" id="MirageVortex.send_anomaly_to_panorama"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.send_anomaly_to_panorama">[docs]</a>    <span class="k">def</span> <span class="nf">send_anomaly_to_panorama</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">algorithms_run</span><span class="p">,</span>
            <span class="n">triggered_algorithms</span><span class="p">):</span>

        <span class="n">sent_to_panorama</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">:</span>
            <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">send_to_panorama</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">):</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">)</span>
            <span class="c1"># Note:</span>
            <span class="c1"># The values are enclosed is single quoted intentionally</span>
            <span class="c1"># as the imp.load_source used results in a shift in the</span>
            <span class="c1"># decimal position when double quoted, e.g.</span>
            <span class="c1"># value = &quot;5622.0&quot; gets imported as</span>
            <span class="c1"># 2016-03-02 12:53:26 :: 28569 :: metric variable - value - 562.2</span>
            <span class="c1"># single quoting results in the desired,</span>
            <span class="c1"># 2016-03-02 13:16:17 :: 1515 :: metric variable - value - 5622.0</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;vortex&#39;</span>
            <span class="n">added_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="n">panoroma_anomaly_data</span> <span class="o">=</span> <span class="s1">&#39;metric = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                    <span class="s1">&#39;value = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                    <span class="s1">&#39;from_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                    <span class="s1">&#39;metric_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                    <span class="s1">&#39;algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                    <span class="s1">&#39;triggered_algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                    <span class="s1">&#39;app = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                    <span class="s1">&#39;source = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                    <span class="s1">&#39;added_by = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                                    <span class="s1">&#39;added_at = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span>
                   <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithms_run</span><span class="p">),</span>
                   <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="s1">&#39;vortex&#39;</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">this_host</span><span class="p">,</span>
                   <span class="nb">str</span><span class="p">(</span><span class="n">added_at</span><span class="p">))</span>
            <span class="c1"># Create an anomaly file with details about the anomaly</span>
            <span class="n">sane_metricname</span> <span class="o">=</span> <span class="n">filesafe_metricname</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">))</span>
            <span class="n">panoroma_anomaly_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">,</span> <span class="n">added_at</span><span class="p">,</span> <span class="n">sane_metricname</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">write_data_to_file</span><span class="p">(</span>
                    <span class="s1">&#39;mirage&#39;</span><span class="p">,</span> <span class="n">panoroma_anomaly_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                    <span class="n">panoroma_anomaly_data</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: added panorama anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">panoroma_anomaly_file</span><span class="p">))</span>
                <span class="n">sent_to_panorama</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to add panorama anomaly file - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">panoroma_anomaly_file</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mirage.sent_to_panorama&#39;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">sent_to_panorama</span></div>

<div class="viewcode-block" id="MirageVortex.spin_process"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.spin_process">[docs]</a>    <span class="k">def</span> <span class="nf">spin_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">run_timestamp</span><span class="p">,</span> <span class="n">assigned_checks</span><span class="p">,</span> <span class="n">ionosphere_results</span><span class="p">,</span> <span class="n">return_results_for</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign a metrics or results to process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">assigned_checks</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ionosphere_results</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_results_for</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: no checks to assign or results to process, nothing to do&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">process_start_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

        <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">process_start_timestamp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_results_for</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: returning </span><span class="si">%s</span><span class="s1"> results&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_results_for</span><span class="p">)))</span>
            <span class="n">processed_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">processed_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_request_results</span><span class="p">(</span><span class="n">run_timestamp</span><span class="p">,</span> <span class="n">return_results_for</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: return_request_results failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: returned </span><span class="si">%s</span><span class="s1"> results&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_results</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">ionosphere_results</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: </span><span class="si">%s</span><span class="s1"> results from ionosphere to process&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ionosphere_results</span><span class="p">)))</span>
            <span class="n">processed_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">processed_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_ionosphere_results</span><span class="p">(</span><span class="n">run_timestamp</span><span class="p">,</span> <span class="n">ionosphere_results</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: process_ionosphere_results failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed and returned </span><span class="si">%s</span><span class="s1"> results from ionosphere&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_results</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="n">redis_metrics_processed_key</span> <span class="o">=</span> <span class="s1">&#39;mirage_vortex.</span><span class="si">%s</span><span class="s1">.metrics_processed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">redis_metrics_processed_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                <span class="n">last_redis_metrics_processed_key</span> <span class="o">=</span> <span class="s1">&#39;mirage_vortex.</span><span class="si">%s</span><span class="s1">.metrics_processed.last&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">redis_metrics_processed_key</span><span class="p">,</span> <span class="n">last_redis_metrics_processed_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to rename </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">redis_metrics_processed_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="n">checks_processed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">ionosphere_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">check_item</span> <span class="ow">in</span> <span class="n">assigned_checks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">process_start_timestamp</span> <span class="o">+</span> <span class="mi">50</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: run time limit reached - stopping&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">checks_processed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">analysis_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>

            <span class="n">check_str</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">check_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;flux.vortex&#39;</span><span class="p">,</span> <span class="n">check_item</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hget </span><span class="si">%s</span><span class="s1"> from flux.vortex - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">check_item</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">check_str</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;flux.vortex&#39;</span><span class="p">,</span> <span class="n">check_item</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hdel </span><span class="si">%s</span><span class="s1"> from flux.vortex - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">check_item</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="n">metric_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">check_str</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">check_str</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to literal_eval data for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">check_item</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_data</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: no metric_data for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">check_item</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">request_id</span> <span class="o">=</span> <span class="n">check_item</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># The source_app can be flux, mirage or luminosity</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">source_app</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;source_app&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">source_app</span> <span class="o">=</span> <span class="s1">&#39;flux&#39;</span>

            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;begin_analysis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processing request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>

            <span class="n">consensus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">MIRAGE_VORTEX_DEFAULT_CONSENSUS</span><span class="p">)</span>
            <span class="n">algorithms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">algorithms</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">algorithms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{}}</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: using default algorithms for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                    <span class="n">algorithms</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">MIRAGE_VORTEX_DEFAULT_ALGORITHMS</span><span class="p">)</span>
            <span class="n">algorithms_to_be_run</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">if</span> <span class="s1">&#39;test_anomaly&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;test_anomaly&#39;</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: test_anomaly request for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                    <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;additional info&#39;</span><span class="p">:</span> <span class="s1">&#39;TEST ANOMALY ONLY - no analysis done&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="p">{}</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
                    <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed test_anomaly request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                    <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">consensus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;consensus&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">consensus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">MIRAGE_VORTEX_DEFAULT_CONSENSUS</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">consensus</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">consensus</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="n">consensus</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">item</span><span class="p">])</span>

            <span class="c1"># @added 20230616 - Feature #4952: vortex - consensus_count</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">consensus_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;consensus_count&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">consensus_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">unknown_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">unknown_algorithms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_valid_algorithms</span><span class="p">(</span><span class="n">consensus</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">unknown_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">unknown_algorithms</span><span class="p">:</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">additional_info</span> <span class="o">=</span> <span class="s1">&#39;unknown algorithm values passed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unknown_algorithms</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: mirage_vortex :: not processing request_id: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="n">additional_info</span><span class="p">))</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;additional info&#39;</span><span class="p">:</span> <span class="n">additional_info</span><span class="p">,</span>
                    <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_info</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span>
                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">unknown_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">unknown_algorithms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_valid_algorithms</span><span class="p">(</span><span class="n">algorithms_to_be_run</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">unknown_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">unknown_algorithms</span><span class="p">:</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">additional_info</span> <span class="o">=</span> <span class="s1">&#39;unknown algorithm values passed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unknown_algorithms</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: mirage_vortex :: not processing request_id: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="n">additional_info</span><span class="p">))</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;additional info&#39;</span><span class="p">:</span> <span class="n">additional_info</span><span class="p">,</span>
                    <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_info</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span>
                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># Check that the algorithms_to_be_run are in consensus</span>
            <span class="n">in_consensus</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">consensus_item</span> <span class="ow">in</span> <span class="n">consensus</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">consensus_item</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">algorithms_to_be_run</span><span class="p">:</span>
                        <span class="n">in_consensus</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_consensus</span><span class="p">:</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">additional_info</span> <span class="o">=</span> <span class="s1">&#39;input error - algorithms passed do not match any algorithms in consensus no consensus could ever be achieved&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: mirage_vortex :: not processing request_id: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="n">additional_info</span><span class="p">))</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;additional info&#39;</span><span class="p">:</span> <span class="n">additional_info</span><span class="p">,</span>
                    <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_info</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span>
                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: no metric in metric_data for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">check_item</span><span class="p">))</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">additional_info</span> <span class="o">=</span> <span class="s1">&#39;no metric name passed&#39;</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;additional info&#39;</span><span class="p">:</span> <span class="n">additional_info</span><span class="p">,</span>
                    <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_info</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span>
                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">VORTEX_TIMESERIES_JSON_TO_DISK</span><span class="p">:</span>
                <span class="n">jsonfile</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">jsonfile</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: no timeseries in metric_data for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">check_item</span><span class="p">))</span>
                <span class="n">file_metric_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="n">file_metric_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to load file_metric_data from </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">jsonfile</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">file_metric_data</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: loaded timeseries from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">jsonfile</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: no timeseries in file_metric_data for </span><span class="si">%s</span><span class="s1">- </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">check_item</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: no timeseries in metric_data for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">check_item</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">new_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="n">ts</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_timeseries</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">timeseries</span><span class="p">[</span><span class="n">ts</span><span class="p">]])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">continue</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_timeseries</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">new_timeseries</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: mirage_vortex :: no timeseries in metric_data for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">check_item</span><span class="p">))</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">additional_info</span> <span class="o">=</span> <span class="s1">&#39;no timeseries data found&#39;</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;additional info&#39;</span><span class="p">:</span> <span class="n">additional_info</span><span class="p">,</span>
                    <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_info</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span>
                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">shard_test</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shard_test</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;shard_test&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">shard_test</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">shard_test</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">TEST_HORIZON_SHARDS</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">this_host</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;another-test-node-1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s1">&#39;another-test-node-2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">shost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_host</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">TEST_HORIZON_SHARDS</span><span class="p">)</span>
                    <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;shard_test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shard_test</span>
                    <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;shard_host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shost</span>
                    <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;processing_shard&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_HORIZON_SHARDS</span><span class="p">[</span><span class="n">shost</span><span class="p">]</span>
                    <span class="n">shard_test_done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_shard_test</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">shard_test_done</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: SHARD_TEST processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                        <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: shard_test failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>

            <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to determine last timestamp for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed no metric_timestamp for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">additional_info</span> <span class="o">=</span> <span class="s1">&#39;no valid timeseries data found&#39;</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;additional info&#39;</span><span class="p">:</span> <span class="n">additional_info</span><span class="p">,</span>
                    <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_info</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span>
                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">is_unix_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">is_unix_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">is_unix_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_unix_timestamp</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: not unix timestamps for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">additional_info</span> <span class="o">=</span> <span class="s1">&#39;date format incorrect, unix timestamps are required&#39;</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;additional info&#39;</span><span class="p">:</span> <span class="n">additional_info</span><span class="p">,</span>
                    <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_info</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span>
                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">check_if_parent_is_alive</span><span class="p">()</span>

            <span class="c1"># Transform the timeseries data to ensure all non values are removed</span>
            <span class="c1"># and that timestamps are coerced into int and values into floats</span>
            <span class="n">use_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">coerce_errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">use_timeseries</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">coerce_errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">index</span><span class="p">,</span> <span class="n">err</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">coerce_errors</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: request_id: </span><span class="si">%s</span><span class="s1"> encountered </span><span class="si">%s</span><span class="s1"> coerce_errors, last err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coerce_errors</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">coerce_errors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_timeseries</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: no use_timeseries for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">additional_info</span> <span class="o">=</span> <span class="s1">&#39;no data to analyse after preprocessing, invalid timestamps and values - hint: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">coerce_errors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;additional info&#39;</span><span class="p">:</span> <span class="n">additional_info</span><span class="p">,</span>
                    <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_info</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span>
                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">return_image_urls</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;return_image_urls&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">return_image_urls</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">trigger_anomaly</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;trigger_anomaly&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trigger_anomaly</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">algorithms_test_only</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;algorithms_test_only&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">algorithms_test_only</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">use_timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">use_timeseries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;full_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_duration</span>
            <span class="n">hours_to_resolve</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">full_duration</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="n">nearest_full_duration</span> <span class="o">=</span> <span class="mi">86400</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">full_duration</span> <span class="o">/</span> <span class="mi">86400</span><span class="p">)</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;nearest_full_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nearest_full_duration</span>

            <span class="n">timeseries_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;timeseries_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeseries_length</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">use_timeseries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_timestamp</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">use_timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">resolution</span> <span class="o">=</span> <span class="n">determine_data_frequency</span><span class="p">(</span><span class="s1">&#39;mirage&#39;</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution</span>

            <span class="c1"># Set whether the timeseries can be trained on.  It is not valid for</span>
            <span class="c1"># training if it has negative values or large gaps in the data.</span>
            <span class="n">trainable</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Determine whether the appropriate analysis period and whether the</span>
            <span class="c1"># timeseries needs to be downsampled</span>
            <span class="n">downsample</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">downsample_resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
            <span class="n">analysis_period</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">full_duration</span><span class="p">)</span>
            <span class="c1"># Analyse the data at 1 or 7 days</span>
            <span class="k">if</span> <span class="n">full_duration</span> <span class="o">&lt;</span> <span class="p">((</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="mi">7200</span><span class="p">):</span>
                <span class="n">analysis_period</span> <span class="o">=</span> <span class="mi">86400</span>
            <span class="k">if</span> <span class="n">full_duration</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">7</span><span class="p">):</span>
                <span class="n">analysis_period</span> <span class="o">=</span> <span class="mi">86400</span> <span class="o">*</span> <span class="mi">7</span>

            <span class="c1"># @added 20230129</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">override_7_day_limit</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;override_7_day_limit&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">override_7_day_limit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">override_7_day_limit</span><span class="p">:</span>
                <span class="n">analysis_period</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">timeseries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;analysis_period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_period</span>
            <span class="c1"># Remove any data before the start of the analysis period</span>
            <span class="n">analysis_start_timestamp</span> <span class="o">=</span> <span class="n">metric_timestamp</span> <span class="o">-</span> <span class="n">analysis_period</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;analysis_period_start_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_start_timestamp</span>
            <span class="k">if</span> <span class="n">timeseries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">analysis_start_timestamp</span><span class="p">:</span>
                <span class="n">use_timeseries</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">timeseries</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">analysis_start_timestamp</span><span class="p">]</span>
            <span class="c1"># Determine the downsample resolution</span>
            <span class="k">if</span> <span class="n">resolution</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
                <span class="n">downsample</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">downsample_resolution</span> <span class="o">=</span> <span class="mi">60</span>
            <span class="k">if</span> <span class="n">resolution</span> <span class="o">&lt;</span> <span class="mi">600</span> <span class="ow">and</span> <span class="n">analysis_period</span> <span class="o">&gt;</span> <span class="mi">86400</span><span class="p">:</span>
                <span class="n">downsample</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">downsample_resolution</span> <span class="o">=</span> <span class="mi">600</span>
            <span class="n">downsampled_timeseries</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">downsampled</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">no_downsample</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">no_downsample</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;no_downsample&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">no_downsample</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">no_downsample</span> <span class="ow">and</span> <span class="n">downsample</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: no_downsample passed for request_id: </span><span class="si">%s</span><span class="s1"> NOT downsampling timeseries from </span><span class="si">%s</span><span class="s1"> data points at </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries_length</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolution</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">full_duration</span> <span class="o">/</span> <span class="n">downsample_resolution</span><span class="p">)),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">downsample_resolution</span><span class="p">)))</span>
                <span class="n">downsample</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Not trainable if timeseries should be downsample and is not</span>
                <span class="c1"># trainable = False</span>

            <span class="n">check_all_consensuses</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">check_all_consensuses</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;check_all_consensuses&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">check_all_consensuses</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20230616 - Feature #4952: vortex - consensus_count</span>
            <span class="k">if</span> <span class="n">consensus_count</span><span class="p">:</span>
                <span class="n">check_all_consensuses</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">consensus_count_results</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">consensus_count_results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">downsample_method</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
            <span class="n">is_strictly_increasing_monotonicity</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">is_strictly_increasing_monotonicity</span> <span class="o">=</span> <span class="n">strictly_increasing_monotonicity</span><span class="p">(</span><span class="n">use_timeseries</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: is_strictly_increasing_monotonicity failed for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;monotonic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_strictly_increasing_monotonicity</span>
            <span class="k">if</span> <span class="n">is_strictly_increasing_monotonicity</span><span class="p">:</span>
                <span class="n">downsample_method</span> <span class="o">=</span> <span class="s1">&#39;sum&#39;</span>

            <span class="k">if</span> <span class="n">downsample</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: downsampling request_id: </span><span class="si">%s</span><span class="s1"> timeseries from </span><span class="si">%s</span><span class="s1"> data points at </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> using the </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries_length</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolution</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">full_duration</span> <span class="o">/</span> <span class="n">downsample_resolution</span><span class="p">)),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">downsample_resolution</span><span class="p">),</span> <span class="n">downsample_method</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">downsampled_timeseries</span> <span class="o">=</span> <span class="n">downsample_timeseries</span><span class="p">(</span><span class="s1">&#39;mirage&#39;</span><span class="p">,</span> <span class="n">use_timeseries</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="n">downsample_method</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: downsample_timeseries failed for request_id </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">downsampled_timeseries</span><span class="p">:</span>
                <span class="c1"># Coerce timestamps to ints</span>
                <span class="n">downsampled_timeseries</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">downsampled_timeseries</span><span class="p">]</span>
                <span class="n">downsampled</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;downsampled_resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">downsample_resolution</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;downsampled_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">downsampled_timeseries</span><span class="p">)</span>
                <span class="n">use_timeseries</span> <span class="o">=</span> <span class="n">downsampled_timeseries</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;downsample_resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">downsample_resolution</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;downsampled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">downsampled</span>

            <span class="n">expected_timeseries_length</span> <span class="o">=</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">600</span>
            <span class="k">if</span> <span class="n">analysis_period</span> <span class="o">==</span> <span class="mi">86400</span><span class="p">:</span>
                <span class="n">expected_timeseries_length</span> <span class="o">=</span> <span class="mi">86400</span> <span class="o">/</span> <span class="mi">60</span>

            <span class="n">use_timeseries_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_timeseries</span><span class="p">)</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;use_timeseries_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_timeseries_length</span>

            <span class="k">if</span> <span class="n">is_strictly_increasing_monotonicity</span><span class="p">:</span>
                <span class="c1"># Calculate the derivate AFTER downsampling</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">use_timeseries</span> <span class="o">=</span> <span class="n">nonNegativeDerivative</span><span class="p">(</span><span class="n">use_timeseries</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: nonNegativeDerivative failed for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="n">metric_data_no_timeseries</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">metric_data_no_timeseries</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: request_id: </span><span class="si">%s</span><span class="s1"> metric_data (excl timeseries): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data_no_timeseries</span><span class="p">)))</span>
            <span class="k">del</span> <span class="n">metric_data_no_timeseries</span>

            <span class="c1"># Return if there is insufficient data</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">use_timeseries</span><span class="p">)</span> <span class="o">/</span> <span class="n">expected_timeseries_length</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: after preprocessing there is insufficient data for analysis - request_id: </span><span class="si">%s</span><span class="s1">, len(use_timeseries): </span><span class="si">%s</span><span class="s1">, expected length: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">use_timeseries</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_timeseries_length</span><span class="p">)))</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">additional_info</span> <span class="o">=</span> <span class="s1">&#39;after preprocessing there insufficient data for analysis&#39;</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;additional info&#39;</span><span class="p">:</span> <span class="n">additional_info</span><span class="p">,</span>
                    <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_info</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">400</span>
                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># Determine if there are any negatives values</span>
            <span class="n">negative_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">use_timeseries</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">negative_values</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                <span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">run_negatives_present</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">algorithms_run</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">added_results</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sent_to_ionosphere</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">last_algorithm</span> <span class="o">=</span> <span class="n">algorithms_to_be_run</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># for algorithm in algorithms:</span>
            <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">algorithms_to_be_run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">added_results</span> <span class="ow">or</span> <span class="n">sent_to_ionosphere</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="n">algorithm</span>
                    <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;prophet&#39;</span><span class="p">:</span>
                        <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;skyline_prophet&#39;</span>

                    <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;matrixprofile&#39;</span><span class="p">:</span>
                        <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;skyline_matrixprofile&#39;</span>

                    <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: running sigma for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                        <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="n">VORTEX_ALGORITHMS</span><span class="p">[</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">return_results</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">anomalyScore</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="n">algorithm</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;algorithm_parameters&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">algorithms</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">algorithms</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: error determining algorithm_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">return_results</span> <span class="o">=</span> <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;return_results&#39;</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">return_results</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">return_anomalies_only</span> <span class="o">=</span> <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;return_anomalies_only&#39;</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">return_anomalies_only</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">anomaly_window</span> <span class="o">=</span> <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;anomaly_window&#39;</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">anomaly_window</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;anomaly_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomaly_window</span>
                        <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;base_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
                        <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;debug_print&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;debug_logging&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;return_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;return_anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">custom_algorithms_to_run</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;algorithm_source&#39;</span><span class="p">:</span> <span class="s1">&#39;/opt/skyline/github/skyline/skyline/custom_algorithms/sigma.py&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;max_execution_time&#39;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span>
                                <span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">:</span> <span class="n">algorithm_parameters</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">}</span>
                        <span class="n">sigma_analysis_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                        <span class="n">sigma_anomalous</span> <span class="o">=</span> <span class="n">anomalyScore</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">use_debug_logging</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">sigma_anomalous</span><span class="p">,</span> <span class="n">anomalyScore</span><span class="p">,</span> <span class="n">anomalies</span> <span class="o">=</span> <span class="n">run_custom_algorithm_on_timeseries</span><span class="p">(</span><span class="s1">&#39;mirage&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">metric</span><span class="p">,</span> <span class="n">use_timeseries</span><span class="p">,</span> <span class="n">custom_algorithm</span><span class="p">,</span> <span class="n">custom_algorithms_to_run</span><span class="p">[</span><span class="n">custom_algorithm</span><span class="p">],</span> <span class="n">use_debug_logging</span><span class="p">)</span>
                            <span class="c1"># Try direct</span>
                            <span class="c1"># sigma_anomalous, anomalies = run_sigma_algorithms(&#39;mirage&#39;, timeseries, algorithm_parameters[&#39;sigma_value&#39;], algorithm_parameters[&#39;consensus&#39;], anomaly_window)</span>
                            <span class="k">if</span> <span class="n">sigma_anomalous</span><span class="p">:</span>
                                <span class="n">anomalyScore</span> <span class="o">=</span> <span class="mf">1.0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">anomalyScore</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: unhandled error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="n">algorithms_run</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_anomalous</span>
                        <span class="k">if</span> <span class="n">sigma_anomalous</span><span class="p">:</span>
                            <span class="n">triggered_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">)</span>
                        <span class="n">sigma_completed_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                        <span class="n">sigma_run_time</span> <span class="o">=</span> <span class="n">sigma_completed_at</span> <span class="o">-</span> <span class="n">sigma_analysis_start_time</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: sigma analysis on </span><span class="si">%s</span><span class="s1"> completed in </span><span class="si">%.2f</span><span class="s1"> seconds with anomalous: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">request_id</span><span class="p">,</span> <span class="n">sigma_run_time</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigma_anomalous</span><span class="p">)))</span>
                        <span class="n">anomalies_in_window</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sigma_anomalous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
                            <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="n">sigma_anomalous</span><span class="p">,</span>
                            <span class="s1">&#39;anomalyScore&#39;</span><span class="p">:</span> <span class="n">anomalyScore</span><span class="p">,</span>
                            <span class="s1">&#39;anomalies_in_window&#39;</span><span class="p">:</span> <span class="n">anomalies_in_window</span><span class="p">,</span>
                            <span class="s1">&#39;analysis_runtime&#39;</span><span class="p">:</span> <span class="n">sigma_run_time</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="n">return_results</span><span class="p">:</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalies</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;an error occurred during sigma analysis&#39;</span>

                        <span class="c1"># @added 20230616 - Feature #4952: vortex - consensus_count</span>
                        <span class="k">if</span> <span class="n">consensus_count</span><span class="p">:</span>
                            <span class="n">consensus_count_results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">consensus_count_results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalies</span>
                            <span class="n">anomalyScore_list</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">anomalies_timestamps</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">anomalies</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
                            <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
                                <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="ow">in</span> <span class="n">anomalies_timestamps</span><span class="p">:</span>
                                    <span class="n">score</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="n">anomalyScore_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                            <span class="n">consensus_count_results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalyScore_list</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;prophet&#39;</span><span class="p">:</span>
                                <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;skyline_prophet&#39;</span>

                            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;matrixprofile&#39;</span><span class="p">:</span>
                                <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;skyline_matrixprofile&#39;</span>

                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: running </span><span class="si">%s</span><span class="s1"> for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">custom_algorithm</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)))</span>
                            <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="n">VORTEX_ALGORITHMS</span><span class="p">[</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">outlier_value</span> <span class="o">=</span> <span class="n">VORTEX_ALGORITHMS</span><span class="p">[</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;outlier_value&#39;</span><span class="p">]</span>
                            <span class="n">return_results</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">anomalyScore</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="n">algorithm</span>
                            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;prophet&#39;</span><span class="p">:</span>
                                <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;skyline_prophet&#39;</span>
                            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;matrixprofile&#39;</span><span class="p">:</span>
                                <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;skyline_matrixprofile&#39;</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;algorithm_parameters&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">algorithms</span><span class="p">[</span><span class="n">algorithm</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                    <span class="n">algorithm_parameters</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">algorithms</span><span class="p">[</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: error determining algorithm_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">return_results</span> <span class="o">=</span> <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;return_results&#39;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="s1">&#39;return_results&#39;</span> <span class="ow">in</span> <span class="n">metric_data</span><span class="p">:</span>
                                    <span class="n">return_results</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;return_results&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">return_results</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">return_anomalies_only</span> <span class="o">=</span> <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;return_anomalies_only&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">return_anomalies_only</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">anomaly_window</span> <span class="o">=</span> <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;anomaly_window&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">anomaly_window</span> <span class="o">=</span> <span class="mi">1</span>

                            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;pca&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">outlier_value</span> <span class="o">=</span> <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">outlier_value</span> <span class="o">=</span> <span class="n">VORTEX_ALGORITHMS</span><span class="p">[</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;outlier_value&#39;</span><span class="p">]</span>

                            <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;anomaly_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomaly_window</span>
                            <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;base_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
                            <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;debug_print&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;debug_logging&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;return_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;return_anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;prophet&#39;</span><span class="p">:</span>
                                <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;skyline_prophet&#39;</span>
                            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;matrixprofile&#39;</span><span class="p">:</span>
                                <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;skyline_matrixprofile&#39;</span>

                            <span class="n">algorithm_source</span> <span class="o">=</span> <span class="s1">&#39;/opt/skyline/github/skyline/skyline/custom_algorithms/</span><span class="si">%s</span><span class="s1">.py&#39;</span> <span class="o">%</span> <span class="n">custom_algorithm</span>
                            <span class="n">custom_algorithms_to_run</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="n">custom_algorithm</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s1">&#39;algorithm_source&#39;</span><span class="p">:</span> <span class="n">algorithm_source</span><span class="p">,</span>
                                    <span class="s1">&#39;max_execution_time&#39;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span>
                                    <span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">:</span> <span class="n">algorithm_parameters</span><span class="p">,</span>
                                <span class="p">},</span>
                            <span class="p">}</span>

                            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;mstl&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">custom_algorithms_to_run</span><span class="p">[</span><span class="n">custom_algorithm</span><span class="p">][</span><span class="s1">&#39;max_execution_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithm_parameters</span><span class="p">[</span><span class="s1">&#39;max_execution_time&#39;</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">custom_algorithms_to_run</span><span class="p">[</span><span class="n">custom_algorithm</span><span class="p">][</span><span class="s1">&#39;max_execution_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">180</span>

                            <span class="n">ca_analysis_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="n">anomalous</span> <span class="o">=</span> <span class="n">anomalyScore</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;anomalies&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;anomalyScore_list&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;scores&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                            <span class="n">anomalyScore_list</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">use_debug_logging</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">anomalous</span><span class="p">,</span> <span class="n">anomalyScore</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">run_custom_algorithm_on_timeseries</span><span class="p">(</span><span class="s1">&#39;mirage&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">metric</span><span class="p">,</span> <span class="n">use_timeseries</span><span class="p">,</span> <span class="n">custom_algorithm</span><span class="p">,</span> <span class="n">custom_algorithms_to_run</span><span class="p">[</span><span class="n">custom_algorithm</span><span class="p">],</span> <span class="n">use_debug_logging</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: </span><span class="si">%s</span><span class="s1"> unhandled error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">custom_algorithm</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                <span class="n">anomalous</span> <span class="o">=</span> <span class="n">anomalyScore</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;anomalies&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;anomalyScore_list&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;scores&#39;</span><span class="p">:</span> <span class="p">[]}</span>

                            <span class="n">algorithms_run</span><span class="p">[</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalous</span>
                            <span class="k">if</span> <span class="n">anomalous</span><span class="p">:</span>
                                <span class="n">triggered_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
                            <span class="n">ca_run_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ca_analysis_start_time</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: </span><span class="si">%s</span><span class="s1"> analysis on </span><span class="si">%s</span><span class="s1"> completed in </span><span class="si">%.2f</span><span class="s1"> seconds with anomalous: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">custom_algorithm</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">ca_run_time</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalous</span><span class="p">)))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">anomalyScore_list</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;anomalyScore_list&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">anomalyScore_list</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="n">total_anomalies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">anomalyScore_list</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
                            <span class="n">anomalies_in_window</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">anomalyScore_list</span><span class="p">[</span><span class="o">-</span><span class="n">anomaly_window</span><span class="p">:]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">anomalous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">unreliable</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;dbscan&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">anomalous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="s1">&#39;unreliable&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]:</span>
                                            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="n">unreliable</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="k">pass</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
                                <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="n">anomalous</span><span class="p">,</span>
                                <span class="s1">&#39;anomalyScore&#39;</span><span class="p">:</span> <span class="n">anomalyScore</span><span class="p">,</span>
                                <span class="s1">&#39;anomalies_in_window&#39;</span><span class="p">:</span> <span class="n">anomalies_in_window</span><span class="p">,</span>
                                <span class="s1">&#39;total_anomalies&#39;</span><span class="p">:</span> <span class="n">total_anomalies</span><span class="p">,</span>
                                <span class="s1">&#39;analysis_runtime&#39;</span><span class="p">:</span> <span class="n">ca_run_time</span><span class="p">,</span>
                                <span class="s1">&#39;unreliable&#39;</span><span class="p">:</span> <span class="n">unreliable</span><span class="p">,</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="n">return_results</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_anomalies_only</span><span class="p">:</span>
                                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span>
                                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">return_anomalies_only</span><span class="p">:</span>
                                <span class="n">anomalies</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]:</span>
                                            <span class="n">anomalies</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]}</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalies</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;an error occurred during </span><span class="si">%s</span><span class="s1"> analysis&#39;</span> <span class="o">%</span> <span class="n">algorithm</span>
                            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;dbscan&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">unreliable</span><span class="p">:</span>
                                    <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
                                    <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;unreliable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;spectral_entropy&#39;</span><span class="p">:</span>
                                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;low_entropy_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;low_entropy_value&#39;</span><span class="p">]</span>

                            <span class="c1"># @added 20230616 - Feature #4952: vortex - consensus_count</span>
                            <span class="k">if</span> <span class="n">consensus_count</span><span class="p">:</span>
                                <span class="n">consensus_count_results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="n">consensus_count_results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span>
                                <span class="n">consensus_count_results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalyScore_list</span>

                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: </span><span class="si">%s</span><span class="s1"> unhandled error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">custom_algorithm</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                    <span class="c1"># Determine consensus status</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">consensus_reached</span><span class="p">,</span> <span class="n">consensus_impossible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_consensus</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">algorithms_run</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: check_consensus failed for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">check_all_consensuses</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">algorithm</span> <span class="o">!=</span> <span class="n">last_algorithm</span><span class="p">:</span>
                            <span class="n">consensus_reached</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">consensus_impossible</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">consensus_reached</span> <span class="ow">or</span> <span class="n">consensus_impossible</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">consensus_reached</span><span class="p">:</span>
                            <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_achieved&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: consensus reached with </span><span class="si">%s</span><span class="s1"> for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">consensus_reached</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">consensus_impossible</span><span class="p">:</span>
                            <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_achieved&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: consensus cannot be reached for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)))</span>
                            <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_reached&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">consensus_reached</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalous</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">algorithms_run</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                            <span class="k">for</span> <span class="n">i_algorithm</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
                                <span class="n">triggered</span> <span class="o">=</span> <span class="n">i_algorithm</span> <span class="ow">in</span> <span class="n">triggered_algorithms</span>
                                <span class="k">if</span> <span class="n">i_algorithm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">algorithms_run</span><span class="p">:</span>
                                    <span class="n">triggered</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="n">triggered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">][</span><span class="n">i_algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="n">triggered</span>
                                <span class="k">if</span> <span class="n">i_algorithm</span> <span class="o">==</span> <span class="s1">&#39;dbscan&#39;</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">anomalous</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">][</span><span class="n">i_algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="k">pass</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: check_consensus failed for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                        <span class="n">consensus_anomalies</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">consensus_scores</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">return_results</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_anomalies_only</span><span class="p">:</span>
                            <span class="n">anomalies</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">algorithms_with_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
                                    <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="n">consensus_anomalies</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;triggered&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                                    <span class="k">for</span> <span class="n">i_algorithm</span> <span class="ow">in</span> <span class="n">algorithms_with_results</span><span class="p">:</span>
                                        <span class="n">algo_anomaly</span> <span class="o">=</span> <span class="kc">None</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">algo_anomaly</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">i_algorithm</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">][</span><span class="n">ts</span><span class="p">]</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                        <span class="k">if</span> <span class="n">algo_anomaly</span><span class="p">:</span>
                                            <span class="n">consensus_anomalies</span><span class="p">[</span><span class="n">ts</span><span class="p">][</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_algorithm</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">consensus_anomalies</span><span class="p">[</span><span class="n">ts</span><span class="p">][</span><span class="s1">&#39;triggered&#39;</span><span class="p">]:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">i_consensus_reached</span><span class="p">,</span> <span class="n">i_consensus_impossible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_consensus</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">consensus_anomalies</span><span class="p">[</span><span class="n">ts</span><span class="p">][</span><span class="s1">&#39;triggered&#39;</span><span class="p">],</span> <span class="p">[])</span>
                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: check_consensus failed for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="n">i_consensus_reached</span><span class="p">:</span>
                                            <span class="n">score</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_consensus_reached</span><span class="p">)</span>
                                            <span class="n">consensus_anomalies</span><span class="p">[</span><span class="n">ts</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
                                            <span class="n">anomalies</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ts</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;triggered&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">consensus_anomalies</span><span class="p">[</span><span class="n">ts</span><span class="p">][</span><span class="s1">&#39;triggered&#39;</span><span class="p">])}</span>
                                    <span class="n">consensus_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed building consensus_anomalies for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">consensus_anomalies</span><span class="p">:</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_results&#39;</span><span class="p">][</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_results&#39;</span><span class="p">][</span><span class="s1">&#39;anomaly_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomaly_window</span>
                            <span class="n">anomalies_in_window</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">consensus_scores</span><span class="p">[</span><span class="o">-</span><span class="n">anomaly_window</span><span class="p">:]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">])</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_results&#39;</span><span class="p">][</span><span class="s1">&#39;anomalies_in_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalies_in_window</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_results&#39;</span><span class="p">][</span><span class="s1">&#39;unreliable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_results&#39;</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_results&#39;</span><span class="p">][</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">consensus_scores</span><span class="p">)</span>
                            <span class="c1"># metric_data[&#39;results&#39;][&#39;consensus_results&#39;][&#39;consensus_anomalies&#39;] = copy.deepcopy(consensus_anomalies)</span>

                        <span class="n">ionosphere_enabled</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                        <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelled_metric_name</span>

                        <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="s1">&#39;save_training_data_on_false&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;save_training_data_on_false&#39;</span><span class="p">]:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: save_training_data_on_false pased for request_id: </span><span class="si">%s</span><span class="s1">, saving&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)))</span>
                                <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">trigger_anomaly</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: trigger_anomaly was passed for request_id: </span><span class="si">%s</span><span class="s1">, setting to anomalous&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)))</span>
                            <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalous</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalous</span>

                        <span class="k">if</span> <span class="n">algorithms_test_only</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: algorithms_test_only was passed for request_id: </span><span class="si">%s</span><span class="s1">, saving training_data&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)))</span>
                            <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">anomalous</span> <span class="ow">or</span> <span class="n">save_training_data</span><span class="p">:</span>
                            <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric_namespace_prefix&#39;</span><span class="p">]</span>
                            <span class="n">skyline_metric</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">labelled_metric</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">prefixed_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="n">possible_metric_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">labelled_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_labelled_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">labelled_metric</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">labelled_metric</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">server_id</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;server_id&#39;</span><span class="p">]</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">server_id</span> <span class="o">=</span> <span class="mi">1</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_labelled_metric_name</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_namespace_prefix</span><span class="p">,</span> <span class="n">server_id</span><span class="o">=</span><span class="n">server_id</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: generate_labelled_metric_name failed for request_id: </span><span class="si">%s</span><span class="s1"> metric: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                                <span class="n">possible_metric_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="n">labelled_metric</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">metric_namespace_prefix</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">):</span>
                                        <span class="n">prefixed_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                                        <span class="n">possible_metric_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefixed_metric</span><span class="p">)</span>

                            <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">possible_metric_name</span> <span class="ow">in</span> <span class="n">possible_metric_names</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="s1">&#39;mirage&#39;</span><span class="p">,</span> <span class="n">possible_metric_name</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="n">possible_metric_name</span>
                                    <span class="k">break</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">labelled_metric</span><span class="p">:</span>
                                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="n">labelled_metric_name</span>
                                    <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="n">prefixed_metric</span>
                                    <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: inserting new metric into DB for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">metric_id</span> <span class="o">=</span> <span class="n">insert_new_metric</span><span class="p">(</span><span class="s1">&#39;mirage&#39;</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: inserted new metric with id </span><span class="si">%s</span><span class="s1"> for request_id: </span><span class="si">%s</span><span class="s1">, metric: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)))</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: insert_new_metric failed for request_id: </span><span class="si">%s</span><span class="s1"> metric: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">skyline_metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">metric_id</span> <span class="ow">and</span> <span class="n">skyline_metric</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">labelled_metric</span><span class="p">:</span>
                                    <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;internal_metric_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skyline_metric</span>
                                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelled_metric_name</span>
                                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>

                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">ionosphere_enabled</span> <span class="o">=</span> <span class="n">get_ionosphere_fp_ids_for_full_duration</span><span class="p">(</span><span class="s1">&#39;mirage&#39;</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">,</span> <span class="n">full_duration</span><span class="o">=</span><span class="n">nearest_full_duration</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: get_ionosphere_fp_ids_for_full_duration failed for metric_id: </span><span class="si">%s</span><span class="s1"> request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: adding results for for request_id: </span><span class="si">%s</span><span class="s1"> and saving training_data&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to determine a metric_id or skyline_metric for request_id: </span><span class="si">%s</span><span class="s1"> metric: </span><span class="si">%s</span><span class="s1">, training_data will not be saved&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)))</span>
                        <span class="n">saved_training_data</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">if</span> <span class="n">save_training_data</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">trainable</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: not saving training_data for request_id: </span><span class="si">%s</span><span class="s1">, trainable: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trainable</span><span class="p">)))</span>
                                <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">send_to_ionosphere</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="s1">&#39;send_to_ionosphere&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">send_to_ionosphere</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;send_to_ionosphere&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">send_to_ionosphere</span><span class="p">:</span>
                                <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="c1"># @added 20230616 - Feature #4952: vortex - consensus_count</span>
                        <span class="k">if</span> <span class="n">consensus_count</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: adding consensus_count results for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)))</span>
                            <span class="n">consensus_count_anomalies</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">consensus_count_scores</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">consensus_count_algos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">consensus_count_results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
                                <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">triggered</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">algo</span> <span class="ow">in</span> <span class="n">consensus_count_algos</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">consensus_count_results</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;scores&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                            <span class="n">triggered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">consensus_count</span><span class="p">:</span>
                                    <span class="n">consensus_count_anomalies</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered</span><span class="p">),</span> <span class="s1">&#39;triggered&#39;</span><span class="p">:</span> <span class="n">triggered</span><span class="p">}</span>
                                    <span class="n">score</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered</span><span class="p">)</span>
                                <span class="n">consensus_count_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                            <span class="n">anomalies_in_window</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">consensus_count_scores</span><span class="p">[</span><span class="o">-</span><span class="n">anomaly_window</span><span class="p">:]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">])</span>
                            <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">anomalies_in_window</span><span class="p">:</span>
                                <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_count_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_count_results&#39;</span><span class="p">][</span><span class="s1">&#39;anomalous&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalous</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_count_results&#39;</span><span class="p">][</span><span class="s1">&#39;anomaly_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomaly_window</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_count_results&#39;</span><span class="p">][</span><span class="s1">&#39;anomalies_in_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalies_in_window</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_count_results&#39;</span><span class="p">][</span><span class="s1">&#39;unreliable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_count_results&#39;</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">consensus_count_anomalies</span><span class="p">)</span>
                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;consensus_count_results&#39;</span><span class="p">][</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">consensus_count_scores</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">return_image_urls</span><span class="p">:</span>
                            <span class="n">image_urls</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">full_duration_in_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;nearest_full_duration&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
                            <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">])</span>
                            <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">use_base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                            <span class="n">metric_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span>
                                <span class="n">timeseries_dir</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i_algorithm</span> <span class="ow">in</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms_run&#39;</span><span class="p">]:</span>
                                <span class="n">image_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/vortex.algorithm.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">h.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">i_algorithm</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_duration_in_hours</span><span class="p">))</span>
                                <span class="n">image_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere_images?image=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span>
                                <span class="n">image_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">consensus_anomalies</span><span class="p">:</span>
                                <span class="n">image_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/vortex.algorithm.consensus.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">h.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_duration_in_hours</span><span class="p">))</span>
                                <span class="n">image_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere_images?image=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span>
                                <span class="n">image_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>

                            <span class="c1"># @added 20230616 - Feature #4952: vortex - consensus_count</span>
                            <span class="k">if</span> <span class="n">consensus_count</span><span class="p">:</span>
                                <span class="n">image_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/vortex.algorithm.consensus_count.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">h.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_data_dir</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_duration_in_hours</span><span class="p">))</span>
                                <span class="n">image_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere_images?image=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span>
                                <span class="n">image_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>

                            <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;image_urls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_urls</span>

                        <span class="k">if</span> <span class="n">save_training_data</span><span class="p">:</span>
                            <span class="n">create_echo_data</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;full_duration&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">86400</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;analysis_period&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">86400</span><span class="p">:</span>
                                    <span class="n">create_echo_data</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">create_echo_data</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">created_echo_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_echo_timeseries</span><span class="p">(</span><span class="n">metric_data</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: create_echo_timeseries failed for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">created_echo_data</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: mirage_vortex :: create_echo_timeseries failed for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">request_id</span><span class="p">))</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">vortex_metric_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                                <span class="n">saved_training_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_training_data</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">vortex_metric_data</span><span class="p">,</span> <span class="n">use_timeseries</span><span class="p">,</span> <span class="n">ionosphere_enabled</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">saved_training_data</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: saved training_data for request_id: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="n">saved_training_data</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: failed to save training_data for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)))</span>
                                    <span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">del</span> <span class="n">vortex_metric_data</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: add_training_data failed for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">saved_training_data</span> <span class="ow">and</span> <span class="n">return_image_urls</span><span class="p">:</span>
                                <span class="n">image_urls</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">full_duration_in_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;nearest_full_duration&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i_algorithm</span> <span class="ow">in</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms_run&#39;</span><span class="p">]:</span>
                                    <span class="n">image_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/vortex.algorithm.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">h.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">saved_training_data</span><span class="p">,</span> <span class="n">i_algorithm</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_duration_in_hours</span><span class="p">))</span>
                                    <span class="n">image_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere_images?image=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span>
                                    <span class="n">image_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">consensus_anomalies</span><span class="p">:</span>
                                    <span class="n">image_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/vortex.algorithm.consensus.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">h.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">saved_training_data</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_duration_in_hours</span><span class="p">))</span>
                                    <span class="n">image_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere_images?image=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span>
                                    <span class="n">image_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>

                                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;image_urls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_urls</span>
                        <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;training_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saved_training_data</span>
                        <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;trainable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">add_results</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">trigger_anomaly</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: trigger_anomaly was passed for request_id: </span><span class="si">%s</span><span class="s1">, setting to send_to_ionosphere and ionosphere_enabled to False&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)))</span>
                            <span class="n">ionosphere_enabled</span> <span class="o">=</span> <span class="n">send_to_ionosphere</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">add_results</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">algorithms_test_only</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: algorithms_test_only was passed for request_id: </span><span class="si">%s</span><span class="s1">, setting to anomalous, send_to_ionosphere and ionosphere_enabled to False&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)))</span>
                            <span class="n">anomalous</span> <span class="o">=</span> <span class="n">ionosphere_enabled</span> <span class="o">=</span> <span class="n">send_to_ionosphere</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">add_results</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">ionosphere_enabled</span> <span class="ow">or</span> <span class="n">send_to_ionosphere</span><span class="p">:</span>
                            <span class="n">add_results</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="c1"># Send to ionosphere</span>
                            <span class="n">ionosphere_parent_id</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">labelled_metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                                <span class="n">send_anomalous_metric_to</span><span class="p">(</span>
                                    <span class="s1">&#39;mirage_vortex&#39;</span><span class="p">,</span> <span class="s1">&#39;ionosphere&#39;</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">,</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">labelled_metric_name</span><span class="p">,</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])),</span>
                                    <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span>
                                    <span class="n">nearest_full_duration</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_parent_id</span><span class="p">),</span>
                                    <span class="nb">list</span><span class="p">(</span><span class="n">algorithms_run</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                                <span class="n">sent_to_ionosphere</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: sent </span><span class="si">%s</span><span class="s1"> to ionosphere for request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">),</span> <span class="n">request_id</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: add_training_data failed for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">sent_to_ionosphere</span><span class="p">:</span>
                            <span class="n">metric_data_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/vortex.metric_data.</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">saved_training_data</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                            <span class="n">key_data</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s1">&#39;request_id&#39;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
                                <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">labelled_metric_name</span><span class="p">,</span>
                                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">metric_timestamp</span><span class="p">,</span>
                                <span class="s1">&#39;training_data&#39;</span><span class="p">:</span> <span class="n">saved_training_data</span><span class="p">,</span>
                                <span class="s1">&#39;metric_data_file&#39;</span><span class="p">:</span> <span class="n">metric_data_file</span><span class="p">,</span>
                                <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">],</span>
                            <span class="p">}</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;mirage_vortex.sent_to_ionosphere&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_data</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to add request_id: </span><span class="si">%s</span><span class="s1"> to mirage_vortex.sent_to_ionosphere - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">continue</span>

                        <span class="k">if</span> <span class="n">add_results</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">added_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">analysis_start_time</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: add_results failed for request_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">added_results</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processed request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">anomalous</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: anomaly detected - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">labelled_metric_name</span><span class="p">)</span>
                                <span class="c1"># If the metric has no features profiles and is anomalous</span>
                                <span class="c1"># add a panorama anomaly because Ionosphere will not add</span>
                                <span class="c1"># one.</span>
                                <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_enabled</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">:</span>
                                        <span class="n">send_to_panorama</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="n">send_to_panorama</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">sent_to_panorama</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_anomaly_to_panorama</span><span class="p">(</span>
                                            <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span>
                                            <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">algorithms_run</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: send_anomaly_to_panorama failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">err</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">sent_to_panorama</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: sent </span><span class="si">%s</span><span class="s1"> anomaly to panorama&#39;</span> <span class="o">%</span> <span class="n">labelled_metric_name</span><span class="p">)</span>
                                <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_illuminance</span><span class="p">(</span><span class="n">run_timestamp</span><span class="p">,</span> <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: add_illuminance_entries failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">err</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">current_illuminance_dict</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: added </span><span class="si">%s</span><span class="s1"> anomaly to illuminance&#39;</span> <span class="o">%</span> <span class="n">labelled_metric_name</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: adding </span><span class="si">%s</span><span class="s1"> to mirage_vortex.anomalous_metrics to be alerted on by mirage&#39;</span> <span class="o">%</span> <span class="n">labelled_metric_name</span><span class="p">)</span>
                                <span class="n">added_to_mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">added_to_mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_mirage_vortex_anomalous_metrics</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to hdel </span><span class="si">%s</span><span class="s1"> from mirage_vortex.sent_to_ionosphere - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: added mirage_vortex.anomalous_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">added_to_mirage_vortex_anomalous_metrics</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: algorithm </span><span class="si">%s</span><span class="s1"> failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s1">&#39;mirage_vortex.checks.done&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to increment mirage_vortex.checks.done Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20220420 - Feature #4530: namespace.analysed_events</span>
            <span class="n">parent_namespace</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric_namespace_prefix&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_namespace</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parent_namespace</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">date_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">gmtime</span><span class="p">()))</span>
            <span class="n">namespace_analysed_events_hash</span> <span class="o">=</span> <span class="s1">&#39;namespace.analysed_events.mirage.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">date_string</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hincrby</span><span class="p">(</span><span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">parent_namespace</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to increment </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">15</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: updated </span><span class="si">%s</span><span class="s1"> Redis hash&#39;</span> <span class="o">%</span> <span class="n">namespace_analysed_events_hash</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to set expire </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">added_results</span> <span class="ow">or</span> <span class="n">sent_to_ionosphere</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="n">completed_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">analysis_run_time</span> <span class="o">=</span> <span class="n">completed_at</span> <span class="o">-</span> <span class="n">process_start_timestamp</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: </span><span class="si">%s</span><span class="s1"> checks processed in in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">checks_processed</span><span class="p">),</span> <span class="n">analysis_run_time</span><span class="p">))</span></div>

<div class="viewcode-block" id="MirageVortex.run"><a class="viewcode-back" href="../../skyline.mirage.html#mirage.mirage_vortex.MirageVortex.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the process intializes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Log management to prevent overwriting</span>
        <span class="c1"># Allow the bin/&lt;skyline_app&gt;.d to manage the log</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logwait</span><span class="p">)</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">log_wait_for</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="k">while</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">log_wait_for</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">log_wait_for</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: starting </span><span class="si">%s</span><span class="s1"> run&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>

        <span class="n">last_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
        <span class="n">filesafe_names_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">last_sleep_log</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="c1"># Make sure Redis is up</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: skyline can not connect to redis at socket path </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: attempting to connect to redis at socket path </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to connect to Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: connected to redis&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to ping Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># Determine if any metric to analyze or Ionosphere alerts to be sent</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

                <span class="c1"># Report app up</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_is_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">redis_is_up</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: could not update the Redis redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">e</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to update Redis key for </span><span class="si">%s</span><span class="s1"> up - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

                <span class="n">items_to_analyse</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ionosphere_results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">return_results_for</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items_to_analyse</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ionosphere_results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">return_results_for</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sleep_for</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">next_send_to_graphite</span> <span class="o">=</span> <span class="n">last_sent_to_graphite</span> <span class="o">+</span> <span class="mi">60</span>
                    <span class="n">seconds_to_next_send_to_graphite</span> <span class="o">=</span> <span class="n">next_send_to_graphite</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">seconds_to_next_send_to_graphite</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">seconds_to_next_send_to_graphite</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">sleep_for</span> <span class="o">=</span> <span class="n">seconds_to_next_send_to_graphite</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">last_sleep_log</span> <span class="o">+</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: sleeping no metrics...&#39;</span><span class="p">)</span>
                        <span class="n">last_sleep_log</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="n">sleep_for</span><span class="p">)</span>

                <span class="c1"># Return results that are about to timeout</span>
                <span class="n">return_results_for</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">mirage_vortex_sent_to_ionosphere</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">c_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mirage_vortex_sent_to_ionosphere</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;mirage_vortex.sent_to_ionosphere&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: hkeys failed on ionosphere.vortex_results - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">request_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mirage_vortex_sent_to_ionosphere</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mirage_vortex_sent_to_ionosphere</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">][</span><span class="s1">&#39;timeout&#39;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">timeout</span> <span class="o">=</span> <span class="mi">55</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sent_timestamp_str</span> <span class="o">=</span> <span class="n">request_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">sent_timestamp_str</span> <span class="o">=</span> <span class="s1">&#39;60&#39;</span>
                    <span class="k">if</span> <span class="n">c_time</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sent_timestamp_str</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">timeout</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)):</span>
                        <span class="n">return_results_for</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mirage_vortex_sent_to_ionosphere</span><span class="p">[</span><span class="n">request_id</span><span class="p">])</span>

                <span class="c1"># Send ionosphere results</span>
                <span class="n">ionosphere_results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">return_results_for</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ionosphere_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hkeys</span><span class="p">(</span><span class="s1">&#39;ionosphere.vortex_results&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: hkeys failed on failed ionosphere.vortex_results - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># Get added checks</span>
                <span class="n">items_to_analyse</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">return_results_for</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ionosphere_results</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">items_to_analyse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hkeys</span><span class="p">(</span><span class="s1">&#39;flux.vortex&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: hkeys failed on failed flux.vortex - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items_to_analyse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ionosphere_results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">return_results_for</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">process_metric_checks</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">items_to_analyse</span><span class="p">:</span>
                <span class="n">items_to_analyse_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">items_to_analyse</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">items_to_analyse_sorted</span><span class="p">:</span>
                    <span class="n">process_metric_checks</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">process_metric_checks</span> <span class="ow">or</span> <span class="n">ionosphere_results</span> <span class="ow">or</span> <span class="n">return_results_for</span><span class="p">:</span>

                <span class="c1"># @added 20200903 - Task #3730: Validate Mirage running multiple processes</span>
                <span class="n">checks_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items_to_analyse_sorted</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">items_to_analyse</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: </span><span class="si">%s</span><span class="s1"> checks to process&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">checks_to_process</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">ionosphere_results</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: </span><span class="si">%s</span><span class="s1"> ionosphere_results to process&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ionosphere_results</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">return_results_for</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: returning results for </span><span class="si">%s</span><span class="s1"> request_ids about to timeout&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_results_for</span><span class="p">)))</span>

                <span class="c1"># Remove any existing algorithm.error files from any previous runs</span>
                <span class="c1"># that did not cleanup for any reason</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.*.algorithm.error&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: cleaning up old error file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>
                            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                <span class="k">pass</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to cleanup mirage_algorithm.error files - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>

                <span class="c1"># Spawn processes</span>
                <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items_to_analyse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_PROCESSES</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items_to_analyse</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIRAGE_PROCESSES</span><span class="p">:</span>
                            <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items_to_analyse</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">MIRAGE_PROCESSES</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">run_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">MIRAGE_PROCESSES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

                    <span class="n">assigned_checks</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">items_to_analyse</span><span class="p">:</span>
                        <span class="n">checks_per_processor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items_to_analyse_sorted</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">MIRAGE_PROCESSES</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">MIRAGE_PROCESSES</span><span class="p">:</span>
                            <span class="n">assigned_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items_to_analyse_sorted</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">assigned_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items_to_analyse_sorted</span><span class="p">),</span> <span class="n">i</span> <span class="o">*</span> <span class="n">checks_per_processor</span><span class="p">)</span>
                        <span class="n">assigned_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">checks_per_processor</span>
                        <span class="n">assigned_keys</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">assigned_min</span><span class="p">,</span> <span class="n">assigned_max</span><span class="p">)</span>
                        <span class="c1"># Compile assigned metrics</span>
                        <span class="n">assigned_checks</span> <span class="o">=</span> <span class="p">[</span><span class="n">items_to_analyse_sorted</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">assigned_keys</span><span class="p">]</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processing </span><span class="si">%s</span><span class="s1"> checks&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_checks</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">ionosphere_results</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: processing </span><span class="si">%s</span><span class="s1"> ionosphere_results&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ionosphere_results</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">return_results_for</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: returning </span><span class="si">%s</span><span class="s1"> results&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_results_for</span><span class="p">)))</span>

                    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin_process</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">run_timestamp</span><span class="p">,</span> <span class="n">assigned_checks</span><span class="p">,</span> <span class="n">ionosphere_results</span><span class="p">,</span> <span class="n">return_results_for</span><span class="p">))</span>

                    <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: starting </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> spin_process/es&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">pid_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">MIRAGE_PROCESSES</span><span class="p">)))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: started spin_process </span><span class="si">%s</span><span class="s1"> with pid </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pid_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)))</span>

                <span class="c1"># Self monitor processes and terminate if any spin_process has run</span>
                <span class="c1"># for longer than 180 seconds - 20160512 @earthgecko</span>
                <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MAX_ANALYZER_PROCESS_RUNTIME</span> <span class="o">*</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                        <span class="c1"># Just to avoid hogging the CPU</span>
                        <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># All the processes are done, break now.</span>
                        <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: </span><span class="si">%s</span><span class="s1"> :: </span><span class="si">%s</span><span class="s1"> spin_process/es completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">MIRAGE_PROCESSES</span><span class="p">),</span> <span class="n">time_to_run</span><span class="p">))</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: </span><span class="si">%s</span><span class="s1"> :: timed out, killing all spin_process processes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                        <span class="c1"># p.join()</span>

                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: </span><span class="si">%s</span><span class="s1"> :: stopping spin_process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())))</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                <span class="c1"># @added 20200607 - Feature #3508: ionosphere.untrainable_metrics</span>
                <span class="c1"># Check to non 3sigma algorithm errors too</span>
                <span class="n">check_algorithm_errors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;negatives_present&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_ALGORITHMS</span><span class="p">):</span>
                    <span class="n">check_algorithm_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">completed_pid</span><span class="p">,</span> <span class="n">mirage_process</span> <span class="ow">in</span> <span class="n">spawned_pids</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: spin_process with pid </span><span class="si">%s</span><span class="s1"> completed&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">completed_pid</span><span class="p">)))</span>
                    <span class="c1"># Check to non 3sigma algorithm errors too and wrapped in try</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># for algorithm in settings.MIRAGE_ALGORITHMS:</span>
                        <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">check_algorithm_errors</span><span class="p">:</span>
                            <span class="n">algorithm_error_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.algorithm.error&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">completed_pid</span><span class="p">),</span> <span class="n">algorithm</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">algorithm_error_file</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s1">&#39;error :: mirage_vortex :: spin_process with pid </span><span class="si">%s</span><span class="s1"> has reported an error with the </span><span class="si">%s</span><span class="s1"> algorithm&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">completed_pid</span><span class="p">),</span> <span class="n">algorithm</span><span class="p">))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">algorithm_error_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                        <span class="n">error_string</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to read </span><span class="si">%s</span><span class="s1"> error file&#39;</span> <span class="o">%</span> <span class="n">algorithm</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">algorithm_error_file</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to check algorithm errors&#39;</span><span class="p">)</span>

                    <span class="n">redis_metrics_processed_key</span> <span class="o">=</span> <span class="s1">&#39;mirage_vortex.</span><span class="si">%s</span><span class="s1">.metrics_processed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">mirage_process</span><span class="p">)</span>
                    <span class="n">redis_metrics_processed</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_metrics_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_metrics_processed_key</span><span class="p">)</span>
                        <span class="c1"># if redis_metrics_processed:</span>
                        <span class="c1">#     self.redis_conn_decoded.delete(redis_metrics_processed_key)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: </span><span class="si">%s</span><span class="s1"> Redis hash operation failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_metrics_processed_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">items_to_analyse</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: process </span><span class="si">%s</span><span class="s1"> checked </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">mirage_process</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">redis_metrics_processed</span><span class="p">))))</span>

                    <span class="c1"># Remove checks from flux.vortex</span>
                    <span class="k">if</span> <span class="n">redis_metrics_processed</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;flux.vortex&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">redis_metrics_processed</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: hdel on flux.vortex failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="n">mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">literal_mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage_vortex.anomalous_metrics&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">metric_list_string</span> <span class="ow">in</span> <span class="n">literal_mirage_vortex_anomalous_metrics</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">metric_list_string</span><span class="p">)</span>
                    <span class="n">mirage_vortex_anomalous_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to determine list from mirage_vortex.anomalous_metrics Redis set&#39;</span><span class="p">)</span>
                <span class="n">mirage_vortex_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">mirage_not_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">literal_mirage_not_anomalous_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage_vortex.not_anomalous_metrics&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">metric_list_string</span> <span class="ow">in</span> <span class="n">literal_mirage_not_anomalous_metrics</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">metric_list_string</span><span class="p">)</span>
                    <span class="n">mirage_not_anomalous_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to determine list from mirage_vortex.not_anomalous_metrics Redis set&#39;</span><span class="p">)</span>
                <span class="n">mirage_not_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Log progress</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: total anomalies    :: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">mirage_vortex_anomalous_metrics</span><span class="p">))</span>

            <span class="c1"># Log to Graphite</span>
            <span class="k">if</span> <span class="n">process_metric_checks</span><span class="p">:</span>
                <span class="n">run_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">run_timestamp</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: seconds to run    :: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">run_time</span><span class="p">)</span>
                <span class="n">graphite_run_time</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">run_time</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="n">skyline_app_graphite_namespace</span> <span class="o">+</span> <span class="s1">&#39;.run_time&#39;</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="n">graphite_run_time</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">last_sent_to_graphite</span> <span class="o">+</span> <span class="mi">60</span><span class="p">):</span>
                <span class="n">checks_done</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20230205 - Task #4844: Replace Redis getset with set with get</span>
                    <span class="c1"># As of Redis version 6.2.0, this command is regarded as deprecated.</span>
                    <span class="c1"># It can be replaced by SET with the GET argument when migrating or writing new code.</span>
                    <span class="c1"># checks_done_str = self.redis_conn_decoded.getset(&#39;mirage_vortex.checks.done&#39;, 0)</span>
                    <span class="n">checks_done_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;mirage_vortex.checks.done&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">checks_done_str</span><span class="p">:</span>
                        <span class="n">checks_done</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">checks_done_str</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_vortex :: failed to get mirage_vortex.checks.done key from Redis&#39;</span><span class="p">)</span>
                    <span class="n">checks_done</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: checks.done   :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">checks_done</span><span class="p">))</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.checks.done&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">checks_done</span><span class="p">))</span>

                <span class="n">last_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

            <span class="c1"># Sleep if it went too fast</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="mi">59</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_vortex :: sleeping due to low run time...&#39;</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>