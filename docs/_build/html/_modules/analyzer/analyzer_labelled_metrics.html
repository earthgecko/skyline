<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>analyzer.analyzer_labelled_metrics &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">analyzer.analyzer_labelled_metrics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for analyzer.analyzer_labelled_metrics</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">analyzer_labelled_metrics.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="c1"># from redis import StrictRedis</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">strftime</span><span class="p">,</span> <span class="n">gmtime</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
<span class="c1"># Use Redis sets in place of Manager().list to reduce memory and number of</span>
<span class="c1"># processes</span>
<span class="c1"># from multiprocessing import Process, Manager, Queue</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">kill</span><span class="p">,</span> <span class="n">getpid</span>
<span class="kn">from</span> <span class="nn">signal</span> <span class="kn">import</span> <span class="n">SIGKILL</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">exit</span> <span class="k">as</span> <span class="n">sys_exit</span>
<span class="kn">import</span> <span class="nn">resource</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="c1"># @added 20220722 - Task #4624: Change all dict copy to deepcopy</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">memray</span>

<span class="kn">from</span> <span class="nn">prometheus_client.parser</span> <span class="kn">import</span> <span class="n">_parse_labels</span> <span class="k">as</span> <span class="n">parse_labels</span>

<span class="kn">import</span> <span class="nn">settings</span>
<span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">nonNegativeDerivative</span><span class="p">,</span> <span class="n">get_redis_conn</span><span class="p">,</span> <span class="n">get_redis_conn_decoded</span><span class="p">,</span>
    <span class="n">write_data_to_file</span><span class="p">)</span>

<span class="c1"># @added 20200425 - Feature #3512: matched_or_regexed_in_list function</span>
<span class="c1">#                   Feature #3508: ionosphere.untrainable_metrics</span>
<span class="c1">#                   Feature #3486: analyzer_batch</span>
<span class="kn">from</span> <span class="nn">matched_or_regexed_in_list</span> <span class="kn">import</span> <span class="n">matched_or_regexed_in_list</span>

<span class="kn">from</span> <span class="nn">alerters</span> <span class="kn">import</span> <span class="n">trigger_alert</span>
<span class="kn">from</span> <span class="nn">algorithms</span> <span class="kn">import</span> <span class="n">run_selected_algorithm</span>
<span class="kn">from</span> <span class="nn">algorithm_exceptions</span> <span class="kn">import</span> <span class="n">TooShort</span><span class="p">,</span> <span class="n">Stale</span><span class="p">,</span> <span class="n">Boring</span><span class="p">,</span> <span class="n">EmptyTimeseries</span>

<span class="kn">from</span> <span class="nn">functions.illuminance.add_illuminance_entries</span> <span class="kn">import</span> <span class="n">add_illuminance_entries</span>
<span class="c1"># from functions.prometheus.metric_name_labels_parser import metric_name_labels_parser</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.downsample</span> <span class="kn">import</span> <span class="n">downsample_timeseries</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.is_stationary</span> <span class="kn">import</span> <span class="n">is_stationary</span>

<span class="kn">from</span> <span class="nn">functions.graphite.send_graphite_metric</span> <span class="kn">import</span> <span class="n">send_graphite_metric</span>
<span class="kn">from</span> <span class="nn">functions.metrics.get_metric_id_from_base_name</span> <span class="kn">import</span> <span class="n">get_metric_id_from_base_name</span>

<span class="kn">from</span> <span class="nn">functions.timeseries.strictly_increasing_monotonicity</span> <span class="kn">import</span> <span class="n">strictly_increasing_monotonicity</span>

<span class="c1"># @added 20230329 - Feature #4882: labelled_metrics - resolution and data sparsity</span>
<span class="c1">#                   Feature #3870: metrics_manager - check_data_sparsity</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.determine_data_frequency</span> <span class="kn">import</span> <span class="n">determine_data_frequency</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.determine_data_sparsity</span> <span class="kn">import</span> <span class="n">determine_data_sparsity</span>

<span class="c1"># @added 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
<span class="kn">from</span> <span class="nn">functions.analyzer.get_tenant_id_mrange_split</span> <span class="kn">import</span> <span class="n">get_tenant_id_mrange_split</span>

<span class="n">send_algorithm_run_metrics</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;analyzer&#39;</span>
<span class="n">skyline_app_thunder_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics&#39;</span>

<span class="n">skyline_app_logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Log&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
<span class="n">skyline_app_logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
<span class="n">skyline_app_loglock</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">skyline_app_logwait</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wait&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>

<span class="n">this_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">ANALYZER_LABELLED_METRICS_PROCESSES</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_LABELLED_METRICS_PROCESSES</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ANALYZER_LABELLED_METRICS_PROCESSES</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">MAX_ANALYZER_LABELLED_METRICS_PROCESS_RUNTIME</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAX_ANALYZER_LABELLED_METRICS_PROCESS_RUNTIME</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MAX_ANALYZER_LABELLED_METRICS_PROCESS_RUNTIME</span> <span class="o">=</span> <span class="mi">180</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
    <span class="k">if</span> <span class="n">SERVER_METRIC_PATH</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">ANALYZER_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_ENABLED</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ANALYZER_ENABLED is set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ANALYZER_ENABLED</span><span class="p">))</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ANALYZER_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;warning :: ANALYZER_ENABLED is not declared in settings.py, defaults to True&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
    <span class="c1"># CUSTOM_ALGORITHMS = settings.CUSTOM_ALGORITHMS.copy()</span>
    <span class="n">CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CUSTOM_ALGORITHMS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">DEBUG_CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG_CUSTOM_ALGORITHMS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">DEBUG_CUSTOM_ALGORITHMS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">VERBOSE_LOGGING</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_VERBOSE_LOGGING</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VERBOSE_LOGGING</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20210513 - Feature #4068: ANALYZER_SKIP</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ANALYZER_SKIP</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_SKIP</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ANALYZER_SKIP</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20210519 - Feature #4076: CUSTOM_STALE_PERIOD</span>
<span class="n">custom_stale_metrics_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics_manager.custom_stale_periods&#39;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
    <span class="c1"># CUSTOM_STALE_PERIOD = settings.CUSTOM_STALE_PERIOD.copy()</span>
    <span class="n">CUSTOM_STALE_PERIOD</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CUSTOM_STALE_PERIOD</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">CUSTOM_STALE_PERIOD</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
<span class="n">LOAD_SHEDDING_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">LOAD_SHEDDING_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOAD_SHEDDING_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">LOAD_SHEDDING_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">skyline_app_graphite_namespace</span> <span class="o">=</span> <span class="s1">&#39;skyline.</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">SERVER_METRIC_PATH</span><span class="p">)</span>

<span class="n">LOCAL_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20191107 - Branch #3262: py3</span>
<span class="n">alert_test_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_alert_test.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>

<span class="c1"># In Skyline a metric is either a counter (derivative) or a gauge</span>
<span class="n">skyline_metric_types</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">skyline_metric_types_by_id</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">skyline_metric_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">skyline_metric_types_by_id</span><span class="p">[</span><span class="n">skyline_metric_types</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">key</span>

<span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
<span class="n">metrics_last_analysis_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.metrics.last_analysis_timestamp&#39;</span>


<div class="viewcode-block" id="AnalyzerLabelledMetrics"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.analyzer_labelled_metrics.AnalyzerLabelledMetrics">[docs]</a><span class="k">class</span> <span class="nc">AnalyzerLabelledMetrics</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The AnalyzerLabelledMetrics class which controls the analyzer_labelled_metrics</span>
<span class="sd">    thread and spawned processes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_pid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the AnalyzerLabelledMetrics</span>

<span class="sd">        Create the :obj:`self.exceptions_q` queue</span>
<span class="sd">        Create the :obj:`self.anomaly_breakdown_q` queue</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># super(AnalyzerLabelledMetrics, self).__init__()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span> <span class="o">=</span> <span class="n">parent_pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exceptions_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anomaly_breakdown_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_metrics_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

<div class="viewcode-block" id="AnalyzerLabelledMetrics.check_if_parent_is_alive"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.analyzer_labelled_metrics.AnalyzerLabelledMetrics.check_if_parent_is_alive">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_parent_is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Self explanatory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: parent or current process dead&#39;</span><span class="p">)</span>
            <span class="n">sys_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnalyzerLabelledMetrics.spawn_alerter_process"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.analyzer_labelled_metrics.AnalyzerLabelledMetrics.spawn_alerter_process">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_alerter_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a process to trigger an alert.</span>

<span class="sd">        This is used by smtp alerters so that matplotlib objects are cleared</span>
<span class="sd">        down and the alerter cannot create a memory leak in this manner and</span>
<span class="sd">        plt.savefig keeps the object in memory until the process terminates.</span>
<span class="sd">        Seeing as data is being surfaced and processed in the alert_smtp</span>
<span class="sd">        context, multiprocessing the alert creation and handling prevents any</span>
<span class="sd">        memory leaks in the parent.</span>

<span class="sd">        Added 20160814 relating to:</span>

<span class="sd">        * Bug #1558: Memory leak in Analyzer</span>
<span class="sd">        * Issue #21 Memory leak in Analyzer see https://github.com/earthgecko/skyline/issues/21</span>

<span class="sd">        Parameters as per :py:func:`skyline.analyzer.alerters.trigger_alert</span>
<span class="sd">        &lt;analyzer.alerters.trigger_alert&gt;`</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trigger_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

    <span class="c1"># Although this could be imported by functions.prometheus.metric_name_labels_parser</span>
    <span class="c1"># memray highlights that the import method generates 1000s of allocations</span>
    <span class="c1"># whereas defined locally incurs none.</span>
<div class="viewcode-block" id="AnalyzerLabelledMetrics.metric_name_labels_parser"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.analyzer_labelled_metrics.AnalyzerLabelledMetrics.metric_name_labels_parser">[docs]</a>    <span class="k">def</span> <span class="nf">metric_name_labels_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a Prometheus metric string return a dict of the metric name and labels.</span>
<span class="sd">        :param metric: the prometheus metric</span>
<span class="sd">        :type metric: str</span>
<span class="sd">        :return: metric_dict</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metric_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_elements</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">metric_labels_str</span> <span class="o">=</span> <span class="n">metric_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">metric_labels</span> <span class="o">=</span> <span class="n">metric_labels_str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to parse metric </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">metric_dict</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">parse_labels</span><span class="p">(</span><span class="n">metric_labels</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to parse labels </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">metric_dict</span>
        <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_name</span>
        <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="k">return</span> <span class="n">metric_dict</span></div>

    <span class="c1"># @modified 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
    <span class="c1"># Added filters</span>
<div class="viewcode-block" id="AnalyzerLabelledMetrics.labelled_metrics_spin_process"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.analyzer_labelled_metrics.AnalyzerLabelledMetrics.labelled_metrics_spin_process">[docs]</a>    <span class="k">def</span> <span class="nf">labelled_metrics_spin_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_process</span><span class="p">,</span> <span class="n">assigned_metrics_dict</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign a bunch of metrics for a process to analyze.</span>

<span class="sd">        Multiple get the assigned_metrics to the process from Redis.</span>

<span class="sd">        For each metric:</span>

<span class="sd">        - unpack the `raw_timeseries` for the metric.</span>
<span class="sd">        - Analyse each timeseries against `ALGORITHMS` to determine if it is</span>
<span class="sd">          anomalous.</span>
<span class="sd">        - If anomalous add it to the Redis set analyzer.anomalous_metrics</span>
<span class="sd">        - Add what algorithms triggered to the :obj:`self.anomaly_breakdown_q`</span>
<span class="sd">          queue</span>
<span class="sd">        - If :mod:`settings.ENABLE_CRUCIBLE` is ``True``:</span>

<span class="sd">          - Add a crucible data file with the details about the timeseries and</span>
<span class="sd">            anomaly.</span>
<span class="sd">          - Write the timeseries to a json file for crucible.</span>

<span class="sd">        Add keys and values to the queue so the parent process can collate for:\n</span>
<span class="sd">        * :py:obj:`self.anomaly_breakdown_q`</span>
<span class="sd">        * :py:obj:`self.exceptions_q`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">memray_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/analyzer_labelled_metrics.labelled_metrics_spin_process.</span><span class="si">%s</span><span class="s1">.bin&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_process</span><span class="p">))</span>
        <span class="n">memray_file_last</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.last&#39;</span> <span class="o">%</span> <span class="n">memray_file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">memray_file_last</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">memray_file_last</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: removed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">memray_file_last</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">memray_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">memray_file</span><span class="p">,</span> <span class="n">memray_file_last</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: removed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">memray_file_last</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">memray</span><span class="o">.</span><span class="n">Tracker</span><span class="p">(</span><span class="n">memray_file</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">median_absolute_deviation</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">])</span>
                        <span class="n">median</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                        <span class="n">demedianed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">series</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span>
                        <span class="n">median_deviation</span> <span class="o">=</span> <span class="n">demedianed</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">median_deviation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test_statistic</span> <span class="o">=</span> <span class="n">demedianed</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">median_deviation</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">test_statistic</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">spin_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: started process </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_process</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: getting spin_start time failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                    <span class="n">spin_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

                <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span>
                <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">until_timestamp</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span>
                <span class="n">current_aligned_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                <span class="n">metric_airgaps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">metric_airgaps_filled</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">run_negatives_present</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">check_for_airgaps_only</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">custom_stale_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># @added 20230401 - Feature #4886: analyzer - operation_timings</span>
                <span class="c1"># Only sadd once</span>
                <span class="n">identified_boring_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">identified_stale_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">identified_tooshort_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">last_reported_up</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">last_reported_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_reported_up</span><span class="p">:</span>
                        <span class="n">last_reported_up</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">last_reported_up</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">last_reported_up</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: Analyzer could not update the Redis </span><span class="si">%s</span><span class="s1"> key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>

                <span class="c1"># Check the unique_labelled_metrics list is valid</span>
                <span class="n">assigned_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assigned_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="c1"># @added 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
                <span class="c1"># Added filters</span>
                <span class="n">filters_str</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">filters</span><span class="p">:</span>
                    <span class="n">filters_str</span> <span class="o">=</span> <span class="s1">&#39;_tenant_id=(&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

                <span class="c1"># @added 20220504 - Feature #2580: illuminance</span>
                <span class="n">illuminance_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># @added 20220919 - Feature #4676: analyzer - illuminance.all key</span>
                <span class="n">illuminance_all_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">algorithms</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">algorithms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.algorithms.ids&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: hgetall metrics_manager.algorithms.ids - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20210513 - Feature #4068: ANALYZER_SKIP</span>
                <span class="n">analyzer_skip_metrics_skipped</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">analyzer_skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">ANALYZER_SKIP</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: determining ANALYZER_SKIP metrics from analyzer.metrics_manager.analyzer_skip Redis set&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">analyzer_skip_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.analyzer_skip&#39;</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to generate a list from analyzer.metrics_manager.analyzer_skip Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="n">analyzer_skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">analyzer_skip_metrics</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: removing </span><span class="si">%s</span><span class="s1"> ANALYZER_SKIP metrics from the </span><span class="si">%s</span><span class="s1"> assigned_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">analyzer_skip_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)))</span>
                        <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_labelled_metrics</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">analyzer_skip_metrics</span><span class="p">))</span>
                        <span class="n">analyzer_skip_metrics_skipped</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">analyzer_skip_metrics</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: did not determine any ANALYZER_SKIP metrics from from analyzer.metrics_manager.analyzer_skip Redis set, will check dynamically&#39;</span><span class="p">)</span>

                <span class="c1"># @added 20190410 - Feature #2916: ANALYZER_ENABLED setting</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ANALYZER_ENABLED</span><span class="p">:</span>
                    <span class="c1"># len_assigned_metrics = len(assigned_metrics)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: ANALYZER_ENABLED is set to </span><span class="si">%s</span><span class="s1"> removing the </span><span class="si">%s</span><span class="s1"> assigned_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">ANALYZER_ENABLED</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">))))</span>
                    <span class="n">assigned_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">del</span> <span class="n">unique_labelled_metrics</span>

                <span class="c1"># Check if this process is unnecessary</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: 0 assigned metrics, nothing to do&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="n">run_selected_algorithm_count</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Make process-specific dicts</span>
                <span class="n">exceptions</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">anomaly_breakdown</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

                <span class="c1"># Surface the last_timeseries_timestamp Redis hash key so that the</span>
                <span class="c1"># timestamps can be compared as Thunder stale_metrics requires all</span>
                <span class="c1"># timestamps for all metrics</span>
                <span class="n">metrics_last_timeseries_timestamp_update_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">metrics_last_timeseries_timestamp_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.last_timeseries_timestamp&#39;</span>

                <span class="n">metrics_stationary_update_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">metrics_stationary_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.stationary_metrics&#39;</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: checking </span><span class="si">%s</span><span class="s1"> assigned_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)))</span>

                <span class="n">metric_type_redis_keys</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tenant_ids</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">metrics_checked</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">metrics_analysed</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">metrics_skipped</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mad_analysed</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mad_anomalies</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">anomalies</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">no_anomalies</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">stationary</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">not_stationary</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">stationary_not_expired</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">redis_timings</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">redis_full_duration_timings</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">stationary_timings</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">mad_timings</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">downsample_timings</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">threesigma_timings</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">last_analysed_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">last_analysed_metric</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">mad_anomalous_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">threesigma_anomalous_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">stale_metrics</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">empty_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">no_new_data_metrics</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tooshort_metrics</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">not_anomalous_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">empty_timeseries_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">boring_dict</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">used_metric_id_keys</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">metric_types_known</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;known&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;looked_up&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;known&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;looked_up&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;SUMMARY&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;known&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;looked_up&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;HISTOGRAM&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;known&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;looked_up&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;UNKNOWN&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;known&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;looked_up&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">}</span>

                <span class="n">metric_subtypes_added</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;SUMMARY&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;HISTOGRAM&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;UNKNOWN&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">}</span>
                <span class="n">metric_subtypes_queried</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;SUMMARY&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;HISTOGRAM&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;UNKNOWN&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">}</span>

                <span class="n">monotonicity_not_expired</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">monotonicity_checked</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">monotonicity_check_per_minute</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">monotonicity_changed</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">metrics_type_dict</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># @added 20230309 - Feature #4864: analyzer_labelled_metrics - exceptions metrics set</span>
                <span class="n">redis_set_errors</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># @added 20221229 - Bug #4766: analyzer_labelled_metrics - monotonicity checked incorrect classification</span>
                <span class="c1"># Fetch the data once because with 1000s of new metrics added it</span>
                <span class="c1"># becomes more efficient</span>
                <span class="n">skyline_labelled_metrics_id_types</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">skyline_labelled_metrics_id_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to hgetall skyline.labelled_metrics.id.type - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># @added 20230518 - metric_type.longterm_expire</span>
                <span class="n">skyline_labelled_metrics_id_types_longterm_expire</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">skyline_labelled_metrics_id_types_longterm_expire</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type.longterm_expire&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to hgetall skyline.labelled_metrics.id.type.longterm_expire - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># @added 20230329 - Feature #4882: labelled_metrics - resolution and data sparsity</span>
                <span class="c1">#                   Feature #3870: metrics_manager - check_data_sparsity</span>
                <span class="n">resolution_and_sparsity_timings</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">labelled_metrics_resolutions</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">labelled_metrics_sparsity</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">labelled_metrics_resolution_sparsity_last_checked_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">labelled_metrics_resolution_sparsity_checked_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">labelled_metrics_resolution_sparsity_recently_checked</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">labelled_metrics_resolution_sparsity_last_checked_hash_key</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.resolution_sparsity_last_checked&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">labelled_metrics_resolution_sparsity_last_checked_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">labelled_metrics_resolution_sparsity_last_checked_hash_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to hgetall </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">labelled_metrics_resolution_sparsity_last_checked_hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">labelled_metrics_resolution_sparsity_last_checked_dict</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                <span class="n">analyzer_last_run_time</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">analyzer_last_run_time_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span>
                <span class="n">load_shedding_active</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">LOAD_SHEDDING_ENABLED</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_active - checking&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">analyzer_last_run_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.run_time&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">))</span>
                        <span class="n">analyzer_last_run_time_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.run_time&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: load_shedding_active failed to get keys from analyzer.run_time Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="n">analyzer_last_run_time</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">analyzer_last_run_time_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">analyzer_last_run_time</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MAX_ANALYZER_PROCESS_RUNTIME</span> <span class="o">-</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">load_shedding_active</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_active set to True because analyzer_last_run_time: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">analyzer_last_run_time</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">analyzer_last_run_time_timestamp</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MAX_ANALYZER_PROCESS_RUNTIME</span> <span class="o">+</span> <span class="mi">30</span><span class="p">)):</span>
                        <span class="n">load_shedding_active</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_active set to True because analyzer_last_run_time_timestamp is older than </span><span class="si">% s</span><span class="s1">econds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">analyzer_last_run_time_timestamp</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_active: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">load_shedding_active</span><span class="p">))</span>
                <span class="n">last_analysed_ordered_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">load_shedding_assigned_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">metrics_last_analysis_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># If the load_shedding hash exist keep updating it until it expires and</span>
                <span class="c1"># does not exist.  If it exists but load_shedding_active is not True the</span>
                <span class="c1"># hash expiry does not get updated it only gets updated if</span>
                <span class="c1"># load_shedding_active is True.  This is so that if load_shedding becomes</span>
                <span class="c1"># active on 1 run, but is not active on the next run the hash last</span>
                <span class="c1"># analysis times are still updated for another 4 minutes so that if</span>
                <span class="c1"># load_shedding becomes active in the next 4 minutes, it is not starting</span>
                <span class="c1"># from scratch and will have data to do an ordered analysis on.</span>
                <span class="n">load_shedding_hash_exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">last_metrics_last_analysis_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">load_shedding_hash_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metrics_last_analysis_hash_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: load_shedding_active failed to hgetall </span><span class="si">%s</span><span class="s1"> from Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metrics_last_analysis_hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">load_shedding_active</span> <span class="ow">or</span> <span class="n">load_shedding_hash_exists</span><span class="p">:</span>
                    <span class="n">start_load_shedding_get</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="n">log_str</span> <span class="o">=</span> <span class="s1">&#39;load shedding hash exists&#39;</span>
                    <span class="k">if</span> <span class="n">load_shedding_active</span><span class="p">:</span>
                        <span class="n">log_str</span> <span class="o">=</span> <span class="s1">&#39;load_shedding_active&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">last_metrics_last_analysis_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">metrics_last_analysis_hash_key</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: </span><span class="si">%s</span><span class="s1"> got </span><span class="si">%s</span><span class="s1"> metrics last analysed timestamps from </span><span class="si">%s</span><span class="s1"> to reorder </span><span class="si">%s</span><span class="s1"> assigned_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">log_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last_metrics_last_analysis_dict</span><span class="p">)),</span> <span class="n">metrics_last_analysis_hash_key</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">))))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: load_shedding_active failed to hgetall </span><span class="si">%s</span><span class="s1"> from Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metrics_last_analysis_hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">load_shedding_active</span><span class="p">:</span>
                    <span class="n">start_load_shedding_get</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="n">assigned_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">assigned_labelled_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">assigned_metrics</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                        <span class="n">assigned_labelled_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>
                        <span class="n">assigned_labelled_metrics_dict</span><span class="p">[</span><span class="n">labelled_metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span>
                    <span class="k">if</span> <span class="n">metrics_last_analysis_dict</span><span class="p">:</span>
                        <span class="n">metrics_last_analyzed_timestamp</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp_str</span><span class="p">),</span> <span class="n">metric</span><span class="p">]</span> <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp_str</span> <span class="ow">in</span> <span class="n">metrics_last_analysis_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                        <span class="n">metrics_last_analyzed_timestamp_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">metrics_last_analyzed_timestamp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">del</span> <span class="n">metrics_last_analyzed_timestamp</span>
                        <span class="k">del</span> <span class="n">metrics_last_analysis_dict</span>
                        <span class="n">metrics_last_analysis_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">metrics_last_analyzed_timestamp_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">metrics_last_analyzed_timestamp_sorted</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">assigned_labelled_metrics</span><span class="p">]</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_active reordered metrics by last analysed timestamp, first metric in list now: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metrics_last_analyzed_timestamp_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_active reordered metrics by last analysed timestamp, last metric in list now: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metrics_last_analyzed_timestamp_sorted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
                        <span class="n">last_analysed_ordered_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">labelled_metric</span> <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">metrics_last_analyzed_timestamp_sorted</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">metrics_last_analyzed_timestamp_sorted</span>
                    <span class="k">if</span> <span class="n">last_analysed_ordered_metrics</span><span class="p">:</span>
                        <span class="n">load_shedding_assigned_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">labelled_metric</span> <span class="k">for</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">last_analysed_ordered_metrics</span> <span class="k">if</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">assigned_labelled_metrics</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_last_analysed_ordered_metrics took </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_load_shedding_get</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">load_shedding_assigned_metrics</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_active replacing </span><span class="si">%s</span><span class="s1"> assigned_metrics with </span><span class="si">%s</span><span class="s1"> metrics ordered by last analysed timestamp&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_labelled_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">load_shedding_assigned_metrics</span><span class="p">))))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">set_assigned_metrics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">assigned_labelled_metrics</span><span class="p">)</span>
                        <span class="n">set_load_shedding_assigned_metrics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">load_shedding_assigned_metrics</span><span class="p">)</span>
                        <span class="n">not_present_metrics_set</span> <span class="o">=</span> <span class="n">set_assigned_metrics</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">set_load_shedding_assigned_metrics</span><span class="p">)</span>
                        <span class="n">not_present_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">not_present_metrics_set</span><span class="p">)</span>
                        <span class="k">del</span> <span class="n">set_assigned_metrics</span>
                        <span class="k">del</span> <span class="n">set_load_shedding_assigned_metrics</span>
                        <span class="k">del</span> <span class="n">not_present_metrics_set</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: load_shedding_active failed determine not_present_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="n">not_present_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">not_present_metrics</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_active appending </span><span class="si">%s</span><span class="s1"> metrics which had no last analysed timestamp&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_present_metrics</span><span class="p">))))</span>
                        <span class="n">load_shedding_assigned_metrics</span> <span class="o">=</span> <span class="n">load_shedding_assigned_metrics</span> <span class="o">+</span> <span class="n">not_present_metrics</span>
                        <span class="k">del</span> <span class="n">not_present_metrics</span>
                    <span class="n">assigned_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">load_shedding_assigned_metrics</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">assigned_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assigned_labelled_metrics_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;load_shedding assigned_metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                    <span class="k">del</span> <span class="n">load_shedding_assigned_metrics</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_active now </span><span class="si">%s</span><span class="s1"> assigned_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">))))</span>

                <span class="c1"># @added 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
                <span class="c1"># Added filters</span>
                <span class="n">all_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">labelled_metric_in_all_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">labelled_metric_and_indices_in_all_timeseries</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">timeseries_not_present_in_all_timeseries</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">filters_str</span><span class="p">:</span>
                    <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">filters_str</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: calling mrange with filters: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">filters</span><span class="p">))</span>
                    <span class="n">r_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">all_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">ts</span><span class="p">()</span><span class="o">.</span><span class="n">mrange</span><span class="p">(((</span><span class="n">until_timestamp</span> <span class="o">-</span> <span class="p">(</span><span class="mi">180</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span> <span class="p">(</span><span class="n">until_timestamp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">filters</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to get Redis timeseries with mrange - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;all_timeseries&#39;</span><span class="p">,</span> <span class="s1">&#39;ts().mrange&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="n">all_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">redis_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">r_start</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">all_timeseries</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: mrange returned </span><span class="si">%s</span><span class="s1"> timeseries&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_timeseries</span><span class="p">)))</span>
                        <span class="n">labelled_metric_in_all_timeseries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">tlist</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tlist</span> <span class="ow">in</span> <span class="n">all_timeseries</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labelled_metric_in_all_timeseries</span><span class="p">):</span>
                            <span class="n">labelled_metric_and_indices_in_all_timeseries</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>

                <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                <span class="n">load_shedding_active_log_stop</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">activating_load_shedding</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
                <span class="n">feedback_metrics_skipped</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">feedback_labelled_metric_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">analyzer_labelled_metrics_busy</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_FEEDBACK_NAMESPACES</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">analyzer_labelled_metrics_busy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.busy&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to get analyzer_labelled_metrics.busy Redis key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">analyzer_labelled_metrics_busy</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: analyzer_labelled_metrics_busy found&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">feedback_labelled_metric_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.feedback.labelled_metric_ids&#39;</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: smembers failed on Redis set aet.metrics_manager.feedback.labelled_metric_ids - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20230426 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
                <span class="c1"># Added expiry to record metrics identified as normal by anomalous_daily_peaks</span>
                <span class="n">normal_daily_peak_metrics_skipped</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">current_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="n">normal_daily_peaks_keys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">key_ts</span> <span class="o">=</span> <span class="n">current_aligned_ts</span> <span class="o">-</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;mirage.normal_daily_peak_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_ts</span><span class="p">)</span>
                    <span class="n">normal_daily_peaks_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">normal_daily_peak_metrics_expiry</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">normal_daily_peaks_key</span> <span class="ow">in</span> <span class="n">normal_daily_peaks_keys</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">current_key_data</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">normal_daily_peaks_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to hgetall Redis hash </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">normal_daily_peaks_key</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_key_data</span><span class="p">):</span>
                        <span class="n">expire_at</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">expire_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">current_key_data</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">expire_at</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">expire_at</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">current_now</span> <span class="o">&gt;</span> <span class="n">expire_at</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">labelled_metric_in_all_timeseries</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">normal_daily_peaks_key</span><span class="p">,</span> <span class="n">labelled_metric</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mirage_labelled_metrics :: failed to remove </span><span class="si">%s</span><span class="s1"> from Redis hash </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">labelled_metric</span><span class="p">,</span> <span class="n">normal_daily_peaks_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">normal_daily_peak_metrics_expiry</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">expire_at</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: surfaced </span><span class="si">%s</span><span class="s1"> metrics currently in anomalous_daily_peak expiry&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">normal_daily_peak_metrics_expiry</span><span class="p">)))</span>

                <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">assigned_metrics</span><span class="p">:</span>
                    <span class="n">metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_if_parent_is_alive</span><span class="p">()</span>

                    <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                    <span class="c1"># If load shedding is active and the process in approaching the</span>
                    <span class="c1"># MAX_ANALYZER_PROCESS_RUNTIME stop</span>
                    <span class="n">right_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">activating_load_shedding</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">right_now</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MAX_ANALYZER_PROCESS_RUNTIME</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)):</span>
                            <span class="n">metrics_done</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_dict</span><span class="p">)</span>
                            <span class="n">metrics_not_done</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)</span> <span class="o">-</span> <span class="n">metrics_done</span>
                            <span class="n">activating_load_shedding</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: activating load shedding - approaching MAX_ANALYZER_PROCESS_RUNTIME so stopping, analysed </span><span class="si">%s</span><span class="s1"> metrics of the </span><span class="si">%s</span><span class="s1"> assigned metrics, </span><span class="si">%s</span><span class="s1"> metric not analysed&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">metrics_done</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">metrics_not_done</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">load_shedding_active_log_stop</span> <span class="ow">and</span> <span class="n">load_shedding_active</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_active - approaching MAX_ANALYZER_PROCESS_RUNTIME so stopping, analysed </span><span class="si">%s</span><span class="s1"> metrics of the </span><span class="si">%s</span><span class="s1"> assigned metrics, </span><span class="si">%s</span><span class="s1"> metric not analysed&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metrics_done</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)),</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metrics_not_done</span><span class="p">)))</span>
                                <span class="n">load_shedding_active_log_stop</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">activating_load_shedding</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to get assigned_metrics_dict for </span><span class="si">%s</span><span class="s1">  - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">base_name</span><span class="p">,</span> <span class="s1">&#39;assigned_metrics_dict&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="n">labelled_metric</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">last_metrics_last_analysis_dict</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">last_anlysis_timestamp_str</span> <span class="o">=</span> <span class="n">last_metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">last_anlysis_timestamp_str</span><span class="p">:</span>
                                    <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_anlysis_timestamp_str</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span> <span class="o">-</span> <span class="mi">60</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span> <span class="o">-</span> <span class="mi">60</span>
                        <span class="k">continue</span>

                    <span class="n">metrics_checked</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metrics_checked</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">:</span>
                        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;checked&#39;</span><span class="p">:</span> <span class="n">metrics_checked</span><span class="p">,</span>
                            <span class="s1">&#39;analysed&#39;</span><span class="p">:</span> <span class="n">metrics_analysed</span><span class="p">,</span>
                            <span class="s1">&#39;skipped&#39;</span><span class="p">:</span> <span class="n">metrics_skipped</span><span class="p">,</span>
                            <span class="s1">&#39;mad anomalous&#39;</span><span class="p">:</span> <span class="n">mad_anomalies</span><span class="p">,</span>
                            <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="n">anomalies</span><span class="p">,</span>
                            <span class="s1">&#39;not anomalous&#39;</span><span class="p">:</span> <span class="n">no_anomalies</span><span class="p">,</span>
                            <span class="s1">&#39;stationary&#39;</span><span class="p">:</span> <span class="n">stationary</span><span class="p">,</span>
                            <span class="s1">&#39;not stationary&#39;</span><span class="p">:</span> <span class="n">not_stationary</span><span class="p">,</span>
                            <span class="s1">&#39;monotonicity_checked&#39;</span><span class="p">:</span> <span class="n">monotonicity_checked</span><span class="p">,</span>
                            <span class="s1">&#39;monotonicity_changed&#39;</span><span class="p">:</span> <span class="n">monotonicity_changed</span><span class="p">,</span>
                            <span class="c1"># @added 20230426 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
                            <span class="c1"># Added expiry to record metrics identified as normal by anomalous_daily_peaks</span>
                            <span class="s1">&#39;normal_daily_peak_metrics_skipped&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">normal_daily_peak_metrics_skipped</span><span class="p">),</span>
                            <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
                            <span class="s1">&#39;feedback_metrics_skipped&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">feedback_metrics_skipped</span><span class="p">),</span>
                        <span class="p">}</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: progress: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">stats</span><span class="p">))</span>

                    <span class="c1"># @added 20210513 - Feature #4068: ANALYZER_SKIP</span>
                    <span class="k">if</span> <span class="n">ANALYZER_SKIP</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">analyzer_skip_metrics</span><span class="p">:</span>
                        <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="s1">&#39;analyzer&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">ANALYZER_SKIP</span><span class="p">)</span>
                        <span class="k">del</span> <span class="n">metric_matched_by</span>
                        <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="n">analyzer_skip_metrics_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">metrics_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                            <span class="n">labelled_metric</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                            <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span>

                            <span class="k">continue</span>

                    <span class="c1"># @added 20210520 - Branch #1444: thunder</span>
                    <span class="c1"># Added to supplement the ran Report app up if analyzer is just running</span>
                    <span class="c1"># long and over running.</span>
                    <span class="n">update_analyzer_up_key</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">right_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_reported_up</span><span class="p">:</span>
                        <span class="n">update_analyzer_up_key</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">right_now</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">last_reported_up</span> <span class="o">+</span> <span class="mi">60</span><span class="p">):</span>
                                <span class="n">update_analyzer_up_key</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: could not determine if last_reported_up time is exceeded - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">update_analyzer_up_key</span><span class="p">:</span>
                        <span class="c1"># Report app up</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">skyline_app_thunder_key</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">right_now</span><span class="p">)</span>
                            <span class="n">last_reported_up</span> <span class="o">=</span> <span class="n">right_now</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: could not update the Redis </span><span class="si">%s</span><span class="s1"> key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>

                    <span class="c1"># labelled_metric = &#39;labelled_metrics.%s&#39; % str(base_name)</span>

                    <span class="c1"># Use the metrics_dict data to optimise when data should be</span>
                    <span class="c1"># retrieved and analysed</span>
                    <span class="n">last_ts</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                        <span class="n">last_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;last_ts&#39;</span><span class="p">]))</span>
                        <span class="n">stationary_status</span> <span class="o">=</span> <span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;stationary&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to get assigned_metrics_dict for </span><span class="si">%s</span><span class="s1">  - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">base_name</span><span class="p">,</span> <span class="s1">&#39;assigned_metrics_dict&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="k">continue</span>

                    <span class="n">labelled_metric</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">metrics_checked</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: labelled_metrics_spin_process :: </span><span class="si">%s</span><span class="s1">, metrics_dict: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">])))</span>

                    <span class="n">labelled_metric_by_id</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                    <span class="n">redis_ts_key</span> <span class="o">=</span> <span class="n">labelled_metric_by_id</span>

                    <span class="n">check_id_key</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">check_id_key</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metrics_id_ts_keys_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">labelled_metric_by_id</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">metrics_id_ts_keys_exists</span><span class="p">:</span>
                                <span class="n">redis_ts_key</span> <span class="o">=</span> <span class="n">labelled_metric_by_id</span>
                                <span class="n">used_metric_id_keys</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                    <span class="c1"># @added 20230426 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
                    <span class="c1"># Added expiry to record metrics identified as normal by anomalous_daily_peaks</span>
                    <span class="n">normal_daily_peak_expiry</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">normal_daily_peak_expiry</span> <span class="o">=</span> <span class="n">normal_daily_peak_metrics_expiry</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">normal_daily_peak_expiry</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
                    <span class="n">feedback_metric</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">analyzer_labelled_metrics_busy</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">feedback_labelled_metric_ids</span><span class="p">:</span>
                            <span class="n">feedback_metric</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">feedback_metric_expiry</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">feedback_metric</span><span class="p">:</span>
                        <span class="n">feedback_key</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.feedback.expiry.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">feedback_metric_expiry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feedback_key</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="n">feedback_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                            <span class="n">feedback_metric_expiry</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># @added 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
                    <span class="c1"># Added filters and all_timeseries</span>
                    <span class="n">timeseries_not_present</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">all_timeseries</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">all_timeseries_index</span> <span class="o">=</span> <span class="n">labelled_metric_and_indices_in_all_timeseries</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">all_timeseries</span><span class="p">[</span><span class="n">all_timeseries_index</span><span class="p">][</span><span class="n">labelled_metric</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: not present in all_timeseries - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">),</span> <span class="n">base_name</span><span class="p">))</span>
                            <span class="n">timeseries_not_present_in_all_timeseries</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span>
                            <span class="n">timeseries_not_present</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to get timeseries from all_timeseries for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;all_timeseries&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># @modified 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
                    <span class="c1"># Added filters and all_timeseries and only query Redis if</span>
                    <span class="c1"># the timeseries is not retrieved from all_timeseries</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">timeseries_not_present</span><span class="p">:</span>
                        <span class="n">r_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># timeseries = self.redis_conn_decoded.ts().range(labelled_metric, (from_timestamp * 1000), (until_timestamp * 1000))</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">ts</span><span class="p">()</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">redis_ts_key</span><span class="p">,</span> <span class="p">((</span><span class="n">until_timestamp</span> <span class="o">-</span> <span class="p">(</span><span class="mi">180</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span> <span class="p">(</span><span class="n">until_timestamp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;TSDB: the key does not exist&#39;</span><span class="p">:</span>
                                <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;TimeseriesDoesNotExist&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">redis_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">r_start</span><span class="p">)</span>
                                <span class="n">empty_timeseries_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">)</span>
                                <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                                <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span>

                                <span class="k">continue</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to get Redis timeseries for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;ts().range&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">redis_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">r_start</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
                        <span class="n">metrics_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;EmptyTimeseries&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">empty_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                        <span class="n">empty_timeseries_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">)</span>
                        <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                        <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Convert Redis millisecond timestamps to second timestamps</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">mts</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">value</span><span class="p">]</span> <span class="k">for</span> <span class="n">mts</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">]</span>

                    <span class="n">last_timeseries_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">last_timeseries_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">metrics_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;EmptyTimeseries&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">empty_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                        <span class="n">empty_timeseries_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">)</span>
                        <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                        <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">until_timestamp</span> <span class="o">-</span> <span class="n">last_timeseries_timestamp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">STALE_PERIOD</span><span class="p">:</span>
                        <span class="n">metrics_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Stale&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">stale_metrics</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_timeseries_timestamp</span><span class="p">)</span>
                        <span class="c1"># @added 20230309 - Feature #4864: analyzer_labelled_metrics - exceptions metrics set</span>
                        <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                        <span class="c1"># Only sadd once</span>
                        <span class="n">identified_stale_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.redis_conn_decoded.sadd(&#39;analyzer_labelled_metrics.stale&#39;, str(metric_id))</span>
                        <span class="c1"># except Exception as err:</span>
                        <span class="c1">#    redis_set_errors.append([&#39;analyzer_labelled_metrics.stale&#39;, str(err)])</span>
                        <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                        <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span>

                        <span class="k">continue</span>
                    <span class="c1"># TODO: How to not classify as short if the metric stops and starts</span>
                    <span class="c1"># again.  In analyzer with FULL_DURATION data this is not so much of</span>
                    <span class="c1"># an issue, but with 3 hours of data...</span>
                    <span class="c1"># if len(timeseries) &lt; 180:</span>
                    <span class="c1"># if len(timeseries) &lt; 60:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIN_TOLERABLE_LENGTH</span><span class="p">:</span>
                        <span class="n">metrics_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;TooShort&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">tooshort_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                        <span class="c1"># @added 20230309 - Feature #4864: analyzer_labelled_metrics - exceptions metrics set</span>
                        <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                        <span class="c1"># Only sadd once</span>
                        <span class="n">identified_tooshort_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.redis_conn_decoded.sadd(&#39;analyzer_labelled_metrics.tooshort&#39;, str(metric_id))</span>
                        <span class="c1"># except Exception as err:</span>
                        <span class="c1">#     redis_set_errors.append([&#39;analyzer_labelled_metrics.tooshort&#39;, str(err)])</span>
                        <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                        <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Maintain a Redis hash key of the last timestamp of all metrics and</span>
                    <span class="c1"># only update the hash key if the timestamp is recent.  This Redis</span>
                    <span class="c1"># hash key is pruned in metrics_manager when an entry has a</span>
                    <span class="c1"># timestamp older that now - FULL_DURATION</span>
                    <span class="c1"># Thunder stale_metrics check requires all metrics to have their</span>
                    <span class="c1"># timestamps recorded in the hash key</span>
                    <span class="n">update_last_timestamp_hash_key</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">last_ts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">last_ts</span> <span class="o">&lt;</span> <span class="n">last_timeseries_timestamp</span><span class="p">:</span>
                            <span class="n">update_last_timestamp_hash_key</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">update_last_timestamp_hash_key</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="n">update_last_timestamp_hash_key</span><span class="p">:</span>
                        <span class="n">metrics_last_timeseries_timestamp_update_dict</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_timeseries_timestamp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># No new data since last analysis</span>
                        <span class="n">metrics_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;NoNewData&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">no_new_data_metrics</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_timeseries_timestamp</span>
                        <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                        <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Get rid of boring series</span>
                    <span class="n">boring</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="n">settings</span><span class="o">.</span><span class="n">MAX_TOLERABLE_BOREDOM</span><span class="p">:]))</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">BOREDOM_SET_SIZE</span><span class="p">:</span>
                        <span class="c1"># metrics_skipped += 1</span>
                        <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Boring&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">boring</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># Class boring as analysed</span>
                        <span class="c1"># continue</span>
                        <span class="c1"># @added 20230309 - Feature #4864: analyzer_labelled_metrics - exceptions metrics set</span>
                        <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                        <span class="c1"># Only sadd once</span>
                        <span class="n">identified_boring_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.redis_conn_decoded.sadd(&#39;analyzer_labelled_metrics.boring&#39;, str(metric_id))</span>
                        <span class="c1"># except Exception as err:</span>
                        <span class="c1">#     redis_set_errors.append([&#39;analyzer_labelled_metrics.boring&#39;, str(err)])</span>

                    <span class="n">metric_type_redis_key</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_dict</span> <span class="o">=</span> <span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;metric_dict&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_dict</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># metric_dict = metric_name_labels_parser(skyline_app, base_name)</span>
                            <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_name_labels_parser</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">metric_dict</span><span class="p">:</span>
                                <span class="n">metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;metric_dict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_dict</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;metric_name_labels_parser&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)])</span>
                            <span class="n">metrics_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;LabelsError&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                            <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span>
                            <span class="k">continue</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                        <span class="n">tenant_id</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;_tenant_id&#39;</span><span class="p">]</span>
                        <span class="n">server_id</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;_server_id&#39;</span><span class="p">]</span>
                        <span class="n">metric_type_redis_key</span> <span class="o">=</span> <span class="s1">&#39;metrics_manager.prometheus.metrics_type.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">server_id</span><span class="p">))</span>
                        <span class="n">tenant_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;parsing metric_dict&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="n">metrics_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;metricDict&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                        <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">determine_monotonic</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">calculate_derivative</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">metric_type_known</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># The metric_subtype allows for SUMMARY and HISTOGRAM metrics</span>
                    <span class="c1"># to be defined as COUNTER or GAUGE metrics due to the fact</span>
                    <span class="c1"># that these metrics can be COUNTERs or GAUGES</span>
                    <span class="n">metric_subtype</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">add_metric_subtype</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># metric_type = metrics_dict[base_name][&#39;type&#39;]</span>
                        <span class="n">metric_type</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_type</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_type</span> <span class="o">=</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="n">in_labelled_metrics_id_types</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">in_labelled_metrics_id_types</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;in_labelled_metrics_id_types&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">in_labelled_metrics_id_types</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">metric_type</span><span class="p">:</span>
                        <span class="n">metric_types_known</span><span class="p">[</span><span class="n">metric_type</span><span class="p">][</span><span class="s1">&#39;known&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># There is an issue in Prometheus metric types in so far as</span>
                    <span class="c1"># developers will not always adhere to metric typing rules</span>
                    <span class="c1"># and in some exporter you will find COUNTER and GAUGE</span>
                    <span class="c1"># metrics in the same metric namespace.  To overcome this</span>
                    <span class="c1"># analyzer periodically checks the metrics and identifies</span>
                    <span class="c1"># the skyline_metric_type, because the Prometheus metadata</span>
                    <span class="c1"># cannot be trusted.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_type</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20221229 - Bug #4766: analyzer_labelled_metrics - monotonicity checked incorrect classification</span>
                            <span class="c1"># Fetch the data once because with 1000s of new metrics added it</span>
                            <span class="c1"># becomes more efficient</span>
                            <span class="c1"># metric_type_id_str = self.redis_conn_decoded.hget(&#39;skyline.labelled_metrics.id.type&#39;, str(metric_id))</span>
                            <span class="n">metric_type_id_str</span> <span class="o">=</span> <span class="n">skyline_labelled_metrics_id_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span>
                            <span class="k">if</span> <span class="n">metric_type_id_str</span><span class="p">:</span>
                                <span class="n">metric_type</span> <span class="o">=</span> <span class="n">skyline_metric_types_by_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">metric_type_id_str</span><span class="p">)]</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;hgetall skyline.labelled_metrics.id.type&#39;</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="k">if</span> <span class="n">metric_type</span><span class="p">:</span>
                            <span class="n">metric_subtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_type</span><span class="p">)</span>
                            <span class="n">metric_types_known</span><span class="p">[</span><span class="n">metric_type</span><span class="p">][</span><span class="s1">&#39;looked_up&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># metric_type = &#39;COUNTER&#39;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_type</span> <span class="ow">and</span> <span class="n">metric_type_redis_key</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric_type_redis_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_type_redis_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">metric_type_redis_key_dict</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">metric_type_redis_key_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">metric_type_redis_key</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;hgetall </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_type_redis_key</span>
                                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                            <span class="n">metric_type_redis_keys</span><span class="p">[</span><span class="n">metric_type_redis_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_type_redis_key_dict</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_type</span> <span class="o">=</span> <span class="n">metric_type_redis_keys</span><span class="p">[</span><span class="n">metric_type_redis_key</span><span class="p">][</span><span class="n">metric_name</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">metric_type</span><span class="p">:</span>
                                <span class="n">metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_type</span>
                                <span class="k">if</span> <span class="n">metric_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">]:</span>
                                    <span class="n">metrics_type_dict</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">skyline_metric_types</span><span class="p">[</span><span class="n">metric_type</span><span class="p">]</span>
                                <span class="n">metric_types_known</span><span class="p">[</span><span class="n">metric_type</span><span class="p">][</span><span class="s1">&#39;looked_up&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># TODO - function to determine monotonic and add to hash, remember to remove id</span>
                    <span class="c1"># from the hash when metric becomes inactive.  Probably best to do in metrics_manager</span>
                    <span class="k">if</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span>
                        <span class="n">metric_subtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_type</span><span class="p">)</span>
                        <span class="n">calculate_derivative</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">metric_type_known</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span>
                        <span class="n">metric_subtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_type</span><span class="p">)</span>
                        <span class="n">calculate_derivative</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">metric_type_known</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">metric_subtype_redis_key</span> <span class="o">=</span> <span class="s1">&#39;metrics_manager.prometheus.metrics_subtype.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">server_id</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">metric_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SUMMARY&#39;</span><span class="p">,</span> <span class="s1">&#39;HISTOGRAM&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_subtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">metric_subtype_redis_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="n">metric_subtype_redis_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="k">if</span> <span class="n">metric_subtype</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                            <span class="n">metric_subtype</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_subtype</span><span class="p">:</span>
                            <span class="n">add_metric_subtype</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_type</span><span class="p">:</span>
                                <span class="c1"># metric_type = &#39;UNKNOWN&#39;</span>
                                <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">metric_subtypes_queried</span><span class="p">[</span><span class="s1">&#39;UNKNOWN&#39;</span><span class="p">][</span><span class="n">metric_subtype</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;subtype queried update dict: metric_subtypes_queried[</span><span class="si">%s</span><span class="s1">][</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_subtype</span><span class="p">))</span>
                                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="n">metric_subtype</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric_type</span><span class="p">:</span>
                        <span class="n">metric_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_subtype</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_subtype</span><span class="p">:</span>
                        <span class="n">determine_monotonic</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Periodically check metric monotonicity every 4 hours</span>
                    <span class="k">if</span> <span class="n">monotonicity_checked</span> <span class="o">&lt;</span> <span class="n">monotonicity_check_per_minute</span><span class="p">:</span>
                        <span class="n">continue_check</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># Do not check not older than 1 hour</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">timeseries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">until_timestamp</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">):</span>
                                <span class="n">continue_check</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">continue_check</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1"># @modified 20221228 - Bug #4766: analyzer_labelled_metrics - monotonicity checked incorrect classification</span>
                        <span class="c1"># The timeseries length could be less than 180 if a few</span>
                        <span class="c1"># data points are missed.  Using MIN_TOLERABLE_LENGTH</span>
                        <span class="c1"># if len(timeseries) &lt; 180:</span>
                        <span class="c1">#    continue_check = False</span>
                        <span class="k">if</span> <span class="n">boring</span><span class="p">:</span>
                            <span class="n">continue_check</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="c1"># @added 20230426 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
                        <span class="c1"># Added expiry to record metrics identified as normal by anomalous_daily_peaks</span>
                        <span class="k">if</span> <span class="n">normal_daily_peak_expiry</span><span class="p">:</span>
                            <span class="n">continue_check</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
                        <span class="k">if</span> <span class="n">feedback_metric_expiry</span><span class="p">:</span>
                            <span class="n">continue_check</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">if</span> <span class="n">continue_check</span><span class="p">:</span>
                            <span class="n">monotonicity_last_checked</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">check_monotonicity</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">monotonicity_last_checked</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.monotonicity_last_checked&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">monotonicity_last_checked</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">monotonicity_last_checked</span><span class="p">:</span>
                                <span class="n">check_monotonicity</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">monotonicity_last_checked</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">monotonicity_last_checked</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">until_timestamp</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)):</span>
                                    <span class="n">check_monotonicity</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">check_monotonicity</span><span class="p">:</span>
                                <span class="n">determine_monotonic</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="c1"># DISABLED</span>
                                <span class="c1"># @modified 20221228 - Bug #4766: analyzer_labelled_metrics - monotonicity checked incorrect classification</span>
                                <span class="c1"># RE-ENABLED</span>
                                <span class="c1"># if int(metric_id) != 12060:</span>
                                <span class="c1">#     determine_monotonic = False</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">monotonicity_not_expired</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">add_metric_subtype</span><span class="p">:</span>
                        <span class="n">determine_monotonic</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># @added 20230426 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
                    <span class="c1"># Added expiry to record metrics identified as normal by anomalous_daily_peaks</span>
                    <span class="k">if</span> <span class="n">normal_daily_peak_expiry</span><span class="p">:</span>
                        <span class="n">determine_monotonic</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
                    <span class="k">if</span> <span class="n">feedback_metric_expiry</span><span class="p">:</span>
                        <span class="n">determine_monotonic</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># @added 20230518 - metric_type.longterm_expire</span>
                    <span class="c1"># Do not overwrite longterm metric_type classifications</span>
                    <span class="n">metric_type_longterm_expire</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">determine_monotonic</span> <span class="ow">and</span> <span class="n">skyline_labelled_metrics_id_types_longterm_expire</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_type_longterm_expire</span> <span class="o">=</span> <span class="n">skyline_labelled_metrics_id_types_longterm_expire</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">metric_type_longterm_expire</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to determine expire_str from skyline_labelled_metrics_id_types_longterm_expire - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metric_type_longterm_expire</span><span class="p">:</span>
                            <span class="n">determine_monotonic</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">determine_monotonic</span><span class="p">:</span>
                        <span class="n">monotonicity_checked</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">is_strictly_increasing_monotonicity</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">is_strictly_increasing_monotonicity</span> <span class="o">=</span> <span class="n">strictly_increasing_monotonicity</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;is_strictly_increasing_monotonicity&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">monotonicity_last_checked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.monotonicity_last_checked&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="k">if</span> <span class="n">is_strictly_increasing_monotonicity</span><span class="p">:</span>
                            <span class="n">calculate_derivative</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">metric_type</span> <span class="o">!=</span> <span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: labelled_metrics_spin_process :: monotonicity changed for </span><span class="si">%s</span><span class="s1">, from type: </span><span class="si">%s</span><span class="s1"> to COUNTER - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">])))</span>
                                <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;COUNTER&#39;</span>
                                <span class="n">monotonicity_changed</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">metric_subtype</span> <span class="o">!=</span> <span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: labelled_metrics_spin_process :: monotonicity changed for </span><span class="si">%s</span><span class="s1">, from subtype: </span><span class="si">%s</span><span class="s1"> to COUNTER&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_subtype</span><span class="p">)))</span>
                                <span class="n">metric_subtype</span> <span class="o">=</span> <span class="s1">&#39;COUNTER&#39;</span>
                                <span class="n">add_metric_subtype</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">monotonicity_changed</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;COUNTER&#39;</span>
                            <span class="n">metric_subtype</span> <span class="o">=</span> <span class="s1">&#39;COUNTER&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">calculate_derivative</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">metric_type</span> <span class="o">!=</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: labelled_metrics_spin_process :: monotonicity changed for </span><span class="si">%s</span><span class="s1">, from type: </span><span class="si">%s</span><span class="s1"> to GAUGE - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">])))</span>
                                <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;GAUGE&#39;</span>
                                <span class="n">monotonicity_changed</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">metric_subtype</span> <span class="o">!=</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: labelled_metrics_spin_process :: monotonicity changed for </span><span class="si">%s</span><span class="s1">, from subtype: </span><span class="si">%s</span><span class="s1"> to GAUGE&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_subtype</span><span class="p">)))</span>
                                <span class="n">metric_subtype</span> <span class="o">=</span> <span class="s1">&#39;GAUGE&#39;</span>
                                <span class="n">monotonicity_changed</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">add_metric_subtype</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;GAUGE&#39;</span>
                            <span class="n">metric_subtype</span> <span class="o">=</span> <span class="s1">&#39;GAUGE&#39;</span>

                    <span class="k">if</span> <span class="n">add_metric_subtype</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">metric_subtype_redis_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="n">metric_subtype</span><span class="p">)</span>
                            <span class="c1"># metric_subtypes_added += 1</span>
                            <span class="n">metric_subtypes_added</span><span class="p">[</span><span class="n">metric_type</span><span class="p">][</span><span class="n">metric_subtype</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;metric_subtype&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="n">metric_subtype</span> <span class="o">==</span> <span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span>
                        <span class="n">calculate_derivative</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Add type to dict for metrics_manager to update</span>
                    <span class="k">if</span> <span class="n">metric_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">]:</span>
                        <span class="n">metrics_type_dict</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">skyline_metric_types</span><span class="p">[</span><span class="n">metric_type</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">metric_subtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">]:</span>
                        <span class="n">metrics_type_dict</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">skyline_metric_types</span><span class="p">[</span><span class="n">metric_subtype</span><span class="p">]</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_labelled_metrics_id_types</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">boring</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric_subtype</span><span class="p">:</span>
                            <span class="n">metrics_type_dict</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">skyline_metric_types</span><span class="p">[</span><span class="n">metric_subtype</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">calculate_derivative</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">boring</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">nonNegativeDerivative</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;nonNegativeDerivative timeseries&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>

                    <span class="n">check_for_anomalous</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">boring</span><span class="p">:</span>
                        <span class="n">check_for_anomalous</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">boring_dict</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># @added 20230426 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
                    <span class="c1"># Added expiry to record metrics identified as normal by anomalous_daily_peaks</span>
                    <span class="k">if</span> <span class="n">normal_daily_peak_expiry</span><span class="p">:</span>
                        <span class="n">check_for_anomalous</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">normal_daily_peak_metrics_skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                        <span class="n">last_analysed_timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                        <span class="n">last_analysed_metric</span> <span class="o">=</span> <span class="n">base_name</span>

                    <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
                    <span class="k">if</span> <span class="n">feedback_metric_expiry</span><span class="p">:</span>
                        <span class="n">check_for_anomalous</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">feedback_metrics_skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                        <span class="n">last_analysed_timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                        <span class="n">last_analysed_metric</span> <span class="o">=</span> <span class="n">base_name</span>

                    <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                    <span class="n">metrics_last_analysis_dict</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span>

                    <span class="n">mad_anomalous</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">use_mad</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">metrics_analysed</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Only check if stationary every ~30 minutes</span>
                    <span class="n">stationary_status</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">check_for_anomalous</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">stationary_status</span> <span class="o">=</span> <span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;stationary&#39;</span><span class="p">][</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
                            <span class="n">stationary_last_checked</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;stationary&#39;</span><span class="p">][</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span>
                            <span class="c1"># Only do 1000 stationary tests per run</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stationary_timings</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">stationary_last_checked</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">current_aligned_ts</span> <span class="o">-</span> <span class="mi">1800</span><span class="p">):</span>
                                    <span class="n">stationary_status</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">stationary_not_expired</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">stationary_not_expired</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">stationary_status</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">stationary_status</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                                <span class="n">s_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                                <span class="n">stationary_status</span> <span class="o">=</span> <span class="n">is_stationary</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                                <span class="n">stationary_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">s_start</span><span class="p">)</span>
                                <span class="n">value_data</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">stationary_status</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">))</span>
                                <span class="n">metrics_stationary_update_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value_data</span>
                            <span class="k">if</span> <span class="n">stationary_status</span><span class="p">:</span>
                                <span class="n">stationary</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">use_mad</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">not_stationary</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;is_stationary&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>

                        <span class="k">if</span> <span class="n">use_mad</span><span class="p">:</span>
                            <span class="n">m_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">mad_anomalous</span> <span class="o">=</span> <span class="n">median_absolute_deviation</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                                <span class="n">mad_analysed</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">mad_anomalous</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                                    <span class="n">check_for_anomalous</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">mad_anomalous</span><span class="p">:</span>
                                    <span class="n">mad_anomalies</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">mad_anomalous_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;median_absolute_deviation&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                            <span class="n">mad_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">m_start</span><span class="p">)</span>
                        <span class="n">last_analysed_timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                        <span class="n">last_analysed_metric</span> <span class="o">=</span> <span class="n">base_name</span>

                    <span class="n">full_duration_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">check_for_anomalous</span><span class="p">:</span>
                        <span class="n">r_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">full_duration_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">ts</span><span class="p">()</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">redis_ts_key</span><span class="p">,</span> <span class="p">(</span><span class="n">from_timestamp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span> <span class="p">(</span><span class="n">until_timestamp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to get Redis full_duration timeseries for </span><span class="si">%s</span><span class="s1">  - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;ts().range&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                            <span class="n">full_duration_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">redis_full_duration_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">r_start</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">full_duration_timeseries</span><span class="p">:</span>
                            <span class="n">check_for_anomalous</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">full_duration_timeseries</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">mts</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">value</span><span class="p">]</span> <span class="k">for</span> <span class="n">mts</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">]</span>

                    <span class="c1"># @added 20230329 - Feature #4882: labelled_metrics - resolution and data sparsity</span>
                    <span class="c1">#                   Feature #3870: metrics_manager - check_data_sparsity</span>
                    <span class="c1"># Handling the populating of the labelled_metrics data</span>
                    <span class="c1"># sparsity directly in analyzer_labelled_metrics to</span>
                    <span class="c1"># prevent having to surface the data in metrics_manager</span>
                    <span class="c1"># if the sparsity has been recently updated.  Running</span>
                    <span class="c1"># the determine_data_frequency and the</span>
                    <span class="c1"># determine_data_sparsity functions, combined together</span>
                    <span class="c1"># take 77.1 Âµs (microseconds) to run, this means that</span>
                    <span class="c1"># we can process ~12970 timeseries per seconds with</span>
                    <span class="c1"># these functions.</span>
                    <span class="k">if</span> <span class="n">check_for_anomalous</span><span class="p">:</span>
                        <span class="n">update_resolution_and_sparsity</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">last_sparsity_check_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">last_sparsity_check_timestamp_str</span> <span class="o">=</span> <span class="n">labelled_metrics_resolution_sparsity_last_checked_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span>
                            <span class="k">if</span> <span class="n">last_sparsity_check_timestamp_str</span><span class="p">:</span>
                                <span class="n">last_sparsity_check_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">last_sparsity_check_timestamp_str</span><span class="p">))</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">last_sparsity_check_timestamp</span> <span class="o">+</span> <span class="mi">1800</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_start</span><span class="p">):</span>
                                    <span class="n">update_resolution_and_sparsity</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">labelled_metrics_resolution_sparsity_recently_checked</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">last_sparsity_check_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">update_resolution_and_sparsity</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">update_resolution_and_sparsity</span><span class="p">:</span>
                            <span class="n">start_resolution_and_sparsity_timing</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="n">metric_resolution</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">data_sparsity</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">metric_resolution</span><span class="p">,</span> <span class="n">timestamp_resolutions_count</span> <span class="o">=</span> <span class="n">determine_data_frequency</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;determine_data_frequency&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                                <span class="n">metric_resolution</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="n">metric_resolution</span><span class="p">:</span>
                                <span class="n">labelled_metrics_resolutions</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">metric_resolution</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">data_sparsity</span> <span class="o">=</span> <span class="n">determine_data_sparsity</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">metric_resolution</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;determine_data_sparsity&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                                    <span class="n">data_sparsity</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_sparsity</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                                <span class="n">labelled_metrics_sparsity</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data_sparsity</span>
                                <span class="n">labelled_metrics_resolution_sparsity_checked_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right_now</span><span class="p">)</span>
                            <span class="n">resolution_and_sparsity_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_resolution_and_sparsity_timing</span><span class="p">)</span>

                    <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">ensemble</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">datapoint</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">algorithms_run</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># @added 20221228 - Bug #4766: analyzer_labelled_metrics - monotonicity checked incorrect classification</span>
                    <span class="c1"># Always check the monotonicity of the timeseries when it</span>
                    <span class="c1"># moves to the full_duration analysis and update the Redis</span>
                    <span class="c1"># sets as appropriate.</span>
                    <span class="c1"># if check_for_anomalous and metric_type != &#39;COUNTER&#39; and metric_subtype != &#39;COUNTER&#39;:</span>
                    <span class="c1"># @modified 20230518 - metric_type.longterm_expire</span>
                    <span class="c1"># Do not overwrite longterm metric_type classifications</span>
                    <span class="c1"># if full_duration_timeseries:</span>
                    <span class="k">if</span> <span class="n">full_duration_timeseries</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric_type_longterm_expire</span><span class="p">:</span>
                        <span class="n">monotonicity_checked</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">is_strictly_increasing_monotonicity</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">is_strictly_increasing_monotonicity</span> <span class="o">=</span> <span class="n">strictly_increasing_monotonicity</span><span class="p">(</span><span class="n">full_duration_timeseries</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;is_strictly_increasing_monotonicity&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">monotonicity_last_checked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.monotonicity_last_checked&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">add_metric_subtype</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">is_strictly_increasing_monotonicity</span><span class="p">:</span>
                            <span class="n">calculate_derivative</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">metric_type</span> <span class="o">!=</span> <span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: labelled_metrics_spin_process :: full_duration monotonicity changed for </span><span class="si">%s</span><span class="s1">, from type: </span><span class="si">%s</span><span class="s1"> to COUNTER - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">])))</span>
                                <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;COUNTER&#39;</span>
                                <span class="n">monotonicity_changed</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">metric_subtype</span> <span class="o">!=</span> <span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: labelled_metrics_spin_process :: full_duration monotonicity changed for </span><span class="si">%s</span><span class="s1">, from subtype: </span><span class="si">%s</span><span class="s1"> to COUNTER&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_subtype</span><span class="p">)))</span>
                                <span class="n">metric_subtype</span> <span class="o">=</span> <span class="s1">&#39;COUNTER&#39;</span>
                                <span class="n">add_metric_subtype</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;COUNTER&#39;</span>
                            <span class="n">metric_subtype</span> <span class="o">=</span> <span class="s1">&#39;COUNTER&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># @added 20230517 - Bug #4766: analyzer_labelled_metrics - monotonicity checked incorrect classification</span>
                            <span class="c1"># Handle changes from COUNTER to GAUGE as well</span>
                            <span class="k">if</span> <span class="n">metric_type</span> <span class="o">!=</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: labelled_metrics_spin_process :: full_duration monotonicity changed for </span><span class="si">%s</span><span class="s1">, from type: </span><span class="si">%s</span><span class="s1"> to GAUGE - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">])))</span>
                                <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;GAUGE&#39;</span>
                                <span class="n">monotonicity_changed</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">metric_subtype</span> <span class="o">!=</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: labelled_metrics_spin_process :: full_duration monotonicity changed for </span><span class="si">%s</span><span class="s1">, from subtype: </span><span class="si">%s</span><span class="s1"> to GAUGE&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_subtype</span><span class="p">)))</span>
                                <span class="n">metric_subtype</span> <span class="o">=</span> <span class="s1">&#39;GAUGE&#39;</span>
                                <span class="n">add_metric_subtype</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">metric_subtype</span> <span class="o">=</span> <span class="s1">&#39;GAUGE&#39;</span>
                            <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;GAUGE&#39;</span>
                        <span class="k">if</span> <span class="n">add_metric_subtype</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">metric_subtype_redis_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="n">metric_subtype</span><span class="p">)</span>
                                <span class="n">metric_subtypes_added</span><span class="p">[</span><span class="n">metric_type</span><span class="p">][</span><span class="n">metric_subtype</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;metric_subtype&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="k">if</span> <span class="n">metric_subtype</span> <span class="o">==</span> <span class="s1">&#39;COUNTER&#39;</span><span class="p">:</span>
                            <span class="n">calculate_derivative</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># Add type to dict for metrics_manager to update</span>
                        <span class="k">if</span> <span class="n">metric_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">]:</span>
                            <span class="n">metrics_type_dict</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">skyline_metric_types</span><span class="p">[</span><span class="n">metric_type</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">metric_subtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;COUNTER&#39;</span><span class="p">,</span> <span class="s1">&#39;GAUGE&#39;</span><span class="p">]:</span>
                            <span class="n">metrics_type_dict</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">skyline_metric_types</span><span class="p">[</span><span class="n">metric_subtype</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">check_for_anomalous</span><span class="p">:</span>
                        <span class="n">run_selected_algorithm_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">d_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">downsampled_timeseries</span> <span class="o">=</span> <span class="n">downsample_timeseries</span><span class="p">(</span><span class="s1">&#39;analyzer&#39;</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;downsample_timeseries&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                            <span class="n">downsampled_timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                        <span class="n">downsample_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">d_start</span><span class="p">)</span>

                        <span class="c1"># Calculate the derivate AFTER downsampling</span>
                        <span class="k">if</span> <span class="n">check_for_anomalous</span> <span class="ow">and</span> <span class="n">calculate_derivative</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">downsampled_timeseries</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">downsampled_timeseries</span> <span class="o">=</span> <span class="n">nonNegativeDerivative</span><span class="p">(</span><span class="n">downsampled_timeseries</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;nonNegativeDerivative downsampled_timeseries&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>

                        <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">anomalous</span><span class="p">,</span> <span class="n">ensemble</span><span class="p">,</span> <span class="n">datapoint</span><span class="p">,</span> <span class="n">negatives_found</span><span class="p">,</span> <span class="n">algorithms_run</span> <span class="o">=</span> <span class="n">run_selected_algorithm</span><span class="p">(</span><span class="n">downsampled_timeseries</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_airgaps</span><span class="p">,</span> <span class="n">metric_airgaps_filled</span><span class="p">,</span> <span class="n">run_negatives_present</span><span class="p">,</span> <span class="n">check_for_airgaps_only</span><span class="p">,</span> <span class="n">custom_stale_metrics_dict</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">negatives_found</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="c1"># It could have been deleted by the Roomba</span>
                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;DeletedByRoomba&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="n">EmptyTimeseries</span><span class="p">:</span>
                            <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;EmptyTimeseries&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">empty_timeseries_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">TooShort</span><span class="p">:</span>
                            <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;TooShort&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="c1"># @added 20230309 - Feature #4864: analyzer_labelled_metrics - exceptions metrics set</span>
                            <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                            <span class="c1"># Only sadd once</span>
                            <span class="n">identified_tooshort_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                            <span class="c1"># try:</span>
                            <span class="c1">#     self.redis_conn_decoded.sadd(&#39;analyzer_labelled_metrics.tooshort&#39;, str(metric_id))</span>
                            <span class="c1"># except Exception as err:</span>
                            <span class="c1">#    redis_set_errors.append([&#39;analyzer_labelled_metrics.tooshort&#39;, str(err)])</span>
                        <span class="k">except</span> <span class="n">Stale</span><span class="p">:</span>
                            <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Stale&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="c1"># @added 20230309 - Feature #4864: analyzer_labelled_metrics - exceptions metrics set</span>
                            <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                            <span class="c1"># Only sadd once</span>
                            <span class="n">identified_stale_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                            <span class="c1"># try:</span>
                            <span class="c1">#     self.redis_conn_decoded.sadd(&#39;analyzer_labelled_metrics.stale&#39;, str(metric_id))</span>
                            <span class="c1"># except Exception as err:</span>
                            <span class="c1">#     redis_set_errors.append([&#39;analyzer_labelled_metrics.stale&#39;, str(err)])</span>
                        <span class="k">except</span> <span class="n">Boring</span><span class="p">:</span>
                            <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Boring&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="c1"># @added 20230309 - Feature #4864: analyzer_labelled_metrics - exceptions metrics set</span>
                            <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                            <span class="c1"># Only sadd once</span>
                            <span class="n">identified_boring_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                            <span class="c1"># try:</span>
                            <span class="c1">#     self.redis_conn_decoded.sadd(&#39;analyzer_labelled_metrics.boring&#39;, str(metric_id))</span>
                            <span class="c1"># except Exception as err:</span>
                            <span class="c1">#     redis_set_errors.append([&#39;analyzer_labelled_metrics.boring&#39;, str(err)])</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">exceptions</span><span class="p">[</span><span class="s1">&#39;Other&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;run_selected_algorithm - Other&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="n">threesigma_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span>

                    <span class="c1"># @added 20220919 - Feature #4676: analyzer - illuminance.all key</span>
                    <span class="k">if</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ensemble</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                                <span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithms_run</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">algorithm_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">algorithms</span><span class="p">[</span><span class="n">algorithm</span><span class="p">])</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">algorithm_id</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">triggered_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">algorithm_id</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">illuminance_all_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="c1"># &#39;t&#39;: int(metric_timestamp),</span>
                                <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_timeseries_timestamp</span><span class="p">),</span>
                                <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span>
                                <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">triggered_algorithms</span><span class="p">}</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;failed to add illuminance_all_dict&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">anomalous</span><span class="p">:</span>
                        <span class="n">no_anomalies</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric_id</span><span class="p">,</span> <span class="n">last_timeseries_timestamp</span><span class="p">]</span>
                            <span class="n">not_anomalous_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;not_anomalous_list&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="k">continue</span>

                    <span class="n">anomalies</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">threesigma_anomalous_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">calculate_derivative</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">nonNegativeDerivative</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;nonNegativeDerivative timeseries&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>

                    <span class="c1"># Handle single value timeseries. The second timestamp in the</span>
                    <span class="c1"># timeseries was used because the first timestamp in a</span>
                    <span class="c1"># nonNegativeDerivative timeseries has no value.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="c1"># Failover to last_timeseries_timestamp</span>
                            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">last_timeseries_timestamp</span>
                    <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">last_timeseries_timestamp</span>

                    <span class="n">triggered_algorithms_for_waterfall_alert</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ensemble</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                            <span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithms_run</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            <span class="n">triggered_algorithms_for_waterfall_alert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
                    <span class="n">waterfall_panorama_data_added_at</span> <span class="o">=</span> <span class="n">until_timestamp</span>
                    <span class="n">waterfall_panorama_data_source</span> <span class="o">=</span> <span class="s1">&#39;redistimeseries&#39;</span>
                    <span class="n">waterfall_panorama_data</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">base_name</span><span class="p">,</span> <span class="n">datapoint</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span>
                        <span class="n">algorithms_run</span><span class="p">,</span> <span class="n">triggered_algorithms_for_waterfall_alert</span><span class="p">,</span>
                        <span class="n">skyline_app</span><span class="p">,</span> <span class="n">waterfall_panorama_data_source</span><span class="p">,</span> <span class="n">this_host</span><span class="p">,</span>
                        <span class="n">waterfall_panorama_data_added_at</span>
                    <span class="p">]</span>

                    <span class="n">metric</span> <span class="o">=</span> <span class="p">[</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">]</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.real_anomalous_metrics&#39;</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;sadd analyzer_labelled_metrics.real_anomalous_metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>

                    <span class="c1"># Get the anomaly breakdown - who returned True?</span>
                    <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ensemble</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                            <span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithms_run</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">triggered_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
                    <span class="n">metric_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">algorithms_run</span><span class="p">]</span>
                    <span class="n">metric_data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">base_name</span><span class="p">,</span>
                        <span class="s1">&#39;metric_id&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span>
                        <span class="s1">&#39;metric_dict&#39;</span><span class="p">:</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">],</span>
                        <span class="s1">&#39;from_timestamp&#39;</span><span class="p">:</span> <span class="n">from_timestamp</span><span class="p">,</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">metric_timestamp</span><span class="p">,</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">datapoint</span><span class="p">,</span>
                        <span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">:</span> <span class="n">triggered_algorithms</span><span class="p">,</span>
                        <span class="s1">&#39;algorithms_run&#39;</span><span class="p">:</span> <span class="n">algorithms_run</span><span class="p">,</span>
                        <span class="s1">&#39;snab_only_check&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;processed_by&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;analyzer_labelled_metrics&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()),</span>
                                <span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">:</span> <span class="n">triggered_algorithms</span><span class="p">,</span>
                                <span class="s1">&#39;algorithms_run&#39;</span><span class="p">:</span> <span class="n">algorithms_run</span><span class="p">,</span>
                                <span class="s1">&#39;waterfall_panorama_data&#39;</span><span class="p">:</span> <span class="n">waterfall_panorama_data</span><span class="p">,</span>
                                <span class="s1">&#39;process_number&#39;</span><span class="p">:</span> <span class="n">i_process</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">},</span>
                    <span class="p">}</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.anomalous_metrics&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;sadd analyzer_labelled_metrics.anomalous_metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>

                    <span class="c1"># Add ionosphere data</span>
                    <span class="c1"># timeseries_dir = str(metric_id)</span>
                    <span class="c1"># timeseries_dir = base_name.replace(&#39;.&#39;, &#39;/&#39;)</span>
                    <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">labelled_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

                    <span class="n">training_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">timeseries_dir</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">training_dir</span><span class="p">):</span>
                        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">training_dir</span><span class="p">)</span>
                    <span class="n">full_duration_in_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span>
                    <span class="n">ionosphere_json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.mirage.redis.</span><span class="si">%s</span><span class="s1">h.json&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">training_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">full_duration_in_hours</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ionosphere_json_file</span><span class="p">):</span>
                        <span class="c1"># Do not use the downsample_timeseries as there are only</span>
                        <span class="c1"># ~144 data points which is not sufficient for echo</span>
                        <span class="c1"># features profiles or motif matching</span>
                        <span class="c1"># timeseries_json = str(downsampled_timeseries).replace(&#39;[&#39;, &#39;(&#39;).replace(&#39;]&#39;, &#39;)&#39;)</span>
                        <span class="n">timeseries_json</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">write_data_to_file</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">ionosphere_json_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">timeseries_json</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">VERBOSE_LOGGING</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: added Ionosphere Mirage </span><span class="si">%s</span><span class="s1">h Redis data timeseries json file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">full_duration_in_hours</span><span class="p">)),</span> <span class="n">ionosphere_json_file</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to add Ionosphere Mirage Redis data timeseries json file - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">ionosphere_json_file</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                    <span class="c1"># @added 20200904 - Feature #3734: waterfall alerts</span>
                    <span class="n">added_to_waterfall_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="c1"># [metric, timestamp, value, added_to_waterfall_timestamp, waterfall_panorama_data]</span>
                    <span class="n">waterfall_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">datapoint</span><span class="p">,</span> <span class="n">added_to_waterfall_timestamp</span><span class="p">,</span> <span class="n">waterfall_panorama_data</span><span class="p">]</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer.waterfall_alerts.sent_to_mirage&#39;</span>
                    <span class="c1"># Only add to waterfall_alerts if it is not</span>
                    <span class="c1"># a snab_only_check</span>
                    <span class="n">snab_only_check</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">snab_only_check</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_data</span><span class="p">))</span>
                            <span class="c1"># if VERBOSE_LOGGING:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: added to Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_data</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">waterfall_data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                    <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.mirage_check&#39;</span>
                    <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: added mirage check for </span><span class="si">%s</span><span class="s1"> with metric_data: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;hset analyzer_labelled_metrics.to_mirage&#39;</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>

                    <span class="c1"># @added 20220504 - Feature #2580: illuminance</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">illuminance_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span>
                            <span class="s1">&#39;triggered_algorithms_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">)}</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;failed to add illuminance_dict&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                    <span class="c1"># FINISH HERE FOR NOW</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">not_anomalous_list</span><span class="p">:</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.not_anomalous_metrics&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: adding </span><span class="si">%s</span><span class="s1"> metric ids to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_anomalous_list</span><span class="p">)),</span> <span class="n">redis_set</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">items_added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="o">*</span><span class="n">not_anomalous_list</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: added </span><span class="si">%s</span><span class="s1"> metric ids to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">items_added</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to sadd to </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;labelled_metrics_spin_process&#39;</span><span class="p">,</span> <span class="s1">&#39;sadd analyzer_labelled_metrics.not_anomalous_metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">empty_timeseries_list</span><span class="p">:</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;redistimeseries_roomba.metrics_to_remove&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: adding </span><span class="si">%s</span><span class="s1"> metrics to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">empty_timeseries_list</span><span class="p">)),</span> <span class="n">redis_set</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">items_added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="o">*</span><span class="n">empty_timeseries_list</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: added </span><span class="si">%s</span><span class="s1"> metrics to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">items_added</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to sadd to </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;labelled_metrics_spin_process&#39;</span><span class="p">,</span> <span class="s1">&#39;sadd redistimeseries_roomba.metrics_to_remove&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>

                <span class="k">if</span> <span class="n">boring_dict</span><span class="p">:</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.boring.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: adding </span><span class="si">%s</span><span class="s1"> metrics to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">boring_dict</span><span class="p">)),</span> <span class="n">redis_set</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">items_added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">boring_dict</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: added </span><span class="si">%s</span><span class="s1"> metrics to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">items_added</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to hset to </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;labelled_metrics_spin_process&#39;</span><span class="p">,</span> <span class="s1">&#39;hset analyzer_labelled_metrics.boring&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to expire to </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: metric_subtypes_added: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_subtypes_added</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: metric_subtypes_queried: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_subtypes_queried</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: metric_types_known: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_types_known</span><span class="p">))</span>

                <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;checked&#39;</span><span class="p">:</span> <span class="n">metrics_checked</span><span class="p">,</span>
                    <span class="s1">&#39;analysed&#39;</span><span class="p">:</span> <span class="n">metrics_analysed</span><span class="p">,</span>
                    <span class="s1">&#39;skipped&#39;</span><span class="p">:</span> <span class="n">metrics_skipped</span><span class="p">,</span>
                    <span class="s1">&#39;anomalous&#39;</span><span class="p">:</span> <span class="n">anomalies</span><span class="p">,</span>
                    <span class="s1">&#39;not anomalous&#39;</span><span class="p">:</span> <span class="n">no_anomalies</span><span class="p">,</span>
                    <span class="s1">&#39;redis timings&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">redis_timings</span><span class="p">),</span>
                    <span class="s1">&#39;redis_timings_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">redis_timings</span><span class="p">),</span>
                    <span class="s1">&#39;redis full_duration timings&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">redis_full_duration_timings</span><span class="p">),</span>
                    <span class="s1">&#39;stationary analysed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">stationary_timings</span><span class="p">),</span>
                    <span class="s1">&#39;stationary&#39;</span><span class="p">:</span> <span class="n">stationary</span><span class="p">,</span>
                    <span class="s1">&#39;not stationary&#39;</span><span class="p">:</span> <span class="n">not_stationary</span><span class="p">,</span>
                    <span class="s1">&#39;stationary timing&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">stationary_timings</span><span class="p">),</span>
                    <span class="s1">&#39;stationary not expired&#39;</span><span class="p">:</span> <span class="n">stationary_not_expired</span><span class="p">,</span>
                    <span class="s1">&#39;mad analysed&#39;</span><span class="p">:</span> <span class="n">mad_analysed</span><span class="p">,</span>
                    <span class="s1">&#39;mad anomalous&#39;</span><span class="p">:</span> <span class="n">mad_anomalies</span><span class="p">,</span>
                    <span class="s1">&#39;mad timings&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mad_timings</span><span class="p">),</span>
                    <span class="s1">&#39;downsampled&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">downsample_timings</span><span class="p">),</span>
                    <span class="s1">&#39;downsample timings&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">downsample_timings</span><span class="p">),</span>
                    <span class="s1">&#39;3sigma analysed&#39;</span><span class="p">:</span> <span class="n">run_selected_algorithm_count</span><span class="p">,</span>
                    <span class="s1">&#39;3sigma timings&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">threesigma_timings</span><span class="p">),</span>
                    <span class="s1">&#39;monotonicity_checked&#39;</span><span class="p">:</span> <span class="n">monotonicity_checked</span><span class="p">,</span>
                    <span class="s1">&#39;monotonicity_changed&#39;</span><span class="p">:</span> <span class="n">monotonicity_changed</span><span class="p">,</span>
                    <span class="s1">&#39;resolution_and_sparsity_timings&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">resolution_and_sparsity_timings</span><span class="p">),</span>
                    <span class="c1"># @added 20230426 - Feature #4724: custom_algorithms - anomalous_daily_peak</span>
                    <span class="c1"># Added expiry to record metrics identified as normal by anomalous_daily_peaks</span>
                    <span class="s1">&#39;normal_daily_peak_metrics_skipped&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">normal_daily_peak_metrics_skipped</span><span class="p">),</span>
                    <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
                    <span class="s1">&#39;feedback_metrics_skipped&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">feedback_metrics_skipped</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: complete: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">stats</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">kkey</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stats_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">kkey</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: used </span><span class="si">%s</span><span class="s1"> metric id Redis ts keys&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">used_metric_id_keys</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: completed with </span><span class="si">%s</span><span class="s1"> errors&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: sample error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                <span class="c1"># @added 20230309 - Feature #4864: analyzer_labelled_metrics - exceptions metrics set</span>
                <span class="k">if</span> <span class="n">redis_set_errors</span><span class="p">:</span>
                    <span class="n">errors</span> <span class="o">=</span> <span class="n">redis_set_errors</span> <span class="o">+</span> <span class="n">errors</span>

                <span class="n">sadd_errors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="n">error_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.errors.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">)</span>
                    <span class="n">errors_strs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">error_list</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                        <span class="n">errors_strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error_list</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">error_set</span><span class="p">,</span> <span class="o">*</span><span class="n">errors_strs</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">sadd_errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;errors_strs&#39;</span><span class="p">,</span> <span class="s1">&#39;sadd analyzer_labelled_metrics.errors&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sadd_errors</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: updated </span><span class="si">%s</span><span class="s1"> Redis set with </span><span class="si">%s</span><span class="s1"> errors&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">),</span> <span class="n">error_set</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to sadd to </span><span class="si">%s</span><span class="s1"> Redis set with </span><span class="si">%s</span><span class="s1"> errors, last err - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">error_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sadd_errors</span><span class="p">)),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">error_set</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to expire </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">error_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: </span><span class="si">%s</span><span class="s1"> metrics run through run_selected_algorithm&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">run_selected_algorithm_count</span><span class="p">)))</span>

                <span class="c1"># @added 20220420 - Feature #4530: namespace.analysed_events</span>
                <span class="n">namespace_analysed</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tenant_id</span> <span class="ow">in</span> <span class="n">tenant_ids</span><span class="p">:</span>
                    <span class="n">parent_namespace</span> <span class="o">=</span> <span class="n">tenant_id</span>
                    <span class="n">namespace_analysed</span><span class="p">[</span><span class="n">parent_namespace</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">date_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">gmtime</span><span class="p">()))</span>
                <span class="n">namespace_analysed_events_hash</span> <span class="o">=</span> <span class="s1">&#39;namespace.analysed_events.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">date_string</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespace_analysed</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hincrby</span><span class="p">(</span><span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">namespace_analysed</span><span class="p">[</span><span class="n">namespace</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to increment </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">15</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: updated </span><span class="si">%s</span><span class="s1"> Redis hash&#39;</span> <span class="o">%</span> <span class="n">namespace_analysed_events_hash</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set expire </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">namespace_analysed_events_hash</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="c1"># Add values to the queue so the parent process can collate</span>
                <span class="k">for</span> <span class="n">kkey</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">anomaly_breakdown</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anomaly_breakdown_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">kkey</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">kkey</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exceptions_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">kkey</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">illuminance_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: calling add_illuminance_entries with </span><span class="si">%s</span><span class="s1"> entries to add&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">illuminance_dict</span><span class="p">))))</span>
                    <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">current_illuminance_dict</span> <span class="o">=</span> <span class="n">add_illuminance_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">),</span> <span class="n">illuminance_dict</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: add_illuminance_entries failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: illuminance Redis hash now has </span><span class="si">%s</span><span class="s1"> entries&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_illuminance_dict</span><span class="p">))))</span>

                <span class="c1"># @added 20220919 - Feature #4676: analyzer - illuminance.all key</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">illuminance_all_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: calling add_illuminance_entries (all) with </span><span class="si">%s</span><span class="s1"> entries to add&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">illuminance_all_dict</span><span class="p">))))</span>
                    <span class="n">current_illuminance_all_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">current_illuminance_all_dict</span> <span class="o">=</span> <span class="n">add_illuminance_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">),</span> <span class="n">illuminance_all_dict</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: add_illuminance_entries (all) failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: illuminance_all Redis hash now has </span><span class="si">%s</span><span class="s1"> entries&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_illuminance_all_dict</span><span class="p">))))</span>

                <span class="k">if</span> <span class="n">metrics_last_timeseries_timestamp_update_dict</span><span class="p">:</span>
                    <span class="n">hash_key</span> <span class="o">=</span> <span class="n">metrics_last_timeseries_timestamp_hash_key</span>
                    <span class="n">hash_dict</span> <span class="o">=</span> <span class="n">metrics_last_timeseries_timestamp_update_dict</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: updating </span><span class="si">%s</span><span class="s1"> Redis hash with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">hash_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hash_dict</span><span class="p">))))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">hash_dict</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to update </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">metrics_stationary_update_dict</span><span class="p">:</span>
                    <span class="n">hash_key</span> <span class="o">=</span> <span class="n">metrics_stationary_hash_key</span>
                    <span class="n">hash_dict</span> <span class="o">=</span> <span class="n">metrics_stationary_update_dict</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: updating </span><span class="si">%s</span><span class="s1"> Redis hash with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">hash_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hash_dict</span><span class="p">))))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">hash_dict</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to update </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">last_analysed_timeseries</span> <span class="ow">and</span> <span class="n">i_process</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">last_analysed_timeseries_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">last_analysed_metric</span><span class="p">,</span> <span class="n">last_analysed_timeseries</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.last_analysed_timeseries&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_analysed_timeseries_data</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set analyzer_labelled_metrics.last_analysed_timeseries Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">mad_anomalous_dict</span> <span class="ow">and</span> <span class="n">i_process</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.last_mad_anomalous.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">mad_anomalous_dict</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">threesigma_anomalous_dict</span><span class="p">:</span>
                    <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.last_3sigma_anomalous.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i_process</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">threesigma_anomalous_dict</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="mi">1800</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">empty_metrics</span><span class="p">:</span>
                    <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.empty_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="o">*</span><span class="n">empty_metrics</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to sadd </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="n">record_stale_metrics</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">record_stale_metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">stale_metrics</span><span class="p">:</span>
                        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.stale_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">stale_metrics</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">tooshort_metrics</span><span class="p">:</span>
                        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.tooshort_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">tooshort_metrics</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="n">record_no_new_data_metrics</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">record_no_new_data_metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">no_new_data_metrics</span><span class="p">:</span>
                        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.no_new_data_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">no_new_data_metrics</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: adding </span><span class="si">%s</span><span class="s1"> metrics to skyline.labelled_metrics.id.type Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_type_dict</span><span class="p">))))</span>
                <span class="k">if</span> <span class="n">metrics_type_dict</span><span class="p">:</span>
                    <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;skyline.labelled_metrics.id.type&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">metrics_type_dict</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20230517 - Bug #4766: analyzer_labelled_metrics - monotonicity checked incorrect classification</span>
                <span class="c1"># If any metrics have changed monotonicity set a key to update the metric_type</span>
                <span class="c1"># in the parent process</span>
                <span class="k">if</span> <span class="n">monotonicity_changed</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type.changed&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">monotonicity_changed</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to create Redis key skyline.labelled_metrics.id.type.changed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20230329 - Feature #4882: labelled_metrics - resolution and data sparsity</span>
                <span class="c1">#                   Feature #3870: metrics_manager - check_data_sparsity</span>
                <span class="k">if</span> <span class="n">labelled_metrics_resolution_sparsity_checked_dict</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: checked resolution and sparsity for </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labelled_metrics_resolution_sparsity_checked_dict</span><span class="p">))))</span>
                <span class="k">if</span> <span class="n">labelled_metrics_resolutions</span><span class="p">:</span>
                    <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.metric_resolutions&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">labelled_metrics_resolutions</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: updated </span><span class="si">%s</span><span class="s1"> metrics in </span><span class="si">%s</span><span class="s1"> Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labelled_metrics_resolutions</span><span class="p">)),</span> <span class="n">hash_key</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">labelled_metrics_sparsity</span><span class="p">:</span>
                    <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.data_sparsity&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">labelled_metrics_sparsity</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: updated </span><span class="si">%s</span><span class="s1"> metrics in </span><span class="si">%s</span><span class="s1"> Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labelled_metrics_sparsity</span><span class="p">)),</span> <span class="n">hash_key</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">labelled_metrics_resolution_sparsity_recently_checked</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: resolution and sparsity not checked on </span><span class="si">%s</span><span class="s1"> metrics that have been recently checked&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metrics_resolution_sparsity_recently_checked</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">labelled_metrics_resolution_sparsity_checked_dict</span><span class="p">:</span>
                    <span class="n">hash_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metrics_resolution_sparsity_last_checked_hash_key</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">labelled_metrics_resolution_sparsity_checked_dict</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                <span class="c1"># Only sadd once</span>
                <span class="k">if</span> <span class="n">identified_boring_metrics</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: sadding </span><span class="si">%s</span><span class="s1"> identified_boring_metrics to analyzer_labelled_metrics.boring Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">identified_boring_metrics</span><span class="p">))))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.boring&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">identified_boring_metrics</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to sadd identified_boring_metrics to analyzer_labelled_metrics.boring Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">identified_stale_metrics</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: sadding </span><span class="si">%s</span><span class="s1"> identified_stale_metrics to analyzer_labelled_metrics.stale Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">identified_stale_metrics</span><span class="p">))))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.stale&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">identified_stale_metrics</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to sadd identified_stale_metrics to analyzer_labelled_metrics.stale Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">identified_tooshort_metrics</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: sadding </span><span class="si">%s</span><span class="s1"> identified_tooshort_metrics to analyzer_labelled_metrics.tooshort Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">identified_tooshort_metrics</span><span class="p">))))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.tooshort&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">identified_tooshort_metrics</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to sadd identified_tooshort_metrics to analyzer_labelled_metrics.tooshort Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20230405 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
                <span class="c1"># Added filters and all_timeseries</span>
                <span class="k">if</span> <span class="n">timeseries_not_present_in_all_timeseries</span><span class="p">:</span>
                    <span class="n">current_aligned_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                    <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.timeseries_not_present_in_all_timeseries.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: adding </span><span class="si">%s</span><span class="s1"> metrics to Redis </span><span class="si">%s</span><span class="s1"> hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries_not_present_in_all_timeseries</span><span class="p">)),</span>
                        <span class="n">hash_key</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">timeseries_not_present_in_all_timeseries</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: added </span><span class="si">%s</span><span class="s1"> metrics to Redis </span><span class="si">%s</span><span class="s1"> hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries_not_present_in_all_timeseries</span><span class="p">)),</span>
                            <span class="n">hash_key</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set </span><span class="si">%s</span><span class="s1"> hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
                <span class="k">if</span> <span class="n">load_shedding_active</span> <span class="ow">or</span> <span class="n">activating_load_shedding</span> <span class="ow">or</span> <span class="n">load_shedding_hash_exists</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metrics_last_analysis_dict</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">metrics_last_analysis_hash_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">metrics_last_analysis_dict</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load shedding - updated </span><span class="si">%s</span><span class="s1"> analysis timestamps in Redis analyzer.metrics.last_analysis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_last_analysis_dict</span><span class="p">))))</span>
                            <span class="k">if</span> <span class="n">load_shedding_active</span><span class="p">:</span>
                                <span class="c1"># The load_shedding hash only has the expiry set if load</span>
                                <span class="c1"># shedding is active, not if the hash is only being updated.</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">metrics_last_analysis_hash_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: load_shedding_active - set expire to 300 on Redis analyzer.metrics.last_analysis hash key&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to update analysis timestamp in Redis analyzer.metrics.last_analysis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">key_ttl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">ttl</span><span class="p">(</span><span class="n">metrics_last_analysis_hash_key</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">key_ttl</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">metrics_last_analysis_hash_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: set the unset expire TTL on Redis analyzer.metrics.last_analysis hash key to 300&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to set the unset expire TTL on Redis analyzer.metrics.last_analysis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: error in memray with block - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: </span><span class="si">%s</span><span class="s1"> metrics had monotonicity_checked and </span><span class="si">%s</span><span class="s1"> changed&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">monotonicity_checked</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">monotonicity_changed</span><span class="p">)))</span>

        <span class="n">spin_end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">spin_start</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_spin_process :: process </span><span class="si">%s</span><span class="s1"> took </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i_process</span><span class="p">),</span> <span class="n">spin_end</span><span class="p">))</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AnalyzerLabelledMetrics.run"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.analyzer_labelled_metrics.AnalyzerLabelledMetrics.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - Called when the process intializes.</span>

<span class="sd">        - Determine if Redis is up and discover the number of `unique metrics`.</span>

<span class="sd">        - Divide the `unique_labelled_metrics` between the number of `ANALYZER_LABELLED_METRICS_PROCESSES`</span>
<span class="sd">          and assign each process a set of metrics to analyse for anomalies.</span>

<span class="sd">        - Wait for the processes to finish.</span>

<span class="sd">        - Determine whether if any anomalous metrics require:</span>

<span class="sd">            - Alerting on (and set `EXPIRATION_TIME` key in Redis for alert).</span>
<span class="sd">            - Feed to another module e.g. mirage.</span>
<span class="sd">            - Alert to syslog.</span>

<span class="sd">        - Populate the webapp json with the anomalous_metrics details.</span>

<span class="sd">        - Log the details about the run to the skyline analyzer log.</span>

<span class="sd">        - Send skyline.analyzer metrics to `GRAPHITE_HOST`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Log management to prevent overwriting</span>
        <span class="c1"># Allow the bin/&lt;skyline_app&gt;.d to manage the log</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">log_wait_for</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="k">while</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">log_wait_for</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">log_wait_for</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: starting&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: bin/</span><span class="si">%s</span><span class="s1">.d log management seems to have failed, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: bin/</span><span class="si">%s</span><span class="s1">.d log management done&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">):</span>
            <span class="c1"># @modified 20160803 - Adding additional exception handling to Analyzer</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to create </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">smtp_trigger_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
            <span class="c1"># Spawn processes</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spawn_alerter_process</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>
                <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to spawn_alerter_process&#39;</span><span class="p">)</span>
            <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                    <span class="c1"># Just to avoid hogging the CPU</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># All the processes are done, break now.</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: timed out, killing the spawn_trigger_alert process&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="c1"># p.join()</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: stopping spawn_trigger_alert - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># Discover unique labelled_metrics</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage before loading unique labelled_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>
        <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.unique_labelled_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: could not get the unique_labelled_metrics list from labelled_metrics.unique_labelled_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after loading unique labelled_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage before loading aet.metrics_manager.metric_names_with_ids - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>
        <span class="n">metric_names_with_ids_key</span> <span class="o">=</span> <span class="s1">&#39;aet.metrics_manager.metric_names_with_ids&#39;</span>
        <span class="n">metric_names_with_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_names_with_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">metric_names_with_ids_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to hgetall aet.metrics_manager.metric_names_with_ids Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after loading aet.metrics_manager.metric_names_with_ids - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

        <span class="n">metric_ids_with_metric_key</span> <span class="o">=</span> <span class="s1">&#39;aet.metrics_manager.active_labelled_ids_with_metric&#39;</span>
        <span class="n">metric_ids_with_name</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_ids_with_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">metric_ids_with_metric_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to hgetall aet.metrics_manager.active_labelled_ids_with_metric Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_ids_with_name</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">metric_names_with_ids</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">metric_names_with_ids</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                <span class="n">metric_ids_with_name</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after loading aet.metrics_manager.active_labelled_ids_with_metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage before creating labelled_metrics_id_types - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>
        <span class="n">labelled_metrics_id_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">labelled_metrics_id_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to hgetall skyline.labelled_metrics.id.type Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after creating labelled_metrics_id_types - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

        <span class="c1"># @added 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
        <span class="c1"># Added filters</span>
        <span class="n">tenant_ids_with_count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tenant_ids_base_names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tenant_ids_labelled_metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage before creating metrics_and_labels_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>
        <span class="n">metrics_and_labels_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metric_type_redis_keys_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">unique_labelled_metrics</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">labelled_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_ids_with_name</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># metric_dict = metric_name_labels_parser(skyline_app, base_name)</span>
                <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_name_labels_parser</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_dict</span><span class="p">:</span>
                    <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_dict</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tenant_id</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;_tenant_id&#39;</span><span class="p">]</span>
                        <span class="n">server_id</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;_server_id&#39;</span><span class="p">]</span>
                        <span class="n">metric_type_redis_key</span> <span class="o">=</span> <span class="s1">&#39;metrics_manager.prometheus.metrics_type.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">server_id</span><span class="p">))</span>
                        <span class="n">metric_type_redis_keys_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_type_redis_key</span><span class="p">)</span>
                        <span class="c1"># @added 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
                        <span class="c1"># Added filters</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">tenant_ids_with_count</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">tenant_ids_base_names</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                            <span class="n">tenant_ids_labelled_metrics</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">tenant_ids_with_count</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">tenant_ids_base_names</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                            <span class="n">tenant_ids_labelled_metrics</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;metric_name_labels_parser&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)])</span>
            <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">in_labelled_metrics_id_types</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_type_id_str</span> <span class="o">=</span> <span class="n">labelled_metrics_id_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">metric_type_id_str</span><span class="p">:</span>
                    <span class="n">in_labelled_metrics_id_types</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">metric_type_id_str</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                        <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;COUNTER&#39;</span>
                    <span class="k">if</span> <span class="n">metric_type_id_str</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                        <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;GAUGE&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_type</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;adding metric type to metrics_and_labels_dict&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;in_labelled_metrics_id_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_labelled_metrics_id_types</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;adding in_labelled_metrics_id_types to metrics_and_labels_dict&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: metric_name_labels_parser encountered </span><span class="si">%s</span><span class="s1"> errors, sample: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after creating metrics_and_labels_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage before creating metric_type_redis_keys - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>
        <span class="n">metric_type_redis_keys</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metric_type_redis_keys_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metric_type_redis_keys_list</span><span class="p">))</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">metric_type_redis_key</span> <span class="ow">in</span> <span class="n">metric_type_redis_keys_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric_type_redis_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_type_redis_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">metric_type_redis_key_dict</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_type_redis_key_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">metric_type_redis_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;hgetall </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_type_redis_key</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric_type_redis_key</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                <span class="n">metric_type_redis_keys</span><span class="p">[</span><span class="n">metric_type_redis_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_type_redis_key_dict</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: metric_name_labels_parser encountered </span><span class="si">%s</span><span class="s1"> errors, sample: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics_and_labels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_type</span> <span class="o">=</span> <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">metric_type</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_type</span> <span class="o">=</span> <span class="n">metric_type_redis_keys</span><span class="p">[</span><span class="n">metric_type_redis_key</span><span class="p">][</span><span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;metric_name&#39;</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">metric_type</span><span class="p">:</span>
                    <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_type</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># Do not default to COUNTER</span>
                <span class="c1"># metrics_and_labels_dict[base_name][&#39;type&#39;] = &#39;COUNTER&#39;</span>
                <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after determining metric types from metric_type_redis_keys - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

        <span class="n">fetch_new_metrics</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">no_id_metrics</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage at beginning of run - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

            <span class="c1"># Make sure Redis is up</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: cannot ping Redis at socket path </span><span class="si">%s</span><span class="s1">, reconnect will be attempted in 10 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: cannot connect to get_redis_conn - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Report app up</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Report app AND Redis as up</span>
                <span class="n">redis_is_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">skyline_app_thunder_key</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">redis_is_up</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: could not update the Redis redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: could not update the Redis </span><span class="si">%s</span><span class="s1"> key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">skyline_app</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># Discover unique labelled_metrics</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.unique_labelled_metrics&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: could not get the unique_labelled_metrics list from labelled_metrics.unique_labelled_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">unique_labelled_metrics_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labelled_metrics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unique_labelled_metrics_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: no labelled_metrics in redis try adding some&#39;</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># If there are ANALYZER_SKIP metrics declare shuffle the metrics</span>
            <span class="c1"># so that the load is distributed evenly between the processes</span>
            <span class="c1"># rather than 1 process getting all the metrics to skip</span>
            <span class="k">if</span> <span class="n">ANALYZER_SKIP</span> <span class="ow">and</span> <span class="n">ANALYZER_LABELLED_METRICS_PROCESSES</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: ANALYZER_SKIP set shuffling unique_labelled_metrics&#39;</span><span class="p">)</span>
                <span class="n">shuffle</span><span class="p">(</span><span class="n">unique_labelled_metrics</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage before creating metrics_last_timeseries_timestamp_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>
            <span class="n">metrics_last_timeseries_timestamp_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">metrics_last_timeseries_timestamp_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.last_timeseries_timestamp&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metrics_last_timeseries_timestamp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">metrics_last_timeseries_timestamp_hash_key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to create metrics_last_timeseries_timestamp_dict from Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metrics_last_timeseries_timestamp_hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after creating metrics_last_timeseries_timestamp_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

            <span class="c1"># @added 20230517 - Bug #4766: analyzer_labelled_metrics - monotonicity checked incorrect classification</span>
            <span class="c1"># If any metrics have changed monotonicity update the metric_type</span>
            <span class="n">update_labelled_metrics_id_type</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">update_labelled_metrics_id_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type.changed&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: exists failed on Redis key skyline.labelled_metrics.id.type.changed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">update_labelled_metrics_id_type</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: skyline.labelled_metrics.id.type.changed exists reloading skyline.labelled_metrics.id.type to use new metric_type from monotonicity changes&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type.changed&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to delete skyline.labelled_metrics.id.type.changed key from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage before updating labelled_metrics_id_types because skyline.labelled_metrics.id.type.changed exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">labelled_metrics_id_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to hgetall skyline.labelled_metrics.id.type Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after creating labelled_metrics_id_types - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">metric_id_str</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">labelled_metrics_id_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_ids_with_name</span><span class="p">[</span><span class="n">metric_id_str</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">in_labelled_metrics_id_types</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_type_id_str</span> <span class="o">=</span> <span class="n">labelled_metrics_id_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">metric_type_id_str</span><span class="p">:</span>
                            <span class="n">in_labelled_metrics_id_types</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">metric_type_id_str</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                                <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;COUNTER&#39;</span>
                            <span class="k">if</span> <span class="n">metric_type_id_str</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                                <span class="n">metric_type</span> <span class="o">=</span> <span class="s1">&#39;GAUGE&#39;</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">metric_type</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_type</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;adding metric type to metrics_and_labels_dict&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;in_labelled_metrics_id_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_labelled_metrics_id_types</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;adding in_labelled_metrics_id_types to metrics_and_labels_dict&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metrics_and_labels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&lt;</span> <span class="n">unique_labelled_metrics_count</span><span class="p">:</span>
                <span class="n">fetch_new_metrics</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">no_id_metrics</span><span class="p">:</span>
                <span class="n">fetch_new_metrics</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">fetch_new_metrics</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_names_with_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">metric_names_with_ids_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to hgetall aet.metrics_manager.metric_names_with_ids Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_ids_with_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">metric_ids_with_metric_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to hgetall aet.metrics_manager.active_labelled_ids_with_metric Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_ids_with_name</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_names_with_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">metric_names_with_ids</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                        <span class="n">metric_ids_with_name</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span>

            <span class="k">if</span> <span class="n">fetch_new_metrics</span><span class="p">:</span>
                <span class="n">new_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">metric_type_redis_keys_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">unique_labelled_metrics</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="n">labelled_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_ids_with_name</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># base_name = labelled_metric.replace(&#39;labelled_metrics.&#39;, &#39;&#39;, 1)</span>
                    <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_dict</span> <span class="o">=</span> <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_type</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_type</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># metric_dict = metric_name_labels_parser(skyline_app, base_name)</span>
                            <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_name_labels_parser</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">metric_dict</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_dict</span>
                                    <span class="n">tenant_id</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;_tenant_id&#39;</span><span class="p">]</span>
                                    <span class="n">server_id</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;_server_id&#39;</span><span class="p">]</span>
                                    <span class="n">metric_type_redis_key</span> <span class="o">=</span> <span class="s1">&#39;metrics_manager.prometheus.metrics_type.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">server_id</span><span class="p">))</span>
                                    <span class="n">metric_type_redis_keys_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_type_redis_key</span><span class="p">)</span>
                                    <span class="n">new_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                                    <span class="c1"># @added 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
                                    <span class="c1"># Added filters</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">tenant_ids_with_count</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                        <span class="n">tenant_ids_base_names</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                                        <span class="n">tenant_ids_labelled_metrics</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">)</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">tenant_ids_with_count</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                                        <span class="n">tenant_ids_base_names</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                                        <span class="n">tenant_ids_labelled_metrics</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="s1">&#39;metric_name_labels_parser&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: metric_name_labels_parser encountered </span><span class="si">%s</span><span class="s1"> errors, sample: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

                <span class="n">metric_type_redis_keys_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metric_type_redis_keys_list</span><span class="p">))</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">metric_type_redis_key</span> <span class="ow">in</span> <span class="n">metric_type_redis_keys_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric_type_redis_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric_type_redis_keys</span><span class="p">:</span>
                        <span class="n">metric_type_redis_key_dict</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_type_redis_key_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">metric_type_redis_key</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;hgetall </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_type_redis_key</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric_type_redis_key</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                        <span class="n">metric_type_redis_keys</span><span class="p">[</span><span class="n">metric_type_redis_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_type_redis_key_dict</span>
                <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: metric_name_labels_parser encountered </span><span class="si">%s</span><span class="s1"> errors, sample: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">new_metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_type</span> <span class="o">=</span> <span class="n">metric_type_redis_keys</span><span class="p">[</span><span class="n">metric_type_redis_key</span><span class="p">][</span><span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;metric_name&#39;</span><span class="p">]]</span>
                        <span class="k">if</span> <span class="n">metric_type</span><span class="p">:</span>
                            <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_type</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="c1"># metrics_and_labels_dict[base_name][&#39;type&#39;] = &#39;COUNTER&#39;</span>
                        <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage before creating stationary_metrics_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>
            <span class="n">stationary_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">stationary_metrics_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.stationary_metrics&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stationary_metrics_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">stationary_metrics_hash_key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to hgetall </span><span class="si">%s</span><span class="s1"> Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">stationary_metrics_hash_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after creating stationary_metrics_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

            <span class="c1"># Discover assigned metrics</span>
            <span class="n">keys_per_processor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">unique_labelled_metrics_count</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ANALYZER_LABELLED_METRICS_PROCESSES</span><span class="p">)))</span>

            <span class="c1"># @added 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
            <span class="c1"># Added filters</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filters_dict</span> <span class="o">=</span> <span class="n">get_tenant_id_mrange_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ANALYZER_LABELLED_METRICS_PROCESSES</span><span class="p">,</span> <span class="n">tenant_ids_with_count</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: get_tenant_id_mrange_split failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">filters_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: filters_dict: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">filters_dict</span><span class="p">))</span>

            <span class="n">no_id_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># @added 20230123 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="c1"># all_db_base_names = {}</span>
            <span class="c1"># all_db_base_names_with_ids = {}</span>
            <span class="c1"># all_db_ids_with_base_names = {}</span>

            <span class="c1"># Spawn processes</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i_process</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ANALYZER_LABELLED_METRICS_PROCESSES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i_process</span> <span class="o">&gt;</span> <span class="n">unique_labelled_metrics_count</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: analyzer_labelled_metrics :: skyline is set for more cores than needed.&#39;</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage before starting process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">i_process</span> <span class="o">==</span> <span class="n">ANALYZER_LABELLED_METRICS_PROCESSES</span><span class="p">:</span>
                    <span class="n">assigned_max</span> <span class="o">=</span> <span class="n">unique_labelled_metrics_count</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">assigned_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">unique_labelled_metrics_count</span><span class="p">,</span> <span class="n">i_process</span> <span class="o">*</span> <span class="n">keys_per_processor</span><span class="p">)</span>
                <span class="c1"># Fix analyzer worker metric assignment #94</span>
                <span class="c1"># https://github.com/etsy/skyline/pull/94 @languitar:worker-fix</span>
                <span class="n">assigned_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_process</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">keys_per_processor</span>
                <span class="n">assigned_keys</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">assigned_min</span><span class="p">,</span> <span class="n">assigned_max</span><span class="p">)</span>

                <span class="c1"># Compile assigned metrics</span>
                <span class="n">error_logged</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">assigned_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique_labelled_metrics</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">assigned_keys</span><span class="p">]</span>

                <span class="c1"># @added 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
                <span class="c1"># Added filters</span>
                <span class="n">assigned_filter_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">filters_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">filters_dict</span><span class="p">:</span>
                    <span class="n">filter_key</span> <span class="o">=</span> <span class="n">i_process</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">filters_list</span> <span class="o">=</span> <span class="n">filters_dict</span><span class="p">[</span><span class="n">filter_key</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to determine filters_dict[</span><span class="si">%s</span><span class="s1">] from filters_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">filter_key</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">filters_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">filters_list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tenant_id</span> <span class="ow">in</span> <span class="n">filters_list</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">assigned_filter_metrics</span> <span class="o">=</span> <span class="n">assigned_filter_metrics</span> <span class="o">+</span> <span class="n">tenant_ids_labelled_metrics</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed metrics for tenant_id </span><span class="si">%s</span><span class="s1"> from tenant_ids_labelled_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">assigned_filter_metrics</span><span class="p">:</span>
                    <span class="n">assigned_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">assigned_filter_metrics</span><span class="p">))</span>
                    <span class="k">del</span> <span class="n">assigned_filter_metrics</span>

                <span class="k">del</span> <span class="n">assigned_keys</span>
                <span class="n">assigned_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">assigned_metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># base_name = labelled_metric.replace(&#39;labelled_metrics.&#39;, &#39;&#39;, 1)</span>
                        <span class="c1"># metric_id = None</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">labelled_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">no_metric_id</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_ids_with_name</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span>
                            <span class="n">no_metric_id</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="c1"># no_id_metrics.append(metric_id)</span>
                            <span class="c1"># continue</span>
                            <span class="n">no_metric_id</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     metric_id = metric_names_with_ids[base_name]</span>
                        <span class="c1">#     no_metric_id = False</span>
                        <span class="c1"># except:</span>
                            <span class="c1"># no_id_metrics.append(metric_id)</span>
                            <span class="c1"># continue</span>
                        <span class="c1">#    no_metric_id = True</span>
                        <span class="k">if</span> <span class="n">no_metric_id</span><span class="p">:</span>
                            <span class="n">no_id_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">last_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metrics_last_timeseries_timestamp_dict</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">last_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">stationary_str</span> <span class="o">=</span> <span class="n">stationary_metrics_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span>
                            <span class="k">if</span> <span class="n">stationary_str</span><span class="p">:</span>
                                <span class="n">stationary_str_elements</span> <span class="o">=</span> <span class="n">stationary_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                                <span class="n">stationary_value</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">stationary_str_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                                    <span class="n">stationary_value</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">stationary_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">stationary_value</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">stationary_str_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">stationary_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;last_ts&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                        <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_dict</span> <span class="o">=</span> <span class="n">metrics_and_labels_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">assigned_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">metric_id</span><span class="p">,</span>
                            <span class="s1">&#39;last_ts&#39;</span><span class="p">:</span> <span class="n">last_timestamp</span><span class="p">,</span>
                            <span class="s1">&#39;stationary&#39;</span><span class="p">:</span> <span class="n">stationary_dict</span><span class="p">,</span>
                            <span class="s1">&#39;metric_dict&#39;</span><span class="p">:</span> <span class="n">metric_dict</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">error_logged</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> details to assigned_metrics_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">labelled_metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">del</span> <span class="n">assigned_metrics</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20230404 - Feature #4890: analyzer_labelled_metrics - use mrange</span>
                    <span class="c1"># Added filters</span>
                    <span class="c1"># p = Process(target=self.labelled_metrics_spin_process, args=(i_process, assigned_metrics_dict))</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labelled_metrics_spin_process</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i_process</span><span class="p">,</span> <span class="n">assigned_metrics_dict</span><span class="p">,</span> <span class="n">filters_list</span><span class="p">))</span>
                    <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: starting </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> labelled_metrics_spin_process/es with filters_list: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">pid_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ANALYZER_LABELLED_METRICS_PROCESSES</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">filters_list</span><span class="p">)))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">started_pid</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">pid</span>
                    <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">started_pid</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: started labelled_metrics_spin_process with pid </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">started_pid</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to spawn process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">assigned_metrics_dict</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after starting process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

            <span class="k">del</span> <span class="n">unique_labelled_metrics</span>
            <span class="k">del</span> <span class="n">metrics_last_timeseries_timestamp_dict</span>
<span class="c1">#            del metric_names_with_ids</span>
            <span class="k">del</span> <span class="n">stationary_metrics_dict</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after starting processes - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">no_id_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: no_id_metrics count: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">no_id_metrics</span><span class="p">))))</span>
                <span class="n">no_id_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.no_id_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">no_id_metrics_key</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">no_id_metrics</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">no_id_metrics_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to sadd </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">no_id_metrics_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># Send wait signal to zombie processes</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: started pids: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">spawned_pids</span><span class="p">)))</span>
            <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="n">MAX_ANALYZER_LABELLED_METRICS_PROCESS_RUNTIME</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                    <span class="c1"># Just to avoid hogging the CPU</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># All the processes are done, break now.</span>
                    <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: </span><span class="si">%s</span><span class="s1"> labelled_metrics_spin_process/es completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">ANALYZER_LABELLED_METRICS_PROCESSES</span><span class="p">),</span> <span class="n">time_to_run</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: timed out, killing all labelled_metrics_spin_process processes&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: killing labelled_metrics_spin_process process&#39;</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="c1"># p.join()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: killed labelled_metrics_spin_process process&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: sending SIGKILL to pid </span><span class="si">%s</span><span class="s1"> labelled_metrics_spin_process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: SIGKILL failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="c1"># p.join()</span>

            <span class="c1"># Log the last reported error by any algorithms that errored in the</span>
            <span class="c1"># spawned processes from algorithms.py</span>
            <span class="k">for</span> <span class="n">completed_pid</span> <span class="ow">in</span> <span class="n">spawned_pids</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: labelled_metrics_pin_process with pid </span><span class="si">%s</span><span class="s1"> completed&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">completed_pid</span><span class="p">)))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after completed processes - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">))</span>

            <span class="c1"># Grab data from the queue and populate dictionaries</span>
            <span class="n">exceptions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">anomaly_breakdown</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anomaly_breakdown_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">anomaly_breakdown</span><span class="p">:</span>
                        <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
                        <span class="n">exceptions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">exceptions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">exceptions_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Boring&#39;</span><span class="p">,</span> <span class="s1">&#39;Stale&#39;</span><span class="p">,</span> <span class="s1">&#39;TooShort&#39;</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">,</span> <span class="s1">&#39;EmptyTimeseries&#39;</span><span class="p">,</span> <span class="s1">&#39;NoNewData&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i_exception</span> <span class="ow">in</span> <span class="n">exceptions_metrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i_exception</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
                    <span class="n">exceptions</span><span class="p">[</span><span class="n">i_exception</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># @added 20230309 - Feature #4864: analyzer_labelled_metrics - exceptions metrics set</span>
                    <span class="k">if</span> <span class="n">i_exception</span> <span class="o">==</span> <span class="s1">&#39;TooShort&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;aet.analyzer_labelled_metrics.tooshort&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;deleted Redis set aet.analyzer_labelled_metrics.tooshort as no tooshort exceptions&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to delete Redis set aet.analyzer_labelled_metrics.tooshort - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">i_exception</span> <span class="o">==</span> <span class="s1">&#39;Stale&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;aet.analyzer_labelled_metrics.stale&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;deleted Redis set aet.analyzer_labelled_metrics.stale as no stale exceptions&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to delete Redis set aet.analyzer_labelled_metrics.stale - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">i_exception</span> <span class="o">==</span> <span class="s1">&#39;Boring&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;aet.analyzer_labelled_metrics.boring&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;deleted Redis set aet.analyzer_labelled_metrics.boring as no boring exceptions&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to delete Redis set aet.analyzer_labelled_metrics.boring - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># @added 20230309 - Feature #4864: analyzer_labelled_metrics - exceptions metrics set</span>
                    <span class="k">if</span> <span class="n">i_exception</span> <span class="o">==</span> <span class="s1">&#39;TooShort&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.tooshort&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.analyzer_labelled_metrics.tooshort&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;renamed Redis set analyzer_labelled_metrics.tooshort to aet.analyzer_labelled_metrics.tooshort&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to rename Redis set analyzer_labelled_metrics.tooshort to aet.analyzer_labelled_metrics.tooshort - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">i_exception</span> <span class="o">==</span> <span class="s1">&#39;Stale&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.stale&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.analyzer_labelled_metrics.stale&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;renamed Redis set analyzer_labelled_metrics.stale to aet.analyzer_labelled_metrics.stale&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to rename Redis set analyzer_labelled_metrics.stale to aet.analyzer_labelled_metrics.stale - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">i_exception</span> <span class="o">==</span> <span class="s1">&#39;Boring&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.boring&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.analyzer_labelled_metrics.boring&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;renamed Redis set analyzer_labelled_metrics.boring to aet.analyzer_labelled_metrics.boring&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to rename Redis set analyzer_labelled_metrics.boring to aet.analyzer_labelled_metrics.boring - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20200603 - Feature #3566: custom_algorithms</span>
            <span class="n">anomaly_breakdown_algorithms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ALGORITHMS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">CUSTOM_ALGORITHMS</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">custom_algorithm</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">CUSTOM_ALGORITHMS</span><span class="p">:</span>
                    <span class="n">anomaly_breakdown_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">custom_algorithm</span><span class="p">)</span>

            <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
                        <span class="n">stats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1"># @modified 20200603 - Feature #3566: custom_algorithms</span>
            <span class="c1"># for i_anomaly_breakdown in settings.ALGORITHMS:</span>
            <span class="k">for</span> <span class="n">i_anomaly_breakdown</span> <span class="ow">in</span> <span class="n">anomaly_breakdown_algorithms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i_anomaly_breakdown</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">anomaly_breakdown</span><span class="p">:</span>
                    <span class="n">anomaly_breakdown</span><span class="p">[</span><span class="n">i_anomaly_breakdown</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Set the anomaly_end_timestamp</span>
            <span class="n">not_anomalous_metric_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">not_anomalous_metrics_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;current.anomalies&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_anomalies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to get Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">current_anomalies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">current_anomalies</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.not_anomalous_metrics&#39;</span>
                    <span class="n">not_anomalous_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">not_anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">not_anomalous_metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">list_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="n">not_anomalous_metrics_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_data</span><span class="p">)</span>
                        <span class="n">not_anomalous_metric_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">current_anomalies</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">list_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                        <span class="n">anomalous_metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">anomalous_metric</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="c1"># @added 20200608 - Feature #3306: Record anomaly_end_timestamp</span>
                        <span class="c1"># Remove entries from the current.anomalies set if the</span>
                        <span class="c1"># timestamp is older than FULL_DURATION</span>
                        <span class="k">if</span> <span class="n">anomaly_timestamp</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">):</span>
                            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;current.anomalies&#39;</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">list_data</span><span class="p">))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: removed </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1"> as the anomaly_timestamp is older than FULL_DURATION - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">anomalous_metric</span><span class="p">,</span> <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">list_data</span><span class="p">)))</span>
                                <span class="k">continue</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to remove </span><span class="si">%s</span><span class="s1"> for Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">list_data</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">anomaly_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">anomaly_end_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">anomaly_end_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to determine current_anomalies item&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">anomaly_end_timestamp</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">anomaly_id</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">anomalous_metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">anomalous_metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">anomalous_metric</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: get_metric_id_from_base_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">anomalous_metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomalous_metric_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">not_anomalous_metric_ids</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">metric_id</span><span class="p">,</span> <span class="n">anomaly_end_timestamp</span> <span class="ow">in</span> <span class="n">not_anomalous_metrics_data</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomalous_metric_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">):</span>
                                <span class="n">update_item</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;current.anomalies&#39;</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">list_data</span><span class="p">))</span>
                                    <span class="n">update_item</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to remove </span><span class="si">%s</span><span class="s1"> for Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">list_data</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">update_item</span><span class="p">:</span>
                                    <span class="n">new_list_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">anomalous_metric</span><span class="p">,</span> <span class="n">anomaly_timestamp</span><span class="p">,</span> <span class="n">anomaly_id</span><span class="p">,</span> <span class="n">anomaly_end_timestamp</span><span class="p">]</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;current.anomalies&#39;</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_list_data</span><span class="p">))</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: set anomaly_end_timestamp to </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> in Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_end_timestamp</span><span class="p">),</span> <span class="n">anomalous_metric</span><span class="p">,</span> <span class="n">redis_set</span><span class="p">))</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_list_data</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="n">not_anomalous_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total_anomalies</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.not_anomalous_metrics&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">not_anomalous_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to determine not_anomalous_count from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">not_anomalous_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;aet.analyzer_labelled_metrics.not_anomalous_metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.not_anomalous_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.analyzer_labelled_metrics.not_anomalous_metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.anomalous_metrics&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">total_anomalies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to determine anomalous_count from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">total_anomalies</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;aet.analyzer_labelled_metrics.anomalous_metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.anomalous_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.analyzer_labelled_metrics.anomalous_metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
            <span class="c1"># Create busy key to enable feedback_labelled_metrics</span>
            <span class="k">if</span> <span class="n">total_anomalies</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.busy&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">total_anomalies</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: created analyzer_labelled_metrics.busy key&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to setex analyzer_labelled_metrics.busy - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">not_anomalous_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">total_errors</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">current_aligned_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p_starts</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="n">error_set</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.errors.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">total_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="n">error_set</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to scard </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">error_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="n">total_analyzed</span> <span class="o">=</span> <span class="n">not_anomalous_count</span> <span class="o">+</span> <span class="n">total_anomalies</span>
            <span class="n">run_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
            <span class="c1"># Log progress</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: seconds to run     :: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">run_time</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: total metrics      :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_labelled_metrics_count</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: total analyzed     :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">total_analyzed</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: total anomalies    :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">total_anomalies</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: total errors       :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">total_errors</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: exception stats    :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exceptions</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: anomaly breakdown  :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">anomaly_breakdown</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: stats              :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stats</span><span class="p">)</span>

            <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.labelled_metrics.run_time&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app_graphite_namespace</span><span class="p">)</span>
            <span class="n">run_time_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">run_time</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="n">run_time_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: could not send send_graphite_metric </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">send_metric_name</span><span class="p">,</span> <span class="n">run_time_str</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20230404 - Feature #4888: analyzer - load_shedding</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_labelled_metrics.run_time&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.run_time&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">run_time</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.run_time&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Analyzer could not update the Redis analyzer_labelled_metrics.run_time hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>


            <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">stat_name</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">skyline_app_graphite_namespace</span><span class="p">,</span> <span class="n">stat_name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="n">stat</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: could not send send_graphite_metric </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="n">stat</span><span class="p">]),</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: sent Graphite </span><span class="si">%s</span><span class="s1"> stats metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">exception</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.labelled_metrics.exceptions.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">skyline_app_graphite_namespace</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exceptions</span><span class="p">[</span><span class="n">exception</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: could not send send_graphite_metric </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exceptions</span><span class="p">[</span><span class="n">exception</span><span class="p">]),</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: sent Graphite </span><span class="si">%s</span><span class="s1"> exceptions metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exceptions</span><span class="p">)))</span>

            <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">mem_usage</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: memory usage after completed run - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_usage</span><span class="p">))</span>
            <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.labelled_metrics.mem_usage&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_usage</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: could not send send_graphite_metric </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_usage</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

            <span class="n">process_runtime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span>
            <span class="n">analyzer_optimum_run_duration</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_OPTIMUM_RUN_DURATION</span>
            <span class="k">if</span> <span class="n">process_runtime</span> <span class="o">&lt;</span> <span class="n">analyzer_optimum_run_duration</span><span class="p">:</span>
                <span class="n">sleep_for</span> <span class="o">=</span> <span class="p">(</span><span class="n">analyzer_optimum_run_duration</span> <span class="o">-</span> <span class="n">process_runtime</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics :: completed in </span><span class="si">%.2f</span><span class="s1"> seconds, sleeping for </span><span class="si">%.2f</span><span class="s1"> seconds due to low run time...&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">),</span> <span class="n">sleep_for</span><span class="p">))</span>
                <span class="n">sleep</span><span class="p">(</span><span class="n">sleep_for</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">sleep_for</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to del sleep_for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">process_runtime</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: analyzer_labelled_metrics :: failed to del process_runtime - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>