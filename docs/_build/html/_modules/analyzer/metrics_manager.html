<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>analyzer.metrics_manager &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">analyzer.metrics_manager</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for analyzer.metrics_manager</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">metrics_manager.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">kill</span><span class="p">,</span> <span class="n">getpid</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">exit</span> <span class="k">as</span> <span class="n">sys_exit</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>
<span class="kn">import</span> <span class="nn">resource</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">nullcontext</span>
<span class="c1"># @added 20220722 - Task #4624: Change all dict copy to deepcopy</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="c1"># @added 20201209 - Feature #3870: metrics_manager - check_data_sparsity</span>
<span class="kn">from</span> <span class="nn">msgpack</span> <span class="kn">import</span> <span class="n">Unpacker</span>
<span class="c1"># from collections import Counter</span>

<span class="c1"># @added 20201213 - Feature #3890: metrics_manager - sync_cluster_files</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># @added 20220708 - Info #4620: memray</span>
<span class="kn">import</span> <span class="nn">memray</span>

<span class="kn">import</span> <span class="nn">settings</span>
<span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="c1"># @modified 20201209 - Feature #3870: metrics_manager - check_data_sparsity</span>
    <span class="c1"># Added send_graphite_metric</span>
    <span class="c1"># @modified 20220630 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="c1"># Moved send_graphite_metric</span>
    <span class="c1"># get_redis_conn, get_redis_conn_decoded, send_graphite_metric,</span>
    <span class="n">get_redis_conn</span><span class="p">,</span> <span class="n">get_redis_conn_decoded</span><span class="p">,</span>
    <span class="c1"># @added 20201213 - Feature #3890: metrics_manager - sync_cluster_files</span>
    <span class="n">mkdir_p</span><span class="p">,</span>
    <span class="c1"># @added 20210624 - Feature #4150: metrics_manager - roomba batch processing metrics</span>
    <span class="n">sort_timeseries</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matched_or_regexed_in_list</span> <span class="kn">import</span> <span class="n">matched_or_regexed_in_list</span>

<span class="c1"># @added 20210430 - Task #4030: refactoring</span>
<span class="c1"># @modified 20220302 - Feature #4444: webapp - inactive_metrics</span>
<span class="c1">#                      Feature #3828: Add inactive columns to the metrics DB table</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.get_all_db_metric_names</span> <span class="kn">import</span> <span class="n">get_all_db_metric_names</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.get_all_active_db_metric_names</span> <span class="kn">import</span> <span class="n">get_all_active_db_metric_names</span>

<span class="c1"># @added 20210519 - Feature #4076: CUSTOM_STALE_PERIOD</span>
<span class="kn">from</span> <span class="nn">functions.settings.get_custom_stale_period</span> <span class="kn">import</span> <span class="n">custom_stale_period</span>
<span class="kn">from</span> <span class="nn">functions.thunder.stale_metrics</span> <span class="kn">import</span> <span class="n">thunder_stale_metrics</span>

<span class="c1"># @added 20210601 - Feature #4000: EXTERNAL_SETTINGS</span>
<span class="kn">from</span> <span class="nn">functions.settings.manage_external_settings</span> <span class="kn">import</span> <span class="n">manage_external_settings</span>

<span class="c1"># @added 20210602 - Feature #4076: CUSTOM_STALE_PERIOD</span>
<span class="kn">from</span> <span class="nn">functions.settings.get_external_settings</span> <span class="kn">import</span> <span class="n">get_external_settings</span>
<span class="kn">from</span> <span class="nn">functions.thunder.manage_thunder_alerted_on_stale_metrics_hash_key</span> <span class="kn">import</span> <span class="n">manage_thunder_alerted_on_stale_metrics_hash_key</span>
<span class="kn">from</span> <span class="nn">functions.redis.prune_metrics_timestamp_hash_key</span> <span class="kn">import</span> <span class="n">prune_metrics_timestamp_hash_key</span>
<span class="kn">from</span> <span class="nn">functions.thunder.no_data</span> <span class="kn">import</span> <span class="n">thunder_no_data</span>

<span class="c1"># @added 20210619 - Feature #4148: analyzer.metrics_manager.resolutions</span>
<span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
<span class="c1">#                   Feature #3870: metrics_manager - check_data_sparsity</span>
<span class="c1"># Use common functions</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.determine_data_frequency</span> <span class="kn">import</span> <span class="n">determine_data_frequency</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.determine_data_sparsity</span> <span class="kn">import</span> <span class="n">determine_data_sparsity</span>

<span class="c1"># @added 20220110 - Bug #4364: Prune old thunder.events</span>
<span class="c1">#                   Branch #1444: thunder</span>
<span class="kn">from</span> <span class="nn">functions.redis.update_set</span> <span class="kn">import</span> <span class="n">update_redis_set</span>

<span class="c1"># @added 20220128 - Feature #4404: flux - external_settings - aggregation</span>
<span class="kn">from</span> <span class="nn">functions.settings.external_settings_aggregation</span> <span class="kn">import</span> <span class="n">external_settings_aggregation</span>

<span class="c1"># @added 20220128 - Feature #4404: flux - external_settings - aggregation</span>
<span class="c1">#                   Feature #4324: flux - reload external_settings</span>
<span class="c1">#                   Feature #4376: webapp - update_external_settings</span>
<span class="kn">from</span> <span class="nn">functions.flux.reload_flux</span> <span class="kn">import</span> <span class="n">reload_flux</span>

<span class="c1"># @added 20220406 - Feature #4518: settings - LAST_KNOWN_VALUE_NAMESPACES</span>
<span class="c1">#                   Feature #4520: settings - ZERO_FILL_NAMESPACES</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.last_known_value_metrics</span> <span class="kn">import</span> <span class="n">last_known_value_metrics</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.zero_fill_metrics</span> <span class="kn">import</span> <span class="n">zero_fill_metrics</span>
<span class="c1"># @added 20220410 - Task #4514: Integrate opentelemetry</span>
<span class="c1">#                   Feature #4516: flux - opentelemetry traces</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.do_not_alert_on_stale_metrics</span> <span class="kn">import</span> <span class="n">do_not_alert_on_stale_metrics</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.non_derivative_metrics</span> <span class="kn">import</span> <span class="n">non_derivative_metrics</span>

<span class="c1"># @added 20220419 - Feature #4528: metrics_manager - derivative_metric_check</span>
<span class="c1">#                   Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.derivative_metrics_check</span> <span class="kn">import</span> <span class="n">derivative_metrics_check</span>
<span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.filesafe_names</span> <span class="kn">import</span> <span class="n">filesafe_names</span>
<span class="c1"># @added 20220420 - Feature #4530: namespace.analysed_events</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.namespace_analysed_events</span> <span class="kn">import</span> <span class="n">namespace_analysed_events</span>

<span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
<span class="kn">from</span> <span class="nn">functions.memcache.get_memcache_key</span> <span class="kn">import</span> <span class="n">get_memcache_key</span>
<span class="kn">from</span> <span class="nn">functions.memcache.set_memcache_key</span> <span class="kn">import</span> <span class="n">set_memcache_key</span>
<span class="c1"># @added 20220427 - Feature #4536: Handle Redis failure</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.get_flux_namespaces</span> <span class="kn">import</span> <span class="n">get_flux_namespaces</span>

<span class="c1"># @added 20220620 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.manage_prometheus_metadata</span> <span class="kn">import</span> <span class="n">manage_prometheus_metadata</span>

<span class="c1"># @added 20220627 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.redistimeseries_roomba</span> <span class="kn">import</span> <span class="n">redistimeseries_roomba</span>

<span class="c1"># @added 20220726 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.graphite.send_graphite_metric</span> <span class="kn">import</span> <span class="n">send_graphite_metric</span>

<span class="c1"># @added 20220727 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.prune_expose_prometheus_metrics</span> <span class="kn">import</span> <span class="n">prune_expose_prometheus_metrics</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.manage_smtp_alerter_labelled_metrics</span> <span class="kn">import</span> <span class="n">manage_smtp_alerter_labelled_metrics</span>

<span class="c1"># @added 20220824 - Feature #3870: metrics_manager - check_data_sparsity</span>
<span class="c1"># Do not check new metrics</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.get_new_metrics</span> <span class="kn">import</span> <span class="n">get_new_metrics</span>

<span class="c1"># @added 20220919 - Feature #4676: analyzer - illuminance.all key</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.get_algorithms</span> <span class="kn">import</span> <span class="n">get_algorithms</span>

<span class="c1"># @added 20221130 - Feature #4734: mirage_vortex</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.purge_vortex_saved_data</span> <span class="kn">import</span> <span class="n">purge_vortex_saved_data</span>

<span class="c1"># @added 20230105 - Feature #4792: functions.metrics_manager.manage_inactive_metrics</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.manage_inactive_metrics</span> <span class="kn">import</span> <span class="n">manage_inactive_metrics</span>

<span class="c1"># @added 20230123 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="c1">#                   Feature #4444: webapp - inactive_metrics</span>
<span class="c1"># Set the passed metric ids to active again</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.set_metric_ids_as_active</span> <span class="kn">import</span> <span class="n">set_metric_ids_as_active</span>

<span class="c1"># @added 20230406 - Feature #4882: labelled_metrics - resolution and data sparsity</span>
<span class="c1">#                   Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.update_labelled_metrics_data_sparsity</span> <span class="kn">import</span> <span class="n">update_labelled_metrics_data_sparsity</span>

<span class="c1"># @added 20230505 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.skip_irregular_unstable_metric_ids</span> <span class="kn">import</span> <span class="n">build_skip_irregular_unstable_metric_ids</span>

<span class="c1"># @added 20230510 - Feature #4902: Prevent training on metrics newer than 7 days</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.manage_untrainable_new_metrics</span> <span class="kn">import</span> <span class="n">manage_untrainable_new_metrics</span>

<span class="c1"># @added 20230519 - metric_type.longterm_expire</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.manage_labelled_metrics_longterm_metric_type</span> <span class="kn">import</span> <span class="n">manage_labelled_metrics_longterm_metric_type</span>

<span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
<span class="kn">from</span> <span class="nn">functions.metrics_manager.manage_mute_alerts_on</span> <span class="kn">import</span> <span class="n">manage_mute_alerts_on</span>

<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;analyzer&#39;</span>
<span class="n">skyline_app_logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Log&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
<span class="n">skyline_app_logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
<span class="n">skyline_app_loglock</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">skyline_app_logwait</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wait&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>

<span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">this_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
    <span class="k">if</span> <span class="n">SERVER_METRIC_PATH</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># @modified 20190524 - Feature #2882: Mirage - periodic_check</span>
<span class="c1">#                      Branch #3002: docker</span>
<span class="c1"># Moved the interpolation of the MIRAGE_PERIODIC_ variables to the top</span>
<span class="c1"># of the file out of spawn_process so they can be accessed in run too</span>
<span class="c1"># @added 20190408 - Feature #2882: Mirage - periodic_check</span>
<span class="c1"># Add Mirage periodic checks so that Mirage is analysing each metric at</span>
<span class="c1"># least once per hour.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20200606 - Bug #3572: Apply list to settings imports</span>
    <span class="n">MIRAGE_PERIODIC_CHECK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_PERIODIC_CHECK</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MIRAGE_PERIODIC_CHECK</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">MIRAGE_PERIODIC_CHECK_INTERVAL</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_PERIODIC_CHECK_INTERVAL</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MIRAGE_PERIODIC_CHECK_INTERVAL</span> <span class="o">=</span> <span class="mi">3600</span>
<span class="c1"># @added 20200505 - Feature #2882: Mirage - periodic_check</span>
<span class="c1"># Surface this once</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20200606 - Bug #3572: Apply list to settings imports</span>
    <span class="n">mirage_periodic_check_namespaces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_PERIODIC_CHECK_NAMESPACES</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">mirage_periodic_check_namespaces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ANALYZER_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ANALYZER_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;warning :: ANALYZER_ENABLED is not declared in settings.py, defaults to True&#39;</span><span class="p">)</span>

<span class="c1"># @added 20200528 - Feature #3560: External alert config</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">EXTERNAL_ALERTS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_ALERTS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">EXTERNAL_ALERTS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># @added 20200602 - Feature #3560: External alert config</span>
<span class="k">if</span> <span class="n">EXTERNAL_ALERTS</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">external_alert_configs</span> <span class="kn">import</span> <span class="n">get_external_alert_configs</span>

<span class="c1"># @added 20200607 - Feature #3566: custom_algorithms</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">MIRAGE_ALWAYS_METRICS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRAGE_ALWAYS_METRICS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MIRAGE_ALWAYS_METRICS</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20200827 - Feature #3708: FLUX_ZERO_FILL_NAMESPACES</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_ZERO_FILL_NAMESPACES</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_ZERO_FILL_NAMESPACES</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_ZERO_FILL_NAMESPACES</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_LAST_KNOWN_VALUE_NAMESPACES</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_LAST_KNOWN_VALUE_NAMESPACES</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_LAST_KNOWN_VALUE_NAMESPACES</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20201017 - Feature #3818: ANALYZER_BATCH_PROCESSING_OVERFLOW_ENABLED</span>
<span class="c1"># This was implemented to allow a busy analyzer to offload low priority metrics</span>
<span class="c1"># to analyzer_batch, unsuccessfully.  It works, but takes loanger and ages</span>
<span class="c1"># actually.  Being left in as may be workable with a different logic.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ANALYZER_BATCH_PROCESSING_OVERFLOW_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_BATCH_PROCESSING_OVERFLOW_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ANALYZER_BATCH_PROCESSING_OVERFLOW_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># Always disable until refactored to work more efficiently if possible</span>
<span class="n">ANALYZER_BATCH_PROCESSING_OVERFLOW_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20201030 - Feature #3812: ANALYZER_ANALYZE_LOW_PRIORITY_METRICS</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ANALYZER_ANALYZE_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_ANALYZE_LOW_PRIORITY_METRICS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ANALYZER_ANALYZE_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># @added 20201030 - Feature #3808: ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># @added 20201018 - Feature #3810: ANALYZER_MAD_LOW_PRIORITY_METRICS</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ANALYZER_MAD_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_MAD_LOW_PRIORITY_METRICS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ANALYZER_MAD_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># @added 20201030 - Feature #3808: ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS</span>
<span class="c1"># Set the default ANALYZER_MAD_LOW_PRIORITY_METRICS to 10 if not set and</span>
<span class="c1"># ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS is set.</span>
<span class="k">if</span> <span class="n">ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ANALYZER_MAD_LOW_PRIORITY_METRICS</span><span class="p">:</span>
        <span class="n">ANALYZER_MAD_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Determine all the settings that place Analyzer in a mode to handle low</span>
<span class="c1"># priority metrics differently</span>
<span class="n">ANALYZER_MANAGE_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">ANALYZER_BATCH_PROCESSING_OVERFLOW_ENABLED</span><span class="p">:</span>
    <span class="n">ANALYZER_MANAGE_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">ANALYZER_ANALYZE_LOW_PRIORITY_METRICS</span><span class="p">:</span>
    <span class="n">ANALYZER_MANAGE_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS</span><span class="p">:</span>
    <span class="n">ANALYZER_MANAGE_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">ANALYZER_MAD_LOW_PRIORITY_METRICS</span><span class="p">:</span>
    <span class="n">ANALYZER_MANAGE_LOW_PRIORITY_METRICS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">low_priority_metrics_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.low_priority_metrics.last_analyzed_timestamp&#39;</span>
<span class="n">metrics_last_timestamp_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics.last_analyzed_timestamp&#39;</span>

<span class="c1"># @added 20201209 - Feature #3870: metrics_manager - check_data_sparsity</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">CHECK_DATA_SPARSITY</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">CHECK_DATA_SPARSITY</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">CHECK_DATA_SPARSITY</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">inactive_after</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">METRICS_INACTIVE_AFTER</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">inactive_after</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span> <span class="o">-</span> <span class="mi">3600</span>
<span class="c1"># @added 20201210 - Feature #3870: metrics_manager - check_data_sparsity</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">SKIP_CHECK_DATA_SPARSITY_NAMESPACES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKIP_CHECK_DATA_SPARSITY_NAMESPACES</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SKIP_CHECK_DATA_SPARSITY_NAMESPACES</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># Declare how often to run metrics_manager is seconds as this is used on some</span>
<span class="c1"># Redis key TTLs as well</span>
<span class="n">RUN_EVERY</span> <span class="o">=</span> <span class="mi">300</span>

<span class="c1"># @added 20201212 - Feature #3884: ANALYZER_CHECK_LAST_TIMESTAMP</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ANALYZER_CHECK_LAST_TIMESTAMP</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_CHECK_LAST_TIMESTAMP</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ANALYZER_CHECK_LAST_TIMESTAMP</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20201213 - Feature #3890: metrics_manager - sync_cluster_files</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">SYNC_CLUSTER_FILES</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SYNC_CLUSTER_FILES</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SYNC_CLUSTER_FILES</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FAKE_CLUSTER_SYNC</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FAKE_CLUSTER_SYNC</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FAKE_CLUSTER_SYNC</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># @added 20201214 - Feature #3890: metrics_manager - sync_cluster_files</span>
<span class="c1">#                   Feature #3820: HORIZON_SHARDS</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
    <span class="c1"># HORIZON_SHARDS = settings.HORIZON_SHARDS.copy()</span>
    <span class="n">HORIZON_SHARDS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">HORIZON_SHARDS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">HORIZON_SHARDS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">number_of_horizon_shards</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">HORIZON_SHARD</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">zlib</span>
    <span class="n">number_of_horizon_shards</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">HORIZON_SHARDS</span><span class="p">)</span>
    <span class="n">HORIZON_SHARD</span> <span class="o">=</span> <span class="n">HORIZON_SHARDS</span><span class="p">[</span><span class="n">this_host</span><span class="p">]</span>

<span class="c1"># @added 20210202 - Feature #3934: ionosphere_performance</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">IONOSPHERE_PERFORMANCE_DATA_POPULATE_CACHE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PERFORMANCE_DATA_POPULATE_CACHE</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">IONOSPHERE_PERFORMANCE_DATA_POPULATE_CACHE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">IONOSPHERE_PERFORMANCE_DATA_POPULATE_CACHE_DEPTH</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PERFORMANCE_DATA_POPULATE_CACHE_DEPTH</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">IONOSPHERE_PERFORMANCE_DATA_POPULATE_CACHE_DEPTH</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># @added 20210406 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
    <span class="c1"># FLUX_AGGREGATE_NAMESPACES = settings.FLUX_AGGREGATE_NAMESPACES.copy()</span>
    <span class="n">FLUX_AGGREGATE_NAMESPACES</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLUX_AGGREGATE_NAMESPACES</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_AGGREGATE_NAMESPACES</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_EXTERNAL_AGGREGATE_NAMESPACES</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_EXTERNAL_AGGREGATE_NAMESPACES</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_EXTERNAL_AGGREGATE_NAMESPACES</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20210513 - Feature #4068: ANALYZER_SKIP</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ANALYZER_SKIP</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_SKIP</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ANALYZER_SKIP</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20210519 - Feature #4076: CUSTOM_STALE_PERIOD</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
    <span class="c1"># CUSTOM_STALE_PERIOD = settings.CUSTOM_STALE_PERIOD.copy()</span>
    <span class="n">CUSTOM_STALE_PERIOD</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CUSTOM_STALE_PERIOD</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">CUSTOM_STALE_PERIOD</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># @added 20210601 - Feature #4000: EXTERNAL_SETTINGS</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
    <span class="c1"># EXTERNAL_SETTINGS = settings.EXTERNAL_SETTINGS.copy()</span>
    <span class="n">EXTERNAL_SETTINGS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_SETTINGS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">EXTERNAL_SETTINGS</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">MEMRAY_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMRAY_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MEMRAY_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20220727 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">EXPOSE_PROMETHEUS_METRICS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">EXPOSE_PROMETHEUS_METRICS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">EXPOSE_PROMETHEUS_METRICS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20221125 - Feature #4734: mirage_vortex</span>
<span class="c1"># Prune the mirage.vortex and flux.vortex hash keys</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">VORTEX_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VORTEX_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">VORTEX_SAVE_RESULTS_FOR</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_SAVE_RESULTS_FOR</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VORTEX_SAVE_RESULTS_FOR</span> <span class="o">=</span> <span class="mi">86400</span>

<span class="n">skyline_app_graphite_namespace</span> <span class="o">=</span> <span class="s1">&#39;skyline.</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">SERVER_METRIC_PATH</span><span class="p">)</span>

<span class="n">full_uniques</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">unique_metrics&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span>

<span class="n">LOCAL_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="Metrics_Manager"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.metrics_manager.Metrics_Manager">[docs]</a><span class="k">class</span> <span class="nc">Metrics_Manager</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Metrics_Manager class which controls the metrics_manager thread and</span>
<span class="sd">    spawned processes.</span>

<span class="sd">    All of this functionality was previously done in the Analyzer thread itself</span>
<span class="sd">    however with 10s of 1000s of metrics, this process can take longer than a</span>
<span class="sd">    minute to achieve, which would make Analyzer lag.  All the original commits</span>
<span class="sd">    and references from the Analyzer code have been maintained here, although</span>
<span class="sd">    the logical order has been changed and the blocks ordered in a different,</span>
<span class="sd">    but more appropriate and efficient manner than they were laid out in Analyzer.</span>
<span class="sd">    Further some blocks from Analyzer were removed with the new consolidated</span>
<span class="sd">    methods using sets, they were no longer required.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_pid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Metrics_Manager</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># super(Metrics_Manager, self).__init__()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_redis_conn - failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_redis_conn_decoded - failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span> <span class="o">=</span> <span class="n">parent_pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">()</span>

<div class="viewcode-block" id="Metrics_Manager.check_if_parent_is_alive"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.metrics_manager.Metrics_Manager.check_if_parent_is_alive">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_parent_is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Self explanatory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sys_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

    <span class="c1"># @added 20201214 - Feature #3890: metrics_manager - sync_cluster_files</span>
    <span class="c1">#                   Feature #3820: HORIZON_SHARDS</span>
<div class="viewcode-block" id="Metrics_Manager.assigned_to_shard"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.metrics_manager.Metrics_Manager.assigned_to_shard">[docs]</a>    <span class="k">def</span> <span class="nf">assigned_to_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine which shard a metric is assigned to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assigned_host</span> <span class="o">=</span> <span class="n">this_host</span>
        <span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_as_bytes</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">adler32</span><span class="p">(</span><span class="n">metric_as_bytes</span><span class="p">)</span>
                <span class="n">modulo_result</span> <span class="o">=</span> <span class="n">value</span> <span class="o">%</span> <span class="n">number_of_horizon_shards</span>
                <span class="k">for</span> <span class="n">shard_hostname</span> <span class="ow">in</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">[</span><span class="n">shard_hostname</span><span class="p">]</span> <span class="o">==</span> <span class="n">modulo_result</span><span class="p">:</span>
                        <span class="n">assigned_host</span> <span class="o">=</span> <span class="n">shard_hostname</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine what shard </span><span class="si">%s</span><span class="s1"> is assigned to via modulo and HORIZON_SHARDS: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">assigned_host</span></div>

<div class="viewcode-block" id="Metrics_Manager.get_remote_data"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.metrics_manager.Metrics_Manager.get_remote_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_remote_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_skyline_instance</span><span class="p">,</span> <span class="n">data_required</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connect_timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_CONNECT_TIMEOUT</span><span class="p">)</span>
            <span class="n">read_timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_READ_TIMEOUT</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">connect_timeout</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">read_timeout</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">use_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">connect_timeout</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">read_timeout</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">password</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">use_auth</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">use_auth</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">password</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @modified 20220510 - Task #4568: Reduce cluster logging</span>
        <span class="c1">#                      Release #4562: v3.0.4</span>
        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: metrics_manager :: get_remote_data - querying </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">endpoint</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">use_auth</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">use_timeout</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">use_timeout</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_remote_data - failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">endpoint</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
            <span class="c1"># @modified 20220510 - Task #4568: Reduce cluster logging</span>
            <span class="c1">#                      Release #4562: v3.0.4</span>
            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: metrics_manager :: get_remote_data - no r from </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_remote_data - </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> responded with status code </span><span class="si">%s</span><span class="s1"> and reason </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">reason</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">save_file</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">file_saved</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">save_file</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_remote_data - failed to save_file </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">save_file</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">file_saved</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_remote_data - failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="k">return</span> <span class="n">file_saved</span>

            <span class="n">js</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">js</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_remote_data - failed to get json from the response from </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: metrics_manager :: get_remote_data - data_required: </span><span class="si">%s</span><span class="s1">, endpoint: </span><span class="si">%s</span><span class="s1">, save_file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">endpoint</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">save_file</span><span class="p">)))</span>
            <span class="n">data_required</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">save_file</span>
            <span class="k">if</span> <span class="n">js</span><span class="p">:</span>
                <span class="c1"># @modified 20220510 - Task #4568: Reduce cluster logging</span>
                <span class="c1">#                      Release #4562: v3.0.4</span>
                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: metrics_manager :: get_remote_data - got response for </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">js</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">data_required</span><span class="p">]</span>
                    <span class="c1"># @modified 20220510 - Task #4568: Reduce cluster logging</span>
                    <span class="c1">#                      Release #4562: v3.0.4</span>
                    <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: debug :: get_remote_data - response for </span><span class="si">%s</span><span class="s1"> has </span><span class="si">%s</span><span class="s1"> items&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_remote_data - failed to build remote_training_data from </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">data</span></div>

    <span class="c1"># @added 20201213 - Feature #3890: metrics_manager - sync_cluster_files</span>
<div class="viewcode-block" id="Metrics_Manager.sync_cluster_files"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.metrics_manager.Metrics_Manager.sync_cluster_files">[docs]</a>    <span class="k">def</span> <span class="nf">sync_cluster_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch any missing training_data and features_profiles directories and</span>
<span class="sd">        files from REMOTE_SKYLINE_INSTANCES</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spin_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files started - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">local_skyline_instance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">remote_skyline_instance</span> <span class="ow">in</span> <span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
            <span class="c1"># @added 20201213 - Feature #3890: metrics_manager - sync_cluster_files</span>
            <span class="c1"># if remote_skyline_instance == settings.SKYLINE_URL:</span>
            <span class="k">if</span> <span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">this_host</span><span class="p">:</span>
                <span class="n">local_skyline_instance</span> <span class="o">=</span> <span class="n">remote_skyline_instance</span>
        <span class="k">if</span> <span class="n">FAKE_CLUSTER_SYNC</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files FAKE_CLUSTER_SYNC - True&#39;</span><span class="p">)</span>
            <span class="n">skyline_url</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_PORT</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
                <span class="n">local_skyline_instance</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">skyline_url</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER</span><span class="p">,</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER_PASSWORD</span><span class="p">,</span> <span class="n">this_host</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">local_skyline_instance</span> <span class="o">=</span> <span class="p">[</span><span class="n">skyline_url</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">this_host</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">local_skyline_instance</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files could not determine local_skyline_instance from REMOTE_SKYLINE_INSTANCES, created&#39;</span><span class="p">)</span>
            <span class="n">skyline_url</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_PORT</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
                <span class="n">local_skyline_instance</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">skyline_url</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER</span><span class="p">,</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER_PASSWORD</span><span class="p">,</span> <span class="n">this_host</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">local_skyline_instance</span> <span class="o">=</span> <span class="p">[</span><span class="n">skyline_url</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">this_host</span><span class="p">]</span>

        <span class="c1"># Check training data on REMOTE_SKYLINE_INSTANCES and determine what</span>
        <span class="c1"># training_data needs to be fetched</span>
        <span class="n">training_data_raw</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">training_data_raw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.training_data&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to generate a list from ionosphere.training_data Redis set&#39;</span><span class="p">)</span>
            <span class="n">training_data_raw</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">training_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">training_data_raw</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">training_data_str</span> <span class="ow">in</span> <span class="n">training_data_raw</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">training_data_item</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">training_data_str</span><span class="p">)</span>
                    <span class="n">training_metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">training_data_item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">training_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">training_data_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">training_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">training_metric</span><span class="p">,</span> <span class="n">training_timestamp</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to interpolate training data: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">training_data_raw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">training_data_already_present</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">training_data_to_fetch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">training_data_fetched</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Rate limit this so that a new instance becomes eventually consistent</span>
        <span class="c1"># add does not thunder against all the other Skyline instances to</span>
        <span class="c1"># populate itself</span>
        <span class="n">max_training_data_to_fetch</span> <span class="o">=</span> <span class="mi">30</span>

        <span class="k">for</span> <span class="n">remote_skyline_instance</span> <span class="ow">in</span> <span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">training_data_fetched</span> <span class="o">&gt;=</span> <span class="n">max_training_data_to_fetch</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: metrics_manager :: fetched training data has reached the limit of </span><span class="si">%s</span><span class="s1">, not continuing to fetch more this run&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_training_data_to_fetch</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="n">remote_training_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">data_required</span> <span class="o">=</span> <span class="s1">&#39;metrics&#39;</span>
            <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;api?training_data&#39;</span>
            <span class="n">save_file</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_training_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_data</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">,</span> <span class="n">data_required</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">save_file</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">remote_training_data_to_fetch</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">training_data_already_fetched</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">remote_training_data</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files - got </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_training_data</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="k">for</span> <span class="n">remote_training_data_item</span> <span class="ow">in</span> <span class="n">remote_training_data</span><span class="p">:</span>

                    <span class="c1"># @added 20230511 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="c1"># Handle labelled_metrics, there are entries for training data for</span>
                    <span class="c1"># both the labelled_metrics.&lt;METRIC_ID&gt; and the labelled metric base_name</span>
                    <span class="c1"># in terms of syncing, only the labelled_metrics.&lt;METRIC_ID&gt; entry needs</span>
                    <span class="c1"># to be handled</span>
                    <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">remote_training_data_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">training_data_already_present</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">remote_training_data_item</span> <span class="ow">in</span> <span class="n">training_data</span><span class="p">:</span>
                        <span class="n">training_data_already_present</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="n">training_data_to_fetch</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">remote_training_data_to_fetch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote_training_data_item</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files - </span><span class="si">%s</span><span class="s1"> training_data dirs from </span><span class="si">%s</span><span class="s1"> already present locally&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">training_data_already_present</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files - </span><span class="si">%s</span><span class="s1"> training_data dirs to fetch from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_training_data_to_fetch</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            
            <span class="k">if</span> <span class="n">remote_training_data_to_fetch</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fetch_item</span> <span class="ow">in</span> <span class="n">remote_training_data_to_fetch</span><span class="p">:</span>
                    <span class="n">cache_key_exists</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics_manager.training_data_fetched.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">fetch_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fetch_item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">cache_key_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">if</span> <span class="n">cache_key_exists</span><span class="p">:</span>
                        <span class="n">training_data_already_fetched</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="n">remote_training_data_files</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data_required</span> <span class="o">=</span> <span class="s1">&#39;files&#39;</span>
                        <span class="n">save_file</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;ionosphere_files?source=training_data&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;timestamp=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">fetch_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fetch_item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">remote_training_data_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_data</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">,</span> <span class="n">data_required</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">save_file</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">remote_training_data_files</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: debug :: sync_cluster_files - no training_data files were returned from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="k">if</span> <span class="n">remote_training_data_files</span><span class="p">:</span>
                        <span class="n">files_to_fetch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_training_data_files</span><span class="p">)</span>
                        <span class="n">files_fetched</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">files_exist</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files - </span><span class="si">%s</span><span class="s1"> training_data files to fetch from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">files_to_fetch</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                        <span class="k">for</span> <span class="n">remote_file</span> <span class="ow">in</span> <span class="n">remote_training_data_files</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">data_file</span> <span class="o">=</span> <span class="n">remote_training_data_files</span><span class="p">[</span><span class="n">remote_file</span><span class="p">]</span>
                                <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
                                    <span class="n">mkdir_p</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to create dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_dir</span><span class="p">)</span>
                                    <span class="k">continue</span>
                                <span class="n">data_required</span> <span class="o">=</span> <span class="s1">&#39;file_saved&#39;</span>
                                <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;ionosphere_file?file=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
                                <span class="n">file_saved</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">data_file</span><span class="p">):</span>
                                    <span class="n">file_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_data</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">,</span> <span class="n">data_required</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">data_file</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_saved</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">data_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                                        <span class="k">continue</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files - got </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">data_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                                    <span class="n">files_fetched</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files - file exists locally nothing to do </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">data_file</span><span class="p">))</span>
                                    <span class="n">files_exist</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                        <span class="k">if</span> <span class="n">files_fetched</span> <span class="o">==</span> <span class="n">files_to_fetch</span><span class="p">:</span>
                            <span class="n">training_data_fetched</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics_manager.training_data_fetched.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">fetch_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fetch_item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;created Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cache_key</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">if</span> <span class="n">files_exist</span> <span class="o">==</span> <span class="n">files_to_fetch</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files - all </span><span class="si">%s</span><span class="s1"> files to fetch exist locally, nothing to do&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">files_to_fetch</span><span class="p">)))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics_manager.training_data_fetched.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">fetch_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fetch_item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;created Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cache_key</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">files_fetched</span> <span class="o">+</span> <span class="n">files_exist</span><span class="p">)</span> <span class="o">!=</span> <span class="n">files_to_fetch</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to get all </span><span class="si">%s</span><span class="s1"> training_data files for </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">files_to_fetch</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fetch_item</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files - </span><span class="si">%s</span><span class="s1"> training_data dirs already fetched and present locally&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">training_data_already_fetched</span><span class="p">)))</span>

        <span class="c1"># Check what features_profiles directories need to be retrieved from</span>
        <span class="c1"># REMOTE_SKYLINE_INSTANCES and saved locally</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checking for expected_features_profiles_dir&#39;</span><span class="p">)</span>
        <span class="n">expected_features_profile_dirs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;api?expected_features_profiles_dir&#39;</span>
            <span class="n">data_required</span> <span class="o">=</span> <span class="s1">&#39;features_profile_dirs&#39;</span>
            <span class="n">save_file</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">expected_features_profile_dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_data</span><span class="p">(</span><span class="n">local_skyline_instance</span><span class="p">,</span> <span class="n">data_required</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">save_file</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries in the expected_features_profiles_dir response&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expected_features_profile_dirs</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">local_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">expected_features_profile_dirs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">local_features_profile_dirs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">local_features_profile_dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.local_features_profile_dirs&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries in the analyzer.metrics_manager.local_features_profile_dirs Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local_features_profile_dirs</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get Redis hash key analyzer.metrics_manager.local_features_profile_dirs&#39;</span><span class="p">)</span>
            <span class="n">local_features_profile_dirs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">get_features_profile_dirs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_features_profile_dirs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_features_profile_dirs</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: all </span><span class="si">%s</span><span class="s1"> expected features_profile_dirs are present locally&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expected_features_profile_dirs</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">expected_features_profile_dir</span> <span class="ow">in</span> <span class="n">expected_features_profile_dirs</span><span class="p">:</span>
                <span class="n">dir_known</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">local_features_profile_dirs</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dir_known</span> <span class="o">=</span> <span class="n">local_features_profile_dirs</span><span class="p">[</span><span class="n">expected_features_profile_dir</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">dir_known</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">dir_known</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">expected_dir</span> <span class="o">=</span> <span class="n">expected_features_profile_dirs</span><span class="p">[</span><span class="n">expected_features_profile_dir</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                <span class="s1">&#39;analyzer.metrics_manager.local_features_profile_dirs&#39;</span><span class="p">,</span>
                                <span class="n">expected_features_profile_dir</span><span class="p">,</span> <span class="n">expected_dir</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> exists locally, added to analyzer.metrics_manager.local_features_profile_dirs&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">))</span>
                            <span class="k">continue</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in analyzer.metrics_manager.local_features_profile_dirs for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to test expected_dir: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">expected_features_profile_dirs</span><span class="p">[</span><span class="n">expected_features_profile_dir</span><span class="p">]:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: skipping </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_features_profile_dirs</span><span class="p">[</span><span class="n">expected_features_profile_dir</span><span class="p">]))</span>
                        <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine if _tenant_id in expected_features_profile_dirs[expected_features_profile_dir] - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">get_features_profile_dirs</span><span class="p">[</span><span class="n">expected_features_profile_dir</span><span class="p">]</span> <span class="o">=</span> <span class="n">expected_features_profile_dirs</span><span class="p">[</span><span class="n">expected_features_profile_dir</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add to get_features_profile_dirs: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set to get </span><span class="si">%s</span><span class="s1"> features_profile_dirs not present locally&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">get_features_profile_dirs</span><span class="p">)))</span>

        <span class="c1"># Add any entires that need to be checked for an update</span>
        <span class="n">local_features_profile_dirs_to_update</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">local_features_profile_dirs_to_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.local_features_profile_dirs.to_update&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries in the analyzer.metrics_manager.local_features_profile_dirs.to_update Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local_features_profile_dirs_to_update</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get Redis hash key analyzer.metrics_manager.local_features_profile_dirs.to_update&#39;</span><span class="p">)</span>
            <span class="n">local_features_profile_dirs_to_update</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">local_features_profile_dirs_to_update</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">local_features_profile_dir_to_update</span> <span class="ow">in</span> <span class="n">local_features_profile_dirs_to_update</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">get_features_profile_dirs</span><span class="p">[</span><span class="n">local_features_profile_dir_to_update</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_features_profile_dirs_to_update</span><span class="p">[</span><span class="n">local_features_profile_dir_to_update</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add to get_features_profile_dirs: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># Rate limit this so that a new instance becomes eventually consistent</span>
        <span class="c1"># add does not thunder against all the other Skyline instances to</span>
        <span class="c1"># populate itself</span>
        <span class="n">max_fps_to_fetch</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">fps_fetched</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">get_features_profile_dirs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fp_id</span> <span class="ow">in</span> <span class="n">get_features_profile_dirs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fps_fetched</span> <span class="o">&gt;=</span> <span class="n">max_fps_to_fetch</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: metrics_manager :: get_features_profile_dirs has reached the limit of </span><span class="si">%s</span><span class="s1">, not continuing to fetch more this run&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_fps_to_fetch</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="n">features_profile_dir</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">features_profile_dir</span> <span class="o">=</span> <span class="n">get_features_profile_dirs</span><span class="p">[</span><span class="n">fp_id</span><span class="p">]</span>
                    <span class="n">features_profile_dir_elements</span> <span class="o">=</span> <span class="n">features_profile_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">features_profile_dir_elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">metric_and_timestamp_path</span> <span class="o">=</span> <span class="n">features_profile_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">metric_and_timestamp_path_elements</span> <span class="o">=</span> <span class="n">metric_and_timestamp_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">metric_and_timestamp_path_elements</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">element</span> <span class="o">!=</span> <span class="n">timestamp</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">metric</span><span class="p">:</span>
                                <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                    <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;ionosphere_files?source=features_profiles&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;timestamp=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to determine endpoint related to fp_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)))</span>
                <span class="n">features_profile_files</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">remote_skyline_instance</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">USE_REMOTE_SKYLINE_INSTANCES</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">remote_skyline_instance</span> <span class="ow">in</span> <span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                    <span class="n">USE_REMOTE_SKYLINE_INSTANCES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">USE_REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">FAKE_CLUSTER_SYNC</span><span class="p">:</span>
                    <span class="n">USE_REMOTE_SKYLINE_INSTANCES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_skyline_instance</span><span class="p">)</span>

                <span class="c1"># @added 20201214 - Feature #3890: metrics_manager - sync_cluster_files</span>
                <span class="c1">#                   Feature #3820: HORIZON_SHARDS</span>
                <span class="c1"># Determine the authorative REMOTE_SKYLINE_INSTANCES which is</span>
                <span class="c1"># assigned to metric and query it first.</span>
                <span class="n">authorative_host</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">authorative_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_to_shard</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to determine authorative_host for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">authorative_host</span><span class="p">:</span>
                        <span class="n">USE_REMOTE_SKYLINE_INSTANCES</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">remote_skyline_instance</span> <span class="ow">in</span> <span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">authorative_host</span><span class="p">:</span>
                                    <span class="n">USE_REMOTE_SKYLINE_INSTANCES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to the remote_skyline_instance list for the authorative_host - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">authorative_host</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">remote_skyline_instance</span> <span class="ow">in</span> <span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">authorative_host</span><span class="p">:</span>
                                    <span class="n">USE_REMOTE_SKYLINE_INSTANCES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to the secondary remote_skyline_instance list for the authorative_host - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">authorative_host</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">remote_skyline_instance</span> <span class="ow">in</span> <span class="n">USE_REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">endpoint</span><span class="p">:</span>
                        <span class="n">data_required</span> <span class="o">=</span> <span class="s1">&#39;files&#39;</span>
                        <span class="n">save_file</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">host_features_profile_files</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">host_features_profile_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_data</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">,</span> <span class="n">data_required</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">save_file</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                            <span class="n">host_features_profile_files</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">host_features_profile_files</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">features_profile_file</span> <span class="ow">in</span> <span class="n">host_features_profile_files</span><span class="p">:</span>
                                <span class="n">known_features_profile_file</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">known_features_profile_file</span> <span class="o">=</span> <span class="n">features_profile_files</span><span class="p">[</span><span class="n">features_profile_file</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">known_features_profile_file</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">known_features_profile_file</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">features_profile_files</span><span class="p">[</span><span class="n">features_profile_file</span><span class="p">]</span> <span class="o">=</span> <span class="n">host_features_profile_files</span><span class="p">[</span><span class="n">features_profile_file</span><span class="p">]</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to add features_profile_file </span><span class="si">%s</span><span class="s1"> to features_profile_files - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">features_profile_file</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_profile_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> features profile files found to download from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features_profile_files</span><span class="p">)),</span> <span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">features_profile_dir</span><span class="p">))</span>
                        <span class="c1"># break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> features profile files found to download from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features_profile_files</span><span class="p">)),</span> <span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">features_profile_dir</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">features_profile_files</span> <span class="ow">and</span> <span class="n">FAKE_CLUSTER_SYNC</span><span class="p">:</span>
                        <span class="n">features_profile_files</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;FAKE_CLUSTER_SYNC reseting features_profile_files with </span><span class="si">%s</span><span class="s1"> items found&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features_profile_files</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">FAKE_CLUSTER_SYNC</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">features_profile_files</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;FAKE_CLUSTER_SYNC no features_profile_files found&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">FAKE_CLUSTER_SYNC</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                <span class="s1">&#39;analyzer.metrics_manager.local_features_profile_dirs&#39;</span><span class="p">,</span>
                                <span class="c1"># expected_features_profile_dir, expected_dir)</span>
                                <span class="n">features_profile_dir</span><span class="p">,</span> <span class="n">expected_dir</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> exists locally, added to analyzer.metrics_manager.local_features_profile_dirs&#39;</span> <span class="o">%</span> <span class="n">expected_dir</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in analyzer.metrics_manager.local_features_profile_dirs for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">))</span>
                            <span class="n">features_profile_files</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">features_profile_files</span><span class="p">:</span>
                        <span class="n">files_to_fetch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_profile_files</span><span class="p">)</span>
                        <span class="n">files_fetched</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">files_present</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files - </span><span class="si">%s</span><span class="s1"> features_profile files to fetch for fp_id </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">files_to_fetch</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                        <span class="n">data_required</span> <span class="o">=</span> <span class="s1">&#39;file_saved&#39;</span>
                        <span class="k">for</span> <span class="n">remote_file</span> <span class="ow">in</span> <span class="n">features_profile_files</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">data_file</span> <span class="o">=</span> <span class="n">features_profile_files</span><span class="p">[</span><span class="n">remote_file</span><span class="p">]</span>
                                <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
                                    <span class="n">mkdir_p</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to create dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_dir</span><span class="p">)</span>
                                    <span class="k">continue</span>
                                <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;ionosphere_file?file=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
                                <span class="c1"># Only fetch it if it does not exist</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">data_file</span><span class="p">):</span>
                                    <span class="n">data_required</span> <span class="o">=</span> <span class="s1">&#39;file_saved&#39;</span>
                                    <span class="n">file_saved</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="n">file_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_data</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">,</span> <span class="n">data_required</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">data_file</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_saved</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">data_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                                        <span class="k">continue</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files - got </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">data_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                                    <span class="n">files_fetched</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">files_present</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">files_fetched</span> <span class="o">+</span> <span class="n">files_present</span><span class="p">)</span> <span class="o">==</span> <span class="n">files_to_fetch</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files - got all </span><span class="si">%s</span><span class="s1"> features_profile files that needed to be fetchd (</span><span class="si">%s</span><span class="s1"> were already present) for </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">files_to_fetch</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">files_present</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

                            <span class="c1"># @added 20230511 - Task #2732: Prometheus to Skyline</span>
                            <span class="c1">#                   Branch #4300: prometheus</span>
                            <span class="c1"># Handle labelled_metrics, there are entries for training data for</span>
                            <span class="c1"># both the labelled_metrics.&lt;METRIC_ID&gt; and the labelled metric base_name</span>
                            <span class="c1"># in terms of syncing, only the labelled_metrics.&lt;METRIC_ID&gt; entry needs</span>
                            <span class="c1"># to be handled</span>
                            <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">):</span>
                                <span class="k">continue</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                    <span class="s1">&#39;analyzer.metrics_manager.local_features_profile_dirs&#39;</span><span class="p">,</span>
                                    <span class="c1"># expected_features_profile_dir, expected_dir)</span>
                                    <span class="n">features_profile_dir</span><span class="p">,</span> <span class="n">expected_dir</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> features profile dir exists locally, added to analyzer.metrics_manager.local_features_profile_dirs&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">))</span>
                                <span class="k">continue</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in analyzer.metrics_manager.local_features_profile_dirs for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                    <span class="s1">&#39;analyzer.metrics_manager.local_features_profile_dirs.to_update&#39;</span><span class="p">,</span>
                                    <span class="c1"># expected_features_profile_dir, expected_dir)</span>
                                    <span class="n">features_profile_dir</span><span class="p">,</span> <span class="n">expected_dir</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> features profile, added to analyzer.metrics_manager.local_features_profile_dirs.to_update&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">))</span>
                                <span class="k">continue</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in analyzer.metrics_manager.local_features_profile_dirs for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">))</span>
                            <span class="n">in_local_features_profile_dirs_to_update</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">local_features_profile_dir_to_update</span> <span class="ow">in</span> <span class="n">local_features_profile_dirs_to_update</span><span class="p">:</span>
                                    <span class="c1"># if local_features_profile_dir_to_update == expected_features_profile_dir:</span>
                                    <span class="k">if</span> <span class="n">local_features_profile_dir_to_update</span> <span class="o">==</span> <span class="n">features_profile_dir</span><span class="p">:</span>
                                        <span class="n">in_local_features_profile_dirs_to_update</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span>
                                                <span class="s1">&#39;analyzer.metrics_manager.local_features_profile_dirs.to_update&#39;</span><span class="p">,</span>
                                                <span class="c1"># expected_features_profile_dir, expected_dir)</span>
                                                <span class="n">features_profile_dir</span><span class="p">,</span> <span class="n">expected_dir</span><span class="p">)</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> features profile, removed from analyzer.metrics_manager.local_features_profile_dirs.to_update&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">))</span>
                                            <span class="k">continue</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in analyzer.metrics_manager.local_features_profile_dirs for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine if entry should be remove from in analyzer.metrics_manager.local_features_profile_dirs.to_update&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_local_features_profile_dirs_to_update</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                        <span class="s1">&#39;analyzer.metrics_manager.local_features_profile_dirs.to_update&#39;</span><span class="p">,</span>
                                        <span class="c1"># expected_features_profile_dir, expected_dir)</span>
                                        <span class="n">features_profile_dir</span><span class="p">,</span> <span class="n">expected_dir</span><span class="p">)</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> features profile, added to analyzer.metrics_manager.local_features_profile_dirs.to_update&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">))</span>
                                    <span class="k">continue</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in analyzer.metrics_manager.local_features_profile_dirs for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_dir</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files - failed to get all </span><span class="si">%s</span><span class="s1"> features_profile files for </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">files_to_fetch</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                        <span class="k">if</span> <span class="n">files_fetched</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">fps_fetched</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files:: features_profiles_dir done&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20220223 - Feature #4464: flux - quota - cluster_sync</span>
        <span class="c1">#                   Feature #4400: flux - quota</span>
        <span class="c1"># Sync flux.quota.namespace_metrics keys between cluster nodes.  Added</span>
        <span class="c1"># into sync_cluster_files process as it is cluster related.</span>
        <span class="c1"># The ancillary of this function, to remove metrics from a</span>
        <span class="c1"># flux.quota.namespace_metrics key is handled by</span>
        <span class="c1"># Feature #4468: flux - remove_namespace_quota_metrics which is done</span>
        <span class="c1"># using functions.flux.remove_namespace_quota_metrics via the webapp</span>
        <span class="c1"># api endpoint.</span>
        <span class="n">file_sync_spin_end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">file_sync_duration</span> <span class="o">=</span> <span class="n">file_sync_spin_end</span> <span class="o">-</span> <span class="n">spin_start</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files file sync took </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="n">file_sync_duration</span><span class="p">)</span>

        <span class="n">metrics_manager_flux_namespace_quotas</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metrics_manager_flux_namespace_quotas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files :: failed to hgetall metrics_manager.flux.namespace_quotas - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">skyline_url</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_PORT</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
            <span class="n">local_skyline_instance</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">skyline_url</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER</span><span class="p">,</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER_PASSWORD</span><span class="p">,</span> <span class="n">this_host</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_skyline_instance</span> <span class="o">=</span> <span class="p">[</span><span class="n">skyline_url</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">this_host</span><span class="p">]</span>

        <span class="c1"># @added 20220510 - Feature #4464: flux - quota - cluster_sync</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Create a single hash that contains all the flux.quota.namespace_metrics</span>
        <span class="c1"># namespaces to allow for the cluster sync to make a single call rather</span>
        <span class="c1"># than a call per namespace</span>
        <span class="n">flux_quota_namespace_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># If there are flux quotas then sync the quota keys</span>
        <span class="k">if</span> <span class="n">metrics_manager_flux_namespace_quotas</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files :: updating flux.quota.namespace_metrics Redis keys with cluster data&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20220510 - Feature #4464: flux - quota - cluster_sync</span>
            <span class="c1">#                   Release #4562 - v3.0.4</span>
            <span class="c1"># Create a single hash that contains all the flux.quota.namespace_metrics</span>
            <span class="c1"># namespaces to allow for the cluster sync to make a single call rather</span>
            <span class="c1"># than a call per namespace</span>
            <span class="n">namespaces_quota_key</span> <span class="o">=</span> <span class="s1">&#39;metrics_manager.flux.quota.namespace_metrics&#39;</span>
            <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;api?redis_data&amp;type=hash&amp;key=</span><span class="si">%s</span><span class="s1">&amp;cluster_data=true&#39;</span> <span class="o">%</span> <span class="n">namespaces_quota_key</span>
            <span class="n">save_file</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_data</span><span class="p">(</span><span class="n">local_skyline_instance</span><span class="p">,</span> <span class="n">namespaces_quota_key</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">save_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files :: failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">local_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">namespace_metrics_str</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">namespace_metrics_str</span><span class="p">:</span>
                            <span class="n">flux_quota_namespace_metrics_dict</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">namespace_metrics_str</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files :: failed to add metrics to flux_quota_namespace_metrics_dict for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">namespace</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files :: updating flux.quota.namespace_metrics Redis keys with cluster data from metrics_manager.flux.quota.namespace_metrics&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20230322 - Feature #4468: flux - remove_namespace_quota_metrics</span>
        <span class="c1">#                   Feature #4464: flux - quota - cluster_sync</span>
        <span class="c1"># Handle labelled_metrics, do not sync the flux.quota.namespace_metrics</span>
        <span class="c1"># keys if they have been removed recently</span>
        <span class="n">quota_metrics_removed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">parent_namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics_manager_flux_namespace_quotas</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

            <span class="c1"># @added 20230322 - Feature #4468: flux - remove_namespace_quota_metrics</span>
            <span class="c1">#                   Feature #4464: flux - quota - cluster_sync</span>
            <span class="c1"># Handle labelled_metrics, do not sync the flux.quota.namespace_metrics</span>
            <span class="c1"># keys if they have been removed recently</span>
            <span class="n">namespaces_quota_removed_key</span> <span class="o">=</span> <span class="s1">&#39;flux.removed.quota.namespace_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_namespace</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">quota_metrics_removed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">namespaces_quota_removed_key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files :: exists failed on </span><span class="si">%s</span><span class="s1"> Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">namespaces_quota_removed_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">quota_metrics_removed</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files :: </span><span class="si">%s</span><span class="s1"> exists so skipping syncing namesapce quota this run&#39;</span> <span class="o">%</span> <span class="n">namespaces_quota_removed_key</span><span class="p">)</span>
                <span class="k">continue</span>
                
            <span class="c1"># @modified 20220510 - Feature #4464: flux - quota - cluster_sync</span>
            <span class="c1">#                      Release #4562 - v3.0.4</span>
            <span class="c1"># Use single hash that contains all the flux.quota.namespace_metrics</span>
            <span class="c1"># namespaces to allow for the cluster sync to make a single call rather</span>
            <span class="c1"># than a call per namespace</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">namespace_quota_key</span> <span class="o">=</span> <span class="s1">&#39;flux.quota.namespace_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">parent_namespace</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flux_quota_namespace_metrics_dict</span><span class="p">:</span>
                <span class="c1"># @modified 20220510 - Feature #4464: flux - quota - cluster_sync</span>
                <span class="c1">#                      Release #4562 - v3.0.4</span>
                <span class="c1"># Correct redis_data URI</span>
                <span class="c1"># endpoint = &#39;redis_data&amp;type=set&amp;key=%s&amp;cluster_data=true&#39; % namespace_quota_key</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;api?redis_data&amp;type=set&amp;key=</span><span class="si">%s</span><span class="s1">&amp;cluster_data=true&#39;</span> <span class="o">%</span> <span class="n">namespace_quota_key</span>
                <span class="n">save_file</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_data</span><span class="p">(</span><span class="n">local_skyline_instance</span><span class="p">,</span> <span class="n">namespace_quota_key</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">save_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files :: failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">local_skyline_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">flux_quota_namespace_metrics_dict</span><span class="p">[</span><span class="n">parent_namespace</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files :: failed to determine metrics from flux_quota_namespace_metrics_dict for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">parent_namespace</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="c1"># Fetch the current Redis data to determine if any new metrics</span>
                <span class="c1"># need to be added</span>
                <span class="n">original_key_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">original_key_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">namespace_quota_key</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files :: failed to add multiple members to the </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">namespace_quota_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">original_key_data</span><span class="p">:</span>
                    <span class="c1"># Compare the current Redis data with the data from the</span>
                    <span class="c1"># other nodes and only add missing metrics to the set to reduce</span>
                    <span class="c1"># the sadd operation to the lowest N</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">original_key_data_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">original_key_data</span><span class="p">))</span>
                        <span class="n">data_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="n">set_difference</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">original_key_data_set</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">set_difference</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files :: failed to determine metrics to remove from mirage.hash_key.metrics_resolutions&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">namespace_quota_key</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files :: updated the </span><span class="si">%s</span><span class="s1"> Redis set with </span><span class="si">%s</span><span class="s1"> new metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">namespace_quota_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files :: failed to add multiple members to the </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">namespace_quota_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">metrics_manager_flux_namespace_quotas</span><span class="p">:</span>
            <span class="n">quota_sync_end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">quota_sync_duration</span> <span class="o">=</span> <span class="n">quota_sync_end</span> <span class="o">-</span> <span class="n">file_sync_spin_end</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files :: cluster quota sync of flux.quota.namespace_metrics Redis keys took </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="n">quota_sync_duration</span><span class="p">)</span>

        <span class="n">spin_end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">spin_start</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files took </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="n">spin_end</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Metrics_Manager.metric_management_process"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.metrics_manager.Metrics_Manager.metric_management_process">[docs]</a>    <span class="k">def</span> <span class="nf">metric_management_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and manage the required lists and Redis sets</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">spin_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process started&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20220708 - Info #4620: memray</span>
        <span class="n">memray_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/analyzer.metrics_manager_process.bin&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span>
        <span class="n">memray_file_last</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.last&#39;</span> <span class="o">%</span> <span class="n">memray_file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">memray_file_last</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">memray_file_last</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">memray_file_last</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">memray_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">memray_file</span><span class="p">,</span> <span class="n">memray_file_last</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">memray_file_last</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">MEMRAY_ENABLED</span><span class="p">:</span>
            <span class="n">memray_tracker</span> <span class="o">=</span> <span class="n">memray</span><span class="o">.</span><span class="n">Tracker</span><span class="p">(</span><span class="n">memray_file</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: memray Tracker enabled&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">memray_tracker</span> <span class="o">=</span> <span class="n">nullcontext</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: memray Tracker NOT enabled&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">memray_tracker</span><span class="p">:</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no redis connection, returning&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage at start of run - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20230411 - Task #4872: Optimise luminosity for labelled_metrics</span>
                <span class="c1"># Create a unique list of namespaces to create a hash to be used in</span>
                <span class="c1"># luminosity</span>
                <span class="n">unique_parent_namespaces</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">unique_parent_namespaces_timings</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># @added 20220128 - Feature #4404: flux - external_settings - aggregation</span>
                <span class="c1">#                   Feature #4324: flux - reload external_settings</span>
                <span class="c1">#                   Feature #4376: webapp - update_external_settings</span>
                <span class="c1"># @modified 20220512 - Feature #4324: flux - reload external_settings</span>
                <span class="c1">#                      Feature #4376: webapp - update_external_settings</span>
                <span class="c1"># Moved block to very beginning so that reload_flux is done as soon as</span>
                <span class="c1"># possible</span>
                <span class="n">manage_flux_aggregate_namespaces_redis_key</span> <span class="o">=</span> <span class="s1">&#39;metrics_manager.manage_flux_aggregate_namespaces&#39;</span>
                <span class="n">external_settings_updated</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">do_reload_flux</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">external_settings_updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings.update.metrics_manager&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager ::: could not get skyline.external_settings.update.metrics_manager from Redis, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">external_settings_updated</span><span class="p">:</span>
                    <span class="n">do_reload_flux</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set to reload_flux as skyline.external_settings.update.metrics_manager is present&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing Redis key metrics_manager.manage_flux_aggregate_namespaces to refresh&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">manage_flux_aggregate_namespaces_redis_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not delete Redis key metrics_manager.manage_flux_aggregate_namespaces: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

                <span class="n">last_run_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">last_run_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.last_run_timestamp&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="n">full_uniques</span><span class="p">)</span>
                    <span class="n">last_run_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">last_run_timestamp</span><span class="p">:</span>
                    <span class="c1"># @modified 20220512 - Feature #4324: flux - reload external_settings</span>
                    <span class="c1">#                      Feature #4376: webapp - update_external_settings</span>
                    <span class="c1"># If there is a reload_flux called then do not return but run</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">do_reload_flux</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: analyzer.metrics_manager.last_run_timestamp Redis key has not expired, not running&#39;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: analyzer.metrics_manager.last_run_timestamp Redis key has not expired, but reload_flux called so running&#39;</span><span class="p">)</span>

                <span class="c1"># @added 20220919 - Feature #4676: analyzer - illuminance.all key</span>
                <span class="c1"># Create a Redis hash with the algorithm ids</span>
                <span class="n">algorithms</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">algorithms</span> <span class="o">=</span> <span class="n">get_algorithms</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_algorithms failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">algorithms</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">last_run_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.algorithms.ids&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">algorithms</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set metrics_manager.algorithms.ids - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

                <span class="n">unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">full_uniques</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="n">full_uniques</span><span class="p">)</span>
                    <span class="n">unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># @added 20230203 - Feature #4840: flux - prometheus - x-test-only header</span>
                <span class="c1"># Readded all_db_metric_names_with_ids so that labelled_metrics</span>
                <span class="c1"># base_names can be looked up if they become active again in</span>
                <span class="c1"># labelled_metrics.unique_metrics</span>
                <span class="n">labelled_metrics_active_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">labelled_metrics_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">labelled_metrics_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.unique_labelled_metrics&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: smembers failed on labelled_metrics.unique_labelled_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">labelled_metrics_unique_metrics</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">labelled_metrics_unique_metrics</span><span class="p">:</span>
                        <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">labelled_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">labelled_metrics_active_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: there are </span><span class="si">%s</span><span class="s1"> active labelled_metrics in labelled_metrics.unique_labelled_metrics Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labelled_metrics_active_ids</span><span class="p">))))</span>
                <span class="c1"># @added 20230217 - Feature #4854: boundary - labelled_metrics</span>
                <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Added the ability for boundary to handle labelled_metrics</span>
                <span class="c1"># via metrics_manager.boundary_metrics</span>
                <span class="n">active_labelled_metrics_with_id</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">active_labelled_metrics_with_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.active_labelled_metrics_with_id&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hgetall Redis hash key aet.metrics_manager.active_labelled_metrics_with_id for boundary_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>

                <span class="c1"># Check if this process is unnecessary</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">labelled_metrics_unique_metrics</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: there are no metrics in </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="n">full_uniques</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">full_uniques</span><span class="p">,</span> <span class="n">unique_metrics</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set memcache </span><span class="si">%s</span><span class="s1"> key&#39;</span> <span class="o">%</span> <span class="n">full_uniques</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: set_memcache_key failed to set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">full_uniques</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="c1">####</span>
                <span class="c1"># Check whether any alert settings or metrics have been changed, added</span>
                <span class="c1"># or removed.  If so do a full refresh.</span>
                <span class="c1">####</span>
                <span class="n">refresh_redis_alert_sets</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20220211 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Create a list of parent_namespaces</span>
                <span class="n">all_parent_namespaces</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1">####</span>
                <span class="c1"># Create a list of base_names from the unique_metrics</span>
                <span class="c1">####</span>

                <span class="c1"># @added 20200723 - Feature #3560: External alert config</span>
                <span class="c1"># Speed this up only check alerters if not already in the set</span>
                <span class="n">unique_base_names</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: creating unique_base_names list&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                    <span class="c1"># @added 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
                    <span class="c1">#                   Branch #3262: py3</span>
                    <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                    <span class="c1"># @modified 20200728 - Bug #3652: Handle multiple metrics in base_name conversion</span>
                    <span class="c1"># base_name = metric_name.replace(settings.FULL_NAMESPACE, &#39;&#39;, 1)</span>
                    <span class="k">if</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span>

                    <span class="c1"># @added 20200723 - Feature #3560: External alert config</span>
                    <span class="c1"># Speed this up only check alerters if not already in the set</span>
                    <span class="c1"># metric_in_smtp_alerters_set = False</span>
                    <span class="n">unique_base_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>

                    <span class="c1"># @added 20220211 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># Create a list of parent_namespaces</span>
                    <span class="n">all_parent_namespaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created unique_base_names list of </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_base_names</span><span class="p">)))</span>

                <span class="c1"># @added 20230217 - Feature #4854: boundary - labelled_metrics</span>
                <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Added the ability for boundary to handle labelled_metrics</span>
                <span class="n">all_active_base_names</span> <span class="o">=</span> <span class="n">unique_base_names</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created all_active_base_names list of </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_active_base_names</span><span class="p">)))</span>

                <span class="c1"># @added 20220211 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Create a list of parent_namespaces</span>
                <span class="n">all_parent_namespaces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_parent_namespaces</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created all_parent_namespaces list of </span><span class="si">%s</span><span class="s1"> top level namespaces&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_parent_namespaces</span><span class="p">)))</span>

                <span class="c1"># @added 20210308 - Feature #3978: luminosity - classify_metrics</span>
                <span class="c1">#                  Feature #3642: Anomaly type classification</span>
                <span class="c1"># Make a Redis set of unique_base_names for other apps to use</span>
                <span class="k">if</span> <span class="n">unique_base_names</span><span class="p">:</span>
                    <span class="n">unique_base_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_base_names</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: recreating the analyzer.unique_base_names set&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;new_analyzer.unique_base_names&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_base_names</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the new_analyzer.unique_base_names Redis set&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;new_analyzer.unique_base_names.old&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer.unique_base_names&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.unique_base_names.old&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;new_analyzer.unique_base_names&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.unique_base_names&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;unique_base_names.old&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sunionstore</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.unique_base_names&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.unique_base_names&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: copied Redis set analyzer.unique_base_names to aet.analyzer.unique_base_names via sunion&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to copy Redis set analyzer.unique_base_names to aet.analyzer.unique_base_names via sunion&#39;</span><span class="p">)</span>

                <span class="c1">#####</span>
                <span class="c1"># Check whether any internal or external alert settings have been changed</span>
                <span class="c1"># if so do a full refresh</span>
                <span class="c1">####</span>

                <span class="c1"># @added 20220410 - Feature #3560: External alert config</span>
                <span class="c1"># This handles a metrics_manager key rather than an analyzer key to</span>
                <span class="c1"># trigger refreshing on</span>
                <span class="n">metrics_manager_last_all_alerts</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metrics_manager_last_all_alerts_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metrics_manager.last_all_alerts&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">metrics_manager_last_all_alerts_str</span><span class="p">:</span>
                        <span class="n">metrics_manager_last_all_alerts</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">metrics_manager_last_all_alerts_str</span><span class="p">)</span>
                        <span class="c1"># A normal sorted nor set can be used as the list has dicts in it</span>
                        <span class="n">metrics_manager_last_all_alerts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">metrics_manager_last_all_alerts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metrics_manager_last_all_alerts from metrics_manager.last_all_alerts Redis set has </span><span class="si">%s</span><span class="s1"> items&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_manager_last_all_alerts</span><span class="p">))))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from the metrics_manager.last_all_alerts Redis key&#39;</span><span class="p">)</span>
                    <span class="n">metrics_manager_last_all_alerts</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># @added 20200528 - Feature #3560: External alert config</span>
                <span class="n">external_alerts</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">external_from_cache</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">internal_alerts</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">internal_from_cache</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">all_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ALERTS</span><span class="p">)</span>
                <span class="n">all_from_cache</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">EXTERNAL_ALERTS</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">external_alerts</span><span class="p">,</span> <span class="n">external_from_cache</span><span class="p">,</span> <span class="n">internal_alerts</span><span class="p">,</span> <span class="n">internal_from_cache</span><span class="p">,</span> <span class="n">all_alerts</span><span class="p">,</span> <span class="n">all_from_cache</span> <span class="o">=</span> <span class="n">get_external_alert_configs</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not determine external alert configs&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: retrieved </span><span class="si">%s</span><span class="s1"> external_alerts configurations from_cache </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> internal_alerts from_cache </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> all_alerts from_cache </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">external_alerts</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">external_from_cache</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">internal_alerts</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">internal_from_cache</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_alerts</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_from_cache</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: metrics_manager :: all_alerts :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_alerts</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">all_alerts</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: all_alerts is not set, so creating from settings.ALERTS&#39;</span><span class="p">)</span>
                    <span class="n">all_alerts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ALERTS</span><span class="p">)</span>

                <span class="c1"># If there was a last known alerts configuration compare it to the</span>
                <span class="c1"># current known alerts configuration if they are different do a full</span>
                <span class="c1"># refresh</span>

                <span class="c1"># @added 20201017 - Feature #3788: snab_flux_load_test</span>
                <span class="c1">#                   Feature #3560: External alert config</span>
                <span class="n">last_all_alerts_set</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">last_all_alerts_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;analyzer.last_all_alerts&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">last_all_alerts_data</span><span class="p">:</span>
                        <span class="n">last_all_alerts</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">last_all_alerts_data</span><span class="p">)</span>
                        <span class="c1"># A normal sorted nor set can be used as the list has dicts in it</span>
                        <span class="n">last_all_alerts_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">last_all_alerts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: last_all_alerts_set from analyzer.last_all_alerts Redis set has </span><span class="si">%s</span><span class="s1"> items&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last_all_alerts_set</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from the analyzer.last_all_alerts Redis key&#39;</span><span class="p">)</span>
                    <span class="n">last_all_alerts_set</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">all_alerts_set</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">all_alerts</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">all_alerts_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_alerts</span><span class="p">]</span>
                        <span class="c1"># A normal sorted nor set can be used as the list has dicts in it</span>
                        <span class="n">all_alerts_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_alerts_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: all_alerts_set from all_alerts has </span><span class="si">%s</span><span class="s1"> items&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_alerts_set</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to create a sorted list from all_alerts object of type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">all_alerts_list</span><span class="p">)))</span>

                    <span class="c1"># Set the last known alert configuration to the current configuration</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;analyzer.last_all_alerts&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_alerts_set</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set analyzer.last_all_alerts Redis key&#39;</span><span class="p">)</span>

                <span class="c1"># Compare the last known with the current, if there was a last known</span>
                <span class="c1"># configuration, if different do a full refresh</span>
                <span class="k">if</span> <span class="n">last_all_alerts_set</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_alerts_set</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_manager_last_all_alerts</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metrics_manager alert settings have changed, sets will be refreshed&#39;</span><span class="p">)</span>
                        <span class="n">refresh_redis_alert_sets</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># @added 20220410 - Feature #3560: External alert config</span>
                <span class="c1"># This handles a metrics_manager key rather than an analyzer key to</span>
                <span class="c1"># trigger refreshing on</span>
                <span class="k">if</span> <span class="n">all_alerts_set</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_alerts_set</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_manager_last_all_alerts</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: alert settings have changed from the metrics_manager.last_all_alerts, alert sets will be refreshed&#39;</span><span class="p">)</span>
                        <span class="n">refresh_redis_alert_sets</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;metrics_manager.last_all_alerts&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_alerts_set</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set metrics_manager.last_all_alerts Redis key&#39;</span><span class="p">)</span>

                <span class="c1"># Compare the current unique_metrics to the last smtp_alerter_metrics +</span>
                <span class="c1"># non_smtp_alerter_metrics, if they have changed do a full refresh</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh_redis_alert_sets</span><span class="p">:</span>
                    <span class="n">smtp_alerter_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">non_smtp_alerter_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">smtp_alerter_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.smtp_alerter_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get list from analyzer.smtp_alerter_metrics Redis key&#39;</span><span class="p">)</span>
                        <span class="n">refresh_redis_alert_sets</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">smtp_alerter_metrics</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">non_smtp_alerter_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.non_smtp_alerter_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get list from analyzer.non_smtp_alerter_metrics Redis key&#39;</span><span class="p">)</span>
                        <span class="n">non_smtp_alerter_metrics</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">known_alerter_metrics_set</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">smtp_alerter_metrics</span> <span class="ow">or</span> <span class="n">non_smtp_alerter_metrics</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">known_alerter_metrics</span> <span class="o">=</span> <span class="n">smtp_alerter_metrics</span> <span class="o">+</span> <span class="n">non_smtp_alerter_metrics</span>
                            <span class="n">known_alerter_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">known_alerter_metrics</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get list from analyzer.non_smtp_alerter_metrics Redis key&#39;</span><span class="p">)</span>

                    <span class="c1"># Compare known metrics to current unique_base_names if they are</span>
                    <span class="c1"># different do a full refresh</span>
                    <span class="k">if</span> <span class="n">known_alerter_metrics_set</span><span class="p">:</span>
                        <span class="n">changed_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">unique_base_names_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_base_names</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">unique_base_names_set</span> <span class="o">==</span> <span class="n">known_alerter_metrics_set</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: unique_base_names_set and known_alerter_metrics_set are the same&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">set_difference</span> <span class="o">=</span> <span class="n">unique_base_names_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">known_alerter_metrics_set</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">set_difference</span><span class="p">:</span>
                                    <span class="n">changed_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: there are </span><span class="si">%s</span><span class="s1"> metrics that have changed, sets will be refreshed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">changed_metrics</span><span class="p">)))</span>
                                <span class="n">refresh_redis_alert_sets</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">del</span> <span class="n">set_difference</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine whether the unique_base_names_set and known_alerter_metrics_set are different&#39;</span><span class="p">)</span>

                <span class="n">smtp_alerter_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">non_smtp_alerter_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">mirage_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">refresh_redis_alert_sets</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># @added 20220822 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Add labelled_metrics to mirage.unique_metrics</span>

                <span class="c1"># @added 20201104 - Feature #3788: snab_flux_load_test</span>
                <span class="c1">#                   Feature #3560: External alert config</span>
                <span class="k">if</span> <span class="n">refresh_redis_alert_sets</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sets being refreshed, determining smtp_alerter_metrics&#39;</span><span class="p">)</span>
                    <span class="n">all_smtp_alerter_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">all_mirage_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">mirage_metrics_expiration_times</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">mirage_metrics_keys</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">start_refresh</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">unique_base_names</span><span class="p">:</span>
                        <span class="c1"># @modified 20230316 - Task #4872: Optimise luminosity for labelled_metrics</span>
                        <span class="c1">#                      Feature #4446: Optimise horizon worker in_skip_list</span>
                        <span class="c1"># Commented out the if base_name not in all_smtp_alerter_metrics</span>
                        <span class="c1"># because it is a unique list so each item will only be iterated</span>
                        <span class="c1"># once. Unindented to for block below</span>
                        <span class="c1"># if base_name not in all_smtp_alerter_metrics:</span>
                        <span class="c1"># Use the all_alerts list which includes external alert configs</span>
                        <span class="c1"># for alert in settings.ALERTS:</span>
                        <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">all_alerts</span><span class="p">:</span>
                            <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;smtp&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="p">[</span><span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                                    <span class="k">if</span> <span class="n">LOCAL_DEBUG</span> <span class="ow">and</span> <span class="n">pattern_match</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: metrics_manager :: </span><span class="si">%s</span><span class="s1"> matched alert - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="k">del</span> <span class="n">metric_matched_by</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                    <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                                        <span class="n">all_smtp_alerter_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                                        <span class="c1"># @added 20160922 - Branch #922: Ionosphere</span>
                                        <span class="c1"># Add a Redis set of mirage.unique_metrics</span>
                                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_MIRAGE</span><span class="p">:</span>
                                            <span class="n">mirage_metric</span> <span class="o">=</span> <span class="kc">False</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">SECOND_ORDER_RESOLUTION_FULL_DURATION</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                                                <span class="k">if</span> <span class="n">SECOND_ORDER_RESOLUTION_FULL_DURATION</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
                                                    <span class="n">mirage_metric</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="n">mirage_metric</span> <span class="o">=</span> <span class="kc">False</span>
                                            <span class="k">if</span> <span class="n">mirage_metric</span><span class="p">:</span>
                                                <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                                                <span class="n">all_mirage_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>

                                                <span class="c1"># @added 20200805 - Task #3662: Change mirage.last_check keys to timestamp value</span>
                                                <span class="c1">#                   Feature #3486: analyzer_batch</span>
                                                <span class="c1">#                   Feature #3480: batch_processing</span>
                                                <span class="c1"># Add the mirage metric and its EXPIRATION_TIME to</span>
                                                <span class="c1"># the mirage.metrics_expiration_times so that Mirage</span>
                                                <span class="c1"># can determine the metric EXPIRATION_TIME without</span>
                                                <span class="c1"># having to create and iterate the all_alerts</span>
                                                <span class="c1"># object in the Mirage analysis phase so that the</span>
                                                <span class="c1"># reported anomaly timestamp can be used to determine</span>
                                                <span class="c1"># whether the EXPIRATION_TIME should be applied to a</span>
                                                <span class="c1"># batch metric in the alerting and Ionosphere contexts</span>
                                                <span class="c1"># mirage_alert_expiration_data = [base_name, int(alert[2])]</span>
                                                <span class="n">mirage_alert_expiration_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                                                <span class="n">mirage_metrics_expiration_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mirage_alert_expiration_data</span><span class="p">)</span>

                                                <span class="c1"># @added 20200904 - Task #3730: Validate Mirage running multiple processes</span>
                                                <span class="c1"># Also always add the mirage.metrics Redis key for the</span>
                                                <span class="c1"># metric which contains its hours_to_resolve so</span>
                                                <span class="c1"># that the spin_process can add the mirage check</span>
                                                <span class="c1"># files immediately, rather than waiting to add</span>
                                                <span class="c1"># the mirage checks all in the alerting phase.</span>
                                                <span class="c1"># This is done to reduce the time it takes to</span>
                                                <span class="c1"># get through the analysis pipeline.</span>
                                                <span class="n">mirage_metrics_keys</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">SECOND_ORDER_RESOLUTION_FULL_DURATION</span><span class="p">])</span>
                                        <span class="k">break</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: all_smtp_alerter_metrics and all_mirage_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                                    <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">end_classify</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: classifying metrics took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_classify</span> <span class="o">-</span> <span class="n">start_refresh</span><span class="p">))</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> all_smtp_alerter_metrics were determined&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_smtp_alerter_metrics</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">all_smtp_alerter_metrics</span><span class="p">:</span>
                        <span class="n">smtp_alerter_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_smtp_alerter_metrics</span><span class="p">)))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> unique smtp_alerter_metrics determined&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">smtp_alerter_metrics</span><span class="p">)))</span>
                    <span class="c1"># Recreate the Redis set the analyzer.smtp_alerter_metrics</span>
                    <span class="k">if</span> <span class="n">smtp_alerter_metrics</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: recreating the analyzer.smtp_alerter_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;new_analyzer.smtp_alerter_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">smtp_alerter_metrics</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the new_analyzer.smtp_alerter_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;analyzer.smtp_alerter_metrics.old&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer.smtp_alerter_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.smtp_alerter_metrics.old&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @added 20180423 - Feature #2360: CORRELATE_ALERTS_ONLY</span>
                            <span class="c1">#                   Branch #2270: luminosity</span>
                            <span class="c1"># Add a Redis set of smtp_alerter_metrics for Luminosity to only</span>
                            <span class="c1"># cross correlate on metrics with an alert setting</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;new_analyzer.smtp_alerter_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.smtp_alerter_metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;analyzer.smtp_alerter_metrics.old&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: recreated the analyzer.smtp_alerter_metrics Redis set&#39;</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determing non_smtp_alerter_metrics&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unique_base_names_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_base_names</span><span class="p">))</span>
                        <span class="n">smtp_alerter_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">smtp_alerter_metrics</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">unique_base_names_set</span> <span class="o">==</span> <span class="n">smtp_alerter_metrics_set</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: unique_base_names_set and smtp_alerter_metrics_set are the same, no non_smtp_alerter_metrics&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">set_difference</span> <span class="o">=</span> <span class="n">unique_base_names_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">smtp_alerter_metrics_set</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">set_difference</span><span class="p">:</span>
                                <span class="n">non_smtp_alerter_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: there are </span><span class="si">%s</span><span class="s1"> non_alerter_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">non_smtp_alerter_metrics</span><span class="p">)))</span>
                            <span class="k">del</span> <span class="n">set_difference</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine non_smtp_alerter_metrics from sets&#39;</span><span class="p">)</span>

                    <span class="c1"># Recreate the Redis set the analyzer.non_smtp_alerter_metrics</span>
                    <span class="k">if</span> <span class="n">non_smtp_alerter_metrics</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: recreating the analyzer.non_smtp_alerter_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;new_analyzer.non_smtp_alerter_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">non_smtp_alerter_metrics</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the new_analyzer.non_smtp_alerter_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;analyzer.non_smtp_alerter_metrics.old&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer.non_smtp_alerter_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.non_smtp_alerter_metrics.old&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;new_analyzer.non_smtp_alerter_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.non_smtp_alerter_metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;analyzer.non_smtp_alerter_metrics.old&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: recreated the analyzer.non_smtp_alerter_metrics Redis set&#39;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sunionstore</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.smtp_alerter_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.smtp_alerter_metrics&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: copied Redis set analyzer.smtp_alerter_metrics to aet.analyzer.smtp_alerter_metrics via sunion&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to copy Redis set analyzer.smtp_alerter_metrics to aet.analyzer.smtp_alerter_metrics via sunion&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sunionstore</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.non_smtp_alerter_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.non_smtp_alerter_metrics&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: copied Redis set analyzer.non_smtp_alerter_metrics to aet.analyzer.non_smtp_alerter_metrics via sunion&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to copy Redis set analyzer.non_smtp_alerter_metrics to aet.analyzer.non_smtp_alerter_metrics via sunion&#39;</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> mirage metrics determined&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_mirage_metrics</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">all_mirage_metrics</span><span class="p">:</span>
                        <span class="n">mirage_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_mirage_metrics</span><span class="p">)))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> unique mirage_metrics determined&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mirage_metrics</span><span class="p">)))</span>

                    <span class="c1"># Recreate the Redis set the mirage.unique_metrics</span>
                    <span class="k">if</span> <span class="n">mirage_metrics</span><span class="p">:</span>
                        <span class="c1"># @modified 20220411 - use sunionstore</span>
                        <span class="c1"># logger.info(&#39;metrics_manager :: recreating the mirage.unique_metrics Redis set&#39;)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: updating the mirage.unique_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;new_mirage.unique_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">mirage_metrics</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add multiple members to the new_mirage.unique_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.redis_conn.delete(&#39;mirage.unique_metrics.old&#39;)</span>
                        <span class="c1"># except:</span>
                        <span class="c1">#     pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20220411</span>
                            <span class="c1"># self.redis_conn.rename(&#39;mirage.unique_metrics&#39;, &#39;mirage.unique_metrics.old&#39;)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sunionstore</span><span class="p">(</span><span class="s1">&#39;mirage.unique_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;new_mirage.unique_metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to sunionstore Redis set mirage.unique_metrics with new_mirage.unique_metricsd&#39;</span><span class="p">)</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.redis_conn.rename(&#39;new_mirage.unique_metrics&#39;, &#39;mirage.unique_metrics&#39;)</span>
                        <span class="c1"># except:</span>
                        <span class="c1">#     logger.error(traceback.format_exc())</span>
                        <span class="c1">#     logger.error(&#39;error :: metrics_manager :: failed to rename Redis set new_mirage.unique_metrics to mirage.unique_metrics&#39;)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># self.redis_conn.delete(&#39;mirage.unique_metrics.old&#39;)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;new_mirage.unique_metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="c1"># logger.info(&#39;metrics_manager :: recreated the mirage.unique_metrics Redis set&#39;)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: updated the mirage.unique_metrics Redis set&#39;</span><span class="p">)</span>

                    <span class="n">end_refresh</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: refresh of smtp_alerter_metrics, non_smtp_alerter_metrics and mirage_metrics took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_refresh</span> <span class="o">-</span> <span class="n">start_refresh</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">mirage_metrics_expiration_times</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing mirage.hash_key.metrics_expiration_times Redis hash key&#39;</span><span class="p">)</span>
                        <span class="n">updated_keys</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">added_keys</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">removed_keys</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">mirage_metrics_expiration_times_errors</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">last_metrics_expiration_times</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">raw_last_metrics_expiration_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;mirage.hash_key.metrics_expiration_times&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">base_name_bytes</span> <span class="ow">in</span> <span class="n">raw_last_metrics_expiration_times</span><span class="p">:</span>
                                <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name_bytes</span><span class="p">)</span>
                                <span class="n">expiration_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw_last_metrics_expiration_times</span><span class="p">[</span><span class="n">base_name</span><span class="p">])</span>
                                <span class="n">last_metrics_expiration_times</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">base_name</span><span class="p">,</span> <span class="n">expiration_time</span><span class="p">])</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries in mirage.hash_key.metrics_expiration_times Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last_metrics_expiration_times</span><span class="p">)))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get Redis hash key mirage.hash_key.metrics_expiration_times&#39;</span><span class="p">)</span>
                            <span class="n">last_metrics_expiration_times</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="c1"># Add them all if there are none in the hash key</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_metrics_expiration_times</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: nothing found in Redis hash key, added all </span><span class="si">%s</span><span class="s1"> metrics from mirage_metrics_expiration_times&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mirage_metrics_expiration_times</span><span class="p">))))</span>
                            <span class="n">error_logged</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mirage_metrics_expiration_times</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                        <span class="s1">&#39;mirage.hash_key.metrics_expiration_times&#39;</span><span class="p">,</span>
                                        <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                    <span class="n">added_keys</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">mirage_metrics_expiration_times_errors</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">error_logged</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in mirage.hash_key.metrics_expiration_times for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                                        <span class="n">error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: added all </span><span class="si">%s</span><span class="s1"> metrics to mirage.hash_key.metrics_expiration_times Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mirage_metrics_expiration_times</span><span class="p">))))</span>
                        <span class="c1"># Determine the base_names in the last_metrics_expiration_times</span>
                        <span class="n">last_metrics_expiration_times_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">last_metrics_expiration_times</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">last_metrics_expiration_times_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">last_metrics_expiration_times</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate list of metric names from last_metrics_expiration_times&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">last_metrics_expiration_times_metrics</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checking entries in mirage.hash_key.metrics_expiration_times Redis hash key are correct&#39;</span><span class="p">)</span>
                            <span class="n">error_logged</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mirage_metrics_expiration_times</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">last_metrics_expiration_times_metrics</span><span class="p">:</span>
                                        <span class="n">last_expiration_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw_last_metrics_expiration_times</span><span class="p">[</span><span class="n">base_name</span><span class="p">])</span>
                                        <span class="k">if</span> <span class="n">last_expiration_time</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                                <span class="s1">&#39;mirage.hash_key.metrics_expiration_times&#39;</span><span class="p">,</span>
                                                <span class="n">base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                            <span class="n">updated_keys</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                            <span class="s1">&#39;mirage.hash_key.metrics_expiration_times&#39;</span><span class="p">,</span>
                                            <span class="n">base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                        <span class="n">added_keys</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">mirage_metrics_expiration_times_errors</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">error_logged</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to manage entry in mirage.hash_key.metrics_expiration_times for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                                        <span class="n">error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checked entries in mirage.hash_key.metrics_expiration_times Redis hash key, </span><span class="si">%s</span><span class="s1"> updated, </span><span class="si">%s</span><span class="s1"> added&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">updated_keys</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">added_keys</span><span class="p">)))</span>
                            <span class="c1"># Remove any metrics in no longer present</span>
                            <span class="n">present_metrics_expiration_times_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">present_metrics_expiration_times_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mirage_metrics_expiration_times</span><span class="p">]</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> current known metrics from mirage_metrics_expiration_times&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">present_metrics_expiration_times_metrics</span><span class="p">)))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate list of metric names from mirage_metrics_expiration_times&#39;</span><span class="p">)</span>
                                <span class="n">present_metrics_expiration_times_metrics</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">present_metrics_expiration_times_metrics</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checking if any entries in mirage.hash_key.metrics_expiration_times Redis hash key need to be removed&#39;</span><span class="p">)</span>
                                <span class="n">error_logged</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">last_metrics_expiration_times_metrics</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">present_metrics_expiration_times_metrics</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span>
                                                <span class="s1">&#39;mirage.hash_key.metrics_expiration_times&#39;</span><span class="p">,</span>
                                                <span class="n">base_name</span><span class="p">)</span>
                                            <span class="n">removed_keys</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">mirage_metrics_expiration_times_errors</span> <span class="o">+=</span> <span class="mi">1</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">error_logged</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to remove entry from mirage.hash_key.metrics_expiration_times for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                                            <span class="n">error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removed </span><span class="si">%s</span><span class="s1"> entries in mirage.hash_key.metrics_expiration_times Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">removed_keys</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managed mirage.hash_key.metrics_expiration_times Redis hash key&#39;</span><span class="p">)</span>

                    <span class="c1"># @added 20200904 - Task #3730: Validate Mirage running multiple processes</span>
                    <span class="c1"># Also always add the mirage.metrics Redis key for the</span>
                    <span class="c1"># metric which contains its hours_to_resolve so</span>
                    <span class="c1"># that the spin_process can add the mirage check</span>
                    <span class="c1"># files immediately, rather than waiting to add</span>
                    <span class="c1"># the mirage checks all in the alerting phase.</span>
                    <span class="c1"># This is done to reduce the time it takes to</span>
                    <span class="c1"># get through the analysis pipeline.</span>
                    <span class="c1"># @modified 20201109 - Feature #3830: metrics_manager</span>
                    <span class="c1"># Changed to a single mirage.hash_key.metrics_resolutions hash key</span>
                    <span class="c1"># rather than individual mirage.metrics. Redis keys for each mirage</span>
                    <span class="c1"># metric</span>
                    <span class="k">if</span> <span class="n">mirage_metrics_keys</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing the mirage.hash_key.metrics_resolutions Redis hash key&#39;</span><span class="p">)</span>
                        <span class="n">last_metrics_resolutions</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">raw_last_metrics_resolutions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;mirage.hash_key.metrics_resolutions&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">base_name_bytes</span> <span class="ow">in</span> <span class="n">raw_last_metrics_resolutions</span><span class="p">:</span>
                                <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name_bytes</span><span class="p">)</span>
                                <span class="n">hours_to_resolve</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw_last_metrics_resolutions</span><span class="p">[</span><span class="n">base_name</span><span class="p">])</span>
                                <span class="n">last_metrics_resolutions</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hours_to_resolve</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries in mirage.hash_key.metrics_resolutions Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last_metrics_resolutions</span><span class="p">)))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get Redis hash key mirage.hash_key.metrics_resolutions&#39;</span><span class="p">)</span>
                            <span class="n">last_metrics_resolutions</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: there are </span><span class="si">%s</span><span class="s1"> metrics in the mirage.hash_key.metrics_resolutions Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last_metrics_resolutions</span><span class="p">)))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determining if any metrics need to be removed from the mirage.hash_key.metrics_resolutions Redis hash key, via set difference&#39;</span><span class="p">)</span>
                        <span class="n">metrics_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">current_metrics_resolutions</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mirage_metrics_keys</span><span class="p">:</span>
                            <span class="n">base_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">current_metrics_resolutions</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">current_metrics_resolutions</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">last_metrics_resolutions_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">last_metrics_resolutions</span><span class="p">))</span>
                                <span class="n">current_metrics_resolutions_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">current_metrics_resolutions</span><span class="p">))</span>
                                <span class="n">set_difference</span> <span class="o">=</span> <span class="n">last_metrics_resolutions_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">current_metrics_resolutions_set</span><span class="p">)</span>
                                <span class="n">metrics_to_remove</span> <span class="o">=</span> <span class="n">set_difference</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine metrics to remove from mirage.hash_key.metrics_resolutions&#39;</span><span class="p">)</span>
                                <span class="n">metrics_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: there are </span><span class="si">%s</span><span class="s1"> metrics to remove from the mirage.hash_key.metrics_resolutions Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_to_remove</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">metrics_to_remove</span><span class="p">:</span>
                            <span class="n">metrics_to_remove_error_logged</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">metrics_removed</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">metrics_to_remove</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span>
                                        <span class="s1">&#39;mirage.hash_key.metrics_resolutions&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                                    <span class="n">metrics_removed</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metrics_to_remove_error_logged</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine metrics to remove from mirage.hash_key.metrics_resolutions&#39;</span><span class="p">)</span>
                                        <span class="n">metrics_to_remove_error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removed </span><span class="si">%s</span><span class="s1"> metrics from the mirage.hash_key.metrics_resolutions Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_removed</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determining if there are any new metrics to add to the mirage.hash_key.metrics_resolutions Redis hash key, via set difference&#39;</span><span class="p">)</span>
                        <span class="n">metrics_to_add</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">current_metrics_resolutions</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">last_metrics_resolutions_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">last_metrics_resolutions</span><span class="p">))</span>
                                <span class="n">current_metrics_resolutions_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">current_metrics_resolutions</span><span class="p">))</span>
                                <span class="n">set_difference</span> <span class="o">=</span> <span class="n">last_metrics_resolutions_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">last_metrics_resolutions_set</span><span class="p">)</span>
                                <span class="n">metrics_to_add</span> <span class="o">=</span> <span class="n">set_difference</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine metrics to remove from mirage.hash_key.metrics_resolutions&#39;</span><span class="p">)</span>
                                <span class="n">metrics_to_add</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">metrics_added</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: there are </span><span class="si">%s</span><span class="s1"> metrics to add to the mirage.hash_key.metrics_resolutions Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_to_add</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">metrics_to_add</span><span class="p">:</span>
                            <span class="n">metrics_to_add_error_logged</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">metrics_to_add</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">hours_to_resolve</span> <span class="o">=</span> <span class="n">current_metrics_resolutions</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                        <span class="s1">&#39;mirage.hash_key.metrics_resolutions&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span>
                                        <span class="n">hours_to_resolve</span><span class="p">)</span>
                                    <span class="n">metrics_added</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metrics_to_add_error_logged</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add </span><span class="si">%s</span><span class="s1"> to mirage.hash_key.metrics_resolutions - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                                        <span class="n">metrics_to_add_error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: added </span><span class="si">%s</span><span class="s1"> metrics to the mirage.hash_key.metrics_resolutions Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_added</span><span class="p">))</span>

                        <span class="c1"># Update any changed metric resolutions, this is a fast iterator</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checking if any metrics need their resolution updated in the mirage.hash_key.metrics_resolutions Redis hash key&#39;</span><span class="p">)</span>
                        <span class="n">metrics_resolutions_updated</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">metrics_updated_error_logged</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_metrics_resolutions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">update_metric_resolution</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">last_resolution</span> <span class="o">=</span> <span class="n">last_metrics_resolutions</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">last_resolution</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">current_resolution</span> <span class="o">=</span> <span class="n">current_metrics_resolutions</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">current_resolution</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">last_resolution</span><span class="p">:</span>
                                <span class="n">update_metric_resolution</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">last_resolution</span> <span class="o">=</span> <span class="n">current_resolution</span>
                            <span class="k">if</span> <span class="n">last_resolution</span> <span class="o">!=</span> <span class="n">current_resolution</span><span class="p">:</span>
                                <span class="n">update_metric_resolution</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">update_metric_resolution</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                        <span class="s1">&#39;mirage.hash_key.metrics_resolutions&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span>
                                        <span class="n">current_resolution</span><span class="p">)</span>
                                    <span class="n">metrics_resolutions_updated</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metrics_updated_error_logged</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to update the resolution of </span><span class="si">%s</span><span class="s1"> to mirage.hash_key.metrics_resolutions&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
                                        <span class="n">metrics_updated_error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: updated the resolutions of </span><span class="si">%s</span><span class="s1"> metrics in the mirage.hash_key.metrics_resolutions Redis hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_resolutions_updated</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: smtp_alerter_metrics     :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">smtp_alerter_metrics</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: non_smtp_alerter_metrics :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">non_smtp_alerter_metrics</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: mirage_metrics :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mirage_metrics</span><span class="p">)))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after set management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20210601 - Feature #4000: EXTERNAL_SETTINGS</span>
                <span class="n">external_settings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">external_from_cache</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">EXTERNAL_SETTINGS</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing external_settings&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">external_settings</span><span class="p">,</span> <span class="n">external_from_cache</span> <span class="o">=</span> <span class="n">manage_external_settings</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: fetch_external_settings failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">external_settings</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> external_settings from cache </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">external_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()))),</span> <span class="nb">str</span><span class="p">(</span><span class="n">external_from_cache</span><span class="p">)))</span>

                    <span class="c1"># @added 20220512- Feature #3824: get_cluster_data</span>
                    <span class="c1">#                  Release #4562 - v3.0.4</span>
                    <span class="c1">#                  Feature #4324: flux - reload external_settings</span>
                    <span class="c1">#                  Feature #4376: webapp - update_external_settings</span>
                    <span class="c1"># Do reload_flux as soon as possible</span>
                    <span class="k">if</span> <span class="n">do_reload_flux</span><span class="p">:</span>


                        <span class="c1"># @added 20230509- Feature #4324: flux - reload external_settings</span>
                        <span class="c1"># Update metrics_manager.flux.namespace_quotas before flux restart</span>
                        <span class="n">namespaces_with_quotas</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">external_settings</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">external_setting</span> <span class="ow">in</span> <span class="n">external_settings</span><span class="p">:</span>
                                <span class="n">quota</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">namespace</span> <span class="o">=</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">external_setting</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span>
                                    <span class="n">quota</span> <span class="o">=</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">external_setting</span><span class="p">][</span><span class="s1">&#39;metric_limit&#39;</span><span class="p">]</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: determining quota from external_setting - </span><span class="si">%s</span><span class="s1">, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">external_setting</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">quota</span><span class="p">:</span>
                                    <span class="n">namespaces_with_quotas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">quota</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set quota for </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> in metrics_manager.flux.namespace_quotas, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">quota</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings.update.metrics_manager&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager ::: deleted skyline.external_settings.update.metrics_manager from Redis&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager ::: failed to delete skyline.external_settings.update.metrics_manager from Redis, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="c1"># @added 20220825- Feature #4324: flux - reload external_settings</span>
                        <span class="c1"># Save the external_settings that flux will be restarted</span>
                        <span class="c1"># with for debugging purposes</span>
                        <span class="n">backup_redis_key</span> <span class="o">=</span> <span class="s1">&#39;skyline.external_settings.flux_reload.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: saving external_settings to </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">backup_redis_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">external_settings</span><span class="p">)))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">backup_redis_key</span><span class="p">,</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">14</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">external_settings</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">backup_redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                        <span class="n">flux_pid_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/flux.pid&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PID_PATH</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">flux_pid_file</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: initiating reload_flux&#39;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">flux_pids</span> <span class="o">=</span> <span class="n">reload_flux</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">flux_pid_file</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">flux_pids</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: reload_flux reports </span><span class="si">%s</span><span class="s1"> flux pids&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_pids</span><span class="p">)))</span>
                                    <span class="n">do_reload_flux</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: reload_flux error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="n">do_reload_flux</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings.update.flux&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager ::: deleted skyline.external_settings.update.flux from Redis&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager ::: failed to delete skyline.external_settings.update.flux from Redis, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># @added 20220329 - Feature #4446: Optimise horizon worker in_skip_list</span>
                <span class="c1"># Update the horizon.do_not_skip_metrics Redis hash periodically to</span>
                <span class="c1"># ensure that any new metrics that are added to DO_NOT_SKIP_LIST are</span>
                <span class="c1"># added to the horizon.do_not_skip_metrics Redis hash and that they are</span>
                <span class="c1"># removed from the horizon.skip_metrics Redis hash</span>
                <span class="n">do_not_skip_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">do_not_skip_metrics_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;horizon.do_not_skip_metrics&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hgetall horizon.do_not_skip_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: got </span><span class="si">%s</span><span class="s1"> metrics from horizon.do_not_skip_metrics Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">do_not_skip_metrics_dict</span><span class="p">))))</span>
                <span class="n">horizon_do_not_skip_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">do_not_skip_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">skip_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">skip_metrics_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;horizon.skip_metrics&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hgetall horizon.skip_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: got </span><span class="si">%s</span><span class="s1"> metrics from horizon.skip_metrics Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">skip_metrics_dict</span><span class="p">))))</span>
                <span class="n">horizon_skip_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">skip_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
                <span class="c1"># Add flux required data to memcache as well</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: creating metrics_manager_skip_list and metrics_manager_do_not_skip_list&#39;</span><span class="p">)</span>
                <span class="n">metrics_manager_skip_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">metrics_manager_do_not_skip_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ALL_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ALL_SKIP_LIST</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKIP_LIST</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">ALL_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">ALL_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DO_NOT_SKIP_LIST</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">external_settings</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">settings_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">external_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">external_setting_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="n">skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">external_namespace</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">external_namespace</span> <span class="o">=</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">external_namespace</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">external_namespace</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="s1">&#39;skip_metrics&#39;</span> <span class="ow">in</span> <span class="n">external_setting_keys</span><span class="p">:</span>
                            <span class="n">skip_metrics</span> <span class="o">=</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">][</span><span class="s1">&#39;skip_metrics&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">skip_metrics</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skip_metrics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">external_namespace</span><span class="p">:</span>
                                        <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">skip_metrics</span><span class="p">:</span>
                                            <span class="n">metric_namespaces</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">external_namespace</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
                                            <span class="n">ALL_SKIP_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_namespaces</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">ALL_SKIP_LIST</span> <span class="o">=</span> <span class="n">ALL_SKIP_LIST</span> <span class="o">+</span> <span class="n">skip_metrics</span>
                        <span class="n">do_not_skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="s1">&#39;do_not_skip_metrics&#39;</span> <span class="ow">in</span> <span class="n">external_setting_keys</span><span class="p">:</span>
                            <span class="n">do_not_skip_metrics</span> <span class="o">=</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">][</span><span class="s1">&#39;do_not_skip_metrics&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">do_not_skip_metrics</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">do_not_skip_metrics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">external_namespace</span><span class="p">:</span>
                                        <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">do_not_skip_metrics</span><span class="p">:</span>
                                            <span class="n">metric_namespaces</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">external_namespace</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
                                            <span class="n">ALL_DO_NOT_SKIP_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_namespaces</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">+</span> <span class="n">do_not_skip_metrics</span>
                <span class="n">horizon_metrics_received</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">horizon_metrics_received</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.horizon.metrics_received&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: smembers failed on aet.horizon.metrics_received - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">horizon_metrics_received</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">all_unique_base_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_base_names</span> <span class="o">+</span> <span class="n">horizon_metrics_received</span> <span class="o">+</span> <span class="n">horizon_skip_metrics</span> <span class="o">+</span> <span class="n">horizon_do_not_skip_metrics</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ALL_SKIP_LIST</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">all_unique_base_names</span><span class="p">:</span>
                        <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">ALL_SKIP_LIST</span><span class="p">)</span>
                        <span class="k">del</span> <span class="n">metric_matched_by</span>
                        <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="n">metrics_manager_skip_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: added </span><span class="si">%s</span><span class="s1"> base_names to metrics_manager_skip_list&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_manager_skip_list</span><span class="p">)))</span>
                <span class="n">metrics_manager_removed_from_skip_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">ALL_DO_NOT_SKIP_LIST</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">all_unique_base_names</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">metrics_manager_skip_list</span><span class="p">:</span>
                            <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">ALL_DO_NOT_SKIP_LIST</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">metric_matched_by</span>
                            <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                                <span class="n">metrics_manager_do_not_skip_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">metrics_manager_skip_list</span><span class="p">:</span>
                                    <span class="n">metrics_manager_skip_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                                    <span class="n">metrics_manager_removed_from_skip_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">metrics_manager_do_not_skip_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: added </span><span class="si">%s</span><span class="s1"> base_names to metrics_manager_do_not_skip_list&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_manager_do_not_skip_list</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removed </span><span class="si">%s</span><span class="s1"> base_names from metrics_manager_skip_list that were found in metrics_manager_do_not_skip_list&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_manager_removed_from_skip_list</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">metrics_manager_skip_list</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;new.metrics_manager.skip_list&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_manager_skip_list</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;new.metrics_manager.skip_list&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics_manager.skip_list&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created metrics_manager.skip_list Redis hash with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_manager_skip_list</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to create Redis set new.metrics_manager.skip_list and rename to metrics_manager.skip_list&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metrics_manager_do_not_skip_list</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;new.metrics_manager.do_not_skip_list&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_manager_do_not_skip_list</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;new.metrics_manager.do_not_skip_list&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics_manager.do_not_skip_list&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created metrics_manager.do_not_skip_list Redis hash with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_manager_do_not_skip_list</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to create Redis set new.metrics_manager.do_not_skip_list and rename to metrics_manager.do_not_skip_list&#39;</span><span class="p">)</span>

                <span class="c1"># @added 20220329 - Feature #4446: Optimise horizon worker in_skip_list</span>
                <span class="c1"># Update the horizon.do_not_skip_metrics Redis hash periodically to</span>
                <span class="c1"># ensure that any new metrics that are added to DO_NOT_SKIP_LIST are</span>
                <span class="c1"># added to the horizon.do_not_skip_metrics Redis hash and that they are</span>
                <span class="c1"># removed from the horizon.skip_metrics Redis hash</span>
                <span class="k">if</span> <span class="n">do_not_skip_metrics_dict</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">DO_NOT_SKIP_LIST</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determining new metrics to add to horizon.do_not_skip_metrics&#39;</span><span class="p">)</span>
                    <span class="n">start_horizon_do_not_skip_metrics</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="n">all_horizon_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_base_names</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">skip_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
                    <span class="n">update_do_not_skip_metrics</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="c1"># @modified 20230316 - Task #4872: Optimise luminosity for labelled_metrics</span>
                    <span class="c1">#                      Feature #4446: Optimise horizon worker in_skip_list</span>
                    <span class="c1"># More efficient to get the set difference</span>
                    <span class="c1"># for base_name in all_horizon_metrics:</span>
                    <span class="c1">#     if base_name in horizon_do_not_skip_metrics:</span>
                    <span class="c1">#         continue</span>
                    <span class="n">all_horizon_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_horizon_metrics</span><span class="p">)</span>
                    <span class="n">horizon_do_not_skip_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">horizon_do_not_skip_metrics</span><span class="p">)</span>
                    <span class="n">all_horizon_metrics_to_check</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_horizon_metrics_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">horizon_do_not_skip_metrics_set</span><span class="p">))</span>
                    <span class="k">del</span> <span class="n">all_horizon_metrics_set</span>
                    <span class="k">del</span> <span class="n">horizon_do_not_skip_metrics_set</span>
                    <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">all_horizon_metrics_to_check</span><span class="p">:</span>
                        <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DO_NOT_SKIP_LIST</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="n">update_do_not_skip_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span>
                        <span class="k">del</span> <span class="n">metric_matched_by</span>
                    <span class="k">del</span> <span class="n">all_horizon_metrics_to_check</span>

                    <span class="n">new_do_not_skip_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">update_do_not_skip_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: found </span><span class="si">%s</span><span class="s1"> new metrics to add to horizon.do_not_skip_metrics Redis hash, took </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_do_not_skip_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_horizon_do_not_skip_metrics</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">update_do_not_skip_metrics</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;horizon.do_not_skip_metrics&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">update_do_not_skip_metrics</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to update horizon.do_not_skip_metrics Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                        <span class="n">remove_from_skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">new_do_not_skip_metrics</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">skip_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="n">remove_from_skip_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">remove_from_skip_metrics</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> metrics to remove from horizon.skip_metrics Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_from_skip_metrics</span><span class="p">))))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;horizon.skip_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_from_skip_metrics</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hdel metrics from horizon.skip_metrics Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">err</span><span class="p">))</span>
                            <span class="k">del</span> <span class="n">remove_from_skip_metrics</span>
                        <span class="k">del</span> <span class="n">update_do_not_skip_metrics</span>
                    <span class="k">del</span> <span class="n">all_horizon_metrics</span>
                    <span class="k">del</span> <span class="n">new_do_not_skip_metrics</span>

                <span class="c1"># @added 20220427 - Feature #4446: Optimise horizon worker in_skip_list</span>
                <span class="c1">#                   Feature #4536: Handle Redis failure</span>
                <span class="c1"># Add flux required data to memcache as well</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: updating horizon.do_not_skip_metrics with metrics_manager_do_not_skip_list&#39;</span><span class="p">)</span>
                <span class="n">horizon_do_not_skip_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">horizon_do_not_skip_metrics</span><span class="p">)</span>
                <span class="n">metrics_manager_do_not_skip_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metrics_manager_do_not_skip_list</span><span class="p">)</span>
                <span class="n">missing_from_horizon_do_not_skip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics_manager_do_not_skip_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">horizon_do_not_skip_set</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">missing_from_horizon_do_not_skip</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: adding </span><span class="si">%s</span><span class="s1"> metrics to horizon.do_not_skip_metrics Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_from_horizon_do_not_skip</span><span class="p">))))</span>
                    <span class="n">missing_from_horizon_do_not_skip_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">current_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">missing_from_horizon_do_not_skip</span><span class="p">:</span>
                        <span class="n">missing_from_horizon_do_not_skip_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_timestamp</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;horizon.do_not_skip_metrics&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">missing_from_horizon_do_not_skip_dict</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hset metrics in horizon.do_not_skip_metrics Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no metrics missing from horizon.do_not_skip_metrics Redis hash&#39;</span><span class="p">)</span>
                <span class="n">remove_from_horizon_do_not_skip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">horizon_do_not_skip_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">metrics_manager_do_not_skip_set</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">remove_from_horizon_do_not_skip</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing </span><span class="si">%s</span><span class="s1"> metrics to horizon.do_not_skip_metrics Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_from_horizon_do_not_skip</span><span class="p">))))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;horizon.do_not_skip_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_from_horizon_do_not_skip</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hset metrics in horizon.do_not_skip_metrics Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;metrics_manager.removed_from.horizon.do_not_skip_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_from_horizon_do_not_skip</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="s1">&#39;metrics_manager.removed_from.horizon.do_not_skip_metrics&#39;</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to sadd metrics to metrics_manager.removed_from.horizon.do_not_skip_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no metrics to remove from horizon.do_not_skip_metrics Redis hash&#39;</span><span class="p">)</span>
                <span class="c1"># del do_not_skip_metrics_dict</span>
                <span class="c1"># del horizon_do_not_skip_metrics</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: updating horizon.skip_metrics with metrics_manager_skip_list&#39;</span><span class="p">)</span>
                <span class="n">horizon_skip_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">horizon_skip_metrics</span><span class="p">)</span>
                <span class="n">metrics_manager_skip_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metrics_manager_skip_list</span><span class="p">)</span>
                <span class="n">missing_from_horizon_skip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics_manager_skip_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">horizon_skip_set</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">missing_from_horizon_skip</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: adding </span><span class="si">%s</span><span class="s1"> metrics to horizon.skip_metrics Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_from_horizon_skip</span><span class="p">))))</span>
                    <span class="n">missing_from_horizon_skip_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">current_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">missing_from_horizon_skip</span><span class="p">:</span>
                        <span class="n">missing_from_horizon_skip_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_timestamp</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;horizon.skip_metrics&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">missing_from_horizon_skip_dict</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hset metrics in horizon.skip_metrics Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no metrics missing from horizon.skip_metrics Redis hash&#39;</span><span class="p">)</span>
                <span class="n">remove_from_horizon_skip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">horizon_skip_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">metrics_manager_skip_set</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">remove_from_horizon_skip</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing </span><span class="si">%s</span><span class="s1"> metrics to horizon.skip_metrics Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_from_horizon_skip</span><span class="p">))))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;horizon.skip_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_from_horizon_skip</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hset metrics in horizon.skip_metrics Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;metrics_manager.removed_from.horizon.skip_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_from_horizon_skip</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="s1">&#39;metrics_manager.removed_from.horizon.skip_metrics&#39;</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to sadd metrics to metrics_manager.removed_from.horizon.skip_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no metrics to remove from horizon.skip_metrics Redis hash&#39;</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after skip management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20220610 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: getting last aet.metrics_manager.metric_names_with_ids from Redis&#39;</span><span class="p">)</span>
                <span class="n">aet_metric_names_with_ids</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">aet_metric_names_with_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.metric_names_with_ids&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: got </span><span class="si">%s</span><span class="s1"> last aet.metrics_manager.metric_names_with_ids from Redis&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aet_metric_names_with_ids</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to hgetall aet.metrics_manager.metric_names_with_ids - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">known_prometheus_metrics</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">aet_metric_names_with_ids</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">aet_metric_names_with_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">known_metric</span> <span class="o">=</span> <span class="n">aet_metric_names_with_ids</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">known_metric</span> <span class="ow">and</span> <span class="s1">&#39;}&#39;</span> <span class="ow">in</span> <span class="n">known_metric</span> <span class="ow">and</span> <span class="s1">&#39;=&quot;&#39;</span> <span class="ow">in</span> <span class="n">known_metric</span><span class="p">:</span>
                            <span class="n">known_prometheus_metrics</span><span class="p">[</span><span class="n">known_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>
                <span class="n">current_prometheus_skip_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">prometheus_skip_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">prometheus_skip_dict_changed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">known_prometheus_metrics</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing metrics_manager.prometheus_skip_dict for </span><span class="si">%s</span><span class="s1"> prometheus metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">known_prometheus_metrics</span><span class="p">)))</span>
                    <span class="n">current_prometheus_skip_dict_data</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">current_prometheus_skip_dict_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.prometheus_skip_dict&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hset metrics_manager.prometheus_skip_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="c1"># Convert str</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_prometheus_skip_dict_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">current_prometheus_skip_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">current_prometheus_skip_dict_data</span><span class="p">[</span><span class="n">metric</span><span class="p">]))</span>
                    <span class="k">del</span> <span class="n">current_prometheus_skip_dict_data</span>

                <span class="c1"># Thoughts instead of a 1 or 0 add the type and if to be skipped set as</span>
                <span class="c1"># skip or None.  That can then be used to determine the aggregation</span>
                <span class="c1"># method.  Introduces a problem of the source and fetching all the</span>
                <span class="c1"># targets/metadata ... Solved by metadata_config</span>

                <span class="n">do_not_skip_prometheus_metrics_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">known_prometheus_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ALL_SKIP_LIST</span><span class="p">)</span>
                        <span class="k">del</span> <span class="n">metric_matched_by</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                        <span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">do_not_skip_prometheus_metrics_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">prometheus_skip_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">skip</span>
                <span class="k">if</span> <span class="n">prometheus_skip_dict</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">prometheus_skip_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">prometheus_skip_dict_changed</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">prometheus_skip_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">!=</span> <span class="n">current_prometheus_skip_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                                <span class="n">prometheus_skip_dict_changed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">prometheus_skip_dict_changed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_prometheus_skip_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">prometheus_skip_dict_changed</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">prometheus_skip_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">!=</span> <span class="n">current_prometheus_skip_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                                <span class="n">prometheus_skip_dict_changed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">prometheus_skip_dict_changed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">prometheus_skip_dict_changed</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.prometheus_skip_dict&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">prometheus_skip_dict</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hset metrics_manager.prometheus_skip_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: updated metrics_manager.prometheus_skip_dict with </span><span class="si">%s</span><span class="s1"> skip and </span><span class="si">%s</span><span class="s1"> do_not_skip prometheus metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">known_prometheus_metrics</span><span class="p">)</span> <span class="o">-</span> <span class="n">do_not_skip_prometheus_metrics_count</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">do_not_skip_prometheus_metrics_count</span><span class="p">)))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;metrics_manager.updated.prometheus_skip_dict&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set metrics_manager.updated.prometheus_skip_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="c1"># Remove inactive metrics from the metrics_manager.prometheus_skip_dict</span>
                <span class="c1"># Redis hash</span>
                <span class="n">remove_inactive_from_prometheus_skip_dict</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_prometheus_skip_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">metric_active</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_active</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">known_prometheus_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">remove_inactive_from_prometheus_skip_dict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">metric_active</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: found </span><span class="si">%s</span><span class="s1"> inactive metrics to remove from the metrics_manager.prometheus_skip_dict Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_inactive_from_prometheus_skip_dict</span><span class="p">))))</span>
                <span class="k">if</span> <span class="n">remove_inactive_from_prometheus_skip_dict</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">removed_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;metrics_manager.prometheus_skip_dict&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">remove_inactive_from_prometheus_skip_dict</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removed </span><span class="si">%s</span><span class="s1"> inactive metrics from the metrics_manager.prometheus_skip_dict Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">removed_count</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to remove inactive metrics from metrics_manager.prometheus_skip_dict Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">current_prometheus_skip_dict</span>
                <span class="k">del</span> <span class="n">known_prometheus_metrics</span>
                <span class="k">del</span> <span class="n">prometheus_skip_dict</span>

                <span class="c1"># @added 20220620 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="n">prometheus_metadata_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">prometheus_metrics_type_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prometheus_metadata_dict</span><span class="p">,</span> <span class="n">prometheus_metrics_type_dict</span> <span class="o">=</span> <span class="n">manage_prometheus_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: manage_prometheus_metadata failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">prometheus_metadata_dict</span>
                    <span class="k">del</span> <span class="n">prometheus_metrics_type_dict</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="c1"># @added 20220627 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Run redistimeseries_roomba</span>
<span class="c1">#                logger.info(&#39;metrics_manager :: running redistimeseries_roomba&#39;)</span>
<span class="c1">#                roombaed_redistimeseries_metrics = []</span>
<span class="c1">#                try:</span>
<span class="c1">#                    roombaed_redistimeseries_metrics = redistimeseries_roomba(self, active_labelled_ids_with_metrics, ids_with_labelled_metric_names)</span>
<span class="c1">#                except Exception as err:</span>
<span class="c1">#                    logger.error(traceback.format_exc())</span>
<span class="c1">#                    logger.error(&#39;error :: metrics_manager :: redistimeseries_roomba failed - %s&#39; % (</span>
<span class="c1">#                        err))</span>
<span class="c1">#                logger.info(&#39;metrics_manager :: redistimeseries_roomba removed %s labelled_metrics&#39; % str(len(roombaed_redistimeseries_metrics)))</span>
<span class="c1">#                try:</span>
<span class="c1">#                    del roombaed_redistimeseries_metrics</span>
<span class="c1">#                except:</span>
<span class="c1">#                    pass</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: pruning old entries from analyzer_labelled_metrics.last_timeseries_timestamp&#39;</span><span class="p">)</span>
                <span class="n">analyzer_labelled_metrics_last_timeseries_timestamps</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">analyzer_labelled_metrics_last_timeseries_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.last_timeseries_timestamp&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: hget analyzer_labelled_metrics.last_timeseries_timestamp failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">oldest_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span>
                <span class="n">removed_ts_keys</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">remove_keys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">metric_id_str</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">analyzer_labelled_metrics_last_timeseries_timestamps</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">analyzer_labelled_metrics_last_timeseries_timestamps</span><span class="p">[</span><span class="n">metric_id_str</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="n">oldest_timestamp</span><span class="p">:</span>
                            <span class="n">remove_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to evaluate </span><span class="si">%s</span><span class="s1"> timestamp from analyzer_labelled_metrics.last_timeseries_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric_id_str</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">analyzer_labelled_metrics_last_timeseries_timestamps</span>
                <span class="k">if</span> <span class="n">remove_keys</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">removed_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.last_timeseries_timestamp&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">remove_keys</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">removed_keys</span><span class="p">:</span>
                            <span class="n">removed_ts_keys</span> <span class="o">+=</span> <span class="n">removed_keys</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: hdel from analyzer_labelled_metrics.last_timeseries_timestamp failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: pruned </span><span class="si">%s</span><span class="s1"> old entries from analyzer_labelled_metrics.last_timeseries_timestamp&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">removed_ts_keys</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">removed_ts_keys</span>
                <span class="k">del</span> <span class="n">remove_keys</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after labelled_metrics management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20220126 - Feature #4400: flux - quota</span>
                <span class="n">namespaces_with_quotas</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">namespace_quotas_settings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">namespace_quotas_settings</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_NAMESPACE_QUOTAS</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">namespace_quotas_settings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">namespace_quotas_settings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">namespace_quotas_settings</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">namespace_quotas_settings</span><span class="p">:</span>
                        <span class="n">quota</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">quota</span> <span class="o">=</span> <span class="n">namespace_quotas_settings</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: determining quota for </span><span class="si">%s</span><span class="s1">, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">quota</span><span class="p">:</span>
                            <span class="n">namespaces_with_quotas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">quota</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set quota for </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> in metrics_manager.flux.namespace_quotas, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">quota</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">namespace_quotas_settings</span>
                <span class="k">if</span> <span class="n">external_settings</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">external_setting</span> <span class="ow">in</span> <span class="n">external_settings</span><span class="p">:</span>
                        <span class="n">quota</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">namespace</span> <span class="o">=</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">external_setting</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span>
                            <span class="n">quota</span> <span class="o">=</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">external_setting</span><span class="p">][</span><span class="s1">&#39;metric_limit&#39;</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: determining quota from external_setting - </span><span class="si">%s</span><span class="s1">, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">external_setting</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">quota</span><span class="p">:</span>
                            <span class="n">namespaces_with_quotas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">quota</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set quota for </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> in metrics_manager.flux.namespace_quotas, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">quota</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">namespace_quotas_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">namespaces_with_quotas</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">namespace_quotas_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hgetall metrics_manager.flux.namespace_quotas Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20220510 - Feature #4464: flux - quota - cluster_sync</span>
                <span class="c1">#                   Release #4562 - v3.0.4</span>
                <span class="c1"># Create a single hash that contains all the flux.quota.namespace_metrics</span>
                <span class="c1"># namespaces to allow for the cluster sync to make a single call rather</span>
                <span class="c1"># than a call per namespace</span>
                <span class="c1"># @modified 20230322 - Feature #4468: flux - remove_namespace_quota_metrics</span>
                <span class="c1">#                      Feature #4464: flux - quota - cluster_sync</span>
                <span class="c1"># Added this comment only - this is managed from a removal of</span>
                <span class="c1"># metrics point of view in the skyline/functions/flux/remove_namespace_quota_metrics.py</span>
                <span class="c1"># along with the normal webapp admin API method of</span>
                <span class="c1"># /remove_namespace_quota_metrics</span>
                <span class="k">for</span> <span class="n">parent_namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespace_quotas_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">namespace_quota_key</span> <span class="o">=</span> <span class="s1">&#39;flux.quota.namespace_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">parent_namespace</span>
                    <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">namespace_quota_key</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># @added 20230322 - Feature #4468: flux - remove_namespace_quota_metrics</span>
                    <span class="c1">#                   Feature #4464: flux - quota - cluster_sync</span>
                    <span class="c1"># Do not manage if things have been removed</span>
                    <span class="n">quota_metrics_removed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">namespace_metrics</span><span class="p">:</span>
                        <span class="n">namespaces_quota_removed_key</span> <span class="o">=</span> <span class="s1">&#39;flux.removed.quota.namespace_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_namespace</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">quota_metrics_removed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">namespaces_quota_removed_key</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: exists failed on Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">namespaces_quota_removed_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">quota_metrics_removed</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: quota_metrics_removed exists so skipping managing metrics_manager.flux.quota.namespace_metrics&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">namespace_metrics</span><span class="p">:</span>
                        <span class="n">known_namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">known_namespace_metrics_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.quota.namespace_metrics&#39;</span><span class="p">,</span> <span class="n">parent_namespace</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">known_namespace_metrics_str</span><span class="p">:</span>
                                <span class="n">known_namespace_metrics</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">known_namespace_metrics_str</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hget </span><span class="si">%s</span><span class="s1"> from metrics_manager.flux.quota.namespace_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">namespace</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">all_namespace_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">known_namespace_metrics</span> <span class="o">+</span> <span class="n">namespace_metrics</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.quota.namespace_metrics&#39;</span><span class="p">,</span> <span class="n">parent_namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_namespace_metrics</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: added </span><span class="si">%s</span><span class="s1"> metrics for </span><span class="si">%s</span><span class="s1"> to metrics_manager.flux.quota.namespace_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_namespace_metrics</span><span class="p">)),</span> <span class="n">parent_namespace</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hset </span><span class="si">%s</span><span class="s1"> in metrics_manager.flux.quota.namespace_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">parent_namespace</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
                <span class="c1"># Add flux required data to memcache as well</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">,</span> <span class="n">namespace_quotas_dict</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set memcache metrics_manager.flux.namespace_quotas key&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: set_memcache_key failed to set metrics_manager.flux.namespace_quotas - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">parent_namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespace_quotas_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

                        <span class="c1"># @added 20230322 - Feature #4468: flux - remove_namespace_quota_metrics</span>
                        <span class="c1">#                   Feature #4464: flux - quota - cluster_sync</span>
                        <span class="c1"># Do not manage if things have been removed</span>
                        <span class="k">if</span> <span class="n">quota_metrics_removed</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="n">namespace_quota_key</span> <span class="o">=</span> <span class="s1">&#39;flux.quota.namespace_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">parent_namespace</span>
                        <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">namespace_quota_key</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">namespace_metrics</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">namespace_quota_key</span><span class="p">,</span> <span class="n">namespace_metrics</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: set_memcache_key failed to set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">namespace_quota_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set memcache </span><span class="si">%s</span><span class="s1"> key&#39;</span> <span class="o">%</span> <span class="n">namespace_quota_key</span><span class="p">)</span>
                        <span class="n">flux_namespace_not_skipped_metrics</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">flux_namespace_not_skipped_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;flux.not_skipped_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">parent_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">flux_namespace_not_skipped_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">flux_namespace_not_skipped_metrics_key</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">flux_namespace_not_skipped_metrics</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">flux_namespace_not_skipped_metrics</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">flux_namespace_not_skipped_metrics_key</span><span class="p">,</span> <span class="n">flux_namespace_not_skipped_metrics</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: set_memcache_key failed to set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">flux_namespace_not_skipped_metrics_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set memcache </span><span class="si">%s</span><span class="s1"> key&#39;</span> <span class="o">%</span> <span class="n">flux_namespace_not_skipped_metrics_key</span><span class="p">)</span>
                        <span class="n">flux_namespace_skipped_metrics</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">flux_namespace_skipped_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;flux.skipped_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">parent_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">flux_namespace_skipped_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">flux_namespace_skipped_metrics_key</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">flux_namespace_skipped_metrics</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">flux_namespace_skipped_metrics</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">flux_namespace_skipped_metrics_key</span><span class="p">,</span> <span class="n">flux_namespace_skipped_metrics</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: set_memcache_key failed to set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">flux_namespace_skipped_metrics_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set memcache </span><span class="si">%s</span><span class="s1"> key&#39;</span> <span class="o">%</span> <span class="n">flux_namespace_skipped_metrics_key</span><span class="p">)</span>

                <span class="c1"># Remove entries which no longer have a quota</span>
                <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">namespace_quotas_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">namespace</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namespaces_with_quotas</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing </span><span class="si">%s</span><span class="s1"> from metrics_manager.flux.namespace_quotas Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">namespace</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set quota for </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> in metrics_manager.flux.namespace_quotas, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">quota</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">namespace_quotas_dict</span>
                <span class="k">del</span> <span class="n">namespaces_with_quotas</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after namespace quota management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20210406 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                <span class="c1"># Analyzer determines what metrics flux should aggregate by creating the</span>
                <span class="c1"># the flux.aggregate_metrics Redis set, which flux/listen and flux/aggregate</span>
                <span class="c1"># reference.  This is done in analyzer/metrics_manager because it manages</span>
                <span class="c1"># metric Redis sets as it always runs.  It is only managed every 5 mins.</span>
                <span class="n">aggregate_namespaces</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">flux_aggregate_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">flux_aggregate_zerofill_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">flux_aggregate_lkv_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># @added 20220128 - Feature #4404: flux - external_settings - aggregation</span>
                <span class="n">external_settings_aggregations</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># @modified 20220222 - Feature #4284: flux - telegraf</span>
                <span class="c1">#                      Feature #4404: flux - external_settings - aggregation</span>
                <span class="c1"># Added or external_settings</span>
                <span class="k">if</span> <span class="n">FLUX_AGGREGATE_NAMESPACES</span> <span class="ow">or</span> <span class="n">FLUX_EXTERNAL_AGGREGATE_NAMESPACES</span> <span class="ow">or</span> <span class="n">external_settings</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">FLUX_AGGREGATE_NAMESPACES</span><span class="p">:</span>
                        <span class="n">aggregate_namespaces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FLUX_AGGREGATE_NAMESPACES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                        <span class="c1"># @added 20220720 - Feature #3708: FLUX_ZERO_FILL_NAMESPACES</span>
                        <span class="c1"># Add any aggregation metrics to the relevant lists</span>
                        <span class="k">for</span> <span class="n">aggregate_namespace</span> <span class="ow">in</span> <span class="n">aggregate_namespaces</span><span class="p">:</span>
                            <span class="n">zero_fill_set</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">zero_fill_set</span> <span class="o">=</span> <span class="n">FLUX_AGGREGATE_NAMESPACES</span><span class="p">[</span><span class="n">aggregate_namespace</span><span class="p">][</span><span class="s1">&#39;zero_fill&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">zero_fill_set</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">zero_fill_set</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">aggregate_namespace</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FLUX_ZERO_FILL_NAMESPACES</span><span class="p">:</span>
                                    <span class="n">FLUX_ZERO_FILL_NAMESPACES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aggregate_namespace</span><span class="p">)</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: FLUX_ZERO_FILL_NAMESPACES - added aggregate_namespace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">aggregate_namespace</span><span class="p">))</span>
                            <span class="n">lkv_set</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">lkv_set</span> <span class="o">=</span> <span class="n">FLUX_AGGREGATE_NAMESPACES</span><span class="p">[</span><span class="n">aggregate_namespace</span><span class="p">][</span><span class="s1">&#39;last_known_value&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">lkv_set</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">lkv_set</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">aggregate_namespace</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FLUX_LAST_KNOWN_VALUE_NAMESPACES</span><span class="p">:</span>
                                    <span class="n">FLUX_LAST_KNOWN_VALUE_NAMESPACES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aggregate_namespace</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">FLUX_EXTERNAL_AGGREGATE_NAMESPACES</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: TODO :: FLUX_EXTERNAL_AGGREGATE_NAMESPACES&#39;</span><span class="p">)</span>
                        <span class="c1"># TODO</span>
                        <span class="c1"># flux_external_aggregate_namespaces_dict = self.redis_conn_decoded.hgetall(...</span>
                        <span class="c1"># for i_metric in ...:</span>
                        <span class="c1">#      aggregate_namespaces.append(i_metric)</span>

                    <span class="c1"># @added 20220128 - Feature #4404: flux - external_settings - aggregation</span>
                    <span class="k">if</span> <span class="n">external_settings</span><span class="p">:</span>
                        <span class="n">external_settings_aggregations</span> <span class="o">=</span> <span class="n">external_settings_aggregation</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">external_settings_aggregations</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">namespace_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">external_settings_aggregations</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">aggregate_namespaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namespace_key</span><span class="p">)</span>
                            <span class="n">FLUX_AGGREGATE_NAMESPACES</span><span class="p">[</span><span class="n">namespace_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">external_settings_aggregations</span><span class="p">[</span><span class="n">namespace_key</span><span class="p">])</span>
                        <span class="n">aggregate_namespaces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aggregate_namespaces</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: aggregate_namespaces: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">aggregate_namespaces</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">FLUX_AGGREGATE_NAMESPACES</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">namespace_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">FLUX_AGGREGATE_NAMESPACES</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.new.flux.aggregate_namespaces&#39;</span><span class="p">,</span> <span class="n">namespace_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">FLUX_AGGREGATE_NAMESPACES</span><span class="p">[</span><span class="n">namespace_key</span><span class="p">]))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not add to metrics_manager.new.flux.aggregate_namespaces Redis hash key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;metrics_manager.new.flux.aggregate_namespaces&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics_manager.flux.aggregate_namespaces&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to rename Redis hash metrics_manager.new.flux.aggregate_namespaces to metrics_manager.flux.aggregate_namespaces, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

                        <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
                        <span class="c1"># Add flux required data to memcache as well</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                            <span class="n">metrics_manager_flux_aggregate_namespaces</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">metrics_manager_flux_aggregate_namespaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.aggregate_namespaces&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: hgetall failed for metrics_manager.flux.aggregate_namespaces - </span><span class="si">%e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">metrics_manager_flux_aggregate_namespaces</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;metrics_manager.flux.aggregate_namespaces&#39;</span><span class="p">,</span> <span class="n">metrics_manager_flux_aggregate_namespaces</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set memcache metrics_manager.flux.aggregate_namespaces key&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: set_memcache_key failed to set metrics_manager.flux.aggregate_namespaces - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">err</span><span class="p">))</span>

                    <span class="n">manage_flux_aggregate_namespaces</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># Only manage every 5 mins</span>

                    <span class="c1"># @modified 20220128 - Feature #4404: flux - external_settings - aggregation</span>
                    <span class="c1">#                      Feature #4324: flux - reload external_settings</span>
                    <span class="c1">#                      Feature #4376: webapp - update_external_settings</span>
                    <span class="c1"># Moved variable definition to above</span>
                    <span class="c1"># manage_flux_aggregate_namespaces_redis_key = &#39;metrics_manager.manage_flux_aggregate_namespaces&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">manage_flux_aggregate_namespaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">manage_flux_aggregate_namespaces_redis_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not query Redis for metrics_manager.manage_flux_aggregate_namespaces key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">manage_flux_aggregate_namespaces</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing FLUX_AGGREGATE_NAMESPACES Redis sets&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_aggregate_metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to delete analyzer.flux_aggregate_metrics Redis set&#39;</span><span class="p">)</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux_zero_fill_aggregate_metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to delete metrics_manager.flux_zero_fill_aggregate_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux_last_known_value_aggregate_metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to delete metrics_manager.flux_last_known_value_aggregate_metrics Redis set&#39;</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">i_base_name</span> <span class="ow">in</span> <span class="n">unique_base_names</span><span class="p">:</span>
                            <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="s1">&#39;analyzer&#39;</span><span class="p">,</span> <span class="n">i_base_name</span><span class="p">,</span> <span class="n">aggregate_namespaces</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">flux_aggregate_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_base_name</span><span class="p">)</span>
                                    <span class="n">matched_namespace</span> <span class="o">=</span> <span class="n">metric_matched_by</span><span class="p">[</span><span class="s1">&#39;matched_namespace&#39;</span><span class="p">]</span>
                                    <span class="n">metric_aggregation_settings</span> <span class="o">=</span> <span class="n">FLUX_AGGREGATE_NAMESPACES</span><span class="p">[</span><span class="n">matched_namespace</span><span class="p">]</span>
                                    <span class="c1"># Add the configuration to Redis</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.aggregate_namespaces.settings&#39;</span><span class="p">,</span> <span class="n">i_base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_aggregation_settings</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to delete metrics_manager.flux_last_known_value_aggregate_metrics Redis set&#39;</span><span class="p">)</span>

                                <span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                                <span class="c1"># Allow for zero_fill and last_known_value setting to be</span>
                                <span class="c1"># defined in the FLUX_AGGREGATE_NAMESPACES setting</span>
                                <span class="n">add_to_zero_fill</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">add_to_zero_fill</span> <span class="o">=</span> <span class="n">metric_aggregation_settings</span><span class="p">[</span><span class="s1">&#39;zero_fill&#39;</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">add_to_zero_fill</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">add_to_zero_fill</span><span class="p">:</span>
                                    <span class="n">flux_aggregate_zerofill_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_base_name</span><span class="p">)</span>
                                    <span class="c1"># logger.debug(&#39;debug :: metrics_manager :: adding i_base_name: %s to flux_aggregate_zerofill_metrics&#39; % str(i_base_name))</span>
                                <span class="n">add_to_last_known_value</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">add_to_last_known_value</span> <span class="o">=</span> <span class="n">metric_aggregation_settings</span><span class="p">[</span><span class="s1">&#39;last_known_value&#39;</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">add_to_last_known_value</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">add_to_last_known_value</span><span class="p">:</span>
                                    <span class="n">flux_aggregate_lkv_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_base_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_aggregate_zerofill_metrics</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: adding </span><span class="si">%s</span><span class="s1"> aggregate metrics that have zerofill aggregation setting to metrics_manager.flux_zero_fill_aggregate_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_aggregate_zerofill_metrics</span><span class="p">)))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux_zero_fill_aggregate_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">flux_aggregate_zerofill_metrics</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple aggregation metric members to the metrics_manager.flux_zero_fill_aggregate_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_aggregate_lkv_metrics</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: adding </span><span class="si">%s</span><span class="s1"> aggregate metrics that have last_known_value aggregation setting to metrics_manager.flux_last_known_value_aggregate_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_aggregate_lkv_metrics</span><span class="p">)))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux_last_known_value_aggregate_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">flux_aggregate_lkv_metrics</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the metrics_manager.flux_last_known_value_aggregate_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_aggregate_metrics</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: popuating analyzer.flux_aggregate_metrics Redis set with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_aggregate_metrics</span><span class="p">)))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_aggregate_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">flux_aggregate_metrics</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the analyzer.flux_aggregate_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="c1"># @added 20220429 - Feature #4536: Handle Redis failure</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                            <span class="n">metrics_manager_flux_aggregate_namespaces_settings</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">metrics_manager_flux_aggregate_namespaces_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.aggregate_namespaces.settings&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hgetall metrics_manager.flux.aggregate_namespaces.settings - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">metrics_manager_flux_aggregate_namespaces_settings</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: populating metrics_manager.flux.aggregate_namespaces.settings memcache key with </span><span class="si">%s</span><span class="s1"> namespace settings&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_manager_flux_aggregate_namespaces_settings</span><span class="p">)))</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="s1">&#39;analyzer&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics_manager.flux.aggregate_namespaces.settings&#39;</span><span class="p">,</span> <span class="n">metrics_manager_flux_aggregate_namespaces_settings</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set memcache key metrics_manager.flux.aggregate_namespaces.settings - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metrics_manager.flux.aggregate_namespaces.settings memcache ket set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">key_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">manage_flux_aggregate_namespaces_redis_key</span><span class="p">,</span> <span class="n">RUN_EVERY</span><span class="p">,</span> <span class="n">key_timestamp</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set key </span><span class="si">%s</span><span class="s1"> manage_flux_aggregate_namespaces_redis_key&#39;</span> <span class="o">%</span> <span class="n">manage_flux_aggregate_namespaces_redis_key</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checking if any metrics need to be removed from analyzer.flux_aggregate_metrics&#39;</span><span class="p">)</span>
                        <span class="n">flux_aggregate_metrics_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">flux_aggregate_metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">flux_aggregate_metrics_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_aggregate_metrics&#39;</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from analyzer.flux_aggregate_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">flux_aggregate_base_name</span> <span class="ow">in</span> <span class="n">flux_aggregate_metrics_list</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">flux_aggregate_base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_base_names</span><span class="p">:</span>
                                <span class="n">flux_aggregate_metrics_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_aggregate_base_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_aggregate_metrics_to_remove</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing </span><span class="si">%s</span><span class="s1"> metrics from analyzer.flux_aggregate_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_aggregate_metrics_to_remove</span><span class="p">)))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_aggregate_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">flux_aggregate_metrics_to_remove</span><span class="p">))</span>
                                <span class="c1"># Reload the new set</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">flux_aggregate_metrics_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_aggregate_metrics&#39;</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from analyzer.flux_aggregate_metrics Redis set after removals&#39;</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the analyzer.flux_aggregate_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no metrics need to remove from analyzer.flux_aggregate_metrics&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_aggregate_metrics_list</span><span class="p">:</span>
                            <span class="c1"># Replace the existing flux.aggregate_metrics Redis set</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sunionstore</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.aggregate_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.flux_aggregate_metrics&#39;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: replaced metrics_manager.flux.aggregate_metrics Redis set with the newly created analyzer.flux_aggregate_metrics set&#39;</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to sunionstore metrics_manager.flux.aggregate_metrics from analyzer.flux_aggregate_metrics Redis sets&#39;</span><span class="p">)</span>

                            <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
                            <span class="c1"># Add flux required data to memcache as well</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="n">metrics_manager_flux_aggregate_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">metrics_manager_flux_aggregate_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.aggregate_metrics&#39;</span><span class="p">))</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: smembers failed for metrics_manager.flux.aggregate_metrics - </span><span class="si">%e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">metrics_manager_flux_aggregate_metrics</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;metrics_manager.flux.aggregate_metrics&#39;</span><span class="p">,</span> <span class="n">metrics_manager_flux_aggregate_metrics</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set memcache metrics_manager.flux.aggregate_metrics key&#39;</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: set_memcache_key failed to set metrics_manager.flux.aggregate_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">err</span><span class="p">))</span>

                            <span class="c1"># Create a Redis hash for flux/listen.  These entries are</span>
                            <span class="c1"># managed flux/listen, if the timestamp for an entry is</span>
                            <span class="c1"># older than 12 hours flux/listen removes it from the hash</span>
                            <span class="n">time_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                            <span class="k">for</span> <span class="n">flux_aggregate_metric</span> <span class="ow">in</span> <span class="n">flux_aggregate_metrics_list</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                        <span class="s1">&#39;metrics_manager.flux.aggregate_metrics.hash&#39;</span><span class="p">,</span> <span class="n">flux_aggregate_metric</span><span class="p">,</span>
                                        <span class="n">time_now</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>

                <span class="c1"># @added 20200827 - Feature #3708: FLUX_ZERO_FILL_NAMESPACES</span>
                <span class="c1"># Analyzer determines what metrics flux should 0 fill by creating</span>
                <span class="c1"># the flux.zero_fill_metrics Redis set, which flux references.  This</span>
                <span class="c1"># is done in Analyzer because it manages metric Redis sets as it</span>
                <span class="c1"># always runs.  It is only managed in Analyzer every 5 mins.</span>
                <span class="c1"># @modified 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                <span class="c1"># if FLUX_ZERO_FILL_NAMESPACES:</span>
                <span class="k">if</span> <span class="n">FLUX_ZERO_FILL_NAMESPACES</span> <span class="ow">or</span> <span class="n">flux_aggregate_zerofill_metrics</span><span class="p">:</span>
                    <span class="n">manage_flux_zero_fill_namespaces</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">flux_zero_fill_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># Only manage every 5 mins</span>
                    <span class="n">manage_flux_zero_fill_namespaces_redis_key</span> <span class="o">=</span> <span class="s1">&#39;metrics_manager.manage_flux_zero_fill_namespaces&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">manage_flux_zero_fill_namespaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">manage_flux_zero_fill_namespaces_redis_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not query Redis for metrics_manager.manage_flux_zero_fill_namespaces key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">manage_flux_zero_fill_namespaces</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing FLUX_ZERO_FILL_NAMESPACES Redis sets&#39;</span><span class="p">)</span>
                        <span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                        <span class="k">if</span> <span class="n">flux_aggregate_zerofill_metrics</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i_base_name</span> <span class="ow">in</span> <span class="n">flux_aggregate_zerofill_metrics</span><span class="p">:</span>
                                <span class="n">flux_zero_fill_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_base_name</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: added </span><span class="si">%s</span><span class="s1"> flux_aggregate_zerofill_metrics to add to Redis sets&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_aggregate_zerofill_metrics</span><span class="p">)))</span>

                        <span class="k">for</span> <span class="n">i_base_name</span> <span class="ow">in</span> <span class="n">unique_base_names</span><span class="p">:</span>
                            <span class="n">flux_zero_fill_metric</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="s1">&#39;analyzer&#39;</span><span class="p">,</span> <span class="n">i_base_name</span><span class="p">,</span> <span class="n">FLUX_ZERO_FILL_NAMESPACES</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                                <span class="n">flux_zero_fill_metric</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">flux_zero_fill_metric</span><span class="p">:</span>
                                <span class="n">flux_zero_fill_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_base_name</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_zero_fill_metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to delete analyzer.flux_zero_fill_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_zero_fill_metrics</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: popuating analyzer.flux_zero_fill_metrics Redis set with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_zero_fill_metrics</span><span class="p">)))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_zero_fill_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">flux_zero_fill_metrics</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the analyzer.flux_zero_fill_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">key_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">manage_flux_zero_fill_namespaces_redis_key</span><span class="p">,</span> <span class="n">RUN_EVERY</span><span class="p">,</span> <span class="n">key_timestamp</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">manage_flux_zero_fill_namespaces_redis_key</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checking if any metrics need to be removed from analyzer.flux_zero_fill_metrics&#39;</span><span class="p">)</span>
                        <span class="n">flux_zero_fill_metrics_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">flux_zero_fill_metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">flux_zero_fill_metrics_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_zero_fill_metrics&#39;</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from analyzer.flux_zero_fill_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">flux_zero_fill_base_name</span> <span class="ow">in</span> <span class="n">flux_zero_fill_metrics_list</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">flux_zero_fill_base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_base_names</span><span class="p">:</span>
                                <span class="n">flux_zero_fill_metrics_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_zero_fill_base_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_zero_fill_metrics_to_remove</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing </span><span class="si">%s</span><span class="s1"> metrics from smtp_alerter_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_zero_fill_metrics_to_remove</span><span class="p">)))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_zero_fill_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">flux_zero_fill_metrics_to_remove</span><span class="p">))</span>
                                <span class="c1"># Reload the new set</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">flux_zero_fill_metrics_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_zero_fill_metrics&#39;</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from analyzer.flux_zero_fill_metrics Redis set after removals&#39;</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the analyzer.flux_zero_fill_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no metrics need to remove from analyzer.flux_zero_fill_metrics&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_zero_fill_metrics_list</span><span class="p">:</span>
                            <span class="c1"># Replace the existing flux.zero_fill_metrics Redis set</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sunionstore</span><span class="p">(</span><span class="s1">&#39;flux.zero_fill_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.flux_zero_fill_metrics&#39;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: replaced flux.zero_fill_metrics Redis set with the newly created analyzer.flux_zero_fill_metrics set&#39;</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to sunionstore flux.zero_fill_metrics from analyzer.flux_zero_fill_metrics Redis sets&#39;</span><span class="p">)</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">flux_zero_fill_metrics_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;flux.zero_fill_metric&#39;</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from flux.zero_fill_metric Redis set for memcache&#39;</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;flux.zero_fill_metrics&#39;</span><span class="p">,</span> <span class="n">flux_zero_fill_metrics_list</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set memcache flux.zero_fill_metrics key&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: set_memcache_key failed to set flux.zero_fill_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                <span class="c1"># Analyzer determines what metrics flux send the last known value for by</span>
                <span class="c1"># creating</span>
                <span class="c1"># the flux.last_known_value_metrics Redis set, which flux references.  This</span>
                <span class="c1"># is done in Analyzer because it manages metric Redis sets as it</span>
                <span class="c1"># always runs.  It is only managed in Analyzer every 5 mins.</span>
                <span class="k">if</span> <span class="n">FLUX_LAST_KNOWN_VALUE_NAMESPACES</span> <span class="ow">or</span> <span class="n">flux_aggregate_lkv_metrics</span><span class="p">:</span>
                    <span class="n">manage_flux_last_known_value_namespaces</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">flux_last_known_value_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># Only manage every 5 mins</span>
                    <span class="n">manage_flux_last_known_value_namespaces_redis_key</span> <span class="o">=</span> <span class="s1">&#39;metrics_manager.manage_flux_last_known_value_namespaces&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">manage_flux_last_known_value_namespaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">manage_flux_last_known_value_namespaces_redis_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not query Redis for metrics_manager.manage_flux_last_known_value_namespaces key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">manage_flux_last_known_value_namespaces</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing FLUX_LAST_KNOWN_VALUE_NAMESPACES Redis sets&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_last_known_value_metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to delete analyzer.flux_last_known_value_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_aggregate_lkv_metrics</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i_base_name</span> <span class="ow">in</span> <span class="n">flux_aggregate_lkv_metrics</span><span class="p">:</span>
                                <span class="n">flux_last_known_value_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_base_name</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: added </span><span class="si">%s</span><span class="s1"> flux_aggregate_lkv_metrics to add to Redis sets&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_aggregate_lkv_metrics</span><span class="p">)))</span>

                        <span class="k">for</span> <span class="n">i_base_name</span> <span class="ow">in</span> <span class="n">unique_base_names</span><span class="p">:</span>
                            <span class="n">flux_last_known_value_metric</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="s1">&#39;analyzer&#39;</span><span class="p">,</span> <span class="n">i_base_name</span><span class="p">,</span> <span class="n">FLUX_LAST_KNOWN_VALUE_NAMESPACES</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                                <span class="n">flux_last_known_value_metric</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">flux_last_known_value_metric</span><span class="p">:</span>
                                <span class="n">flux_last_known_value_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_base_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_last_known_value_metrics</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: popuating analyzer.flux_last_known_value_metrics Redis set with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_last_known_value_metrics</span><span class="p">)))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_last_known_value_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">flux_last_known_value_metrics</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the analyzer.flux_last_known_value_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">key_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">manage_flux_last_known_value_namespaces_redis_key</span><span class="p">,</span> <span class="n">RUN_EVERY</span><span class="p">,</span> <span class="n">key_timestamp</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set key :: manage_flux_last_known_value_namespaces_redis_key, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">manage_flux_last_known_value_namespaces_redis_key</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checking if any metrics need to be removed from analyzer.flux_last_known_value_metrics&#39;</span><span class="p">)</span>
                        <span class="n">flux_last_known_value_metrics_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">flux_last_known_value_metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">flux_last_known_value_metrics_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_last_known_value_metrics&#39;</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from analyzer.flux_last_known_value_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">flux_last_known_value_base_name</span> <span class="ow">in</span> <span class="n">flux_last_known_value_metrics_list</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">flux_last_known_value_base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_base_names</span><span class="p">:</span>
                                <span class="n">flux_last_known_value_metrics_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_last_known_value_base_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_last_known_value_metrics_to_remove</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing </span><span class="si">%s</span><span class="s1"> metrics from analyzer.flux_last_known_value_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_last_known_value_metrics_to_remove</span><span class="p">)))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_last_known_value_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">flux_last_known_value_metrics_to_remove</span><span class="p">))</span>
                                <span class="c1"># Reload the new set</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">flux_last_known_value_metrics_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.flux_last_known_value_metrics&#39;</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from analyzer.flux_last_known_value_metrics Redis set after removals&#39;</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the analyzer.flux_last_known_value_metrics Redis set&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no metrics need to remove from analyzer.flux_last_known_value_metrics&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flux_last_known_value_metrics_list</span><span class="p">:</span>
                            <span class="c1"># Replace the existing flux.last_known_value_metrics Redis set</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sunionstore</span><span class="p">(</span><span class="s1">&#39;flux.last_known_value_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzer.flux_last_known_value_metrics&#39;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: replaced flux.last_known_value_metrics Redis set with the newly created analyzer.flux_last_known_value_metrics set&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to sunionstore flux.last_known_value_metrics from analyzer.flux_last_known_value_metrics Redis sets - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">flux_last_known_value_metrics_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;flux.last_known_value_metrics&#39;</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate a list from flux.last_known_value_metrics Redis set for memcache&#39;</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;flux.last_known_value_metrics&#39;</span><span class="p">,</span> <span class="n">flux_last_known_value_metrics_list</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set memcache flux.last_known_value_metrics key&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: set_memcache_key failed to set flux.last_known_value_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">err</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after aggregate management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20220427 - Feature #4536: Handle Redis failure</span>
                <span class="c1"># Add flux required data to memcache as well</span>
                <span class="n">flux_namespaces</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">metrics_manager_flux_namespaces_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">flux_namespaces</span> <span class="o">=</span> <span class="n">get_flux_namespaces</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_flux_namespaces failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Manage the flux.skipped_metrics and flux.not_skipped_metrics Redis hashes</span>
                <span class="k">for</span> <span class="n">redis_hash</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;flux.skipped_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.not_skipped_metrics&#39;</span><span class="p">]:</span>
                    <span class="n">refresh_after</span> <span class="o">=</span> <span class="mi">86700</span>
                    <span class="k">if</span> <span class="n">redis_hash</span> <span class="o">==</span> <span class="s1">&#39;flux.skipped_metrics&#39;</span><span class="p">:</span>
                        <span class="n">refresh_after</span> <span class="o">=</span> <span class="mi">3900</span>

                    <span class="c1"># @modified 20220211 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># By parent_namespaces</span>
                    <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">all_parent_namespaces</span><span class="p">:</span>
                        <span class="n">flux_redis_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">redis_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">flux_redis_metrics_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hgetall </span><span class="si">%s</span><span class="s1"> Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">flux_redis_metrics_dict</span><span class="p">:</span>
                            <span class="n">removed_entries</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">flux_redis_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="n">remove_entry</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">last_updated_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">last_updated_timestamp_str</span> <span class="o">=</span> <span class="n">flux_redis_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">last_updated_timestamp_str</span><span class="p">:</span>
                                        <span class="n">last_updated_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">last_updated_timestamp_str</span><span class="p">))</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="n">remove_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine last_updated_timestamp for </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">metric</span><span class="p">,</span> <span class="n">redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">last_updated_timestamp</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span> <span class="o">-</span> <span class="n">last_updated_timestamp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">refresh_after</span><span class="p">:</span>
                                        <span class="c1"># Remove to refresh</span>
                                        <span class="n">remove_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">remove_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="c1"># @added 20220427 - Feature #4536: Handle Redis failure</span>
                                <span class="c1"># Add flux required data to memcache as well, compare to</span>
                                <span class="c1"># new metrics_manager sets</span>
                                <span class="k">if</span> <span class="n">redis_hash</span> <span class="o">==</span> <span class="s1">&#39;flux.skipped_metrics&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics_manager_do_not_skip_set</span><span class="p">:</span>
                                        <span class="n">remove_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics_manager_skip_set</span><span class="p">:</span>
                                        <span class="n">remove_entry</span> <span class="o">=</span> <span class="kc">True</span>

                                <span class="k">if</span> <span class="n">remove_entry</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">redis_key</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                                        <span class="n">removed_entries</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hdel </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">metric</span><span class="p">,</span> <span class="n">redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">removed_entries</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing </span><span class="si">%s</span><span class="s1"> metrics from </span><span class="si">%s</span><span class="s1"> Redis hash to be refreshed&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">redis_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">removed_entries</span><span class="p">)))</span>
                        <span class="c1"># @added 20220427 - Feature #4536: Handle Redis failure</span>
                        <span class="c1"># Add flux required data to memcache as well, compare to</span>
                        <span class="c1"># new metrics_manager sets</span>
                        <span class="k">if</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">flux_namespaces</span><span class="p">:</span>
                            <span class="n">add_entries</span> <span class="o">=</span> <span class="p">[]</span>

                            <span class="c1"># @modified 20230410 - Task #2732: Prometheus to Skyline</span>
                            <span class="c1">#                      Branch #4300: prometheus</span>
                            <span class="c1"># Handle labelled_metrics</span>
                            <span class="n">full_parent_namespace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_namespace</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">redis_hash</span> <span class="o">==</span> <span class="s1">&#39;flux.skipped_metrics&#39;</span><span class="p">:</span>
                                <span class="n">namespace_skipped</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics_manager_skip_set</span><span class="p">:</span>
                                    <span class="c1"># @modified 20230410 - Task #2732: Prometheus to Skyline</span>
                                    <span class="c1">#                      Branch #4300: prometheus</span>
                                    <span class="c1"># Handle labelled_metrics</span>
                                    <span class="c1"># if metric.startswith(namespace):</span>
                                    <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">full_parent_namespace</span><span class="p">):</span>
                                        <span class="n">namespace_skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">namespace_skipped</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">flux_redis_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                        <span class="n">add_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">redis_hash</span> <span class="o">==</span> <span class="s1">&#39;flux.not_skipped_metrics&#39;</span><span class="p">:</span>
                                <span class="n">namespace_not_skipped</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics_manager_do_not_skip_set</span><span class="p">:</span>
                                    <span class="c1"># @modified 20230410 - Task #2732: Prometheus to Skyline</span>
                                    <span class="c1">#                      Branch #4300: prometheus</span>
                                    <span class="c1"># Handle labelled_metrics</span>
                                    <span class="c1"># if metric.startswith(namespace):</span>
                                    <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">full_parent_namespace</span><span class="p">):</span>
                                        <span class="n">namespace_not_skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">namespace_not_skipped</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">flux_redis_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                        <span class="n">add_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">add_entries</span><span class="p">:</span>
                                <span class="n">add_entries_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="n">current_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">add_entries</span><span class="p">:</span>
                                    <span class="n">add_entries_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_timestamp</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">redis_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">add_entries_dict</span><span class="p">)</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: added </span><span class="si">%s</span><span class="s1"> metrics to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">add_entries</span><span class="p">)),</span> <span class="n">redis_key</span><span class="p">))</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hset mapping for </span><span class="si">%s</span><span class="s1"> Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after flux skip management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20210513 - Feature #4068: ANALYZER_SKIP</span>
                <span class="n">analyzer_skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">ANALYZER_SKIP</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determining ANALYZER_SKIP metrics&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                        <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="s1">&#39;analyzer&#39;</span><span class="p">,</span> <span class="n">i_metric</span><span class="p">,</span> <span class="n">ANALYZER_SKIP</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="n">analyzer_skip_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_metric</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">analyzer_skip_metrics</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: adding </span><span class="si">%s</span><span class="s1"> metrics to analyzer.metrics_manager.analyzer_skip&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">analyzer_skip_metrics</span><span class="p">)))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;new.analyzer.metrics_manager.analyzer_skip&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">analyzer_skip_metrics</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sunionstore</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.analyzer_skip&#39;</span><span class="p">,</span> <span class="s1">&#39;new.analyzer.metrics_manager.analyzer_skip&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: replaced analyzer.metrics_manager.analyzer_skip Redis set with the newly created new.analyzer.metrics_manager.analyzer_skip set&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to sunionstore analyzer.metrics_manager.analyzer_skip from new.analyzer.metrics_manager.analyzer_skip Redis sets - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">analyzer_skip_metrics</span>

                <span class="c1"># @added 20210519 - Feature #4076: CUSTOM_STALE_PERIOD</span>
                <span class="n">custom_stale_periods</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">custom_stale_period_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">default_metric_stale_period</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">STALE_PERIOD</span><span class="p">)</span>

                <span class="c1"># @added 20230329 - Feature #4882: labelled_metrics - resolution and data sparsity</span>
                <span class="c1">#                   Feature #3870: metrics_manager - check_data_sparsity</span>
                <span class="c1"># Add custom stale periods declared in external settings to</span>
                <span class="c1"># CUSTOM_STALE_PERIOD</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">external_settings</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">external_settings</span> <span class="o">=</span> <span class="n">get_external_settings</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_external_settings failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">external_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;alert_on_stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;enabled&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;alert_on_stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_period&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">STALE_PERIOD</span><span class="p">:</span>
                                <span class="n">namespace</span> <span class="o">=</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span>
                                <span class="n">CUSTOM_STALE_PERIOD</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span> <span class="o">=</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;alert_on_stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_period&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine stale period from external_settings item - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">CUSTOM_STALE_PERIOD</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no CUSTOM_STALE_PERIOD metrics defined&#39;</span><span class="p">)</span>
                <span class="n">known_custom_stale_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">known_custom_stale_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">start_custom_stale_period</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">CUSTOM_STALE_PERIOD</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determining known CUSTOM_STALE_PERIOD metrics from analyzer.metrics_manager.custom_stale_period&#39;</span><span class="p">)</span>
                    <span class="n">custom_stale_metrics_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics_manager.custom_stale_periods&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">known_custom_stale_metrics_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">custom_stale_metrics_hash_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to create known_custom_stale_metrics_dict from Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">custom_stale_metrics_hash_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">known_custom_stale_metrics_dict</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">known_custom_stale_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">known_custom_stale_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to create list of known_custom_stale_metrics from known_custom_stale_metrics_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">e</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determined </span><span class="si">%s</span><span class="s1"> known CUSTOM_STALE_PERIOD metrics from analyzer.metrics_manager.custom_stale_period&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">known_custom_stale_metrics</span><span class="p">)))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determining unique_base_names matching CUSTOM_STALE_PERIOD&#39;</span><span class="p">)</span>

                    <span class="c1"># @added 20210601 - Feature #4000: EXTERNAL_SETTINGS</span>
                    <span class="c1"># Pass the external_settings as a custom_stale_period argument</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">external_settings</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># debug</span>
                            <span class="c1"># external_settings = get_external_settings(skyline_app)</span>
                            <span class="n">external_settings</span> <span class="o">=</span> <span class="n">get_external_settings</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_external_settings failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">e</span><span class="p">))</span>

                    <span class="c1"># @modified 20230411 - Task #4872: Optimise luminosity for labelled_metrics</span>
                    <span class="c1"># for i_metric in unique_base_names:</span>
                    <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="n">all_active_base_names</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="n">custom_stale_period_metrics</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">metric_stale_period</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">default_metric_stale_period</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20210601 - Feature #4000: EXTERNAL_SETTINGS</span>
                            <span class="c1"># Pass the external_settings as a custom_stale_period argument</span>
                            <span class="n">metric_stale_period</span> <span class="o">=</span> <span class="n">custom_stale_period</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">i_metric</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed running custom_stale_period - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                            <span class="n">metric_stale_period</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">default_metric_stale_period</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_stale_period</span><span class="p">))</span> <span class="o">!=</span> <span class="n">default_metric_stale_period</span><span class="p">:</span>
                            <span class="n">custom_stale_periods</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i_metric</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_stale_period</span><span class="p">))])</span>
                            <span class="n">custom_stale_period_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_metric</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determined </span><span class="si">%s</span><span class="s1"> custom_stale_period metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">custom_stale_periods</span><span class="p">))))</span>

                <span class="k">if</span> <span class="n">custom_stale_periods</span><span class="p">:</span>
                    <span class="n">metrics_unchanged</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">metrics_added_to_hash_key</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">metrics_updated_in_hash_key</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">metrics_removed_from_hash_key</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing </span><span class="si">%s</span><span class="s1"> metrics in </span><span class="si">%s</span><span class="s1"> hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">custom_stale_periods</span><span class="p">)),</span> <span class="n">custom_stale_metrics_hash_key</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i_metric</span><span class="p">,</span> <span class="n">i_stale_period</span> <span class="ow">in</span> <span class="n">custom_stale_periods</span><span class="p">:</span>
                        <span class="n">update_hash_key</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">to_add_to_hash_key</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="n">known_custom_stale_metrics</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i_stale_period</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">known_custom_stale_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">])):</span>
                                <span class="n">update_hash_key</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">metrics_unchanged</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">update_hash_key</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">to_add_to_hash_key</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">update_hash_key</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                    <span class="n">custom_stale_metrics_hash_key</span><span class="p">,</span>
                                    <span class="n">i_metric</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i_stale_period</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">to_add_to_hash_key</span><span class="p">:</span>
                                    <span class="n">metrics_added_to_hash_key</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">metrics_updated_in_hash_key</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in </span><span class="si">%s</span><span class="s1"> for - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">custom_stale_metrics_hash_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">metrics_to_remove_from_custom_stale_period_hash</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="n">known_custom_stale_metrics</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i_metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">custom_stale_period_metrics</span><span class="p">:</span>
                            <span class="n">metrics_to_remove_from_custom_stale_period_hash</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_metric</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">metrics_to_remove_from_custom_stale_period_hash</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">custom_stale_metrics_hash_key</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_to_remove_from_custom_stale_period_hash</span><span class="p">))</span>
                            <span class="n">metrics_removed_from_hash_key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_to_remove_from_custom_stale_period_hash</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to remove </span><span class="si">%s</span><span class="s1"> metrics from the Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_to_remove_from_custom_stale_period_hash</span><span class="p">)),</span>
                                <span class="n">custom_stale_metrics_hash_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managed analyzer.metrics_manager.custom_stale_period - unchanged: </span><span class="si">%s</span><span class="s1">, added: </span><span class="si">%s</span><span class="s1">, updated: </span><span class="si">%s</span><span class="s1">, removed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metrics_unchanged</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_added_to_hash_key</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metrics_updated_in_hash_key</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metrics_removed_from_hash_key</span><span class="p">)))</span>

                <span class="k">del</span> <span class="n">known_custom_stale_metrics_dict</span>
                <span class="k">del</span> <span class="n">known_custom_stale_metrics</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: custom_stale_period management took </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_custom_stale_period</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after custom_stale_period management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20210519 - Feature #4076: CUSTOM_STALE_PERIOD</span>
                <span class="c1">#                   Branch #1444: thunder</span>
                <span class="c1"># Prune any entries out of the analyzer.metrics.last_timeseries_timestamp</span>
                <span class="c1"># has key that are older that FULL_DURATION</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: pruning analyzer.metrics.last_timeseries_timestamp Redis hash key&#39;</span><span class="p">)</span>
                <span class="n">removed_from_hash</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">prune_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics.last_timeseries_timestamp&#39;</span>
                <span class="n">older_than_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">removed_from_hash</span> <span class="o">=</span> <span class="n">prune_metrics_timestamp_hash_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">prune_hash_key</span><span class="p">,</span> <span class="n">older_than_timestamp</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: prune_metrics_timestamp_hash_key failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removed </span><span class="si">%s</span><span class="s1"> entries from </span><span class="si">%s</span><span class="s1"> hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">removed_from_hash</span><span class="p">),</span> <span class="n">prune_hash_key</span><span class="p">))</span>

                <span class="c1"># @added 20220419 - Feature #4528: metrics_manager - derivative_metric_check</span>
                <span class="c1">#                   Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
                <span class="n">longterm_non_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">longterm_non_derivative_metrics</span> <span class="o">=</span> <span class="n">derivative_metrics_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: derivative_metrics_check failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: identified </span><span class="si">%s</span><span class="s1"> longterm_non_derivative_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">longterm_non_derivative_metrics</span><span class="p">)))</span>
                <span class="k">del</span> <span class="n">longterm_non_derivative_metrics</span>

                <span class="c1"># @added 20220410 - Task #4514: Integrate opentelemetry</span>
                <span class="c1">#                   Feature #4516: flux - opentelemetry traces</span>
                <span class="n">do_not_alert_on_stale_metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determining do_not_alert_on_stale_metrics&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20230523 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                      Branch #4300: prometheus</span>
                    <span class="c1"># Handle labelled_metrics</span>
                    <span class="c1"># do_not_alert_on_stale_metrics_list = do_not_alert_on_stale_metrics(self, external_settings, unique_base_names)</span>
                    <span class="n">do_not_alert_on_stale_metrics_list</span> <span class="o">=</span> <span class="n">do_not_alert_on_stale_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">,</span> <span class="n">all_active_base_names</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: do_not_alert_on_stale_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">do_not_alert_on_stale_metrics_list</span>

                <span class="c1"># @added 20210518 - Branch #1444: thunder</span>
                <span class="c1"># Determine stale metrics AND custom stale metrics per parent namespace.</span>
                <span class="c1"># If any are present send them to thunder.</span>
                <span class="n">namespace_stale_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">namespace_recovered_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">namespace_stale_metrics_dict</span><span class="p">,</span> <span class="n">namespace_recovered_metrics_dict</span> <span class="o">=</span> <span class="n">thunder_stale_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: thunder_stale_metrics falied to get get namespace_stale_metrics_dict via - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">e</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> namespaces checked for stale metrics discovered with thunder_stale_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">namespace_stale_metrics_dict</span><span class="p">))))</span>
                <span class="k">if</span> <span class="n">namespace_stale_metrics_dict</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.namespaces.stale_metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_stale_metrics_dict</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set analyzer.metrics_manager.namespaces.stale_metrics Redis key&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set analyzer.metrics_manager.namespaces.stale_metrics Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="c1"># Thunder stale_metrics alerts on recovered metrics</span>
                <span class="k">if</span> <span class="n">namespace_recovered_metrics_dict</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.namespaces.recovered.stale_metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_recovered_metrics_dict</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set analyzer.metrics_manager.namespaces.recovered.stale_metrics Redis key&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set analyzer.metrics_manager.namespaces.recovered.stale_metrics Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing thunder alerted on stale metrics hash key&#39;</span><span class="p">)</span>
                <span class="n">removed_from_hash</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">removed_from_hash</span> <span class="o">=</span> <span class="n">manage_thunder_alerted_on_stale_metrics_hash_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: manage_thunder_alerted_on_stale_metrics_hash_key failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removed </span><span class="si">%s</span><span class="s1"> from thunder alerted on stale metrics hash key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">removed_from_hash</span><span class="p">))</span>

                <span class="c1"># @added 20210518 - Branch #1444: thunder</span>
                <span class="c1"># Determine no data per parent namespace and if any are found send them</span>
                <span class="c1"># to thunder</span>
                <span class="n">namespaces_no_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">namespaces_no_data_dict</span> <span class="o">=</span> <span class="n">thunder_no_data</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: thunder_no_data failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">namespaces_no_data_dict</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> namespaces discovered not receiving data with thunder_no_data&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">namespaces_no_data_dict</span><span class="p">))))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: thunder_no_data - all namespaces receiving data OK&#39;</span><span class="p">)</span>

                <span class="c1"># @added 20220110 - Bug #4364: Prune old thunder.events</span>
                <span class="c1">#                   Branch #1444: thunder</span>
                <span class="c1"># Any thunder events that are not acted on subsequent remain in the</span>
                <span class="c1"># thunder.events set. Remove entries older than 3 days.</span>
                <span class="n">thunder_events_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">thunder_events_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;thunder.events&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: smembers thunder.events falied - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">thunder_events_list</span><span class="p">:</span>
                    <span class="n">pruned_events</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">oldest_event_timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
                    <span class="n">thunder_events_list_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thunder_events_list</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checking </span><span class="si">%s</span><span class="s1"> thunder.events items for pruning&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">thunder_events_list_len</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">event_item</span> <span class="ow">in</span> <span class="n">thunder_events_list</span><span class="p">:</span>
                        <span class="n">remove_item</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">event_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">event_expiry</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">event_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">event_item</span><span class="p">)</span>
                            <span class="n">event_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">event_data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]))</span>
                            <span class="n">event_expiry</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">event_data</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: thunder.events determining event.timestamp failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">event_timestamp</span><span class="p">:</span>
                            <span class="n">remove_item</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">event_timestamp</span> <span class="o">&lt;</span> <span class="n">oldest_event_timestamp</span><span class="p">:</span>
                            <span class="n">remove_item</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">event_expiry</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">event_timestamp</span> <span class="o">+</span> <span class="n">event_expiry</span><span class="p">:</span>
                                <span class="n">remove_item</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">remove_item</span><span class="p">:</span>
                            <span class="c1"># Delete the item from the Redis set</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">update_redis_set</span><span class="p">(</span>
                                    <span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;thunder.events&#39;</span><span class="p">,</span> <span class="n">event_item</span><span class="p">,</span>
                                    <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="n">pruned_events</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not remove item from Redis set thunder.events - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">err</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: pruned </span><span class="si">%s</span><span class="s1"> old thunder.events items&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">pruned_events</span><span class="p">)))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after thunder and stale management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20210720 - Feature #4188: metrics_manager.boundary_metrics</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">BOUNDARY_METRICS</span><span class="p">:</span>
                    <span class="c1"># Build boundary metrics</span>
                    <span class="n">boundary_metrics_hash_key</span> <span class="o">=</span> <span class="s1">&#39;metrics_manager.boundary_metrics&#39;</span>
                    <span class="n">boundary_metrics</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="c1"># @added 20230217 - Feature #4854: boundary - labelled_metrics</span>
                    <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="c1"># Added the ability for boundary to handle labelled_metrics</span>
                    <span class="c1"># via metrics_manager.boundary_metrics</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: creating metrics_manager.boundary_metrics&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">active_labelled_metrics_with_id</span><span class="p">:</span>
                        <span class="n">active_labelled_metrics_with_id</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">active_labelled_metrics_with_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.active_labelled_metrics_with_id&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hgetall Redis hash key aet.metrics_manager.active_labelled_metrics_with_id for boundary_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                        <span class="n">all_active_base_names</span> <span class="o">=</span> <span class="n">unique_base_names</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                    <span class="c1"># @added 20230220 - Feature #4854: boundary - labelled_metrics</span>
                    <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="c1"># The original method of all metrics being matched_or_regexed_in_list</span>
                    <span class="c1"># against all settings.BOUNDARY_METRICS was quite expensive,</span>
                    <span class="c1"># taking 15 seconds for 8740 metrics and 62 boundary metric</span>
                    <span class="c1"># alert rules.  Still iterating all the metric names and</span>
                    <span class="c1"># the boundary metric alert rules but altogether first and</span>
                    <span class="c1"># only checking if any match reduces this to 3 seconds</span>
                    <span class="n">boundary_metric_patterns</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">BOUNDARY_METRICS</span><span class="p">:</span>
                        <span class="n">boundary_metric_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># @modified 20230217 - Feature #4854: boundary - labelled_metrics</span>
                    <span class="c1">#                      Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                      Branch #4300: prometheus</span>
                    <span class="c1"># Include labelled_metric base_names as well.  This is quite</span>
                    <span class="c1"># expensive, taking 15 seconds for 8740 metrics</span>
                    <span class="c1"># for base_name in unique_base_names:</span>
                    <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">all_active_base_names</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>

                            <span class="c1"># @added 20230220 - Feature #4854: boundary - labelled_metrics</span>
                            <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                            <span class="c1">#                   Branch #4300: prometheus</span>
                            <span class="c1"># The original method of all metrics being matched_or_regexed_in_list</span>
                            <span class="c1"># against all settings.BOUNDARY_METRICS was quite expensive,</span>
                            <span class="c1"># taking 15 seconds for 8740 metrics and 62 boundary metric</span>
                            <span class="c1"># alert rules.  Still iterating all the metric names and</span>
                            <span class="c1"># the boundary metric alert rules but altogether first and</span>
                            <span class="c1"># only checking if any match reduces this to 3 seconds</span>
                            <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">boundary_metric_patterns</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_match</span><span class="p">:</span>
                                <span class="k">continue</span>

                            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">BOUNDARY_METRICS</span><span class="p">:</span>
                                <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="p">[</span><span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                                <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">boundary_metrics</span><span class="p">:</span>
                                        <span class="n">boundary_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="n">algorithm</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">boundary_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="n">boundary_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                    <span class="n">boundary_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;min_average&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                                    <span class="n">boundary_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;min_average_seconds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                                    <span class="n">boundary_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;trigger_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                                    <span class="n">boundary_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;alert_threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                                    <span class="n">boundary_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">algorithm</span><span class="p">][</span><span class="s1">&#39;alert_vias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine boundary_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">boundary_metrics_redis_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">boundary_metrics_base_names</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> boundary_metrics identified from the </span><span class="si">%s</span><span class="s1"> unique_base_names and </span><span class="si">%s</span><span class="s1"> active labelled_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">boundary_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_base_names</span><span class="p">)),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="p">))))</span>
                    <span class="n">boundary_metrics_keys_updated</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">boundary_metrics</span><span class="p">:</span>
                        <span class="n">boundary_metrics_base_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">boundary_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">boundary_metrics_redis_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">boundary_metrics_hash_key</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">boundary_metrics_hash_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">boundary_metrics_base_names</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                    <span class="n">boundary_metrics_hash_key</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">boundary_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">]))</span>
                                <span class="n">boundary_metrics_keys_updated</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry to </span><span class="si">%s</span><span class="s1"> for - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">boundary_metrics_hash_key</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

                    <span class="c1"># Remove entries not defined in BOUNDARY_METRICS</span>
                    <span class="n">boundary_metrics_keys_removed</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">boundary_metrics</span> <span class="ow">and</span> <span class="n">boundary_metrics_redis_dict</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">boundary_metrics_redis_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">boundary_metrics_base_names</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">boundary_metrics_hash_key</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                                    <span class="n">boundary_metrics_keys_removed</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to delete entry in </span><span class="si">%s</span><span class="s1"> for - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">boundary_metrics_hash_key</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">boundary_metrics</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: updated: </span><span class="si">%s</span><span class="s1">, removed: </span><span class="si">%s</span><span class="s1"> entries in the Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">boundary_metrics_keys_updated</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">boundary_metrics_keys_removed</span><span class="p">),</span> <span class="n">boundary_metrics_hash_key</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after boundary management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20220406 - Feature #4518: settings - LAST_KNOWN_VALUE_NAMESPACES</span>
                <span class="c1"># Create the metrics_manager.last_known_value_metrics Redis set</span>
                <span class="n">last_known_value_metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determining last_known_value_metrics&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">last_known_value_metrics_list</span> <span class="o">=</span> <span class="n">last_known_value_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">,</span> <span class="n">unique_base_names</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: last_known_value_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">last_known_value_metrics_list</span>
                <span class="c1"># @added 20220406 - Feature #4520: settings - ZERO_FILL_NAMESPACES</span>
                <span class="c1"># Create the metrics_manager.zero_fill_metrics Redis set</span>
                <span class="n">zero_fill_metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determining zero_fill_metrics&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">zero_fill_metrics_list</span> <span class="o">=</span> <span class="n">zero_fill_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">,</span> <span class="n">unique_base_names</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: zero_fill_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">zero_fill_metrics_list</span>
                <span class="c1"># @added 20220414 - Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
                <span class="c1">#                   Task #3868: POC MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
                <span class="n">non_derivative_metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">non_derivative_metrics_list</span> <span class="o">=</span> <span class="n">non_derivative_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">,</span> <span class="n">unique_base_names</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: non_derivative_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">non_derivative_metrics_list</span>

                <span class="c1"># @added 20220421 - Task #3800: Handle feedback metrics in Mirage and waterfall alerts</span>
                <span class="c1"># Create a Redis hash of filesafe_name to base_name</span>
                <span class="n">filesafe_names_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">filesafe_names_dict</span> <span class="o">=</span> <span class="n">filesafe_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_base_names</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: filesafe_names failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">filesafe_names_dict</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after lkv, zerofill, non_derivative management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20220420 - Feature #4530: namespace.analysed_events</span>
                <span class="n">namespace_analysed_events_managed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">namespace_analysed_events_managed</span> <span class="o">=</span> <span class="n">namespace_analysed_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: namespace_analysed_events failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metrics_manager.namespace.analysed_events managed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">namespace_analysed_events_managed</span><span class="p">)))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after namespace_analysed_events management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20201030 - Feature #3808: ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS</span>
                <span class="c1"># Remove any entries in the Redis low_priority_metrics_hash_key</span>
                <span class="c1"># that are not in unique_metrics</span>
                <span class="k">if</span> <span class="n">ANALYZER_MANAGE_LOW_PRIORITY_METRICS</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing the Redis hash key </span><span class="si">%s</span><span class="s1"> and removing any metrics not in unique_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">low_priority_metrics_hash_key</span><span class="p">))</span>
                    <span class="n">low_priority_metrics_last_analyzed</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">raw_low_priority_metrics_last_analyzed</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">raw_low_priority_metrics_last_analyzed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">low_priority_metrics_hash_key</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">base_name_bytes</span> <span class="ow">in</span> <span class="n">raw_low_priority_metrics_last_analyzed</span><span class="p">:</span>
                            <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name_bytes</span><span class="p">)</span>
                            <span class="n">last_analyzed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw_low_priority_metrics_last_analyzed</span><span class="p">[</span><span class="n">base_name</span><span class="p">])</span>
                            <span class="n">low_priority_metrics_last_analyzed</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">base_name</span><span class="p">,</span> <span class="n">last_analyzed</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">low_priority_metrics_hash_key</span><span class="p">))</span>
                        <span class="n">low_priority_metrics_last_analyzed</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">del</span> <span class="n">raw_low_priority_metrics_last_analyzed</span>
                    <span class="n">low_priority_analyzed_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">low_priority_metrics_last_analyzed</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">low_priority_analyzed_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">low_priority_metrics_last_analyzed</span><span class="p">]</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: there are </span><span class="si">%s</span><span class="s1"> metrics in the Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">low_priority_analyzed_metrics</span><span class="p">)),</span>
                                <span class="n">low_priority_metrics_hash_key</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate low_priority_metrics_last_analyzed&#39;</span><span class="p">)</span>
                            <span class="n">low_priority_analyzed_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">low_priority_metrics_last_analyzed</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">if</span> <span class="n">low_priority_analyzed_metrics</span><span class="p">:</span>
                        <span class="n">low_priority_analyzed_metrics_set</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">low_priority_analyzed_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">low_priority_analyzed_metrics</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate low_priority_analyzed_metrics_set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">low_priority_analyzed_metrics</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">unique_metrics_set</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">unique_metrics_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)</span>
                            <span class="n">unique_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unique_metrics_list</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">unique_metrics_list</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to generate unique_metrics_set&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">low_priority_analyzed_metrics_set</span> <span class="ow">and</span> <span class="n">unique_metrics_set</span><span class="p">:</span>
                            <span class="n">low_priority_metrics_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">set_difference</span> <span class="o">=</span> <span class="n">low_priority_analyzed_metrics_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">unique_metrics_set</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">set_difference</span><span class="p">:</span>
                                    <span class="n">low_priority_metrics_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: determining difference between low_priority_analyzed_metrics_set and unique_metrics_set&#39;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">low_priority_analyzed_metrics_set</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">unique_metrics_set</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">set_difference</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">if</span> <span class="n">low_priority_metrics_to_remove</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing </span><span class="si">%s</span><span class="s1"> metrics from the Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">low_priority_metrics_to_remove</span><span class="p">)),</span>
                                        <span class="n">low_priority_metrics_hash_key</span><span class="p">))</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">low_priority_metrics_hash_key</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">low_priority_metrics_to_remove</span><span class="p">))</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removed </span><span class="si">%s</span><span class="s1"> metrics from the Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">low_priority_metrics_to_remove</span><span class="p">)),</span>
                                        <span class="n">low_priority_metrics_hash_key</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to remove the low_priority_metrics_to_remove the Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">low_priority_metrics_hash_key</span><span class="p">))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">del</span> <span class="n">low_priority_metrics_to_remove</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no metrics need to be removed from the Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">low_priority_metrics_hash_key</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after low priority management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20210619 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
                <span class="c1"># Surface the Redis hash key data</span>
                <span class="n">added_metric_resolution_keys</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">updated_metric_resolution_keys</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">metrics_resolutions_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics_manager.resolutions&#39;</span>
                <span class="n">metrics_resolutions_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metrics_resolutions_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">metrics_resolutions_hash_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get </span><span class="si">%s</span><span class="s1"> Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">metrics_resolutions_hash_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">metrics_resolutions_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># Set check_metrics before CHECK_DATA_SPARSITY</span>
                <span class="n">check_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)</span>
                <span class="c1"># @added 20210621 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
                <span class="n">metrics_with_unknown_resolution</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after resolution management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20201209 - Feature #3870: metrics_manager - check_data_sparsity</span>
                <span class="k">if</span> <span class="n">CHECK_DATA_SPARSITY</span><span class="p">:</span>
                    <span class="n">check_data_sparsity_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checking data sparsity&#39;</span><span class="p">)</span>

                    <span class="c1"># @added 20201210 - Feature #3870: metrics_manager - check_data_sparsity</span>
                    <span class="c1"># Allow SKIP_CHECK_DATA_SPARSITY_NAMESPACES</span>
                    <span class="n">check_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)</span>
                    <span class="n">do_not_check_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">SKIP_CHECK_DATA_SPARSITY_NAMESPACES</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determing which metric to skip checking data sparsity on as SKIP_CHECK_DATA_SPARSITY_NAMESPACES has </span><span class="si">%s</span><span class="s1"> namespaces declared&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SKIP_CHECK_DATA_SPARSITY_NAMESPACES</span><span class="p">)))</span>
                        <span class="n">check_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">skip_check_data_sparsity_error_logged</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span>
                                    <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">SKIP_CHECK_DATA_SPARSITY_NAMESPACES</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_check_data_sparsity_error_logged</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: an error occurred while matched_or_regexed_in_list in SKIP_CHECK_DATA_SPARSITY_NAMESPACES - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                                            <span class="n">skip_check_data_sparsity_error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                                        <span class="n">do_not_check_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_matched_by</span><span class="p">])</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">check_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="c1"># Only log one error as to not fill the log</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_check_data_sparsity_error_logged</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: an error occurred while evaluating </span><span class="si">%s</span><span class="s1"> for check_metrics in SKIP_CHECK_DATA_SPARSITY_NAMESPACES - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                                        <span class="n">skip_check_data_sparsity_error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">pass</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: an error occurred while determining check_metrics in SKIP_CHECK_DATA_SPARSITY_NAMESPACES - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">do_not_check_metrics</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: excluding </span><span class="si">%s</span><span class="s1"> metrics from check_data_sparsity as they match a namespace in SKIP_CHECK_DATA_SPARSITY_NAMESPACES&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">do_not_check_metrics</span><span class="p">)))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                                        <span class="s1">&#39;analyzer.metrics_manager.metrics_sparsity.skip_check_data_sparsity_metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">do_not_check_metrics</span><span class="p">))</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not set Redis analyzer.metrics_manager.metrics_sparsity.skip_check_data_sparsity_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: an error occurred while setting Redis analyzer.metrics_manager.metrics_sparsity.skip_check_data_sparsity_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                    <span class="c1"># @added 20220824 - Feature #3870: metrics_manager - check_data_sparsity</span>
                    <span class="c1"># Do not check new metrics</span>
                    <span class="n">new_metrics</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_metrics</span> <span class="o">=</span> <span class="n">get_new_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_new_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">removed_new_metrics_from_check_metrics</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">new_metrics</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># @modified 20230126 - Feature #3870: metrics_manager - check_data_sparsity</span>
                                <span class="c1">#                      Feature #3820: HORIZON_SHARDS</span>
                                <span class="c1"># Added conditional to only remove if in the</span>
                                <span class="c1"># list of unique_metrics, on cluster may not be</span>
                                <span class="c1"># if the metric is not assigned to this shard</span>
                                <span class="c1"># host.</span>
                                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">check_metrics</span><span class="p">:</span>
                                    <span class="n">check_metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                    <span class="n">removed_new_metrics_from_check_metrics</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: could not remove </span><span class="si">%s</span><span class="s1"> from check_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removed </span><span class="si">%s</span><span class="s1"> new metrics from check_metrics for check_data_sparsity&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">removed_new_metrics_from_check_metrics</span><span class="p">))</span>

                    <span class="c1"># Multi get series</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20201210 - Feature #3870: metrics_manager - check_data_sparsity</span>
                        <span class="c1"># Allow SKIP_CHECK_DATA_SPARSITY_NAMESPACES</span>
                        <span class="c1"># raw_assigned = self.redis_conn.mget(unique_metrics)</span>
                        <span class="n">raw_assigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">mget</span><span class="p">(</span><span class="n">check_metrics</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get check_metrics from Redis&#39;</span><span class="p">)</span>
                        <span class="n">raw_assigned</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_assigned</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: metrics_manager :: No raw_assigned for check sparisty&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checking data sparsity on </span><span class="si">%s</span><span class="s1"> metric timeseries from Redis&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_assigned</span><span class="p">)))</span>
                    <span class="n">last_metrics_data_sparsity</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">last_metrics_data_sparsity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.hash_key.metrics_data_sparsity&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get analyzer.metrics_manager.hash_key.metrics_data_sparsity Redis hash key&#39;</span><span class="p">)</span>
                        <span class="n">last_metrics_data_sparsity</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">if</span> <span class="n">raw_assigned</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.hash_key.metrics_data_sparsity&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to delete analyzer.metrics_manager.hash_key.metrics_data_sparsity&#39;</span><span class="p">)</span>

                    <span class="c1"># @added 20210617 - Feature #3870: metrics_manager - check_data_sparsity</span>
                    <span class="c1">#                   Branch ##1444: thunder</span>
                    <span class="n">metrics_timestamp_resolutions_count_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metrics_timestamp_resolutions_count_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.hash_key.metrics_timestamp_resolutions&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get analyzer.metrics_manager.hash_key.metrics_timestamp_resolutions Redis hash key&#39;</span><span class="p">)</span>
                        <span class="n">metrics_timestamp_resolutions_count_dict</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">check_sparsity_error_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">added_data_sparsity_keys</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">metrics_sparsity</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">metrics_fully_populated</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 100% of datapoints</span>
                    <span class="n">metrics_sparsity_decreasing</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># becoming more densely populated (good)</span>
                    <span class="n">metrics_sparsity_increasing</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># becoming more sparsely populated (bad)</span>
                    <span class="n">metrics_stale</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">metrics_inactive</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">sparsities</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">metrics_sparsity_use_namespace</span> <span class="o">=</span> <span class="n">skyline_app_graphite_namespace</span> <span class="o">+</span> <span class="s1">&#39;.metrics_sparsity&#39;</span>

                    <span class="c1"># Distill timeseries strings into lists</span>
                    <span class="c1"># @modified 20201210 - Feature #3870: metrics_manager - check_data_sparsity</span>
                    <span class="c1"># Allow SKIP_CHECK_DATA_SPARSITY_NAMESPACES</span>
                    <span class="c1"># for i, metric_name in enumerate(unique_metrics):</span>
                    <span class="k">for</span> <span class="n">check_metric_index</span><span class="p">,</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">check_metrics</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">raw_series</span> <span class="o">=</span> <span class="n">raw_assigned</span><span class="p">[</span><span class="n">check_metric_index</span><span class="p">]</span>
                                <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">raw_series</span><span class="p">)</span>
                                <span class="n">timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpacker</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>

                            <span class="c1"># @added 20210619 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                            <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
                            <span class="c1"># Populate Redis hash key data with the base_name</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span>

                            <span class="c1"># @added 20210619 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                            <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
                            <span class="c1"># Use determine_data_frequency function</span>
                            <span class="n">metric_resolution</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">timestamp_resolutions_count</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">metric_resolution</span><span class="p">,</span> <span class="n">timestamp_resolutions_count</span> <span class="o">=</span> <span class="n">determine_data_frequency</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: determine_data_frequency failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                                    <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">check_sparsity_error_count</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="n">update_metric_timestamp_resolutions_key</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">metric_timestamp_resolutions_count_str</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">metric_timestamp_resolutions_count_str</span> <span class="o">=</span> <span class="n">metrics_timestamp_resolutions_count_dict</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">metric_timestamp_resolutions_count_str</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">update_metric_timestamp_resolutions_key</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get entry from metrics_timestamp_resolutions_count_dict for - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                                    <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">metric_timestamp_resolutions_count_str</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">update_metric_timestamp_resolutions_key</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">metric_timestamp_resolutions_count_str</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">metric_timestamp_resolutions_count_str</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">timestamp_resolutions_count</span><span class="p">)):</span>
                                    <span class="n">update_metric_timestamp_resolutions_key</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">update_metric_timestamp_resolutions_key</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                        <span class="s1">&#39;analyzer.metrics_manager.hash_key.metrics_timestamp_resolutions&#39;</span><span class="p">,</span>
                                        <span class="n">metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">timestamp_resolutions_count</span><span class="p">)))</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in analyzer.metrics_manager.hash_key.metrics_timestamp_resolutions for - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                                        <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>

                            <span class="c1"># @added 20210619 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                            <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
                            <span class="c1">#                   Feature #4144: webapp - stale_metrics API endpoint</span>
                            <span class="c1">#                   Feature #4076: CUSTOM_STALE_PERIOD</span>
                            <span class="n">update_metrics_resolutions_key</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">last_known_metric_resolution</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">metric_resolution</span> <span class="ow">and</span> <span class="n">metrics_resolutions_dict</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">last_known_metric_resolution</span> <span class="o">=</span> <span class="n">metrics_resolutions_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="n">update_metrics_resolutions_key</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">last_known_metric_resolution</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: update_metrics_resolutions_key - failed to determine metric resolution for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                                        <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">check_sparsity_error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">last_known_metric_resolution</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="n">last_known_metric_resolution</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">last_known_metric_resolution</span><span class="p">))</span> <span class="o">==</span> <span class="n">metric_resolution</span><span class="p">:</span>
                                        <span class="n">update_metrics_resolutions_key</span> <span class="o">=</span> <span class="kc">False</span>

                            <span class="c1"># @added 20210621 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                            <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_resolution</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">update_metrics_resolutions_key</span><span class="p">:</span>
                                    <span class="n">update_metrics_resolutions_key</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">metrics_with_unknown_resolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>

                            <span class="c1"># @added 20210702 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                            <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
                            <span class="c1"># Never set the metric_resolution to a negative int</span>
                            <span class="k">if</span> <span class="n">update_metrics_resolutions_key</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_resolution</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: update_metrics_resolutions_key - not updating </span><span class="si">%s</span><span class="s1"> resolution from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> (invalid resolution)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_known_metric_resolution</span><span class="p">),</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_resolution</span><span class="p">)))</span>
                                    <span class="n">update_metrics_resolutions_key</span> <span class="o">=</span> <span class="kc">False</span>

                            <span class="k">if</span> <span class="n">update_metrics_resolutions_key</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">last_known_metric_resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                                    <span class="c1"># @added 20230315 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                                    <span class="c1"># Keep the sane value</span>
                                    <span class="n">update_value</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">if</span> <span class="n">last_known_metric_resolution</span> <span class="o">==</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">metric_resolution</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">metric_resolution</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>
                                        <span class="n">metric_resolution</span> <span class="o">=</span> <span class="mi">60</span>
                                        <span class="n">update_value</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">if</span> <span class="n">last_known_metric_resolution</span> <span class="o">==</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">metric_resolution</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
                                        <span class="n">metric_resolution</span> <span class="o">=</span> <span class="mi">60</span>
                                        <span class="n">update_value</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">if</span> <span class="n">update_value</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: update_metrics_resolutions_key - updating </span><span class="si">%s</span><span class="s1"> resolution from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_known_metric_resolution</span><span class="p">),</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_resolution</span><span class="p">)))</span>
                                        <span class="n">updated_metric_resolution_keys</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">added_metric_resolution_keys</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="c1"># @added 20230315 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                                    <span class="c1"># Keep the sane value</span>
                                    <span class="n">update_value</span> <span class="o">=</span> <span class="kc">True</span>

                                <span class="k">if</span> <span class="n">update_value</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                            <span class="n">metrics_resolutions_hash_key</span><span class="p">,</span>
                                            <span class="n">base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_resolution</span><span class="p">))</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in analyzer.metrics_manager.hash_key.metrics_data_sparsity for - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                                            <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="n">check_sparsity_error_count</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="c1"># @added 20210702 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                            <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
                            <span class="c1"># Explicitly set data_sparsity</span>
                            <span class="n">data_sparsity</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="k">if</span> <span class="n">metric_resolution</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">data_sparsity</span> <span class="o">=</span> <span class="n">determine_data_sparsity</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">metric_resolution</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: determine_data_sparsity failed during check_data_sparsity - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                                        <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">check_sparsity_error_count</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="n">previous_sparsity</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="n">last_metrics_data_sparsity</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">previous_sparsity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">last_metrics_data_sparsity</span><span class="p">[</span><span class="n">metric_name</span><span class="p">])</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">if</span> <span class="n">data_sparsity</span> <span class="ow">or</span> <span class="n">data_sparsity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                        <span class="s1">&#39;analyzer.metrics_manager.hash_key.metrics_data_sparsity&#39;</span><span class="p">,</span>
                                        <span class="n">metric_name</span><span class="p">,</span> <span class="n">data_sparsity</span><span class="p">)</span>
                                    <span class="n">added_data_sparsity_keys</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in analyzer.metrics_manager.hash_key.metrics_data_sparsity for - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                                        <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">check_sparsity_error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">sparsity_change</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="c1"># if data_sparsity &gt;= 100:</span>
                                <span class="k">if</span> <span class="n">data_sparsity</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULLY_POPULATED_PERCENTAGE</span><span class="p">:</span>
                                    <span class="n">metrics_fully_populated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">previous_sparsity</span> <span class="o">&lt;</span> <span class="n">data_sparsity</span><span class="p">:</span>
                                        <span class="n">metrics_sparsity_decreasing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                        <span class="n">sparsity_change</span> <span class="o">=</span> <span class="n">previous_sparsity</span> <span class="o">-</span> <span class="n">data_sparsity</span>
                                    <span class="k">if</span> <span class="n">previous_sparsity</span> <span class="o">&gt;</span> <span class="n">data_sparsity</span><span class="p">:</span>
                                        <span class="n">metrics_sparsity_increasing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                        <span class="n">sparsity_change</span> <span class="o">=</span> <span class="n">previous_sparsity</span> <span class="o">-</span> <span class="n">data_sparsity</span>
                                <span class="n">metric_sparsity_dict</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric_name</span><span class="p">,</span>
                                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                    <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="n">metric_resolution</span><span class="p">,</span>
                                    <span class="s1">&#39;data_sparsity&#39;</span><span class="p">:</span> <span class="n">data_sparsity</span><span class="p">,</span>
                                    <span class="s1">&#39;last_data_sparsity&#39;</span><span class="p">:</span> <span class="n">previous_sparsity</span><span class="p">,</span>
                                    <span class="s1">&#39;change&#39;</span><span class="p">:</span> <span class="n">sparsity_change</span><span class="p">,</span>
                                <span class="p">}</span>
                                <span class="n">metrics_sparsity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_sparsity_dict</span><span class="p">))</span>
                                <span class="n">sparsities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_sparsity</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: an error occurred during check_data_sparsity - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                                <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">check_sparsity_error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: check_data_sparsity added </span><span class="si">%s</span><span class="s1"> metrics of </span><span class="si">%s</span><span class="s1"> total metrics to analyzer.metrics_manager.hash_key.metrics_data_sparsity Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">added_data_sparsity_keys</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">))))</span>

                    <span class="k">if</span> <span class="n">metrics_fully_populated</span><span class="p">:</span>
                        <span class="n">metrics_fully_populated_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_fully_populated</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.metrics_fully_populated&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.analyzer.metrics_manager.metrics_fully_populated&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created the aet.analyzer.metrics_manager.metrics_fully_populated Redis set&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to created the aet.analyzer.metrics_manager.metrics_fully_populated Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.metrics_fully_populated&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_fully_populated</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created and added </span><span class="si">%s</span><span class="s1"> metrics to the analyzer.metrics_manager.metrics_fully_populated Redis set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_fully_populated_count</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the analyzer.metrics_manager.metrics_fully_populated Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                                <span class="s1">&#39;analyzer.metrics_manager.metrics_sparsity.metrics_fully_populated&#39;</span><span class="p">,</span> <span class="n">metrics_fully_populated_count</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not set Redis analyzer.metrics_manager.metrics_sparsity.metrics_fully_populated: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">send_metric_name</span> <span class="o">=</span> <span class="n">metrics_sparsity_use_namespace</span> <span class="o">+</span> <span class="s1">&#39;.metrics_fully_populated&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_fully_populated_count</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sent Graphite metric - </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_fully_populated_count</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not send send_graphite_metric </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_fully_populated_count</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">metrics_sparsity_decreasing</span><span class="p">:</span>
                        <span class="n">metrics_sparsity_decreasing_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_sparsity_decreasing</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.metrics_sparsity_decreasing&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.analyzer.metrics_manager.metrics_sparsity_decreasing&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created the aet.analyzer.metrics_manager.metrics_sparsity_decreasing Redis set&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to created the aet.analyzer.metrics_manager.metrics_sparsity_decreasing Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.metrics_sparsity_decreasing&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_sparsity_decreasing</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created and added </span><span class="si">%s</span><span class="s1"> metrics to the analyzer.metrics_manager.metrics_sparsity_decreasing Redis set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sparsity_decreasing_count</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the analyzer.metrics_manager.metrics_sparsity_decreasing Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                                <span class="s1">&#39;analyzer.metrics_manager.metrics_sparsity.metrics_sparsity_decreasing&#39;</span><span class="p">,</span> <span class="n">metrics_sparsity_decreasing_count</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not set Redis analyzer.metrics_manager.metrics_sparsity.metrics_sparsity_decreasing: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">send_metric_name</span> <span class="o">=</span> <span class="n">metrics_sparsity_use_namespace</span> <span class="o">+</span> <span class="s1">&#39;.metrics_sparsity_decreasing&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sparsity_decreasing_count</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sent Graphite metric - </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sparsity_decreasing_count</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not send send_graphite_metric </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sparsity_decreasing_count</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">metrics_sparsity_increasing</span><span class="p">:</span>
                        <span class="n">metrics_sparsity_increasing_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_sparsity_increasing</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.metrics_sparsity_increasing&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.analyzer.metrics_manager.metrics_sparsity_increasing&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created the aet.analyzer.metrics_manager.metrics_sparsity_increasing Redis set&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to created the aet.analyzer.metrics_manager.metrics_sparsity_increasing Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.metrics_sparsity_increasing&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_sparsity_increasing</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created and added </span><span class="si">%s</span><span class="s1"> metrics to the analyzer.metrics_manager.metrics_sparsity_increasing Redis set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sparsity_increasing_count</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the analyzer.metrics_manager.metrics_sparsity_increasing Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                                <span class="s1">&#39;analyzer.metrics_manager.metrics_sparsity.metrics_sparsity_increasing&#39;</span><span class="p">,</span> <span class="n">metrics_sparsity_increasing_count</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not set Redis analyzer.metrics_manager.metrics_sparsity.metrics_sparsity_increasing: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">send_metric_name</span> <span class="o">=</span> <span class="n">metrics_sparsity_use_namespace</span> <span class="o">+</span> <span class="s1">&#39;.metrics_sparsity_increasing&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sparsity_increasing_count</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sent Graphite metric - </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sparsity_increasing_count</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not send send_graphite_metric </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sparsity_increasing_count</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">metrics_sparsity</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.metrics_sparsity&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.analyzer.metrics_manager.metrics_sparsity&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created the aet.analyzer.metrics_manager.metrics_sparsity Redis set&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to created the aet.analyzer.metrics_manager.metrics_sparsity Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.metrics_sparsity&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_sparsity</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created and added </span><span class="si">%s</span><span class="s1"> metrics to the analyzer.metrics_manager.metrics_sparsity Redis set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_sparsity</span><span class="p">)))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the analyzer.metrics_manager.metrics_sparsity_increasing Redis set&#39;</span><span class="p">)</span>

                    <span class="n">avg_sparsity</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">sparsities</span><span class="p">:</span>
                        <span class="n">float_sparsities</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sparsities</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">float_sparsities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">avg_sparsity</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">float_sparsities</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsities</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to calculate avg_sparsity&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">avg_sparsity</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                                <span class="s1">&#39;analyzer.metrics_manager.metrics_sparsity.avg_sparsity&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">avg_sparsity</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not set Redis analyzer.metrics_manager.metrics_sparsity.avg_sparsity: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">send_metric_name</span> <span class="o">=</span> <span class="n">metrics_sparsity_use_namespace</span> <span class="o">+</span> <span class="s1">&#39;.avg_sparsity&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">avg_sparsity</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sent Graphite metric - </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">avg_sparsity</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not send send_graphite_metric </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">avg_sparsity</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
                                <span class="s1">&#39;analyzer.metrics_manager.sent.metrics_sparsity.metrics&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not set Redis analyzer.metrics_manager.sent.metrics_sparsity.metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: check_data_sparsity - of the </span><span class="si">%s</span><span class="s1"> unique_metrics, </span><span class="si">%s</span><span class="s1"> metrics are fully populated&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_fully_populated</span><span class="p">))))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: check_data_sparsity - of the </span><span class="si">%s</span><span class="s1"> unique_metrics, </span><span class="si">%s</span><span class="s1"> metrics are increasing in sparsity (this is could be bad)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_sparsity_increasing</span><span class="p">))))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: check_data_sparsity - of the </span><span class="si">%s</span><span class="s1"> unique_metrics, </span><span class="si">%s</span><span class="s1"> metrics are decreasing in sparsity (this is good)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_sparsity_decreasing</span><span class="p">))))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: check_data_sparsity - of the </span><span class="si">%s</span><span class="s1"> unique_metrics, </span><span class="si">%s</span><span class="s1"> metrics are stale&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_stale</span><span class="p">))))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: check_data_sparsity - of the </span><span class="si">%s</span><span class="s1"> unique_metrics, </span><span class="si">%s</span><span class="s1"> metrics are inactive&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_inactive</span><span class="p">))))</span>
                    <span class="n">check_data_sparsity_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">check_data_sparsity_start</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: check data sparsity took </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="n">check_data_sparsity_time</span><span class="p">)</span>

                <span class="c1"># @added 20210619 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
                <span class="c1"># Also determine resolution of metrics that were not checked for data</span>
                <span class="c1"># sparsity</span>
                <span class="n">unique_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">))</span>
                <span class="n">check_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">check_metrics</span><span class="p">)</span>
                <span class="n">set_difference</span> <span class="o">=</span> <span class="n">unique_metrics_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">check_metrics_set</span><span class="p">)</span>
                <span class="n">unchecked_resolution_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">set_difference</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: update_metrics_resolutions_key - determining resolution of </span><span class="si">%s</span><span class="s1"> metric which were skipped from sparsity check&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unchecked_resolution_metrics</span><span class="p">))))</span>
                <span class="n">unchecked_raw_assigned</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">unchecked_resolution_metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unchecked_raw_assigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">mget</span><span class="p">(</span><span class="n">unchecked_resolution_metrics</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get unchecked_resolution_metrics from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">unchecked_raw_assigned</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unchecked_resolution_metrics</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">raw_series</span> <span class="o">=</span> <span class="n">unchecked_raw_assigned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">raw_series</span><span class="p">)</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpacker</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                            <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span>
                        <span class="n">metric_resolution</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">timestamp_resolutions_count</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_resolution</span><span class="p">,</span> <span class="n">timestamp_resolutions_count</span> <span class="o">=</span> <span class="n">determine_data_frequency</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: unchecked_resolution_metrics - determine_data_frequency failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                                <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">update_metric_timestamp_resolutions_key</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">metric_timestamp_resolutions_count_str</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_timestamp_resolutions_count_str</span> <span class="o">=</span> <span class="n">metrics_timestamp_resolutions_count_dict</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">metric_timestamp_resolutions_count_str</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">update_metric_timestamp_resolutions_key</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: unchecked_resolution_metrics - failed to get entry from metrics_timestamp_resolutions_count_dict for - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                                <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">metric_timestamp_resolutions_count_str</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">update_metric_timestamp_resolutions_key</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">metric_timestamp_resolutions_count_str</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">metric_timestamp_resolutions_count_str</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">timestamp_resolutions_count</span><span class="p">)):</span>
                                <span class="n">update_metric_timestamp_resolutions_key</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">update_metric_timestamp_resolutions_key</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                    <span class="s1">&#39;analyzer.metrics_manager.hash_key.metrics_timestamp_resolutions&#39;</span><span class="p">,</span>
                                    <span class="n">metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">timestamp_resolutions_count</span><span class="p">)))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in analyzer.metrics_manager.hash_key.metrics_timestamp_resolutions for - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                                    <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">update_metrics_resolutions_key</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">last_known_metric_resolution</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">metric_resolution</span> <span class="ow">and</span> <span class="n">metrics_resolutions_dict</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">last_known_metric_resolution</span> <span class="o">=</span> <span class="n">metrics_resolutions_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">update_metrics_resolutions_key</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">last_known_metric_resolution</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: update_metrics_resolutions_key - failed to determine metric resolution for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                                    <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">last_known_metric_resolution</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">last_known_metric_resolution</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">last_known_metric_resolution</span><span class="p">))</span> <span class="o">==</span> <span class="n">metric_resolution</span><span class="p">:</span>
                                    <span class="n">update_metrics_resolutions_key</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="c1"># @added 20210621 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                        <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_resolution</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">update_metrics_resolutions_key</span><span class="p">:</span>
                                <span class="n">update_metrics_resolutions_key</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">metrics_with_unknown_resolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">update_metrics_resolutions_key</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">last_known_metric_resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                                <span class="c1"># @added 20230511 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                                <span class="c1"># Keep the sane value</span>
                                <span class="k">if</span> <span class="n">last_known_metric_resolution</span> <span class="o">==</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">metric_resolution</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">metric_resolution</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>
                                    <span class="n">metric_resolution</span> <span class="o">=</span> <span class="mi">60</span>
                                <span class="k">if</span> <span class="n">last_known_metric_resolution</span> <span class="o">==</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">metric_resolution</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
                                    <span class="n">metric_resolution</span> <span class="o">=</span> <span class="mi">60</span>

                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: update_metrics_resolutions_key - updating </span><span class="si">%s</span><span class="s1"> resolution from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_known_metric_resolution</span><span class="p">),</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_resolution</span><span class="p">)))</span>
                                <span class="n">updated_metric_resolution_keys</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">added_metric_resolution_keys</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
                                    <span class="n">metrics_resolutions_hash_key</span><span class="p">,</span>
                                    <span class="n">base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_resolution</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add entry in analyzer.metrics_manager.hash_key.metrics_data_sparsity for - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                                    <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_sparsity_error_log</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed unchecked_resolution_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                            <span class="n">check_sparsity_error_log</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: update_metrics_resolutions_key - added </span><span class="si">%s</span><span class="s1"> metric resolutions to </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">added_metric_resolution_keys</span><span class="p">),</span> <span class="n">metrics_resolutions_hash_key</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: update_metrics_resolutions_key - updated </span><span class="si">%s</span><span class="s1"> metric resolution in </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">updated_metric_resolution_keys</span><span class="p">),</span> <span class="n">metrics_resolutions_hash_key</span><span class="p">))</span>

                <span class="c1"># @added 20210621 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: update_metrics_resolutions_key - </span><span class="si">%s</span><span class="s1"> metrics have unknown resolution&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_with_unknown_resolution</span><span class="p">))))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after sparisty and resolution management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20201212 - Feature #3884: ANALYZER_CHECK_LAST_TIMESTAMP</span>
                <span class="k">if</span> <span class="n">ANALYZER_CHECK_LAST_TIMESTAMP</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metrics_last_timestamp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">metrics_last_timestamp_hash_key</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metrics_last_timestamp_dict</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: ANALYZER_CHECK_LAST_TIMESTAMP - got </span><span class="si">%s</span><span class="s1"> metrics and last analysed timestamps from </span><span class="si">%s</span><span class="s1"> Redis hash key to manage&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_last_timestamp_dict</span><span class="p">)),</span>
                                <span class="n">metrics_last_timestamp_hash_key</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: ANALYZER_CHECK_LAST_TIMESTAMP enabled but got no data from the </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">metrics_last_timestamp_hash_key</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metrics_last_timestamp_hash_key</span><span class="p">))</span>
                        <span class="n">metrics_last_timestamp_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">removed_old_keys</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">metrics_last_timestamp_dict</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics_last_timestamp_dict</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">last_analyzed_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metrics_last_timestamp_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">last_analyzed_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">last_analyzed_timestamp</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">last_analyzed_timestamp</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">):</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">metrics_last_timestamp_hash_key</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                                        <span class="n">removed_old_keys</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: ANALYZER_CHECK_LAST_TIMESTAMP could not remove </span><span class="si">%s</span><span class="s1"> from Redis </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">metrics_last_timestamp_hash_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: ANALYZER_CHECK_LAST_TIMESTAMP - removed </span><span class="si">%s</span><span class="s1"> inactive metrics from the </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">removed_old_keys</span><span class="p">),</span> <span class="n">metrics_last_timestamp_hash_key</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after last_analyzed_timestamp management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20210330 - Feature #3994: Panorama - mirage not anomalous</span>
                <span class="c1"># The mirage.panorama.not_anomalous_metrics is managed here and entries</span>
                <span class="c1"># older than 7 days are removed.</span>
                <span class="c1"># @modified 20220803 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                      Branch #4300: prometheus</span>
                <span class="c1"># Added mirage_labelled_metrics.panorama.not_anomalous_metrics</span>
                <span class="n">redis_hashes</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;mirage.panorama.not_anomalous_metrics&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;mirage_labelled_metrics.panorama.not_anomalous_metrics&#39;</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">redis_hash</span> <span class="ow">in</span> <span class="n">redis_hashes</span><span class="p">:</span>
                    <span class="c1"># redis_hash = &#39;mirage.panorama.not_anomalous_metrics&#39;</span>
                    <span class="n">mirage_panorama_not_anomalous</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">mirage_panorama_not_anomalous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries to check in the </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mirage_panorama_not_anomalous</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_hash</span><span class="p">)</span>
                        <span class="n">mirage_panorama_not_anomalous</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">timestamp_floats</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">mirage_panorama_not_anomalous</span><span class="p">:</span>
                        <span class="n">timestamp_floats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mirage_panorama_not_anomalous</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">timestamp_floats_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">timestamp_floats</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">timestamp_week_ago</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">timestamp_float</span> <span class="ow">in</span> <span class="n">timestamp_floats</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">timestamp_float</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">timestamp_week_ago</span><span class="p">:</span>
                                    <span class="n">timestamp_floats_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp_float</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine entries to remove from Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">redis_hash</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">timestamp_floats_to_remove</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">timestamp_floats_to_remove</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries were removed from Redis hash </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">timestamp_floats_to_remove</span><span class="p">))),</span> <span class="n">redis_hash</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to </span><span class="si">%s</span><span class="s1"> remove entries from Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamp_floats_to_remove</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: there are no entries that need to be removed from Redis hash </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">redis_hash</span><span class="p">))</span>

                <span class="c1"># @added 20210429 - Feature #3994: Panorama - mirage not anomalous</span>
                <span class="c1"># The ionosphere.panorama.not_anomalous_metrics is managed here and entries</span>
                <span class="c1"># older than 7 days are removed.</span>
                <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.panorama.not_anomalous_metrics&#39;</span>
                <span class="n">ionosphere_panorama_not_anomalous</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ionosphere_panorama_not_anomalous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries to check in the </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ionosphere_panorama_not_anomalous</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_hash</span><span class="p">)</span>
                    <span class="n">ionosphere_panorama_not_anomalous</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">ionosphere_timestamp_floats</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">ionosphere_panorama_not_anomalous</span><span class="p">:</span>
                    <span class="n">ionosphere_timestamp_floats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ionosphere_panorama_not_anomalous</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">ionosphere_timestamp_floats_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">ionosphere_timestamp_floats</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">timestamp_week_ago</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">timestamp_float</span> <span class="ow">in</span> <span class="n">ionosphere_timestamp_floats</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">timestamp_float</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">timestamp_week_ago</span><span class="p">:</span>
                                <span class="n">ionosphere_timestamp_floats_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp_float</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine entries to remove from Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">redis_hash</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ionosphere_timestamp_floats_to_remove</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">ionosphere_timestamp_floats_to_remove</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries were removed from Redis hash </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ionosphere_timestamp_floats_to_remove</span><span class="p">))),</span> <span class="n">redis_hash</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to </span><span class="si">%s</span><span class="s1"> remove entries from Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamp_floats_to_remove</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: there are no entries that need to be removed from Redis hash </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">redis_hash</span><span class="p">))</span>

                <span class="c1"># @added 20210330 - Feature #3994: Panorama - mirage not anomalous</span>
                <span class="c1"># The panorama.not_anomalous_plots are managed here and entries</span>
                <span class="c1"># older than 7 days are removed and files deleted</span>
                <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;panorama.not_anomalous_plots&#39;</span>
                <span class="n">panorama_not_anomalous_plots</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">panorama_not_anomalous_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries to check in the </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">panorama_not_anomalous_plots</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_hash</span><span class="p">)</span>
                    <span class="n">panorama_not_anomalous_plots</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">timestamp_floats</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">panorama_not_anomalous_plots</span><span class="p">:</span>
                    <span class="n">timestamp_floats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">panorama_not_anomalous_plots</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="n">timestamp_floats_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">timestamp_floats</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">timestamp_week_ago</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">timestamp_float</span> <span class="ow">in</span> <span class="n">timestamp_floats</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">timestamp_float</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">timestamp_week_ago</span><span class="p">:</span>
                                <span class="n">timestamp_floats_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp_float</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine entries to remove from Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">redis_hash</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">timestamp_floats_to_remove</span><span class="p">:</span>
                    <span class="c1"># Remove plot files</span>
                    <span class="k">for</span> <span class="n">timestamp_float</span> <span class="ow">in</span> <span class="n">timestamp_floats_to_remove</span><span class="p">:</span>
                        <span class="n">file_to_remove</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">file_to_remove</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="n">timestamp_float</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine file to remove from </span><span class="si">%s</span><span class="s1"> from Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_float</span><span class="p">),</span> <span class="n">redis_hash</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">file_to_remove</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_to_remove</span><span class="p">):</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_to_remove</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to file for remove entries from Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">redis_hash</span><span class="p">))</span>
                    <span class="c1"># Remove entries from the hash</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">timestamp_floats_to_remove</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries were removed from Redis hash </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">timestamp_floats_to_remove</span><span class="p">))),</span> <span class="n">redis_hash</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to </span><span class="si">%s</span><span class="s1"> remove entries from Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamp_floats_to_remove</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: there are no entries that need to be removed from Redis hash </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">redis_hash</span><span class="p">))</span>

                <span class="c1"># @added 20210803 - Feature #4164: luminosity - cloudbursts</span>
                <span class="c1"># Manage the luminosity.cloudbursts.anomalies_processed Redis hash and</span>
                <span class="c1"># remove keys that are older than 24 hours</span>
                <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudbursts.anomalies_processed&#39;</span>
                <span class="n">remove_before</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="mi">86400</span>
                <span class="n">luminosity_cloudburst_anomalies_processed</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">luminosity_cloudburst_anomalies_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries to check in the </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">luminosity_cloudburst_anomalies_processed</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_hash</span><span class="p">)</span>
                    <span class="n">luminosity_cloudburst_anomalies_processed</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">remove_keys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">luminosity_cloudburst_anomalies_processed</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">luminosity_cloudburst_anomalies_processed</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">remove_before</span><span class="p">:</span>
                            <span class="n">remove_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine timestamp from </span><span class="si">%s</span><span class="s1"> entry from Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">key</span><span class="p">,</span> <span class="n">redis_hash</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">remove_keys</span><span class="p">:</span>
                    <span class="c1"># Remove entries from the hash</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_keys</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> entries were removed from Redis hash </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_keys</span><span class="p">))),</span> <span class="n">redis_hash</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to </span><span class="si">%s</span><span class="s1"> remove entries from Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_keys</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: there are no entries or files that need to be removed from Redis hash </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">redis_hash</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after ionosphere, panorama and cloudbursts management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20230510 - Feature #4902: Prevent training on metrics newer than 7 days</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing untrainable new metrics&#39;</span><span class="p">)</span>
                <span class="n">new_from</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="p">(</span><span class="n">RUN_EVERY</span> <span class="o">+</span> <span class="mi">60</span><span class="p">)</span>
                <span class="n">last_full_new_metrics</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">last_full_new_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metrics_manager.last_full_new_metrics_timestamp&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get failed on Redis key metrics_manager.last_full_new_metrics_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">last_full_new_metrics</span><span class="p">:</span>
                    <span class="n">new_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">new_from</span> <span class="o">=</span> <span class="n">new_now</span> <span class="o">-</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: hourly retrieval of new metrics in past 7 days&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;metrics_manager.last_full_new_metrics_timestamp&#39;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_now</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: setex failed on Redis key metrics_manager.last_full_new_metrics_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_metrics</span> <span class="o">=</span> <span class="n">get_new_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="o">=</span><span class="n">new_from</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: get_new_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="n">managed_new_metrics_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;added&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">managed_new_metrics_dict</span> <span class="o">=</span> <span class="n">manage_untrainable_new_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_metrics</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: manage_untrainable_new_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managed untrainable new metrics, added </span><span class="si">%s</span><span class="s1"> new metrics and removed </span><span class="si">%s</span><span class="s1"> mature metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">managed_new_metrics_dict</span><span class="p">[</span><span class="s1">&#39;added&#39;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">managed_new_metrics_dict</span><span class="p">[</span><span class="s1">&#39;removed&#39;</span><span class="p">])))</span>

                <span class="c1"># @added 20210825 - Feature #4164: luminosity - cloudbursts</span>
                <span class="n">metric_names_with_ids</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># @added 20211004 - Feature #4264: luminosity - cross_correlation_relationships</span>
                <span class="n">ids_with_metric_names</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># @added 20210430 - Task #4030: refactoring</span>
                <span class="n">metric_names</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20210825 - Feature #4164: luminosity - cloudbursts</span>
                    <span class="c1"># metric_names = get_all_db_metric_names(skyline_app)</span>
                    <span class="n">with_ids</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># @modified 20220302 - Feature #4444: webapp - inactive_metrics</span>
                    <span class="c1">#                      Feature #3828: Add inactive columns to the metrics DB table</span>
                    <span class="c1">#                      Feature #4468: flux - remove_namespace_quota_metrics</span>
                    <span class="c1"># Use the method to exclude metrics that have been set to inactive</span>
                    <span class="c1"># metric_names, metric_names_with_ids = get_all_db_metric_names(skyline_app, with_ids)</span>
                    <span class="n">metric_names</span><span class="p">,</span> <span class="n">metric_names_with_ids</span> <span class="o">=</span> <span class="n">get_all_active_db_metric_names</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">with_ids</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get_all_active_db_metric_names - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">metric_names</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.db.metric_names&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.analyzer.metrics_manager.db.metric_names&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created the aet.analyzer.metrics_manager.db.metric_names Redis set&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to created the aet.analyzer.metrics_manager.db.metrics_fully_populated Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager.db.metric_names&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metric_names</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created and added </span><span class="si">%s</span><span class="s1"> metrics to the analyzer.metrics_manager.db.metric_names Redis set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_names</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the analyzer.metrics_manager.db.metrics_fully_populated Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                <span class="c1"># @added 20230505 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
                <span class="n">skip_irregular_unstable_metric_ids_count</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">start_skip_irregular_unstable_metric_ids</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">skip_irregular_unstable_metric_ids_count</span> <span class="o">=</span> <span class="n">build_skip_irregular_unstable_metric_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_names_with_ids</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: build_skip_irregular_unstable_metric_ids failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determined </span><span class="si">%s</span><span class="s1"> skip_irregular_unstable_metric_ids in </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">skip_irregular_unstable_metric_ids_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_skip_irregular_unstable_metric_ids</span><span class="p">)))</span>

                <span class="c1"># @added 20230203 - Feature #4840: flux - prometheus - x-test-only header</span>
                <span class="c1"># Readded all_db_metric_names_with_ids some that labelled_metrics</span>
                <span class="c1"># base_names can be looked up if they become active again in</span>
                <span class="c1"># labelled_metrics.unique_metrics</span>
                <span class="n">all_db_metric_names</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">all_db_metric_names_with_ids</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">with_ids</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">all_db_metric_names</span><span class="p">,</span> <span class="n">all_db_metric_names_with_ids</span> <span class="o">=</span> <span class="n">get_all_db_metric_names</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">with_ids</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get_all_db_metric_names - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                
                <span class="n">all_db_metric_ids_with_names</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_db_metric_names_with_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">all_db_metric_ids_with_names</span><span class="p">[</span><span class="n">all_db_metric_names_with_ids</span><span class="p">[</span><span class="n">metric</span><span class="p">]]</span> <span class="o">=</span> <span class="n">metric</span>

                    <span class="c1"># @added 20230411 - Task #4872: Optimise luminosity for labelled_metrics</span>
                    <span class="c1"># Create a unique list of namespaces to create a hash to be used in</span>
                    <span class="c1"># luminosity</span>
                    <span class="n">start_unique_parent_namespaces_timing</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
                        <span class="n">metric_elements</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">metric_labels</span> <span class="o">=</span> <span class="n">metric_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">metric_labels</span> <span class="o">=</span> <span class="n">metric_labels</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                        <span class="n">tenant_id_label</span> <span class="o">=</span> <span class="n">metric_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">tenant_id_label_list</span> <span class="o">=</span> <span class="n">tenant_id_label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                        <span class="n">parent_namespace</span> <span class="o">=</span> <span class="n">tenant_id_label_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">parent_namespace</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">active_namespace</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">active_namespace</span> <span class="o">=</span> <span class="n">metric_names_with_ids</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">active_namespace</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">active_namespace</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">unique_parent_namespaces</span><span class="p">[</span><span class="n">parent_namespace</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">unique_parent_namespaces</span><span class="p">[</span><span class="n">parent_namespace</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">unique_parent_namespaces_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_unique_parent_namespaces_timing</span><span class="p">)</span>

                <span class="c1"># @added 20230411 - Task #4872: Optimise luminosity for labelled_metrics</span>
                <span class="c1"># Create a unique list of namespaces to create a hash to be used in</span>
                <span class="c1"># luminosity</span>
                <span class="n">known_parent_namespaces</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">known_parent_namespaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hkeys</span><span class="p">(</span><span class="s1">&#39;metrics_manager.luminosity.namespaces&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: hkeys failed on metrics_manager.luminosity.namespaces Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">add_luminosity_namespace_keys</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">unique_parent_namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_parent_namespaces</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">unique_parent_namespace</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_parent_namespaces</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: adding namespace: </span><span class="si">%s</span><span class="s1"> to add_luminosity_namespace_keys&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_parent_namespace</span><span class="p">))</span>
                        <span class="n">add_luminosity_namespace_keys</span><span class="p">[</span><span class="n">unique_parent_namespace</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">known_parent_namespaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_parent_namespace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">add_luminosity_namespace_keys</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: adding </span><span class="si">%s</span><span class="s1"> namespaces to metrics_manager.luminosity.namespaces Redis hash&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">add_luminosity_namespace_keys</span><span class="p">)))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: adding add_luminosity_namespace_keys: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">add_luminosity_namespace_keys</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">known_parent_namespaces_added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.luminosity.namespaces&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">add_luminosity_namespace_keys</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> namespace added to metrics_manager.luminosity.namespaces&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">known_parent_namespaces_added</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: hset failed on metrics_manager.luminosity.namespaces Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.luminosity.namespaces&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">unique_parent_namespaces</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: updated </span><span class="si">%s</span><span class="s1"> namespace counts in metrics_manager.luminosity.namespaces&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_parent_namespaces</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: hset failed on metrics_manager.luminosity.namespaces Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">remove_namespace_keys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">known_parent_namespaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hkeys</span><span class="p">(</span><span class="s1">&#39;metrics_manager.luminosity.namespaces&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: hkeys failed on metrics_manager.luminosity.namespaces Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">known_parent_namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">known_parent_namespaces</span><span class="p">):</span>
                    <span class="c1"># Remove inactive namespaces</span>
                    <span class="k">if</span> <span class="n">known_parent_namespace</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_parent_namespaces</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing </span><span class="si">%s</span><span class="s1"> namespace from metrics_manager.luminosity.namespaces&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">known_parent_namespaces</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;metrics_manager.luminosity.namespaces&#39;</span><span class="p">,</span> <span class="n">known_parent_namespace</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: hdel failed with </span><span class="si">%s</span><span class="s1"> on metrics_manager.luminosity.namespaces Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">known_parent_namespace</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                <span class="n">unique_parent_namespaces_timing</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">unique_parent_namespaces_timings</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_parent_namespaces_timings</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metrics_manager.luminosity.namespaces managed, unique_parent_namespaces_timings: </span><span class="si">%s</span><span class="s1"> seconds, </span><span class="si">%s</span><span class="s1"> namespaces determined from </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">unique_parent_namespaces_timing</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_parent_namespaces</span><span class="p">)),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_db_metric_names_with_ids</span><span class="p">))))</span>

                <span class="c1"># @added 20230411 - Task #4872: Optimise luminosity for labelled_metrics</span>
                <span class="c1"># Create a unique list of namespaces to create a hash to be used in</span>
                <span class="c1"># luminosity</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> metric_names_with_ids retrieved from DB&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_names_with_ids</span><span class="p">)))</span>

                <span class="c1"># @added 20211011 - Feature #4278: luminosity - related_namespaces</span>
                <span class="c1"># Create and manage the metrics_manager.namespaces Redis hash but only</span>
                <span class="c1"># update it if new data</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_names_with_ids</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: metric_names_with_ids is empty&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_names_with_ids</span><span class="p">:</span>
                    <span class="n">update_namespaces</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> metric_names_with_ids retrieved from DB&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_names_with_ids</span><span class="p">)))</span>

                    <span class="c1"># aet_metric_names_with_ids = {}</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">aet_metric_names_with_ids</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">aet_metric_names_with_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.metric_names_with_ids&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: got </span><span class="si">%s</span><span class="s1"> last aet.metrics_manager.metric_names_with_ids from Redis to check namespaces&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aet_metric_names_with_ids</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to hgetall aet.metrics_manager.metric_names_with_ids to check namespace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aet_metric_names_with_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">metric_names_with_ids</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: aet.metrics_manager.metric_names_with_ids from Redis is empty so using metric_names_with_ids to check namespaces&#39;</span><span class="p">)</span>
                        <span class="n">aet_metric_names_with_ids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">metric_names_with_ids</span><span class="p">)</span>

                    <span class="n">namespaces</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">namespaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.namespaces&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: got </span><span class="si">%s</span><span class="s1"> metrics_manager.namespaces from Redis to check namespaces&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">namespaces</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to hgetall metrics_manager.namespaces to check namespaces - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">namespaces</span><span class="p">:</span>
                        <span class="n">update_namespaces</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no known namespaces updating namespaces&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">aet_metric_names_with_ids</span><span class="p">:</span>
                        <span class="n">last_metric_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">aet_metric_names_with_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
                        <span class="k">if</span> <span class="n">metric_names</span><span class="p">:</span>
                            <span class="n">current_metric_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">aet_metric_names_with_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
                        <span class="k">if</span> <span class="n">current_metric_names</span> <span class="o">!=</span> <span class="n">last_metric_names</span><span class="p">:</span>
                            <span class="n">update_namespaces</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metrics changes updating namespaces&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">update_namespaces</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no changes to metrics not updating namespaces&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">update_namespaces</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: updating namespaces&#39;</span><span class="p">)</span>
                        <span class="n">namespaces_list</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">current_metric_names</span><span class="p">:</span>
                            <span class="n">namespace_elements</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                            <span class="n">namespaces_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">namespace_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">namespaces_list</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">namespace</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">namespace_element_count</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">r_base_name</span> <span class="ow">in</span> <span class="n">current_metric_names</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">r_base_name</span><span class="p">:</span>
                                    <span class="n">namespace_element_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">namespace_element_count</span><span class="p">:</span>
                                <span class="n">namespaces</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespace_element_count</span>
                        <span class="n">sorted_namespaces</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">namespaces</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                            <span class="n">sorted_namespaces</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespaces</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">sorted_namespaces</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.namespaces&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">sorted_namespaces</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set </span><span class="si">%s</span><span class="s1"> namespaces in metrics_manager.namespaces Redis hash&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sorted_namespaces</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to create metrics_manager.namespaces Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20230123 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Check metric if metric/s are in DB and not in</span>
                <span class="c1"># Redis for metrics_manager to reset as active</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checking if horizon.prometheus has added any metrics to horizon.active_metrics_not_in_metric_names_with_ids&#39;</span><span class="p">)</span>
                <span class="n">metric_ids_to_reactive</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_ids_to_reactive</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;horizon.active_metrics_not_in_metric_names_with_ids&#39;</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: horizon.prometheus added </span><span class="si">%s</span><span class="s1"> metric_idsto reactive&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_ids_to_reactive</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: smembers on horizon.active_metrics_not_in_metric_names_with_ids failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                <span class="n">set_metrics_as_active_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">metric_ids_to_reactive</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;horizon.active_metrics_not_in_metric_names_with_ids&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: deleted horizon.active_metrics_not_in_metric_names_with_ids&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: delete on horizon.active_metrics_not_in_metric_names_with_ids failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">set_metrics_as_active_count</span> <span class="o">=</span> <span class="n">set_metric_ids_as_active</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_ids_to_reactive</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: set_metric_ids_as_active failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set </span><span class="si">%s</span><span class="s1"> metric ids as active again&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">set_metrics_as_active_count</span><span class="p">))</span>

                <span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
                <span class="n">mute_alerts_on_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mute_alerts_on_dict</span><span class="p">,</span> <span class="n">removed</span> <span class="o">=</span> <span class="n">manage_mute_alerts_on</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: manage_mute_alerts_on failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

                <span class="n">ids_with_metric_names</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">ids_with_labelled_metric_names</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">active_labelled_ids_with_metrics</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># @added 20220620 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="n">active_labelled_metrics_with_id</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># @added 20230519 - Feature #3336: webapp api - derivative_metrics</span>
                <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># To handle labelled_metrics, allow for the request to pass a metric</span>
                <span class="c1"># to determine if it is a derivative_metric or not</span>
                <span class="n">derivative_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="n">metric_names_with_ids</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: creating the aet.metrics_manager.metric_names_with_ids Redis set&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;metrics_manager.metric_names_with_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.metrics_manager.metric_names_with_ids&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created the aet.metrics_manager.metric_names_with_ids Redis set&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to created the aet.metrics_manager.metric_names_with_ids Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">set_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hlen</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.metric_names_with_ids&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created the aet.metrics_manager.metric_names_with_ids Redis set with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">set_len</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: hlen failed on the aet.metrics_manager.metric_names_with_ids Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.metric_names_with_ids&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">metric_names_with_ids</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created and added </span><span class="si">%s</span><span class="s1"> metrics to the metrics_manager.metric_names_with_ids Redis hash&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_names_with_ids</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to create metrics_manager.metric_names_with_ids Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="c1"># @added 20220620 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: creating active_labelled_metrics_with_id&#39;</span><span class="p">)</span>
                    <span class="n">active_labelled_metrics_with_id</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">analyzer_labelled_metrics_last_timeseries_timestamps</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">analyzer_labelled_metrics_last_timeseries_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.last_timeseries_timestamp&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: active_labelled_metrics_with_id - hget analyzer_labelled_metrics.last_timeseries_timestamp failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="c1"># @added 20211004 - Feature #4264: luminosity - cross_correlation_relationships</span>
                    <span class="k">for</span> <span class="n">c_metric_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_names_with_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">c_metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_names_with_ids</span><span class="p">[</span><span class="n">c_metric_name</span><span class="p">]))</span>
                        <span class="n">ids_with_metric_names</span><span class="p">[</span><span class="n">c_metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_metric_name</span>
                        <span class="c1"># @added 20220620 - Task #2732: Prometheus to Skyline</span>
                        <span class="c1">#                   Branch #4300: prometheus</span>
                        <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">c_metric_name</span> <span class="ow">and</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">c_metric_name</span> <span class="ow">and</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">c_metric_name</span><span class="p">:</span>
                            <span class="n">ids_with_labelled_metric_names</span><span class="p">[</span><span class="n">c_metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_metric_name</span>

                            <span class="c1"># @added 20220620 - Task #2732: Prometheus to Skyline</span>
                            <span class="c1">#                   Branch #4300: prometheus</span>
                            <span class="c1"># @modified 20230202 - Feature #4792: functions.metrics_manager.manage_inactive_metrics</span>
                            <span class="c1">#                      Feature #4838: functions.metrics.get_namespace_metric.count</span>
                            <span class="c1"># This entire active_metric_id block was under-indented</span>
                            <span class="c1"># so indented properly while handling manage_inactive_metrics</span>
                            <span class="c1"># in the cluster context, which highlighted that this</span>
                            <span class="c1"># was adding all metrics due to the</span>
                            <span class="c1"># Add metrics reset to active added on 20230123</span>
                            <span class="n">active_metric_id</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">active_metric_id</span> <span class="o">=</span> <span class="n">analyzer_labelled_metrics_last_timeseries_timestamps</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c_metric_id</span><span class="p">)]</span>
                                <span class="k">if</span> <span class="n">active_metric_id</span><span class="p">:</span>
                                    <span class="n">active_labelled_metrics_with_id</span><span class="p">[</span><span class="n">c_metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_metric_id</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>

                            <span class="c1"># @added 20230123 - Task #2732: Prometheus to Skyline</span>
                            <span class="c1">#                   Branch #4300: prometheus</span>
                            <span class="c1"># Add metrics reset to active</span>
                            <span class="k">if</span> <span class="n">active_metric_id</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">c_metric_id</span> <span class="ow">in</span> <span class="n">metric_ids_to_reactive</span><span class="p">:</span>
                                    <span class="n">active_labelled_metrics_with_id</span><span class="p">[</span><span class="n">c_metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_metric_id</span>
                                    <span class="n">active_labelled_ids_with_metrics</span><span class="p">[</span><span class="n">c_metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_metric_name</span>
                                <span class="c1"># and add all metrics reported active by the database</span>
                                <span class="n">active_labelled_metrics_with_id</span><span class="p">[</span><span class="n">c_metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_metric_id</span>
                                <span class="n">active_labelled_ids_with_metrics</span><span class="p">[</span><span class="n">c_metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_metric_name</span>

                    <span class="k">del</span> <span class="n">analyzer_labelled_metrics_last_timeseries_timestamps</span>

                    <span class="c1"># @added 20230406 - Feature #4882: labelled_metrics - resolution and data sparsity</span>
                    <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="n">updated_labelled_metrics_sparsity</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">active_labelled_ids_with_metrics</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">updated_labelled_metrics_sparsity</span> <span class="o">=</span> <span class="n">update_labelled_metrics_data_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_labelled_ids_with_metrics</span><span class="p">,</span> <span class="n">RUN_EVERY</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: update_labelled_metrics_data_sparsity failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sparsity updated </span><span class="si">%s</span><span class="s1"> labelled_metric&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">updated_labelled_metrics_sparsity</span><span class="p">)))</span>

                    <span class="c1"># @added 20230203 - Feature #4840: flux - prometheus - x-test-only header</span>
                    <span class="c1"># Readded all_db_metric_names_with_ids so that labelled_metrics</span>
                    <span class="c1"># base_names can be looked up if they become active again in</span>
                    <span class="c1"># labelled_metrics.unique_metrics</span>
                    <span class="k">if</span> <span class="n">labelled_metrics_active_ids</span><span class="p">:</span>
                        <span class="n">labelled_metrics_active_ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">labelled_metrics_active_ids</span><span class="p">)</span>
                        <span class="n">active_labelled_ids_with_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_ids_with_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                        <span class="n">set_difference</span> <span class="o">=</span> <span class="n">labelled_metrics_active_ids_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">active_labelled_ids_with_metrics_set</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">set_difference</span><span class="p">:</span>
                            <span class="n">readding_labelled_metrics_errors</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">readded_active_again_labelled_metrics</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">set_difference</span><span class="p">):</span>
                                <span class="n">metric_name</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">metric_name</span> <span class="o">=</span> <span class="n">all_db_metric_ids_with_names</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">readding_labelled_metrics_errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;readding_labelled_metrics error - failed to determine metric_name from id:&#39;</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">metric_name</span><span class="p">:</span>
                                    <span class="n">active_labelled_metrics_with_id</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>
                                    <span class="n">active_labelled_ids_with_metrics</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_name</span>
                                    <span class="n">readded_active_again_labelled_metrics</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">readding_labelled_metrics_errors</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> readding_labelled_metrics errors occurred, last 3: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">readding_labelled_metrics_errors</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: readded </span><span class="si">%s</span><span class="s1"> labelled_metrics that are active again in Redis&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">readded_active_again_labelled_metrics</span><span class="p">))</span>
                    <span class="k">del</span> <span class="n">all_db_metric_ids_with_names</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;metrics_manager.ids_with_metric_names&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.metrics_manager.ids_with_metric_names&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created the aet.metrics_manager.ids_with_metric_names Redis set&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to created the aet.metrics_manager.ids_with_metric_names Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.ids_with_metric_names&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">ids_with_metric_names</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created and added </span><span class="si">%s</span><span class="s1"> metrics to the metrics_manager.ids_with_metric_names Redis hash&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids_with_metric_names</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to create metrics_manager.ids_with_metric_names Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="c1"># @added 20220620 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="k">if</span> <span class="n">active_labelled_metrics_with_id</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.active_labelled_metrics_with_id&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">active_labelled_metrics_with_id</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;metrics_manager.active_labelled_metrics_with_id&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.metrics_manager.active_labelled_metrics_with_id&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created the aet.metrics_manager.active_labelled_metrics_with_id Redis hash with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to create aet.metrics_manager.active_labelled_metrics_with_id Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">active_labelled_metrics_with_id</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                            <span class="n">active_labelled_ids_with_metrics</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
                        <span class="c1"># del active_labelled_metrics_with_id</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;metrics_manager.active_labelled_ids_with_metric&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">active_labelled_ids_with_metrics</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;metrics_manager.active_labelled_ids_with_metric&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.metrics_manager.active_labelled_ids_with_metric&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created the aet.metrics_manager.active_labelled_ids_with_metric Redis hash with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_labelled_ids_with_metrics</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to create metrics_manager.active_labelled_ids_with_metric Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                        <span class="c1"># @added 20230519 - Feature #3336: webapp api - derivative_metrics</span>
                        <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                        <span class="c1">#                   Branch #4300: prometheus</span>
                        <span class="c1"># To handle labelled_metrics, allow for the request to pass a metric</span>
                        <span class="c1"># to determine if it is a derivative_metric or not</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determining list of derivative_labelled_metrics&#39;</span><span class="p">)</span>
                        <span class="n">skyline_labelled_metrics_id_types</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">skyline_labelled_metrics_id_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to hgetall skyline.labelled_metrics.id.type - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">active_labelled_metric</span> <span class="ow">in</span> <span class="n">active_labelled_metrics_with_id</span><span class="p">:</span>
                            <span class="n">metric_type</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">metric_type</span> <span class="o">=</span> <span class="n">skyline_labelled_metrics_id_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="p">[</span><span class="n">active_labelled_metric</span><span class="p">])]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_type</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                                <span class="n">derivative_labelled_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">active_labelled_metric</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determined list of </span><span class="si">%s</span><span class="s1"> derivative_labelled_metrics from the </span><span class="si">%s</span><span class="s1"> active labelled_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">derivative_labelled_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="p">))))</span>

                        <span class="c1"># @added 20230519 - metric_type.longterm_expire</span>
                        <span class="c1"># Determine labelled_metrics longterm monotonicity</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: managing labelled_metrics longterm metric_type&#39;</span><span class="p">)</span>
                        <span class="n">updated_types</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">checked_ids</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">checked_ids</span><span class="p">,</span> <span class="n">updated_types</span> <span class="o">=</span> <span class="n">manage_labelled_metrics_longterm_metric_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RUN_EVERY</span><span class="p">,</span> <span class="n">active_labelled_metrics_with_id</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: manage_labelled_metrics_longterm_metric_type failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: checked: </span><span class="si">%s</span><span class="s1"> and updated </span><span class="si">%s</span><span class="s1"> labelled_metrics longterm metric_types&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">checked_ids</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">updated_types</span><span class="p">)))</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no entries in active_labelled_metrics_with_id deleting Redis hashes&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;metrics_manager.active_labelled_ids_with_metric&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.active_labelled_ids_with_metric&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: deleted the metrics_manager.active_labelled_ids_with_metric and aet.metrics_manager.active_labelled_ids_with_metric Redis hashes&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to delete metrics_manager.active_labelled_ids_with_metric and aet.metrics_manager.active_labelled_ids_with_metric Redis hashes - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no entries in active_labelled_metrics_with_id deleting Redis hashes&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;metrics_manager.active_labelled_metrics_with_id&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.active_labelled_metrics_with_id&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: deleted the metrics_manager.active_labelled_metrics_with_id and aet.metrics_manager.active_labelled_metrics_with_id Redis hashes&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to delete metrics_manager.active_labelled_metrics_with_id and aet.metrics_manager.active_labelled_metrics_with_id Redis hashes - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after metric names and ids management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20230105 - Feature #4792: functions.metrics_manager.manage_inactive_metrics</span>
                <span class="n">reactivate_metric_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">reactivate_metric_ids</span> <span class="o">=</span> <span class="n">manage_inactive_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_base_names</span><span class="p">,</span> <span class="n">active_labelled_metrics_with_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: manage_inactive_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="c1"># @added 20230201 - Feature #4792: functions.metrics_manager.manage_inactive_metrics</span>
                <span class="c1"># Reactivate metrics if manage_inactive_metrics returns metric ids to reactive</span>
                <span class="k">if</span> <span class="n">reactivate_metric_ids</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">set_metrics_as_active_count</span> <span class="o">=</span> <span class="n">set_metric_ids_as_active</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">reactivate_metric_ids</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: set_metric_ids_as_active failed after manage_inactive_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set </span><span class="si">%s</span><span class="s1"> metric ids as active again after manage_inactive_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">set_metrics_as_active_count</span><span class="p">))</span>

                <span class="c1"># @added 20230425 - Feature #4894: labelled_metrics - SKYLINE_FEEDBACK_NAMESPACES</span>
                <span class="c1"># Create feedback_labelled_metrics from active_labelled_metrics_with_id</span>
                <span class="n">start_feedback_labelled_metric_ids</span><span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="n">feedback_labelled_metric_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">feedback_labelled_metric_errors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">labelled_metric_base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pattern_match</span><span class="p">,</span> <span class="n">matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">labelled_metric_base_name</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_FEEDBACK_NAMESPACES</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="n">feedback_metric</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="n">feedback_metric</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span><span class="p">:</span>
                                <span class="n">pattern_match</span><span class="p">,</span> <span class="n">matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">labelled_metric_base_name</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DO_NOT_SKIP_SKYLINE_FEEDBACK_NAMESPACES</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                                    <span class="n">feedback_metric</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">feedback_metric</span><span class="p">:</span>
                                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">active_labelled_metrics_with_id</span><span class="p">[</span><span class="n">labelled_metric_base_name</span><span class="p">]</span>
                                <span class="n">feedback_labelled_metric_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">feedback_labelled_metric_errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_metric_base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">feedback_labelled_metric_errors</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: </span><span class="si">%s</span><span class="s1"> errors reported during determining feedback_labelled_metric_ids, last 3 errors - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feedback_labelled_metric_errors</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">feedback_labelled_metric_errors</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]),</span> <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
                <span class="k">if</span> <span class="n">mute_alerts_on_dict</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mute_alerts_on_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                            <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">feedback_labelled_metric_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">feedback_labelled_metric_ids</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;metrics_manager.feedback.labelled_metric_ids&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">feedback_labelled_metric_ids</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to created metrics_manager.feedback.labelled_metric_ids Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;metrics_manager.feedback.labelled_metric_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.metrics_manager.feedback.labelled_metric_ids&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created the aet.metrics_manager.feedback.labelled_metric_ids Redis set&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to rename metrics_manager.feedback.labelled_metric_ids Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determined </span><span class="si">%s</span><span class="s1"> feedback labelled_metrics in </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feedback_labelled_metric_ids</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_feedback_labelled_metric_ids</span><span class="p">)))</span>

                <span class="k">del</span> <span class="n">unique_base_names</span>

                <span class="c1"># @added 20220809 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="k">if</span> <span class="n">active_labelled_ids_with_metrics</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: running manage_smtp_alerter_labelled_metrics passing </span><span class="si">%s</span><span class="s1"> ids_with_metric_names&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids_with_metric_names</span><span class="p">)))</span>
                    <span class="n">smtp_alert_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">smtp_alert_labelled_metrics</span> <span class="o">=</span> <span class="n">manage_smtp_alerter_labelled_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids_with_metric_names</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: manage_smtp_alerter_labelled_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                        <span class="n">smtp_alert_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: ran manage_smtp_alerter_labelled_metrics </span><span class="si">%s</span><span class="s1"> smtp alert enabled metrics determined&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">smtp_alert_labelled_metrics</span><span class="p">)))</span>
                    <span class="k">del</span> <span class="n">smtp_alert_labelled_metrics</span>

                <span class="k">del</span> <span class="n">active_labelled_metrics_with_id</span>

                <span class="c1"># @added 20220627 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Run redistimeseries_roomba</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: running redistimeseries_roomba passing </span><span class="si">%s</span><span class="s1"> active_labelled_ids_with_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_labelled_ids_with_metrics</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">active_labelled_ids_with_metrics</span><span class="p">:</span>
                    <span class="n">sample_data_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_ids_with_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sample_data</span> <span class="o">=</span> <span class="n">active_labelled_ids_with_metrics</span><span class="p">[</span><span class="n">sample_data_key</span><span class="p">]</span>
                    <span class="n">sample_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">sample_data_key</span><span class="p">:</span> <span class="n">sample_data</span><span class="p">}</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: metrics_manager :: active_labelled_ids_with_metrics sample: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample_dict</span><span class="p">))</span>

                <span class="n">roombaed_redistimeseries_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">roombaed_redistimeseries_metrics</span> <span class="o">=</span> <span class="n">redistimeseries_roomba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_labelled_ids_with_metrics</span><span class="p">,</span> <span class="n">ids_with_labelled_metric_names</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: redistimeseries_roomba failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: ran redistimeseries_roomba and </span><span class="si">%s</span><span class="s1"> labelled_metrics were removed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roombaed_redistimeseries_metrics</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">roombaed_redistimeseries_metrics</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">del</span> <span class="n">ids_with_labelled_metric_names</span>
                <span class="k">del</span> <span class="n">active_labelled_ids_with_metrics</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after redistimeseries_roomba management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20220727 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Prune the skyline.expose.prometheus.metrics</span>
                <span class="k">if</span> <span class="n">EXPOSE_PROMETHEUS_METRICS</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pruned_count</span> <span class="o">=</span> <span class="n">prune_expose_prometheus_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: prune_expose_prometheus_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: </span><span class="si">%s</span><span class="s1"> keys older than 5 minutes were pruned from skyline.expose.prometheus.metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">pruned_count</span><span class="p">)))</span>

                <span class="c1"># @added 20221125 - Feature #4734: mirage_vortex</span>
                <span class="c1"># Prune the mirage.vortex and flux.vortex hash keys</span>
                <span class="k">if</span> <span class="n">VORTEX_ENABLED</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: purging any old keys in vortex hash keys&#39;</span><span class="p">)</span>
                    <span class="n">c_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">vortex_purge_times</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flux.vortex&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;mirage.vortex&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">vortex_hash_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;flux.vortex&#39;</span><span class="p">,</span> <span class="s1">&#39;mirage.vortex&#39;</span><span class="p">]:</span>
                        <span class="n">vortex_keys</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">vortex_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hkeys</span><span class="p">(</span><span class="n">vortex_hash_key</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hkeys on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">vortex_hash_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                        <span class="n">v_errors</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">remove_v_keys</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">v_key</span> <span class="ow">in</span> <span class="n">vortex_keys</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">v_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">v_errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">v_key</span><span class="p">,</span> <span class="s1">&#39;failed to determine timestamp&#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">])</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">c_time</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">v_ts</span> <span class="o">+</span> <span class="n">vortex_purge_times</span><span class="p">[</span><span class="n">vortex_hash_key</span><span class="p">]):</span>
                                <span class="n">remove_v_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_key</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">remove_v_keys</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: metrics_manager :: purging </span><span class="si">%s</span><span class="s1"> keys from </span><span class="si">%s</span><span class="s1"> older than </span><span class="si">% s</span><span class="s1">econds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_v_keys</span><span class="p">)),</span> <span class="n">vortex_hash_key</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">vortex_purge_times</span><span class="p">[</span><span class="n">vortex_hash_key</span><span class="p">])))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">vortex_hash_key</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_v_keys</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to hdel keys from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">vortex_hash_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                    <span class="c1"># @added 20221130 - Feature #4734: mirage_vortex</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">vortex_saved_data_purged_count</span> <span class="o">=</span> <span class="n">purge_vortex_saved_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">VORTEX_SAVE_RESULTS_FOR</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_DIR</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: purge_vortex_saved_data failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

                <span class="c1"># @added 20211012 - Feature #4280: aet.metrics_manager.derivative_metrics Redis hash</span>
                <span class="n">current_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;derivative_metrics&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to get derivative_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20220323 - Feature #4502: settings - MONOTONIC_METRIC_NAMESPACES</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determining what metrics match metric namespaces declared as monotonic&#39;</span><span class="p">)</span>
                <span class="n">settings_monotonic_metric_namespaces</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">settings_monotonic_metric_namespaces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MONOTONIC_METRIC_NAMESPACES</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">settings_monotonic_metric_namespaces</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to determine settings.MONOTONIC_METRIC_NAMESPACES - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="n">settings_monotonic_metric_namespaces</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">external_settings</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">config_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">external_settings</span><span class="p">):</span>
                        <span class="n">external_settings_monotonic_namespaces</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">namespace</span> <span class="o">=</span> <span class="n">external_settings</span><span class="p">[</span><span class="n">config_id</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span>
                            <span class="n">external_settings_monotonic_namespaces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">external_settings</span><span class="p">[</span><span class="n">config_id</span><span class="p">][</span><span class="s1">&#39;monotonic_namespaces&#39;</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: determining monotonic_metric_namespaces from external_setting - </span><span class="si">%s</span><span class="s1">, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">config_id</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">external_settings_monotonic_namespaces</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">external_settings_monotonic_namespace</span> <span class="ow">in</span> <span class="n">external_settings_monotonic_namespaces</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">monotonic_namespace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">external_settings_monotonic_namespace</span><span class="p">)</span>
                                    <span class="n">settings_monotonic_metric_namespaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">monotonic_namespace</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> to settings_monotonic_metric_namespaces - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">external_settings_monotonic_namespace</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">always_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">always_derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;metrics_manager.always_derivative_metrics&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to get metrics_manager.always_derivative_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">non_derivative_monotonic_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">NON_DERIVATIVE_MONOTONIC_METRICS</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">non_derivative_monotonic_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># If a metric is prune out of unique_metrics by roomba remove to from</span>
                <span class="c1"># the always_derivative_metrics set as well</span>
                <span class="n">remove_from_always_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">always_derivative_metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                        <span class="n">remove_from_always_derivative_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">non_derivative_monotonic_metrics</span><span class="p">:</span>
                        <span class="n">remove_from_always_derivative_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remove_from_always_derivative_metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;metrics_manager.always_derivative_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_from_always_derivative_metrics</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to remove metrics from metrics_manager.always_derivative_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">remove_from_always_derivative_metrics</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">always_derivative_metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">non_derivative_monotonic_metrics</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">current_derivative_metrics</span><span class="p">:</span>
                            <span class="n">current_derivative_metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">current_derivative_metrics</span><span class="p">:</span>
                        <span class="n">always_derivative_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">always_derivative_metrics</span><span class="p">:</span>
                        <span class="n">current_derivative_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="s1">&#39;analyzer&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">settings_monotonic_metric_namespaces</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                        <span class="n">current_derivative_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                        <span class="n">always_derivative_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                <span class="n">always_derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">always_derivative_metrics</span><span class="p">))</span>

                <span class="c1"># @modified 20230201 - Feature #4792: functions.metrics_manager.manage_inactive_metrics</span>
                <span class="c1"># Only run if there are always_derivative_metrics</span>
                <span class="k">if</span> <span class="n">always_derivative_metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;metrics_manager.always_derivative_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">always_derivative_metrics</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to set metrics_manager.always_derivative_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">current_derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">current_derivative_metrics</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: determined </span><span class="si">%s</span><span class="s1"> metrics which match namespaces declared as monotonic&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">always_derivative_metrics</span><span class="p">)))</span>

                <span class="n">add_derivative_metrics</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">derivative_metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">derivative_metric</span> <span class="ow">in</span> <span class="n">current_derivative_metrics</span><span class="p">:</span>
                    <span class="n">add_derivative_metrics</span><span class="p">[</span><span class="n">derivative_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">derivative_metric_timestamp</span>
                <span class="k">if</span> <span class="n">add_derivative_metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics.timestamps&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">add_derivative_metrics</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: set </span><span class="si">%s</span><span class="s1"> namespaces in aet.metrics_manager.derivative_metrics.timestamps Redis hash&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">add_derivative_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to create aet.metrics_manager.derivative_metrics.timestamps Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">aet_metrics_manager_derivative_metrics_timestamps</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">aet_metrics_manager_derivative_metrics_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics.timestamps&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: got aet.metrics_manager.derivative_metrics.timestamps from Redis to check derivative_metric timestamps&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to hgetall aet.metrics_manager.derivative_metrics.timestamps to check derivative_metric timestamps - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">derivative_metrics_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">new_current_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">remove_derivative_metric_older_than</span> <span class="o">=</span> <span class="n">derivative_metric_timestamp</span> <span class="o">-</span> <span class="mi">3600</span>
                <span class="k">if</span> <span class="n">aet_metrics_manager_derivative_metrics_timestamps</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">derivative_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">aet_metrics_manager_derivative_metrics_timestamps</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

                        <span class="c1"># @added 20220225 - Feature #4468: flux - remove_namespace_quota_metrics</span>
                        <span class="c1">#                   Feature #4464: flux - quota - cluster_sync</span>
                        <span class="k">if</span> <span class="s1">&#39;skyline_set_as_of_&#39;</span> <span class="ow">in</span> <span class="n">derivative_metric</span><span class="p">:</span>
                            <span class="n">derivative_metrics_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">derivative_metric</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">derivative_metric_last_updated</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">aet_metrics_manager_derivative_metrics_timestamps</span><span class="p">[</span><span class="n">derivative_metric</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="n">derivative_metric_last_updated</span> <span class="o">&lt;</span> <span class="n">remove_derivative_metric_older_than</span><span class="p">:</span>
                                <span class="n">derivative_metrics_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">derivative_metric</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">new_current_derivative_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">derivative_metric</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to determine derivative_metric_last_updated - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">derivative_metrics_to_remove</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: not removing any metrics from aet.metrics_manager.derivative_metrics.timestamps Redis hash as all have been updated in last hour&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">derivative_metrics_to_remove</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing </span><span class="si">%s</span><span class="s1"> metrics from aet.metrics_manager.derivative_metrics.timestamps Redis hash as older than 1 hour&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">derivative_metrics_to_remove</span><span class="p">)))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics.timestamps&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">derivative_metrics_to_remove</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to remove </span><span class="si">%s</span><span class="s1"> metrics from the Redis hash key aet.metrics_manager.derivative_metrics.timestamps - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">derivative_metrics_to_remove</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: removing </span><span class="si">%s</span><span class="s1"> metrics from aet.metrics_manager.derivative_metrics Redis set as older than 1 hour&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">derivative_metrics_to_remove</span><span class="p">)))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">derivative_metrics_to_remove</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to remove </span><span class="si">%s</span><span class="s1"> metrics from the Redis hash key aet.metrics_manager.derivative_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">derivative_metrics_to_remove</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">new_current_derivative_metrics</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: adding </span><span class="si">%s</span><span class="s1"> metrics to aet.metrics_manager.derivative_metrics Redis set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_current_derivative_metrics</span><span class="p">)))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">new_current_derivative_metrics</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to add multiple members to the aet.metrics_manager.derivative_metrics Redis set&#39;</span><span class="p">)</span>

                <span class="c1"># @added 20230519 - Feature #3336: webapp api - derivative_metrics</span>
                <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># To handle labelled_metrics, allow for the request to pass a metric</span>
                <span class="c1"># to determine if it is a derivative_metric or not</span>
                <span class="k">if</span> <span class="n">derivative_labelled_metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;metrics_manager.derivative_labelled_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">derivative_labelled_metrics</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;metrics_manager.derivative_labelled_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.metrics_manager.derivative_labelled_metrics&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: created aet.metrics_manager.derivative_labelled_metrics with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">derivative_labelled_metrics</span><span class="p">))))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: failed to create and then rename metrics_manager.derivative_labelled_metrics Redis set to aet.metrics_manager.derivative_labelled_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after derivative management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20210624 - Feature #4150: metrics_manager - roomba batch processing metrics</span>
                <span class="c1">#                   Feature #3650: ROOMBA_DO_NOT_PROCESS_BATCH_METRICS</span>
                <span class="c1">#                   Feature #3480: batch_processing</span>
                <span class="c1"># When there are batch processing metrics and ROOMBA_DO_NOT_PROCESS_BATCH_METRICS</span>
                <span class="c1"># is enabled analyzer_batch only roombas metrics when they are received.</span>
                <span class="c1"># If batch metrics stop, they never get roomba&#39;ed again and will remain</span>
                <span class="c1"># in Redis and never get purged.</span>
                <span class="c1"># Once an hour make metrics_manager just remove any batch processing</span>
                <span class="c1"># metrics that are older than FULL_DURATION + (FULL_DURATION / 2)</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">BATCH_PROCESSING</span><span class="p">:</span>
                    <span class="n">inactive_batch_metrics_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span> <span class="o">+</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">roomba_cleaned</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">roomba_cache_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics_manager.roomba.batch_metrics&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">roomba_cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">roomba_cache_key</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">roomba_cleaned</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: roomba batch_processing_metrics Redis key </span><span class="si">%s</span><span class="s1"> exists, nothing to do&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">roomba_cache_key</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: roomba batch_processing_metrics failed to get Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">roomba_cache_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">batch_processing_base_names</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">roomba_cleaned</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">batch_processing_base_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.batch_processing_metrics&#39;</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: roomba batch_processing_metrics failed to get Redis set aet.analyzer.batch_processing_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">e</span><span class="p">))</span>
                    <span class="n">batch_processing_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">batch_processing_base_names</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">batch_processing_base_names</span><span class="p">:</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                            <span class="n">batch_processing_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                    <span class="n">raw_assigned</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">batch_processing_metrics</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: roomba checking </span><span class="si">%s</span><span class="s1"> batch_processing_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_processing_metrics</span><span class="p">))))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">raw_assigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">mget</span><span class="p">(</span><span class="n">batch_processing_metrics</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: roomba batch_processing_metrics failed to get raw_assigned from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">roomba_removed</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">raw_assigned</span><span class="p">:</span>
                        <span class="c1"># Distill timeseries strings into lists</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_processing_metrics</span><span class="p">):</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">raw_series</span> <span class="o">=</span> <span class="n">raw_assigned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">raw_series</span><span class="p">)</span>
                                <span class="n">timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpacker</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: metrics_manager :: roomba batch_processing_metrics failed to unpack </span><span class="si">%s</span><span class="s1"> timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                                <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="c1"># To ensure that there are no unordered timestamps in the time</span>
                            <span class="c1"># series which are artefacts of the collector or carbon-relay, sort</span>
                            <span class="c1"># all time series by timestamp before analysis.</span>
                            <span class="n">original_timeseries</span> <span class="o">=</span> <span class="n">timeseries</span>
                            <span class="k">if</span> <span class="n">original_timeseries</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">sort_timeseries</span><span class="p">(</span><span class="n">original_timeseries</span><span class="p">)</span>
                                    <span class="k">del</span> <span class="n">original_timeseries</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: roomba batch_processing_metrics failed to determine whther to remove </span><span class="si">%s</span><span class="s1"> timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">metric_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                            <span class="n">remove_timeseries</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">timeseries</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">last_timeseries_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="n">last_timeseries_timestamp</span> <span class="o">&lt;</span> <span class="n">inactive_batch_metrics_timestamp</span><span class="p">:</span>
                                        <span class="n">remove_timeseries</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: roomba batch_processing_metrics failed to determine whther to remove </span><span class="si">%s</span><span class="s1"> timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">metric_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">remove_timeseries</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: roomba removed batch processing metric </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                                    <span class="n">roomba_removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: roomba falied to remove batch processing metric </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">metric_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                                <span class="c1"># TODO - set inactive</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">roomba_cleaned</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">roomba_cache_key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">roomba_removed</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to set Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">roomba_cache_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage after batch_processing management - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

                <span class="c1"># @added 20220128 - Feature #4404: flux - external_settings - aggregation</span>
                <span class="c1">#                   Feature #4324: flux - reload external_settings</span>
                <span class="c1">#                   Feature #4376: webapp - update_external_settings</span>
                <span class="k">if</span> <span class="n">do_reload_flux</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings.update.metrics_manager&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager ::: deleted skyline.external_settings.update.metrics_manager from Redis&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager ::: failed to delete skyline.external_settings.update.metrics_manager from Redis, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">flux_pid_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/flux.pid&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PID_PATH</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">flux_pid_file</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: initiating reload_flux&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">flux_pids</span> <span class="o">=</span> <span class="n">reload_flux</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">flux_pid_file</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">flux_pids</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: reload_flux reports </span><span class="si">%s</span><span class="s1"> flux pids&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_pids</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: reload_flux error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings.update.flux&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager ::: deleted skyline.external_settings.update.flux from Redis&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager ::: failed to delete skyline.external_settings.update.flux from Redis, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="n">spin_end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">spin_start</span>

                <span class="c1"># @added 20210619 - Feature #4148: analyzer.metrics_manager.resolutions</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                        <span class="s1">&#39;analyzer.metrics_manager.run_time&#39;</span><span class="p">,</span> <span class="n">spin_end</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not set Redis analyzer.metrics_manager.run_time: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">send_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.metrics_manager_run_time&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spin_end</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sent Graphite metric - </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spin_end</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not send send_graphite_metric </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">send_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spin_end</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: with memray failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process :: memory usage final - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process took </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="n">spin_end</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Metrics_Manager.run"><a class="viewcode-back" href="../../skyline.analyzer.html#analyzer.metrics_manager.Metrics_Manager.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - Called when the process intializes.</span>

<span class="sd">        - Determine if Redis is up</span>

<span class="sd">        - Spawn a process to manage metrics lists and Redis sets</span>

<span class="sd">        - Wait for the process to finish.</span>

<span class="sd">        - Log the details about the run to the skyline analyzer log.</span>

<span class="sd">        - Send skyline.analyzer.metrics_manager metrics to `GRAPHITE_HOST`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Log management to prevent overwriting</span>
        <span class="c1"># Allow the bin/&lt;skyline_app&gt;.d to manage the log</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">log_wait_for</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="k">while</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">log_wait_for</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">log_wait_for</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: starting </span><span class="si">%s</span><span class="s1"> metrics_manager&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>

        <span class="c1"># @added 20190417 - Feature #2950: Report defaulted settings to log</span>
        <span class="c1"># Added all the globally declared settings to enable reporting in the</span>
        <span class="c1"># log the state of each setting.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
            <span class="k">if</span> <span class="n">SERVER_METRIC_PATH</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: metrics_manager :: settings.SERVER_METRICS_NAME is not declared in settings.py, defaults to </span><span class="se">\&#39;\&#39;</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ANALYZER_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_ENABLED</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: ANALYZER_ENABLED is set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ANALYZER_ENABLED</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">ANALYZER_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;warning :: metrics_manager :: ANALYZER_ENABLED is not declared in settings.py, defaults to True - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="c1"># Make sure Redis is up</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager cannot connect to redis at socket path </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager cannot connect to get_redis_conn - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Report app up</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;analyzer.metrics_manager&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: could not update the Redis analyzer.metrics_manager key&#39;</span><span class="p">)</span>

            <span class="c1"># Discover unique metrics</span>
            <span class="n">unique_metrics_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">raw_unique_metrics_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="n">full_uniques</span><span class="p">)</span>
                <span class="n">unique_metrics_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw_unique_metrics_count</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager ::: could not get the count of </span><span class="si">%s</span><span class="s1"> from Redis&#39;</span> <span class="o">%</span> <span class="n">full_uniques</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">unique_metrics_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: no metrics in redis. try adding some - see README&#39;</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: memory usage at start of run - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

            <span class="c1"># Spawn processes</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_management_process</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
                <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: starting metric_management_process&#39;</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to spawn process&#39;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: memory usage after start of run - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

            <span class="c1"># Send wait signal to zombie processes</span>
            <span class="c1"># for p in pids:</span>
            <span class="c1">#     p.join()</span>
            <span class="c1"># Self monitor processes and terminate if any metric_management_process has run</span>
            <span class="c1"># for longer than 180 seconds - 20160512 @earthgecko</span>
            <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="c1"># TESTING p.join removal</span>
            <span class="c1"># while time() - p_starts &lt;= 1:</span>
            <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="n">RUN_EVERY</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                    <span class="c1"># Just to avoid hogging the CPU</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># All the processes are done, break now.</span>
                    <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: metric_management_process completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_to_run</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: timed out, killing metric_management_process process&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: killing metric_management_process process&#39;</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="c1"># p.join()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: killed metric_management_process process&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: stopping metric_management_process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())))</span>
                        <span class="c1"># p.join()</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to stop spawn process&#39;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: memory usage after end of run - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span><span class="o">.</span><span class="n">ru_maxrss</span><span class="p">)))</span>

            <span class="n">process_runtime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span>
            <span class="k">if</span> <span class="n">process_runtime</span> <span class="o">&lt;</span> <span class="n">RUN_EVERY</span><span class="p">:</span>
                <span class="n">sleep_for</span> <span class="o">=</span> <span class="p">(</span><span class="n">RUN_EVERY</span> <span class="o">-</span> <span class="n">process_runtime</span><span class="p">)</span>

                <span class="c1"># @added 20201213 - Feature #3890: metrics_manager - sync_cluster_files</span>
                <span class="c1"># If this is a clustered Skyline instance and SYNC_CLUSTER_FILES</span>
                <span class="c1"># is enabled run the sync_cluster_files process every minute</span>
                <span class="n">run_sync_cluster_files</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">SYNC_CLUSTER_FILES</span><span class="p">:</span>
                        <span class="n">run_sync_cluster_files</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">FAKE_CLUSTER_SYNC</span><span class="p">:</span>
                    <span class="n">run_sync_cluster_files</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: run_sync_cluster_files as FAKE_CLUSTER_SYNC&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: run_sync_cluster_files is set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_sync_cluster_files</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">run_sync_cluster_files</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: running sync_cluster_files&#39;</span><span class="p">)</span>
                    <span class="n">external_settings_updated</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sync_until</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="p">(</span><span class="n">sleep_for</span> <span class="o">-</span> <span class="mi">60</span><span class="p">)</span>
                        <span class="n">sync_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                        <span class="n">last_sync_cluster_time</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">while</span> <span class="n">sync_time</span> <span class="o">&lt;</span> <span class="n">sync_until</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">last_sync_cluster_time</span><span class="p">:</span>
                                <span class="n">check_sync_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                                <span class="n">sync_sleep_for</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">-</span> <span class="p">(</span><span class="n">check_sync_time</span> <span class="o">-</span> <span class="n">last_sync_cluster_time</span><span class="p">)</span>
                                <span class="c1"># @modified 20220224 - Feature #4464: flux - quota - cluster_sync</span>
                                <span class="c1"># ValueError: sleep length must be non-negative</span>
                                <span class="c1"># if sync_sleep_for:</span>
                                <span class="k">if</span> <span class="n">sync_sleep_for</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sleeping for </span><span class="si">%.2f</span><span class="s1"> seconds between sync_cluster_files runs&#39;</span> <span class="o">%</span> <span class="n">sync_sleep_for</span><span class="p">)</span>
                                    <span class="c1"># @modified 202200512 - Feature #4324: flux - reload external_settings</span>
                                    <span class="c1">#                    Feature #4376: webapp - update_external_settings</span>
                                    <span class="c1"># Break out of sync_cluster_files if reload_flux is</span>
                                    <span class="c1"># required</span>
                                    <span class="c1"># sleep(sync_sleep_for)</span>

                                    <span class="c1"># @added 202200512 - Feature #4324: flux - reload external_settings</span>
                                    <span class="c1">#                    Feature #4376: webapp - update_external_settings</span>
                                    <span class="c1"># Break out of sync_cluster_files if reload_flux is</span>
                                    <span class="c1"># required</span>
                                    <span class="n">sleep_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                                    <span class="n">update_error_logged</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">while</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sleep_start</span> <span class="o">+</span> <span class="n">sync_sleep_for</span><span class="p">):</span>
                                        <span class="n">external_settings_updated</span> <span class="o">=</span> <span class="kc">None</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">external_settings_updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings.update.metrics_manager&#39;</span><span class="p">)</span>
                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="ow">not</span> <span class="n">update_error_logged</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager ::: could not get skyline.external_settings.update.metrics_manager from Redis, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                                                <span class="n">external_settings_updated</span> <span class="o">=</span> <span class="kc">False</span>
                                                <span class="n">update_error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">if</span> <span class="n">external_settings_updated</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: breaking sleep as skyline.external_settings.update.metrics_manager Redis was found&#39;</span><span class="p">)</span>
                                            <span class="k">break</span>
                                        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">external_settings_updated</span><span class="p">:</span>
                                <span class="k">break</span>

                            <span class="n">last_sync_cluster_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="c1"># Spawn sync_cluster_files</span>
                            <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_cluster_files</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
                                <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                                <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: starting sync_cluster_files&#39;</span><span class="p">)</span>
                                <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                                <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to spawn sync_cluster_files process&#39;</span><span class="p">)</span>
                            <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                                    <span class="c1"># Just to avoid hogging the CPU</span>
                                    <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># All the processes are done, break now.</span>
                                    <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sync_cluster_files completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_to_run</span><span class="p">))</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: timed out, killing sync_cluster_files process&#39;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: killing sync_cluster_files process&#39;</span><span class="p">)</span>
                                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                                    <span class="c1"># p.join()</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: killed sync_cluster_files process&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: stopping sync_cluster_files - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())))</span>
                                        <span class="c1"># p.join()</span>
                                        <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to stop sync_cluster_files process&#39;</span><span class="p">)</span>
                            <span class="n">sync_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: sync_cluster_files spawning failed&#39;</span><span class="p">)</span>

                <span class="n">process_runtime_now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span>
                <span class="n">sleep_for</span> <span class="o">=</span> <span class="p">(</span><span class="n">RUN_EVERY</span> <span class="o">-</span> <span class="n">process_runtime_now</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: sleeping for </span><span class="si">%.2f</span><span class="s1"> seconds due to low run time...&#39;</span> <span class="o">%</span> <span class="n">sleep_for</span><span class="p">)</span>
                <span class="c1"># @modified 20220128 - Feature #4404: flux - external_settings - aggregation</span>
                <span class="c1">#                      Feature #4324: flux - reload external_settings</span>
                <span class="c1">#                      Feature #4376: webapp - update_external_settings</span>
                <span class="c1"># sleep(sleep_for)</span>
                <span class="n">sleep_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="n">update_error_logged</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sleep_start</span> <span class="o">+</span> <span class="n">sleep_for</span><span class="p">):</span>
                    <span class="n">external_settings_updated</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">external_settings_updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings.update.metrics_manager&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">update_error_logged</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager ::: could not get skyline.external_settings.update.metrics_manager from Redis, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                            <span class="n">external_settings_updated</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">update_error_logged</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">external_settings_updated</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics_manager :: breaking sleep as skyline.external_settings.update.metrics_manager Redis was found&#39;</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">sleep_for</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to del sleep_for&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">process_runtime</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metrics_manager :: failed to del process_runtime&#39;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>