<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>skyline_functions &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">skyline_functions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for skyline_functions</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Skyline functions</span>

<span class="sd">These are shared functions that are required in multiple modules.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="c1"># @added 20201012 - Feature #3780: skyline_functions - sanitise_graphite_url</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># @modified 20191025 - Task #3290: Handle urllib2 in py3</span>
<span class="c1">#                      Branch #3262: py3</span>
<span class="c1"># try:</span>
<span class="c1">#     import urllib2</span>
<span class="c1"># except ImportError:</span>
<span class="c1">#     import urllib.request</span>
<span class="c1">#     import urllib.error</span>

<span class="c1"># @added 20191114 - Bug #3266: py3 Redis binary objects not strings</span>
<span class="c1">#                   Branch #3262: py3</span>
<span class="c1"># Added a single functions to deal with Redis connection and the</span>
<span class="c1"># charset=&#39;utf-8&#39;, decode_responses=True arguments required in py3</span>
<span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">StrictRedis</span>

<span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
<span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">MetaData</span>

<span class="kn">import</span> <span class="nn">settings</span>

<span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
<span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">get_engine</span><span class="p">,</span> <span class="n">engine_disposal</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20190518 - Branch #3002: docker</span>
    <span class="c1"># from settings import GRAPHITE_HOST</span>
    <span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="n">CARBON_HOST</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># @modified 20190518 - Branch #3002: docker</span>
    <span class="c1"># GRAPHITE_HOST = &#39;&#39;</span>
    <span class="n">CARBON_HOST</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="n">CARBON_PORT</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">CARBON_PORT</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># @added 20191007 - Feature #3250: Allow Skyline to send metrics to another Carbon host</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="n">SKYLINE_METRICS_CARBON_HOST</span>
    <span class="n">skyline_metrics_carbon_host</span> <span class="o">=</span> <span class="n">SKYLINE_METRICS_CARBON_HOST</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">skyline_metrics_carbon_host</span> <span class="o">=</span> <span class="n">CARBON_HOST</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="n">SKYLINE_METRICS_CARBON_PORT</span>
    <span class="n">skyline_metrics_carbon_port</span> <span class="o">=</span> <span class="n">SKYLINE_METRICS_CARBON_PORT</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">skyline_metrics_carbon_port</span> <span class="o">=</span> <span class="n">CARBON_PORT</span>

<span class="c1"># @added 20200731 - Feature #3654: IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20200813 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">IONOSPHERE_HISTORICAL_DATA_FOLDER</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_HISTORICAL_DATA_FOLDER</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">IONOSPHERE_HISTORICAL_DATA_FOLDER</span> <span class="o">=</span> <span class="s1">&#39;/opt/skyline/ionosphere/historical_data&#39;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20220405 - Task #4514: Integrate opentelemetry</span>
<span class="c1">#                   Feature #4516: flux - opentelemetry traces</span>
<span class="n">OTEL_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">OTEL_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTEL_ENABLED</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="n">OTEL_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">OTEL_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">OTEL_ENABLED</span><span class="p">:</span>
    <span class="c1"># from opentelemetry import trace</span>
    <span class="kn">from</span> <span class="nn">opentelemetry.instrumentation.redis</span> <span class="kn">import</span> <span class="n">RedisInstrumentor</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">opentelemetry.instrumentation.pymemcache</span> <span class="kn">import</span> <span class="n">PymemcacheInstrumentor</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBUSER</span><span class="p">,</span>
          <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBUSERPASS</span><span class="p">,</span>
          <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBHOST</span><span class="p">,</span>
          <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBPORT</span><span class="p">,</span>
          <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DATABASE</span><span class="p">,</span>
          <span class="s1">&#39;raise_on_warnings&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>


<span class="c1"># @added 20191025 - Bug #3266: py3 Redis binary objects not strings</span>
<span class="c1">#                   Branch #3262: py3</span>
<span class="c1"># Added a single functions to deal with Redis connection and the</span>
<span class="c1"># charset=&#39;utf-8&#39;, decode_responses=True arguments required in py3</span>
<div class="viewcode-block" id="get_redis_conn"><a class="viewcode-back" href="../skyline.html#skyline_functions.get_redis_conn">[docs]</a><span class="k">def</span> <span class="nf">get_redis_conn</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a Redis connection</span>

<span class="sd">    :param current_skyline_app: the skyline app using this function</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :return: REDIS_CONN</span>
<span class="sd">    :rtype: object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="c1"># @added 20220405 - Task #4514: Integrate opentelemetry</span>
    <span class="c1">#                   Feature #4516: flux - opentelemetry traces</span>
    <span class="c1"># Instrument redis</span>
    <span class="c1"># @modified 20220505 - Task #4514: Integrate opentelemetry</span>
    <span class="c1"># Fail gracefully if opentelemetry breaks it breaks</span>
    <span class="c1"># if current_skyline_app == &#39;webapp&#39;:</span>
    <span class="k">if</span> <span class="n">current_skyline_app</span> <span class="o">==</span> <span class="s1">&#39;webapp&#39;</span> <span class="ow">and</span> <span class="n">OTEL_ENABLED</span><span class="p">:</span>

        <span class="c1"># @modified 20221102 - Bug #4714: opentelemetry check is_instrumented_by_opentelemetry</span>
        <span class="n">instrumented</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instrumented</span> <span class="o">=</span> <span class="n">RedisInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">is_instrumented_by_opentelemetry</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_redis_conn - RedisInstrumentor().is_instrumented_by_opentelemetry failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instrumented</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_redis_conn - starting RedisInstrumentor&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">RedisInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span>
                <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span>
                <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> - get_redis_conn failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">REDIS_CONN</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span>
                    <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> - get_redis_conn failed&#39;</span> <span class="o">%</span> <span class="n">current_skyline_app</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">REDIS_CONN</span></div>


<div class="viewcode-block" id="get_redis_conn_decoded"><a class="viewcode-back" href="../skyline.html#skyline_functions.get_redis_conn_decoded">[docs]</a><span class="k">def</span> <span class="nf">get_redis_conn_decoded</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a Redis connection with decoded responses, to read sets</span>

<span class="sd">    :param current_skyline_app: the skyline app using this function</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :return: REDIS_CONN_DECODED</span>
<span class="sd">    :rtype: object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">python_version</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="c1"># @added 20220405 - Task #4514: Integrate opentelemetry</span>
    <span class="c1">#                   Feature #4516: flux - opentelemetry traces</span>
    <span class="c1"># Instrument redis</span>
    <span class="c1"># @modified 20220505 - Task #4514: Integrate opentelemetry</span>
    <span class="c1"># Fail gracefully if opentelemetry breaks it breaks</span>
    <span class="c1"># if current_skyline_app == &#39;webapp&#39;:</span>
    <span class="k">if</span> <span class="n">current_skyline_app</span> <span class="o">==</span> <span class="s1">&#39;webapp&#39;</span> <span class="ow">and</span> <span class="n">OTEL_ENABLED</span><span class="p">:</span>
        <span class="c1"># @modified 20221102 - Bug #4714: opentelemetry check is_instrumented_by_opentelemetry</span>
        <span class="n">instrumented</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instrumented</span> <span class="o">=</span> <span class="n">RedisInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">is_instrumented_by_opentelemetry</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_redis_conn_decoded - RedisInstrumentor().is_instrumented_by_opentelemetry failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instrumented</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_redis_conn_decoded - starting RedisInstrumentor&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">RedisInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span>
                    <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span>
                    <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span>
                    <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span>
                    <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span>
                    <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> - get_redis_conn_decoded failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">REDIS_CONN_DECODED</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span>
                        <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span>
                        <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span>
                        <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span>
                        <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span>
                        <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span>
                        <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span>
                        <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> - get_redis_conn_decoded failed&#39;</span> <span class="o">%</span> <span class="n">current_skyline_app</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">REDIS_CONN_DECODED</span></div>


<div class="viewcode-block" id="send_graphite_metric"><a class="viewcode-back" href="../skyline.html#skyline_functions.send_graphite_metric">[docs]</a><span class="k">def</span> <span class="nf">send_graphite_metric</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sends the skyline_app metrics to the `GRAPHITE_HOST` if a graphite</span>
<span class="sd">    host is defined.</span>

<span class="sd">    :param current_skyline_app: the skyline app using this function</span>
<span class="sd">    :param metric: the metric namespace</span>
<span class="sd">    :param value: the metric value (as a str not an int)</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type metric: str</span>
<span class="sd">    :type value: str</span>
<span class="sd">    :return: ``True`` or ``False``</span>
<span class="sd">    :rtype: boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># @added 20190805 - Task #2828: Skyline - Python 3.7</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">python_version</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># @added 20190518 - Branch #3002: docker</span>
    <span class="c1"># If the CARBON_HOST is set to the default do not send_graphite_metric</span>
    <span class="c1"># @modified 20191007 - Feature #3250: Allow Skyline to send metrics to another Carbon host</span>
    <span class="c1"># if CARBON_HOST == &#39;YOUR_GRAPHITE_HOST.example.com&#39;:</span>
    <span class="k">if</span> <span class="n">skyline_metrics_carbon_host</span> <span class="o">==</span> <span class="s1">&#39;YOUR_GRAPHITE_HOST.example.com&#39;</span><span class="p">:</span>
        <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
        <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CARBON_HOST is not configured in settings.py no CARBON_HOST to send metrics to&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># @modified 20190518 - Branch #3002: docker</span>
    <span class="c1"># Use the CARBON_HOST rather than GRAPHITE_HOST to allow for the 2 to be</span>
    <span class="c1"># on different hosts</span>
    <span class="c1"># if GRAPHITE_HOST != &#39;&#39;:</span>
    <span class="c1"># @modified 20191007 - Feature #3250: Allow Skyline to send metrics to another Carbon host</span>
    <span class="c1"># if CARBON_HOST != &#39;&#39;:</span>
    <span class="k">if</span> <span class="n">skyline_metrics_carbon_host</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Handle connection error to Graphite #116 @etsy</span>
        <span class="c1"># Fixed as per https://github.com/etsy/skyline/pull/116 and</span>
        <span class="c1"># mlowicki:etsy_handle_connection_error_to_graphite</span>
        <span class="c1"># Handle connection error to Graphite #7 @ earthgecko</span>
        <span class="c1"># merged 1 commit into earthgecko:master from</span>
        <span class="c1"># mlowicki:handle_connection_error_to_graphite on 16 Mar 2015</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20190518 - Branch #3002: docker</span>
            <span class="c1"># sock.connect((GRAPHITE_HOST, CARBON_PORT))</span>
            <span class="c1"># @modified 20191007 - Feature #3250: Allow Skyline to send metrics to another Carbon host</span>
            <span class="c1"># sock.connect((CARBON_HOST, CARBON_PORT))</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">skyline_metrics_carbon_host</span><span class="p">,</span> <span class="n">skyline_metrics_carbon_port</span><span class="p">))</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># @modified 20190518 - Branch #3002: docker</span>
            <span class="c1"># endpoint = &#39;%s:%d&#39; % (GRAPHITE_HOST, CARBON_PORT)</span>
            <span class="c1"># @modified 20191007 - Feature #3250: Allow Skyline to send metrics to another Carbon host</span>
            <span class="c1"># endpoint = &#39;%s:%d&#39; % (CARBON_HOST, CARBON_PORT)</span>
            <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_metrics_carbon_host</span><span class="p">,</span> <span class="n">skyline_metrics_carbon_port</span><span class="p">)</span>
            <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
            <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: cannot connect to Graphite at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">endpoint</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># For the same reason as above</span>
        <span class="c1"># sock.sendall(&#39;%s %s %i\n&#39; % (name, value, time()))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20190805 - Task #2828: Skyline - Python 3.7</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">time</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">time</span><span class="p">())</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># @modified 20190518 - Branch #3002: docker</span>
            <span class="c1"># endpoint = &#39;%s:%d&#39; % (GRAPHITE_HOST, CARBON_PORT)</span>
            <span class="c1"># @modified 20191007 - Feature #3250: Allow Skyline to send metrics to another Carbon host</span>
            <span class="c1"># endpoint = &#39;%s:%d&#39; % (CARBON_HOST, CARBON_PORT)</span>
            <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_metrics_carbon_host</span><span class="p">,</span> <span class="n">skyline_metrics_carbon_port</span><span class="p">)</span>
            <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
            <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: could not send data to Graphite at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">endpoint</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="mkdir_p"><a class="viewcode-back" href="../skyline.html#skyline_functions.mkdir_p">[docs]</a><span class="k">def</span> <span class="nf">mkdir_p</span><span class="p">(</span><span class="n">make_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create nested directories.</span>

<span class="sd">    :param path: directory path to create</span>
<span class="sd">    :type path: str</span>
<span class="sd">    :return: returns True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># try:</span>
    <span class="c1">#     os.getpid()</span>
    <span class="c1"># except:</span>
    <span class="c1">#     import os</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">make_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o755</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># Python &gt;2.5</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">make_path</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span></div>


<span class="c1"># @added 20191023 - Task #3290: Handle urllib2 in py3</span>
<span class="c1">#                   Branch #3262: py3</span>
<span class="c1"># Use urlretrieve</span>
<div class="viewcode-block" id="get_graphite_graph_image"><a class="viewcode-back" href="../skyline.html#skyline_functions.get_graphite_graph_image">[docs]</a><span class="k">def</span> <span class="nf">get_graphite_graph_image</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches a Graphite graph image of a metric and saves the image to the</span>
<span class="sd">    specified file.</span>

<span class="sd">    :param current_skyline_app: the app calling the function so the function</span>
<span class="sd">        knows which log to write too.</span>
<span class="sd">    :param url: the graph URL</span>
<span class="sd">    :param image_file: the absolute path and file name to save the graph png image</span>
<span class="sd">        as.</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type url: str</span>
<span class="sd">    :type image_file: str</span>
<span class="sd">    :return: True</span>
<span class="sd">    :rtype:  boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: get_graphite_graph_image :: URL - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_file</span><span class="p">:</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: get_graphite_graph_image :: image_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">image_file</span><span class="p">))</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o755</span><span class="p">)</span>
        <span class="c1"># Python &gt;2.5</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_dir</span><span class="p">):</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: get_graphite_graph_image - could not create directory - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_dir</span><span class="p">)))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: get_graphite_graph_image :: saving </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">image_file</span><span class="p">)))</span>
        <span class="c1"># @modified 20200808 - Task #3608: Update Skyline to Python 3.8.3 and deps</span>
        <span class="c1"># Added nosec for bandit [B310:blacklist] Audit url open for</span>
        <span class="c1"># permitted schemes. Allowing use of file:/ or custom schemes is</span>
        <span class="c1"># often unexpected.</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">):</span>
            <span class="c1"># @modified 20210423 - Task #4030: refactoring</span>
            <span class="c1"># Use requests</span>
            <span class="c1"># urllib.request.urlretrieve(url, image_file)  # nosec</span>
            <span class="c1"># os.chmod(image_file, mode=0o644)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: get_graphite_graph_image - url does not start with http - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">)))</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: get_graphite_graph_image :: saved </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">image_file</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: get_graphite_graph_image :: failed to save </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">image_file</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_skyline_app</span> <span class="o">==</span> <span class="s1">&#39;webapp&#39;</span><span class="p">:</span>
            <span class="c1"># Raise to webbapp</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="load_metric_vars"><a class="viewcode-back" href="../skyline.html#skyline_functions.load_metric_vars">[docs]</a><span class="k">def</span> <span class="nf">load_metric_vars</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">metric_vars_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Import the metric variables for a check from a metric check variables file</span>

<span class="sd">    :param current_skyline_app: the skyline app using this function</span>
<span class="sd">    :param metric_vars_file: the path and filename to the metric variables files</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type metric_vars_file: str</span>
<span class="sd">    :return: the metric_vars module object or ``False``</span>
<span class="sd">    :rtype: object or boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">os</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">imp</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">imp</span>

    <span class="n">metric_vars</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">metric_vars_got</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">):</span>
        <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
        <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;loading metric variables from import - metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
        <span class="c1"># Bug #1460: panorama check file fails</span>
        <span class="c1"># global metric_vars</span>
        <span class="c1"># current_logger.info(&#39;set global metric_vars&#39;)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_vars</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_source</span><span class="p">(</span><span class="s1">&#39;metric_vars&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">metric_vars_got</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;failed to import metric variables - metric_check_file&#39;</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
                <span class="n">metric_vars</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span> <span class="ow">and</span> <span class="n">metric_vars_got</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;metric_vars determined - metric variable - metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars</span><span class="o">.</span><span class="n">metric</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: metric_vars_file not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">metric_vars</span></div>


<div class="viewcode-block" id="write_data_to_file"><a class="viewcode-back" href="../skyline.html#skyline_functions.write_data_to_file">[docs]</a><span class="k">def</span> <span class="nf">write_data_to_file</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">write_to_file</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write date to a file</span>

<span class="sd">    :param current_skyline_app: the skyline app using this function</span>
<span class="sd">    :param file: the path and filename to write the data into</span>
<span class="sd">    :param mode: ``w`` to overwrite, ``a`` to append</span>
<span class="sd">    :param data: the data to write to the file</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type file: str</span>
<span class="sd">    :type mode: str</span>
<span class="sd">    :type data: str</span>
<span class="sd">    :return: ``True`` or ``False``</span>
<span class="sd">    :rtype: boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">os</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">python_version</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">write_to_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o755</span><span class="p">)</span>
        <span class="c1"># Python &gt;2.5</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_dir</span><span class="p">):</span>
        <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
        <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;error :: could not create directory - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_dir</span><span class="p">)))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">write_to_file</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">write_to_file</span><span class="p">,</span> <span class="mo">0o644</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">write_to_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o644</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="fail_check"><a class="viewcode-back" href="../skyline.html#skyline_functions.fail_check">[docs]</a><span class="k">def</span> <span class="nf">fail_check</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">failed_check_dir</span><span class="p">,</span> <span class="n">check_file_to_fail</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Move a failed check file.</span>

<span class="sd">    :param current_skyline_app: the skyline app using this function</span>
<span class="sd">    :param failed_check_dir: the directory where failed checks are moved to</span>
<span class="sd">    :param check_file_to_fail: failed check file to move</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type failed_check_dir: str</span>
<span class="sd">    :type check_file_to_fail: str</span>
<span class="sd">    :return: ``True``, ``False``</span>
<span class="sd">    :rtype: boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">os</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">shutil</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">python_version</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">failed_check_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">failed_check_dir</span><span class="p">)</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;created failed_check_dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">failed_check_dir</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: failed to create failed_check_dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">failed_check_dir</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="n">check_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">check_file_to_fail</span><span class="p">))</span>
    <span class="n">failed_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">failed_check_dir</span><span class="p">,</span> <span class="n">check_file_name</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">check_file_to_fail</span><span class="p">,</span> <span class="n">failed_check_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">failed_check_file</span><span class="p">,</span> <span class="mo">0o644</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">failed_check_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o644</span><span class="p">)</span>

        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;moved check file to - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">failed_check_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;failed to move check file to -</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">failed_check_file</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># @modified 20220419 -</span>
<div class="viewcode-block" id="get_graphite_metric"><a class="viewcode-back" href="../skyline.html#skyline_functions.get_graphite_metric">[docs]</a><span class="k">def</span> <span class="nf">get_graphite_metric</span><span class="p">(</span>
    <span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span>
        <span class="n">output_object</span><span class="p">,</span> <span class="n">check_for_derivative</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch data from graphite and return it as object or save it as file</span>

<span class="sd">    :param current_skyline_app: the skyline app using this function</span>
<span class="sd">    :param metric: metric name</span>
<span class="sd">    :param from_timestamp: unix timestamp</span>
<span class="sd">    :param until_timestamp: unix timestamp</span>
<span class="sd">    :param data_type: image, json or list</span>
<span class="sd">    :param output_object: object or path and filename to save data as, if set to</span>
<span class="sd">                          object, the object is returned</span>
<span class="sd">    :param check_for_derivative: check if the metric is a derivative and apply</span>
<span class="sd">        the nonNegativeDerivative Graphite function if it is</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type metric: str</span>
<span class="sd">    :type from_timestamp: str</span>
<span class="sd">    :type until_timestamp: str</span>
<span class="sd">    :type data_type: str</span>
<span class="sd">    :type output_object: str</span>
<span class="sd">    :type check_for_derivative: boolean</span>
<span class="sd">    :return: timeseries string, ``True``, ``False``</span>
<span class="sd">    :rtype: str or boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">os</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">python_version</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">quote</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">requests.utils</span> <span class="kn">import</span> <span class="n">quote</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">time</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">re</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">re</span>

    <span class="c1"># @added 20220406 - Feature #4518: settings - LAST_KNOWN_VALUE_NAMESPACES</span>
    <span class="c1">#                   Feature #4520: settings - ZERO_FILL_NAMESPACES</span>
    <span class="c1"># These cannot be added in the top level import as that results in a circular</span>
    <span class="c1"># import error and nothing will start</span>
    <span class="c1"># ImportError: cannot import name &#39;get_redis_conn_decoded&#39; from partially initialized module &#39;skyline_functions&#39; (most likely due to a circular import)</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.last_known_value_metrics_list</span> <span class="kn">import</span> <span class="n">last_known_value_metrics_list</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.zero_fill_metrics_list</span> <span class="kn">import</span> <span class="n">zero_fill_metrics_list</span>

    <span class="c1"># @added 20191025 - Task #3290: Handle urllib2 in py3</span>
    <span class="c1">#                   Branch #3262: py3</span>
<span class="c1">#    try:</span>
<span class="c1">#        urllib.urlretrieve</span>
<span class="c1">#    except:</span>
<span class="c1">#        try:</span>
<span class="c1">#            import urllib as urllib</span>
<span class="c1">#        except:</span>
<span class="c1">#            import urllib.request</span>
<span class="c1">#            import urllib.error</span>

    <span class="c1"># @aded 20210309 - Feature #3978: luminosity - classify_metrics</span>
    <span class="c1">#                  Feature #3642: Anomaly type classification</span>
    <span class="c1"># Do not log luminosity classify_metrics calls unless error</span>
    <span class="n">write_to_log</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">current_skyline_app</span> <span class="o">==</span> <span class="s1">&#39;luminosity&#39;</span> <span class="ow">and</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;list&#39;</span> <span class="ow">and</span> <span class="n">output_object</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
        <span class="n">write_to_log</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

<span class="c1">#    if settings.ENABLE_DEBUG:</span>
    <span class="k">if</span> <span class="n">write_to_log</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_graphite_metric :: graphite_metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>

    <span class="c1"># @added 20160803 - Unescaped Graphite target - https://github.com/earthgecko/skyline/issues/20</span>
    <span class="c1">#                   bug1546: Unescaped Graphite target</span>
    <span class="c1"># @modified 20191029 - Branch #3263: py3</span>
    <span class="c1"># Commented out colon</span>
    <span class="c1"># new_metric_namespace = metric.replace(&#39;:&#39;, &#39;\:&#39;)</span>
    <span class="c1"># metric_namespace = new_metric_namespace.replace(&#39;(&#39;, &#39;\(&#39;)</span>
    <span class="n">metric_namespace</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">(&#39;</span><span class="p">)</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">metric_namespace</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="c1"># Graphite timeouts</span>
    <span class="n">connect_timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_CONNECT_TIMEOUT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: get_graphite_metric :: connect_timeout - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">connect_timeout</span><span class="p">))</span>

    <span class="n">read_timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_READ_TIMEOUT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: get_graphite_metric :: read_timeout - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">read_timeout</span><span class="p">))</span>

    <span class="n">graphite_from</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">write_to_log</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_graphite_metric :: graphite_from - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_from</span><span class="p">))</span>

    <span class="n">graphite_until</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">write_to_log</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_graphite_metric :: graphite_until - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_until</span><span class="p">))</span>

    <span class="n">output_format</span> <span class="o">=</span> <span class="n">data_type</span>

    <span class="c1"># @modified 20170603 - Feature #2034: analyse_derivatives</span>
    <span class="c1"># Added deriative functions to convert the values of metrics strictly</span>
    <span class="c1"># increasing monotonically to their deriative products in Graphite now</span>
    <span class="c1"># graphs</span>
    <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_graphite_metric - failed to get_redis_conn_decoded&#39;</span><span class="p">)</span>

<span class="c1">#    try:</span>
<span class="c1">#        # @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1">#        if settings.REDIS_PASSWORD:</span>
<span class="c1">#            REDIS_CONN = StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1">#        else:</span>
<span class="c1">#            REDIS_CONN = StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1">#    except:</span>
<span class="c1">#        from redis import StrictRedis</span>
<span class="c1">#    if not REDIS_CONN:</span>
<span class="c1">#        try:</span>
<span class="c1">#            # @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1">#            if settings.REDIS_PASSWORD:</span>
<span class="c1">#                REDIS_CONN = StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1">#            else:</span>
<span class="c1">#                REDIS_CONN = StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1">#        except:</span>
<span class="c1">#            current_logger.error(&#39;error :: %s - redis connection failed&#39; % current_skyline_app)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20211012 - Feature #4280: aet.metrics_manager.derivative_metrics Redis hash</span>
        <span class="c1"># derivative_metrics = list(REDIS_CONN_DECODED.smembers(&#39;derivative_metrics&#39;))</span>
        <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>

    <span class="c1"># @added 20180423 - Feature #2034: analyse_derivatives</span>
    <span class="c1">#                   Branch #2270: luminosity</span>
    <span class="n">metric_found_in_redis</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">derivative_metrics</span><span class="p">:</span>
        <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">metric_found_in_redis</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;non_derivative_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">non_derivative_metrics</span><span class="p">:</span>
            <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">metric_found_in_redis</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># @added 20180423 - Feature #2034: analyse_derivatives</span>
    <span class="c1">#                   Branch #2270: luminosity</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found_in_redis</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
        <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># for redis_ip, redis_port in settings.OTHER_SKYLINE_REDIS_INSTANCES:</span>
        <span class="k">for</span> <span class="n">redis_ip</span><span class="p">,</span> <span class="n">redis_port</span><span class="p">,</span> <span class="n">redis_password</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found_in_redis</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
                        <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_password</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">))</span>
                    <span class="n">other_derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">other_redis_conn</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;derivative_metrics&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_graphite_metric :: failed to connect to Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">other_derivative_metrics</span><span class="p">:</span>
                    <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">metric_found_in_redis</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">write_to_log</span><span class="p">:</span>
                        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_graphite_metric :: </span><span class="si">%s</span><span class="s1"> found in derivative_metrics in Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>

    <span class="n">target_metric</span> <span class="o">=</span> <span class="n">metric</span>

    <span class="c1"># @added 20220419 - Feature #4528: metrics_manager - derivative_metric_check</span>
    <span class="c1">#                   Feature #3866: MIRAGE_ENABLE_HIGH_RESOLUTION_ANALYSIS</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_for_derivative</span><span class="p">:</span>
        <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
        <span class="n">target_metric</span> <span class="o">=</span> <span class="s1">&#39;nonNegativeDerivative(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

    <span class="c1"># @added 20220406 - Feature #4518: settings - LAST_KNOWN_VALUE_NAMESPACES</span>
    <span class="c1">#                   Feature #4520: settings - ZERO_FILL_NAMESPACES</span>
    <span class="n">last_known_value_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">last_known_value_metrics</span> <span class="o">=</span> <span class="n">last_known_value_metrics_list</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_graphite_metric :: last_known_value_metrics_list failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
    <span class="n">zero_fill_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">zero_fill_metrics</span> <span class="o">=</span> <span class="n">zero_fill_metrics_list</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_graphite_metric :: zero_fill_metrics_list failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
    <span class="c1"># Do not zero fill derivative metrics, if the use has defined a metric as a</span>
    <span class="c1"># zero fill metric and it is a derivative metric do not break the metric</span>
    <span class="c1"># by applying zero filling, rather correct it and apply last_known_value</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">zero_fill_metrics</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
            <span class="n">target_metric</span> <span class="o">=</span> <span class="s1">&#39;transformNull(</span><span class="si">%s</span><span class="s1">,0)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_metric</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fix the badly defined metric</span>
            <span class="n">target_metric</span> <span class="o">=</span> <span class="s1">&#39;keepLastValue(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_metric</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">last_known_value_metrics</span><span class="p">:</span>
        <span class="n">target_metric</span> <span class="o">=</span> <span class="s1">&#39;keepLastValue(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_metric</span><span class="p">)</span>

    <span class="c1"># graphite URL</span>
    <span class="n">graphite_port</span> <span class="o">=</span> <span class="s1">&#39;80&#39;</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">graphite_port</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span><span class="p">)</span>
    <span class="c1"># @added 20191002 - Branch #3002: docker</span>
    <span class="c1"># Unset the graphite_port if normal https</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span> <span class="o">==</span> <span class="s1">&#39;443&#39;</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span> <span class="o">==</span> <span class="s1">&#39;https&#39;</span><span class="p">:</span>
        <span class="n">graphite_port</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># @modified 20190520 - Branch #3002: docker</span>
    <span class="c1"># image_url = settings.GRAPHITE_PROTOCOL + &#39;://&#39; + settings.GRAPHITE_HOST + &#39;:&#39; + graphite_port + &#39;/render?from=&#39; + graphite_from + &#39;&amp;until=&#39; + graphite_until + &#39;&amp;target=&#39; + target_metric</span>
    <span class="c1"># image_url = settings.GRAPHITE_PROTOCOL + &#39;://&#39; + settings.GRAPHITE_HOST + &#39;:&#39; + graphite_port + &#39;/api/datasources/proxy/1/render/?from=&#39; + graphite_from + &#39;&amp;until=&#39; + graphite_until + &#39;&amp;target=&#39; + target_metric</span>
    <span class="n">image_url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">graphite_port</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_RENDER_URI</span> <span class="o">+</span> <span class="s1">&#39;?from=&#39;</span> <span class="o">+</span> <span class="n">graphite_from</span> <span class="o">+</span> <span class="s1">&#39;&amp;until=&#39;</span> <span class="o">+</span> <span class="n">graphite_until</span> <span class="o">+</span> <span class="s1">&#39;&amp;target=&#39;</span> <span class="o">+</span> <span class="n">target_metric</span>

    <span class="c1"># @modified 20201125 - Feature #3850: webapp - yhat_values API endoint</span>
    <span class="c1"># Added list as data_type</span>
    <span class="c1"># if data_type == &#39;json&#39;:</span>
    <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">]:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">image_url</span> <span class="o">+</span> <span class="s1">&#39;&amp;format=json&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">image_url</span> <span class="o">+</span> <span class="s1">&#39;&amp;format=&#39;</span> <span class="o">+</span> <span class="n">output_format</span>

    <span class="k">if</span> <span class="n">write_to_log</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_graphite_metric :: graphite url - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">))</span>

    <span class="n">get_image</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span> <span class="ow">and</span> <span class="n">output_object</span> <span class="o">!=</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">output_object</span><span class="p">):</span>
            <span class="n">get_image</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: get_graphite_metric :: graph file exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_object</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">get_image</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">write_to_log</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;get_graphite_metric :: retrieving png - surfacing </span><span class="si">%s</span><span class="s1"> graph from graphite from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_from</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_until</span><span class="p">)))</span>

        <span class="n">graphite_image_file</span> <span class="o">=</span> <span class="n">output_object</span>
        <span class="k">if</span> <span class="s1">&#39;width&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">image_url</span><span class="p">:</span>
            <span class="n">image_url</span> <span class="o">+=</span> <span class="s1">&#39;&amp;width=586&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;height&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">image_url</span><span class="p">:</span>
            <span class="n">image_url</span> <span class="o">+=</span> <span class="s1">&#39;&amp;height=308&#39;</span>
        <span class="c1"># @added 20170106 - Feature #1842: Ionosphere - Graphite now graphs</span>
        <span class="c1"># settings, color and title</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;webapp&#39;</span><span class="p">:</span>
            <span class="n">get_ionosphere_graphs</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;graphite_now&#39;</span> <span class="ow">in</span> <span class="n">output_object</span><span class="p">:</span>
                <span class="n">get_ionosphere_graphs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># @added 20170107 - Feature #1852: Ionosphere - features_profile matched graphite graphs</span>
            <span class="c1"># Added graphite_matched_images matched.fp_id</span>
            <span class="k">if</span> <span class="s1">&#39;matched.fp_id&#39;</span> <span class="ow">in</span> <span class="n">output_object</span><span class="p">:</span>
                <span class="n">get_ionosphere_graphs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># @added 20170308 - Feature #1960: ionosphere_layers</span>
            <span class="c1"># Added graphite_layers_matched_images matched.layer</span>
            <span class="k">if</span> <span class="s1">&#39;matched.layers.fp_id&#39;</span> <span class="ow">in</span> <span class="n">output_object</span><span class="p">:</span>
                <span class="n">get_ionosphere_graphs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">get_ionosphere_graphs</span><span class="p">:</span>
                <span class="n">int_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">))</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;graphite_now&#39;</span> <span class="ow">in</span> <span class="n">output_object</span><span class="p">:</span>
                    <span class="n">no_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_object</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_hours</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">no_extension</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">hours</span> <span class="o">=</span> <span class="n">_hours</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">int_hours</span> <span class="o">=</span> <span class="n">hours</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">str_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">int_hours</span><span class="p">)</span>
                <span class="n">period</span> <span class="o">=</span> <span class="s1">&#39;hours&#39;</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">int_hours</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
                    <span class="n">str_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">int_hours</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>
                    <span class="n">period</span> <span class="o">=</span> <span class="s1">&#39;days&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;graphite_now&#39;</span> <span class="ow">in</span> <span class="n">output_object</span><span class="p">:</span>
                    <span class="c1"># @added 20200731 - Feature #3654: IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span>
                    <span class="k">if</span> <span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span><span class="p">:</span>
                        <span class="n">unencoded_graph_title</span> <span class="o">=</span> <span class="s1">&#39;Graphite THEN at </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">str_value</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">unencoded_graph_title</span> <span class="o">=</span> <span class="s1">&#39;Graphite NOW at </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">str_value</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
                <span class="c1"># @added 20170308 - Feature #1960: ionosphere_layers</span>
                <span class="n">matched_graph</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="s1">&#39;matched.fp_id&#39;</span> <span class="ow">in</span> <span class="n">output_object</span><span class="p">:</span>
                    <span class="n">matched_graph</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;matched.layers.fp_id&#39;</span> <span class="ow">in</span> <span class="n">output_object</span><span class="p">:</span>
                    <span class="n">matched_graph</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># @modified 20170308 - Feature #1960: ionosphere_layers</span>
                <span class="c1"># if &#39;matched.fp_id&#39; in output_object:</span>
                <span class="k">if</span> <span class="n">matched_graph</span><span class="p">:</span>
                    <span class="n">human_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S %Z&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="s1">&#39;matched.fp_id&#39;</span> <span class="ow">in</span> <span class="n">output_object</span><span class="p">:</span>
                        <span class="n">tail_piece</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;.*\.fp_id-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_object</span><span class="p">)</span>
                        <span class="n">matched_fp_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;\..*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tail_piece</span><span class="p">)</span>
                        <span class="n">unencoded_graph_title</span> <span class="o">=</span> <span class="s1">&#39;fp_id </span><span class="si">%s</span><span class="s1"> matched - </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> hours&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">matched_fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">human_date</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">int_hours</span><span class="p">))</span>
                        <span class="c1"># @added 20210421 - Feature #4014: Ionosphere - inference</span>
                        <span class="c1"># Add motif_id to Graph title</span>
                        <span class="k">if</span> <span class="s1">&#39;motif_id-&#39;</span> <span class="ow">in</span> <span class="n">output_object</span><span class="p">:</span>
                            <span class="n">tail_piece</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;.*\.motif_id-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_object</span><span class="p">)</span>
                            <span class="n">motif_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;\..*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tail_piece</span><span class="p">)</span>
                            <span class="n">unencoded_graph_title</span> <span class="o">=</span> <span class="s1">&#39;fp_id </span><span class="si">%s</span><span class="s1"> (motif_id </span><span class="si">%s</span><span class="s1">) matched - </span><span class="si">%s</span><span class="s1"> for the trailing period&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">matched_fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">motif_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">human_date</span><span class="p">))</span>

                    <span class="k">if</span> <span class="s1">&#39;matched.layers.fp_id&#39;</span> <span class="ow">in</span> <span class="n">output_object</span><span class="p">:</span>
                        <span class="c1"># layers_id</span>
                        <span class="n">tail_piece</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;.*\.layers_id-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_object</span><span class="p">)</span>
                        <span class="n">matched_layers_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;\..*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tail_piece</span><span class="p">)</span>
                        <span class="n">unencoded_graph_title</span> <span class="o">=</span> <span class="s1">&#39;layers_id </span><span class="si">%s</span><span class="s1"> matched - </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> hours&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">matched_layers_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">human_date</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">int_hours</span><span class="p">))</span>
                <span class="n">graph_title_string</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">unencoded_graph_title</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">graph_title</span> <span class="o">=</span> <span class="s1">&#39;&amp;title=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">graph_title_string</span>
                <span class="n">add_parameters</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;colorList=blue</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">,</span> <span class="n">graph_title</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;matched.layers.fp_id&#39;</span> <span class="ow">in</span> <span class="n">output_object</span><span class="p">:</span>
                    <span class="n">add_parameters</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;colorList=green</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">,</span> <span class="n">graph_title</span><span class="p">)</span>
                <span class="n">image_url</span> <span class="o">+=</span> <span class="n">add_parameters</span>
                <span class="k">if</span> <span class="n">write_to_log</span><span class="p">:</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_graphite_metric :: Ionosphere graphite NOW url - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_url</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: get_graphite_metric :: graphite image url - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">image_url</span><span class="p">)))</span>
        <span class="c1"># image_url_timeout = int(connect_timeout)</span>

        <span class="n">image_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @modified 20191025 - Task #3290: Handle urllib2 in py3</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># Use urlretrieve</span>
        <span class="c1"># try:</span>
        <span class="c1">#     # @modified 20170913 - Task #2160: Test skyline with bandit</span>
        <span class="c1">#     # Added nosec to exclude from bandit tests</span>
        <span class="c1">#     image_data = urllib2.urlopen(image_url, timeout=image_url_timeout).read()  # nosec</span>
        <span class="c1">#     current_logger.info(&#39;url OK - %s&#39; % (image_url))</span>
        <span class="c1"># except urllib2.URLError:</span>
        <span class="c1">#     image_data = None</span>
        <span class="c1">#     current_logger.error(&#39;error :: url bad - %s&#39; % (image_url))</span>

        <span class="c1"># @added 20201009 - Feature #3780: skyline_functions - sanitise_graphite_url</span>
        <span class="c1">#                   Bug #3778: Handle single encoded forward slash requests to Graphite</span>
        <span class="n">sanitised</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sanitised</span><span class="p">,</span> <span class="n">image_url</span> <span class="o">=</span> <span class="n">sanitise_graphite_url</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">image_url</span><span class="p">)</span>

        <span class="c1"># @added 20191025 - Task #3290: Handle urllib2 in py3</span>
        <span class="c1">#                   Branch #3262: py3</span>
        <span class="c1"># Use urlretrieve</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">get_graphite_graph_image</span><span class="p">(</span>
                <span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">image_url</span><span class="p">,</span> <span class="n">graphite_image_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: get_graphite_metric :: failed to get_graphite_graph_image(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_image_file</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>

        <span class="c1"># if image_data is not None:</span>
        <span class="k">if</span> <span class="n">image_data</span> <span class="o">==</span> <span class="s1">&#39;disabled_for_testing&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">graphite_image_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_to_log</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_graphite_metric :: retrieved - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">graphite_image_file</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">graphite_image_file</span><span class="p">,</span> <span class="mo">0o644</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">graphite_image_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o644</span><span class="p">)</span>
        <span class="c1"># else:</span>
        <span class="c1">#    current_logger.error(</span>
        <span class="c1">#         &#39;error :: failed to retrieve - %s&#39; % (graphite_image_file))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">graphite_image_file</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;get_graphite_metric :: retrieve failed to surface </span><span class="si">%s</span><span class="s1"> graph from Graphite&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>
        <span class="c1"># @added 20170107 - Feature #1842: Ionosphere - Graphite now graphs</span>
        <span class="c1"># In order to determine whether a Graphite image was retrieved or not</span>
        <span class="c1"># this needs to return here.  This should not be backwards incompatible</span>
        <span class="c1"># as it has never been used to determine the outcome before it appears,</span>
        <span class="c1"># which as they say is my bad.</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># @modified 20201125 - Feature #3850: webapp - yhat_values API endoint</span>
    <span class="c1"># Added list as data_type</span>
    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span> <span class="ow">or</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;list&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">output_object</span> <span class="o">!=</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">output_object</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">write_to_log</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;get_graphite_metric :: surfacing timeseries data for </span><span class="si">%s</span><span class="s1"> from graphite from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">metric</span><span class="p">,</span> <span class="n">graphite_from</span><span class="p">,</span> <span class="n">graphite_until</span><span class="p">)</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">requests</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s1">&#39;2.4.0&#39;</span><span class="p">:</span>
            <span class="n">use_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">connect_timeout</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">read_timeout</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">connect_timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: get_graphite_metric :: use_timeout - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">use_timeout</span><span class="p">)))</span>

        <span class="c1"># @added 20201009 - Feature #3780: skyline_functions - sanitise_graphite_url</span>
        <span class="c1">#                   Bug #3778: Handle single encoded forward slash requests to Graphite</span>
        <span class="n">sanitised</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sanitised</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="n">sanitise_graphite_url</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

        <span class="n">graphite_json_fetched</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">use_timeout</span><span class="p">)</span>
            <span class="c1"># @added 20220505 - Bug #4374: webapp - handle url encoded chars</span>
            <span class="c1"># Handle metrics with url encoded names</span>
            <span class="n">try_encoded_name</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="s1">&#39;%&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s1">&#39;[]&#39;</span><span class="p">:</span>
                    <span class="n">try_encoded_name</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">try_encoded_name</span><span class="p">:</span>
                <span class="n">new_url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;%25&#39;</span><span class="p">)</span>
                <span class="n">new_url</span> <span class="o">=</span> <span class="n">new_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%2525&#39;</span><span class="p">,</span> <span class="s1">&#39;%25&#39;</span><span class="p">)</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_graphite_metric :: no data - trying </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">new_url</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">use_timeout</span><span class="p">)</span>
            <span class="n">graphite_json_fetched</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">datapoints</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_until</span><span class="p">)]]</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_graphite_metric :: data retrieval from Graphite failed&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">graphite_json_fetched</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">js</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">datapoints</span> <span class="o">=</span> <span class="n">js</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datapoints&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span><span class="p">:</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: get_graphite_metric :: data retrieved OK&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>

                <span class="n">datapoints</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_until</span><span class="p">)]]</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_graphite_metric :: failed to parse data points from retrieved json&#39;</span><span class="p">)</span>

        <span class="n">converted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">datapoint</span> <span class="ow">in</span> <span class="n">datapoints</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_datapoint</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                <span class="n">converted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_datapoint</span><span class="p">)</span>
            <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
            <span class="c1"># Added nosec to exclude from bandit tests</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># nosec</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">output_object</span> <span class="o">!=</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>

            <span class="c1"># @added 20220406 - Feature #4518: settings - LAST_KNOWN_VALUE_NAMESPACES</span>
            <span class="c1">#                   Feature #4520: settings - ZERO_FILL_NAMESPACES</span>
            <span class="c1"># Add the mkdir_p function to mimic self.surface_graphite_metric_data</span>
            <span class="c1"># in mirage so that the same function can be used for all graphite</span>
            <span class="c1"># requests</span>
            <span class="n">output_object_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_object</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_object_path</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mkdir_p</span><span class="p">(</span><span class="n">output_object_path</span><span class="p">)</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;output_object_path - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_object_path</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;error :: failed to create output_object_path - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">output_object_path</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_object</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">converted</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">output_object</span><span class="p">,</span> <span class="mo">0o644</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">output_object</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o644</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: get_graphite_metric :: json file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">output_object</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;list&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">converted</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                <span class="n">timeseries_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">converted</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">timeseries_json</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">output_object</span><span class="p">):</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: get_graphite_metric :: failed to surface </span><span class="si">%s</span><span class="s1"> json from graphite&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<span class="c1"># @added 20170206 - Bug #1904: Handle non filesystem friendly metric names in check files</span>
<div class="viewcode-block" id="filesafe_metricname"><a class="viewcode-back" href="../skyline.html#skyline_functions.filesafe_metricname">[docs]</a><span class="k">def</span> <span class="nf">filesafe_metricname</span><span class="p">(</span><span class="n">metricname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns a file system safe name for a metric name in terms of creating</span>
<span class="sd">    check files, etc</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">keepchars</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sane_metricname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">metricname</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">keepchars</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">sane_metricname</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># @added 20160922 - Branch #922: Ionosphere</span>
<span class="c1"># Added the send_anomalous_metric_to function for Analyzer and Mirage</span>
<span class="c1"># @modified 20161228 Feature #1828: ionosphere - mirage Redis data features</span>
<span class="c1"># Added full_duration which needs to be recorded to allow Mirage metrics</span>
<span class="c1"># to be profiled on Redis timeseries data at FULL_DURATION</span>
<span class="c1"># e.g. mirage.redis.24h.json</span>
<span class="c1"># @modified 20170127 - Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
<span class="c1"># Added parent_id, always zero from Analyzer and Mirage</span>


<div class="viewcode-block" id="send_anomalous_metric_to"><a class="viewcode-back" href="../skyline.html#skyline_functions.send_anomalous_metric_to">[docs]</a><span class="k">def</span> <span class="nf">send_anomalous_metric_to</span><span class="p">(</span>
    <span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">send_to_app</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span>
        <span class="n">base_name</span><span class="p">,</span> <span class="n">datapoint</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span>
        <span class="c1"># @added 20201001 - Task #3748: POC SNAB</span>
        <span class="c1"># Added algorithms_run required to determine the anomalyScore</span>
        <span class="c1"># so this needs to be sent to Ionosphere so Ionosphere</span>
        <span class="c1"># can send it back on an alert</span>
        <span class="n">full_duration</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">algorithms_run</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign a metric and timeseries to Crucible or Ionosphere.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">os</span>

    <span class="c1"># @modified 20191115 - Branch #3262: py3</span>
    <span class="c1"># try:</span>
    <span class="c1">#     python_version</span>
    <span class="c1"># except:</span>
    <span class="c1">#     from sys import version_info</span>
    <span class="c1">#     python_version = int(version_info[0])</span>

    <span class="c1"># @added 20221130 - Feature #4734: mirage_vortex</span>
    <span class="n">mirage_vortex</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">current_skyline_app</span> <span class="o">==</span> <span class="s1">&#39;mirage_vortex&#39;</span><span class="p">:</span>
        <span class="n">added_by_context</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
        <span class="n">current_skyline_app</span> <span class="o">=</span> <span class="s1">&#39;mirage&#39;</span>
        <span class="n">mirage_vortex</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="c1"># @added 20170116 - Feature #1854: Ionosphere learn</span>
    <span class="n">added_by_context</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>

    <span class="c1"># @added 20221130 - Feature #4734: mirage_vortex</span>
    <span class="k">if</span> <span class="n">mirage_vortex</span><span class="p">:</span>
        <span class="n">added_by_context</span> <span class="o">=</span> <span class="s1">&#39;mirage_vortex&#39;</span>

    <span class="c1"># @added 20170117 - Feature #1854: Ionosphere learn</span>
    <span class="c1"># Added the ionosphere_learn_to_ionosphere to fix ionosphere_learn not being</span>
    <span class="c1"># logged.</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">send_to_app</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ionosphere_learn_to_ionosphere&#39;</span><span class="p">:</span>
        <span class="n">added_by_context</span> <span class="o">=</span> <span class="s1">&#39;ionosphere_learn&#39;</span>
        <span class="n">new_send_to_app</span> <span class="o">=</span> <span class="s1">&#39;ionosphere&#39;</span>
        <span class="n">send_to_app</span> <span class="o">=</span> <span class="n">new_send_to_app</span>

    <span class="c1"># @added 20170206 - Bug #1904: Handle non filesystem friendly metric names in check files</span>
    <span class="n">sane_metricname</span> <span class="o">=</span> <span class="n">filesafe_metricname</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">send_to_app</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;crucible&#39;</span><span class="p">:</span>
        <span class="n">anomaly_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">CRUCIBLE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries_dir</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">))</span>
        <span class="n">check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">CRUCIBLE_CHECK_PATH</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">sane_metricname</span><span class="p">))</span>
        <span class="n">check_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CRUCIBLE_CHECK_PATH</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">send_to_app</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ionosphere&#39;</span><span class="p">:</span>
        <span class="c1"># @modified 20161121 - Branch #922: ionosphere</span>
        <span class="c1"># Use the timestamp as the parent dir for training_data, it is easier</span>
        <span class="c1"># to manage and clean on timestamps.  Walking through 1000s of Graphite</span>
        <span class="c1"># style dirs with dotted metric namespaces for timestamps.</span>
        <span class="c1"># anomaly_dir = settings.IONOSPHERE_DATA_FOLDER + &#39;/&#39; + timeseries_dir + &#39;/&#39; + metric_timestamp</span>
        <span class="n">anomaly_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">timeseries_dir</span><span class="p">))</span>
        <span class="n">check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_CHECK_PATH</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">sane_metricname</span><span class="p">))</span>
        <span class="n">check_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_CHECK_PATH</span><span class="p">)</span>

        <span class="c1"># @added 20170116 - Feature #1854: Ionosphere learn</span>
        <span class="c1"># So as to not have to backport a context to all the instances of</span>
        <span class="c1"># send_anomalous_metric_to identify what this was added_by, here the</span>
        <span class="c1"># learn directory path string overrides the dirs if it is a learn</span>
        <span class="c1"># related check</span>
        <span class="c1"># @modified 20170117 - Feature #1854: Ionosphere learn</span>
        <span class="c1"># The ionosphere_learn_to_ionosphere to fix ionosphere_learn not being</span>
        <span class="c1"># logged.</span>
        <span class="c1"># if str(settings.IONOSPHERE_LEARN_FOLDER) in anomaly_dir:</span>
        <span class="c1">#     added_by_context = &#39;ionosphere_learn&#39;</span>
        <span class="k">if</span> <span class="n">added_by_context</span> <span class="o">==</span> <span class="s1">&#39;ionosphere_learn&#39;</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;send_anomalous_metric_to :: this is an ionosphere_learn check&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">check_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">check_dir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o755</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">anomaly_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">anomaly_dir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o755</span><span class="p">)</span>

    <span class="c1"># @added 20220805 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="c1"># Handle labelled_metrics</span>
    <span class="n">graphite_metric</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
        <span class="n">graphite_metric</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Note:</span>
    <span class="c1"># The values are enclosed is single quoted intentionally</span>
    <span class="c1"># as the imp.load_source used in crucible results in a</span>
    <span class="c1"># shift in the decimal position when double quoted, e.g.</span>
    <span class="c1"># value = &quot;5622.0&quot; gets imported as</span>
    <span class="c1"># 2016-03-02 12:53:26 :: 28569 :: metric variable - value - 562.2</span>
    <span class="c1"># single quoting results in the desired,</span>
    <span class="c1"># 2016-03-02 13:16:17 :: 1515 :: metric variable - value - 5622.0</span>
    <span class="n">now_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

    <span class="n">algorithms</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALGORITHMS</span>
    <span class="k">if</span> <span class="n">added_by_context</span> <span class="o">==</span> <span class="s1">&#39;mirage_vortex&#39;</span><span class="p">:</span>
        <span class="n">algorithms</span> <span class="o">=</span> <span class="n">algorithms_run</span>

    <span class="c1"># @modified 20161228 Feature #1828: ionosphere - mirage Redis data features</span>
    <span class="c1"># Added full_duration</span>
    <span class="c1"># @modified 20170116 - Feature #1854: Ionosphere learn</span>
    <span class="c1"># Changed added_by parameter from current_skyline_app to added_by_context</span>
    <span class="c1"># @modified 20170127 - Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
    <span class="c1"># Added ionosphere_parent_id, always zero from Analyzer and Mirage</span>
    <span class="c1"># @added 20201001 - Task #3748: POC SNAB</span>
    <span class="c1"># Added algorithms_run required to determine the anomalyScore</span>
    <span class="c1"># so this needs to be sent to Ionosphere so Ionosphere</span>
    <span class="c1"># can send it back on an alert</span>
    <span class="n">anomaly_data</span> <span class="o">=</span> <span class="s1">&#39;metric = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;value = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;from_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;metric_timestamp = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;triggered_algorithms = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;anomaly_dir = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;graphite_metric = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;run_crucible_tests = False</span><span class="se">\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;added_by = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;added_at = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;full_duration = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;ionosphere_parent_id = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> \
                   <span class="s1">&#39;algorithms_run = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithms</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">),</span> <span class="n">anomaly_dir</span><span class="p">,</span>
            <span class="c1"># @added 20220805 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="c1"># Handle labelled_metrics</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">graphite_metric</span><span class="p">),</span>
            <span class="n">added_by_context</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">now_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">full_duration</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_id</span><span class="p">),</span>
            <span class="c1"># @added 20201001 - Task #3748: POC SNAB</span>
            <span class="c1"># Added algorithms_run required to determine the anomalyScore</span>
            <span class="c1"># so this needs to be sent to Ionosphere so Ionosphere</span>
            <span class="c1"># can send it back on an alert</span>
            <span class="n">algorithms_run</span><span class="p">)</span>

    <span class="c1"># @modified 20170116 - Feature #1854: Ionosphere learn</span>
    <span class="c1"># In the Ionosphere context there is no requirement to create a timeseries</span>
    <span class="c1"># json file or anomaly_file, just the check</span>
    <span class="k">if</span> <span class="n">added_by_context</span> <span class="o">!=</span> <span class="s1">&#39;ionosphere_learn&#39;</span><span class="p">:</span>

        <span class="c1"># Create an anomaly file with details about the anomaly</span>
        <span class="n">anomaly_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">anomaly_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">write_data_to_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="n">anomaly_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">anomaly_data</span><span class="p">)</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added </span><span class="si">%s</span><span class="s1"> anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">send_to_app</span><span class="p">),</span> <span class="n">anomaly_file</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> anomaly file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">send_to_app</span><span class="p">),</span> <span class="n">anomaly_file</span><span class="p">))</span>

        <span class="c1"># Create timeseries json file with the timeseries</span>
        <span class="n">json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">anomaly_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
        <span class="n">timeseries_json</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">write_data_to_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="n">json_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">timeseries_json</span><span class="p">)</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added </span><span class="si">%s</span><span class="s1"> timeseries file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">send_to_app</span><span class="p">),</span> <span class="n">json_file</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> timeseries file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">send_to_app</span><span class="p">),</span> <span class="n">json_file</span><span class="p">))</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

    <span class="c1"># Create a check file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">write_data_to_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="n">check_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">anomaly_data</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;added </span><span class="si">%s</span><span class="s1"> check :: </span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">send_to_app</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> check file :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">send_to_app</span><span class="p">),</span> <span class="n">check_file</span><span class="p">))</span></div>


<div class="viewcode-block" id="RepresentsInt"><a class="viewcode-back" href="../skyline.html#skyline_functions.RepresentsInt">[docs]</a><span class="k">def</span> <span class="nf">RepresentsInt</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    As per http://stackoverflow.com/a/1267145 and @Aivar I must agree with</span>
<span class="sd">    @Triptycha &gt; &quot;This 5 line function is not a complex mechanism.&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1">################################################################################</span>


<div class="viewcode-block" id="mysql_select"><a class="viewcode-back" href="../skyline.html#skyline_functions.mysql_select">[docs]</a><span class="k">def</span> <span class="nf">mysql_select</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select data from mysql database</span>

<span class="sd">    :param current_skyline_app: the Skyline app that is calling the function</span>
<span class="sd">    :param select: the select string</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type select: str</span>
<span class="sd">    :return: tuple</span>
<span class="sd">    :rtype: tuple, boolean</span>

<span class="sd">    - **Example usage**::</span>

<span class="sd">        from skyline_functions import mysql_select</span>
<span class="sd">        query = &#39;select id, metric from anomalies&#39;</span>
<span class="sd">        results = mysql_select(query)</span>

<span class="sd">    - **Example of the 0 indexed results tuple, which can hold multiple results**::</span>

<span class="sd">        &gt;&gt; print(&#39;results: %s&#39; % str(results))</span>
<span class="sd">        results: [(1, u&#39;test1&#39;), (2, u&#39;test2&#39;)]</span>

<span class="sd">        &gt;&gt; print(&#39;results[0]: %s&#39; % str(results[0]))</span>
<span class="sd">        results[0]: (1, u&#39;test1&#39;)</span>

<span class="sd">    .. note::</span>
<span class="sd">        - If the MySQL query fails a boolean will be returned not a tuple</span>
<span class="sd">            * ``False``</span>
<span class="sd">            * ``None``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ENABLE_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
            <span class="n">ENABLE_DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">ENABLE_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_WEBAPP_DEBUG</span><span class="p">:</span>
            <span class="n">ENABLE_DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">ENABLE_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
            <span class="n">ENABLE_DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">ENABLE_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ENABLE_DEBUG</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: entering mysql_select&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">mysql.connector</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conversion</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">mysql.connector</span> <span class="kn">import</span> <span class="n">conversion</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">re</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">re</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cnx</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ENABLE_DEBUG</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: connected to mysql&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mysql error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to mysql&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">cnx</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ENABLE_DEBUG</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">select</span><span class="p">)))</span>

            <span class="c1"># NOTE: when a LIKE SELECT is made the query string is not run</span>
            <span class="c1"># through the conversion.MySQLConverter().escape method as it</span>
            <span class="c1"># it would not work and kept on returning mysql error - 1064 with</span>
            <span class="c1"># multiple single quotes e.g. use near &#39;\&#39;carbon%\&#39;&#39; at line 1</span>
            <span class="c1"># Various patterns were attempted to no avail, it seems to be</span>
            <span class="c1"># related to % character. pseudo basic HTTP auth has been added to</span>
            <span class="c1"># the webapp just in someone does not secure it properly, a little</span>
            <span class="c1"># defence in depth, so added WEBAPP_ALLOWED_IPS too.</span>
            <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pattern_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39; LIKE &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">select</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: pattern_match - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_match</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pattern_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39; like &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">select</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: pattern_match - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

            <span class="c1"># TBD - not sure how to get it escaping safely</span>
            <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ENABLE_DEBUG</span><span class="p">:</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: unescaped query - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)))</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="n">cnx</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">conversion</span><span class="o">.</span><span class="n">MySQLConverter</span><span class="p">()</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ENABLE_DEBUG</span><span class="p">:</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: escaped query - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)))</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="n">cnx</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

            <span class="c1"># cursor = cnx.cursor()</span>
            <span class="c1"># cursor.execute(query)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mysql error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: failed to query database - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">select</span><span class="p">)))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ENABLE_DEBUG</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - failed to connect to mysql&#39;</span><span class="p">)</span>

    <span class="c1"># Close the test mysql connection</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># @added 20170602 - Feature #2034: analyse_derivatives</span>
<div class="viewcode-block" id="nonNegativeDerivative"><a class="viewcode-back" href="../skyline.html#skyline_functions.nonNegativeDerivative">[docs]</a><span class="k">def</span> <span class="nf">nonNegativeDerivative</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to convert an integral or incrementing count to a</span>
<span class="sd">    derivative by calculating the delta between subsequent datapoints.  The</span>
<span class="sd">    function ignores datapoints that trend down and is useful for metrics that</span>
<span class="sd">    increase over time and then reset.</span>
<span class="sd">    This based on part of the Graphite render function nonNegativeDerivative at:</span>
<span class="sd">    https://github.com/graphite-project/graphite-web/blob/1e5cf9f659f5d4cc0fa53127f756a1916e62eb47/webapp/graphite/render/functions.py#L1627</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">derivative_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">datapoint</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">datapoint</span><span class="p">):</span>
            <span class="c1"># derivative_timeseries.append((timestamp, None))</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">datapoint</span>
            <span class="k">continue</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="n">datapoint</span> <span class="o">-</span> <span class="n">prev</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">derivative_timeseries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">diff</span><span class="p">))</span>
        <span class="c1"># else:</span>
        <span class="c1">#    derivative_timeseries.append((timestamp, None))</span>

        <span class="n">prev</span> <span class="o">=</span> <span class="n">datapoint</span>

    <span class="k">return</span> <span class="n">derivative_timeseries</span></div>


<div class="viewcode-block" id="strictly_increasing_monotonicity"><a class="viewcode-back" href="../skyline.html#skyline_functions.strictly_increasing_monotonicity">[docs]</a><span class="k">def</span> <span class="nf">strictly_increasing_monotonicity</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to determine whether timeseries is strictly increasing</span>
<span class="sd">    monotonically, it will only return True if the values are strictly</span>
<span class="sd">    increasing, an incrementing count.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># @added 20200529 - Feature #3480: batch_processing</span>
    <span class="c1">#                   Bug #2050: analyse_derivatives - change in monotonicity</span>
    <span class="c1"># Only apply to time series that have sufficient data to make this</span>
    <span class="c1"># determination</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="n">test_ts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">datapoint</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="c1"># This only identifies and handles positive, strictly increasing</span>
        <span class="c1"># monotonic timeseries</span>
        <span class="k">if</span> <span class="n">datapoint</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">test_ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datapoint</span><span class="p">)</span>

    <span class="c1"># Exclude timeseries that are all the same value, these are not increasing</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">test_ts</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Exclude timeseries that sum to 0, these are not increasing</span>
    <span class="n">ts_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">test_ts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">ts_sum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">diff_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">test_ts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">diff_ts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="in_list"><a class="viewcode-back" href="../skyline.html#skyline_functions.in_list">[docs]</a><span class="k">def</span> <span class="nf">in_list</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">check_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the metric is in list.</span>

<span class="sd">    # @added 20170602 - Feature #2034: analyse_derivatives</span>
<span class="sd">    #                   Feature #1978: worker - DO_NOT_SKIP_LIST</span>
<span class="sd">    This is a part copy of the SKIP_LIST allows for a string match or a match on</span>
<span class="sd">    dotted elements within the metric namespace used in Horizon/worker</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">metric_namespace_elements</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">metric_in_list</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">in_list</span> <span class="ow">in</span> <span class="n">check_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">in_list</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
            <span class="n">metric_in_list</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
        <span class="n">in_list_namespace_elements</span> <span class="o">=</span> <span class="n">in_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">elements_matched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metric_namespace_elements</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">in_list_namespace_elements</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements_matched</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_list_namespace_elements</span><span class="p">):</span>
            <span class="n">metric_in_list</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">metric_in_list</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># @added 20170825 - Task #2132: Optimise Ionosphere DB usage</span>
<span class="c1"># Get the metric db object data to memcache</span>
<div class="viewcode-block" id="get_memcache_metric_object"><a class="viewcode-back" href="../skyline.html#skyline_functions.get_memcache_metric_object">[docs]</a><span class="k">def</span> <span class="nf">get_memcache_metric_object</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the metrics_db_object from memcache if it exists.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pymemcache_Client</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pymemcache.client.base</span> <span class="kn">import</span> <span class="n">Client</span> <span class="k">as</span> <span class="n">pymemcache_Client</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">literal_eval</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

    <span class="c1"># @added 20191029 - Task #3304: py3 - handle pymemcache bytes not str</span>
    <span class="c1">#                   Branch #3262: py3</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">python_version</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># @added 20191030 - Task #3304: py3 - handle pymemcache bytes not str</span>
    <span class="c1">#                   Branch #3262: py3</span>
    <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">codecs</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">codecs</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="c1"># @added 20220405 - Task #4514: Integrate opentelemetry</span>
    <span class="c1">#                   Feature #4516: flux - opentelemetry traces</span>
    <span class="k">if</span> <span class="n">OTEL_ENABLED</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>

        <span class="c1"># @modified 20221102 - Bug #4714: opentelemetry check is_instrumented_by_opentelemetry</span>
        <span class="n">instrumented</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instrumented</span> <span class="o">=</span> <span class="n">PymemcacheInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">is_instrumented_by_opentelemetry</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_memcache_metric_object - PymemcacheInstrumentor().is_instrumented_by_opentelemetry failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instrumented</span><span class="p">:</span>
            <span class="c1"># @modified 20220505 - Task #4514: Integrate opentelemetry</span>
            <span class="c1"># Fail gracefully if opentelemetry breaks it breaks</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">PymemcacheInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
        <span class="n">memcache_client</span> <span class="o">=</span> <span class="n">pymemcache_Client</span><span class="p">((</span><span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHED_SERVER_IP</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHED_SERVER_PORT</span><span class="p">),</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">memcache_metrics_db_object</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metrics_db_object_key</span> <span class="o">=</span> <span class="s1">&#39;metrics_db_object.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
    <span class="n">memcache_result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20191029 - Task #3304: py3 - handle pymemcache bytes not str</span>
            <span class="c1"># memcache_result = memcache_client.get(metrics_db_object_key)</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">memcache_result</span> <span class="o">=</span> <span class="n">memcache_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metrics_db_object_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># memcache_result = memcache_client.get(metrics_db_object_key)</span>
                <span class="c1"># @modified 20200109 - Task #3304: py3 - handle pymemcache bytes not str</span>
                <span class="c1"># Handle when memcache returns None as the new decode errors with</span>
                <span class="c1"># AttributeError: &#39;NoneType&#39; object has no attribute &#39;decode&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">memcache_result</span> <span class="o">=</span> <span class="n">memcache_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metrics_db_object_key</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="n">memcache_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: skyline_functions :: get_memcache_metric_object :: failed to get </span><span class="si">%s</span><span class="s1"> from memcache&#39;</span> <span class="o">%</span> <span class="n">metrics_db_object_key</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">memcache_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
        <span class="c1"># Added nosec to exclude from bandit tests</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># nosec</span>
            <span class="k">pass</span>

    <span class="n">memcache_metric_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">memcache_result</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">memcache_metrics_db_object</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">memcache_result</span><span class="p">)</span>
            <span class="n">memcache_metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># for k, v in memcache_result_list:</span>
            <span class="c1"># @modified 20191030 - Branch #3262: py3</span>
            <span class="c1"># for k, v in memcache_metrics_db_object.iteritems():</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">memcache_metrics_db_object</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="n">key_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">key_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">memcache_metric_dict</span><span class="p">[</span><span class="n">key_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">memcache_metrics_db_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">key_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">key_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">memcache_metric_dict</span><span class="p">[</span><span class="n">key_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_value</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: skyline_functions :: get_memcache_metric_object :: failed to process data with iter of memcache memcache_metrics_db_object key dict </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metrics_db_object_key</span><span class="p">)</span>
            <span class="n">memcache_metric_dict</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">memcache_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
        <span class="c1"># Added nosec to exclude from bandit tests</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># nosec</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">memcache_metric_dict</span><span class="p">:</span>
        <span class="c1"># metrics_id = int(memcache_metric_dict[&#39;id&#39;])</span>
        <span class="c1"># metric_ionosphere_enabled = int(memcache_metric_dict[&#39;ionosphere_enabled&#39;])</span>
        <span class="n">metrics_db_object</span> <span class="o">=</span> <span class="n">memcache_metric_dict</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_memcache_metric_object :: returned memcache data for key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metrics_db_object_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">metrics_db_object</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># @added 20170826 - Task #2132: Optimise Ionosphere DB usage</span>
<span class="c1"># Get the fp_ids list object data to memcache</span>
<div class="viewcode-block" id="get_memcache_fp_ids_object"><a class="viewcode-back" href="../skyline.html#skyline_functions.get_memcache_fp_ids_object">[docs]</a><span class="k">def</span> <span class="nf">get_memcache_fp_ids_object</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the fp_ids list from memcache if it exists.</span>

<span class="sd">    .. warning: this returns a list and to mimic the MySQL results rows, when</span>
<span class="sd">        this is used the list item must to turned into a dict to match the</span>
<span class="sd">        MySQL/SQLAlchemy format.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pymemcache_Client</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pymemcache.client.base</span> <span class="kn">import</span> <span class="n">Client</span> <span class="k">as</span> <span class="n">pymemcache_Client</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">literal_eval</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

    <span class="c1"># @added 20191029 - Task #3304: py3 - handle pymemcache bytes not str</span>
    <span class="c1">#                   Branch #3262: py3</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">python_version</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
        <span class="n">memcache_client</span> <span class="o">=</span> <span class="n">pymemcache_Client</span><span class="p">((</span><span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHED_SERVER_IP</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHED_SERVER_PORT</span><span class="p">),</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fp_ids_list_object_key</span> <span class="o">=</span> <span class="s1">&#39;fp_ids_list_object.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>

    <span class="n">memcache_result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20191029 - Task #3304: py3 - handle pymemcache bytes not str</span>
            <span class="c1"># memcache_result = memcache_client.get(fp_ids_list_object_key)</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">memcache_result</span> <span class="o">=</span> <span class="n">memcache_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fp_ids_list_object_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">memcache_result</span> <span class="o">=</span> <span class="n">memcache_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fp_ids_list_object_key</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: skyline_functions :: get_memcache_fp_ids_object :: failed to get </span><span class="si">%s</span><span class="s1"> from memcache&#39;</span> <span class="o">%</span> <span class="n">fp_ids_list_object_key</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">memcache_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
        <span class="c1"># Added nosec to exclude from bandit tests</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># nosec</span>
            <span class="k">pass</span>

    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">memcache_result</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">memcache_result</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: skyline_functions :: get_memcache_fp_ids_object :: failed to process data from memcache key with literal_eval </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fp_ids_list_object_key</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">memcache_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
        <span class="c1"># Added nosec to exclude from bandit tests</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># nosec</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">result</span></div>


<span class="c1"># @added 20171216 - Task #2236: Change Boundary to only send to Panorama on alert</span>
<div class="viewcode-block" id="move_file"><a class="viewcode-back" href="../skyline.html#skyline_functions.move_file">[docs]</a><span class="k">def</span> <span class="nf">move_file</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">,</span> <span class="n">file_to_move</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Move a file.</span>

<span class="sd">    :param current_skyline_app: the skyline app using this function</span>
<span class="sd">    :param dest_dir: the directory the file is to be moved to</span>
<span class="sd">    :param file_to_move: path and filename of the file to move</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type dest_dir: str</span>
<span class="sd">    :type file_to_move: str</span>
<span class="sd">    :return: ``True``, ``False``</span>
<span class="sd">    :rtype: boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">os</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">shutil</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">python_version</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;created dest_dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: failed to create dest_dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="n">move_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_to_move</span><span class="p">))</span>
    <span class="n">moved_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">move_file_name</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">file_to_move</span><span class="p">,</span> <span class="n">moved_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">moved_file</span><span class="p">,</span> <span class="mo">0o644</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">moved_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o644</span><span class="p">)</span>

        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;moved file to - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">moved_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;failed to move file to - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">moved_file</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># @added 20180107 - Branch #2270: luminosity</span>
<div class="viewcode-block" id="is_derivative_metric"><a class="viewcode-back" href="../skyline.html#skyline_functions.is_derivative_metric">[docs]</a><span class="k">def</span> <span class="nf">is_derivative_metric</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if a metric is a known derivative metric.</span>

<span class="sd">    :param current_skyline_app: the Skyline app that is calling the function</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :param base_name: The metric base_name</span>
<span class="sd">    :type base_name: str</span>
<span class="sd">    :return: boolean</span>
<span class="sd">    :rtype: boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="c1"># Feature #2034: analyse_derivatives</span>
    <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1">#    try:</span>
<span class="c1">#        # @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1">#        if settings.REDIS_PASSWORD:</span>
<span class="c1">#            REDIS_CONN = StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1">#        else:</span>
<span class="c1">#            REDIS_CONN = StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1">#    except:</span>
<span class="c1">#        from redis import StrictRedis</span>
<span class="c1">#    if not REDIS_CONN:</span>
<span class="c1">#        try:</span>
<span class="c1">#            # @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1">#            if settings.REDIS_PASSWORD:</span>
<span class="c1">#                REDIS_CONN = StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1">#            else:</span>
<span class="c1">#                REDIS_CONN = StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1">#        except:</span>
<span class="c1">#            current_logger.error(&#39;error :: known_derivative_metric - Redis connection failed&#39;)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: known_derivative_metric - get_redis_conn failed&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># @added 20220808 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
            <span class="n">metric_type_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_type_id_str</span> <span class="o">=</span> <span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;skyline.labelled_metrics.id.type&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">metric_type_id_str</span><span class="p">:</span>
                    <span class="n">metric_type_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_type_id_str</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: known_derivative_metric - hget skyline.labelled_metrics.id.type failed for metric_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">metric_type_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">metric_type_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20211012 - Feature #4280: aet.metrics_manager.derivative_metrics Redis hash</span>
        <span class="c1"># derivative_metrics = list(REDIS_CONN_DECODED.smembers(&#39;derivative_metrics&#39;))</span>
        <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;non_derivative_metrics&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20200606 - Bug #3572: Apply list to settings import</span>
        <span class="n">non_derivative_monotonic_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">NON_DERIVATIVE_MONOTONIC_METRICS</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">non_derivative_monotonic_metrics</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">derivative_metrics</span><span class="p">:</span>
        <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># First check if it has its own Redis z.derivative_metric key</span>
    <span class="c1"># that has not expired</span>
    <span class="n">derivative_metric_key</span> <span class="o">=</span> <span class="s1">&#39;z.derivative_metric.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
        <span class="n">last_derivative_metric_key</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: is_derivative_metric :: last_derivative_metric_key - get_redis_conn failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">last_derivative_metric_key</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">derivative_metric_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: is_derivative_metric :: could not query Redis for last_derivative_metric_key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">last_derivative_metric_key</span><span class="p">:</span>
            <span class="c1"># Until the z.derivative_metric key expires, it is classed</span>
            <span class="c1"># as such</span>
            <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">skip_derivative</span> <span class="o">=</span> <span class="n">in_list</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">non_derivative_monotonic_metrics</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">skip_derivative</span><span class="p">:</span>
        <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">non_derivative_metrics</span><span class="p">:</span>
            <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># @added 20180804 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
<div class="viewcode-block" id="set_metric_as_derivative"><a class="viewcode-back" href="../skyline.html#skyline_functions.set_metric_as_derivative">[docs]</a><span class="k">def</span> <span class="nf">set_metric_as_derivative</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the metric to the derivative_metrics Redis set and create a</span>
<span class="sd">    z_derivative_metrics Redis key.</span>

<span class="sd">    :param current_skyline_app: the Skyline app that is calling the function</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :param base_name: the metric base_name</span>
<span class="sd">    :type base_name: str</span>
<span class="sd">    :return: boolean</span>
<span class="sd">    :rtype: boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set_metric_as_derivative :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
    <span class="n">return_boolean</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @modified 20191025 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                      Branch #3262: py3</span>
    <span class="c1"># Added, charset=&#39;utf-8&#39;, decode_responses=True to REDIS_CONN</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">StrictRedis</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">REDIS_CONN</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: set_metric_as_derivative - Redis connection failed&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">REDIS_CONN</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">return_boolean</span>

    <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;derivative_metrics&#39;</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set_metric_as_derivative :: </span><span class="si">%s</span><span class="s1"> added to derivative_metrics Redis set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add metric to Redis derivative_metrics set&#39;</span><span class="p">)</span>
        <span class="n">return_boolean</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">derivative_metric_key</span> <span class="o">=</span> <span class="s1">&#39;z.derivative_metric.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">last_expire_set</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
        <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
            <span class="n">derivative_metric_key</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">,</span> <span class="n">last_expire_set</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not set Redis derivative_metric key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">return_boolean</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20190108 - Bug #2796: set_metric_as_derivative remove from non_derivative_metrics</span>
    <span class="c1"># Remove the metric from the non_derivative_metrics Redis set.  This set is</span>
    <span class="c1"># normally managed by Analyzer and although the metric is added to the</span>
    <span class="c1"># derivative_metrics set above, it only gets removed from the</span>
    <span class="c1"># non_derivative_metrics set after the Analyzer Redis key</span>
    <span class="c1"># analyzer.derivative_metrics_expiry expires, which can be up to 300 seconds</span>
    <span class="c1"># when the derivative_metrics and non_derivative_metrics Redis sets are</span>
    <span class="c1"># recreated</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set_metric_as_derivative :: removing </span><span class="si">%s</span><span class="s1"> from non_derivative_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;non_derivative_metrics&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_non_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">len_non_derivative_metrics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_derivative_metrics</span><span class="p">)</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set_metric_as_derivative :: </span><span class="si">%s</span><span class="s1"> metrics in non_derivative_metrics before the removal&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">len_non_derivative_metrics</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">non_derivative_metrics</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i_metric_name</span> <span class="ow">in</span> <span class="n">non_derivative_metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i_metric_name</span> <span class="o">!=</span> <span class="n">metric_name</span><span class="p">:</span>
                <span class="n">new_non_derivative_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_metric_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new_non_derivative_metrics</span><span class="p">:</span>
        <span class="n">all_redis_ops_ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i_metric_name</span> <span class="ow">in</span> <span class="n">new_non_derivative_metrics</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;new_non_derivative_metrics&#39;</span><span class="p">,</span> <span class="n">i_metric_name</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">all_redis_ops_ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add metric </span><span class="si">%s</span><span class="s1"> to Redis new_non_derivative_metrics set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_metric_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">all_redis_ops_ok</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;non_derivative_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;old_non_derivative_metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not rename Redis set non_derivative_metrics to old_non_derivative_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">return_boolean</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;new_non_derivative_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;non_derivative_metrics&#39;</span><span class="p">)</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set_metric_as_derivative :: removed </span><span class="si">%s</span><span class="s1"> from non_derivative_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not rename Redis set new_non_derivative_metrics to non_derivative_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">return_boolean</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;old_non_derivative_metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not delta Redis set old_non_derivative_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;non_derivative_metrics&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">len_non_derivative_metrics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_derivative_metrics</span><span class="p">)</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set_metric_as_derivative :: </span><span class="si">%s</span><span class="s1"> metrics in non_derivative_metrics after the removal of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">len_non_derivative_metrics</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">return_boolean</span></div>


<span class="c1"># @added 20190920 - Feature #3230: users DB table</span>
<span class="c1">#                   Ideas #2476: Label and relate anomalies</span>
<span class="c1">#                   Feature #2516: Add label to features profile</span>
<div class="viewcode-block" id="get_user_details"><a class="viewcode-back" href="../skyline.html#skyline_functions.get_user_details">[docs]</a><span class="k">def</span> <span class="nf">get_user_details</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">desired_value</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the user details for a user given the desired_value, key and</span>
<span class="sd">    value.  If you want the username of the user with id 1 then:</span>
<span class="sd">    get_user_details(&#39;username&#39;, &#39;id&#39;, 1)  # Will return &#39;Skyline&#39;</span>
<span class="sd">    get_user_details(&#39;id&#39;, &#39;username&#39;, &#39;Skyline&#39;)  # Will return &#39;1&#39;</span>

<span class="sd">    :param current_skyline_app: the app calling the function so the function</span>
<span class="sd">        knows which log to write too.</span>
<span class="sd">    :param desired_value: the id or username</span>
<span class="sd">    :param key: the field for the value</span>
<span class="sd">    :param value: the value of the item you want to query in the key field</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type desired_value: str</span>
<span class="sd">    :type key: str</span>
<span class="sd">    :type value: str or int</span>
<span class="sd">    :return: tuple</span>
<span class="sd">    :rtype:  (boolean, str)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
        <span class="n">select_field</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>
        <span class="n">select_where</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>

    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span>
        <span class="n">select_field</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>
        <span class="n">select_where</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>

    <span class="k">if</span> <span class="n">desired_value</span> <span class="o">!=</span> <span class="n">select_field</span><span class="p">:</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: get_user_details :: desired_value </span><span class="si">%s</span><span class="s1"> is invalid in get_user_details(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">desired_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">desired_value</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_skyline_app</span> <span class="o">==</span> <span class="s1">&#39;webapp&#39;</span><span class="p">:</span>
            <span class="c1"># Raise to webbapp</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_user_details :: could not get a MySQL engine - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">users_table_meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
        <span class="n">users_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">users_table_meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_user_details :: Table failed on user table - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">err</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="c1"># query = &#39;select %s from users WHERE %s = \&#39;%s\&#39;&#39; % (select_field, select_where, str(value))  # nosec</span>
        <span class="c1"># results = mysql_select(str(current_skyline_app), query)</span>
        <span class="c1"># result = results[0][0]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">users_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">users_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">users_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">users_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: get_user_details :: could not get user </span><span class="si">%s</span><span class="s1"> from database for get_user_details(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="n">select_field</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">desired_value</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_user_details :: engine_disposal failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">current_skyline_app</span> <span class="o">==</span> <span class="s1">&#39;webapp&#39;</span><span class="p">:</span>
            <span class="c1"># Raise to webbapp</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: get_user_details :: determined </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> for users.</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">),</span> <span class="n">select_field</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">select_where</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

    <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_user_details :: engine_disposal failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">select_field</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<span class="c1"># @added 20191106 - Branch #3002: docker</span>
<span class="c1">#                   Branch #3262: py3</span>
<div class="viewcode-block" id="get_graphite_port"><a class="viewcode-back" href="../skyline.html#skyline_functions.get_graphite_port">[docs]</a><span class="k">def</span> <span class="nf">get_graphite_port</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns graphite port based on configuration in settings.py</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span> <span class="o">==</span> <span class="s1">&#39;http&#39;</span><span class="p">:</span>
        <span class="n">graphite_port</span> <span class="o">=</span> <span class="s1">&#39;80&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">graphite_port</span> <span class="o">=</span> <span class="s1">&#39;443&#39;</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">graphite_port</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">graphite_port</span></div>


<div class="viewcode-block" id="get_graphite_render_uri"><a class="viewcode-back" href="../skyline.html#skyline_functions.get_graphite_render_uri">[docs]</a><span class="k">def</span> <span class="nf">get_graphite_render_uri</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns graphite render uri based on configuration in settings.py</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">graphite_render_uri</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_RENDER_URI</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_graphite_render_uri :: GRAPHITE_RENDER_URI is not declared in settings.py, using default of </span><span class="se">\&#39;</span><span class="s1">render</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">graphite_render_uri</span> <span class="o">=</span> <span class="s1">&#39;render&#39;</span>
    <span class="k">return</span> <span class="n">graphite_render_uri</span></div>


<div class="viewcode-block" id="get_graphite_custom_headers"><a class="viewcode-back" href="../skyline.html#skyline_functions.get_graphite_custom_headers">[docs]</a><span class="k">def</span> <span class="nf">get_graphite_custom_headers</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns custom http headers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_CUSTOM_HEADERS</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_graphite_custom_headers :: GRAPHITE_CUSTOM_HEADERS is not declared in settings.py, using default of \{\}&#39;</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">headers</span></div>


<span class="c1"># @added 20191113 - Feature #: forward_alert</span>
<div class="viewcode-block" id="forward_alert"><a class="viewcode-back" href="../skyline.html#skyline_functions.forward_alert">[docs]</a><span class="k">def</span> <span class="nf">forward_alert</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">alert_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sends alert data to a HTTP endpoint</span>

<span class="sd">    :param current_skyline_app: the app calling the function so the function</span>
<span class="sd">        knows which log to write too.</span>
<span class="sd">    :param alert_data: a list containing the alert data</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type alert_data: list</span>
<span class="sd">    :type key: str</span>
<span class="sd">    :type value: str or int</span>
<span class="sd">    :return: tuple</span>
<span class="sd">    :rtype:  (boolean, str)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - never to be implemented.  Implemented as http_alerter&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">current_skyline_app</span><span class="p">))</span></div>


<span class="c1"># @added 20200413 - Feature #3486: analyzer_batch</span>
<span class="c1">#                   Feature #3480: batch_processing</span>
<div class="viewcode-block" id="is_batch_metric"><a class="viewcode-back" href="../skyline.html#skyline_functions.is_batch_metric">[docs]</a><span class="k">def</span> <span class="nf">is_batch_metric</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if the metric is designated as an analyzer batch processing metric</span>

<span class="sd">    :param current_skyline_app: the app calling the function so the function</span>
<span class="sd">        knows which log to write too.</span>
<span class="sd">    :param metric_name: the metric name</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type metric_name: str</span>
<span class="sd">    :return: False</span>
<span class="sd">    :rtype:  boolean</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">debug_is_batch_metric</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">debug_is_batch_metric</span><span class="p">:</span>
        <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
        <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current_logger</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="n">BATCH_PROCESSING</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">BATCH_PROCESSING</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20200606 - Bug #3572: Apply list to settings import</span>
        <span class="c1"># from settings import BATCH_PROCESSING_NAMESPACES</span>
        <span class="n">BATCH_PROCESSING_NAMESPACES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BATCH_PROCESSING_NAMESPACES</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">BATCH_PROCESSING_NAMESPACES</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># @added 20201017 - Feature #3818: ANALYZER_BATCH_PROCESSING_OVERFLOW_ENABLED</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ANALYZER_BATCH_PROCESSING_OVERFLOW_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANALYZER_BATCH_PROCESSING_OVERFLOW_ENABLED</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">ANALYZER_BATCH_PROCESSING_OVERFLOW_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">ANALYZER_BATCH_PROCESSING_OVERFLOW_ENABLED</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">BATCH_PROCESSING_NAMESPACES</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="n">debug_is_batch_metric</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">batch_metric</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">BATCH_PROCESSING</span><span class="p">:</span>
        <span class="n">batch_metric</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">BATCH_PROCESSING_NAMESPACES</span><span class="p">:</span>
            <span class="n">batch_metric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">base_name_namespace_elements</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">batch_processing_namespace</span> <span class="ow">in</span> <span class="n">BATCH_PROCESSING_NAMESPACES</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">batch_processing_namespace</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                    <span class="n">batch_metric</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">debug_is_batch_metric</span><span class="p">:</span>
                        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - is_batch_metric - namespace - </span><span class="si">%s</span><span class="s1"> matched by being in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">batch_processing_namespace</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="n">batch_processing_namespace_namespace_elements</span> <span class="o">=</span> <span class="n">batch_processing_namespace</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">elements_matched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">base_name_namespace_elements</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">batch_processing_namespace_namespace_elements</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements_matched</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_processing_namespace_namespace_elements</span><span class="p">):</span>
                    <span class="n">batch_metric</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">debug_is_batch_metric</span><span class="p">:</span>
                        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - is_batch_metric - namespace - </span><span class="si">%s</span><span class="s1"> matched by elements of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">batch_processing_namespace</span><span class="p">))</span>
                    <span class="k">break</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">base_name_namespace_elements</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">batch_processing_namespace_namespace_elements</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">elements_matched</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">batch_metric</span></div>


<span class="c1"># @added 20200424 - Feature #3504: Handle airgaps in batch metrics</span>
<span class="c1">#                   Feature #3480: batch_processing</span>
<span class="c1">#                   Feature #3486: analyzer_batch</span>
<span class="c1">#                   Feature #3400: Identify air gaps in the metric data</span>
<span class="c1"># Moved to skyline_functions from its original definition analyzer/algorithms.py</span>
<span class="c1"># as is required in analyzer/analyzer.py now as well to identify which batch</span>
<span class="c1"># metrics should also be checked for airgaps.</span>
<div class="viewcode-block" id="is_check_airgap_metric"><a class="viewcode-back" href="../skyline.html#skyline_functions.is_check_airgap_metric">[docs]</a><span class="k">def</span> <span class="nf">is_check_airgap_metric</span><span class="p">(</span><span class="n">base_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a metric matches a metric namespace in CHECK_AIRGAPS or one in</span>
<span class="sd">    SKIP_AIRGAPS.</span>

<span class="sd">    :param base_name: the metric base_name</span>
<span class="sd">    :type base_name: str</span>
<span class="sd">    :return: False</span>
<span class="sd">    :rtype:  boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">IDENTIFY_AIRGAPS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IDENTIFY_AIRGAPS</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">IDENTIFY_AIRGAPS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20200606 - Bug #3572: Apply list to settings import</span>
        <span class="n">CHECK_AIRGAPS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CHECK_AIRGAPS</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">CHECK_AIRGAPS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20200606 - Bug #3572: Apply list to settings import</span>
        <span class="n">SKIP_AIRGAPS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKIP_AIRGAPS</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">SKIP_AIRGAPS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">check_metric_for_airgaps</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">IDENTIFY_AIRGAPS</span><span class="p">:</span>
        <span class="n">check_metric_for_airgaps</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">CHECK_AIRGAPS</span><span class="p">:</span>
            <span class="n">check_metric_for_airgaps</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_namespace_elements</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">to_check</span> <span class="ow">in</span> <span class="n">CHECK_AIRGAPS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">to_check</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                        <span class="n">check_metric_for_airgaps</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                    <span class="n">to_check_namespace_elements</span> <span class="o">=</span> <span class="n">to_check</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="n">elements_matched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metric_namespace_elements</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_check_namespace_elements</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements_matched</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_check_namespace_elements</span><span class="p">):</span>
                        <span class="n">check_metric_for_airgaps</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># Allow to skip identifying airgaps on certain metrics and namespaces</span>
        <span class="k">if</span> <span class="n">check_metric_for_airgaps</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_namespace_elements</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">to_skip</span> <span class="ow">in</span> <span class="n">SKIP_AIRGAPS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">to_skip</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                        <span class="n">check_metric_for_airgaps</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="n">to_skip_namespace_elements</span> <span class="o">=</span> <span class="n">to_skip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="n">elements_matched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metric_namespace_elements</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_skip_namespace_elements</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements_matched</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_skip_namespace_elements</span><span class="p">):</span>
                        <span class="n">check_metric_for_airgaps</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">return</span> <span class="n">check_metric_for_airgaps</span></div>


<span class="c1"># @added 20200506 - Feature #3532: Sort all time series</span>
<div class="viewcode-block" id="sort_timeseries"><a class="viewcode-back" href="../skyline.html#skyline_functions.sort_timeseries">[docs]</a><span class="k">def</span> <span class="nf">sort_timeseries</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to sort a time series by timestamp to ensure that</span>
<span class="sd">    there are no unordered timestamps in the time series which are artefacts of</span>
<span class="sd">    the collector or carbon-relay. So all Redis time series are sorted by</span>
<span class="sd">    timestamp before analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sorted_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="n">sorted_timeseries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">timeseries</span>

    <span class="k">return</span> <span class="n">sorted_timeseries</span></div>


<span class="c1"># @added 20200813 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
<div class="viewcode-block" id="historical_data_dir_exists"><a class="viewcode-back" href="../skyline.html#skyline_functions.historical_data_dir_exists">[docs]</a><span class="k">def</span> <span class="nf">historical_data_dir_exists</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">ionosphere_data_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to determine if an ionosphere data dir exists and if</span>
<span class="sd">    it does return the path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="n">historical_data_path_exists</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ionosphere_data_dir</span><span class="p">):</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: historical_data_dir_exists :: ionosphere_data_dir exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">ionosphere_data_dir</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">historical_data_path_exists</span><span class="p">,</span> <span class="n">ionosphere_data_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: historical_data_dir_exists :: ionosphere_data_dir does not exist - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">ionosphere_data_dir</span><span class="p">))</span>

    <span class="c1"># @added 20200813 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">IONOSPHERE_HISTORICAL_DATA_FOLDER</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_HISTORICAL_DATA_FOLDER</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">IONOSPHERE_HISTORICAL_DATA_FOLDER</span> <span class="o">=</span> <span class="s1">&#39;/opt/skyline/ionosphere/historical_data&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: historical_data_dir_exists :: checking for any IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR namespaces match in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">ionosphere_data_dir</span><span class="p">))</span>
        <span class="n">historical_data_dir</span> <span class="o">=</span> <span class="n">ionosphere_data_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="n">IONOSPHERE_HISTORICAL_DATA_FOLDER</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">historical_data_dir</span><span class="p">):</span>
            <span class="n">historical_data_path_exists</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: historical_data_dir_exists :: historical_data_dir exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">historical_data_dir</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: historical_data_dir_exists :: historical_data_dir does not exist - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">historical_data_dir</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">historical_data_path_exists</span><span class="p">:</span>
            <span class="n">ionosphere_data_dir</span> <span class="o">=</span> <span class="n">historical_data_dir</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">historical_data_path_exists</span><span class="p">,</span> <span class="n">ionosphere_data_dir</span><span class="p">)</span></div>


<span class="c1"># @added 20200825 - Feature #3704: Add alert to anomalies</span>
<div class="viewcode-block" id="add_panorama_alert"><a class="viewcode-back" href="../skyline.html#skyline_functions.add_panorama_alert">[docs]</a><span class="k">def</span> <span class="nf">add_panorama_alert</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send an event to Panorama to update an anomaly as alerted on.</span>

<span class="sd">    :param current_skyline_app: the Skyline app that is calling the function</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :param anomaly_timestamp: The anomaly timestamp</span>
<span class="sd">    :type base_name: int</span>
<span class="sd">    :param base_name: The metric base_name</span>
<span class="sd">    :type base_name: str</span>
<span class="sd">    :return: boolean</span>
<span class="sd">    :rtype: boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: add_panorama_alert - get_redis_conn failed&#39;</span><span class="p">)</span>

    <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.alert.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
    <span class="n">cache_key_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())]</span>
    <span class="k">if</span> <span class="n">REDIS_CONN</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mi">86400</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_key_value</span><span class="p">))</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;added Panorama alert Redis key - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_key_value</span><span class="p">)))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: failed to add Panorama alert Redis key - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_key_value</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;error :: failed to add Panorama alert Redis key - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">, no REDIS_CONN&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_key_value</span><span class="p">)))</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># @added 20200912 - Branch #3068: SNAB</span>
<span class="c1">#                   Info #3742: matrixprofile</span>
<span class="c1">#                   Task #3744: POC matrixprofile</span>
<span class="c1">#                   Info #2726: pytsmp</span>
<span class="c1">#                   Info #1792: Shapelet extraction</span>
<div class="viewcode-block" id="update_item_in_redis_set"><a class="viewcode-back" href="../skyline.html#skyline_functions.update_item_in_redis_set">[docs]</a><span class="k">def</span> <span class="nf">update_item_in_redis_set</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">redis_set</span><span class="p">,</span> <span class="n">original_item</span><span class="p">,</span> <span class="n">updated_item</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update a list, dict or str item in a Redis set.</span>

<span class="sd">    :param current_skyline_app: the Skyline app calling the function</span>
<span class="sd">    :param redis_set: the Redis set to operate on</span>
<span class="sd">    :param original_item: the original set item, this must be the object in the</span>
<span class="sd">        set if it is a list use the list, if it is a dict use the dict, only</span>
<span class="sd">        use a str if the item is a string.</span>
<span class="sd">    :param updated_item: the updated set item, the list, dict or str</span>
<span class="sd">    :param log: whether to write the update details to log</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type redis_set: str</span>
<span class="sd">    :type original_item: object (list, dict or a str)</span>
<span class="sd">    :type updated_item: object (list, dict or a str)</span>
<span class="sd">    :type log: boolean</span>
<span class="sd">    :return: boolean</span>
<span class="sd">    :rtype: boolean</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
        <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_item_in_redis_set - failed to set up log&#39;</span><span class="p">)</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_item_in_redis_set - get_redis_conn failed&#39;</span><span class="p">)</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">REDIS_CONN</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">original_item</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed item from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">original_item</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove item from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">redis_set</span><span class="p">))</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">updated_item</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added updated check_details item to Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">updated_item</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove item from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">redis_set</span><span class="p">))</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">return_value</span></div>


<span class="c1"># @added 20201009 - Feature #3780: skyline_functions - sanitise_graphite_url</span>
<span class="c1">#                   Bug #3778: Handle single encoded forward slash requests to Graphite</span>
<div class="viewcode-block" id="sanitise_graphite_url"><a class="viewcode-back" href="../skyline.html#skyline_functions.sanitise_graphite_url">[docs]</a><span class="k">def</span> <span class="nf">sanitise_graphite_url</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">graphite_url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform any targets in the URL that need modifications like double encoded</span>
<span class="sd">    forward slash and return whether the URL was sanitised and the url.</span>

<span class="sd">    :param current_skyline_app: the Skyline app calling the function</span>
<span class="sd">    :param graphite_url: the URL</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type graphite_url: str</span>
<span class="sd">    :return: sanitised, url</span>
<span class="sd">    :rtype: tuple</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sanitised_url</span> <span class="o">=</span> <span class="n">graphite_url</span>
    <span class="n">sanitised</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s1">&#39;.</span><span class="si">%2F</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">sanitised_url</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sanitised_url</span> <span class="o">=</span> <span class="n">graphite_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.</span><span class="si">%2F</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;.</span><span class="si">%252F</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sanitised</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
                <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">current_logger</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sanitise_graphite_url - transformed </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">graphite_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_url</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">graphite_url</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_sanitised_url</span> <span class="o">=</span> <span class="n">sanitised_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;%2B&#39;</span><span class="p">)</span>
            <span class="n">sanitised_url</span> <span class="o">=</span> <span class="n">new_sanitised_url</span>
            <span class="n">sanitised</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
                <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">current_logger</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sanitise_graphite_url - transformed </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">graphite_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sanitised_url</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">sanitised</span><span class="p">,</span> <span class="n">sanitised_url</span></div>


<span class="c1"># @added 20201012 - Feature #3780: skyline_functions - sanitise_graphite_url</span>
<div class="viewcode-block" id="encode_graphite_metric_name"><a class="viewcode-back" href="../skyline.html#skyline_functions.encode_graphite_metric_name">[docs]</a><span class="k">def</span> <span class="nf">encode_graphite_metric_name</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform a metric name into a Graphite compliant encoded url name</span>

<span class="sd">    :param current_skyline_app: the Skyline app calling the function</span>
<span class="sd">    :param metric: the base_name</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type metric: str</span>
<span class="sd">    :return: encoded_graphite_metric_name</span>
<span class="sd">    :rtype: str</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">encoded_graphite_metric_name</span> <span class="o">=</span> <span class="n">metric</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># import urllib.parse</span>
    <span class="c1"># encoded_graphite_metric_name = urllib.parse.quote(encoded_graphite_metric_name)</span>

    <span class="c1"># Double encode forward slash</span>
    <span class="k">if</span> <span class="s1">&#39;</span><span class="si">%2F</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">encoded_graphite_metric_name</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encoded_graphite_metric_name</span> <span class="o">=</span> <span class="n">encoded_graphite_metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%2F</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%252F</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
                <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">current_logger</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;encode_graphite_metric_name - transformed </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">encoded_graphite_metric_name</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># Encode +</span>
    <span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">encoded_graphite_metric_name</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encoded_graphite_metric_name</span> <span class="o">=</span> <span class="n">encoded_graphite_metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;%2B&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
                <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">current_logger</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;encode_graphite_metric_name - transformed </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">encoded_graphite_metric_name</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># Double encode colons</span>
    <span class="k">if</span> <span class="s1">&#39;%3A&#39;</span> <span class="ow">in</span> <span class="n">encoded_graphite_metric_name</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encoded_graphite_metric_name</span> <span class="o">=</span> <span class="n">encoded_graphite_metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%3A&#39;</span><span class="p">,</span> <span class="s1">&#39;%253A&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
                <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">current_logger</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;encode_graphite_metric_name - transformed </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">encoded_graphite_metric_name</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">encoded_graphite_metric_name</span></div>

<span class="c1"># @added 20201202- Feature #3858: skyline_functions - correlate_or_relate_with</span>
<span class="c1"># @modified 20220504 - Task #4544: Handle EXTERNAL_SETTINGS in correlate_or_relate_with</span>
<span class="c1">#                      Feature #3858: skyline_functions - correlate_or_relate_with</span>
<span class="c1"># Moved to functions.metrics.correlate_or_relate_with to handle external_settings</span>
<span class="c1"># def correlate_or_relate_with(current_skyline_app, metric, metric_to_correlate_or_relate):</span>

<span class="c1"># @added 20210323 - Feature #3642: Anomaly type classification</span>
<span class="c1"># @modified 20220722 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                      Branch #4300: prometheus</span>
<span class="c1"># Moved to function.panorama.get_anomaly_id</span>
<span class="c1"># def get_anomaly_id(current_skyline_app, base_name, timestamp):</span>


<span class="c1"># @added 20210324 - Feature #3642: Anomaly type classification</span>
<div class="viewcode-block" id="get_anomaly_type"><a class="viewcode-back" href="../skyline.html#skyline_functions.get_anomaly_type">[docs]</a><span class="k">def</span> <span class="nf">get_anomaly_type</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">anomaly_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an anomaly id return any classified types</span>

<span class="sd">    :param current_skyline_app: the Skyline app calling the function</span>
<span class="sd">    :param anomaly_id: the anomaly id</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type anomaly_id: int</span>
<span class="sd">    :return: (anomaly_type_list, anomaly_type_id_list)</span>
<span class="sd">    :rtype: tuple</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">anomaly_type_id_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">anomaly_type_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
        <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">anomaly_type_ids</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_anomaly_type :: could not get a MySQL engine - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">anomalies_type_table_meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
        <span class="n">anomalies_type_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;anomalies_type&#39;</span><span class="p">,</span> <span class="n">anomalies_type_table_meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_anomaly_type :: Table failed on anomalies_type table - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">err</span><span class="p">))</span>

    <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
    <span class="c1"># query = &#39;SELECT type from anomalies_type WHERE id=%s&#39; % str(anomaly_id)  # nosec</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="c1"># result = mysql_select(current_skyline_app, query)</span>
        <span class="c1"># if result:</span>
        <span class="c1">#     anomaly_type_ids = str(result[0][0])</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">anomalies_type_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">anomalies_type_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
            <span class="n">anomaly_type_ids</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_anomaly_type :: failed to get anomaly type for anomaly id </span><span class="si">%s</span><span class="s1"> from the db - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_anomaly_type :: engine_disposal failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">anomaly_type_ids</span><span class="p">:</span>
        <span class="n">anomaly_type_ids_str_list</span> <span class="o">=</span> <span class="n">anomaly_type_ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">anomaly_type_id</span> <span class="ow">in</span> <span class="n">anomaly_type_ids_str_list</span><span class="p">:</span>
            <span class="n">anomaly_type_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">anomaly_type_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">anomaly_type_id_list</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT id,algorithm,type FROM anomaly_types&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">mysql_select</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: querying MySQL - SELECT id,type FROM anomaly_types&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">associated_algorithm</span><span class="p">,</span> <span class="n">anomaly_type</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">anomaly_type_id_list</span><span class="p">:</span>
                <span class="n">anomaly_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anomaly_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">anomaly_type_list</span><span class="p">,</span> <span class="n">anomaly_type_id_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="mirage_load_metric_vars"><a class="viewcode-back" href="../skyline.html#skyline_functions.mirage_load_metric_vars">[docs]</a><span class="k">def</span> <span class="nf">mirage_load_metric_vars</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">metric_vars_file</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the mirage metric variables for a check from a metric check variables</span>
<span class="sd">    file</span>

<span class="sd">    :param metric_vars_file: the path and filename to the metric variables files</span>
<span class="sd">    :type metric_vars_file: str</span>
<span class="sd">    :return: the metric_vars list or ``False``</span>
<span class="sd">    :rtype: list</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
        <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">):</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;loading the mirage metric variables from metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;error :: loading metric variables from metric_check_file - file not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">metric_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">no_new_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">no_equal_line</span> <span class="o">=</span> <span class="n">no_new_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; = &#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">array</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">no_equal_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">add_line</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">metric_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_line</span><span class="p">)</span>

    <span class="c1"># Allow the check file to already hold a valid python list on one line</span>
    <span class="c1"># so that a check can be added by simply echoing to debug metric_vars</span>
    <span class="c1"># line from to log for any failed checks into a new Mirage check file</span>
    <span class="c1"># The original above pattern is still the default, this is for the check</span>
    <span class="c1"># files to be added by the operator from the log or for debugging.</span>
    <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">metric_vars</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># current_logger.info(&#39;metric_vars is not a list, set to try_literal_eval&#39;)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_vars</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># current_logger.info(&#39;metric_vars is not a list of lists, set to try_literal_eval&#39;)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># current_logger.info(&#39;metric_vars is not defined, set to try_literal_eval&#39;)</span>
    <span class="k">if</span> <span class="n">try_literal_eval</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">metric_vars</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">metric_vars</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metric_vars not loaded with literal_eval&#39;</span><span class="p">)</span>
            <span class="n">metric_vars</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">string_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;added_by&#39;</span><span class="p">]</span>
    <span class="n">float_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">int_keys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;full_duration&#39;</span><span class="p">,</span>
        <span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">,</span> <span class="s1">&#39;added_at&#39;</span><span class="p">]</span>
    <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
    <span class="c1">#                   Task #3744: POC matrixprofile</span>
    <span class="n">boolean_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snab_only_check&#39;</span><span class="p">,</span> <span class="s1">&#39;graphite_metric&#39;</span><span class="p">,</span> <span class="s1">&#39;run_crucible_tests&#39;</span><span class="p">]</span>

    <span class="c1"># @added 20210304 - Feature #3642: Anomaly type classification</span>
    <span class="c1">#                   Feature #3970: custom_algorithm - adtk_level_shift</span>
    <span class="c1"># Added triggered_algorithms to mirage_check_file</span>
    <span class="n">list_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithms&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithms_run&#39;</span><span class="p">]</span>

    <span class="n">metric_vars_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars</span><span class="p">:</span>
        <span class="c1"># @modified 20181023 - Feature #2618: alert_slack</span>
        <span class="c1"># Wrapped in try except for debugging issue where the</span>
        <span class="c1"># hours_to_resolve was interpolating to hours_to_resolve = &quot;t&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">string_keys</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_value_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">float_keys</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_value_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">int_keys</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_value_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">))</span>
            <span class="c1"># @added 20200916 - Branch #3068: SNAB</span>
            <span class="c1">#                   Task #3744: POC matrixprofile</span>
            <span class="c1"># Handle new snab_only_check boolean</span>
            <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">boolean_keys</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># current_logger.debug(</span>
                <span class="c1">#     &#39;debug :: boolean key - key: %s, value: %s&#39; % (</span>
                <span class="c1">#         str(var_array[0]), str(var_array[1])))</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;&quot;True&quot;&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20210304 - Feature #3642: Anomaly type classification</span>
            <span class="c1">#                   Feature #3970: custom_algorithm - adtk_level_shift</span>
            <span class="c1"># Added triggered_algorithms to mirage_check_file</span>
            <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">list_keys</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># current_logger.debug(</span>
                <span class="c1">#     &#39;debug :: list key - key: %s, value: %s&#39; % (</span>
                <span class="c1">#         str(var_array[0]), str(var_array[1])))</span>
                <span class="n">_value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;error :: loading metric variables - failed to literal_eval list for </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">metric_vars_array</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_vars_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: loading metric variables - none found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load metric variables from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_vars_file</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># current_logger.debug(&#39;debug :: metric_vars for %s&#39; % str(metric))</span>
    <span class="c1"># current_logger.debug(&#39;debug :: %s&#39; % str(metric_vars_array))</span>

    <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
        <span class="n">metric_vars_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metric_vars_dict</span><span class="p">[</span><span class="s1">&#39;metric_vars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">metric_vars_array</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">metric_vars_dict</span><span class="p">[</span><span class="s1">&#39;metric_vars&#39;</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: metric_vars_dict: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_dict</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">metric_vars_dict</span>

    <span class="k">return</span> <span class="n">metric_vars_array</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>