<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>luminosity.cloudburst &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">luminosity.cloudburst</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for luminosity.cloudburst</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">strftime</span><span class="p">,</span> <span class="n">gmtime</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">kill</span><span class="p">,</span> <span class="n">getpid</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">msgpack</span> <span class="kn">import</span> <span class="n">Unpacker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">select</span>

<span class="kn">import</span> <span class="nn">settings</span>
<span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_redis_conn</span><span class="p">,</span> <span class="n">get_redis_conn_decoded</span><span class="p">,</span> <span class="n">nonNegativeDerivative</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">functions.redis.get_metric_timeseries</span> <span class="kn">import</span> <span class="n">get_metric_timeseries</span>
<span class="kn">from</span> <span class="nn">functions.graphite.get_metrics_timeseries</span> <span class="kn">import</span> <span class="n">get_metrics_timeseries</span>
<span class="kn">from</span> <span class="nn">custom_algorithms</span> <span class="kn">import</span> <span class="n">run_custom_algorithm_on_timeseries</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_engine</span><span class="p">,</span> <span class="n">cloudburst_table_meta</span><span class="p">,</span> <span class="n">ionosphere_matched_table_meta</span><span class="p">,</span>
    <span class="n">ionosphere_layers_matched_table_meta</span><span class="p">,</span> <span class="n">ionosphere_table_meta</span><span class="p">,</span>
    <span class="n">anomalies_table_meta</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.metric_id_from_base_name</span> <span class="kn">import</span> <span class="n">metric_id_from_base_name</span>
<span class="c1"># @added 20220913 - Feature #4662: settings.LUMINOSITY_CLOUDBURST_SKIP_METRICS</span>
<span class="c1">#                   Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="c1"># Allow for skipping of metrics</span>
<span class="kn">from</span> <span class="nn">matched_or_regexed_in_list</span> <span class="kn">import</span> <span class="n">matched_or_regexed_in_list</span>
<span class="kn">from</span> <span class="nn">functions.metrics.get_metric_ids_and_base_names</span> <span class="kn">import</span> <span class="n">get_metric_ids_and_base_names</span>

<span class="c1"># @added 20220920 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.strictly_increasing_monotonicity</span> <span class="kn">import</span> <span class="n">strictly_increasing_monotonicity</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.determine_data_frequency</span> <span class="kn">import</span> <span class="n">determine_data_frequency</span>
<span class="kn">from</span> <span class="nn">functions.luminosity.cloudburst_get_metric_ids_to_check</span> <span class="kn">import</span> <span class="n">cloudburst_get_metric_ids_to_check</span>
<span class="kn">from</span> <span class="nn">functions.victoriametrics.get_victoriametrics_metric</span> <span class="kn">import</span> <span class="n">get_victoriametrics_metric</span>
<span class="kn">from</span> <span class="nn">functions.timeseries.downsample</span> <span class="kn">import</span> <span class="n">downsample_timeseries</span>

<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;luminosity&#39;</span>
<span class="n">skyline_app_logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Log&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
<span class="n">skyline_app_logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
<span class="n">skyline_app_loglock</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">skyline_app_logwait</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wait&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>

<span class="n">this_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
    <span class="k">if</span> <span class="n">SERVER_METRIC_PATH</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">skyline_app_graphite_namespace</span> <span class="o">=</span> <span class="s1">&#39;skyline.</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">SERVER_METRIC_PATH</span><span class="p">)</span>

<span class="n">full_uniques</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">unique_metrics&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span>
<span class="n">LOCAL_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">current_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span>

<span class="n">LUMINOSITY_CLOUDBURST_OPTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s1">&#39;nth_median&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s1">&#39;n_sigma&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">LUMINOSITY_CLOUDBURST_PROCESSES</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">LUMINOSITY_CLOUDBURST_PROCESSES</span>
<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
    <span class="n">LUMINOSITY_CLOUDBURST_PROCESSES</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">LUMINOSITY_CLOUDBURST_PROCESSES</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">run_every</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">LUMINOSITY_CLOUDBURST_RUN_EVERY</span>
<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
    <span class="n">run_every</span> <span class="o">=</span> <span class="mi">900</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">run_every</span> <span class="o">=</span> <span class="mi">900</span>

<span class="c1"># @added 20220913 - Feature #4662: settings.LUMINOSITY_CLOUDBURST_SKIP_METRICS</span>
<span class="c1">#                   Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="c1"># Allow for skipping of metrics</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">LUMINOSITY_CLOUDBURST_SKIP_METRICS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">LUMINOSITY_CLOUDBURST_SKIP_METRICS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">LUMINOSITY_CLOUDBURST_SKIP_METRICS</span> <span class="o">=</span> <span class="p">[]</span>


<span class="c1"># @added 20210730 - Feature #4164: luminosity - cloudbursts</span>
<div class="viewcode-block" id="Cloudburst"><a class="viewcode-back" href="../../skyline.luminosity.html#luminosity.cloudburst.Cloudburst">[docs]</a><span class="k">class</span> <span class="nc">Cloudburst</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Cloudbursts class which controls the luminosity/cloudburst thread and</span>
<span class="sd">    spawned processes. luminosity/cloudburst analyses metrics to identify</span>
<span class="sd">    significant changepoints using the m66 algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_pid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Cloudburst</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Cloudburst</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span> <span class="o">=</span> <span class="n">parent_pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">()</span>

<div class="viewcode-block" id="Cloudburst.check_if_parent_is_alive"><a class="viewcode-back" href="../../skyline.luminosity.html#luminosity.cloudburst.Cloudburst.check_if_parent_is_alive">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_parent_is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Self explanatory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cloudburst.find_cloudbursts"><a class="viewcode-back" href="../../skyline.luminosity.html#luminosity.cloudburst.Cloudburst.find_cloudbursts">[docs]</a>    <span class="k">def</span> <span class="nf">find_cloudbursts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">unique_metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and manage the required lists and Redis sets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">process_number</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">spin_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: process </span><span class="si">%s</span><span class="s1"> started&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">process_number</span><span class="p">))</span>

        <span class="n">engine</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">get_an_engine</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;cloudburst :: find_cloudbursts :: failed to get MySQL engine - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get MySQL engine - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span>

        <span class="k">def</span> <span class="nf">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: calling engine.dispose() - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="n">last_run_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">luminosity_cloudburst_last_timestamp_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.last_run_timestamp.process.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">last_run_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">luminosity_cloudburst_last_timestamp_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get timestamp from </span><span class="si">%s</span><span class="s1"> Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">luminosity_cloudburst_last_timestamp_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">last_run_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">last_run_timestamp</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> Redis key has not expired, not running&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">luminosity_cloudburst_last_timestamp_key</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># Set Redis key</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">luminosity_cloudburst_last_timestamp_key</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed set timestamp for </span><span class="si">%s</span><span class="s1"> Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">luminosity_cloudburst_last_timestamp_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to determine unique_metrics from </span><span class="si">%s</span><span class="s1"> Redis key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">full_uniques</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># @added 20220913 - Feature #4662: settings.LUMINOSITY_CLOUDBURST_SKIP_METRICS</span>
        <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="c1"># Allow for skipping of metrics</span>
        <span class="n">ids_with_base_names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ids_with_base_names</span> <span class="o">=</span> <span class="n">get_metric_ids_and_base_names</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: get_metric_ids_and_base_names failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="n">base_names_with_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ids_with_base_names</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">base_names_with_ids</span><span class="p">[</span><span class="n">ids_with_base_names</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]]</span> <span class="o">=</span> <span class="n">metric_id</span>

        <span class="c1"># @added 20230105 - Feature #4792: functions.metrics_manager.manage_inactive_metrics</span>
        <span class="c1"># Skip trying to correlate inactive metrics</span>
        <span class="n">inactive_metric_id_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inactive_metric_id_strings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.inactive_metric_ids&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: smembers failed on aet.metrics_manager.inactive_metric_ids - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>

        <span class="n">filtered_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">LUMINOSITY_CLOUDBURST_SKIP_METRICS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: checking which of the </span><span class="si">%s</span><span class="s1"> metrics matched LUMINOSITY_CLOUDBURST_SKIP_METRICS&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">))))</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">ids_with_base_names</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))]</span>
                    <span class="c1"># @added 20230105 - Feature #4792: functions.metrics_manager.manage_inactive_metrics</span>
                    <span class="c1"># Skip trying to correlate inactive metrics</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric_id_str</span> <span class="ow">in</span> <span class="n">inactive_metric_id_strings</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">base_name</span><span class="p">,</span> <span class="s1">&#39;before pattern match - failed base_name lookup from id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pattern_match</span><span class="p">,</span> <span class="n">metric_matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">LUMINOSITY_CLOUDBURST_SKIP_METRICS</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">base_name</span><span class="p">,</span> <span class="s1">&#39;matched_or_regexed_in_list failed&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">filtered_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filtered_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: removing </span><span class="si">%s</span><span class="s1"> metrics which matched LUMINOSITY_CLOUDBURST_SKIP_METRICS&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_metrics</span><span class="p">))))</span>
                <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filtered_metrics</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">filtered_metrics</span>
                <span class="k">del</span> <span class="n">metric_matched_by</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: matched_or_regexed_in_list </span><span class="si">%s</span><span class="s1"> errors encountered, last error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>

        <span class="c1"># @added 20220919 - Feature #4674: cloudburst active events only</span>
        <span class="c1"># Only check metrics that have been active recently in the relevant</span>
        <span class="c1"># analyzer.illuminance.all.YYYY-MM-DD key/s handle day roll overs.</span>
        <span class="n">unique_metric_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">redis_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">redistimeseries_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unique_metric_ids_with_metric</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">unique_metric_ids_errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">redis_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                <span class="n">redistimeseries_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))</span>
                    <span class="n">unique_metric_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;unique_metric_ids failed base_name lookup from id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                    <span class="n">unique_metric_ids_errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">base_names_with_ids</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))</span>
                    <span class="n">unique_metric_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">base_name</span><span class="p">,</span> <span class="s1">&#39;unique_metric_ids failed id look up from base_name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                    <span class="n">unique_metric_ids_errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">unique_metric_ids_with_metric</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="k">if</span> <span class="n">unique_metric_ids_errors</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: unique_metric_ids_with_metric </span><span class="si">%s</span><span class="s1"> errors encountered, last error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>

        <span class="n">metric_ids_to_check</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_ids_to_check</span> <span class="o">=</span> <span class="n">cloudburst_get_metric_ids_to_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">unique_metric_ids</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: cloudburst_get_metric_ids_to_check failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: cloudburst_get_metric_ids_to_check found </span><span class="si">%s</span><span class="s1"> metrics with recent activity&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_ids_to_check</span><span class="p">))))</span>

        <span class="n">metrics_to_check</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">metrics_to_check_errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="n">metric_ids_to_check</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metrics_to_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_metric_ids_with_metric</span><span class="p">[</span><span class="n">metric_id</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric_id</span><span class="p">,</span> <span class="s1">&#39;metrics_to_check failed to append id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                <span class="n">metrics_to_check_errors</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">metrics_to_check_errors</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: metrics_to_check </span><span class="si">%s</span><span class="s1"> errors encountered, last error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>

        <span class="n">luminosity_cloudburst_errors_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.errors.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spin_start</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">luminosity_cloudburst_errors_key</span><span class="p">,</span> <span class="s1">&#39;determining metrics errors&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">luminosity_cloudburst_errors_key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">luminosity_cloudburst_errors_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metrics_to_check</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: no metrics found with recent activity to check&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> metrics found with recent activity to check&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_to_check</span><span class="p">))))</span>
        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics_to_check</span><span class="p">)</span>

        <span class="c1"># Discover assigned metrics</span>
        <span class="n">keys_per_processor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">LUMINOSITY_CLOUDBURST_PROCESSES</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">LUMINOSITY_CLOUDBURST_PROCESSES</span><span class="p">:</span>
            <span class="n">assigned_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">assigned_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">),</span> <span class="n">i</span> <span class="o">*</span> <span class="n">keys_per_processor</span><span class="p">)</span>
        <span class="n">assigned_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">keys_per_processor</span>
        <span class="n">assigned_keys</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">assigned_min</span><span class="p">,</span> <span class="n">assigned_max</span><span class="p">)</span>

        <span class="c1"># Compile assigned metrics</span>
        <span class="n">assigned_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique_metrics</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">assigned_keys</span><span class="p">]</span>
        <span class="n">use_mget</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># @added 20220920 - Feature #4674: cloudburst active events only</span>
        <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="n">assigned_redis_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">assigned_metrics</span> <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">)]</span>

        <span class="c1"># assigned_metrics = unique_metrics[500:503]</span>
        <span class="c1"># use_mget = False</span>

        <span class="c1"># align = True</span>
        <span class="n">truncate_last_datapoint</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">window</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">nth_median</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">n_sigma</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="c1"># long_period_high_res = True</span>
        <span class="n">long_period_high_res</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">custom_algorithm</span> <span class="o">=</span> <span class="s1">&#39;m66&#39;</span>
        <span class="n">algorithm_source</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/custom_algorithms/</span><span class="si">%s</span><span class="s1">.py&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">custom_algorithm</span><span class="p">)</span>
        <span class="n">m66_candidate_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">now_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
        <span class="n">key_reference_timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">now_timestamp</span><span class="p">)</span> <span class="o">//</span> <span class="n">run_every</span> <span class="o">*</span> <span class="n">run_every</span><span class="p">)</span>
        <span class="n">processed_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.processed_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_reference_timestamp</span><span class="p">)</span>
        <span class="n">cloudburst_info_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.info.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_reference_timestamp</span><span class="p">)</span>
        <span class="c1"># This key is NOT managed in metrics manager it is managed below</span>
        <span class="n">cloudburst_anomalies_processed_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.anomalies_processed&#39;</span>

        <span class="c1"># check_last = 3600</span>
        <span class="c1"># check_last = 5400</span>
        <span class="n">check_last</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
        <span class="c1"># check_last = 86400</span>

        <span class="n">long_period_check_last</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span>
        <span class="c1"># long_period_check_last = 86400</span>

        <span class="k">if</span> <span class="n">long_period_high_res</span><span class="p">:</span>
            <span class="n">long_period_check_last</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: checking </span><span class="si">%s</span><span class="s1"> metrics with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)),</span> <span class="n">custom_algorithm</span><span class="p">))</span>

        <span class="n">redis_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics_manager.resolutions&#39;</span>
        <span class="n">resolutions_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resolutions_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_hash_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: fail to query Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">redis_hash_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># Manage the luminosity.cloudburst.anomalies_processed delete entries</span>
        <span class="c1"># older than a week.  This Redis hash contains both short_period and</span>
        <span class="c1"># long_period identified AND processed metric timestamps to increase</span>
        <span class="c1"># efficiency in pushing short_period cloudbursts to second stage</span>
        <span class="c1"># analysis.</span>
        <span class="n">cloudburst_anomalies_processed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cloudburst_anomalies_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">cloudburst_anomalies_processed_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: fail to query Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">cloudburst_anomalies_processed_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cloudburst_anomalies_processed</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">key_ts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: fail to determine key_ts from key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key_ts</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="c1"># if key_ts &lt; (now_timestamp - (86400 * 7)):</span>
                <span class="k">if</span> <span class="n">key_ts</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">now_timestamp</span> <span class="o">-</span> <span class="n">long_period_check_last</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">cloudburst_anomalies_processed_key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: fail to delete </span><span class="si">%s</span><span class="s1"> from Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">cloudburst_anomalies_processed_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="n">raw_assigned</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">use_mget</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20220920 - Feature #4674: cloudburst active events only</span>
                <span class="c1">#                      Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                      Branch #4300: prometheus</span>
                <span class="c1"># raw_assigned = self.redis_conn.mget(assigned_metrics)</span>
                <span class="n">raw_assigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">mget</span><span class="p">(</span><span class="n">assigned_redis_metrics</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: got raw_assigned metric data from Redis for </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get raw_assigned from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20211012 - Feature #4280: aet.metrics_manager.derivative_metrics Redis hash</span>
                <span class="c1"># derivative_metrics = list(self.redis_conn_decoded.smembers(&#39;derivative_metrics&#39;))</span>
                <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get derivative_metrics from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">non_derivative_monotonic_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">NON_DERIVATIVE_MONOTONIC_METRICS</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get non_derivative_monotonic_metrics from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">non_derivative_monotonic_metrics</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">timer_start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">no_data</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">too_short</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">too_old</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">not_analysed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">analysed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">item_index</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">processed</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">processed</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: processed </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> metrics with </span><span class="si">%s</span><span class="s1"> algorithm, </span><span class="si">%s</span><span class="s1"> significant changepoint candidates at </span><span class="si">%s</span><span class="s1"> hours found so far&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">processed</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)),</span> <span class="n">custom_algorithm</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m66_candidate_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">check_last</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">))))</span>

            <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span>
            <span class="k">if</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>

            <span class="c1"># @added 20220920 - Feature #4674: cloudburst active events only</span>
            <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="n">labelled_metric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="n">labelled_metric</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">processed_metrics_key</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to add </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric_name</span><span class="p">,</span> <span class="n">processed_metrics_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># @modified 20220920 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                      Branch #4300: prometheus</span>
            <span class="c1"># if raw_assigned:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">labelled_metric</span> <span class="ow">and</span> <span class="n">raw_assigned</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="c1"># @modified 20220920 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                      Branch #4300: prometheus</span>
                    <span class="c1"># raw_series = raw_assigned[item_index]</span>
                    <span class="n">raw_series_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assigned_redis_metrics</span><span class="p">)</span> <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="n">metric_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">raw_series</span> <span class="o">=</span> <span class="n">raw_assigned</span><span class="p">[</span><span class="n">raw_series_index</span><span class="p">]</span>

                    <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">raw_series</span><span class="p">)</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpacker</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to unpack </span><span class="si">%s</span><span class="s1"> timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">metric_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">timeseries</span><span class="p">:</span>
                    <span class="n">calculate_derivative</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">derivative_metrics</span><span class="p">:</span>
                        <span class="n">calculate_derivative</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">non_derivative_monotonic_metrics</span><span class="p">:</span>
                        <span class="n">calculate_derivative</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">calculate_derivative</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">derivative_timeseries</span> <span class="o">=</span> <span class="n">nonNegativeDerivative</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">derivative_timeseries</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: nonNegativeDerivative failed on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">metric_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                            <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_metric_timeseries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: get_metric_timeseries failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># @added 20220920 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="k">if</span> <span class="n">labelled_metric</span><span class="p">:</span>
                    <span class="n">metric_resolution</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_resolution</span> <span class="o">=</span> <span class="n">determine_data_frequency</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="n">resolutions_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_resolution</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: determine_data_frequency failed on data from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">metric_resolution</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">metric_resolution</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">metric_resolution</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
                        <span class="n">resolutions_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">downsampled_timeseries</span> <span class="o">=</span> <span class="n">downsample_timeseries</span><span class="p">(</span><span class="s1">&#39;luminosity&#39;</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="n">metric_resolution</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">downsampled_timeseries</span><span class="p">:</span>
                                <span class="n">timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">downsampled_timeseries</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: downsample_timeseries failed on data from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">is_strictly_increasing_monotonicity</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_strictly_increasing_monotonicity</span> <span class="o">=</span> <span class="n">strictly_increasing_monotonicity</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: is_strictly_increasing_monotonicity failed on data from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">is_strictly_increasing_monotonicity</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">nonNegativeDerivative</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: nonNegativeDerivative failed on data from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
                <span class="n">no_data</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">too_short</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">timeseries_last_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">timeseries_last_timestamp</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">now_timestamp</span> <span class="o">-</span> <span class="p">(</span><span class="n">run_every</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)):</span>
                <span class="n">too_old</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">truncate_last_datapoint</span><span class="p">:</span>
                <span class="n">timeseries_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="mi">1</span><span class="p">:(</span><span class="n">timeseries_length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>

            <span class="n">resolution</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resolutions_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed get resolution for </span><span class="si">%s</span><span class="s1"> from resolutions_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">continue</span>

<span class="c1">#            first_timestamp = now_timestamp - (3600 * 4)</span>
<span class="c1">#            timeseries = [item for item in timeseries if int(item[0]) &gt;= first_timestamp]</span>

            <span class="n">aligned_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
                <span class="n">aligned_timeseries</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">//</span> <span class="n">resolution</span> <span class="o">*</span> <span class="n">resolution</span><span class="p">),</span> <span class="n">value</span><span class="p">])</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">aligned_timeseries</span>

            <span class="n">custom_check_last</span> <span class="o">=</span> <span class="n">check_last</span>
            <span class="n">window</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">if</span> <span class="n">resolution</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                <span class="n">custom_check_last</span> <span class="o">=</span> <span class="n">check_last</span> <span class="o">+</span> <span class="mi">1800</span>
                <span class="n">window</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">if</span> <span class="n">resolution</span> <span class="o">&gt;</span> <span class="mi">600</span><span class="p">:</span>
                <span class="n">custom_check_last</span> <span class="o">=</span> <span class="n">check_last</span> <span class="o">+</span> <span class="mi">3600</span>
                <span class="n">window</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">nth_median</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">n_sigma</span> <span class="o">=</span> <span class="mi">6</span>

            <span class="n">use_debug_logging</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">debug_algorithms</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">custom_algorithm_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;base_name&#39;</span><span class="p">:</span> <span class="n">base_name</span><span class="p">,</span>
                <span class="s1">&#39;algorithm_source&#39;</span><span class="p">:</span> <span class="n">algorithm_source</span><span class="p">,</span>
                <span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;nth_median&#39;</span><span class="p">:</span> <span class="n">nth_median</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">n_sigma</span><span class="p">,</span> <span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="n">window</span><span class="p">,</span>
                    <span class="s1">&#39;minimum_sparsity&#39;</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="n">resolution</span><span class="p">,</span>
                    <span class="s1">&#39;determine_duration&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;return_anomalies&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;save_plots_to&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;save_plots_to_absolute_dir&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;filename_prefix&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="n">use_debug_logging</span><span class="p">,</span>
                    <span class="s1">&#39;shift_to_start_of_window&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s1">&#39;max_execution_time&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s1">&#39;consensus&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;algorithms_allowed_in_consensus&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">custom_algorithm</span><span class="p">],</span>
                <span class="s1">&#39;run_3sigma_algorithms&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;run_before_3sigma&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;run_only_if_consensus&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;use_with&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">skyline_app</span><span class="p">],</span>
                <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="kc">False</span>
            <span class="p">}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">anomalyScore</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">anomalyScore</span><span class="p">,</span> <span class="n">anomalies</span> <span class="o">=</span> <span class="n">run_custom_algorithm_on_timeseries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="n">custom_algorithm</span><span class="p">,</span> <span class="n">custom_algorithm_dict</span><span class="p">,</span> <span class="n">debug_algorithms</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">debug_algorithms</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> -  result: </span><span class="si">%s</span><span class="s1">, anomalyScore: </span><span class="si">%s</span><span class="s1">, anomalies: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalyScore</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">anomalies</span><span class="p">))))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to run custom_algorithm </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">custom_algorithm</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">not_analysed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">analysed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">processed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">new_anomalies</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># @added 20230612 - Feature #4946: vortex - m66</span>
            <span class="c1"># Changed the m66 algorithm to return a results dict</span>
            <span class="c1"># like other custom algorithms that vortex can run,</span>
            <span class="c1"># making cloudburst backwards compatible</span>
            <span class="n">anomalies_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">anomalies</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anomalies</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">anomalies_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anomalies</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span>

            <span class="c1"># @added 20230612 - Feature #4946: vortex - m66</span>
            <span class="c1"># Changed the m66 algorithm to return a results dict</span>
            <span class="c1"># like other custom algorithms that vortex can run,</span>
            <span class="c1"># making cloudburst backwards compatible</span>
            <span class="k">if</span> <span class="n">anomalies_dict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">anomalies_dict</span><span class="p">[</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">anomalies_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ts</span><span class="p">,</span> <span class="n">anomalies_dict</span><span class="p">[</span><span class="s1">&#39;anomalies&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]])</span>

            <span class="c1"># @modified 20230612 - Feature #4946: vortex - m66</span>
            <span class="c1"># Changed the m66 algorithm to return a results dict</span>
            <span class="c1"># like other custom algorithms that vortex can run,</span>
            <span class="c1"># making cloudburst backwards compatible</span>
            <span class="c1"># if anomalies:</span>
            <span class="k">if</span> <span class="n">anomalies_list</span><span class="p">:</span>
                <span class="n">anomaly_timestamps</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">anomalies</span><span class="p">]</span>
                <span class="n">anomalies_present_in_period</span> <span class="o">=</span> <span class="p">[</span><span class="n">ts</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">anomaly_timestamps</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">now_timestamp</span> <span class="o">-</span> <span class="n">custom_check_last</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">anomalies_present_in_period</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">anomalies</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">anomalies_present_in_period</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">already_added</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">processed_anomaly_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">already_added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">cloudburst_anomalies_processed_key</span><span class="p">,</span> <span class="n">processed_anomaly_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed at determine already_added from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">processed_anomaly_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">already_added</span><span class="p">:</span>
                        <span class="n">new_anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_anomalies</span><span class="p">:</span>
                <span class="n">m66_candidate_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">m66_candidate_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">custom_algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">m66_candidate_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">custom_algorithm</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_anomalies</span>
        <span class="n">timer_end</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

        <span class="n">candidate_labelled_metrics_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">m66_candidate_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">)])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: found </span><span class="si">%s</span><span class="s1"> candidate_metrics (of which </span><span class="si">%s</span><span class="s1"> are labelled_matrics) with </span><span class="si">%s</span><span class="s1"> algorithm from </span><span class="si">%s</span><span class="s1"> processed metrics in </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m66_candidate_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">candidate_labelled_metrics_count</span><span class="p">),</span> <span class="n">custom_algorithm</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">processed</span><span class="p">),</span> <span class="p">(</span><span class="n">timer_end</span> <span class="o">-</span> <span class="n">timer_start</span><span class="p">)))</span>

        <span class="n">info_data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;processed&#39;</span><span class="p">:</span> <span class="n">processed</span><span class="p">,</span>
            <span class="s1">&#39;analysed&#39;</span><span class="p">:</span> <span class="n">analysed</span><span class="p">,</span>
            <span class="s1">&#39;not_analysed&#39;</span><span class="p">:</span> <span class="n">not_analysed</span><span class="p">,</span>
            <span class="s1">&#39;no_data&#39;</span><span class="p">:</span> <span class="n">no_data</span><span class="p">,</span>
            <span class="s1">&#39;too_short&#39;</span><span class="p">:</span> <span class="n">too_short</span><span class="p">,</span>
            <span class="s1">&#39;too_old&#39;</span><span class="p">:</span> <span class="n">too_old</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">cloudburst_info_key</span><span class="p">,</span> <span class="n">process_number</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_data_dict</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to add </span><span class="si">%s</span><span class="s1"> Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">info_data_dict</span><span class="p">),</span> <span class="n">cloudburst_info_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="n">candidate_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.candidate_metrics.short_period.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_reference_timestamp</span><span class="p">)</span>
        <span class="n">key_created</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">m66_candidate_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">candidate_metrics_key</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">m66_candidate_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">candidate_metrics_key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
                <span class="n">key_created</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to create </span><span class="si">%s</span><span class="s1"> Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">candidate_metrics_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key_created</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: created </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">candidate_metrics_key</span><span class="p">))</span>

        <span class="c1"># Second stage analysis, check to see if the changepoint is anomalous</span>
        <span class="c1"># at 7 days</span>
        <span class="n">second_stage_m66_candidate_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">timer_start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m66_candidate_metrics</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: checking </span><span class="si">%s</span><span class="s1"> candidate_metrics with </span><span class="si">%s</span><span class="s1"> algorithm at 7 days&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m66_candidate_metrics</span><span class="p">)),</span> <span class="n">custom_algorithm</span><span class="p">))</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now_timestamp</span><span class="p">)</span>
        <span class="n">window</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">summarize_intervalString</span> <span class="o">=</span> <span class="s1">&#39;15min&#39;</span>
        <span class="n">summarize_func</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span>
        <span class="n">nth_median</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">n_sigma</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="mi">900</span>

        <span class="k">if</span> <span class="n">long_period_high_res</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">nth_median</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">n_sigma</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="mi">60</span>

        <span class="n">truncate_last_datapoint</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">metrics_timeseries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metrics_to_do</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">m66_candidate_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_to_do</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">current_base_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_base_names</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_to_do</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">current_base_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics_to_do</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">metrics_functions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">truncate_last_datapoint</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20220920 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="n">victoriametrics_to_get</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">current_base_names</span><span class="p">:</span>

                <span class="c1"># @added 20220920 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="n">ids_with_base_names</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))]</span>
                        <span class="n">victoriametrics_to_get</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelled_metric_base_name</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;failed base_name lookup from id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)])</span>
                    <span class="k">continue</span>

                <span class="n">metrics_functions</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">long_period_high_res</span><span class="p">:</span>
                    <span class="n">metrics_functions</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;functions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">metrics_functions</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;functions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;summarize&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;intervalString&#39;</span><span class="p">:</span> <span class="n">summarize_intervalString</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">summarize_func</span><span class="p">}}</span>

                <span class="c1"># If the timeseries is summarized truncate the last datapoint</span>
                <span class="c1"># so it does not fall off a cliff</span>
                <span class="n">truncate_last_datapoint</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: metrics_functions </span><span class="si">%s</span><span class="s1"> errors encountered, last error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">luminosity_cloudburst_errors_key</span><span class="p">,</span> <span class="s1">&#39;metrics_functions errors&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">luminosity_cloudburst_errors_key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">luminosity_cloudburst_errors_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">metrics_timeseries</span> <span class="o">=</span> <span class="n">get_metrics_timeseries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metrics_functions</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: get_metrics_timeseries failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># @added 20220920 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="k">if</span> <span class="n">victoriametrics_to_get</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">victoriametrics_to_get</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">use_base_name</span> <span class="o">=</span> <span class="n">victoriametrics_to_get</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_victoriametrics_metric</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span>
                            <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: get_victoriametrics_metric failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">use_base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">timeseries</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metrics_timeseries</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">metrics_timeseries</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_base_name</span>
                            <span class="n">metrics_timeseries</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeseries</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed add timeseries to metrics_timeseries for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: cloudburst :: find_cloudbursts :: failed to retrieve timeseries from VictoriaMetrics for </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">base_name</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">current_base_names</span><span class="p">:</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">metrics_timeseries</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># @added 20220921 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="n">data_source</span> <span class="o">=</span> <span class="s1">&#39;Graphite&#39;</span>
                <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                    <span class="n">data_source</span> <span class="o">=</span> <span class="s1">&#39;VictoriaMetrics&#39;</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
                    <span class="c1"># @modified 20220506 - Feature #4164: luminosity - cloudbursts</span>
                    <span class="c1"># Change error to warning</span>
                    <span class="c1"># logger.error(&#39;error :: cloudburst :: find_cloudbursts :: no timeseries from Graphite for %s&#39; % base_name)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: cloudburst :: find_cloudbursts :: no timeseries from </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">base_name</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">truncate_last_datapoint</span><span class="p">:</span>
                    <span class="n">timeseries_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="mi">1</span><span class="p">:(</span><span class="n">timeseries_length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>

                <span class="k">if</span> <span class="n">long_period_high_res</span><span class="p">:</span>
                    <span class="n">aligned_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
                        <span class="n">aligned_timeseries</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">//</span> <span class="n">resolution</span> <span class="o">*</span> <span class="n">resolution</span><span class="p">),</span> <span class="n">value</span><span class="p">])</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">aligned_timeseries</span>

                <span class="n">some_debug</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">some_debug</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: cloudburst :: find_cloudbursts :: checking timeseries of length </span><span class="si">%s</span><span class="s1"> from Graphite for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)),</span> <span class="n">base_name</span><span class="p">))</span>

                <span class="n">custom_algorithm_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;base_name&#39;</span><span class="p">:</span> <span class="n">base_name</span><span class="p">,</span>
                    <span class="s1">&#39;algorithm_source&#39;</span><span class="p">:</span> <span class="n">algorithm_source</span><span class="p">,</span>
                    <span class="s1">&#39;algorithm_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;nth_median&#39;</span><span class="p">:</span> <span class="n">nth_median</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">n_sigma</span><span class="p">,</span> <span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="n">window</span><span class="p">,</span>
                        <span class="s1">&#39;minimum_sparsity&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="n">resolution</span><span class="p">,</span>
                        <span class="s1">&#39;determine_duration&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;return_anomalies&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;save_plots_to&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;save_plots_to_absolute_dir&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;filename_prefix&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;max_execution_time&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s1">&#39;consensus&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;algorithms_allowed_in_consensus&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">custom_algorithm</span><span class="p">],</span>
                    <span class="s1">&#39;run_3sigma_algorithms&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;run_before_3sigma&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;run_only_if_consensus&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;use_with&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">skyline_app</span><span class="p">],</span>
                    <span class="s1">&#39;debug_logging&#39;</span><span class="p">:</span> <span class="kc">False</span>
                <span class="p">}</span>
                <span class="n">debug_algorithms</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">anomalyScore</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">,</span> <span class="n">anomalyScore</span><span class="p">,</span> <span class="n">anomalies</span> <span class="o">=</span> <span class="n">run_custom_algorithm_on_timeseries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="n">custom_algorithm</span><span class="p">,</span> <span class="n">custom_algorithm_dict</span><span class="p">,</span> <span class="n">debug_algorithms</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">debug_algorithms</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> -  result: </span><span class="si">%s</span><span class="s1">, anomalyScore: </span><span class="si">%s</span><span class="s1">, anomalies: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalyScore</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">anomalies</span><span class="p">))))</span>
                    <span class="k">if</span> <span class="n">some_debug</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> -  result: </span><span class="si">%s</span><span class="s1">, anomalyScore: </span><span class="si">%s</span><span class="s1">, anomalies: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalyScore</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">anomalies</span><span class="p">))))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to run custom_algorithm </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">custom_algorithm</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="n">new_anomalies</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># @added 20230612 - Feature #4946: vortex - m66</span>
                <span class="c1"># Changed the m66 algorithm to return a results dict</span>
                <span class="c1"># like other custom algorithms that vortex can run,</span>
                <span class="c1"># making cloudburst backwards compatible</span>
                <span class="n">anomalies_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">anomalies</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anomalies</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">anomalies_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anomalies</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span>

                <span class="c1"># @added 20230612 - Feature #4946: vortex - m66</span>
                <span class="c1"># Changed the m66 algorithm to return a results dict</span>
                <span class="c1"># like other custom algorithms that vortex can run,</span>
                <span class="c1"># making cloudburst backwards compatible</span>
                <span class="k">if</span> <span class="n">anomalies_dict</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">anomalies_dict</span><span class="p">[</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">anomalies_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ts</span><span class="p">,</span> <span class="n">anomalies_dict</span><span class="p">[</span><span class="s1">&#39;anomalies&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]])</span>

                <span class="c1"># @modified 20230612 - Feature #4946: vortex - m66</span>
                <span class="c1"># Changed the m66 algorithm to return a results dict</span>
                <span class="c1"># like other custom algorithms that vortex can run,</span>
                <span class="c1"># making cloudburst backwards compatible</span>
                <span class="c1"># if anomalies:</span>
                <span class="k">if</span> <span class="n">anomalies_list</span><span class="p">:</span>
                    <span class="n">anomaly_timestamps</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">anomalies</span><span class="p">]</span>
                    <span class="n">anomalies_present_in_period</span> <span class="o">=</span> <span class="p">[</span><span class="n">ts</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">anomaly_timestamps</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">now_timestamp</span> <span class="o">-</span> <span class="n">long_period_check_last</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">anomalies_present_in_period</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">some_debug</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> has no cloudbursts in period&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">anomalies</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">anomalies_present_in_period</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">already_added</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">processed_anomaly_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">already_added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">cloudburst_anomalies_processed_key</span><span class="p">,</span> <span class="n">processed_anomaly_key</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed at determine already_added from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">processed_anomaly_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">already_added</span><span class="p">:</span>
                            <span class="n">new_anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">some_debug</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: cloudburst :: find_cloudbursts :: all </span><span class="si">%s</span><span class="s1"> cloudbursts in period for </span><span class="si">%s</span><span class="s1"> have already been processed&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)),</span> <span class="n">base_name</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">new_anomalies</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> found </span><span class="si">%s</span><span class="s1"> new anomalies in window - </span><span class="si">%s</span><span class="s1"> -  result: </span><span class="si">%s</span><span class="s1">, anomalyScore: </span><span class="si">%s</span><span class="s1">, anomalies: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">custom_algorithm</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_anomalies</span><span class="p">)),</span>
                        <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalyScore</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_anomalies</span><span class="p">))))</span>
                    <span class="n">second_stage_m66_candidate_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">second_stage_m66_candidate_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">custom_algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">second_stage_m66_candidate_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">custom_algorithm</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_anomalies</span>
        <span class="n">timer_end</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: found </span><span class="si">%s</span><span class="s1"> 2nd stage candidate_metrics with </span><span class="si">%s</span><span class="s1"> algorithm at 7 days from the 24 hour candidate metrics in </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">second_stage_m66_candidate_metrics</span><span class="p">)),</span> <span class="n">custom_algorithm</span><span class="p">,</span>
            <span class="p">(</span><span class="n">timer_end</span> <span class="o">-</span> <span class="n">timer_start</span><span class="p">)))</span>

        <span class="n">candidate_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.identified.long_period.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_reference_timestamp</span><span class="p">)</span>
        <span class="n">key_created</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">second_stage_m66_candidate_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">candidate_metrics_key</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_stage_m66_candidate_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">candidate_metrics_key</span><span class="p">,</span> <span class="mi">14400</span><span class="p">)</span>
                <span class="n">key_created</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to create </span><span class="si">%s</span><span class="s1"> Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">candidate_metrics_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key_created</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: created </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">candidate_metrics_key</span><span class="p">))</span>

        <span class="c1"># OK so...</span>
        <span class="c1"># Add to DB</span>
        <span class="c1"># eating-snow</span>
        <span class="c1"># https://soundcloud.com/user-76297227/eating-snow-this-emptiness-is-mine-andhim-remix-1?in_system_playlist=weekly%3A%3Aearthgecko</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">second_stage_m66_candidate_metrics</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: added </span><span class="si">%s</span><span class="s1"> 2nd stage candidate_metrics to </span><span class="si">%s</span><span class="s1"> Redis hash&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">second_stage_m66_candidate_metrics</span><span class="p">)),</span> <span class="n">candidate_metrics_key</span><span class="p">))</span>

        <span class="c1"># Define each cloudburst incident by each period in terms of a start</span>
        <span class="c1"># and end period of the cloudburst.  A period is defined by a</span>
        <span class="c1"># continuous triggering of m66, if there is a single m66 anomaly</span>
        <span class="c1"># triggered then the period will be from anomaly_timestamp, until</span>
        <span class="c1"># (anomaly_timestamp + resolution)</span>
        <span class="n">full_duration</span> <span class="o">=</span> <span class="n">until_timestamp</span> <span class="o">-</span> <span class="n">from_timestamp</span>
        <span class="n">found_cloudbursts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">second_stage_m66_candidate_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">anomalies</span> <span class="o">=</span> <span class="n">second_stage_m66_candidate_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">custom_algorithm</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span>
                <span class="n">initial_start_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomalies</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">start_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomalies</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">last_ts</span> <span class="o">=</span> <span class="n">start_ts</span>
                <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">anomalies</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">ts</span> <span class="o">==</span> <span class="n">initial_start_ts</span><span class="p">:</span>
                        <span class="n">last_ts</span> <span class="o">=</span> <span class="n">ts</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">ts</span> <span class="o">==</span> <span class="p">(</span><span class="n">last_ts</span> <span class="o">+</span> <span class="n">resolution</span><span class="p">):</span>
                        <span class="n">last_ts</span> <span class="o">=</span> <span class="n">ts</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">last_ts</span> <span class="o">+</span> <span class="n">resolution</span><span class="p">):</span>
                        <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution</span>
                        <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;full_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_duration</span>
                        <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_timestamp</span>
                        <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">until_timestamp</span>
                        <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_ts</span>
                        <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_ts</span>
                        <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_ts</span> <span class="o">-</span> <span class="n">start_ts</span>
                        <span class="c1"># This new timestamp that is more than one step from</span>
                        <span class="c1"># the last_ts defines the start of a new period</span>
                        <span class="n">start_ts</span> <span class="o">=</span> <span class="n">ts</span>
                    <span class="n">last_ts</span> <span class="o">=</span> <span class="n">ts</span>
                <span class="k">if</span> <span class="n">initial_start_ts</span> <span class="o">==</span> <span class="n">last_ts</span><span class="p">:</span>
                    <span class="n">last_ts</span> <span class="o">=</span> <span class="n">initial_start_ts</span> <span class="o">+</span> <span class="n">resolution</span>
                <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution</span>
                <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;full_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_duration</span>
                <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_timestamp</span>
                <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">until_timestamp</span>
                <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_ts</span>
                <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_ts</span>
                <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">start_ts</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_ts</span> <span class="o">-</span> <span class="n">start_ts</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> cloudburst periods identified for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">])),</span> <span class="n">base_name</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to add </span><span class="si">%s</span><span class="s1"> to found_cloudbursts dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="n">new_cloudburst_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">known_cloudbursts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">matches_in_period</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;fp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">matched_metric_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">found_metric_cloudbursts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">period_anomalies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cloudburst_metrics_key_created</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_cloudbursts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_an_engine</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not get a MySQL engine to update cloudburst table - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: engine not obtained to update cloudburst table&#39;</span><span class="p">)</span>

            <span class="n">cloudburst_table</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cloudburst_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">cloudburst_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: cloudburst_table OK&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get cloudburst_table meta - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">cloudburst_table</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">cloudburst_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: cloudburst_table not defined&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20210819 - Feature #4164: luminosity - cloudbursts</span>
            <span class="c1"># Determine first matched id in period to reduce the</span>
            <span class="c1"># mysql.handler_read_next count from doing index scans and use</span>
            <span class="c1"># primary key instead</span>
            <span class="n">check_period</span> <span class="o">=</span> <span class="n">now_timestamp</span> <span class="o">-</span> <span class="n">long_period_check_last</span>
            <span class="n">first_cloudburst_id_in_period</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: determining first cloudburst id in period&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">cloudburst_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">])</span><span class="o">.</span>\
                    <span class="n">where</span><span class="p">(</span><span class="n">cloudburst_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">check_period</span><span class="p">)</span><span class="o">.</span>\
                    <span class="n">order_by</span><span class="p">(</span><span class="n">cloudburst_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">first_cloudburst_id_in_period</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not determine first cloudburst id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: first cloudburst id in the period is: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">first_cloudburst_id_in_period</span><span class="p">)))</span>

            <span class="n">cloudburst_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_reference_timestamp</span><span class="p">)</span>
            <span class="n">new_cloudburst_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">known_cloudbursts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">period_cloudbursts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># one_day_ago = now_timestamp - 86400</span>
            <span class="k">if</span> <span class="n">first_cloudburst_id_in_period</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="c1"># @modified 20210819 - Feature #4164: luminosity - cloudbursts</span>
                    <span class="c1"># Added end so that the period can be compared</span>
                    <span class="c1"># stmt = select([cloudburst_table.c.metric_id, cloudburst_table.c.timestamp, cloudburst_table.c.end]).\</span>
                    <span class="c1"># @modified 20210819 - Feature #4164: luminosity - cloudbursts</span>
                    <span class="c1"># Reduce the mysql.handler_read_next count from doing</span>
                    <span class="c1"># index scans and use primary key</span>
                    <span class="c1"># stmt = select([cloudburst_table.c.metric_id, cloudburst_table.c.timestamp, cloudburst_table.c.end]).\</span>
                    <span class="c1">#     where(cloudburst_table.c.timestamp &gt;= one_day_ago)</span>
                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">cloudburst_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_id</span><span class="p">,</span> <span class="n">cloudburst_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">cloudburst_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">end</span><span class="p">])</span><span class="o">.</span>\
                        <span class="n">where</span><span class="p">(</span><span class="n">cloudburst_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">first_cloudburst_id_in_period</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">metric_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">known_cloudbursts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">known_cloudbursts</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">known_timestamp</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                        <span class="c1"># known_cloudbursts[metric_id][known_timestamp] = metric_id</span>
                        <span class="c1"># @added 20210819 - Feature #4164: luminosity - cloudbursts</span>
                        <span class="n">known_cloudbursts</span><span class="p">[</span><span class="n">metric_id</span><span class="p">][</span><span class="n">known_timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">known_cloudbursts</span><span class="p">[</span><span class="n">metric_id</span><span class="p">][</span><span class="n">known_timestamp</span><span class="p">][</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>
                        <span class="n">known_cloudbursts</span><span class="p">[</span><span class="n">metric_id</span><span class="p">][</span><span class="n">known_timestamp</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
                        <span class="n">period_cloudbursts</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not get a MySQL engine to update cloudburst table - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: found </span><span class="si">%s</span><span class="s1"> cloudbursts recorded in the DB in the </span><span class="si">%s</span><span class="s1"> seconds period&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">period_cloudbursts</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_period_check_last</span><span class="p">)))</span>

<span class="c1">####</span>
<span class="c1"># ONLY make the DB queries if there are unknown cloudbursts</span>
            <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">found_cloudbursts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># logger.info(&#39;cloudburst :: find_cloudbursts :: checking cloudbursts to insert for %s&#39; % base_name)</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="n">metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get metric id for </span><span class="si">%s</span><span class="s1"> from db: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: checking cloudbursts to insert for </span><span class="si">%s</span><span class="s1"> with metric_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)))</span>
                <span class="n">known_metric_cloudburst_timestamps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">known_metric_cloudburst_timestamps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">known_cloudbursts</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">known_metric_cloudburst_timestamps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to determine known_metric_timestamps for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">too_old</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">now_timestamp</span> <span class="o">-</span> <span class="n">long_period_check_last</span><span class="p">):</span>
                            <span class="n">too_old</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="n">known_metric_cloudburst_timestamps</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: known cloudburst - skipping cloudburst at </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">))</span>
                            <span class="k">continue</span>
                        <span class="k">for</span> <span class="n">known_metric_cloudburst_timestamp</span> <span class="ow">in</span> <span class="n">known_metric_cloudburst_timestamps</span><span class="p">:</span>
                            <span class="n">end</span> <span class="o">=</span> <span class="n">known_cloudbursts</span><span class="p">[</span><span class="n">metric_id</span><span class="p">][</span><span class="n">known_metric_cloudburst_timestamp</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">known_metric_cloudburst_timestamp</span> <span class="ow">and</span> <span class="n">timestamp</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: known cloudburst - skipping cloudburst at </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">, found in a period of cloudburst starting at </span><span class="si">%s</span><span class="s1"> and ending </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">known_metric_cloudburst_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span><span class="p">)))</span>
                                <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">timestamp</span><span class="p">]</span>
                        <span class="c1"># @modified 20210819 - Feature #4164: luminosity - cloudbursts</span>
                        <span class="c1"># Added end so that the period can be compared</span>
                        <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">timestamp</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">found_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">timestamp</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: new cloudburst found for </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">timestamp</span><span class="p">])))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to determine if known cloudburst for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: all identified cloudbursts for </span><span class="si">%s</span><span class="s1"> are known and </span><span class="si">%s</span><span class="s1"> are too old&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">too_old</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> new cloudbursts for </span><span class="si">%s</span><span class="s1"> are not known&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))),</span> <span class="n">base_name</span><span class="p">))</span>

        <span class="c1"># Consolidate back to back periods</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">cloudburst_tss</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">c_index</span><span class="p">,</span> <span class="n">cloudburst_ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cloudburst_tss</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">c_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">cloudburst_ts</span> <span class="ow">in</span> <span class="n">merged</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">c2_index</span><span class="p">,</span> <span class="n">c_ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cloudburst_tss</span><span class="p">):</span>
                        <span class="c1"># if c2_index == 0:</span>
                        <span class="c1">#     continue</span>
                        <span class="k">if</span> <span class="n">c_ts</span> <span class="ow">in</span> <span class="n">merged</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">c2_index</span> <span class="o">==</span> <span class="n">c_index</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">c_start</span> <span class="o">=</span> <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">c_ts</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
                        <span class="n">c_end</span> <span class="o">=</span> <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">c_ts</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">cloudburst_ts</span> <span class="o">&gt;=</span> <span class="n">c_start</span> <span class="ow">and</span> <span class="n">cloudburst_ts</span> <span class="o">&lt;=</span> <span class="n">c_end</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> falls within period of (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cloudburst_ts</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">c_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">c_end</span><span class="p">)))</span>
                            <span class="n">ts_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ts</span> <span class="k">for</span> <span class="n">c_i</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cloudburst_tss</span><span class="p">)</span> <span class="k">if</span> <span class="n">c_i</span> <span class="o">==</span> <span class="n">c2_index</span><span class="p">]</span>
                            <span class="n">ts</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># start = found_metric_cloudbursts[base_name][c_ts][&#39;start&#39;]</span>
                            <span class="n">end</span> <span class="o">=</span> <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">c_ts</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;merging </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">ts</span><span class="p">]),</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">])))</span>
                                <span class="n">new_end</span> <span class="o">=</span> <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">c_ts</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
                                <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_end</span>
                                <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_end</span> <span class="o">-</span> <span class="n">cloudburst_ts</span>
                                <span class="n">merge</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">merge</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">c_ts</span><span class="p">]</span>
                            <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_ts</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Determine what Ionosphere matches occurred in the cloudburst</span>
            <span class="c1"># period</span>
            <span class="c1"># SELECT id,layer_id,fp_id,metric_id,anomaly_timestamp FROM ionosphere_layers_matched WHERE anomaly_timestamp &gt; (now_timestamp - long_period_check_last)</span>
            <span class="c1"># SELECT id,fp_id,metric_timestamp FROM ionosphere_matched WHERE metric_timestamp &gt; (now_timestamp - long_period_check_last)</span>
            <span class="n">newer_than_timestamp</span> <span class="o">=</span> <span class="n">now_timestamp</span> <span class="o">-</span> <span class="n">long_period_check_last</span>
            <span class="n">ionosphere_matched_table</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ionosphere_matched_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_matched_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: ionosphere_matched_table OK&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get ionosphere_matched_table meta - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">ionosphere_matched_table</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @modified 20210819 - Feature #4164: luminosity - cloudbursts</span>
            <span class="c1"># Reduce the mysql.handler_read_next count from doing index scans</span>
            <span class="c1"># when the query uses metric_timestamp &gt;= newer_than_timestamp, by</span>
            <span class="c1"># first identifying the firsted matched id in the period and then</span>
            <span class="c1"># basing the query on id &gt;= first_matched_id_in_period, reduces the</span>
            <span class="c1"># handler_read_next from 242561</span>
            <span class="c1"># EXPLAIN SELECT ionosphere_matched.id, ionosphere_matched.fp_id, ionosphere_matched.metric_timestamp</span>
            <span class="c1"># FROM ionosphere_matched</span>
            <span class="c1"># WHERE ionosphere_matched.metric_timestamp &gt;= 1629272047&quot;</span>
            <span class="c1"># +------+-------------+--------------------+-------+---------------+--------------------------+---------+------+--------+--------------------------+</span>
            <span class="c1"># | id   | select_type | table              | type  | possible_keys | key                      | key_len | ref  | rows   | Extra                    |</span>
            <span class="c1"># +------+-------------+--------------------+-------+---------------+--------------------------+---------+------+--------+--------------------------+</span>
            <span class="c1"># |    1 | SIMPLE      | ionosphere_matched | index | NULL          | features_profile_matched | 13      | NULL | 242561 | Using where; Using index |</span>
            <span class="c1"># +------+-------------+--------------------+-------+---------------+--------------------------+---------+------+--------+--------------------------+</span>
            <span class="c1"># to 339</span>
            <span class="c1"># &quot;EXPLAIN SELECT id FROM ionosphere_matched WHERE metric_timestamp &gt;= 1629272047 ORDER BY id ASC LIMIT 1&quot;</span>
            <span class="c1"># +------+-------------+--------------------+-------+---------------+---------+---------+------+------+-------------+</span>
            <span class="c1"># | id   | select_type | table              | type  | possible_keys | key     | key_len | ref  | rows | Extra       |</span>
            <span class="c1"># +------+-------------+--------------------+-------+---------------+---------+---------+------+------+-------------+</span>
            <span class="c1"># |    1 | SIMPLE      | ionosphere_matched | index | NULL          | PRIMARY | 4       | NULL | 1    | Using where |</span>
            <span class="c1"># +------+-------------+--------------------+-------+---------------+---------+---------+------+------+-------------+</span>
            <span class="c1"># &quot;SELECT id FROM ionosphere_matched WHERE metric_timestamp &gt;= 1629272047 ORDER BY id ASC LIMIT 1&quot;</span>
            <span class="c1"># +--------+</span>
            <span class="c1"># | id     |</span>
            <span class="c1"># +--------+</span>
            <span class="c1"># | 249655 |</span>
            <span class="c1"># +--------+</span>
            <span class="c1"># &quot;EXPLAIN SELECT ionosphere_matched.id, ionosphere_matched.fp_id, ionosphere_matched.metric_timestamp</span>
            <span class="c1"># FROM ionosphere_matched</span>
            <span class="c1"># WHERE ionosphere_matched.id &gt;= 249655&quot;</span>
            <span class="c1"># +------+-------------+--------------------+-------+----------------------------------+--------------------------+---------+------+------+--------------------------+</span>
            <span class="c1"># | id   | select_type | table              | type  | possible_keys                    | key                      | key_len | ref  | rows | Extra                    |</span>
            <span class="c1"># +------+-------------+--------------------+-------+----------------------------------+--------------------------+---------+------+------+--------------------------+</span>
            <span class="c1"># |    1 | SIMPLE      | ionosphere_matched | range | PRIMARY,features_profile_matched | features_profile_matched | 4       | NULL | 338  | Using where; Using index |</span>
            <span class="c1"># +------+-------------+--------------------+-------+----------------------------------+--------------------------+---------+------+------+--------------------------+</span>
            <span class="c1"># Determine first matched id in period</span>
            <span class="n">first_matched_id_in_period</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: determining first ionosphere match id in period&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">ionosphere_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">])</span><span class="o">.</span>\
                    <span class="n">where</span><span class="p">(</span><span class="n">ionosphere_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_timestamp</span> <span class="o">&gt;=</span> <span class="n">newer_than_timestamp</span><span class="p">)</span><span class="o">.</span>\
                    <span class="n">order_by</span><span class="p">(</span><span class="n">ionosphere_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">first_matched_id_in_period</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not determine ionosphere matches - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: the first fp match id for the period is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">first_matched_id_in_period</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">first_matched_id_in_period</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: determining ionosphere matches in period&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="c1"># @modified 20210819 - Feature #4164: luminosity - cloudbursts</span>
                    <span class="c1"># Reduce the mysql.handler_read_next count from doing</span>
                    <span class="c1"># index scans and use primary key</span>
                    <span class="c1"># stmt = select([ionosphere_matched_table.c.id, ionosphere_matched_table.c.fp_id, ionosphere_matched_table.c.metric_timestamp]).\</span>
                    <span class="c1">#    where(ionosphere_matched_table.c.metric_timestamp &gt;= newer_than_timestamp)</span>
                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">ionosphere_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ionosphere_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fp_id</span><span class="p">,</span> <span class="n">ionosphere_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_timestamp</span><span class="p">])</span><span class="o">.</span>\
                        <span class="n">where</span><span class="p">(</span><span class="n">ionosphere_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">first_matched_id_in_period</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">match_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;fp&#39;</span><span class="p">][</span><span class="n">match_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;fp&#39;</span><span class="p">][</span><span class="n">match_id</span><span class="p">][</span><span class="s1">&#39;fp_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fp_id&#39;</span><span class="p">]</span>
                        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;fp&#39;</span><span class="p">][</span><span class="n">match_id</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;metric_timestamp&#39;</span><span class="p">]</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not determine ionosphere matches - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> Ionosphere fp matches recorded in the DB for the period&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;fp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())))))</span>

            <span class="n">ionosphere_layers_matched_table</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ionosphere_layers_matched_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_layers_matched_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: ionosphere_layers_matched_table OK&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get ionosphere_layers_matched_table meta - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">ionosphere_layers_matched_table</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20210819 - Feature #4164: luminosity - cloudbursts</span>
            <span class="c1"># Determine first matched id in period to reduce the</span>
            <span class="c1"># mysql.handler_read_next count from doing index scans and use</span>
            <span class="c1"># primary key instead</span>
            <span class="n">first_layers_matched_id_in_period</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: determining first ionosphere layers match id in period&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">ionosphere_layers_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">])</span><span class="o">.</span>\
                    <span class="n">where</span><span class="p">(</span><span class="n">ionosphere_layers_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_timestamp</span> <span class="o">&gt;=</span> <span class="n">newer_than_timestamp</span><span class="p">)</span><span class="o">.</span>\
                    <span class="n">order_by</span><span class="p">(</span><span class="n">ionosphere_layers_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">first_layers_matched_id_in_period</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not determine first ionosphere match id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: first ionosphere layers match id in the period is: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">first_layers_matched_id_in_period</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">first_layers_matched_id_in_period</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="c1"># @modified 20210819 - Feature #4164: luminosity - cloudbursts</span>
                    <span class="c1"># Reduce the mysql.handler_read_next count from doing</span>
                    <span class="c1"># index scans and use primary key</span>
                    <span class="c1"># stmt = select([ionosphere_layers_matched_table.c.id, ionosphere_layers_matched_table.c.layer_id, ionosphere_layers_matched_table.c.fp_id, ionosphere_layers_matched_table.c.metric_id, ionosphere_layers_matched_table.c.anomaly_timestamp]).\</span>
                    <span class="c1">#     where(ionosphere_layers_matched_table.c.anomaly_timestamp &gt;= newer_than_timestamp)</span>
                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">ionosphere_layers_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ionosphere_layers_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">layer_id</span><span class="p">,</span> <span class="n">ionosphere_layers_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fp_id</span><span class="p">,</span> <span class="n">ionosphere_layers_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_id</span><span class="p">,</span> <span class="n">ionosphere_layers_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_timestamp</span><span class="p">])</span><span class="o">.</span>\
                        <span class="n">where</span><span class="p">(</span><span class="n">ionosphere_layers_matched_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">first_layers_matched_id_in_period</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">match_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">][</span><span class="n">match_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">][</span><span class="n">match_id</span><span class="p">][</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_id</span>
                        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">][</span><span class="n">match_id</span><span class="p">][</span><span class="s1">&#39;layer_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;layer_id&#39;</span><span class="p">]</span>
                        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">][</span><span class="n">match_id</span><span class="p">][</span><span class="s1">&#39;fp_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fp_id&#39;</span><span class="p">]</span>
                        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">][</span><span class="n">match_id</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>
                        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">][</span><span class="n">match_id</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">]</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not determine ionosphere layers matches - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> Ionosphere layers matches recorded in the DB for the period&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())))))</span>

            <span class="c1"># matched_metric_ids = []</span>
            <span class="k">for</span> <span class="n">layer_match_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">matched_metric_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">][</span><span class="n">layer_match_id</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">])</span>

            <span class="c1"># Determine metric_id from the ionosphere table from fps of matches</span>
            <span class="c1"># but these are expensive queries, maybe not so much with IN</span>
            <span class="n">ionosphere_table</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ionosphere_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: ionosphere_table OK&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get ionosphere_table meta - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">ionosphere_table</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">fp_metric_ids_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">match_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;fp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># SELECT metric_id FROM</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">fp_id</span> <span class="o">=</span> <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;fp&#39;</span><span class="p">][</span><span class="n">match_id</span><span class="p">][</span><span class="s1">&#39;fp_id&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">ionosphere_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_id</span><span class="p">])</span><span class="o">.</span>\
                        <span class="n">where</span><span class="p">(</span><span class="n">ionosphere_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">fp_id</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>
                        <span class="n">matches_in_period</span><span class="p">[</span><span class="s1">&#39;fp&#39;</span><span class="p">][</span><span class="n">match_id</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>
                        <span class="n">fp_metric_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not determine metric_id from ionosphere - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">fp_metric_ids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fp_metric_ids_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">fp_metric_ids_list</span><span class="p">:</span>
                <span class="n">matched_metric_ids</span> <span class="o">=</span> <span class="n">matched_metric_ids</span> <span class="o">+</span> <span class="n">fp_metric_ids_list</span>
            <span class="n">matched_metric_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">matched_metric_ids</span><span class="p">))</span>

            <span class="n">anomalies_table</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomalies_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">anomalies_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: anomalies_table OK&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get anomalies_table meta - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">anomalies_table</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20210819 - Feature #4164: luminosity - cloudbursts</span>
            <span class="c1"># Determine first anomaly id in period to reduce the</span>
            <span class="c1"># mysql.handler_read_next count from doing index scans and use</span>
            <span class="c1"># primary key instead</span>
            <span class="n">first_anomaly_id_in_period</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: determining first anomaly id in period&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">])</span><span class="o">.</span>\
                    <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_timestamp</span> <span class="o">&gt;=</span> <span class="n">newer_than_timestamp</span><span class="p">)</span><span class="o">.</span>\
                    <span class="n">order_by</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">first_anomaly_id_in_period</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not determine first anomaly id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: first anomaly id in the period is: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">first_anomaly_id_in_period</span><span class="p">)))</span>

            <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">period_anomalies</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">first_anomaly_id_in_period</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="c1"># @modified 20210819 - Feature #4164: luminosity - cloudbursts</span>
                    <span class="c1"># Reduce the mysql.handler_read_next count from doing</span>
                    <span class="c1"># index scans and use primary key</span>
                    <span class="c1"># stmt = select([anomalies_table.c.id, anomalies_table.c.metric_id, anomalies_table.c.anomaly_timestamp, ]).\</span>
                    <span class="c1">#     where(anomalies_table.c.anomaly_timestamp &gt;= newer_than_timestamp)</span>
                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_id</span><span class="p">,</span> <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_timestamp</span><span class="p">,</span> <span class="p">])</span><span class="o">.</span>\
                        <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">first_anomaly_id_in_period</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">metric_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">period_anomalies</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">period_anomalies</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">anomaly_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                        <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">]</span>
                        <span class="n">period_anomalies</span><span class="p">[</span><span class="n">metric_id</span><span class="p">][</span><span class="n">anomaly_timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">period_anomalies</span><span class="p">[</span><span class="n">metric_id</span><span class="p">][</span><span class="n">anomaly_timestamp</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomaly_id</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not determine metric_id from ionosphere - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> anomalies found in the period&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">period_anomalies</span><span class="p">)))</span>

        <span class="n">found_cloudbursts_to_add</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1">#        cloudburst_metrics_key = &#39;luminosity.cloudburst.metrics.%s&#39; % str(key_reference_timestamp)</span>
<span class="c1">#        for base_name in list(found_cloudbursts.keys()):</span>
        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to get metric id for </span><span class="si">%s</span><span class="s1"> from db: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: checking anomalies and matches in period for </span><span class="si">%s</span><span class="s1"> with metric_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)))</span>

            <span class="c1"># Extract the matches for the metric and create a dictionary</span>
            <span class="c1"># based on the match timestamp not the match id.  Although there</span>
            <span class="c1"># are both fp and layer matches they will never have the same</span>
            <span class="c1"># timestamp because only a fp or a layer can match a potential</span>
            <span class="c1"># anomaly, not both.</span>
            <span class="n">metric_matches</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="n">matched_metric_ids</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">match_type</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">matches_in_period</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">for</span> <span class="n">match_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">matches_in_period</span><span class="p">[</span><span class="n">match_type</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">metric_id</span> <span class="o">==</span> <span class="n">matches_in_period</span><span class="p">[</span><span class="n">match_type</span><span class="p">][</span><span class="n">match_id</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_matches</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                    <span class="n">metric_matches</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="n">match_timestamp</span> <span class="o">=</span> <span class="n">matches_in_period</span><span class="p">[</span><span class="n">match_type</span><span class="p">][</span><span class="n">match_id</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                                <span class="n">metric_matches</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">match_timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches_in_period</span><span class="p">[</span><span class="n">match_type</span><span class="p">][</span><span class="n">match_id</span><span class="p">]</span>
                                <span class="n">metric_matches</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">match_timestamp</span><span class="p">][</span><span class="s1">&#39;match_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_type</span>
                                <span class="n">metric_matches</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">match_timestamp</span><span class="p">][</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_id</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to populate fmetric_matches for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="c1"># Sort by end timestamps?</span>
            <span class="k">for</span> <span class="n">cloudburst_ts</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">cloudburst_ts_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">((</span><span class="n">cloudburst_ts</span> <span class="o">-</span> <span class="n">resolution</span><span class="p">),</span> <span class="p">(</span><span class="n">cloudburst_ts</span> <span class="o">+</span> <span class="n">resolution</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;fp_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;layer_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;anomaly_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">metric_matches_present</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_matches_present</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metric_matches</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">metric_matches_present</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to determine if the are matches for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">metric_matches_present</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">matched_ts</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_matches</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="c1"># if matched_ts == cloudburst_ts:</span>
                            <span class="k">if</span> <span class="n">matched_ts</span> <span class="ow">in</span> <span class="n">cloudburst_ts_range</span><span class="p">:</span>
                                <span class="n">match_id</span> <span class="o">=</span> <span class="n">metric_matches</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">matched_ts</span><span class="p">][</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span>
                                <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_id</span>
                                <span class="n">match_type</span> <span class="o">=</span> <span class="n">metric_matches</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">matched_ts</span><span class="p">][</span><span class="s1">&#39;match_type&#39;</span><span class="p">]</span>
                                <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;fp_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_matches</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">matched_ts</span><span class="p">][</span><span class="s1">&#39;fp_id&#39;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">match_type</span> <span class="o">==</span> <span class="s1">&#39;layer&#39;</span><span class="p">:</span>
                                    <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;layer_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_matches</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">matched_ts</span><span class="p">][</span><span class="s1">&#39;layer_id&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to populate found_metric_cloudbursts for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

                <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># Use the period_anomalies single query rather than a query for</span>
                <span class="c1"># every cloudburst timestamp which index scans the anomalies</span>
                <span class="c1"># table and results in 700K mysql.handler_read_next operations,</span>
                <span class="c1"># Skyline eating its own performance monitoring dog food.</span>
                <span class="c1"># try:</span>
                <span class="c1">#     connection = engine.connect()</span>
                <span class="c1">#     stmt = select([anomalies_table.c.id]).\</span>
                <span class="c1">#         where(anomalies_table.c.anomaly_timestamp == cloudburst_ts).\</span>
                <span class="c1">#         where(anomalies_table.c.metric_id == metric_id)</span>
                <span class="c1">#     result = connection.execute(stmt)</span>
                <span class="c1">#     for row in result:</span>
                <span class="c1">#         anomaly_id = int(row[&#39;id&#39;])</span>
                <span class="c1">#     connection.close()</span>
                <span class="n">cloudburst_ts_range_start</span> <span class="o">=</span> <span class="n">cloudburst_ts</span> <span class="o">-</span> <span class="n">resolution</span>
                <span class="n">cloudburst_ts_range_end</span> <span class="o">=</span> <span class="n">cloudburst_ts</span> <span class="o">+</span> <span class="n">resolution</span>
                <span class="n">cloudburst_ts_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cloudburst_ts_range_start</span><span class="p">,</span> <span class="n">cloudburst_ts_range_end</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">period_anomalies</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">for</span> <span class="n">anomaly_timestamp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">period_anomalies</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">anomaly_timestamp</span> <span class="ow">in</span> <span class="n">cloudburst_ts_range</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">anomaly_id</span> <span class="o">=</span> <span class="n">period_anomalies</span><span class="p">[</span><span class="n">metric_id</span><span class="p">][</span><span class="n">anomaly_timestamp</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                                        <span class="k">break</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: cloudburst :: find_cloudbursts :: due to KeyError in period_anomalies[</span><span class="si">%s</span><span class="s1">][</span><span class="si">%s</span><span class="s1">] could not determine anomaly_id in cloudburst_ts_range (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">) for </span><span class="si">%s</span><span class="s1"> with metric_id </span><span class="si">%s</span><span class="s1"> from period_anomalies: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">),</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">cloudburst_ts_range_start</span><span class="p">),</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">cloudburst_ts_range_end</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">period_anomalies</span><span class="p">[</span><span class="n">metric_id</span><span class="p">])))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: due to KeyError in period_anomalies[</span><span class="si">%s</span><span class="s1">][</span><span class="si">%s</span><span class="s1">] could not determine anomaly_id in cloudburst_ts_range (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">) for </span><span class="si">%s</span><span class="s1"> with metric_id </span><span class="si">%s</span><span class="s1"> from period_anomalies: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">cloudburst_ts_range_start</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">cloudburst_ts_range_end</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">period_anomalies</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]),</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;anomaly_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomaly_id</span>

                <span class="k">if</span> <span class="n">base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">found_cloudbursts_to_add</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># This ensures that the longest cloudburst for the timestamp</span>
                <span class="c1"># will be recorded because multiple cloudburst anomalies</span>
                <span class="c1"># can be identified for a period but we only want to record</span>
                <span class="c1"># one, the last one for each timestamp, for example if this</span>
                <span class="c1"># not not done it results in:</span>
                <span class="c1"># +----+-----------+------------+------------+----------+----------------+------------+---------------+------------+----------+-------+----------+</span>
                <span class="c1"># | id | metric_id | timestamp  | end        | duration | from_timestamp | resolution | full_duration | anomaly_id | match_id | fp_id | layer_id |</span>
                <span class="c1"># +----+-----------+------------+------------+----------+----------------+------------+---------------+------------+----------+-------+----------+</span>
                <span class="c1"># | 87 |      1099 | 1628600400 | 1628171100 |     2700 |     1628068572 |        900 |        604800 |          0 |        0 |     0 |        0 |</span>
                <span class="c1"># | 88 |      1099 | 1628600400 | 1628343900 |     3600 |     1628068572 |        900 |        604800 |          0 |        0 |     0 |        0 |</span>
                <span class="c1"># +----+-----------+------------+------------+----------+----------------+------------+---------------+------------+----------+-------+----------+</span>
                <span class="c1"># Here a cloudburt was identified at 1628600400</span>
                <span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">found_metric_cloudbursts</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">]</span>

                <span class="c1"># BREAK OUT HERE - before inserting into DB - testing</span>
                <span class="c1"># continue</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> found_cloudbursts_to_add&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">found_cloudbursts_to_add</span><span class="p">))))</span>

        <span class="n">db_added_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">found_cloudbursts_to_add</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1"># Sort by newest timestamps first</span>
            <span class="c1"># cloudburst_tss = sorted(list(found_cloudbursts_to_add[base_name].keys()), reverse=True)</span>
            <span class="n">cloudburst_tss</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">cloudburst_ts</span> <span class="ow">in</span> <span class="n">cloudburst_tss</span><span class="p">:</span>
                <span class="c1"># if cloudburst_ts &gt; (now_timestamp - custom_check_last):</span>
                <span class="k">if</span> <span class="n">cloudburst_ts</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">now_timestamp</span> <span class="o">-</span> <span class="n">long_period_check_last</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">ts_added_for</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ts_added_for</span> <span class="o">=</span> <span class="n">known_cloudbursts</span><span class="p">[</span><span class="n">metric_id</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">ts_added_for</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not determine if cloudburst_ts was added to known_cloudbursts[metric_id][cloudburst_ts] - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">ts_added_for</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">ts_added_for</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: cloudburst at </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> is present in known_cloudbursts not adding to the DB&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">cloudburst_ts</span><span class="p">),</span> <span class="n">base_name</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="c1"># Do not just check timestamp, check to see if the cloudburst_ts</span>
                <span class="c1"># is between timestamp and end</span>
                <span class="c1"># So preprocess all the cloudbursts for a metric pre insertion</span>
                <span class="c1"># combining cloudburst that are next to each other and those</span>
                <span class="c1"># which overlap.  These detections describe the same event only</span>
                <span class="c1"># the event when detected in the next 5 minute run could</span>
                <span class="c1"># describe the event diferently as it is describing it in a</span>
                <span class="c1"># different dataset.  The dataset starts and ends 5 minutes</span>
                <span class="c1"># later therefore</span>

                <span class="n">new_cloudburst_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: inserting cloudburst at </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">cloudburst_ts</span><span class="p">),</span> <span class="n">base_name</span><span class="p">))</span>
                    <span class="n">end_ts</span> <span class="o">=</span> <span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
                    <span class="n">from_ts</span> <span class="o">=</span> <span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span>
                    <span class="n">resolution</span> <span class="o">=</span> <span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span>
                    <span class="n">full_duration</span> <span class="o">=</span> <span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;full_duration&#39;</span><span class="p">]</span>
                    <span class="n">match_id</span> <span class="o">=</span> <span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span>
                    <span class="n">fp_id</span> <span class="o">=</span> <span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;fp_id&#39;</span><span class="p">]</span>
                    <span class="n">layer_id</span> <span class="o">=</span> <span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;layer_id&#39;</span><span class="p">]</span>
                    <span class="n">anomaly_id</span> <span class="o">=</span> <span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">][</span><span class="s1">&#39;anomaly_id&#39;</span><span class="p">]</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="n">ins</span> <span class="o">=</span> <span class="n">cloudburst_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
                        <span class="n">metric_id</span><span class="o">=</span><span class="n">metric_id</span><span class="p">,</span>
                        <span class="n">timestamp</span><span class="o">=</span><span class="n">cloudburst_ts</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_ts</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                        <span class="n">from_timestamp</span><span class="o">=</span><span class="n">from_ts</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                        <span class="n">full_duration</span><span class="o">=</span><span class="n">full_duration</span><span class="p">,</span> <span class="n">match_id</span><span class="o">=</span><span class="n">match_id</span><span class="p">,</span>
                        <span class="n">fp_id</span><span class="o">=</span><span class="n">fp_id</span><span class="p">,</span> <span class="n">layer_id</span><span class="o">=</span><span class="n">layer_id</span><span class="p">,</span>
                        <span class="n">anomaly_id</span><span class="o">=</span><span class="n">anomaly_id</span><span class="p">,</span> <span class="n">added_at</span><span class="o">=</span><span class="n">db_added_at</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ins</span><span class="p">)</span>
                    <span class="n">new_cloudburst_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">inserted_primary_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">new_cloudburst_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_cloudburst_id</span><span class="p">)</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: could not insert cloudburst record into DB for </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">]),</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">new_cloudburst_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">cloudburst_metrics_key</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">found_cloudbursts_to_add</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">]))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">cloudburst_metrics_key</span><span class="p">,</span> <span class="mi">604800</span><span class="p">)</span>
                        <span class="n">cloudburst_metrics_key_created</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to add to </span><span class="si">%s</span><span class="s1"> Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">cloudburst_metrics_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="c1"># Add it to the known_cloudbursts dict</span>
                    <span class="k">if</span> <span class="n">metric_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">known_cloudbursts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">known_cloudbursts</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">known_cloudbursts</span><span class="p">[</span><span class="n">metric_id</span><span class="p">][</span><span class="n">cloudburst_ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>

                <span class="c1"># Add both short_period and long_period timestamp keys to</span>
                <span class="c1"># the luminosity.cloudburst.processed.anomalies Redis hash</span>
                <span class="c1"># key so that the timestamps identified in later short_period</span>
                <span class="c1"># analysis can be looked up and skipped if already processed</span>
                <span class="c1"># rather than sent through to the second stage to improve</span>
                <span class="c1"># efficiency.</span>
                <span class="n">processed_timestamps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">short_period_anomalies</span> <span class="o">=</span> <span class="n">m66_candidate_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">custom_algorithm</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span>
                    <span class="n">processed_timestamps</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">short_period_anomalies</span><span class="p">]</span>
                    <span class="n">long_period_anomalies</span> <span class="o">=</span> <span class="n">second_stage_m66_candidate_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="n">custom_algorithm</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span>
                    <span class="n">long_period_processed_timestamps</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">long_period_anomalies</span><span class="p">]</span>
                    <span class="n">processed_timestamps</span> <span class="o">=</span> <span class="n">processed_timestamps</span> <span class="o">+</span> <span class="n">long_period_processed_timestamps</span>
                    <span class="n">processed_timestamps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">processed_timestamps</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to determine processed_timestamps for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">base_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">processed_timestamp</span> <span class="ow">in</span> <span class="n">processed_timestamps</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">key_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cloudburst_id&#39;</span><span class="p">:</span> <span class="n">new_cloudburst_id</span><span class="p">,</span> <span class="s1">&#39;processed_at&#39;</span><span class="p">:</span> <span class="n">now_timestamp</span><span class="p">}</span>
                        <span class="n">processed_anomaly_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">processed_timestamp</span><span class="p">)))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">cloudburst_anomalies_processed_key</span><span class="p">,</span> <span class="n">processed_anomaly_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_data</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: find_cloudbursts :: failed to add to </span><span class="si">%s</span><span class="s1"> Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">cloudburst_anomalies_processed_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cloudburst_metrics_key_created</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: created </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">cloudburst_metrics_key</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: added </span><span class="si">%s</span><span class="s1"> new cloudbursts to the database&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_cloudburst_ids</span><span class="p">))))</span>

        <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
            <span class="n">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

        <span class="n">spin_end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">spin_start</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: find_cloudbursts :: </span><span class="si">%s</span><span class="s1"> metrics took </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)),</span> <span class="n">spin_end</span><span class="p">))</span>

        <span class="c1"># cloudburst table</span>
        <span class="c1"># id, source_metric_id, timestamp, full_duration, resolution, processed</span>
        <span class="c1"># cloudbursts table</span>
        <span class="c1"># id, cloudburst_id, related_metric_id, ppscore_1, ppscore_2</span>
        <span class="c1"># Maybe do not just do ppscore maybe use ruptures to identify metrics</span>
        <span class="c1"># that have changespoints in the same window</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Cloudburst.run"><a class="viewcode-back" href="../../skyline.luminosity.html#luminosity.cloudburst.Cloudburst.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - Called when the process intializes.</span>

<span class="sd">        - Determine if Redis is up</span>

<span class="sd">        - Spawn a find_cloudbursts process to do analysis</span>

<span class="sd">        - Wait for the process to finish.</span>

<span class="sd">        - run_every 300 seconds</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Log management to prevent overwriting</span>
        <span class="c1"># Allow the bin/&lt;skyline_app&gt;.d to manage the log</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">log_wait_for</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="k">while</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">log_wait_for</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">log_wait_for</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;luminosity/cloudburst :: starting find_cloudbursts&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">SERVER_METRIC_PATH</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: luminosity/cloudburst :: settings.SERVER_METRICS_NAME is not declared in settings.py, defaults to </span><span class="se">\&#39;\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="c1"># Make sure Redis is up</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst cannot connect to redis at socket path </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst cannot connect to get_redis_conn - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Report app up</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;luminosity.cloudburst&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: could not update the Redis luminosity.cloudburst key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># Get all Redis metrics</span>
            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">full_uniques</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed get unique_metrics from </span><span class="si">%s</span><span class="s1"> Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">full_uniques</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># @added 20220920 - Feature #4662: settings.LUMINOSITY_CLOUDBURST_SKIP_METRICS</span>
            <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.unique_labelled_metrics&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed get unique_labelled_metrics from labelled_metrics.unique_labelled_metrics Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
                <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">unique_labelled_metrics</span><span class="p">:</span>
                <span class="n">unique_metrics</span> <span class="o">=</span> <span class="n">unique_metrics</span> <span class="o">+</span> <span class="n">unique_labelled_metrics</span>

            <span class="n">now_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="n">key_reference_timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">now_timestamp</span><span class="p">)</span> <span class="o">//</span> <span class="n">run_every</span> <span class="o">*</span> <span class="n">run_every</span><span class="p">)</span>
            <span class="n">processed_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.processed_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_reference_timestamp</span><span class="p">)</span>
            <span class="n">cloudburst_info_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.info.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_reference_timestamp</span><span class="p">)</span>

            <span class="c1"># Spawn processes</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">LUMINOSITY_CLOUDBURST_PROCESSES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: cloudburst :: skyline is set for more cores than needed.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_cloudbursts</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">unique_metrics</span><span class="p">))</span>
                    <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> find_cloudbursts processes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pid_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">LUMINOSITY_CLOUDBURST_PROCESSES</span><span class="p">)))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed to spawn find_cloudbursts process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># Self monitor processes and terminate if any find_cloudbursts</span>
            <span class="c1"># has run for longer than run_every - 10</span>
            <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">run_every</span> <span class="o">-</span> <span class="mi">10</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                    <span class="c1"># Just to avoid hogging the CPU</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># All the processes are done, break now.</span>
                    <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: </span><span class="si">%s</span><span class="s1"> find_cloudbursts processes completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">LUMINOSITY_CLOUDBURST_PROCESSES</span><span class="p">),</span> <span class="n">time_to_run</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: timed out, killing find_cloudbursts process&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: killing find_cloudbursts process&#39;</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: killed find_cloudbursts process&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: stopping find_cloudbursts - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())))</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed to stop find_cloudbursts - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="n">processed_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">processed_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">processed_metrics_key</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed get </span><span class="si">%s</span><span class="s1"> set from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">processed_metrics_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">processed_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">processed_metrics</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">processed_metrics_key</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed set expire on </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">processed_metrics_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

            <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">no_data</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">too_short</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">too_old</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">not_analysed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">analysed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cloudburst_info_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cloudburst_info_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">cloudburst_info_key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed get </span><span class="si">%s</span><span class="s1"> set from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">cloudburst_info_dict</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">cloudburst_info_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">cloudburst_info_dict</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">cloudburst_info_key</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed set expire on </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">cloudburst_info_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cloudburst_info_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">info_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">cloudburst_info_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed literal_eval cloudburst_info_dict[</span><span class="si">%s</span><span class="s1">] - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                        <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">info_dict</span><span class="p">:</span>
                        <span class="n">processed</span> <span class="o">+=</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">]</span>
                        <span class="n">no_data</span> <span class="o">+=</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;no_data&#39;</span><span class="p">]</span>
                        <span class="n">too_short</span> <span class="o">+=</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;too_short&#39;</span><span class="p">]</span>
                        <span class="n">too_old</span> <span class="o">+=</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;too_old&#39;</span><span class="p">]</span>
                        <span class="n">not_analysed</span> <span class="o">+=</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;not_analysed&#39;</span><span class="p">]</span>
                        <span class="n">analysed</span> <span class="o">+=</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;analysed&#39;</span><span class="p">]</span>
            <span class="n">info_data_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;processed&#39;</span><span class="p">:</span> <span class="n">processed</span><span class="p">,</span>
                <span class="s1">&#39;analysed&#39;</span><span class="p">:</span> <span class="n">analysed</span><span class="p">,</span>
                <span class="s1">&#39;not_analysed&#39;</span><span class="p">:</span> <span class="n">not_analysed</span><span class="p">,</span>
                <span class="s1">&#39;no_data&#39;</span><span class="p">:</span> <span class="n">no_data</span><span class="p">,</span>
                <span class="s1">&#39;too_short&#39;</span><span class="p">:</span> <span class="n">too_short</span><span class="p">,</span>
                <span class="s1">&#39;too_old&#39;</span><span class="p">:</span> <span class="n">too_old</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: info: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_data_dict</span><span class="p">))</span>

            <span class="c1"># @modified 20220920 - Feature #4674: cloudburst active events only</span>
            <span class="c1">#                      Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                      Branch #4300: prometheus</span>
            <span class="c1"># Only processing metrics with recent activity</span>
            <span class="n">process_all</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">process_all</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">unique_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">))</span>
                    <span class="n">processed_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">processed_metrics</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">unique_metrics_set</span> <span class="o">==</span> <span class="n">processed_metrics_set</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: all </span><span class="si">%s</span><span class="s1"> unique_metrics were processed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">not_processed_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.not_processed_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_reference_timestamp</span><span class="p">)</span>
                        <span class="n">not_processed_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">set_difference</span> <span class="o">=</span> <span class="n">unique_metrics_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">processed_metrics_set</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">set_difference</span><span class="p">:</span>
                            <span class="n">not_processed_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">not_processed_metrics_key</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed to add </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">metric_name</span><span class="p">,</span> <span class="n">not_processed_metrics_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">not_processed_metrics_key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed to set expire on </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">not_processed_metrics_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: cloudburst :: there are </span><span class="si">%s</span><span class="s1"> metrics that were not processed of the </span><span class="si">%s</span><span class="s1"> unique_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_processed_metrics</span><span class="p">)),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">))))</span>
                        <span class="k">del</span> <span class="n">set_difference</span>
                    <span class="k">del</span> <span class="n">unique_metrics_set</span>
                    <span class="k">del</span> <span class="n">processed_metrics_set</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed to determine whether the unique_metrics_set and processed_metrics_set are different - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">processed_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">processed_metrics</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: </span><span class="si">%s</span><span class="s1"> metrics were processed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_metrics_set</span><span class="p">)))</span>
                <span class="n">last_active_metrics_check_key</span> <span class="o">=</span> <span class="s1">&#39;luminosity.cloudburst.last_active_metrics_timestamp_check&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">last_active_metrics_check_key</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: fail to set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">last_active_metrics_check_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="n">process_runtime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span>
            <span class="k">if</span> <span class="n">process_runtime</span> <span class="o">&lt;</span> <span class="n">run_every</span><span class="p">:</span>
                <span class="n">sleep_for</span> <span class="o">=</span> <span class="p">(</span><span class="n">run_every</span> <span class="o">-</span> <span class="n">process_runtime</span><span class="p">)</span>

                <span class="n">process_runtime_now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span>
                <span class="n">sleep_for</span> <span class="o">=</span> <span class="p">(</span><span class="n">run_every</span> <span class="o">-</span> <span class="n">process_runtime_now</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cloudburst :: sleeping for </span><span class="si">%.2f</span><span class="s1"> seconds due to low run time...&#39;</span> <span class="o">%</span> <span class="n">sleep_for</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="n">sleep_for</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">sleep_for</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed to del sleep_for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">process_runtime</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cloudburst :: failed to del process_runtime - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>