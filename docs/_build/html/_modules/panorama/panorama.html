<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>panorama.panorama &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">panorama.panorama</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for panorama.panorama</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
<span class="c1"># Use Redis sets in place of Manager().list() to reduce memory and number of</span>
<span class="c1"># processes</span>
<span class="c1"># from multiprocessing import Process, Manager</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">kill</span><span class="p">,</span> <span class="n">getpid</span><span class="p">,</span> <span class="n">listdir</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">isfile</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

<span class="c1"># from redis import StrictRedis</span>
<span class="kn">from</span> <span class="nn">msgpack</span> <span class="kn">import</span> <span class="n">Unpacker</span><span class="p">,</span> <span class="n">packb</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">exit</span> <span class="k">as</span> <span class="n">sys_exit</span>
<span class="kn">import</span> <span class="nn">mysql.connector</span>
<span class="kn">from</span> <span class="nn">mysql.connector</span> <span class="kn">import</span> <span class="n">errorcode</span>

<span class="c1"># @added 20190502 - Branch #2646: slack</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">select</span>

<span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
<span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
<span class="c1"># Use sqlalchemy rather than string-based query construction</span>
<span class="c1"># Added Table and MetaData</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">MetaData</span>

<span class="kn">import</span> <span class="nn">settings</span>

<span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">fail_check</span><span class="p">,</span> <span class="n">mkdir_p</span><span class="p">,</span>
    <span class="c1"># @added 20191031 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                   Branch #3262: py3</span>
    <span class="c1"># Added a single functions to deal with Redis connection and the</span>
    <span class="c1"># charset=&#39;utf-8&#39;, decode_responses=True arguments required in py3</span>
    <span class="n">get_redis_conn</span><span class="p">,</span> <span class="n">get_redis_conn_decoded</span><span class="p">,</span>
    <span class="c1"># @added 20200413 - Feature #3486: analyzer_batch</span>
    <span class="c1">#                   Feature #3480: batch_processing</span>
    <span class="n">is_batch_metric</span><span class="p">)</span>

<span class="c1"># @added 20170115 - Feature #1854: Ionosphere learn - generations</span>
<span class="c1"># Added determination of the learn related variables so that any new metrics</span>
<span class="c1"># that Panorama adds to the Skyline database, it adds the default</span>
<span class="c1"># IONOSPHERE_LEARN_DEFAULT_ values or the namespace specific values matched</span>
<span class="c1"># from settings.IONOSPHERE_LEARN_NAMESPACE_CONFIG to the metric database</span>
<span class="c1"># entry.</span>
<span class="kn">from</span> <span class="nn">ionosphere_functions</span> <span class="kn">import</span> <span class="n">get_ionosphere_learn_details</span>

<span class="c1"># @added 20190502 - Branch #2646: slack</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_engine</span><span class="p">,</span> <span class="n">metrics_table_meta</span><span class="p">,</span> <span class="n">anomalies_table_meta</span><span class="p">,</span>
    <span class="c1"># @added 20200928 - Task #3748: POC SNAB</span>
    <span class="c1">#                   Branch #3068: SNAB</span>
    <span class="n">snab_table_meta</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># @added 20211001 - Feature #4268: Redis hash key - panorama.metrics.latest_anomaly</span>
<span class="c1">#                   Feature #4264: luminosity - cross_correlation_relationships</span>
<span class="kn">from</span> <span class="nn">functions.panorama.update_metric_latest_anomaly</span> <span class="kn">import</span> <span class="n">update_metric_latest_anomaly</span>

<span class="c1"># @added 20220722 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.metrics.get_base_name_from_labelled_metrics_name</span> <span class="kn">import</span> <span class="n">get_base_name_from_labelled_metrics_name</span>

<span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
<span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
<span class="c1"># Replace mysql_select for all metrics</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.get_all_db_metric_names</span> <span class="kn">import</span> <span class="n">get_all_db_metric_names</span>

<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;panorama&#39;</span>
<span class="n">skyline_app_logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Log&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
<span class="n">skyline_app_logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
<span class="n">skyline_app_loglock</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">skyline_app_logwait</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wait&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>

<span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">this_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Converting one settings variable into a local variable, just because it is a</span>
<span class="c1"># long string otherwise.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ENABLE_PANORAMA_DEBUG</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cannot determine ENABLE_PANORAMA_DEBUG from settings&#39;</span><span class="p">)</span>
    <span class="n">ENABLE_PANORAMA_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
    <span class="k">if</span> <span class="n">SERVER_METRIC_PATH</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># @added 20190523 - Branch #2646: slack</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">SLACK_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SLACK_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SLACK_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">skyline_app_graphite_namespace</span> <span class="o">=</span> <span class="s1">&#39;skyline.</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">SERVER_METRIC_PATH</span><span class="p">)</span>

<span class="n">failed_checks_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_failed&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span>

<span class="c1"># @added 20160907 - Handle Panorama stampede on restart after not running #26</span>
<span class="c1"># Allow to expire check if greater than PANORAMA_CHECK_MAX_AGE, backwards</span>
<span class="c1"># compatible</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">test_max_age_set</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_MAX_AGE</span>
    <span class="k">if</span> <span class="n">test_max_age_set</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">max_age</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">test_max_age_set</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">max_age</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">max_age_seconds</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_MAX_AGE</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">max_age</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">max_age_seconds</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">expired_checks_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_expired&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span>

<span class="c1"># @added 20200128 - Feature #3418: PANORAMA_CHECK_INTERVAL</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">PANORAMA_CHECK_INTERVAL</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_INTERVAL</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">PANORAMA_CHECK_INTERVAL</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># @added 20200204 - Feature #3442: Panorama - add metric to metrics table immediately</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20230204 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                      Branch #4300: prometheus</span>
    <span class="c1">#                      Feature #3442: Panorama - add metric to metrics table immediately</span>
    <span class="c1"># With the addition of analyzer/labelled_metrics, mirage/mirage_labelled_metrics,</span>
    <span class="c1"># and the plethora of changes that supporting the ingestion, storage and</span>
    <span class="c1"># analysis of labelled_metrics, Panorama now needs to insert the metrics as soon</span>
    <span class="c1"># as possible as they are not accepted by flux/prometheus/write until the new,</span>
    <span class="c1"># incoming metric/s have an id assigned to them.  Therefore as of v4.0.0 this</span>
    <span class="c1"># was set to True so that Panorama checks and inserts new metrics every 60</span>
    <span class="c1"># seconds.</span>
    <span class="c1"># PANORAMA_INSERT_METRICS_IMMEDIATELY = settings.PANORAMA_INSERT_METRICS_IMMEDIATELY</span>
    <span class="n">PANORAMA_INSERT_METRICS_IMMEDIATELY</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># PANORAMA_INSERT_METRICS_IMMEDIATELY = False</span>
    <span class="n">PANORAMA_INSERT_METRICS_IMMEDIATELY</span> <span class="o">=</span> <span class="kc">True</span>



<span class="c1"># @added 20200413 - Feature #3486: analyzer_batch</span>
<span class="c1">#                   Feature #3480: batch_processing</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="n">BATCH_PROCESSING</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">BATCH_PROCESSING</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20200606 - Bug #3572: Apply list to settings import</span>
    <span class="c1"># from settings import BATCH_PROCESSING_NAMESPACES</span>
    <span class="n">BATCH_PROCESSING_NAMESPACES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BATCH_PROCESSING_NAMESPACES</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">BATCH_PROCESSING_NAMESPACES</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20200929 - Task #3748: POC SNAB</span>
<span class="c1">#                   Branch #3068: SNAB</span>
<span class="c1"># If SNAB is enabled override PANORAMA_CHECK_INTERVAL</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">SNAB_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SNAB_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SNAB_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">SNAB_ENABLED</span><span class="p">:</span>
    <span class="n">PANORAMA_CHECK_INTERVAL</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Database configuration</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBUSER</span><span class="p">,</span>
          <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBUSERPASS</span><span class="p">,</span>
          <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBHOST</span><span class="p">,</span>
          <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBPORT</span><span class="p">,</span>
          <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DATABASE</span><span class="p">,</span>
          <span class="s1">&#39;raise_on_warnings&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>


<div class="viewcode-block" id="Panorama"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama">[docs]</a><span class="k">class</span> <span class="nc">Panorama</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Panorama class which controls the panorama thread and spawned processes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_pid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Panorama</span>

<span class="sd">        Create the :obj:`mysql_conn`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># @modified 20230110 - Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Changed to Python 3 style super without arguments</span>
        <span class="c1"># super(Panorama, self).__init__()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># @modified 20191031 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># Use get_redis_conn and get_redis_conn_decoded</span>
        <span class="c1"># if settings.REDIS_PASSWORD:</span>
        <span class="c1">#     self.redis_conn = StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self.redis_conn = StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>

        <span class="c1"># @added 20191031 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                   Branch #3262: py3</span>
        <span class="c1"># Added a single functions to deal with Redis connection and the</span>
        <span class="c1"># charset=&#39;utf-8&#39;, decode_responses=True arguments required in py3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span> <span class="o">=</span> <span class="n">parent_pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">()</span>
        <span class="c1"># @modified 20190522 - Task #3034: Reduce multiprocessing Manager list usage</span>
        <span class="c1">#                      Task #3032: Debug number of Python processes and memory use</span>
        <span class="c1">#                      Branch #3002: docker</span>
        <span class="c1"># Reduce amount of Manager instances that are used as each requires a</span>
        <span class="c1"># copy of entire memory to be copied into each subprocess so this</span>
        <span class="c1"># results in a python process per Manager instance, using as much</span>
        <span class="c1"># memory as the parent.  OK on a server, not so much in a container.</span>
        <span class="c1"># Disabled all the Manager().list() below and replaced with Redis sets</span>
        <span class="c1"># self.anomalous_metrics = Manager().list()</span>
        <span class="c1"># self.metric_variables = Manager().list()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mysql_conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="Panorama.check_if_parent_is_alive"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.check_if_parent_is_alive">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_parent_is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Self explanatory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># @added 20201203 - Bug #3856: Handle boring sparsely populated metrics in derivative_metrics</span>
            <span class="c1"># Log warning</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: parent or current process dead&#39;</span><span class="p">)</span>
            <span class="n">sys_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

    <span class="c1"># These are the panorama mysql functions used to surface and input panorama data</span>
    <span class="c1"># for timeseries.</span>

<div class="viewcode-block" id="Panorama.mysql_select"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.mysql_select">[docs]</a>    <span class="k">def</span> <span class="nf">mysql_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select_stmt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select data from mysql database</span>

<span class="sd">        :param select_stmt: the select string</span>
<span class="sd">        :type select_stmt: str</span>
<span class="sd">        :return: tuple</span>
<span class="sd">        :rtype: tuple, boolean</span>

<span class="sd">        - **Example usage**::</span>

<span class="sd">            query = &#39;select id, test from test&#39;</span>
<span class="sd">            result = self.mysql_select(query)</span>

<span class="sd">        - **Example of the 0 indexed results tuple, which can hold multiple results**::</span>

<span class="sd">            &gt;&gt; print(&#39;results: %s&#39; % str(results))</span>
<span class="sd">            results: [(1, u&#39;test1&#39;), (2, u&#39;test2&#39;)]</span>

<span class="sd">            &gt;&gt; print(&#39;results[0]: %s&#39; % str(results[0]))</span>
<span class="sd">            results[0]: (1, u&#39;test1&#39;)</span>

<span class="sd">        .. note::</span>
<span class="sd">            - If the MySQL query fails a boolean will be returned not a tuple</span>
<span class="sd">                * ``False``</span>
<span class="sd">                * ``None``</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cnx</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: connected to mysql&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mysql error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to mysql&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">cnx</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">select_stmt</span><span class="p">)))</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="n">cnx</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">select_stmt</span><span class="p">)))</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mysql error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to query database - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">select_stmt</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to mysql&#39;</span><span class="p">)</span>

        <span class="c1"># Close the test mysql connection</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Panorama.mysql_insert"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.mysql_insert">[docs]</a>    <span class="k">def</span> <span class="nf">mysql_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">insert</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert data into mysql table</span>

<span class="sd">        :param select: the insert string</span>
<span class="sd">        :type select: str</span>
<span class="sd">        :return: int</span>
<span class="sd">        :rtype: int or boolean</span>

<span class="sd">        - **Example usage**::</span>

<span class="sd">            query = &#39;insert into host (host) VALUES (\&#39;this_host\&#39;)&#39;</span>
<span class="sd">            result = self.mysql_insert(query)</span>

<span class="sd">        .. note::</span>
<span class="sd">            - If the MySQL query fails a boolean will be returned not a tuple</span>
<span class="sd">                * ``False``</span>
<span class="sd">                * ``None``</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cnx</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: connected to mysql&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mysql error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to mysql&#39;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">cnx</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="n">cnx</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">)</span>
                <span class="n">inserted_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>
                <span class="c1"># Make sure data is committed to the database</span>
                <span class="n">cnx</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">inserted_id</span>
            <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mysql error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to insert record&#39;</span><span class="p">)</span>
                <span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1"># @added 20200204 - Feature #3442: Panorama - add metric to metrics table immediately</span>
<div class="viewcode-block" id="Panorama.insert_new_metric"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.insert_new_metric">[docs]</a>    <span class="k">def</span> <span class="nf">insert_new_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert a new metric into the metrics tables.</span>

<span class="sd">        :param metric_name: metric name</span>
<span class="sd">        :type metric_name: str</span>
<span class="sd">        :return: int or boolean</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set defaults</span>
        <span class="n">learn_full_duration_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_FULL_DURATION_DAYS</span><span class="p">)</span>
        <span class="n">valid_learning_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_VALID_TIMESERIES_OLDER_THAN_SECONDS</span><span class="p">)</span>
        <span class="n">max_generations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_MAX_GENERATIONS</span><span class="p">)</span>
        <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_MAX_PERCENT_DIFF_FROM_ORIGIN</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">use_full_duration</span><span class="p">,</span> <span class="n">valid_learning_duration</span><span class="p">,</span> <span class="n">use_full_duration_days</span><span class="p">,</span> <span class="n">max_generations</span><span class="p">,</span> <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="n">get_ionosphere_learn_details</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">)</span>
            <span class="n">learn_full_duration_days</span> <span class="o">=</span> <span class="n">use_full_duration_days</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get_ionosphere_learn_details for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric learn details determined for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn_full_duration_days     :: </span><span class="si">%s</span><span class="s1"> days&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;valid_learning_duration      :: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">valid_learning_duration</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;max_generations              :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_generations</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;max_percent_diff_from_origin :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">)))</span>

        <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="n">determined_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
            <span class="c1"># @modified 20230116 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># DO NOT return the engine you muppet</span>
            <span class="c1"># return engine, log_msg, trace</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: insert_new_metric :: failed to get MySQL engine - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metrics_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">metrics_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: insert_new_metric :: failed to get metrics_table meta - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: insert_new_metric :: engine.dispose() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="c1"># insert_query_string = &#39;%s (%s, learn_full_duration_days, learn_valid_ts_older_than, max_generations, max_percent_diff_from_origin) VALUES (\&#39;%s\&#39;, %s, %s, %s, %s)&#39; % (</span>
        <span class="c1">#     &#39;metrics&#39;, &#39;metric&#39;, metric_name, str(learn_full_duration_days),</span>
        <span class="c1">#     str(valid_learning_duration), str(max_generations),</span>
        <span class="c1">#     str(max_percent_diff_from_origin))</span>
        <span class="c1"># insert_query = &#39;insert into %s&#39; % insert_query_string  # nosec</span>

        <span class="c1"># @modified 20230116 - Bug #4816: Handle error in sqlalchemy change</span>
        <span class="c1">#                      Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Simplify log arguments</span>
        <span class="c1"># logger.info(&#39;inserting %s into %s table&#39; % (metric_name, &#39;metrics&#39;))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;inserting </span><span class="si">%s</span><span class="s1"> into metrics table&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># results = self.mysql_insert(insert_query)</span>
            <span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">metrics_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
                <span class="n">metric</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                <span class="n">learn_full_duration_days</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">),</span>
                <span class="n">learn_valid_ts_older_than</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_learning_duration</span><span class="p">),</span>
                <span class="n">max_generations</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">max_generations</span><span class="p">),</span>
                <span class="n">max_percent_diff_from_origin</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">))</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_stmt</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">determined_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">inserted_primary_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: insert_new_metric :: failed to insert metric </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: insert_new_metric :: engine.dispose() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>

        <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="c1"># determined_id = 0</span>
        <span class="c1"># if results:</span>
        <span class="c1">#     determined_id = int(results)</span>
        <span class="c1">#     return determined_id</span>
        <span class="c1"># else:</span>
        <span class="c1">#    logger.error(&#39;error :: results not set&#39;)</span>
        <span class="c1">#    raise ValueError(&#39;error :: results not set&#39;)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">determined_id</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: insert_new_metric :: failed to determine the inserted id for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">determined_id</span></div>

    <span class="c1"># @added 20170101 - Feature #1830: Ionosphere alerts</span>
    <span class="c1">#                   Bug #1460: panorama check file fails</span>
    <span class="c1">#                   Panorama check file fails #24</span>
    <span class="c1"># Get rid of the skyline_functions imp as imp is deprecated in py3 anyway</span>
<div class="viewcode-block" id="Panorama.new_load_metric_vars"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.new_load_metric_vars">[docs]</a>    <span class="k">def</span> <span class="nf">new_load_metric_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_vars_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the metric variables for a check from a metric check variables file</span>

<span class="sd">        :param metric_vars_file: the path and filename to the metric variables files</span>
<span class="sd">        :type metric_vars_file: str</span>
<span class="sd">        :return: the metric_vars module object or ``False``</span>
<span class="sd">        :rtype: list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;loading metric variables from metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: loading metric variables from metric_check_file - file not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">metric_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">no_new_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">no_equal_line</span> <span class="o">=</span> <span class="n">no_new_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; = &#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">array</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">no_equal_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">add_line</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                <span class="n">metric_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_line</span><span class="p">)</span>

        <span class="c1"># @added 20200429 - Feature #3486: analyzer_batch</span>
        <span class="c1">#                   Feature #3480: batch_processing</span>
        <span class="c1"># Allow the check file to already hold a valid python list on one line</span>
        <span class="c1"># so that a check can be added by simply echoing to debug metric_vars</span>
        <span class="c1"># line from to log for any failed checks into a new Panorama check file</span>
        <span class="c1"># The original above pattern is still the default, this is for the check</span>
        <span class="c1"># files to be added by the operator from the log or for debugging.</span>
        <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">metric_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_vars is not a list, set to try_literal_eval&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_vars</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_vars is not a list of lists, set to try_literal_eval&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">try_literal_eval</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_vars is not defined, set to try_literal_eval&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">try_literal_eval</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">metric_vars</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metric_vars</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metric_vars not loaded with literal_eval&#39;</span><span class="p">)</span>
                <span class="n">metric_vars</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># @modified 20200420 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                      Feature #1448: Crucible web UI</span>
        <span class="c1">#                      Branch #868: crucible</span>
        <span class="c1"># Added label to string_keys and user_id to int_keys</span>
        <span class="n">string_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;anomaly_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;added_by&#39;</span><span class="p">,</span> <span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="n">float_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">int_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;added_at&#39;</span><span class="p">,</span> <span class="s1">&#39;full_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
        <span class="n">array_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">,</span> <span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">]</span>
        <span class="n">boolean_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;graphite_metric&#39;</span><span class="p">,</span> <span class="s1">&#39;run_crucible_tests&#39;</span><span class="p">]</span>

        <span class="n">metric_vars_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">string_keys</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">float_keys</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">int_keys</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">array_keys</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">boolean_keys</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">metric_vars_array</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_vars_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: loading metric variables - none found in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="c1"># @modified 20200713 - AttributeError: &#39;list&#39; object has no attribute &#39;metric&#39; - Panorama not working #255</span>
                    <span class="c1">#                      Bug #1460: panorama check file fails</span>
                    <span class="c1"># Missed changing old method</span>
                    <span class="c1"># &#39;debug :: metric_vars determined - metric variable - metric - %s&#39; % str(metric_vars.metric))</span>
                    <span class="s1">&#39;debug :: metric_vars determined - metric variable - metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric_vars for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_array</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">metric_vars_array</span></div>

    <span class="c1"># @modified 20200929 - Task #3748: POC SNAB</span>
    <span class="c1">#                      Branch #3068: SNAB</span>
    <span class="c1"># Handle snab as well</span>
    <span class="c1"># def update_slack_thread_ts(self, i, base_name, metric_timestamp, slack_thread_ts):</span>
<div class="viewcode-block" id="Panorama.update_slack_thread_ts"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.update_slack_thread_ts">[docs]</a>    <span class="k">def</span> <span class="nf">update_slack_thread_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">slack_thread_ts</span><span class="p">,</span> <span class="n">snab_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update an anomaly record with the slack_thread_ts.</span>

<span class="sd">        :param i: python process id</span>
<span class="sd">        :param metric_check_file: full path to the metric check file</span>

<span class="sd">        :return: returns True</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">get_an_engine</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: update_slack_thread_ts :: failed to get MySQL engine in update_slack_thread_ts&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: failed to get MySQL engine in update_slack_thread_ts&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span>

        <span class="k">def</span> <span class="nf">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: calling engine.dispose()&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">child_process_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: child_process_pid </span><span class="si">%s</span><span class="s1">, processing </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">child_process_pid</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">slack_thread_ts</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">snab_id</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: child_process_pid </span><span class="si">%s</span><span class="s1">, processing snab id - </span><span class="si">%s</span><span class="s1">, slack_thread_ts - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">child_process_pid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_id</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">slack_thread_ts</span><span class="p">)))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_an_engine</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: could not get a MySQL engine to update slack_thread_ts in anomalies for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">snab_id</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: could not get a MySQL engine to update slack_thread_ts in snab for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: engine not obtained to update slack_thread_ts in anomalies for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">snab_id</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: engine not obtained to update slack_thread_ts in snab for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">metric_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
        <span class="c1"># @modified 20230418 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
        <span class="c1">#                      Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                      Branch #4300: prometheus</span>
        <span class="c1"># Handle snab using None as base_name (not a str)</span>
        <span class="c1"># if base_name.startswith(&#39;labelled_metrics.&#39;):</span>
        <span class="k">if</span> <span class="n">use_base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
            <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric_id_str</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">use_base_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="s1">&#39;panorama&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: engine not obtained to update slack_thread_ts in anomalies for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="n">anomaly_record_updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metrics_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">metrics_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: metrics_table OK&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: failed to get metrics_table meta for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="c1"># stmt = select([metrics_table]).where(metrics_table.c.metric == base_name)</span>
                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">metrics_table</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">metrics_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="n">use_base_name</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: could not determine metric id from metrics table&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: metric id determined as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomalies_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">anomalies_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: anomalies_table OK&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: failed to get anomalies_table meta for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
            <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">anomalies_table</span><span class="p">])</span><span class="o">.</span>\
                        <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_id</span> <span class="o">==</span> <span class="n">metric_id</span><span class="p">)</span><span class="o">.</span>\
                        <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_timestamp</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">anomaly_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: could not determine anomaly id from anomaly table&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: anomaly id determined as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">anomaly_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">anomalies_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">anomaly_id</span><span class="p">)</span><span class="o">.</span>
                        <span class="n">values</span><span class="p">(</span><span class="n">slack_thread_ts</span><span class="o">=</span><span class="n">slack_thread_ts</span><span class="p">))</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: updated slack_thread_ts for anomaly id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
                    <span class="n">anomaly_record_updated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: could not update slack_thread_ts for anomaly id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
                <span class="c1"># @added 20201002 - Task #3748: POC SNAB</span>
                <span class="c1">#                   Branch #3068: SNAB</span>
                <span class="c1"># Add a Redis key for snab to also update the original anomaly</span>
                <span class="c1"># id slack_thread_ts</span>
                <span class="k">if</span> <span class="n">anomaly_record_updated</span> <span class="ow">and</span> <span class="n">SNAB_ENABLED</span><span class="p">:</span>
                    <span class="n">anomaly_id_slack_thread_ts_redis_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.anomaly.id.</span><span class="si">%s</span><span class="s1">.slack_thread_ts&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">anomaly_id_slack_thread_ts_redis_key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">slack_thread_ts</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: created Redis key </span><span class="si">%s</span><span class="s1"> for snab with slack_thread_ts </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">anomaly_id_slack_thread_ts_redis_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">slack_thread_ts</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: failed to create Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">anomaly_id_slack_thread_ts_redis_key</span><span class="p">))</span>

        <span class="c1"># @added 20200929 - Task #3748: POC SNAB</span>
        <span class="c1">#                   Branch #3068: SNAB</span>
        <span class="c1"># Handle snab as well</span>
        <span class="k">if</span> <span class="n">snab_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">snab_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">snab_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: snab_table OK&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: failed to get snab_table meta for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_id</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">snab_table</span><span class="o">.</span><span class="n">update</span><span class="p">()</span><span class="o">.</span>\
                    <span class="n">values</span><span class="p">(</span><span class="n">slack_thread_ts</span><span class="o">=</span><span class="n">slack_thread_ts</span><span class="p">)</span><span class="o">.</span>\
                    <span class="n">where</span><span class="p">(</span><span class="n">snab_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">snab_id</span><span class="p">))</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: updated slack_thread_ts for snab id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_id</span><span class="p">))</span>
                <span class="n">anomaly_record_updated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: could not update slack_thread_ts for snab id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_id</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: could not dispose engine&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.slack_thread_ts.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
            <span class="c1"># cache_key = &#39;panorama.slack_thread_ts.%s.%s&#39; % (str(metric_timestamp), use_base_name)</span>
        <span class="k">if</span> <span class="n">snab_id</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.snab.slack_thread_ts.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_id</span><span class="p">))</span>

        <span class="n">delete_cache_key</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">anomaly_record_updated</span><span class="p">:</span>
            <span class="n">delete_cache_key</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">anomaly_record_updated</span><span class="p">:</span>
            <span class="c1"># Allow for 60 seconds for an anomaly to be added</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">anomaly_age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">anomaly_age</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                <span class="n">delete_cache_key</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">delete_cache_key</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: deleting cache_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_slack_thread_ts :: cache_key </span><span class="si">%s</span><span class="s1"> deleted&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_slack_thread_ts :: failed to delete cache_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="c1"># @added 20191107 - Feature #3306: Record anomaly_end_timestamp</span>
    <span class="c1">#                   Branch #3262: py3</span>
<div class="viewcode-block" id="Panorama.update_anomaly_end_timestamp"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.update_anomaly_end_timestamp">[docs]</a>    <span class="k">def</span> <span class="nf">update_anomaly_end_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">anomaly_id</span><span class="p">,</span> <span class="n">anomaly_end_timestamp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update an anomaly record with the anomaly_end_timestamp.</span>

<span class="sd">        :param self: self</span>
<span class="sd">        :param i: python process id</span>
<span class="sd">        :param anomaly_id: the anomaly id</span>
<span class="sd">        :param anomaly_end_timestamp: the anomaly end timestamp</span>
<span class="sd">        :type self: object</span>
<span class="sd">        :type i: object</span>
<span class="sd">        :type anomaly_id: int</span>
<span class="sd">        :type anomaly_end_timestamp: int</span>
<span class="sd">        :return: boolean</span>
<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">get_an_engine</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: update_anomaly_end_timestamp :: failed to get MySQL engine in update_anomaly_end_timestamp&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_anomaly_end_timestamp :: failed to get MySQL engine in update_anomaly_end_timestamp&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span>

        <span class="k">def</span> <span class="nf">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_anomaly_end_timestamp :: calling engine.dispose()&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">child_process_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_anomaly_end_timestamp :: child_process_pid </span><span class="si">%s</span><span class="s1">, processing anomaly_id </span><span class="si">%s</span><span class="s1"> and setting anomaly_end_timestamp as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">child_process_pid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_end_timestamp</span><span class="p">)))</span>
        <span class="n">updated_anomaly_record</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_an_engine</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_anomaly_end_timestamp :: could not get a MySQL engine to update slack_thread_ts in anomalies for anomaly_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_anomaly_end_timestamp :: engine not obtained to update slack_thread_ts in anomalies for anomaly_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">)))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">anomalies_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">anomalies_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_anomaly_end_timestamp :: anomalies_table OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_anomaly_end_timestamp :: failed to get anomalies_table meta for anomaly_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">anomalies_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">anomaly_id</span><span class="p">)</span><span class="o">.</span>
                <span class="n">values</span><span class="p">(</span><span class="n">anomaly_end_timestamp</span><span class="o">=</span><span class="n">anomaly_end_timestamp</span><span class="p">))</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">updated_anomaly_record</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_anomaly_end_timestamp :: updated anomaly_end_timestamp (</span><span class="si">%s</span><span class="s1">) for anomaly id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_end_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_anomaly_end_timestamp :: could not update anomaly_end_timestamp (</span><span class="si">%s</span><span class="s1">) for anomaly id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_end_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_anomaly_end_timestamp :: could not dispose engine&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updated_anomaly_record</span></div>

    <span class="c1"># @added 20200825 - Feature #3704: Add alert to anomalies</span>
<div class="viewcode-block" id="Panorama.update_alert_ts"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.update_alert_ts">[docs]</a>    <span class="k">def</span> <span class="nf">update_alert_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">alerted_at</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update an anomaly record with the alert_ts.</span>

<span class="sd">        :param i: python process id</span>
<span class="sd">        :param base_name: base name</span>
<span class="sd">        :param metric_timestamp: the anomaly timestamp</span>
<span class="sd">        :param alerted_at: the alert timestamp</span>

<span class="sd">        :return: returns True</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">get_an_engine</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: update_alert_ts :: failed to get MySQL engine in update_alert_ts&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: failed to get MySQL engine in update_alert_ts&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span>

        <span class="k">def</span> <span class="nf">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: calling engine.dispose()&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">child_process_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_alert_ts :: child_process_pid </span><span class="si">%s</span><span class="s1">, processing </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">child_process_pid</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">alerted_at</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_an_engine</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: could not get a MySQL engine to update slack_thread_ts in anomalies for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: engine not obtained to update slack_thread_ts in anomalies for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># @added 20220810 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: failed to determine metric id for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metrics_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">metrics_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_alert_ts :: metrics_table OK&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: failed to get metrics_table meta for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">metrics_table</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">metrics_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="n">base_name</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: could not determine metric id from metrics table&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_alert_ts :: metric id determined as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">anomalies_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">anomalies_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_alert_ts :: anomalies_table OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: failed to get anomalies_table meta for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>

        <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">anomalies_table</span><span class="p">])</span><span class="o">.</span>\
                <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_id</span> <span class="o">==</span> <span class="n">metric_id</span><span class="p">)</span><span class="o">.</span>\
                <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_timestamp</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">anomaly_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: could not determine anomaly id from anomaly table&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_alert_ts :: anomaly id determined as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
        <span class="n">anomaly_record_updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">anomaly_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">anomalies_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">anomaly_id</span><span class="p">)</span><span class="o">.</span>
                    <span class="n">values</span><span class="p">(</span><span class="n">alert</span><span class="o">=</span><span class="n">alerted_at</span><span class="p">))</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_alert_ts :: updated alert for anomaly id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
                <span class="n">anomaly_record_updated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: could not update alert for anomaly id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: could not dispose engine&#39;</span><span class="p">)</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.alert.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="n">delete_cache_key</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">anomaly_record_updated</span><span class="p">:</span>
            <span class="n">delete_cache_key</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">anomaly_record_updated</span><span class="p">:</span>
            <span class="c1"># Allow for 120 seconds for an anomaly to be added</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">anomaly_age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">anomaly_age</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">:</span>
                <span class="n">delete_cache_key</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">delete_cache_key</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_alert_ts :: deleting cache_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_alert_ts :: cache_key </span><span class="si">%s</span><span class="s1"> deleted&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: failed to delete cache_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="c1"># @added 20200928 - Task #3748: POC SNAB</span>
    <span class="c1">#                   Branch #3068: SNAB</span>
    <span class="c1"># Determine id of something thing</span>
<div class="viewcode-block" id="Panorama.determine_db_id"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.determine_db_id">[docs]</a>    <span class="k">def</span> <span class="nf">determine_db_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the id of something from the database and create a new entry if it</span>
<span class="sd">        does not exist</span>

<span class="sd">        :param table: table name</span>
<span class="sd">        :param key: key name</span>
<span class="sd">        :param value: value name</span>
<span class="sd">        :type table: str</span>
<span class="sd">        :type key: str</span>
<span class="sd">        :type value: str</span>
<span class="sd">        :return: int or boolean</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">determined_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_db_id :: could not get a MySQL engine - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">determined_id</span>
        <span class="c1"># Use the MetaData autoload rather than string-based query construction</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">use_table_meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
            <span class="n">use_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">use_table_meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_db_id :: use_table Table failed on </span><span class="si">%s</span><span class="s1"> table - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">table</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="c1"># query = &#39;select id FROM %s WHERE %s=\&#39;%s\&#39;&#39; % (table, key, value)  # nosec</span>

        <span class="n">determined_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># results = None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># results = self.mysql_select(query)</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">use_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">use_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
                <span class="n">determined_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_db_id :: failed to determine results from - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">stmt</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

        <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="c1"># determined_id = 0</span>
        <span class="c1"># if results:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         determined_id = int(results[0][0])</span>
        <span class="c1">#     except:</span>
        <span class="c1">#         logger.error(traceback.format_exc())</span>
        <span class="c1">#         logger.error(&#39;error :: determined_id is not an int&#39;)</span>
        <span class="c1">#         determined_id = 0</span>

        <span class="k">if</span> <span class="n">determined_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># @added 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_db_id :: engine.dispose() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>

            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">determined_id</span><span class="p">)</span>

        <span class="c1"># @added 20170115 - Feature #1854: Ionosphere learn - generations</span>
        <span class="c1"># Added determination of the learn related variables</span>
        <span class="c1"># learn_full_duration_days, learn_valid_ts_older_than,</span>
        <span class="c1"># max_generations and max_percent_diff_from_origin value to the</span>
        <span class="c1"># insert statement if the table is the metrics table.</span>
        <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
            <span class="c1"># Set defaults</span>
            <span class="n">learn_full_duration_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_FULL_DURATION_DAYS</span><span class="p">)</span>
            <span class="n">valid_learning_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_VALID_TIMESERIES_OLDER_THAN_SECONDS</span><span class="p">)</span>
            <span class="n">max_generations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_MAX_GENERATIONS</span><span class="p">)</span>
            <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_MAX_PERCENT_DIFF_FROM_ORIGIN</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">use_full_duration</span><span class="p">,</span> <span class="n">valid_learning_duration</span><span class="p">,</span> <span class="n">use_full_duration_days</span><span class="p">,</span> <span class="n">max_generations</span><span class="p">,</span> <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="n">get_ionosphere_learn_details</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">learn_full_duration_days</span> <span class="o">=</span> <span class="n">use_full_duration_days</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get_ionosphere_learn_details for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric learn details determined for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn_full_duration_days     :: </span><span class="si">%s</span><span class="s1"> days&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;valid_learning_duration      :: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">valid_learning_duration</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;max_generations              :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_generations</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;max_percent_diff_from_origin :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">)))</span>

        <span class="c1"># INSERT because no known id</span>
        <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>

            <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># Comment out insert_query</span>
            <span class="c1"># insert_query_string = &#39;%s (%s, learn_full_duration_days, learn_valid_ts_older_than, max_generations, max_percent_diff_from_origin) VALUES (\&#39;%s\&#39;, %s, %s, %s, %s)&#39; % (</span>
            <span class="c1">#     table, key, value, str(learn_full_duration_days),</span>
            <span class="c1">#     str(valid_learning_duration), str(max_generations),</span>
            <span class="c1">#     str(max_percent_diff_from_origin))</span>
            <span class="c1"># insert_query = &#39;insert into %s&#39; % insert_query_string  # nosec</span>

            <span class="c1"># @added 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">use_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                <span class="s1">&#39;learn_full_duration_days&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">),</span>
                <span class="s1">&#39;learn_valid_ts_older_than&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_learning_duration</span><span class="p">),</span>
                <span class="s1">&#39;max_generations&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_generations</span><span class="p">),</span>
                <span class="s1">&#39;max_percent_diff_from_origin&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">)})</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># Comment out insert_query</span>
            <span class="c1"># insert_query = &#39;insert into %s (%s) VALUES (\&#39;%s\&#39;)&#39; % (table, key, value)  # nosec</span>

            <span class="c1"># @added 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">use_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;inserting </span><span class="si">%s</span><span class="s1"> into </span><span class="si">%s</span><span class="s1"> table&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># results = self.mysql_insert(insert_query)</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_stmt</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">determined_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">inserted_primary_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine the id of </span><span class="si">%s</span><span class="s1"> from the insert&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="c1"># @added 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_db_id :: engine.dispose() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>

            <span class="k">raise</span>

        <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="c1"># determined_id = 0</span>
        <span class="c1"># if results:</span>
        <span class="c1">#    determined_id = int(results)</span>
        <span class="c1"># else:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">determined_id</span><span class="p">:</span>
            <span class="c1"># @added 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_db_id :: engine.dispose() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: no determined_id&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;error :: no determined_id&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20220822 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="c1"># Training data should only be returned for fp creation if there is</span>
        <span class="c1"># sufficient data for a metric.  By adding to the Redis set</span>
        <span class="c1"># ionosphere.untrainable_metrics, training data items are removed</span>
        <span class="c1"># from the api training_data response, defaulting and hardcoding 7</span>
        <span class="c1"># days because the metric may not fall into an alert tuple</span>
        <span class="k">if</span> <span class="n">determined_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.untrainable_metrics&#39;</span>
                <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;_tenant_id&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">use_base_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">determined_id</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">now_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">remove_after_timestamp</span> <span class="o">=</span> <span class="n">now_ts</span> <span class="o">+</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">([</span><span class="n">use_base_name</span><span class="p">,</span> <span class="n">now_ts</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">now_ts</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">7</span><span class="p">),</span> <span class="n">remove_after_timestamp</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)))</span>

        <span class="c1"># @added 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_db_id :: engine.dispose() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">determined_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">determined_id</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_db_id :: failed to determine the inserted id for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1"># @added 20200928 - Task #3748: POC SNAB</span>
    <span class="c1">#                   Branch #3068: SNAB</span>
<div class="viewcode-block" id="Panorama.update_snab"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.update_snab">[docs]</a>    <span class="k">def</span> <span class="nf">update_snab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">snab_panorama_items</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update snab anomaly records.</span>

<span class="sd">        :param i: python process id</span>
<span class="sd">        :return: returns True</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">get_an_engine</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: update_alert_ts :: failed to get MySQL engine in update_alert_ts&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: failed to get MySQL engine in update_alert_ts&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span>

        <span class="k">def</span> <span class="nf">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_alert_ts :: calling engine.dispose()&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">child_process_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_snab :: child_process_pid </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_process_pid</span><span class="p">))</span>

        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;snab.panorama&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">snab_panorama_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get data from </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="n">redis_set</span><span class="p">)</span>
            <span class="n">snab_panorama_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">snab_panorama_items</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_an_engine</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: could not get a MySQL engine to update snab table&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: engine not obtained to update snab table&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metrics_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">metrics_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_snab :: metrics_table OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: failed to get metrics_table meta&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">anomalies_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">anomalies_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_snab :: anomalies_table OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: failed to get anomalies_table meta&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">snab_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">snab_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_snab :: snab_table OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: failed to get snab_table meta&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">snab_panorama_items</span><span class="p">:</span>
            <span class="n">remove_item</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">snab_item</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">snab_item</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">snab_item</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">analysis_run_time</span> <span class="o">=</span> <span class="n">snab_item</span><span class="p">[</span><span class="s1">&#39;analysis_run_time&#39;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">analysis_run_time</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">source_app</span> <span class="o">=</span> <span class="n">snab_item</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
                <span class="n">algorithm_group</span> <span class="o">=</span> <span class="n">snab_item</span><span class="p">[</span><span class="s1">&#39;algorithm_group&#39;</span><span class="p">]</span>
                <span class="n">algorithm</span> <span class="o">=</span> <span class="n">snab_item</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span>
                <span class="n">added_at</span> <span class="o">=</span> <span class="n">snab_item</span><span class="p">[</span><span class="s1">&#39;added_at&#39;</span><span class="p">]</span>
                <span class="c1"># @added 20201001 - Task #3748: POC SNAB</span>
                <span class="c1"># Added anomalyScore</span>
                <span class="n">anomalyScore</span> <span class="o">=</span> <span class="n">snab_item</span><span class="p">[</span><span class="s1">&#39;anomalyScore&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to evaluate data from item </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">metrics_table</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">metrics_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="n">base_name</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: could not determine metric id from metrics table&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_snab :: metric id determined as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
            <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">anomalies_table</span><span class="p">])</span><span class="o">.</span>\
                        <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_id</span> <span class="o">==</span> <span class="n">metric_id</span><span class="p">)</span><span class="o">.</span>\
                        <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_timestamp</span> <span class="o">==</span> <span class="n">metric_timestamp</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">anomaly_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: could not determine anomaly id from anomaly table&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_snab :: anomaly id determined as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">anomaly_id</span><span class="p">:</span>
                <span class="n">app_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">app_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_db_id</span><span class="p">(</span><span class="s1">&#39;apps&#39;</span><span class="p">,</span> <span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="n">source_app</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: failed to determine app_id for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source_app</span><span class="p">))</span>
                    <span class="n">app_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">algorithm_group_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">algorithm_group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_db_id</span><span class="p">(</span><span class="s1">&#39;algorithm_groups&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithm_group&#39;</span><span class="p">,</span> <span class="n">algorithm_group</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: failed to determine algorithm_group_id for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">algorithm_group</span><span class="p">))</span>
                    <span class="n">algorithm_group</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">algorithm_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">algorithm</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">algorithm_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_db_id</span><span class="p">(</span><span class="s1">&#39;algorithms&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithm&#39;</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: failed to determine algorithm_group_id for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">algorithm_group</span><span class="p">))</span>
                        <span class="n">algorithm_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">new_snab_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">algorithm_id</span><span class="p">:</span>
                        <span class="n">ins</span> <span class="o">=</span> <span class="n">snab_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
                            <span class="n">anomaly_id</span><span class="o">=</span><span class="n">anomaly_id</span><span class="p">,</span>
                            <span class="c1"># @added 20201001 - Task #3748: POC SNAB</span>
                            <span class="c1"># Added anomalyScore</span>
                            <span class="n">anomalyScore</span><span class="o">=</span><span class="n">anomalyScore</span><span class="p">,</span>
                            <span class="n">app_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">app_id</span><span class="p">),</span>
                            <span class="n">algorithm_group_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">algorithm_group_id</span><span class="p">),</span>
                            <span class="n">algorithm_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">algorithm_id</span><span class="p">),</span>
                            <span class="n">runtime</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">analysis_run_time</span><span class="p">),</span>
                            <span class="n">snab_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">added_at</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ins</span> <span class="o">=</span> <span class="n">snab_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
                            <span class="n">anomaly_id</span><span class="o">=</span><span class="n">anomaly_id</span><span class="p">,</span>
                            <span class="c1"># @added 20201001 - Task #3748: POC SNAB</span>
                            <span class="c1"># Added anomalyScore</span>
                            <span class="n">anomalyScore</span><span class="o">=</span><span class="n">anomalyScore</span><span class="p">,</span>
                            <span class="n">app_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">app_id</span><span class="p">),</span>
                            <span class="n">algorithm_group_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">algorithm_group_id</span><span class="p">),</span>
                            <span class="n">runtime</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">analysis_run_time</span><span class="p">),</span>
                            <span class="n">snab_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">added_at</span><span class="p">))</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ins</span><span class="p">)</span>
                    <span class="n">new_snab_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">inserted_primary_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_snab :: new snab id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_snab_id</span><span class="p">))</span>
                    <span class="n">remove_item</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;error :: update_snab :: could not update snab for </span><span class="si">%s</span><span class="s1"> with with timestamp </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">new_snab_id</span><span class="p">:</span>
                    <span class="n">snab_id_redis_key</span> <span class="o">=</span> <span class="s1">&#39;snab.id.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">algorithm_group</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">added_at</span><span class="p">))</span>
                    <span class="c1"># @added 20230419 - Feature #4848: mirage - analyse.irregular.unstable.timeseries.at.30days</span>
                    <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                        <span class="n">snab_id_redis_key</span> <span class="o">=</span> <span class="s1">&#39;snab.id.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">algorithm_group</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">added_at</span><span class="p">))</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">snab_id_redis_key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_snab_id</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_snab :: created Redis key </span><span class="si">%s</span><span class="s1"> for snab id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">snab_id_redis_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_snab_id</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: failed to create Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">snab_id_redis_key</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">anomaly_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="mi">600</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">added_at</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;error :: update_snab :: removing snab.panorama item as no anomaly id can be determined after 600 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">snab_item</span><span class="p">)))</span>
                    <span class="n">remove_item</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">remove_item</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_snab :: removed item from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_snab :: failed to remove item from Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
            <span class="n">engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Panorama.spin_process"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.spin_process">[docs]</a>    <span class="k">def</span> <span class="nf">spin_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">metric_check_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign a metric anomaly to process.</span>

<span class="sd">        :param i: python process id</span>
<span class="sd">        :param metric_check_file: full path to the metric check file</span>

<span class="sd">        :return: returns True</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">child_process_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: child_process_pid - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_process_pid</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: processing metric check - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: file not found - metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="n">check_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: check_file_name - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_name</span><span class="p">)</span>
        <span class="n">check_file_timestamp</span> <span class="o">=</span> <span class="n">check_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: check_file_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">check_file_timestamp</span><span class="p">))</span>
        <span class="n">check_file_metricname_txt</span> <span class="o">=</span> <span class="n">check_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: check_file_metricname_txt - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_metricname_txt</span><span class="p">)</span>
        <span class="n">check_file_metricname</span> <span class="o">=</span> <span class="n">check_file_metricname_txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: check_file_metricname - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_metricname</span><span class="p">)</span>
        <span class="n">check_file_metricname_dir</span> <span class="o">=</span> <span class="n">check_file_metricname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: check_file_metricname_dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_metricname_dir</span><span class="p">)</span>

        <span class="n">metric_failed_check_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">failed_checks_dir</span><span class="p">,</span> <span class="n">check_file_metricname_dir</span><span class="p">,</span> <span class="n">check_file_timestamp</span><span class="p">)</span>

        <span class="n">failed_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="n">check_file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: failed_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">failed_check_file</span><span class="p">)</span>

        <span class="c1"># Load and validate metric variables</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20170101 - Feature #1830: Ionosphere alerts</span>
            <span class="c1">#                      Bug #1460: panorama check file fails</span>
            <span class="c1">#                      Panorama check file fails #24</span>
            <span class="c1"># Get rid of the skyline_functions imp as imp is deprecated in py3 anyway</span>
            <span class="c1"># Use def new_load_metric_vars(self, metric_vars_file):</span>
            <span class="c1"># metric_vars = load_metric_vars(skyline_app, str(metric_check_file))</span>
            <span class="n">metric_vars_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_load_metric_vars</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load metric variables from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># Test metric variables</span>
        <span class="c1"># We use a pythonic methodology to test if the variables are defined,</span>
        <span class="c1"># this ensures that if any of the variables are not set for some reason</span>
        <span class="c1"># we can handle unexpected data or situations gracefully and try and</span>
        <span class="c1"># ensure that the process does not hang.</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># metric_vars.metric</span>
            <span class="c1"># metric = str(metric_vars.metric)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;metric&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read metric variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load metric variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># @added 20171214 - Bug #2234: panorama metric_vars value check</span>
        <span class="n">value_valid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># metric_vars.value</span>
            <span class="c1"># value = str(metric_vars.value)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="c1"># @added 20171214 - Bug #2234: panorama metric_vars value check</span>
            <span class="n">value_valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read value variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># @added 20171214 - Bug #2234: panorama metric_vars value check</span>
        <span class="c1"># If value was float of 0.0 then this was interpolated as not set</span>
        <span class="c1"># if not value:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value_valid</span><span class="p">:</span>
            <span class="c1"># @added 20171214 - Bug #2234: panorama metric_vars value check</span>
            <span class="c1"># Added exception handling here</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read value variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># metric_vars.from_timestamp</span>
            <span class="c1"># from_timestamp = str(metric_vars.from_timestamp)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;from_timestamp&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - from_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">from_timestamp</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># @added 20160822 - Bug #1460: panorama check file fails</span>
            <span class="c1"># Added exception handling here</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read from_timestamp variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_timestamp</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load from_timestamp variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># metric_vars.metric_timestamp</span>
            <span class="c1"># metric_timestamp = str(metric_vars.metric_timestamp)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;metric_timestamp&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - metric_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_timestamp</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read metric_timestamp variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_timestamp</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load metric_timestamp variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">algorithms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># metric_vars.algorithms</span>
            <span class="c1"># algorithms = metric_vars.algorithms</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;algorithms&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">algorithms</span> <span class="o">=</span> <span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - algorithms - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithms</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read algorithms variable from check file setting to all - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">algorithms</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load algorithms variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># metric_vars.triggered_algorithms</span>
            <span class="c1"># triggered_algorithms = metric_vars.triggered_algorithms</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;triggered_algorithms&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - triggered_algorithms - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">triggered_algorithms</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read triggered_algorithms variable from check file setting to all - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">triggered_algorithms</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load triggered_algorithms variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">app</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># metric_vars.app</span>
            <span class="c1"># app = str(metric_vars.app)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;app&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">app</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - app - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">app</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read app variable from check file setting to all  - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load app variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># metric_vars.source</span>
            <span class="c1"># source = str(metric_vars.source)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;source&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - source - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">source</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read source variable from check file setting to all  - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load app variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">added_by</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># metric_vars.added_by</span>
            <span class="c1"># added_by = str(metric_vars.added_by)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;added_by&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">added_by</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - added_by - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">added_by</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read added_by variable from check file setting to all - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">added_by</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load added_by variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">added_at</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># metric_vars.added_at</span>
            <span class="c1"># added_at = str(metric_vars.added_at)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;added_at&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">added_at</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - added_at - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">added_at</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read added_at variable from check file setting to all - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">added_at</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to load added_at variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># @modified 20200420 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                      Feature #1448: Crucible web UI</span>
        <span class="c1">#                      Branch #868: crucible</span>
        <span class="c1"># Added label to string_keys and user_id to int_keys</span>
        <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;label&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - label - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - label was not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;user_id&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - user_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">user_id</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - user_id was not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">user_id</span><span class="p">)</span>

        <span class="n">record_anomaly</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.last_check.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: cache_key - </span><span class="si">%s</span><span class="s1">.last_check.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">skyline_app</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20200603 - Task #3562; Change panorama.last_check keys to timestamp value</span>
            <span class="c1">#                      Feature #3486: analyzer_batch</span>
            <span class="c1">#                      Feature #3480: batch_processing</span>
            <span class="c1"># As a int is now used and not a msgpack value, decoded the key</span>
            <span class="c1"># value</span>
            <span class="c1"># last_check = self.redis_conn.get(cache_key)</span>
            <span class="n">last_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: could not query cache_key - </span><span class="si">%s</span><span class="s1">.last_check.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">skyline_app</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">last_check</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @modified 20200420 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                      Feature #1448: Crucible web UI</span>
        <span class="c1">#                      Branch #868: crucible</span>
        <span class="c1"># Added label to string_keys and user_id to int_keys</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;webapp&#39;</span><span class="p">,</span> <span class="s1">&#39;crucible&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;anomaly added by </span><span class="si">%s</span><span class="s1"> recording anomaly unsetting last_check&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">app</span><span class="p">))</span>
            <span class="n">last_check</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20200413 - Feature #3486: analyzer_batch</span>
        <span class="c1">#                   Feature #3480: batch_processing</span>
        <span class="c1"># Evaluate the reported anomaly timestamp to determine whether</span>
        <span class="c1"># PANORAMA_EXPIRY_TIME should be applied to a batch metric</span>
        <span class="n">batch_metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">BATCH_PROCESSING</span><span class="p">:</span>
            <span class="n">batch_metric</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">batch_metric</span> <span class="o">=</span> <span class="n">is_batch_metric</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">batch_metric</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">batch_metric</span><span class="p">:</span>
            <span class="c1"># Is this a analyzer_batch related anomaly</span>
            <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">analyzer_batch_metric_anomaly_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer_batch.anomaly.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: could not query cache_key - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">analyzer_batch_anomaly</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">analyzer_batch_anomaly</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;identified as an analyzer_batch triggered anomaly from the presence of the Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not identified as an analyzer_batch triggered anomaly as no Redis key found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">analyzer_batch_metric_anomaly_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last_check</span> <span class="ow">and</span> <span class="n">analyzer_batch_anomaly</span><span class="p">:</span>
                <span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">last_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_check</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine last_timestamp for batch metric Panorama key- </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                    <span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">seconds_between_batch_anomalies</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">last_timestamp</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">seconds_between_batch_anomalies</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine seconds_between_batch_anomalies for batch metric Panorama key- </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                        <span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">seconds_between_batch_anomalies</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">seconds_between_batch_anomalies</span> <span class="o">&gt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_EXPIRY_TIME</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the difference between the last anomaly timestamp (</span><span class="si">%s</span><span class="s1">) and the current anomaly timestamp (</span><span class="si">%s</span><span class="s1">) for batch metric </span><span class="si">%s</span><span class="s1"> is greater than </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_EXPIRY_TIME</span><span class="p">)))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;recording anomaly for batch metric </span><span class="si">%s</span><span class="s1">, so setting last_check to None&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric</span><span class="p">))</span>
                        <span class="n">last_check</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the difference between the last anomaly timestamp (</span><span class="si">%s</span><span class="s1">) and the current anomaly timestamp (</span><span class="si">%s</span><span class="s1">) for batch metric </span><span class="si">%s</span><span class="s1"> is less than </span><span class="si">%s</span><span class="s1">, not recording the anomaly&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_EXPIRY_TIME</span><span class="p">)))</span>

                    <span class="c1"># @added 20200603 - Task #3562; Change panorama.last_check keys to timestamp value</span>
                    <span class="c1">#                   Feature #3486: analyzer_batch</span>
                    <span class="c1">#                   Feature #3480: batch_processing</span>
                    <span class="c1"># If the metric is a batch processing metric and the anomaly</span>
                    <span class="c1"># timestamp is less than the last_check timestamp, insert</span>
                    <span class="c1"># the anomaly</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">last_timestamp</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;batch anomaly timestamp (</span><span class="si">%s</span><span class="s1">) less than the last_check timestamp (</span><span class="si">%s</span><span class="s1">), recording anomaly for batch metric </span><span class="si">%s</span><span class="s1">, so setting last_check to None&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">))</span>
                        <span class="n">last_check</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">last_check</span><span class="p">:</span>
            <span class="n">record_anomaly</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Panorama metric key not expired - </span><span class="si">%s</span><span class="s1">.last_check.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">skyline_app</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>

        <span class="c1"># @added 20200420 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                   Feature #1448: Crucible web UI</span>
        <span class="c1">#                   Branch #868: crucible</span>
        <span class="c1"># Added check_max_age</span>
        <span class="n">check_max_age</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">set_anomaly_key</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">add_to_current_anomalies</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;webapp&#39;</span><span class="p">,</span> <span class="s1">&#39;crucible&#39;</span><span class="p">]:</span>
            <span class="n">check_max_age</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">set_anomaly_key</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">add_to_current_anomalies</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">batch_metric</span><span class="p">:</span>
            <span class="n">check_max_age</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20160907 - Handle Panorama stampede on restart after not running #26</span>
        <span class="c1"># Allow to expire check if greater than PANORAMA_CHECK_MAX_AGE</span>
        <span class="c1"># @modified 20200413 - Feature #3486: analyzer_batch</span>
        <span class="c1">#                      Feature #3480: batch_processing</span>
        <span class="c1"># Only evaluate max_age is the metric is not a batch metric</span>
        <span class="c1"># @modied 20200420 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                   Feature #1448: Crucible web UI</span>
        <span class="c1">#                   Branch #868: crucible</span>
        <span class="c1"># if not batch_metric:</span>
        <span class="k">if</span> <span class="n">check_max_age</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_age</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="n">anomaly_age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">anomaly_age</span> <span class="o">&gt;</span> <span class="n">max_age_seconds</span><span class="p">:</span>
                    <span class="n">record_anomaly</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Panorama check max age exceeded - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1"> seconds old, older than </span><span class="si">%s</span><span class="s1"> seconds discarding&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_age</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_age_seconds</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">record_anomaly</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not recording anomaly for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_check_file removed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">return</span>

        <span class="c1"># Determine id of something thing</span>
        <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                     Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="c1"># Use self.determine_db_id instead, declare the function once</span>
        <span class="c1"># def determine_id(table, key, value):</span>
        <span class="k">def</span> <span class="nf">old_determine_id</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get the id of something from Redis or the database and create a new</span>
<span class="sd">            Redis key with the value if one does not exist.</span>

<span class="sd">            :param table: table name</span>
<span class="sd">            :param key: key name</span>
<span class="sd">            :param value: value name</span>
<span class="sd">            :type table: str</span>
<span class="sd">            :type key: str</span>
<span class="sd">            :type value: str</span>
<span class="sd">            :return: int or boolean</span>

<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">query_cache_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.mysql_ids.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">determined_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">redis_determined_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: query_cache_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_cache_key</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">redis_known_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_cache_key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">redis_known_id</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">redis_known_id</span><span class="p">:</span>
                <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">redis_known_id</span><span class="p">)</span>
                <span class="n">redis_determined_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpacker</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">redis_determined_id</span><span class="p">:</span>
                <span class="n">determined_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">redis_determined_id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">determined_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">determined_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">determined_id</span>

            <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_db_id :: could not get a MySQL engine - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">determined_id</span>
            <span class="c1"># Use the MetaData autoload rather than string-based query construction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">use_table_meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
                <span class="n">use_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">use_table_meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_id :: use_table Table failed on </span><span class="si">%s</span><span class="s1"> table - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">table</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># Query MySQL</span>
            <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
            <span class="c1"># Added nosec to exclude from bandit tests</span>
            <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># query = &#39;select id FROM %s WHERE %s=\&#39;%s\&#39;&#39; % (table, key, value)  # nosec</span>
            <span class="n">determined_id</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @modified 20170916 - Bug #2166: panorama incorrect mysql_id cache keys</span>
            <span class="c1"># Wrap in except</span>
            <span class="c1"># results = self.mysql_select(query)</span>

            <span class="c1"># results = None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="c1"># results = self.mysql_select(query)</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">use_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">use_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
                    <span class="n">determined_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># logger.error(&#39;error :: failed to determine results from - %s&#39; % (query))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_id :: failed to determine results from - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">stmt</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># determined_id = 0</span>
            <span class="c1"># if results:</span>
            <span class="c1">#     try:</span>
            <span class="c1">#         determined_id = int(results[0][0])</span>
            <span class="c1">#     except Exception as e:</span>
            <span class="c1">#         logger.error(traceback.format_exc())</span>
            <span class="c1">#         logger.error(&#39;error :: determined_id is not an int - %s&#39; % e)</span>
            <span class="c1">#         determined_id = 0</span>

            <span class="k">if</span> <span class="n">determined_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Set the key for a week</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">redis_determined_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">query_cache_key</span><span class="p">,</span> <span class="mi">604800</span><span class="p">,</span> <span class="n">packb</span><span class="p">(</span><span class="n">determined_id</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set redis query_cache_key - </span><span class="si">%s</span><span class="s1"> - id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">query_cache_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">determined_id</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to set query_cache_key - </span><span class="si">%s</span><span class="s1"> - id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">query_cache_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">determined_id</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">determined_id</span><span class="p">)</span>

            <span class="c1"># @added 20170115 - Feature #1854: Ionosphere learn - generations</span>
            <span class="c1"># Added determination of the learn related variables</span>
            <span class="c1"># learn_full_duration_days, learn_valid_ts_older_than,</span>
            <span class="c1"># max_generations and max_percent_diff_from_origin value to the</span>
            <span class="c1"># insert statement if the table is the metrics table.</span>
            <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="c1"># Set defaults</span>
                <span class="n">learn_full_duration_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_FULL_DURATION_DAYS</span><span class="p">)</span>
                <span class="n">valid_learning_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_VALID_TIMESERIES_OLDER_THAN_SECONDS</span><span class="p">)</span>
                <span class="n">max_generations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_MAX_GENERATIONS</span><span class="p">)</span>
                <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_MAX_PERCENT_DIFF_FROM_ORIGIN</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">use_full_duration</span><span class="p">,</span> <span class="n">valid_learning_duration</span><span class="p">,</span> <span class="n">use_full_duration_days</span><span class="p">,</span> <span class="n">max_generations</span><span class="p">,</span> <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="n">get_ionosphere_learn_details</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">learn_full_duration_days</span> <span class="o">=</span> <span class="n">use_full_duration_days</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get_ionosphere_learn_details for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric learn details determined for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn_full_duration_days     :: </span><span class="si">%s</span><span class="s1"> days&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;valid_learning_duration      :: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">valid_learning_duration</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;max_generations              :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_generations</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;max_percent_diff_from_origin :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">)))</span>

            <span class="c1"># INSERT because no known id</span>
            <span class="c1"># @modified 20170115 - Feature #1854: Ionosphere learn - generations</span>
            <span class="c1"># Added the learn_full_duration_days, learn_valid_ts_older_than,</span>
            <span class="c1"># max_generations and max_percent_diff_from_origin value to the</span>
            <span class="c1"># insert statement if the table is the metrics table.</span>
            <span class="c1"># insert_query = &#39;insert into %s (%s) VALUES (\&#39;%s\&#39;)&#39; % (table, key, value)</span>
            <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
                <span class="c1"># Added nosec to exclude from bandit tests</span>
                <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="c1"># insert_query_string = &#39;%s (%s, learn_full_duration_days, learn_valid_ts_older_than, max_generations, max_percent_diff_from_origin) VALUES (\&#39;%s\&#39;, %s, %s, %s, %s)&#39; % (</span>
                <span class="c1">#     table, key, value, str(learn_full_duration_days),</span>
                <span class="c1">#     str(valid_learning_duration), str(max_generations),</span>
                <span class="c1">#     str(max_percent_diff_from_origin))</span>
                <span class="c1"># insert_query = &#39;insert into %s&#39; % insert_query_string  # nosec</span>

                <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">use_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
                    <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                    <span class="s1">&#39;learn_full_duration_days&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">),</span>
                    <span class="s1">&#39;learn_valid_ts_older_than&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_learning_duration</span><span class="p">),</span>
                    <span class="s1">&#39;max_generations&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_generations</span><span class="p">),</span>
                    <span class="s1">&#39;max_percent_diff_from_origin&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">)})</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="c1"># insert_query = &#39;insert into %s (%s) VALUES (\&#39;%s\&#39;)&#39; % (table, key, value)  # nosec</span>

                <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">use_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;inserting </span><span class="si">%s</span><span class="s1"> into </span><span class="si">%s</span><span class="s1"> table&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="c1"># results = self.mysql_insert(insert_query)</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_stmt</span><span class="p">)</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">determined_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">inserted_primary_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine the id of </span><span class="si">%s</span><span class="s1"> from the insert - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_id :: engine.dispose() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>

                <span class="k">raise</span>

            <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_id :: engine.dispose() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># determined_id = 0</span>
            <span class="c1"># if results:</span>
            <span class="c1">#     determined_id = int(results)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     logger.error(&#39;error :: results not set&#39;)</span>
            <span class="c1">#     raise ValueError(&#39;error :: results not set&#39;)</span>

            <span class="k">if</span> <span class="n">determined_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Set the key for a week</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">redis_determined_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">query_cache_key</span><span class="p">,</span> <span class="mi">604800</span><span class="p">,</span> <span class="n">packb</span><span class="p">(</span><span class="n">determined_id</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set redis query_cache_key - </span><span class="si">%s</span><span class="s1"> - id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">query_cache_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">determined_id</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to set query_cache_key - </span><span class="si">%s</span><span class="s1"> - id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">query_cache_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">determined_id</span><span class="p">)))</span>
                <span class="k">return</span> <span class="n">determined_id</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine the inserted id for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                     Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># Use self.determine_db_id instead, declare the function once</span>
            <span class="c1"># added_by_host_id = determine_id(&#39;hosts&#39;, &#39;host&#39;, added_by)</span>
            <span class="n">added_by_host_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_db_id</span><span class="p">(</span><span class="s1">&#39;hosts&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="n">added_by</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># logger.error(&#39;error :: failed to determine id of %s&#39; % (added_by))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: self.determine_db_id failed to determine id of </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">added_by</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                     Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># Use self.determine_db_id instead, declare the function once</span>
            <span class="c1"># app_id = determine_id(&#39;apps&#39;, &#39;app&#39;, app)</span>
            <span class="n">app_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_db_id</span><span class="p">(</span><span class="s1">&#39;apps&#39;</span><span class="p">,</span> <span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># logger.error(&#39;error :: failed to determine id of %s&#39; % (app))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: self.determine_db_id failed to determine id of </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                     Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># Use self.determine_db_id instead, declare the function once</span>
            <span class="c1"># source_id = determine_id(&#39;sources&#39;, &#39;source&#39;, source)</span>
            <span class="n">source_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_db_id</span><span class="p">(</span><span class="s1">&#39;sources&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># logger.error(&#39;error :: failed to determine id of %s&#39; % (source))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: self.determine_db_id failed to determine id of </span><span class="si">%s</span><span class="s1">- </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># @added 20220722 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="n">labelled_metrics_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
            <span class="n">labelled_metrics_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;looking up metric for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="s1">&#39;panorama&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                     Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># Use self.determine_db_id instead, declare the function once</span>
            <span class="c1"># metric_id = determine_id(&#39;metrics&#39;, &#39;metric&#39;, metric)</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_db_id</span><span class="p">(</span><span class="s1">&#39;metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># logger.error(&#39;error :: failed to determine id of %s&#39; % (metric))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: self.determine_db_id failed to determine id of </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># @added 20221103 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">labelled_metrics_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>

        <span class="n">algorithms_ids_csv</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
            <span class="c1"># @added 20220822 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="c1"># Strip override string</span>
            <span class="k">if</span> <span class="s1">&#39; (override - &#39;</span> <span class="ow">in</span> <span class="n">algorithm</span><span class="p">:</span>
                <span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                     Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="c1"># Use self.determine_db_id instead, declare the function once</span>
                <span class="c1"># algorithm_id = determine_id(&#39;algorithms&#39;, &#39;algorithm&#39;, algorithm)</span>
                <span class="n">algorithm_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_db_id</span><span class="p">(</span><span class="s1">&#39;algorithms&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithm&#39;</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># logger.error(&#39;error :: failed to determine id of %s&#39; % (algorithm))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: self.determine_db_id failed to determine id of </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">algorithm</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">algorithms_ids_csv</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">algorithms_ids_csv</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithm_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_algorithms_ids_csv</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">algorithms_ids_csv</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithm_id</span><span class="p">))</span>
                <span class="n">algorithms_ids_csv</span> <span class="o">=</span> <span class="n">new_algorithms_ids_csv</span>

        <span class="n">triggered_algorithms_ids_csv</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">triggered_algorithm</span> <span class="ow">in</span> <span class="n">triggered_algorithms</span><span class="p">:</span>
            <span class="c1"># @added 20220822 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="c1"># Strip override string</span>
            <span class="k">if</span> <span class="s1">&#39; (override - &#39;</span> <span class="ow">in</span> <span class="n">triggered_algorithm</span><span class="p">:</span>
                <span class="n">triggered_algorithm</span> <span class="o">=</span> <span class="n">triggered_algorithm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                     Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="c1"># Use self.determine_db_id instead, declare the function once</span>
                <span class="c1"># triggered_algorithm_id = determine_id(&#39;algorithms&#39;, &#39;algorithm&#39;, triggered_algorithm)</span>
                <span class="n">triggered_algorithm_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_db_id</span><span class="p">(</span><span class="s1">&#39;algorithms&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithm&#39;</span><span class="p">,</span> <span class="n">triggered_algorithm</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># logger.error(&#39;error :: failed to determine id of %s&#39; % (triggered_algorithm))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: self.determine_db_id failed to determine id of </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">triggered_algorithm</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">triggered_algorithms_ids_csv</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">triggered_algorithms_ids_csv</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">triggered_algorithm_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_triggered_algorithms_ids_csv</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">triggered_algorithms_ids_csv</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">triggered_algorithm_id</span><span class="p">))</span>
                <span class="n">triggered_algorithms_ids_csv</span> <span class="o">=</span> <span class="n">new_triggered_algorithms_ids_csv</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;inserting anomaly&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: full_duration - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_duration</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine full_duration&#39;</span><span class="p">)</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">anomalous_datapoint</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: anomalous_datapoint - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalous_datapoint</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine anomalous_datapoint&#39;</span><span class="p">)</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20200420 - Feature #3500: webapp - crucible_process_metrics</span>
            <span class="c1">#                      Feature #1448: Crucible web UI</span>
            <span class="c1">#                      Branch #868: crucible</span>
            <span class="c1"># Added label and user_id</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="s1">&#39;metric_id&#39;</span><span class="p">,</span> <span class="s1">&#39;host_id&#39;</span><span class="p">,</span> <span class="s1">&#39;app_id&#39;</span><span class="p">,</span> <span class="s1">&#39;source_id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;anomalous_datapoint&#39;</span><span class="p">,</span> <span class="s1">&#39;full_duration&#39;</span><span class="p">,</span>
                <span class="s1">&#39;algorithms_run&#39;</span><span class="p">,</span> <span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: columns - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to construct columns string&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine for anomalies_table - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">anomalies_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">anomalies_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: spin_process :: failed to get anomalies_table meta - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
            <span class="c1"># Added nosec to exclude from bandit tests</span>
            <span class="c1"># @modified 20200420 - Feature #3500: webapp - crucible_process_metrics</span>
            <span class="c1">#                      Feature #1448: Crucible web UI</span>
            <span class="c1">#                      Branch #868: crucible</span>
            <span class="c1"># Added label and user_id</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="c1"># User the Skyline user id</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">query_string</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">) VALUES (</span><span class="si">%d</span><span class="s1">, </span><span class="si">%d</span><span class="s1">, </span><span class="si">%d</span><span class="s1">, </span><span class="si">%d</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%.6f</span><span class="s1">, </span><span class="si">%d</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, </span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">columns</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">,</span> <span class="n">added_by_host_id</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span>
                <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">anomalous_datapoint</span><span class="p">,</span> <span class="n">full_duration</span><span class="p">,</span>
                <span class="n">algorithms_ids_csv</span><span class="p">,</span> <span class="n">triggered_algorithms_ids_csv</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;insert into anomalies </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query_string</span>  <span class="c1"># nosec</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to construct insert query&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: anomaly insert - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

        <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># anomaly_id = self.mysql_insert(query)</span>
            <span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">anomalies_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
                <span class="n">metric_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span>
                <span class="n">host_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">added_by_host_id</span><span class="p">),</span>
                <span class="n">app_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">app_id</span><span class="p">),</span>
                <span class="n">source_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">source_id</span><span class="p">),</span>
                <span class="n">anomaly_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                <span class="n">anomalous_datapoint</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">anomalous_datapoint</span><span class="p">),</span>
                <span class="n">full_duration</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">full_duration</span><span class="p">),</span>
                <span class="n">algorithms_run</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">algorithms_ids_csv</span><span class="p">),</span>
                <span class="n">triggered_algorithms</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">triggered_algorithms_ids_csv</span><span class="p">),</span>
                <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
                <span class="n">user_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_stmt</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">anomaly_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">inserted_primary_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;anomaly id - </span><span class="si">%d</span><span class="s1"> - created for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">anomaly_id</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to insert anomaly for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: engine.dispose() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># @added 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: engine.dispose() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="c1"># @added 20211001 - Feature #4268: Redis hash key - panorama.metrics.latest_anomaly</span>
        <span class="c1">#                   Feature #4264: luminosity - cross_correlation_relationships</span>
        <span class="k">if</span> <span class="n">anomaly_id</span><span class="p">:</span>
            <span class="n">latest_anomaly</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">latest_anomaly</span> <span class="o">=</span> <span class="n">update_metric_latest_anomaly</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_metric_latest_anomaly failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

        <span class="c1"># @added 20200929 - Task #3748: POC SNAB</span>
        <span class="c1">#                   Branch #3068: SNAB</span>
        <span class="c1"># If snab is enabled add a Redis key with the anomaly_id</span>
        <span class="k">if</span> <span class="n">anomaly_id</span><span class="p">:</span>
            <span class="n">anomaly_id_redis_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.anomaly_id.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)),</span> <span class="n">metric</span><span class="p">)</span>
            <span class="c1"># @added 20220915 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="k">if</span> <span class="n">labelled_metrics_name</span><span class="p">:</span>
                <span class="n">anomaly_id_redis_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.anomaly_id.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)),</span> <span class="n">labelled_metrics_name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">anomaly_id_redis_key</span><span class="p">,</span> <span class="mi">86400</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set Redis anomaly_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">anomaly_id_redis_key</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: could not set anomaly_id_redis_key - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">anomaly_id_redis_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="c1"># Set anomaly record cache key</span>
        <span class="c1"># @modified 20200420 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                      Feature #1448: Crucible web UI</span>
        <span class="c1">#                      Branch #868: crucible</span>
        <span class="c1"># Only if it was not added_by webapp or crucible</span>
        <span class="k">if</span> <span class="n">set_anomaly_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20200413 - Feature #3486: analyzer_batch</span>
                <span class="c1">#                   Feature #3480: batch_processing</span>
                <span class="c1"># Set key to timestamp if a batch metric.  I have looked and cannot</span>
                <span class="c1"># find where the panorama.last_check is used anyway else other than</span>
                <span class="c1"># above in panorama its self and further it does not appear that the</span>
                <span class="c1"># packb(value) is used at all, just the existence of the key its</span>
                <span class="c1"># self.</span>
                <span class="k">if</span> <span class="n">batch_metric</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
                        <span class="n">cache_key</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_EXPIRY_TIME</span><span class="p">,</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
                        <span class="c1"># @modified 20200603 - Feature #3486: analyzer_batch</span>
                        <span class="c1">#                      Feature #3480: batch_processing</span>
                        <span class="c1"># As per above do not use msgpack with the value, set the</span>
                        <span class="c1"># value to the timestamp</span>
                        <span class="c1"># cache_key, settings.PANORAMA_EXPIRY_TIME, packb(value))</span>
                        <span class="n">cache_key</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_EXPIRY_TIME</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set cache_key - </span><span class="si">%s</span><span class="s1">.last_check.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">skyline_app</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_EXPIRY_TIME</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: could not set cache_key - </span><span class="si">%s</span><span class="s1">.last_check.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">skyline_app</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="c1"># @added 20191031 - Feature #3306: Record anomaly_end_timestamp</span>
        <span class="c1"># Add to current anomalies set</span>
        <span class="c1"># @modified 20200420 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                      Feature #1448: Crucible web UI</span>
        <span class="c1">#                      Branch #868: crucible</span>
        <span class="c1"># Only if it was not added_by webapp or crucible</span>
        <span class="k">if</span> <span class="n">add_to_current_anomalies</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;current.anomalies&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">anomaly_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: could not add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_check_file removed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">anomaly_id</span></div>

<div class="viewcode-block" id="Panorama.run"><a class="viewcode-back" href="../../skyline.panorama.html#panorama.panorama.Panorama.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the process intializes.</span>

<span class="sd">        Determine if what is known in the Skyline DB</span>
<span class="sd">        blah</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Log management to prevent overwriting</span>
        <span class="c1"># Allow the bin/&lt;skyline_app&gt;.d to manage the log</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logwait</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logwait</span><span class="p">)</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">log_wait_for</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="k">while</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">log_wait_for</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">log_wait_for</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting </span><span class="si">%s</span><span class="s1"> run&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: bin/</span><span class="si">%s</span><span class="s1">.d log management seems to have failed, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;log lock file removed&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app_loglock</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bin/</span><span class="si">%s</span><span class="s1">.d log management done&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>

        <span class="c1"># See if I am known in the DB, if so, what are my variables</span>
        <span class="c1"># self.populate mysql</span>
        <span class="c1"># What is my host id in the Skyline panorama DB?</span>
        <span class="c1">#   - if not known - INSERT hostname INTO hosts</span>
        <span class="c1"># What are the known apps?</span>
        <span class="c1">#   - if returned make a dictionary</span>
        <span class="c1"># What are the known algorithms?</span>
        <span class="c1">#   - if returned make a dictionary</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="c1"># Make sure Redis is up</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: connected to Redis&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cannot connect to redis at socket path </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">))</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
                <span class="c1"># @modified 20191031 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># if settings.REDIS_PASSWORD:</span>
                <span class="c1">#     self.redis_conn = StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="c1"># else:</span>
                <span class="c1">#     self.redis_conn = StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Report app up</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;updated Redis key for </span><span class="si">%s</span><span class="s1"> up&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to update Redis key for </span><span class="si">%s</span><span class="s1"> up&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>

            <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># Disabled all ENABLE_PANORAMA_DEBUG mysql tests</span>
            <span class="c1"># if ENABLE_PANORAMA_DEBUG:</span>
            <span class="c1">#     # Make sure mysql is available</span>
            <span class="c1">#     mysql_down = True</span>
            <span class="c1">#     while mysql_down:</span>
            <span class="c1">#         query = &#39;SHOW TABLES&#39;</span>
            <span class="c1">#         results = self.mysql_select(query)</span>
            <span class="c1">#         if results:</span>
            <span class="c1">#             mysql_down = False</span>
            <span class="c1">#             logger.info(&#39;debug :: tested database query - OK&#39;)</span>
            <span class="c1">#         else:</span>
            <span class="c1">#             logger.error(&#39;error :: failed to query database&#39;)</span>
            <span class="c1">#             sleep(30)</span>
            <span class="c1">#     try:</span>
            <span class="c1">#         query = &#39;SELECT id, test FROM test&#39;</span>
            <span class="c1">#         result = self.mysql_select(query)</span>
            <span class="c1">#         logger.info(&#39;debug :: tested mysql SELECT query - OK&#39;)</span>
            <span class="c1">#         logger.info(&#39;debug :: result: %s&#39; % str(result))</span>
            <span class="c1">#         logger.info(&#39;debug :: result[0]: %s&#39; % str(result[0]))</span>
            <span class="c1">#         logger.info(&#39;debug :: result[1]: %s&#39; % str(result[1]))</span>
<span class="c1"># Works</span>
<span class="c1"># 2016-06-10 19:07:23 :: 4707 :: result: [(1, u&#39;test1&#39;)]</span>
            <span class="c1">#     except:</span>
            <span class="c1">#         logger.error(</span>
            <span class="c1">#             &#39;error :: mysql error - %s&#39; %</span>
            <span class="c1">#             traceback.print_exc())</span>
            <span class="c1">#         logger.error(&#39;error :: failed to SELECT&#39;)</span>

            <span class="c1"># self.populate the database metatdata tables</span>
            <span class="c1"># What is my host id in the Skyline panorama DB?</span>
            <span class="n">host_id</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
            <span class="c1"># Added nosec to exclude from bandit tests</span>
            <span class="c1"># @modified 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># If this case use the determine_db_id function which now uses</span>
            <span class="c1"># sqlalchemy</span>
            <span class="c1"># query = &#39;select id FROM hosts WHERE host=\&#39;%s\&#39;&#39; % this_host  # nosec</span>
            <span class="c1"># results = self.mysql_select(query)</span>
            <span class="c1"># if results:</span>
            <span class="c1">#     host_id = results[0][0]</span>
            <span class="c1">#     logger.info(&#39;host_id: %s&#39; % str(host_id))</span>
            <span class="c1"># else:</span>
            <span class="c1">#     logger.info(&#39;failed to determine host id of %s&#39; % this_host)</span>
            <span class="c1"># #   - if not known - INSERT hostname INTO host</span>
            <span class="c1"># if not host_id:</span>
            <span class="c1">#     logger.info(&#39;inserting %s into hosts table&#39; % this_host)</span>
            <span class="c1">#     # @modified 20170913 - Task #2160: Test skyline with bandit</span>
            <span class="c1">#     # Added nosec to exclude from bandit tests</span>
            <span class="c1">#     query = &#39;insert into hosts (host) VALUES (\&#39;%s\&#39;)&#39; % this_host  # nosec</span>
            <span class="c1">#     host_id = self.mysql_insert(query)</span>
            <span class="c1">#     if host_id:</span>
            <span class="c1">#         logger.info(&#39;new host_id: %s&#39; % str(host_id))</span>

            <span class="c1"># @added 20230109 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">host_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_db_id</span><span class="p">(</span><span class="s1">&#39;hosts&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="n">this_host</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;host_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">host_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: determine_db_id failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">host_id</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: failed to determine populate </span><span class="si">%s</span><span class="s1"> into the hosts table&#39;</span> <span class="o">%</span>
                    <span class="n">this_host</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Like loop through the panorama dir and see if anyone has left you</span>
            <span class="c1"># any work, etc</span>
            <span class="c1"># Make sure check_dir exists and has not been removed</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: checking check dir exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: check dir did not exist - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">)</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;check dir created - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">)</span>
                <span class="c1"># continue</span>

            <span class="c1"># Determine if any metric has been added to add</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">metric_var_files</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_var_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to list files in check dir&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_var_files</span><span class="p">:</span>

                    <span class="c1"># @added 20200204 - Feature #3442: Panorama - add metric to metrics table immediately</span>
                    <span class="k">if</span> <span class="n">PANORAMA_INSERT_METRICS_IMMEDIATELY</span><span class="p">:</span>
                        <span class="c1"># Only check once a minute</span>
                        <span class="n">redis_insert_new_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.insert_new_metrics&#39;</span>
                        <span class="n">redis_insert_new_metrics_key_exists</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_insert_new_metrics_key_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_insert_new_metrics_key</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not query Redis for key </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_insert_new_metrics_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="n">check_metrics_to_insert</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">redis_insert_new_metrics_key_exists</span><span class="p">:</span>
                            <span class="n">check_metrics_to_insert</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checking for new metrics to insert into the metrics table&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">check_metrics_to_insert</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checking for new unique_metrics to insert into the metrics table&#39;</span><span class="p">)</span>
                            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">unique_metrics&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get data from </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="n">redis_set</span><span class="p">)</span>
                                <span class="n">unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">db_fullnamespace_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">results</span> <span class="o">=</span> <span class="kc">False</span>

                            <span class="c1"># @added 20220630 - Task #2732: Prometheus to Skyline</span>
                            <span class="c1">#                   Branch #4300: prometheus</span>
                            <span class="n">db_metric_names</span> <span class="o">=</span> <span class="p">[]</span>

                            <span class="k">if</span> <span class="n">unique_metrics</span><span class="p">:</span>

                                <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                                <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                                <span class="c1"># But in this case use the get_all_db_metric_names</span>
                                <span class="c1"># function</span>
                                <span class="c1"># query = &#39;SELECT metric FROM metrics&#39;</span>
                                <span class="c1"># results = self.mysql_select(query)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">with_ids</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="n">results</span> <span class="o">=</span> <span class="n">get_all_db_metric_names</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">with_ids</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_all_db_metric_names failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                                        <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                                        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                                        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                                        <span class="c1"># db_metric_name = &#39;%s%s&#39; % (settings.FULL_NAMESPACE, str(result[0]))</span>
                                        <span class="n">db_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
                                        <span class="n">db_fullnamespace_unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db_metric_name</span><span class="p">)</span>
                                        <span class="c1"># @added 20220630 - Task #2732: Prometheus to Skyline</span>
                                        <span class="c1">#                   Branch #4300: prometheus</span>
                                        <span class="c1"># @modified 20230110 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                                        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                                        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                                        <span class="c1"># db_metric_names.append(str(result[0]))</span>
                                        <span class="n">db_metric_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

                            <span class="k">if</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="n">db_fullnamespace_unique_metrics</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">unique_metric</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">unique_metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db_fullnamespace_unique_metrics</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="c1"># @modified 20200728 - Bug #3652: Handle multiple metrics in base_name conversion</span>
                                            <span class="c1"># base_name = unique_metric.replace(settings.FULL_NAMESPACE, &#39;&#39;, 1)</span>
                                            <span class="k">if</span> <span class="n">unique_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                                                <span class="n">base_name</span> <span class="o">=</span> <span class="n">unique_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">base_name</span> <span class="o">=</span> <span class="n">unique_metric</span>

                                            <span class="n">metric_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_new_metric</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;inserted </span><span class="si">%s</span><span class="s1"> into metrics table from db_fullnamespace_unique_metrics, assigned id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)))</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to insert </span><span class="si">%s</span><span class="s1"> into metrics table&#39;</span> <span class="o">%</span> <span class="n">unique_metric</span><span class="p">)</span>

                            <span class="c1"># @added 20220630 - Task #2732: Prometheus to Skyline</span>
                            <span class="c1">#                   Branch #4300: prometheus</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checking for new labelled_metrics to insert into the metrics table against </span><span class="si">%s</span><span class="s1"> known metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">db_metric_names</span><span class="p">)))</span>
                            <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">unique_labelled_metric_ids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">unique_labelled_metric_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.unique_labelled_metrics&#39;</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get data from labelled_metrics.unique_labelled_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                                <span class="n">unique_labelled_metric_ids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="n">unique_labelled_metric_ids</span><span class="p">:</span>
                                <span class="n">ids_with_base_names</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">ids_with_base_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.ids_with_metric_names&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_all_db_metric_names failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">unique_labelled_metric_id</span> <span class="ow">in</span> <span class="n">unique_labelled_metric_ids</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">unique_labelled_metric_id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">ids_with_base_names</span><span class="p">[</span><span class="n">metric_id_str</span><span class="p">]</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                    <span class="n">unique_labelled_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">unique_labelled_metric_ids</span>
                            <span class="n">horizon_metrics_without_ids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">horizon_metrics_without_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;panorama.horizon.metrics_with_no_id&#39;</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">horizon_metrics_without_ids</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> metrics without ids from panorama.horizon.metrics_with_no_id&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">horizon_metrics_without_ids</span><span class="p">)))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: smembers failed on Redis set panorama.horizon.metrics_with_no_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">horizon_metrics_without_ids</span><span class="p">:</span>
                                <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="n">unique_labelled_metrics</span> <span class="o">+</span> <span class="n">horizon_metrics_without_ids</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># self.redis_conn_decoded.delete(&#39;panorama.horizon.metrics_with_no_id&#39;)</span>
                                    <span class="n">new_key_name</span> <span class="o">=</span> <span class="s1">&#39;panorama.horizon.metrics_with_no_id.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;panorama.horizon.metrics_with_no_id&#39;</span><span class="p">,</span> <span class="n">new_key_name</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">new_key_name</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to delete Redis set panorama.horizon.metrics_with_no_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                            <span class="k">del</span> <span class="n">horizon_metrics_without_ids</span>

                            <span class="c1"># @added 20220819 -</span>
                            <span class="c1"># Added inserted metrics to the relevant Redis resources</span>
                            <span class="c1"># so that metrics are processed</span>
                            <span class="n">inserted_metric_ids</span> <span class="o">=</span> <span class="p">[]</span>

                            <span class="k">if</span> <span class="n">unique_labelled_metrics</span> <span class="ow">and</span> <span class="n">db_metric_names</span><span class="p">:</span>
                                <span class="c1"># Using a sets comparison rather than a for loop</span>
                                <span class="c1"># takes 0 seconds rather than 5 seconds for a</span>
                                <span class="c1"># loop over 42955 metrics</span>
                                <span class="n">labelled_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique_labelled_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">unique_labelled_metric</span> <span class="ow">in</span> <span class="n">unique_labelled_metrics</span><span class="p">]</span>
                                <span class="n">db_metric_names_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">db_metric_names</span><span class="p">)</span>
                                <span class="n">labelled_metrics_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">labelled_metrics</span><span class="p">)</span>
                                <span class="n">unknown_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labelled_metrics_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">db_metric_names_set</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">labelled_basename</span> <span class="ow">in</span> <span class="n">unknown_metrics</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">metric_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_new_metric</span><span class="p">(</span><span class="n">labelled_basename</span><span class="p">)</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;inserted </span><span class="si">%s</span><span class="s1"> into metrics table from unique_labelled_metrics and db_metric_names, assigned id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">labelled_basename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)))</span>
                                        <span class="c1"># @added 20220819</span>
                                        <span class="n">inserted_metric_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to insert </span><span class="si">%s</span><span class="s1"> into metrics table - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">labelled_basename</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                            <span class="c1"># @added 20220819</span>
                            <span class="c1"># Added inserted metrics to the relevant Redis resources</span>
                            <span class="c1"># so that metrics are processed</span>
                            <span class="k">if</span> <span class="n">inserted_metric_ids</span><span class="p">:</span>
                                <span class="n">now_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="n">inserted_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="n">inserted_metric_ids</span><span class="p">:</span>
                                    <span class="n">data_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">now_ts</span>
                                    <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                                    <span class="n">inserted_labelled_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;inserting </span><span class="si">%s</span><span class="s1"> entries into analyzer_labelled_metrics.last_timeseries_timestamp Redis hash&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;analyzer_labelled_metrics.last_timeseries_timestamp&#39;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">data_dict</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to update analyzer_labelled_metrics.last_timeseries_timestamp Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;inserting </span><span class="si">%s</span><span class="s1"> metrics into labelled_metrics.unique_labelled_metrics Redis set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inserted_labelled_metrics</span><span class="p">)))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.unique_labelled_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">inserted_labelled_metrics</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to sadd to labelled_metrics.unique_labelled_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">unknown_metrics</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">unique_labelled_metrics</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">db_metric_names</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">unique_metrics</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">results</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_insert_new_metrics_key</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to set key :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_insert_new_metrics_key</span><span class="p">)</span>

                    <span class="c1"># @modified 20200128 - Feature #3418: PANORAMA_CHECK_INTERVAL</span>
                    <span class="c1"># Allow Panaroma to check for anomalies more frequently.  At</span>
                    <span class="c1"># some point TODO replace Panorama check files with Redis</span>
                    <span class="c1"># keys or a set.</span>
                    <span class="c1"># logger.info(&#39;sleeping 20 no metric check files&#39;)</span>
                    <span class="c1"># sleep(20)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sleeping for </span><span class="si">%s</span><span class="s1"> seconds - no metric check files&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">PANORAMA_CHECK_INTERVAL</span><span class="p">))</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="n">PANORAMA_CHECK_INTERVAL</span><span class="p">)</span>

                <span class="c1"># Discover metric anomalies to insert</span>
                <span class="n">metric_var_files</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_var_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to list files in check dir&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">metric_var_files</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># @added 20191107 - Feature #3306: Record anomaly_end_timestamp</span>
                <span class="c1">#                   Branch #3262: py3</span>
                <span class="c1"># Set the anomaly_end_timestamp for any metrics no longer anomalous</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;current.anomalies&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_anomalies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get data from </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="n">redis_set</span><span class="p">)</span>
                    <span class="n">current_anomalies</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">current_anomalies</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">current_anomalies</span><span class="p">:</span>
                        <span class="n">remove_item</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">list_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="n">anomalous_metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">anomaly_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">anomaly_end_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">anomaly_end_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to evaluate data from item </span><span class="si">%s</span><span class="s1"> from Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">anomaly_id</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">anomaly_timestamp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">STALE_PERIOD</span><span class="p">):</span>
                                <span class="c1"># If no anomaly is has been created by now, it</span>
                                <span class="c1"># never will be created.</span>
                                <span class="n">remove_item</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">anomaly_end_timestamp</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">remove_item</span><span class="p">:</span>
                                <span class="k">continue</span>

                        <span class="k">if</span> <span class="n">anomaly_id</span> <span class="ow">and</span> <span class="n">anomaly_end_timestamp</span><span class="p">:</span>
                            <span class="c1"># Update SQL</span>
                            <span class="c1"># Spawn update_anomaly_end_timestamp process</span>
                            <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_anomaly_end_timestamp</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">anomaly_id</span><span class="p">,</span> <span class="n">anomaly_end_timestamp</span><span class="p">))</span>
                                    <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                                    <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting update_anomaly_end_timestamp&#39;</span><span class="p">)</span>
                                    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                                    <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: to start update_anomaly_end_timestamp&#39;</span><span class="p">)</span>
                                    <span class="k">continue</span>
                            <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="c1"># If the Skyline MySQL database is on a remote host</span>
                            <span class="c1"># 2 seconds here is sometimes not sufficient so</span>
                            <span class="c1"># increased to 10</span>
                            <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                                    <span class="c1"># Just to avoid hogging the CPU</span>
                                    <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># All the processes are done, break now.</span>
                                    <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: update_anomaly_end_timestamp completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">time_to_run</span><span class="p">))</span>
                                    <span class="n">remove_item</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: timed out, killing all update_anomaly_end_timestamp processes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">remove_item</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;current.anomalies&#39;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">list_data</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove </span><span class="si">%s</span><span class="s1"> for Redis set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">list_data</span><span class="p">),</span> <span class="n">redis_set</span><span class="p">))</span>

                <span class="c1"># @added 20200928 - Task #3748: POC SNAB</span>
                <span class="c1">#                   Branch #3068: SNAB</span>
                <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;snab.panorama&#39;</span>
                <span class="n">snab_panorama_items</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">SNAB_ENABLED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">snab_panorama_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get data from </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="n">redis_set</span><span class="p">)</span>
                        <span class="n">snab_panorama_items</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">snab_panorama_items</span><span class="p">:</span>
                    <span class="c1"># Update SQL</span>
                    <span class="c1"># Spawn update_snab process</span>
                    <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_snab</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">snab_panorama_items</span><span class="p">))</span>
                            <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                            <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting update_snab&#39;</span><span class="p">)</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                            <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: to start update_snab&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>
                    <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                    <span class="k">del</span> <span class="n">snab_panorama_items</span>
                    <span class="c1"># If the Skyline MySQL database is on a remote host</span>
                    <span class="c1"># 2 seconds here is sometimes not sufficient so</span>
                    <span class="c1"># increased to 10</span>
                    <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                            <span class="c1"># Just to avoid hogging the CPU</span>
                            <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># All the processes are done, break now.</span>
                            <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: update_snab completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">skyline_app</span><span class="p">,</span> <span class="n">time_to_run</span><span class="p">))</span>
                            <span class="n">remove_item</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: timed out, killing all update_snab processes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

                <span class="c1"># @added 20190501 - Branch #2646: slack</span>
                <span class="c1"># Check if any Redis keys exist with a slack_thread_ts to update</span>
                <span class="c1"># any anomaly records</span>
                <span class="n">slack_thread_ts_updates</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># @added 20190523 - Branch #3002: docker</span>
                <span class="c1">#                   Branch #2646: slack</span>
                <span class="c1"># Only check if slack is enabled</span>
                <span class="k">if</span> <span class="n">SLACK_ENABLED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20200430 - Bug #3266: py3 Redis binary objects not strings</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># slack_thread_ts_updates = list(self.redis_conn.scan_iter(match=&#39;panorama.slack_thread_ts.*&#39;))</span>
                        <span class="n">slack_thread_ts_updates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scan_iter</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="s1">&#39;panorama.slack_thread_ts.*&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to scan panorama.slack_thread_ts.* from Redis&#39;</span><span class="p">)</span>
                        <span class="n">slack_thread_ts_updates</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># @added 20200929 - Task #3748: POC SNAB</span>
                    <span class="c1">#                   Branch #3068: SNAB</span>
                    <span class="c1"># Handle snab slack threads as well</span>
                    <span class="n">snab_slack_thread_ts_updates</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">SNAB_ENABLED</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">snab_slack_thread_ts_updates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scan_iter</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="s1">&#39;panorama.snab.slack_thread_ts.*&#39;</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to scan panorama.snab.slack_thread_ts.* from Redis&#39;</span><span class="p">)</span>
                            <span class="n">snab_slack_thread_ts_updates</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">snab_slack_thread_ts_updates</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">snab_slack_thread_ts_update</span> <span class="ow">in</span> <span class="n">snab_slack_thread_ts_updates</span><span class="p">:</span>
                                <span class="n">slack_thread_ts_updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snab_slack_thread_ts_update</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">slack_thread_ts_updates</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no panorama.slack_thread_ts Redis keys to process, OK&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">slack_thread_ts_updates</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="n">slack_thread_ts_updates</span><span class="p">:</span>

                        <span class="c1"># @added 20200929 - Task #3748: POC SNAB</span>
                        <span class="c1">#                   Branch #3068: SNAB</span>
                        <span class="n">update_table</span> <span class="o">=</span> <span class="s1">&#39;anomalies&#39;</span>
                        <span class="n">snab_id</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="s1">&#39;panorama.snab.slack_thread_ts&#39;</span> <span class="ow">in</span> <span class="n">cache_key</span><span class="p">:</span>
                            <span class="n">update_table</span> <span class="o">=</span> <span class="s1">&#39;snab&#39;</span>

                        <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">update_table</span> <span class="o">==</span> <span class="s1">&#39;anomalies&#39;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># @modified 20191106 - Bug #3266: py3 Redis binary objects not strings</span>
                                <span class="c1">#                      Branch #3262: py3</span>
                                <span class="c1"># update_on = self.redis_conn.get(cache_key)</span>
                                <span class="n">update_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                                <span class="c1"># cache_key_value = [base_name, metric_timestamp, slack_thread_ts]</span>
                                <span class="n">update_for</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">update_on</span><span class="p">)</span>
                                <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">update_for</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">update_for</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="n">slack_thread_ts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">update_for</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get details from cache_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                            <span class="n">update_db_record</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">base_name</span> <span class="ow">and</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                                <span class="n">update_db_record</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not determine base_name and metric_timestamp from cache_key </span><span class="si">%s</span><span class="s1">, deleting&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to delete cache_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>

                        <span class="c1"># @added 20200929 - Task #3748: POC SNAB</span>
                        <span class="c1">#                   Branch #3068: SNAB</span>
                        <span class="k">if</span> <span class="n">update_table</span> <span class="o">==</span> <span class="s1">&#39;snab&#39;</span><span class="p">:</span>
                            <span class="n">cache_key_elements</span> <span class="o">=</span> <span class="n">cache_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">cache_key_elements</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to delete cache_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">slack_thread_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read cache_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cache_key_elements</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                                    <span class="n">snab_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cache_key_elements</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine metric_timestamp from cache_key element - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_key</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">slack_thread_ts</span> <span class="ow">and</span> <span class="n">metric_timestamp</span><span class="p">:</span>
                                    <span class="n">update_db_record</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">update_db_record</span><span class="p">:</span>
                            <span class="c1"># Spawn update_slack_thread_ts process</span>
                            <span class="n">process_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">slack_thread_ts</span><span class="p">,</span> <span class="n">snab_id</span><span class="p">]</span>
                            <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># @modified 20200929 - Task #3748: POC SNAB</span>
                                    <span class="c1">#                      Branch #3068: SNAB</span>
                                    <span class="c1"># Handle snab as well</span>
                                    <span class="c1"># p = Process(target=self.update_slack_thread_ts, args=(i, base_name, metric_timestamp, slack_thread_ts))</span>
                                    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_slack_thread_ts</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">slack_thread_ts</span><span class="p">,</span> <span class="n">snab_id</span><span class="p">))</span>
                                    <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                                    <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting update_slack_thread_ts - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">process_data</span><span class="p">)</span>
                                    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                                    <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: to start update_slack_thread_ts&#39;</span><span class="p">)</span>
                                    <span class="k">continue</span>
                            <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="c1"># @modified 20190509 - Branch #2646: slack</span>
                            <span class="c1"># If the Skyline MySQL database is on a remote host</span>
                            <span class="c1"># 2 seconds here is sometimes not sufficient so</span>
                            <span class="c1"># increased to 10</span>
                            <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                                    <span class="c1"># Just to avoid hogging the CPU</span>
                                    <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># All the processes are done, break now.</span>
                                    <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: update_slack_thread_ts completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">time_to_run</span><span class="p">))</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: timed out, killing all update_slack_thread_ts processes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

                <span class="c1"># @added 20210612 - Branch #1444: thunder</span>
                <span class="c1"># Report app up</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;updated Redis key for </span><span class="si">%s</span><span class="s1"> up&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to update Redis key for </span><span class="si">%s</span><span class="s1"> up&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>

                <span class="c1"># @added 20200825 - Feature #3704: Add alert to anomalies</span>
                <span class="c1"># Check if any Redis keys exist with anomaly alerts to update</span>
                <span class="c1"># the alert field on any anomaly records</span>
                <span class="n">alert_updates</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">alert_updates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scan_iter</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="s1">&#39;panorama.alert.*&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to scan panorama.alert.* from Redis&#39;</span><span class="p">)</span>
                    <span class="n">alert_updates</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">alert_updates</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no panorama.alert Redis keys to process, OK&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">alert_updates</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="n">alert_updates</span><span class="p">:</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">update_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                            <span class="c1"># cache_key_value = [base_name, metric_timestamp, alerted_at_timestamp]</span>
                            <span class="n">update_for</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">update_on</span><span class="p">)</span>
                            <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">update_for</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">update_for</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">alerted_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">update_for</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get details from cache_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                        <span class="n">update_db_record</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">base_name</span> <span class="ow">and</span> <span class="n">metric_timestamp</span> <span class="ow">and</span> <span class="n">alerted_at</span><span class="p">:</span>
                            <span class="n">update_db_record</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not determine base_name, metric_timestamp or alerted_at from cache_key </span><span class="si">%s</span><span class="s1">, deleting&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to delete cache_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">update_db_record</span><span class="p">:</span>
                            <span class="c1"># Spawn update_alert_ts process</span>
                            <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_alert_ts</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">alerted_at</span><span class="p">))</span>
                                    <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                                    <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting update_alert_ts&#39;</span><span class="p">)</span>
                                    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                                    <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to start update_alert_ts&#39;</span><span class="p">)</span>
                                    <span class="k">continue</span>
                            <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                                    <span class="c1"># Just to avoid hogging the CPU</span>
                                    <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># All the processes are done, break now.</span>
                                    <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: update_alert_ts completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">time_to_run</span><span class="p">))</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: timed out, killing all update_alert_ts processes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

            <span class="n">metric_var_files_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">metric_var_files</span><span class="p">)</span>
            <span class="n">metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_CHECK_PATH</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_var_files_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;assigning anomaly for insertion - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_var_files_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="c1"># Spawn processes</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">spawned_pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pid_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_PROCESSES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin_process</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">metric_check_file</span><span class="p">))</span>
                    <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">pid_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> spin_process/es&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pid_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_PROCESSES</span><span class="p">)))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">spawned_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: to start spin_process&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="k">continue</span>

            <span class="c1"># Send wait signal to zombie processes</span>
            <span class="c1"># for p in pids:</span>
            <span class="c1">#     p.join()</span>
            <span class="c1"># Self monitor processes and terminate if any spin_process has run</span>
            <span class="c1"># for longer than CRUCIBLE_TESTS_TIMEOUT</span>
            <span class="n">p_starts</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">):</span>
                    <span class="c1"># Just to avoid hogging the CPU</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># All the processes are done, break now.</span>
                    <span class="n">time_to_run</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_starts</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: </span><span class="si">%s</span><span class="s1"> spin_process/es completed in </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_PROCESSES</span><span class="p">),</span>
                            <span class="n">time_to_run</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We only enter this if we didn&#39;t &#39;break&#39; above.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: timed out, killing all spin_process processes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="c1"># p.join()</span>

                <span class="n">check_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: check_file_name - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_name</span><span class="p">)</span>
                <span class="n">check_file_timestamp</span> <span class="o">=</span> <span class="n">check_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: check_file_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">check_file_timestamp</span><span class="p">))</span>
                <span class="n">check_file_metricname_txt</span> <span class="o">=</span> <span class="n">check_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: check_file_metricname_txt - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_metricname_txt</span><span class="p">)</span>
                <span class="n">check_file_metricname</span> <span class="o">=</span> <span class="n">check_file_metricname_txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: check_file_metricname - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_metricname</span><span class="p">)</span>
                <span class="n">check_file_metricname_dir</span> <span class="o">=</span> <span class="n">check_file_metricname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_PANORAMA_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: check_file_metricname_dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_metricname_dir</span><span class="p">)</span>

                <span class="n">metric_failed_check_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">failed_checks_dir</span><span class="p">,</span> <span class="n">check_file_metricname_dir</span><span class="p">,</span> <span class="n">check_file_timestamp</span><span class="p">)</span>

                <span class="n">fail_check</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_failed_check_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: stopping spin_process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>