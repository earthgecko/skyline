<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>webapp.backend &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">webapp.backend</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for webapp.backend</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="c1"># import mysql.connector</span>
<span class="c1"># from mysql.connector import errorcode</span>

<span class="c1"># @added 20180720 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Added redis and msgpack</span>
<span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">StrictRedis</span>
<span class="kn">from</span> <span class="nn">msgpack</span> <span class="kn">import</span> <span class="n">Unpacker</span>

<span class="c1"># @added 20201103 - Feature #3824: get_cluster_data</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># @added 20201125 - Feature #3850: webapp - yhat_values API endoint</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># @added 20210328 - Feature #3994: Panorama - mirage not anomalous</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># @added 20221019 - Feature #4702: numba optimisations</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>

<span class="c1"># @added 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
<span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">text</span>

<span class="kn">import</span> <span class="nn">settings</span>
<span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">mysql_select</span><span class="p">,</span>
    <span class="c1"># @added 20180720 - Feature #2464: luminosity_remote_data</span>
    <span class="c1"># nonNegativeDerivative, in_list, is_derivative_metric,</span>
    <span class="c1"># @added 20200507 - Feature #3532: Sort all time series</span>
    <span class="c1"># Added sort_timeseries and removed unused in_list</span>
    <span class="n">nonNegativeDerivative</span><span class="p">,</span> <span class="n">sort_timeseries</span><span class="p">,</span>
    <span class="c1"># @added 20201123 - Feature #3824: get_cluster_data</span>
    <span class="c1">#                   Feature #2464: luminosity_remote_data</span>
    <span class="c1">#                   Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                   Branch #3262: py3</span>
    <span class="n">get_redis_conn_decoded</span><span class="p">,</span>
    <span class="c1"># @added 20201125 - Feature #3850: webapp - yhat_values API endoint</span>
    <span class="n">get_graphite_metric</span><span class="p">,</span>
    <span class="c1"># @added 20210328 - Feature #3994: Panorama - mirage not anomalous</span>
    <span class="n">filesafe_metricname</span><span class="p">,</span> <span class="n">mkdir_p</span><span class="p">)</span>

<span class="c1"># @added 20210420  - Task #4022: Move mysql_select calls to SQLAlchemy</span>
<span class="c1"># from database_queries import (</span>
<span class="c1">#    db_query_metric_id_from_base_name, db_query_latest_anomalies,</span>
<span class="c1">#    db_query_metric_ids_from_metric_like)</span>
<span class="c1"># @added 20210420  - Task #4022: Move mysql_select calls to SQLAlchemy</span>
<span class="c1">#                    Task #4030: refactoring</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.metric_id_from_base_name</span> <span class="kn">import</span> <span class="n">metric_id_from_base_name</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.metric_ids_from_metric_like</span> <span class="kn">import</span> <span class="n">metric_ids_from_metric_like</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.latest_anomalies</span> <span class="kn">import</span> <span class="n">latest_anomalies</span> <span class="k">as</span> <span class="n">db_latest_anomalies</span>

<span class="c1"># @added 20210617 - Feature #4144: webapp - stale_metrics API endpoint</span>
<span class="c1">#                   Feature #4076: CUSTOM_STALE_PERIOD</span>
<span class="c1">#                   Branch #1444: thunder</span>
<span class="kn">from</span> <span class="nn">functions.thunder.stale_metrics</span> <span class="kn">import</span> <span class="n">thunder_stale_metrics</span>

<span class="c1"># @added 20220801 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="kn">from</span> <span class="nn">functions.metrics.get_base_name_from_labelled_metrics_name</span> <span class="kn">import</span> <span class="n">get_base_name_from_labelled_metrics_name</span>
<span class="kn">from</span> <span class="nn">functions.metrics.get_metric_id_from_base_name</span> <span class="kn">import</span> <span class="n">get_metric_id_from_base_name</span>
<span class="kn">from</span> <span class="nn">functions.victoriametrics.get_victoriametrics_metric</span> <span class="kn">import</span> <span class="n">get_victoriametrics_metric</span>

<span class="c1"># @added 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
<span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.get_apps</span> <span class="kn">import</span> <span class="n">get_apps</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.get_sources</span> <span class="kn">import</span> <span class="n">get_sources</span>
<span class="kn">from</span> <span class="nn">functions.database.queries.get_hosts</span> <span class="kn">import</span> <span class="n">get_hosts</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_engine</span><span class="p">,</span> <span class="n">engine_disposal</span><span class="p">,</span> <span class="n">anomalies_table_meta</span><span class="p">,</span> <span class="n">metrics_table_meta</span><span class="p">,</span>
    <span class="n">luminosity_table_meta</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">functions.metrics.get_base_name_from_metric_id</span> <span class="kn">import</span> <span class="n">get_base_name_from_metric_id</span>

<span class="kn">import</span> <span class="nn">skyline_version</span>
<span class="n">skyline_version</span> <span class="o">=</span> <span class="n">skyline_version</span><span class="o">.</span><span class="n">__absolute_version__</span>

<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;webapp&#39;</span>
<span class="n">skyline_app_logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Log&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
<span class="n">skyline_app_logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
<span class="n">logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>

<span class="n">REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;from_date&#39;</span><span class="p">,</span>
                <span class="s1">&#39;from_time&#39;</span><span class="p">,</span>
                <span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span>
                <span class="s1">&#39;until_date&#39;</span><span class="p">,</span>
                <span class="s1">&#39;until_time&#39;</span><span class="p">,</span>
                <span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">,</span>
                <span class="s1">&#39;like_target&#39;</span><span class="p">,</span>
                <span class="s1">&#39;source&#39;</span><span class="p">,</span>
                <span class="s1">&#39;host&#39;</span><span class="p">,</span>
                <span class="s1">&#39;algorithm&#39;</span><span class="p">,</span>
                <span class="c1"># @added 20161127 - Branch #922: ionosphere</span>
                <span class="s1">&#39;panorama_anomaly_id&#39;</span><span class="p">,</span>
                <span class="p">]</span>

<span class="c1"># Converting one settings variable into a local variable, just because it is a</span>
<span class="c1"># long string otherwise.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ENABLE_WEBAPP_DEBUG</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_WEBAPP_DEBUG</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: cannot determine ENABLE_WEBAPP_DEBUG from settings - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outer_err</span><span class="p">)</span>
    <span class="n">ENABLE_WEBAPP_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20180720 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Added REDIS_CONN</span>
<span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
    <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>


<div class="viewcode-block" id="panorama_request"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.backend.panorama_request">[docs]</a><span class="k">def</span> <span class="nf">panorama_request</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the details of anomalies from the database, using the URL arguments</span>
<span class="sd">    that are passed in by the :obj:`request.args` to build the MySQL select</span>
<span class="sd">    query string and queries the database, parse the results and creates an</span>
<span class="sd">    array of the anomalies that matched the query and creates the</span>
<span class="sd">    ``panaroma.json`` file, then returns the array.  The Webapp needs both the</span>
<span class="sd">    array and the JSONP file to serve to the browser for the client side</span>
<span class="sd">    ``panaroma.js``.</span>

<span class="sd">    :param None: determined from :obj:`request.args`</span>
<span class="sd">    :return: array</span>
<span class="sd">    :rtype: array</span>

<span class="sd">    .. note:: And creates ``panaroma.js`` for client side javascript</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;determining request args&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ids_from_rows</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="n">found_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">found_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">found_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">found_id</span><span class="p">))</span>

        <span class="c1"># @modified 20191014 - Task #3270: Deprecate string.replace for py3</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># ids_first = string.replace(str(found_ids), &#39;[&#39;, &#39;&#39;)</span>
        <span class="c1"># in_ids = string.replace(str(ids_first), &#39;]&#39;, &#39;&#39;)</span>
        <span class="n">found_ids_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">found_ids</span><span class="p">)</span>
        <span class="n">ids_first</span> <span class="o">=</span> <span class="n">found_ids_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">in_ids</span> <span class="o">=</span> <span class="n">ids_first</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">in_ids</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">latest_anomalies</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">request_args_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="s1">&#39;No request arguments passed&#39;</span>
        <span class="c1"># return str(request_args_len)</span>
        <span class="n">latest_anomalies</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">metric</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @modified 20210504  - Task #4030: refactoring</span>
    <span class="c1">#                       Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1"># if metric</span>
    <span class="c1">#     logger.info(&#39;Getting db id for %s&#39; % metric)</span>
    <span class="c1">#     # @modified 20170913 - Task #2160: Test skyline with bandit</span>
    <span class="c1">#     # Added nosec to exclude from bandit tests</span>
    <span class="c1">#     query = &#39;select id from metrics WHERE metric=\&#39;%s\&#39;&#39; % metric  # nosec</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         result = mysql_select(skyline_app, query)</span>
    <span class="c1">#     except:</span>
    <span class="c1">#         logger.error(&#39;error :: failed to get id from db: %s&#39; % traceback.format_exc())</span>
    <span class="c1">#         result = &#39;metric id not found in database&#39;</span>
    <span class="c1">#     return str(result[0][0])</span>

    <span class="n">search_request</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">count_request</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1">#                  Task #4778: v4.0.0 - update dependencies</span>
    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">latest_anomalies</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting latest anomalies&#39;</span><span class="p">)</span>
        <span class="c1"># @modified 20191108 - Feature #3306: Record the anomaly_end_timestamp</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># query = &#39;select id, metric_id, anomalous_datapoint, anomaly_timestamp, full_duration, created_timestamp from anomalies ORDER BY id DESC LIMIT 10&#39;</span>
        <span class="c1"># @modified 20210420  - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1"># query = &#39;select id, metric_id, anomalous_datapoint, anomaly_timestamp, full_duration, created_timestamp, anomaly_end_timestamp from anomalies ORDER BY id DESC LIMIT 10&#39;</span>
        <span class="c1"># try:</span>
        <span class="c1">#     rows = mysql_select(skyline_app, query)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     logger.error(&#39;error :: failed to get anomalies from db: %s&#39; % traceback.format_exc())</span>
        <span class="c1">#     rows = []</span>
        <span class="c1"># @added 20210420  - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">db_latest_anomalies</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get anomalies from db: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">latest_anomalies</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Determining search parameters&#39;</span><span class="p">)</span>
        <span class="c1"># @modified 20191108 - Feature #3306: Record the end_timestamp of anomalies</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># query_string = &#39;select id, metric_id, anomalous_datapoint, anomaly_timestamp, full_duration, created_timestamp from anomalies&#39;</span>
        <span class="n">query_string</span> <span class="o">=</span> <span class="s1">&#39;select id, metric_id, anomalous_datapoint, anomaly_timestamp, full_duration, created_timestamp, anomaly_end_timestamp from anomalies&#39;</span>

        <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># If we have to &#39;&#39; a string we cannot escape the query it seems...</span>
        <span class="c1"># do_not_escape = False</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># if metric and metric != &#39;all&#39;:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">metric</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
                <span class="c1"># Added nosec to exclude from bandit tests</span>
                <span class="c1"># @modified 20210420  - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1"># query = &quot;select id from metrics WHERE metric=&#39;%s&#39;&quot; % (metric)  # nosec</span>
                <span class="c1"># try:</span>
                <span class="c1">#     found_id = mysql_select(skyline_app, query)</span>
                <span class="c1"># except:</span>
                <span class="c1">#     logger.error(&#39;error :: failed to get app ids from db: %s&#39; % traceback.format_exc())</span>
                <span class="c1">#     found_id = None</span>
                <span class="c1"># @added 20210420  - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="n">found_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># found_id = db_query_metric_id_from_base_name(skyline_app, base_name)</span>
                    <span class="n">found_id</span> <span class="o">=</span> <span class="n">metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get metric id from db: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">found_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">found_id</span><span class="p">:</span>
                    <span class="c1"># target_id = str(found_id[0][0])</span>
                    <span class="n">target_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">found_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">needs_and</span><span class="p">:</span>
                        <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> AND metric_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE metric_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
                    <span class="n">query_string</span> <span class="o">=</span> <span class="n">new_query_string</span>
                    <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># in_ids_str = None</span>
        <span class="k">if</span> <span class="s1">&#39;metric_like&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metric_like</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric_like&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">metrics_like_str</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># if metric_like and metric_like != &#39;all&#39;:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_like</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">metric_like</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
                <span class="c1"># Added nosec to exclude from bandit tests</span>
                <span class="n">rows_returned</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># @modified 20210420  - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1"># query = &#39;select id from metrics WHERE metric LIKE \&#39;%s\&#39;&#39; % (str(metric_like))  # nosec</span>
                <span class="c1"># try:</span>
                <span class="c1">#     rows = mysql_select(skyline_app, query)</span>
                <span class="c1"># except:</span>
                <span class="c1">#     logger.error(&#39;error :: failed to get metric ids from db: %s&#39; % traceback.format_exc())</span>
                <span class="c1">#     return False</span>
                <span class="c1"># rows_returned = None</span>
                <span class="c1"># try:</span>
                <span class="c1">#     rows_returned = rows[0]</span>
                <span class="c1">#     if ENABLE_WEBAPP_DEBUG:</span>
                <span class="c1">#         logger.info(&#39;debug :: rows - rows[0] - %s&#39; % str(rows[0]))</span>
                <span class="c1"># except:</span>
                <span class="c1">#     rows_returned = False</span>
                <span class="c1">#     if ENABLE_WEBAPP_DEBUG:</span>
                <span class="c1">#         logger.info(&#39;debug :: no rows returned&#39;)</span>

                <span class="c1"># @added 20210420  - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="n">metrics_like_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_like</span><span class="p">)</span>
                <span class="n">db_metric_ids</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">db_metric_ids</span> <span class="o">=</span> <span class="n">metric_ids_from_metric_like</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metrics_like_str</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get metric ids from db: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="n">use_db_metric_ids</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">db_metric_ids</span> <span class="ow">and</span> <span class="n">use_db_metric_ids</span><span class="p">:</span>
                    <span class="n">rows_returned</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">ids</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">db_metric_id</span> <span class="ow">in</span> <span class="n">db_metric_ids</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ids</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">ids</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">db_metric_id</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ids</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">db_metric_id</span><span class="p">))</span>
                    <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE metric_id IN (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Get nothing</span>
                    <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE metric_id IN (0)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ENABLE_WEBAPP_DEBUG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: no rows returned using new_query_string - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">new_query_string</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">use_db_metric_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rows_returned</span><span class="p">:</span>
                        <span class="n">ids</span> <span class="o">=</span> <span class="n">get_ids_from_rows</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
                        <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE metric_id IN (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: id is </span><span class="si">%s</span><span class="s1"> chars long after adding get_ids_from_rows, new_query_string: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)),</span> <span class="n">new_query_string</span><span class="p">))</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Get nothing</span>
                        <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE metric_id IN (0)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ENABLE_WEBAPP_DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: no rows returned using new_query_string - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">new_query_string</span><span class="p">)</span>

                <span class="n">query_string</span> <span class="o">=</span> <span class="n">new_query_string</span>
                <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s1">&#39;count_by_metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">count_by_metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count_by_metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count_by_metric</span> <span class="ow">and</span> <span class="n">count_by_metric</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">search_request</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">count_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># query_string = &#39;SELECT metric_id, COUNT(*) FROM anomalies GROUP BY metric_id ORDER BY COUNT(*) DESC&#39;</span>
                <span class="n">query_string</span> <span class="o">=</span> <span class="s1">&#39;SELECT metric_id, COUNT(*) FROM anomalies&#39;</span>
                <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s1">&#39;from_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">from_timestamp</span> <span class="ow">and</span> <span class="n">from_timestamp</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>

                <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">from_timestamp</span><span class="p">:</span>
                    <span class="c1"># @modified 20211021 - handle multiple date formats</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_from_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">new_from_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: panorama_request :: failed to unix timestamp from from_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
                        <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>

                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">new_from_timestamp</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">needs_and</span><span class="p">:</span>
                    <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> AND anomaly_timestamp &gt;= </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">)</span>
                    <span class="n">query_string</span> <span class="o">=</span> <span class="n">new_query_string</span>
                    <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE anomaly_timestamp &gt;= </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">)</span>
                    <span class="n">query_string</span> <span class="o">=</span> <span class="n">new_query_string</span>
                    <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s1">&#39;until_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">until_timestamp</span> <span class="ow">and</span> <span class="n">until_timestamp</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">until_timestamp</span><span class="p">:</span>
                    <span class="c1"># @modified 20211021 - handle multiple date formats</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_until_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">new_until_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: panorama_request :: failed to unix timestamp from until_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
                        <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>

                    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">new_until_timestamp</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">needs_and</span><span class="p">:</span>
                    <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> AND anomaly_timestamp &lt;= </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">)</span>
                    <span class="n">query_string</span> <span class="o">=</span> <span class="n">new_query_string</span>
                    <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE anomaly_timestamp &lt;= </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">)</span>
                    <span class="n">query_string</span> <span class="o">=</span> <span class="n">new_query_string</span>
                    <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s1">&#39;app&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">app</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">app</span> <span class="ow">and</span> <span class="n">app</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="c1"># @added 20210504  - Task #4030: refactoring</span>
                <span class="c1">#                    Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1"># Sanitise variable</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">for_app</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">for_app</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

                <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
                <span class="c1"># Added nosec to exclude from bandit tests</span>
                <span class="c1"># @modified 20210504  - Task #4030: refactoring</span>
                <span class="c1">#                       Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1"># query = &#39;select id from apps WHERE app=\&#39;%s\&#39;&#39; % (str(app))  # nosec</span>
                <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="c1"># query = &#39;select id from apps WHERE app=\&#39;%s\&#39;&#39; % (str(for_app))</span>
                <span class="c1"># try:</span>
                <span class="c1">#     found_id = mysql_select(skyline_app, query)</span>
                <span class="c1"># except:</span>
                <span class="c1">#     logger.error(&#39;error :: failed to get app ids from db: %s&#39; % traceback.format_exc())</span>
                <span class="c1">#     found_id = None</span>
                <span class="n">apps</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">apps</span> <span class="o">=</span> <span class="n">get_apps</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_apps failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">found_id</span> <span class="o">=</span> <span class="n">apps</span><span class="p">[</span><span class="n">for_app</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get app id from apps for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">for_app</span><span class="p">)</span>
                    <span class="n">found_id</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">found_id</span><span class="p">:</span>
                    <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                    <span class="c1"># target_id = str(found_id[0][0])</span>
                    <span class="n">target_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">found_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">needs_and</span><span class="p">:</span>
                        <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> AND app_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE app_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>

                    <span class="n">query_string</span> <span class="o">=</span> <span class="n">new_query_string</span>
                    <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">and</span> <span class="n">source</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>

                <span class="c1"># @added 20210504  - Task #4030: refactoring</span>
                <span class="c1">#                    Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1"># Sanitise variable</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">for_source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">for_source</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

                <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
                <span class="c1"># Added nosec to exclude from bandit tests</span>
                <span class="c1"># @modified 20210504  - Task #4030: refactoring</span>
                <span class="c1">#                       Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1"># query = &#39;select id from sources WHERE source=\&#39;%s\&#39;&#39; % (str(source))  # nosec</span>
                <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="c1"># query = &#39;select id from sources WHERE source=\&#39;%s\&#39;&#39; % (str(for_source))</span>
                <span class="c1"># try:</span>
                <span class="c1">#     found_id = mysql_select(skyline_app, query)</span>
                <span class="c1"># except:</span>
                <span class="c1">#     logger.error(&#39;error :: failed to get source id from db: %s&#39; % traceback.format_exc())</span>
                <span class="c1">#     found_id = None</span>
                <span class="n">sources</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sources</span> <span class="o">=</span> <span class="n">get_sources</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_sources failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">found_id</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="n">for_source</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get source id from sources for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">for_source</span><span class="p">)</span>
                    <span class="n">found_id</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">found_id</span><span class="p">:</span>
                    <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                    <span class="c1"># target_id = str(found_id[0][0])</span>
                    <span class="n">target_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">found_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">needs_and</span><span class="p">:</span>
                        <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> AND source_id=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE source_id=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>

                    <span class="n">query_string</span> <span class="o">=</span> <span class="n">new_query_string</span>
                    <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s1">&#39;algorithm&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">algorithm</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;algorithm&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># DISABLED as it is difficult match algorithm_id in the</span>
            <span class="c1"># triggered_algorithms csv list</span>
            <span class="n">algorithm</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
            <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
            <span class="c1"># semgrep - python.lang.correctness.useless-comparison.no-strings-as-booleans</span>
            <span class="c1"># if algorithm and algorithm != &#39;all&#39;:</span>
            <span class="n">use_all_for_algorithm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">use_all_for_algorithm</span> <span class="ow">and</span> <span class="n">algorithm</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>

                <span class="c1"># @added 20210504  - Task #4030: refactoring</span>
                <span class="c1">#                    Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1"># Sanitise variable</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">algorithm</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">for_algorithm</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">for_algorithm</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

                <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
                <span class="c1"># Added nosec to exclude from bandit tests</span>
                <span class="c1"># @modified 20210504  - Task #4030: refactoring</span>
                <span class="c1">#                       Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1"># query = &#39;select id from algorithms WHERE algorithm LIKE \&#39;%s\&#39;&#39; % (str(algorithm))  # nosec</span>
                <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="c1"># query = &#39;select id from algorithms WHERE algorithm LIKE \&#39;%s\&#39;&#39; % (str(for_algorithm))</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT id FROM algorithms WHERE algorithm LIKE :like_string&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">fail_msg</span> <span class="o">!=</span> <span class="s1">&#39;got MySQL engine&#39;</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine fail_msg - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">trace</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine trace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">trace</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                    <span class="c1"># rows = mysql_select(skyline_app, query)</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">like_string</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">for_algorithm</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">for_algorithm</span><span class="p">])</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get algorithm ids from db: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">ids</span> <span class="o">=</span> <span class="n">get_ids_from_rows</span><span class="p">(</span><span class="s1">&#39;algorithm&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">needs_and</span><span class="p">:</span>
                    <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> AND algorithm_id IN (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE algorithm_id IN (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
                <span class="n">query_string</span> <span class="o">=</span> <span class="n">new_query_string</span>
                <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># @added 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                  Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
            <span class="n">engine_disposal</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;host&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">host</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>

                <span class="c1"># @added 20210504  - Task #4030: refactoring</span>
                <span class="c1">#                    Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1"># Sanitise variable</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">for_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">for_host</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

                <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
                <span class="c1"># Added nosec to exclude from bandit tests</span>
                <span class="c1"># @modified 20210504  - Task #4030: refactoring</span>
                <span class="c1">#                       Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1"># query = &#39;select id from hosts WHERE host=\&#39;%s\&#39;&#39; % (str(host))  # nosec</span>
                <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="c1"># query = &#39;select id from hosts WHERE host=\&#39;%s\&#39;&#39; % (str(for_host))</span>
                <span class="c1"># try:</span>
                <span class="c1">#     found_id = mysql_select(skyline_app, query)</span>
                <span class="c1"># except:</span>
                <span class="c1">#     logger.error(&#39;error :: failed to get host id from db: %s&#39; % traceback.format_exc())</span>
                <span class="c1">#     found_id = None</span>
                <span class="n">hosts</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hosts</span> <span class="o">=</span> <span class="n">get_hosts</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_hosts failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">found_id</span> <span class="o">=</span> <span class="n">hosts</span><span class="p">[</span><span class="n">for_host</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get host id from hosts for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">for_host</span><span class="p">)</span>
                    <span class="n">found_id</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">found_id</span><span class="p">:</span>
                    <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                    <span class="c1"># target_id = str(found_id[0][0])</span>
                    <span class="n">target_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">found_id</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">needs_and</span><span class="p">:</span>
                        <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> AND host_id=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_query_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE host_id=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
                    <span class="n">query_string</span> <span class="o">=</span> <span class="n">new_query_string</span>
                    <span class="n">needs_and</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s1">&#39;limit&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="c1"># @modified 20210504  - Task #4030: refactoring</span>
            <span class="c1">#                       Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1"># limit = request.args.get(&#39;limit&#39;, &#39;10&#39;)</span>
            <span class="n">limit_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit_str</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: limit parameter not an int: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="s1">&#39;10&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="c1"># @modified 20210504  - Task #4030: refactoring</span>
            <span class="c1">#                       Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1"># order = request.args.get(&#39;order&#39;, &#39;DESC&#39;)</span>
            <span class="n">order_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;DESC&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order_str</span> <span class="o">==</span> <span class="s1">&#39;ASC&#39;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;ASC&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>

        <span class="n">search_query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> ORDER BY id </span><span class="si">%s</span><span class="s1"> LIMIT </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">query_string</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;count_by_metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">count_by_metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count_by_metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count_by_metric</span> <span class="ow">and</span> <span class="n">count_by_metric</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="c1"># query_string = &#39;SELECT metric_id, COUNT(*) FROM anomalies GROUP BY metric_id ORDER BY COUNT(*) DESC&#39;</span>
                <span class="n">search_query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> GROUP BY metric_id ORDER BY COUNT(*) </span><span class="si">%s</span><span class="s1"> LIMIT </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">query_string</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">mysql_select</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">search_query</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get anomalies from db: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">anomalous_metrics</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">search_request</span><span class="p">:</span>
        <span class="c1"># @modified 20191014 - Task #3270: Deprecate string.replace for py3</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="n">anomalies_json</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANOMALY_DUMP</span><span class="p">))</span>
        <span class="c1"># panorama_json = string.replace(str(anomalies_json), &#39;anomalies.json&#39;, &#39;panorama.json&#39;)</span>
        <span class="n">panorama_json</span> <span class="o">=</span> <span class="n">anomalies_json</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;anomalies.json&#39;</span><span class="p">,</span> <span class="s1">&#39;panorama.json&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ENABLE_WEBAPP_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug ::  panorama_json - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">panorama_json</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">search_request</span><span class="p">:</span>
            <span class="n">anomaly_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">count_request</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">anomaly_count</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
        <span class="c1"># Added nosec to exclude from bandit tests</span>
        <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="c1"># But in this case use get_base_name_from_metric_id</span>
        <span class="c1"># query = &#39;select metric from metrics WHERE id=%s&#39; % metric_id  # nosec</span>
        <span class="c1"># try:</span>
        <span class="c1">#     result = mysql_select(skyline_app, query)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     logger.error(&#39;error :: failed to get id from db: %s&#39; % traceback.format_exc())</span>
        <span class="c1">#     continue</span>
        <span class="c1"># metric = str(result[0][0])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">get_base_name_from_metric_id</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_metric_id falied for metric_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">search_request</span><span class="p">:</span>
            <span class="n">anomalous_datapoint</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">created_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="c1"># @modified 20191108 - Feature #3306: Record the anomaly_end_timestamp</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># anomaly_data = (anomaly_id, metric, anomalous_datapoint, anomaly_timestamp, full_duration, created_timestamp)</span>
            <span class="c1"># anomalies.append([int(anomaly_id), str(metric), anomalous_datapoint, anomaly_timestamp, full_duration, created_timestamp])</span>
            <span class="n">anomaly_end_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="c1"># anomaly_data = (anomaly_id, metric, anomalous_datapoint, anomaly_timestamp, full_duration, created_timestamp, anomaly_end_timestamp)</span>
            <span class="n">anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">anomalous_datapoint</span><span class="p">,</span> <span class="n">anomaly_timestamp</span><span class="p">,</span> <span class="n">full_duration</span><span class="p">,</span> <span class="n">created_timestamp</span><span class="p">,</span> <span class="n">anomaly_end_timestamp</span><span class="p">])</span>
            <span class="n">anomalous_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">count_request</span><span class="p">:</span>
            <span class="n">limit_argument</span> <span class="o">=</span> <span class="n">anomaly_count</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">limit_argument</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="c1"># anomaly_data = (int(anomaly_count), metric, str(limit_argument))</span>
            <span class="n">anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">anomaly_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">limit_argument</span><span class="p">)])</span>

    <span class="n">anomalies</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">search_request</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">panorama_json</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Write anomalous_metrics to static webapp directory</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">panorama_json</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="c1"># Make it JSONP with a handle_data() function</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;handle_data(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">anomalies</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">latest_anomalies</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">anomalies</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">search_query</span><span class="p">,</span> <span class="n">anomalies</span></div>

<span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
<span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
<span class="c1"># Use sqlalchemy rather than string-based query construction</span>
<span class="c1"># Deprecated get_list and using get_ functions in weabpp instead</span>
<span class="c1"># def get_list(thing):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Get a list of names for things in a database table.</span>
<span class="c1">#</span>
<span class="c1">#     :param thing: the thing, e.g. &#39;algorithm&#39;</span>
<span class="c1">#     :type thing: str</span>
<span class="c1">#     :return: list</span>
<span class="c1">#     :rtype: list</span>
<span class="c1">#</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     table = &#39;%ss&#39; % thing</span>
<span class="c1">#     # @modified 20170913 - Task #2160: Test skyline with bandit</span>
<span class="c1">#     # Added nosec to exclude from bandit tests</span>
<span class="c1">#     query = &#39;select %s from %s&#39; % (thing, table)  # nosec</span>
<span class="c1">#</span>
<span class="c1">#     # @modified 20220802 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#     #                      Branch #4300: prometheus</span>
<span class="c1">#     # Disabled logging</span>
<span class="c1">#     # logger.info(&#39;get_list :: select %s from %s&#39; % (thing, table))  # nosec</span>
<span class="c1">#</span>
<span class="c1">#     # got_results = False</span>
<span class="c1">#     try:</span>
<span class="c1">#         results = mysql_select(skyline_app, query)</span>
<span class="c1">#         # got_results = True</span>
<span class="c1">#     except:</span>
<span class="c1">#         logger.error(&#39;error :: failed to get list of %ss from %s&#39; % (thing, table))</span>
<span class="c1">#         results = None</span>
<span class="c1">#</span>
<span class="c1">#     things = []</span>
<span class="c1">#     results_array_valid = False</span>
<span class="c1">#     try:</span>
<span class="c1">#         test_results = results[0]</span>
<span class="c1">#         if test_results:</span>
<span class="c1">#             results_array_valid = True</span>
<span class="c1">#     except:</span>
<span class="c1">#         logger.error(&#39;error :: invalid results array for get list of %ss from %s&#39; % (thing, table))</span>
<span class="c1">#</span>
<span class="c1">#     # @modified 20210415 - Feature #4014: Ionosphere - inference</span>
<span class="c1">#     # Stop logging results in webapp</span>
<span class="c1">#</span>
<span class="c1">#     # @modified 20220802 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#     #                      Branch #4300: prometheus</span>
<span class="c1">#     # Disabled logging</span>
<span class="c1">#     # if results_array_valid:</span>
<span class="c1">#         # @modified 20210415 - Feature #4014: Ionosphere - inference</span>
<span class="c1">#         # Stop logging results in webapp</span>
<span class="c1">#         # logger.info(&#39;results: %s&#39; % str(results))</span>
<span class="c1">#         # for result in results:</span>
<span class="c1">#         #     things.append(str(result[0]))</span>
<span class="c1">#         # logger.info(&#39;things: %s&#39; % str(things))</span>
<span class="c1">#         # @modified 20220802 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#         #                      Branch #4300: prometheus</span>
<span class="c1">#         # Disabled logging</span>
<span class="c1">#         # logger.info(&#39;get_list :: returned valid result: %s&#39; % str(results_array_valid))</span>
<span class="c1">#</span>
<span class="c1">#     return things</span>


<span class="c1"># @added 20180720 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># @modified 20201203 - Feature #3860: luminosity - handle low frequency data</span>
<span class="c1"># Add the metric resolution</span>
<span class="c1"># def luminosity_remote_data(anomaly_timestamp):</span>
<span class="c1"># @modified 20230409 - Task #4872: Optimise luminosity for labelled_metrics</span>
<span class="c1"># Added namespace parameter</span>
<span class="c1"># def luminosity_remote_data(anomaly_timestamp, resolution):</span>
<div class="viewcode-block" id="luminosity_remote_data"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.backend.luminosity_remote_data">[docs]</a><span class="k">def</span> <span class="nf">luminosity_remote_data</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets all the unique_metrics from Redis and then mgets Redis data for all</span>
<span class="sd">    metrics.  The data is then preprocessed for the remote Skyline luminosity</span>
<span class="sd">    instance and only the relevant fragments of the time series are</span>
<span class="sd">    returned.  This return is then gzipped by the Flask Webapp response to</span>
<span class="sd">    ensure the minimum about of bandwidth is used.</span>

<span class="sd">    :param anomaly_timestamp: the anomaly timestamp</span>
<span class="sd">    :type anomaly_timestamp: int</span>
<span class="sd">    :return: list</span>
<span class="sd">    :rtype: list</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;luminosity_remote_data returned&#39;</span>
    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">luminosity_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;luminosity_remote_data :: determining unique_metrics&#39;</span><span class="p">)</span>
    <span class="n">unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># If you modify the values of 61 or 600 here, it must be modified in the</span>
    <span class="c1"># luminosity_remote_data function in</span>
    <span class="c1"># skyline/luminosity/process_correlations.py as well</span>
    <span class="c1"># @modified 20201203 - Feature #3860: luminosity - handle low frequency data</span>
    <span class="c1"># Use the metric resolution</span>
    <span class="c1"># from_timestamp = int(anomaly_timestamp) - 600</span>
    <span class="c1"># until_timestamp = int(anomaly_timestamp) + 61</span>
    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20201123 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                      Feature #2464: luminosity_remote_data</span>
        <span class="c1">#                      Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># unique_metrics = list(REDIS_CONN.smembers(settings.FULL_NAMESPACE + &#39;unique_metrics&#39;))</span>
        <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: luminosity_remote_data :: get_redis_conn_decoded failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

    <span class="c1"># @added 20230409 - Task #4872: Optimise luminosity for labelled_metrics</span>
    <span class="c1"># Added namespace parameter to filter on namespace rather than surfacing the</span>
    <span class="c1"># entire Redis data</span>
    <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">namespace</span><span class="p">:</span>
        <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;luminosity.namespace.metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">redis_set</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: luminosity_remote_data :: failed to get the </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: luminosity_remote_data :: could not determine unique_metrics from Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">unique_metrics</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;error :: luminosity_remote_data :: could not determine unique_metrics from Redis set&#39;</span>
        <span class="c1"># @modified 20230409 - Task #4872: Optimise luminosity for labelled_metrics</span>
        <span class="c1"># Do not return here are labelled_metrics should be surfaced first</span>
        <span class="c1"># return luminosity_data, success, message</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;luminosity_remote_data :: </span><span class="si">%s</span><span class="s1"> unique_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)))</span>

    <span class="c1"># @added 20210125 - Feature #3956: luminosity - motifs</span>
    <span class="c1">#                   Improve luminosity_remote_data performance</span>
    <span class="c1"># Although the is_derivative_metric function is appropriate in the below</span>
    <span class="c1"># loop here that is not the  most performant manner in which to determine if</span>
    <span class="c1"># the metrics are derivatives, as it needs to fire on every metric, so here</span>
    <span class="c1"># we just trust the Redis derivative_metrics list.  This increases</span>
    <span class="c1"># performance on 1267 metrics from 6.442009 seconds to 1.473067 seconds</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20211012 - Feature #4280: aet.metrics_manager.derivative_metrics Redis hash</span>
        <span class="c1"># derivative_metrics = list(REDIS_CONN_DECODED.smembers(&#39;derivative_metrics&#39;))</span>
        <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># @added 20230409 - Task #4872: Optimise luminosity for labelled_metrics</span>
    <span class="c1"># Added namespace parameter to filter on namespace rather than surfacing the</span>
    <span class="c1"># entire Redis data</span>
    <span class="k">if</span> <span class="n">namespace_metrics</span><span class="p">:</span>
        <span class="n">full_namespace_namespace_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">namespace_metrics</span><span class="p">]</span>
        <span class="n">namespace_assigned_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">full_namespace_namespace_metrics</span><span class="p">]</span>
        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespace_assigned_metrics</span><span class="p">)</span>
    <span class="n">assigned_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.unique_labelled_metrics&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: luminosity_remote_data :: smembers labelled_metrics.unique_labelled_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
    <span class="n">active_labelled_ids_with_metric</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">unique_labelled_metrics</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">active_labelled_ids_with_metric</span> <span class="o">=</span> <span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.active_labelled_ids_with_metric&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_assigned_metrics :: hgetall aet.metrics_manager.active_labelled_ids_with_metric failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">active_labelled_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_ids_with_metric</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
    <span class="k">if</span> <span class="n">namespace_metrics</span><span class="p">:</span>
        <span class="n">assigned_labelled_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">labelled_metric</span> <span class="k">for</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">active_labelled_metrics</span> <span class="k">if</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="n">namespace_metrics</span><span class="p">]</span>
        <span class="n">active_labelled_base_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_name</span> <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_ids_with_metric</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">namespace_metrics</span><span class="p">]</span>

    <span class="c1"># assigned metrics</span>
    <span class="n">assigned_min</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">assigned_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)</span>
    <span class="n">assigned_keys</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">assigned_min</span><span class="p">,</span> <span class="n">assigned_max</span><span class="p">)</span>

    <span class="c1"># Compile assigned metrics</span>
    <span class="n">assigned_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique_metrics</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">assigned_keys</span><span class="p">]</span>
    <span class="c1"># Check if this process is unnecessary</span>
    <span class="c1"># @modified 20230409 - Task #4872: Optimise luminosity for labelled_metrics</span>
    <span class="c1"># if len(assigned_metrics) == 0 and len():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">assigned_labelled_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;error :: luminosity_remote_data :: assigned_metrics length is 0&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">luminosity_data</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">message</span>

    <span class="c1"># @modified 20230409 - Task #4872: Optimise luminosity for labelled_metrics</span>
    <span class="k">if</span> <span class="n">assigned_metrics</span><span class="p">:</span>
        <span class="c1"># Multi get series</span>
        <span class="n">raw_assigned_failed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_assigned</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">mget</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">)</span>
            <span class="n">raw_assigned_failed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;error :: luminosity_remote_data :: failed to mget raw_assigned&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">luminosity_data</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">message</span>
        <span class="k">if</span> <span class="n">raw_assigned_failed</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;error :: luminosity_remote_data :: failed to mget raw_assigned&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="c1"># @modified 20230409 - Task #4872: Optimise luminosity for labelled_metrics</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">assigned_labelled_metrics</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">luminosity_data</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">message</span>

        <span class="c1"># Distill timeseries strings into lists</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assigned_metrics</span><span class="p">):</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">raw_series</span> <span class="o">=</span> <span class="n">raw_assigned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">raw_series</span><span class="p">)</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpacker</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># @added 20200507 - Feature #3532: Sort all time series</span>
            <span class="c1"># To ensure that there are no unordered timestamps in the time</span>
            <span class="c1"># series which are artefacts of the collector or carbon-relay, sort</span>
            <span class="c1"># all time series by timestamp before analysis.</span>
            <span class="n">original_timeseries</span> <span class="o">=</span> <span class="n">timeseries</span>
            <span class="k">if</span> <span class="n">original_timeseries</span><span class="p">:</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="n">sort_timeseries</span><span class="p">(</span><span class="n">original_timeseries</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">original_timeseries</span>

            <span class="c1"># Convert the time series if this is a known_derivative_metric</span>
            <span class="c1"># @modified 20200728 - Bug #3652: Handle multiple metrics in base_name conversion</span>
            <span class="c1"># base_name = metric_name.replace(settings.FULL_NAMESPACE, &#39;&#39;, 1)</span>

            <span class="c1"># @added 20201117 - Feature #3824: get_cluster_data</span>
            <span class="c1">#                   Feature #2464: luminosity_remote_data</span>
            <span class="c1">#                   Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                   Branch #3262: py3</span>
            <span class="c1"># Convert metric_name bytes to str</span>
            <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>

            <span class="c1"># @modified 20210125 - Feature #3956: luminosity - motifs</span>
            <span class="c1">#                      Improve luminosity_remote_data performance</span>
            <span class="c1"># Although the is_derivative_metric function is appropriate here it is</span>
            <span class="c1"># not the most performant manner in which to determine if the metric</span>
            <span class="c1"># is a derivative in this case as it needs to fire on every metric, so</span>
            <span class="c1"># here we just trust the Redis derivative_metrics list. This increases</span>
            <span class="c1"># performance on 1267 metrics from 6.442009 seconds to 1.473067 seconds</span>
            <span class="c1"># if metric_name.startswith(settings.FULL_NAMESPACE):</span>
            <span class="c1">#     base_name = metric_name.replace(settings.FULL_NAMESPACE, &#39;&#39;, 1)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     base_name = metric_name</span>
            <span class="c1"># known_derivative_metric = is_derivative_metric(&#39;webapp&#39;, base_name)</span>
            <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">derivative_metrics</span><span class="p">:</span>
                <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">derivative_timeseries</span> <span class="o">=</span> <span class="n">nonNegativeDerivative</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">derivative_timeseries</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: nonNegativeDerivative failed&#39;</span><span class="p">)</span>

            <span class="c1"># @modified 20210125 - Feature #3956: luminosity - motifs</span>
            <span class="c1">#                      Improve luminosity_remote_data performance</span>
            <span class="c1"># The list comprehension method halves the time to create the</span>
            <span class="c1"># correlate_ts from 0.0008357290644198656 to 0.0004676780663430691 seconds</span>
            <span class="c1"># correlate_ts = []</span>
            <span class="c1"># for ts, value in timeseries:</span>
            <span class="c1">#     if int(ts) &lt; from_timestamp:</span>
            <span class="c1">#         continue</span>
            <span class="c1">#     if int(ts) &lt;= anomaly_timestamp:</span>
            <span class="c1">#         correlate_ts.append((int(ts), value))</span>
            <span class="c1">#     if int(ts) &gt; (anomaly_timestamp + until_timestamp):</span>
            <span class="c1">#         break</span>
            <span class="n">correlate_ts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">timeseries</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">from_timestamp</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">until_timestamp</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">correlate_ts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">metric_data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">),</span> <span class="n">correlate_ts</span><span class="p">]</span>
            <span class="n">luminosity_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>

    <span class="c1"># @added 20230409 - Task #4872: Optimise luminosity for labelled_metrics</span>
    <span class="k">if</span> <span class="n">assigned_labelled_metrics</span><span class="p">:</span>
        <span class="n">all_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">r_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">labelled_metric_in_all_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">labelled_metric_and_indices_in_all_timeseries</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">timeseries_not_present_in_all_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">namespace</span><span class="p">:</span>
                <span class="n">filters_str</span> <span class="o">=</span> <span class="s1">&#39;_tenant_id=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
                <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">filters_str</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;luminosity_remote_data :: calling mrange with filters: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">filters</span><span class="p">))</span>
                <span class="n">all_timeseries</span> <span class="o">=</span> <span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">ts</span><span class="p">()</span><span class="o">.</span><span class="n">mrange</span><span class="p">((</span><span class="n">from_timestamp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span> <span class="p">(</span><span class="n">until_timestamp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">filters</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: luminosity_remote_data :: failed to get Redis timeseries with mrange - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="n">all_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">redis_timing</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">r_start</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;luminosity_remote_data :: mrange returned </span><span class="si">%s</span><span class="s1"> timeseries in </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_timeseries</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_timing</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">all_timeseries</span><span class="p">:</span>
            <span class="n">labelled_metric_in_all_timeseries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">tlist</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tlist</span> <span class="ow">in</span> <span class="n">all_timeseries</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">labelled_metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labelled_metric_in_all_timeseries</span><span class="p">):</span>
                <span class="n">labelled_metric_and_indices_in_all_timeseries</span><span class="p">[</span><span class="n">labelled_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">all_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">labelled_metric</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">timeseries_not_present_in_all_timeseries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: labelled_metrics_spin_process :: failed to get timeseries from all_timeseries for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">timeseries_not_present_in_all_timeseries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled_metric</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">mts</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">value</span><span class="p">]</span> <span class="k">for</span> <span class="n">mts</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">]</span>
                <span class="n">metric_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">labelled_metric</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">]</span>
                <span class="n">luminosity_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;luminosity_remote_data :: </span><span class="si">%s</span><span class="s1"> valid metric time series data preprocessed for the remote request in </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">luminosity_data</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">p_start</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">luminosity_data</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">message</span></div>


<span class="c1"># @added 20200908 - Feature #3740: webapp - anomaly API endpoint</span>
<div class="viewcode-block" id="panorama_anomaly_details"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.backend.panorama_anomaly_details">[docs]</a><span class="k">def</span> <span class="nf">panorama_anomaly_details</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the details for an anomaly from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;panorama_anomaly_details - getting details for anomaly id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>

    <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># @added 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fail_msg</span> <span class="o">!=</span> <span class="s1">&#39;got MySQL engine&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: panorama_anomaly_details :: could not get a MySQL engine fail_msg - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: panorama_anomaly_details :: could not get a MySQL engine trace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">trace</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: panorama_anomaly_details :: could not get a MySQL engine - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">anomalies_table</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">anomalies_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fail_msg</span> <span class="o">!=</span> <span class="s1">&#39;anomalies_table meta reflected OK&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: panorama_anomaly_details :: could not get a MySQL engine fail_msg - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: panorama_anomaly_details :: could not get a MySQL engine trace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">trace</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: panorama_anomaly_details :: anomalies_table_meta - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

    <span class="c1"># Added nosec to exclude from bandit tests</span>
    <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
    <span class="c1"># query = &#39;select metric_id from anomalies WHERE id=\&#39;%s\&#39;&#39; % str(anomaly_id)  # nosec</span>
    <span class="c1"># try:</span>
    <span class="c1">#     result = mysql_select(skyline_app, query)</span>
    <span class="c1">#     metric_id = int(result[0][0])</span>
    <span class="c1"># except:</span>
    <span class="c1">#     logger.error(traceback.format_exc())</span>
    <span class="c1">#     logger.error(&#39;error :: panorama_anomaly_details - failed to get metric_id from db&#39;)</span>
    <span class="c1">#     return False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_id</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: panorama_anomaly_details :: failed to get metric_id from anomalies table for anomaly_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">,</span> <span class="n">err</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">metric_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;panorama_anomaly_details - getting metric for metric_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
        <span class="c1"># Added nosec to exclude from bandit tests</span>
        <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="c1"># But in this case use get_base_name_from_metric_id</span>
        <span class="c1"># query = &#39;select metric from metrics WHERE id=\&#39;%s\&#39;&#39; % str(metric_id)  # nosec</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># result = mysql_select(skyline_app, query)</span>
            <span class="c1"># metric = str(result[0][0])</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">get_base_name_from_metric_id</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># logger.error(traceback.format_exc())</span>
            <span class="c1"># logger.error(&#39;error :: panorama_anomaly_details - failed to get metric from db&#39;)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: panorama_anomaly_details :: get_base_name_from_metric_id falied for metric_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
    <span class="c1"># query = &#39;select id, metric_id, anomalous_datapoint, anomaly_timestamp, full_duration, created_timestamp, anomaly_end_timestamp from anomalies WHERE id=\&#39;%s\&#39;&#39; % str(anomaly_id)  # nosec</span>
    <span class="c1"># logger.info(&#39;panorama_anomaly_details - running query - %s&#39; % str(query))</span>
    <span class="c1"># try:</span>
    <span class="c1">#     rows = mysql_select(skyline_app, query)</span>
    <span class="c1"># except:</span>
    <span class="c1">#     logger.error(traceback.format_exc())</span>
    <span class="c1">#     logger.error(&#39;error :: panorama_anomaly_details - failed to get anomaly details from db&#39;)</span>
    <span class="c1">#     return False</span>
    <span class="n">anomaly_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_id</span><span class="p">,</span> <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomalous_datapoint</span><span class="p">,</span> <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_timestamp</span><span class="p">,</span> <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">full_duration</span><span class="p">,</span> <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">created_timestamp</span><span class="p">,</span> <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_end_timestamp</span><span class="p">])</span><span class="o">.</span>\
            <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">anomalous_datapoint</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;anomalous_datapoint&#39;</span><span class="p">])</span>
            <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">])</span>
            <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;full_duration&#39;</span><span class="p">])</span>
            <span class="n">created_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;created_timestamp&#39;</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomaly_end_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;anomaly_end_timestamp&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">anomaly_end_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">anomaly_data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">anomalous_datapoint</span><span class="p">,</span> <span class="n">anomaly_timestamp</span><span class="p">,</span> <span class="n">full_duration</span><span class="p">,</span> <span class="n">created_timestamp</span><span class="p">,</span> <span class="n">anomaly_end_timestamp</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: panorama_anomaly_details :: failed to get anomaly from the db - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># @added 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
    <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
        <span class="n">engine_disposal</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">anomaly_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">anomaly_data</span>

    <span class="n">anomaly_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">anomalous_datapoint</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">created_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">anomaly_end_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">anomaly_end_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">anomaly_data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">anomalous_datapoint</span><span class="p">,</span> <span class="n">anomaly_timestamp</span><span class="p">,</span> <span class="n">full_duration</span><span class="p">,</span> <span class="n">created_timestamp</span><span class="p">,</span> <span class="n">anomaly_end_timestamp</span><span class="p">]</span>
        <span class="k">break</span>
    <span class="k">return</span> <span class="n">anomaly_data</span></div>


<span class="c1"># @added 20201103 - Feature #3824: get_cluster_data</span>
<span class="c1"># @modified 20201127 - Feature #3824: get_cluster_data</span>
<span class="c1">#                      Feature #3820: HORIZON_SHARDS</span>
<span class="c1"># Allow to query only a single host in the cluster so that just the response</span>
<span class="c1"># can from a single host in the cluster can be evaluated</span>
<div class="viewcode-block" id="get_cluster_data"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.backend.get_cluster_data">[docs]</a><span class="k">def</span> <span class="nf">get_cluster_data</span><span class="p">(</span><span class="n">api_endpoint</span><span class="p">,</span> <span class="n">data_required</span><span class="p">,</span> <span class="n">only_host</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">endpoint_params</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets data from the /api of REMOTE_SKYLINE_INSTANCES.  This allows the user</span>
<span class="sd">    to query a single Skyline webapp node in a cluster and the Skyline instance</span>
<span class="sd">    will respond with the concentated responses of all the</span>
<span class="sd">    REMOTE_SKYLINE_INSTANCES in one a single response.</span>

<span class="sd">    :param api_endpoint: the api endpoint to request data from the remote</span>
<span class="sd">        Skyline instances</span>
<span class="sd">    :param data_required: the element from the api json response that is</span>
<span class="sd">        required</span>
<span class="sd">    :param only_host: The remote Skyline host to query, if not passed all are</span>
<span class="sd">        queried.</span>
<span class="sd">    :param endpoint_params: A dictionary of any additional parameters that may</span>
<span class="sd">        be required</span>
<span class="sd">    :type api_endpoint: str</span>
<span class="sd">    :type data_required: str</span>
<span class="sd">    :type only_host: str</span>
<span class="sd">    :type endpoint_params: dict</span>
<span class="sd">    :return: list</span>
<span class="sd">    :rtype: list</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">connect_timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_CONNECT_TIMEOUT</span><span class="p">)</span>
        <span class="n">read_timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_READ_TIMEOUT</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">connect_timeout</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">read_timeout</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">use_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">connect_timeout</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">read_timeout</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
    <span class="c1">#                   Release #4562 - v3.0.4</span>
    <span class="c1"># Force cluster_data on appropriate methods and added cluster_call to prevent</span>
    <span class="c1"># infinite loop calls</span>
    <span class="n">cluster_call</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cluster_call_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_call&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">cluster_call</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">cluster_call</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_cluster_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: get_cluster_data was call with a request that pased cluster_call=true, prevent loop returning empty data&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">if</span> <span class="n">only_host</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: querying all remote hosts as only_host set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">only_host</span><span class="p">)))</span>

    <span class="c1"># @added 20220115 - Feature #4376: webapp - update_external_settings</span>
    <span class="c1"># Now determined based on endpoint_params if passed and handle GET</span>
    <span class="c1"># and POST</span>
    <span class="n">normal_api</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>
    <span class="n">post_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">endpoint_params</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;api_endpoint&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">endpoint_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">api_endpoint</span> <span class="o">=</span> <span class="n">endpoint_params</span><span class="p">[</span><span class="s1">&#39;api_endpoint&#39;</span><span class="p">]</span>
            <span class="n">normal_api</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: overriding api_endpoint with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">api_endpoint</span><span class="p">)))</span>
        <span class="k">if</span> <span class="s1">&#39;method&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">endpoint_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">endpoint_params</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: overriding method with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">)))</span>
        <span class="k">if</span> <span class="s1">&#39;post_data&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">endpoint_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">post_data</span> <span class="o">=</span> <span class="n">endpoint_params</span><span class="p">[</span><span class="s1">&#39;post_data&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: post_data was passed&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">password</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">use_auth</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20201127 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Feature #3820: HORIZON_SHARDS</span>
        <span class="c1"># Allow to query only a single host in the cluster so that just the response</span>
        <span class="c1"># can from a single host in the cluster can be evaluated</span>
        <span class="k">if</span> <span class="n">only_host</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">only_host</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: not querying </span><span class="si">%s</span><span class="s1"> as only_host set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">only_host</span><span class="p">)))</span>
                <span class="k">continue</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: querying </span><span class="si">%s</span><span class="s1"> as only_host set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">only_host</span><span class="p">)))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">use_auth</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">password</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: querying </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">api_endpoint</span><span class="p">)))</span>

        <span class="c1"># @added 20220115 - Feature #4376: webapp - update_external_settings</span>
        <span class="c1"># Now determined based on endpoint_params if passed and handle GET</span>
        <span class="c1"># and POST</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/api?</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">api_endpoint</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">normal_api</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">api_endpoint</span><span class="p">))</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="s1">&#39;cluster_call&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;cluster_call=true&#39;</span> <span class="o">%</span> <span class="n">url</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;cluster_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20220115 - Feature #4376: webapp - update_external_settings</span>
            <span class="c1"># Now determined based on endpoint_params if passed and handle GET</span>
            <span class="c1"># and POST</span>
            <span class="c1"># url = &#39;%s/api?%s&#39; % (str(item[0]), api_endpoint)</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">use_auth</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">use_timeout</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">use_timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">connect_timeout</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="n">read_timeout</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">use_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">connect_timeout</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">read_timeout</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">use_auth</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">),</span> <span class="n">json</span><span class="o">=</span><span class="n">post_data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">use_timeout</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERIFY_SSL</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">post_data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">use_timeout</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERIFY_SSL</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_cluster_data :: failed to get </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">api_endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="c1"># @added 20220503 - Feature #4530: namespace.analysed_events</span>
            <span class="c1"># Added 404 to handle resource not on cluster node</span>
            <span class="c1"># @modified 20220509 - Feature #4530: namespace.analysed_events</span>
            <span class="c1"># Added 400 to handle bad request on cluster node</span>
            <span class="c1"># if r.status_code == 404:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">404</span><span class="p">,</span> <span class="mi">400</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> responded with status code </span><span class="si">%s</span><span class="s1"> and reason </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">api_endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">reason</span><span class="p">)))</span>
                <span class="c1"># @modified 20220504 - Feature #4530: namespace.analysed_events</span>
                <span class="c1"># return data</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_cluster_data :: </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> responded with status code </span><span class="si">%s</span><span class="s1"> and reason </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">api_endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">reason</span><span class="p">)))</span>
                <span class="k">continue</span>

            <span class="n">js</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">js</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_cluster_data :: failed to get json from the response from </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">api_endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)))</span>
            <span class="n">remote_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">js</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: got response for </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">remote_data</span> <span class="o">=</span> <span class="n">js</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">data_required</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_cluster_data :: failed to build remote_data from </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">remote_data</span><span class="p">:</span>
                <span class="c1"># @modified 20210617 - Feature #4144: webapp - stale_metrics API endpoint</span>
                <span class="c1"># Handle list and dic items</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: got </span><span class="si">%s</span><span class="s1"> items </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_data</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">remote_data</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: got </span><span class="si">%s</span><span class="s1"> items </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_data</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_data</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: got </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">remote_data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_data</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: got </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">remote_data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_required</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># @added 20220503 - Feature #4530: namespace.analysed_events</span>
            <span class="c1"># Added 404 to handle resource not on cluster node</span>
            <span class="c1"># @modified 20220509 - Feature #4530: namespace.analysed_events</span>
            <span class="c1"># Added 400 to handle bad request on cluster node</span>
            <span class="c1"># if r.status_code == 404:</span>
            <span class="c1"># If there is no r ....</span>
            <span class="c1"># if r.status_code in [404, 400]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;get_cluster_data :: </span><span class="si">%s</span><span class="s1"> no response from </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">api_endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="c1"># @modified 20220504 - Feature #4530: namespace.analysed_events</span>
            <span class="c1"># return data</span>
            <span class="k">continue</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_cluster_data :: failed to get response from </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">api_endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">data</span></div>


<span class="c1"># @added 20221019 - Feature #4702: numba optimisations</span>
<span class="c1"># A numba function to calculate the 3sigma which reduces the time taken from</span>
<span class="c1"># ~4 seconds to 0.068135 seconds</span>
<div class="viewcode-block" id="numba_sigma3_array"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.backend.numba_sigma3_array">[docs]</a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">numba_sigma3_array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">first_index_with_value</span><span class="p">,</span> <span class="n">first_value</span><span class="p">):</span>
    <span class="n">last_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">v_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">v_mean</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">v_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">v_lower</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">v_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">v_upper</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">first_index_with_value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">first_value</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">last_value</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">last_value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">last_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">va_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">va_std_3</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">v_mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_mean</span>
        <span class="n">v_lower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_mean</span> <span class="o">-</span> <span class="n">va_std_3</span>
        <span class="n">v_upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_mean</span> <span class="o">+</span> <span class="n">va_std_3</span>
    <span class="n">sigma3_array_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">v_mean</span><span class="p">,</span>
        <span class="s1">&#39;lower&#39;</span><span class="p">:</span> <span class="n">v_lower</span><span class="p">,</span>
        <span class="s1">&#39;upper&#39;</span><span class="p">:</span> <span class="n">v_upper</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">sigma3_array_dict</span></div>


<span class="c1"># @added 20221019 - Feature #4702: numba optimisations</span>
<span class="c1"># A NO numba DEBUG function to calculate the yhat_dict which reduces the time taken from</span>
<span class="c1"># ~12 seconds to 0.068135 seconds</span>
<div class="viewcode-block" id="no_numba_yhat_dict"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.backend.no_numba_yhat_dict">[docs]</a><span class="k">def</span> <span class="nf">no_numba_yhat_dict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">lowers</span><span class="p">,</span> <span class="n">uppers</span><span class="p">,</span> <span class="n">anomaly_timestamps_indices</span><span class="p">,</span> <span class="n">include_yhat_real_lower</span><span class="p">):</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lower_yhat_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">lower_yhat_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">upper_yhat_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">upper_yhat_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">yhat_real_lower_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yhat_real_lower_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">yhat_real_upper_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yhat_real_upper_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">anomalous_period_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">anomalous_period_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">use_extended_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">use_extended_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">array_amin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">last_breach</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">breach_for</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">last_breach_vector</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="c1"># ts = item[0]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">va_mean</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">anomalous_period</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">three_sigma_lower</span> <span class="o">=</span> <span class="n">lowers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">three_sigma_upper</span> <span class="o">=</span> <span class="n">uppers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">drop_expected_range</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">anomaly_timestamps_indices</span><span class="p">:</span>
                <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># if last_used_extended:</span>
                <span class="c1">#     last_used_extended_value = None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">drop_expected_range</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">anomaly_index</span> <span class="ow">in</span> <span class="n">anomaly_timestamps_indices</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">anomaly_index</span><span class="p">:</span>
                    <span class="c1"># if index &lt; (anomaly_index + 30):</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">anomaly_index</span> <span class="o">+</span> <span class="n">breach_for</span><span class="p">):</span>
                        <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">anomalous_period</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">break</span>

            <span class="n">anomalous_period_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalous_period</span>

            <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
            <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
            <span class="k">if</span> <span class="n">use_extended</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">three_sigma_upper</span><span class="p">:</span>
                    <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                    <span class="n">extended_upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="p">((</span><span class="n">value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                    <span class="n">last_breach</span> <span class="o">=</span> <span class="n">index</span>
                    <span class="n">last_breach_vector</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span>
                <span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">three_sigma_lower</span><span class="p">:</span>
                    <span class="n">extended_lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="p">((</span><span class="n">value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                    <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                    <span class="n">last_breach</span> <span class="o">=</span> <span class="n">index</span>
                    <span class="n">last_breach_vector</span> <span class="o">=</span> <span class="s1">&#39;negative&#39;</span>
                <span class="k">elif</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">last_breach</span> <span class="o">+</span> <span class="n">breach_for</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">last_breach</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                        <span class="n">extended_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="p">((</span><span class="n">value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                        <span class="n">three_sigma_value</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                        <span class="k">if</span> <span class="n">three_sigma_value</span> <span class="o">&gt;</span> <span class="n">extended_value</span><span class="p">:</span>
                            <span class="n">extended_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">three_sigma_value</span> <span class="o">+</span> <span class="p">((</span><span class="n">three_sigma_value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                        <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                        <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">extended_value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">extended_lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="p">((</span><span class="n">value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                        <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                    <span class="k">if</span> <span class="n">drop_expected_range</span><span class="p">:</span>
                        <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                            <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_upper</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                            <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                            <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_lower</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                            <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                    <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                    <span class="k">if</span> <span class="n">drop_expected_range</span><span class="p">:</span>
                        <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                            <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_upper</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                            <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                            <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_lower</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                            <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                <span class="k">if</span> <span class="n">drop_expected_range</span><span class="p">:</span>
                    <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                        <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_upper</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                        <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                        <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_lower</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                        <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="c1"># extended_values.append([extended_lower, extended_upper])</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">extended_lower</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">extended_upper</span>

            <span class="c1"># @modified 20210201 - Task #3958: Handle secondary algorithms in yhat_values</span>
            <span class="c1"># yhat_lower = va_mean - va_std_3</span>
            <span class="n">yhat_lower</span> <span class="o">=</span> <span class="n">lower</span>
            <span class="n">yhat_upper</span> <span class="o">=</span> <span class="n">upper</span>

            <span class="k">if</span> <span class="n">include_yhat_real_lower</span><span class="p">:</span>
                <span class="c1"># @modified 20201202 - Feature #3850: webapp - yhat_values API endoint</span>
                <span class="c1"># Set the yhat_real_lower correctly</span>
                <span class="c1"># if yhat_lower &lt; array_amin and array_amin == 0:</span>
                <span class="c1">#     yhat_dict[int_ts][&#39;yhat_real_lower&#39;] = array_amin</span>
                <span class="k">if</span> <span class="n">yhat_lower</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">array_amin</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.0000000001</span><span class="p">:</span>
                    <span class="n">yhat_real_lower_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">yhat_real_lower_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat_lower</span>
            <span class="n">lower_yhat_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower</span>
            <span class="n">upper_yhat_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
            <span class="k">if</span> <span class="n">use_extended</span><span class="p">:</span>
                <span class="n">use_extended_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">use_extended_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_yhat_values :: failed create yhat_dict for&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">yhat_array_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;lower_yhat_values&#39;</span><span class="p">:</span> <span class="n">lower_yhat_values</span><span class="p">,</span>
        <span class="s1">&#39;upper_yhat_values&#39;</span><span class="p">:</span> <span class="n">upper_yhat_values</span><span class="p">,</span>
        <span class="s1">&#39;real_lower_values&#39;</span><span class="p">:</span> <span class="n">yhat_real_lower_values</span><span class="p">,</span>
        <span class="s1">&#39;real_upper_values&#39;</span><span class="p">:</span> <span class="n">yhat_real_upper_values</span><span class="p">,</span>
        <span class="s1">&#39;anomalous_period_values&#39;</span><span class="p">:</span> <span class="n">anomalous_period_values</span><span class="p">,</span>
        <span class="s1">&#39;use_extended_values&#39;</span><span class="p">:</span> <span class="n">use_extended_values</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">yhat_array_dict</span></div>


<span class="c1"># @added 20221019 - Feature #4702: numba optimisations</span>
<span class="c1"># A numba function to calculate the yhat_dict which reduces the time taken from</span>
<span class="c1"># ~12 seconds to 0.068135 seconds</span>
<div class="viewcode-block" id="numba_yhat_dict"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.backend.numba_yhat_dict">[docs]</a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">numba_yhat_dict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">lowers</span><span class="p">,</span> <span class="n">uppers</span><span class="p">,</span> <span class="n">anomaly_timestamps_indices</span><span class="p">,</span> <span class="n">include_yhat_real_lower</span><span class="p">):</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lower_yhat_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">lower_yhat_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">upper_yhat_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">upper_yhat_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">yhat_real_lower_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yhat_real_lower_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">yhat_real_upper_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yhat_real_upper_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">anomalous_period_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">anomalous_period_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">use_extended_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">use_extended_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">array_amin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">last_breach</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">breach_for</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">last_breach_vector</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="c1"># ts = item[0]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">va_mean</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">anomalous_period</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">three_sigma_lower</span> <span class="o">=</span> <span class="n">lowers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">three_sigma_upper</span> <span class="o">=</span> <span class="n">uppers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">drop_expected_range</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">anomaly_timestamps_indices</span><span class="p">:</span>
            <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drop_expected_range</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">anomaly_index</span> <span class="ow">in</span> <span class="n">anomaly_timestamps_indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">anomaly_index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">anomaly_index</span> <span class="o">+</span> <span class="n">breach_for</span><span class="p">):</span>
                    <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">anomalous_period</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>

        <span class="n">anomalous_period_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalous_period</span>

        <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
        <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
        <span class="k">if</span> <span class="n">use_extended</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">three_sigma_upper</span><span class="p">:</span>
                <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                <span class="n">extended_upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="p">((</span><span class="n">value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                <span class="n">last_breach</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">last_breach_vector</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">three_sigma_lower</span><span class="p">:</span>
                <span class="n">extended_lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="p">((</span><span class="n">value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                <span class="n">last_breach</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">last_breach_vector</span> <span class="o">=</span> <span class="s1">&#39;negative&#39;</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">last_breach</span> <span class="o">+</span> <span class="n">breach_for</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">last_breach</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                    <span class="n">extended_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="p">((</span><span class="n">value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                    <span class="n">three_sigma_value</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                    <span class="k">if</span> <span class="n">three_sigma_value</span> <span class="o">&gt;</span> <span class="n">extended_value</span><span class="p">:</span>
                        <span class="n">extended_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">three_sigma_value</span> <span class="o">+</span> <span class="p">((</span><span class="n">three_sigma_value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                    <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                    <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">extended_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extended_lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="p">((</span><span class="n">value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                    <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                <span class="k">if</span> <span class="n">drop_expected_range</span><span class="p">:</span>
                    <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                        <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_upper</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                        <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                        <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_lower</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                        <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                <span class="k">if</span> <span class="n">drop_expected_range</span><span class="p">:</span>
                    <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                        <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_upper</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                        <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                        <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_lower</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                        <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
            <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
            <span class="k">if</span> <span class="n">drop_expected_range</span><span class="p">:</span>
                <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                    <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_upper</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                    <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_lower</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="c1"># extended_values.append([extended_lower, extended_upper])</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">extended_lower</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">extended_upper</span>

        <span class="c1"># @modified 20210201 - Task #3958: Handle secondary algorithms in yhat_values</span>
        <span class="c1"># yhat_lower = va_mean - va_std_3</span>
        <span class="n">yhat_lower</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="n">yhat_upper</span> <span class="o">=</span> <span class="n">upper</span>

        <span class="k">if</span> <span class="n">include_yhat_real_lower</span><span class="p">:</span>
            <span class="c1"># @modified 20201202 - Feature #3850: webapp - yhat_values API endoint</span>
            <span class="c1"># Set the yhat_real_lower correctly</span>
            <span class="c1"># if yhat_lower &lt; array_amin and array_amin == 0:</span>
            <span class="c1">#     yhat_dict[int_ts][&#39;yhat_real_lower&#39;] = array_amin</span>
            <span class="k">if</span> <span class="n">yhat_lower</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">array_amin</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.0000000001</span><span class="p">:</span>
                <span class="n">yhat_real_lower_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">yhat_real_lower_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat_lower</span>
        <span class="n">lower_yhat_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="n">upper_yhat_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="k">if</span> <span class="n">use_extended</span><span class="p">:</span>
            <span class="n">use_extended_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_extended_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">yhat_array_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;lower_yhat_values&#39;</span><span class="p">:</span> <span class="n">lower_yhat_values</span><span class="p">,</span>
        <span class="s1">&#39;upper_yhat_values&#39;</span><span class="p">:</span> <span class="n">upper_yhat_values</span><span class="p">,</span>
        <span class="s1">&#39;real_lower_values&#39;</span><span class="p">:</span> <span class="n">yhat_real_lower_values</span><span class="p">,</span>
        <span class="s1">&#39;real_upper_values&#39;</span><span class="p">:</span> <span class="n">yhat_real_upper_values</span><span class="p">,</span>
        <span class="s1">&#39;anomalous_period_values&#39;</span><span class="p">:</span> <span class="n">anomalous_period_values</span><span class="p">,</span>
        <span class="s1">&#39;use_extended_values&#39;</span><span class="p">:</span> <span class="n">use_extended_values</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">yhat_array_dict</span></div>


<span class="c1"># @added 20201125 - Feature #3850: webapp - yhat_values API endoint</span>
<div class="viewcode-block" id="get_yhat_values"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.backend.get_yhat_values">[docs]</a><span class="k">def</span> <span class="nf">get_yhat_values</span><span class="p">(</span>
        <span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">include_value</span><span class="p">,</span> <span class="n">include_mean</span><span class="p">,</span>
        <span class="n">include_yhat_real_lower</span><span class="p">,</span> <span class="n">include_anomalous_periods</span><span class="p">):</span>

    <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_yhat_values :: for </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> until </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)))</span>

        <span class="c1"># @modified 20221025 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_graphite_metric</span><span class="p">(</span><span class="s1">&#39;webapp&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get_victoriametrics_metric automatically applies the rate and</span>
            <span class="c1"># step required no downsampling or nonNegativeDerivative is</span>
            <span class="c1"># required.</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_victoriametrics_metric</span><span class="p">(</span>
                <span class="s1">&#39;webapp&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span>
                <span class="s1">&#39;object&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_yhat_values :: failed to get timeseries data for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">metric</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># @added 20221025 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="n">redis_use_metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_yhat_values :: get_metric_id_from_base_name failed with base_name: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
            <span class="n">redis_use_metric</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>

    <span class="n">yhat_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_yhat_values :: </span><span class="si">%s</span><span class="s1"> values in timeseries for </span><span class="si">%s</span><span class="s1"> to calculate yhat values from&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)),</span> <span class="n">metric</span><span class="p">))</span>

    <span class="n">first_value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">first_index_with_value</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># @added 20210126 - Task #3958: Handle secondary algorithms in yhat_values</span>
    <span class="n">anomalous_periods_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># @added 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fail_msg</span> <span class="o">!=</span> <span class="s1">&#39;got MySQL engine&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine fail_msg - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine trace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">trace</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_yhat_values :: getting db id for metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
            <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># but in this case just use the get_metric_id_from_base_name function</span>
            <span class="c1"># query = &#39;select id from metrics WHERE metric=\&#39;%s\&#39;&#39; % metric  # nosec</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># result = mysql_select(skyline_app, query)</span>
                <span class="c1"># metric_id = int(result[0][0])</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># logger.error(&#39;error :: get_yhat_values :: failed to get id from db: %s&#39; % traceback.format_exc())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_yhat_values :: failed to get id with get_metric_id_from_base_name - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="n">anomalies_at</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_yhat_values :: getting latest anomalies&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fail_msg</span> <span class="o">!=</span> <span class="s1">&#39;got MySQL engine&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine fail_msg - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">trace</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine trace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">trace</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomalies_table</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">anomalies_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fail_msg</span> <span class="o">!=</span> <span class="s1">&#39;anomalies_table meta reflected OK&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine fail_msg - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">trace</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get a MySQL engine trace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">trace</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: anomalies_table_meta - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

            <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># query = &#39;select anomaly_timestamp, anomalous_datapoint, anomaly_end_timestamp from anomalies WHERE metric_id=%s AND anomaly_timestamp &gt;= %s AND anomaly_timestamp &lt;= %s&#39; % (</span>
            <span class="c1">#     str(metric_id), str(from_timestamp), str(until_timestamp))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
                <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
                <span class="c1"># rows = mysql_select(skyline_app, query)</span>
                <span class="c1"># for row in rows:</span>
                <span class="c1">#     a_timestamp = int(row[0])</span>
                <span class="c1">#     a_value = float(row[1])</span>
                <span class="c1">#     try:</span>
                <span class="c1">#         a_end_timestamp = int(row[2])</span>
                <span class="c1">#     except:</span>
                <span class="c1">#         a_end_timestamp = 0</span>
                <span class="c1">#     anomalies_at.append([a_timestamp, a_value, a_end_timestamp])</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_timestamp</span><span class="p">,</span> <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomalous_datapoint</span><span class="p">,</span> <span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_end_timestamp</span><span class="p">])</span><span class="o">.</span>\
                    <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_id</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span><span class="o">.</span>\
                    <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_timestamp</span> <span class="o">&gt;=</span> <span class="n">from_timestamp</span><span class="p">)</span><span class="o">.</span>\
                    <span class="n">where</span><span class="p">(</span><span class="n">anomalies_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">anomaly_timestamp</span> <span class="o">&lt;=</span> <span class="n">until_timestamp</span><span class="p">)</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">a_timestamp</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">]</span>
                    <span class="n">a_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;anomalous_datapoint&#39;</span><span class="p">])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">a_end_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;anomaly_end_timestamp&#39;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">a_end_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">anomalies_at</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">a_timestamp</span><span class="p">,</span> <span class="n">a_value</span><span class="p">,</span> <span class="n">a_end_timestamp</span><span class="p">])</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_yhat_values :: failed to get anomalies from db - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="c1"># rows = []</span>

            <span class="c1"># @added 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">engine_disposal</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>

        <span class="n">timeseries_ranges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">last_timestamp</span><span class="p">:</span>
                <span class="n">t_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="n">timeseries_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">index</span><span class="p">,</span> <span class="n">t_range</span><span class="p">,</span> <span class="n">item</span><span class="p">])</span>
            <span class="n">last_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">first_index_with_value</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="n">first_index_with_value</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">first_value</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">last_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">last_item</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="n">t_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">last_item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">timeseries_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">last_index</span><span class="p">,</span> <span class="n">t_range</span><span class="p">,</span> <span class="n">last_item</span><span class="p">])</span>
        <span class="n">anomalies_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">time_range</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">timeseries_ranges</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a_timestamp</span><span class="p">,</span> <span class="n">a_value</span><span class="p">,</span> <span class="n">a_end_timestamp</span> <span class="ow">in</span> <span class="n">anomalies_at</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a_timestamp</span> <span class="ow">in</span> <span class="n">time_range</span><span class="p">:</span>
                    <span class="n">anomalies_index</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="p">])</span>
        <span class="n">anomalous_period_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">anomalies_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">anomalies_index</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">anomalies_indices</span><span class="p">:</span>
                <span class="n">anomaly_index_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">((</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">anomaly_index_range</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">anomaly_index_range</span><span class="p">:</span>
                        <span class="n">anomalous_period_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">anomaly_timestamps_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">anomalies_index</span><span class="p">:</span>
            <span class="n">anomaly_timestamps_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">top</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">left</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">right</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># @added 20221019 - Feature #4702: numba optimisations</span>
    <span class="n">use_numba</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">sigma3_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">numba_s3_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">use_numba</span><span class="p">:</span>
        <span class="n">start_numba_s3_array</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">numba_s3_array</span> <span class="o">=</span> <span class="n">numba_sigma3_array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">first_index_with_value</span><span class="p">,</span> <span class="n">first_value</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;get_yhat_values - numba_sigma3_array took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_numba_s3_array</span><span class="p">))</span>
<span class="c1">#        start_iterate = timer()</span>
<span class="c1">#        for i, ts in enumerate(x.tolist()):</span>
<span class="c1">#            sigma3_array.append([int(ts), y[i], numba_s3_array[&#39;mean&#39;][i], [numba_s3_array[&#39;lower&#39;][i], numba_s3_array[&#39;upper&#39;][i]]])</span>
<span class="c1">#            break</span>
<span class="c1">#        logger.debug(&#39;get_yhat_values - iterate numba_sigma3_array took %.6f seconds&#39; % (timer() - start_iterate))</span>
<span class="c1">#        logger.debug(&#39;get_yhat_values - sigma3_array sample: %s&#39; % str(sigma3_array[0]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numba_s3_array</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sigma3_array</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">use_numba</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sigma3_array</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;get_yhat_values - numba_sigma3_array did not populate sigma3_array&#39;</span><span class="p">)</span>

    <span class="n">yhat_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">use_numba</span> <span class="ow">and</span> <span class="n">sigma3_array</span><span class="p">:</span>
        <span class="n">yhat_array_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">start_numba_yhat_dict</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">np_anomaly_timestamps_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">anomaly_timestamps_indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="c1"># FOR DEBUGGING</span>
            <span class="c1"># yhat_array_dict = no_numba_yhat_dict(x, y, numba_s3_array[&#39;mean&#39;], numba_s3_array[&#39;lower&#39;], numba_s3_array[&#39;upper&#39;], np_anomaly_timestamps_indices, include_yhat_real_lower)</span>
            <span class="n">yhat_array_dict</span> <span class="o">=</span> <span class="n">numba_yhat_dict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">numba_s3_array</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">numba_s3_array</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="n">numba_s3_array</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="n">np_anomaly_timestamps_indices</span><span class="p">,</span> <span class="n">include_yhat_real_lower</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: numba_yhat_dict failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_yhat_values - numba_yhat_dict took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_numba_yhat_dict</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">yhat_array_dict</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning get_yhat_values - numba_yhat_dict did not return dictionary&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">yhat_array_dict</span><span class="p">:</span>
            <span class="n">start_yhat_array_dict</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">int_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
                <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">include_value</span><span class="p">:</span>
                    <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">include_mean</span><span class="p">:</span>
                    <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numba_s3_array</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">include_yhat_real_lower</span><span class="p">:</span>
                    <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;yhat_real_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat_array_dict</span><span class="p">[</span><span class="s1">&#39;real_lower_values&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">yhat_lower</span> <span class="o">=</span> <span class="n">yhat_array_dict</span><span class="p">[</span><span class="s1">&#39;lower_yhat_values&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;yhat_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat_lower</span>
                <span class="n">yhat_upper</span> <span class="o">=</span> <span class="n">yhat_array_dict</span><span class="p">[</span><span class="s1">&#39;upper_yhat_values&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;yhat_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat_upper</span>
                <span class="n">use_extended</span> <span class="o">=</span> <span class="n">yhat_array_dict</span><span class="p">[</span><span class="s1">&#39;use_extended_values&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">use_extended</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">yhat_lower</span> <span class="o">!=</span> <span class="n">numba_s3_array</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]:</span>
                        <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;3sigma_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numba_s3_array</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">yhat_upper</span> <span class="o">!=</span> <span class="n">numba_s3_array</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]:</span>
                        <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;3sigma_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numba_s3_array</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">include_anomalous_periods</span><span class="p">:</span>
                    <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;anomalous_period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat_array_dict</span><span class="p">[</span><span class="s1">&#39;anomalous_period_values&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;get_yhat_values - iterating yhat_array_dict to create yhat_dict took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_yhat_array_dict</span><span class="p">))</span>

    <span class="c1"># if timeseries:</span>
    <span class="k">if</span> <span class="n">timeseries</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">yhat_dict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">array_amin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">])</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># @added 20210126 - Task #3958: Handle secondary algorithms in yhat_values</span>
            <span class="c1"># last_value = None</span>
            <span class="c1"># start_anomalous_period = None</span>
            <span class="c1"># end_anomalous_period = None</span>
            <span class="c1"># sigma3_array = []</span>
            <span class="c1"># sigma3_values = []</span>
            <span class="c1"># extended_values = []</span>
            <span class="n">last_breach</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">breach_for</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">last_breach_vector</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span>
            <span class="c1"># last_used_extended = False</span>
            <span class="c1"># last_used_extended_value = None</span>
            <span class="n">top</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bottom</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">left</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">right</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">error_logged</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @modified 20210126 - Task #3958: Handle secondary algorithms in yhat_values</span>
            <span class="c1"># for ts, value in timeseries:</span>
            <span class="c1">#     values.append(value)</span>
            <span class="c1">#     va = np.array(values)</span>
            <span class="c1">#     va_mean = va.mean()</span>
            <span class="c1">#    va_std_3 = 3 * va.std()</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">sigma3_array</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">va_mean</span> <span class="o">=</span> <span class="n">va</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">va_std_3</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">va</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

                    <span class="c1"># @added 20210126 - Task #3958: Handle secondary algorithms in yhat_values</span>
                    <span class="n">anomalous_period</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">three_sigma_lower</span> <span class="o">=</span> <span class="n">va_mean</span> <span class="o">-</span> <span class="n">va_std_3</span>
                    <span class="n">three_sigma_upper</span> <span class="o">=</span> <span class="n">va_mean</span> <span class="o">+</span> <span class="n">va_std_3</span>
                    <span class="c1"># sigma3_array.append([ts, value, va_mean, [three_sigma_lower, three_sigma_upper]])</span>
                    <span class="c1"># sigma3_values.append([three_sigma_lower, three_sigma_upper])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># sigma3_array [int(ts), y[i], numba_s3_array[&#39;mean&#39;][i], [numba_s3_array[&#39;lower&#39;][i], numba_s3_array[&#39;upper&#39;][i]]])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># va_mean = sigma3_array[2]</span>
                        <span class="n">va_mean</span> <span class="o">=</span> <span class="n">numba_s3_array</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">anomalous_period</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="c1"># three_sigma_lower = sigma3_array[index][3][0]</span>
                        <span class="c1"># three_sigma_upper = sigma3_array[index][3][1]</span>
                        <span class="n">three_sigma_lower</span> <span class="o">=</span> <span class="n">numba_s3_array</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">three_sigma_upper</span> <span class="o">=</span> <span class="n">numba_s3_array</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">error_logged</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: iterating index </span><span class="si">%s</span><span class="s1"> in numba_s3_array - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                            <span class="n">error_logged</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">drop_expected_range</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">anomaly_timestamps_indices</span><span class="p">:</span>
                    <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># if last_used_extended:</span>
                    <span class="c1">#     last_used_extended_value = None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">drop_expected_range</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">anomaly_index</span> <span class="ow">in</span> <span class="n">anomaly_timestamps_indices</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">anomaly_index</span><span class="p">:</span>
                        <span class="c1"># if index &lt; (anomaly_index + 30):</span>
                        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">anomaly_index</span> <span class="o">+</span> <span class="n">breach_for</span><span class="p">):</span>
                            <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">anomalous_period</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">break</span>
                <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                <span class="k">if</span> <span class="n">use_extended</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">three_sigma_upper</span><span class="p">:</span>
                        <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                        <span class="n">extended_upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                        <span class="n">last_breach</span> <span class="o">=</span> <span class="n">index</span>
                        <span class="n">last_breach_vector</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span>
                    <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">three_sigma_lower</span><span class="p">:</span>
                        <span class="n">extended_lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                        <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                        <span class="n">last_breach</span> <span class="o">=</span> <span class="n">index</span>
                        <span class="n">last_breach_vector</span> <span class="o">=</span> <span class="s1">&#39;negative&#39;</span>
                    <span class="k">elif</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">last_breach</span> <span class="o">+</span> <span class="n">breach_for</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">last_breach</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                            <span class="n">extended_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                            <span class="n">three_sigma_value</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                            <span class="k">if</span> <span class="n">three_sigma_value</span> <span class="o">&gt;</span> <span class="n">extended_value</span><span class="p">:</span>
                                <span class="n">extended_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">three_sigma_value</span> <span class="o">+</span> <span class="p">((</span><span class="n">three_sigma_value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                            <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                            <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">extended_value</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">extended_lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
                            <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                        <span class="k">if</span> <span class="n">drop_expected_range</span><span class="p">:</span>
                            <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                                <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_upper</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                                <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                                <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_lower</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                                <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                        <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                        <span class="k">if</span> <span class="n">drop_expected_range</span><span class="p">:</span>
                            <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                                <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_upper</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                                <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                                <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_lower</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                                <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                    <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                    <span class="k">if</span> <span class="n">drop_expected_range</span><span class="p">:</span>
                        <span class="n">use_extended</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                            <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_upper</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                            <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">last_breach_vector</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                            <span class="n">extended_lower</span> <span class="o">=</span> <span class="n">three_sigma_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">three_sigma_lower</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                            <span class="n">extended_upper</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                <span class="c1"># extended_values.append([extended_lower, extended_upper])</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="n">extended_lower</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="n">extended_upper</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">anomalous_period_indices</span><span class="p">))):</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">anomalies_indices</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">anomaly_timestamps_indices</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">idx</span><span class="p">:</span>
                            <span class="n">a_top</span> <span class="o">=</span> <span class="n">extended_upper</span> <span class="o">+</span> <span class="p">(</span><span class="n">extended_upper</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                            <span class="n">top</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_top</span><span class="p">)</span>
                            <span class="n">a_bottom</span> <span class="o">=</span> <span class="n">extended_lower</span> <span class="o">-</span> <span class="p">(</span><span class="n">extended_lower</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
                            <span class="n">bottom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_bottom</span><span class="p">)</span>
                            <span class="n">a_left</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">left</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_left</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="n">idx</span><span class="p">:</span>
                            <span class="n">a_right</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">right</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_right</span><span class="p">)</span>

                <span class="c1"># @modified 20201126 - Feature #3850: webapp - yhat_values API endoint</span>
                <span class="c1"># Change dict key to int not float</span>
                <span class="n">int_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
                <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">include_value</span><span class="p">:</span>
                    <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">include_mean</span><span class="p">:</span>
                    <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_mean</span>
                <span class="k">if</span> <span class="n">include_mean</span><span class="p">:</span>
                    <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_mean</span>

                <span class="c1"># @modified 20210201 - Task #3958: Handle secondary algorithms in yhat_values</span>
                <span class="c1"># yhat_lower = va_mean - va_std_3</span>
                <span class="n">yhat_lower</span> <span class="o">=</span> <span class="n">lower</span>
                <span class="n">yhat_upper</span> <span class="o">=</span> <span class="n">upper</span>

                <span class="k">if</span> <span class="n">include_yhat_real_lower</span><span class="p">:</span>
                    <span class="c1"># @modified 20201202 - Feature #3850: webapp - yhat_values API endoint</span>
                    <span class="c1"># Set the yhat_real_lower correctly</span>
                    <span class="c1"># if yhat_lower &lt; array_amin and array_amin == 0:</span>
                    <span class="c1">#     yhat_dict[int_ts][&#39;yhat_real_lower&#39;] = array_amin</span>
                    <span class="k">if</span> <span class="n">yhat_lower</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">array_amin</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.0000000001</span><span class="p">:</span>
                        <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;yhat_real_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;yhat_real_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat_lower</span>
                <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;yhat_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat_lower</span>
                <span class="c1"># @modified 20210201 - Task #3958: Handle secondary algorithms in yhat_values</span>
                <span class="c1"># yhat_dict[int_ts][&#39;yhat_upper&#39;] = va_mean + va_std_3</span>
                <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;yhat_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
                <span class="c1"># @added 20210201 - Task #3958: Handle secondary algorithms in yhat_values</span>
                <span class="k">if</span> <span class="n">use_extended</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">yhat_lower</span> <span class="o">!=</span> <span class="n">three_sigma_lower</span><span class="p">:</span>
                        <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;3sigma_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">three_sigma_lower</span>
                    <span class="k">if</span> <span class="n">yhat_upper</span> <span class="o">!=</span> <span class="n">three_sigma_upper</span><span class="p">:</span>
                        <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;3sigma_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">three_sigma_upper</span>
                <span class="k">if</span> <span class="n">include_anomalous_periods</span><span class="p">:</span>
                    <span class="n">yhat_dict</span><span class="p">[</span><span class="n">int_ts</span><span class="p">][</span><span class="s1">&#39;anomalous_period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalous_period</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_yhat_values :: failed create yhat_dict for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">metric</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_yhat_values :: calculated yhat values for </span><span class="si">%s</span><span class="s1"> data points&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yhat_dict</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">yhat_dict</span><span class="p">:</span>
        <span class="n">yhat_dict_cache_key</span> <span class="o">=</span> <span class="s1">&#39;webapp.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">include_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">include_mean</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">include_yhat_real_lower</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_yhat_values :: saving yhat_dict to Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">yhat_dict_cache_key</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">yhat_dict_cache_key</span><span class="p">,</span> <span class="mi">14400</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">yhat_dict</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_yhat_values :: created Redis key - </span><span class="si">%s</span><span class="s1"> with 14400 TTL&#39;</span> <span class="o">%</span> <span class="n">yhat_dict_cache_key</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_yhat_values :: failed to setex Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">yhat_dict_cache_key</span><span class="p">)</span>

    <span class="c1"># @added 20210126 - Task #3958: Handle secondary algorithms in yhat_values</span>
    <span class="c1"># Add rectangle coordinates that describe anomalous periods</span>
    <span class="n">anomalous_periods_dict</span><span class="p">[</span><span class="s1">&#39;rectangles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">anomalous_periods_dict</span><span class="p">[</span><span class="s1">&#39;rectangles&#39;</span><span class="p">][</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">top</span>
    <span class="n">anomalous_periods_dict</span><span class="p">[</span><span class="s1">&#39;rectangles&#39;</span><span class="p">][</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bottom</span>
    <span class="n">anomalous_periods_dict</span><span class="p">[</span><span class="s1">&#39;rectangles&#39;</span><span class="p">][</span><span class="s1">&#39;left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span>
    <span class="n">anomalous_periods_dict</span><span class="p">[</span><span class="s1">&#39;rectangles&#39;</span><span class="p">][</span><span class="s1">&#39;right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span>
    <span class="k">if</span> <span class="n">anomalous_periods_dict</span><span class="p">:</span>
        <span class="n">yhat_anomalous_periods_dict_cache_key</span> <span class="o">=</span> <span class="s1">&#39;webapp.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.anomalous_periods&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="c1"># @modified 20221025 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                      Branch #4300: prometheus</span>
            <span class="c1"># metric, str(from_timestamp), str(until_timestamp),</span>
            <span class="n">redis_use_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">include_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">include_mean</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">include_yhat_real_lower</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_yhat_values :: saving yhat_dict to Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">yhat_anomalous_periods_dict_cache_key</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">yhat_anomalous_periods_dict_cache_key</span><span class="p">,</span> <span class="mi">14400</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">yhat_anomalous_periods_dict_cache_key</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_yhat_values :: created Redis key - </span><span class="si">%s</span><span class="s1"> with 14400 TTL&#39;</span> <span class="o">%</span> <span class="n">yhat_anomalous_periods_dict_cache_key</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_yhat_values :: failed to setex Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">yhat_dict_cache_key</span><span class="p">)</span>

    <span class="c1"># @modified 20210201 - Task #3958: Handle secondary algorithms in yhat_values</span>
    <span class="c1"># return yhat_dict</span>
    <span class="k">return</span> <span class="n">yhat_dict</span><span class="p">,</span> <span class="n">anomalous_periods_dict</span></div>


<span class="c1"># @added 20210326 - Feature #3994: Panorama - mirage not anomalous</span>
<div class="viewcode-block" id="get_mirage_not_anomalous_metrics"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.backend.get_mirage_not_anomalous_metrics">[docs]</a><span class="k">def</span> <span class="nf">get_mirage_not_anomalous_metrics</span><span class="p">(</span>
        <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">anomalies</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine mirage not anomalous metrics from mirage.panorama.not_anomalous_metrics</span>
<span class="sd">    and ionosphere.panorama.not_anomalous_metrics</span>

<span class="sd">    :param metric: base_name</span>
<span class="sd">    :param from_timestamp: the from_timestamp</span>
<span class="sd">    :param until_timestamp: the until_timestamp</span>
<span class="sd">    :param anomalies: whether to report anomalies as well</span>
<span class="sd">    :type metric: str</span>
<span class="sd">    :type from_timestamp: int</span>
<span class="sd">    :type until_timestamp: int</span>
<span class="sd">    :type anomalies: boolean</span>
<span class="sd">    :return: (dict, dict)</span>
<span class="sd">    :rtype: tuple</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;get_mirage_not_anomalous_metrics called with - metric: </span><span class="si">%s</span><span class="s1">, from_timestamp: </span><span class="si">%s</span><span class="s1">, until_timestamp: </span><span class="si">%s</span><span class="s1">, anomalies: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)))</span>

    <span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">current_date_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> 00:00&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_date</span><span class="p">)</span>
    <span class="c1"># from_timestamp_date_str = current_date_str</span>
    <span class="c1"># until_timestamp_date_str = current_date_str</span>
    <span class="c1"># until_timestamp = str(int(time.time()))</span>

    <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base_name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">metric</span><span class="p">:</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span>

    <span class="c1"># if not from_timestamp and &#39;from_timestamp&#39; in request.args:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">from_timestamp</span><span class="p">:</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;today&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">from_timestamp</span> <span class="o">==</span> <span class="s1">&#39;today&#39;</span><span class="p">:</span>
            <span class="c1"># from_timestamp_date_str = current_date_str</span>
            <span class="c1"># @modified 20211021 - handle multiple date formats</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_from_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">current_date_str</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: panorama_request :: failed to determine unix timestamp from current_date_str - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
                <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_from_timestamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">from_timestamp</span> <span class="ow">and</span> <span class="n">from_timestamp</span> <span class="o">!=</span> <span class="s1">&#39;today&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">):</span>
                <span class="c1"># try:</span>
                <span class="c1">#     datetime_object = datetime.datetime.strptime(from_timestamp, &#39;%Y-%m-%d %H:%M&#39;)</span>
                <span class="c1"># except:</span>
                <span class="c1">#     # Handle old format</span>
                <span class="c1">#     datetime_object = datetime.datetime.strptime(from_timestamp, &#39;%Y%m%d %H:%M&#39;)</span>
                <span class="c1"># from_timestamp_date_str = str(datetime_object.date())</span>
                <span class="c1"># @modified 20211021 - handle multiple date formats</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_from_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">new_from_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: panorama_request :: failed to unix timestamp from from_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
                    <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>
                <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_from_timestamp</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">from_timestamp</span><span class="p">:</span>
        <span class="c1"># from_timestamp_date_str = current_date_str</span>
        <span class="c1"># @modified 20211021 - handle multiple date formats</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_from_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">current_date_str</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: panorama_request :: failed to unix get timestamp from current_date_str - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_from_timestamp</span><span class="p">)</span>

    <span class="c1"># if not until_timestamp and &#39;until_timestamp&#39; in request.args:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">until_timestamp</span><span class="p">:</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">until_timestamp</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="c1"># until_timestamp_date_str = current_date_str</span>
            <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">until_timestamp</span> <span class="ow">and</span> <span class="n">until_timestamp</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">):</span>
                <span class="c1"># datetime_object = datetime.datetime.strptime(until_timestamp, &#39;%Y-%m-%d %H:%M&#39;)</span>
                <span class="c1"># until_timestamp_date_str = str(datetime_object.date())</span>
                <span class="c1"># @modified 20211021 - handle multiple date formats</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_until_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">new_until_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: panorama_request :: failed to unix timestamp from until_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
                    <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>
                <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_until_timestamp</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">until_timestamp</span><span class="p">:</span>
        <span class="c1"># until_timestamp_date_str = current_date_str</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="n">get_anomalies</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;anomalies&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">anomalies_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;anomalies&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">anomalies_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">get_anomalies</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;get_mirage_not_anomalous_metrics - also determining anomalies for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;get_mirage_not_anomalous_metrics - base_name: </span><span class="si">%s</span><span class="s1">, from_timestamp: </span><span class="si">%s</span><span class="s1">, until_timestamp: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)))</span>

    <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;mirage.panorama.not_anomalous_metrics&#39;</span>
    <span class="n">mirage_panorama_not_anomalous</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="n">mirage_panorama_not_anomalous</span> <span class="o">=</span> <span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics :: </span><span class="si">%s</span><span class="s1"> entries to check in the </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mirage_panorama_not_anomalous</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: failed to get Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_hash</span><span class="p">)</span>
        <span class="n">mirage_panorama_not_anomalous</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># @added 20220804 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="c1"># Handle labelled_metrics.  Create a dict to limit the amount of look ups</span>
    <span class="n">labelled_metrics_base_names</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">use_base_name_metric_ids</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># @added 20220804 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="c1"># Added mirage_labelled_metrics.panorama.not_anomalous_metrics</span>
    <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;mirage_labelled_metrics.panorama.not_anomalous_metrics&#39;</span>
    <span class="n">mirage_labelled_metrics_panorama_not_anomalous</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mirage_labelled_metrics_panorama_not_anomalous</span> <span class="o">=</span> <span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics :: </span><span class="si">%s</span><span class="s1"> entries to check in the </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mirage_labelled_metrics_panorama_not_anomalous</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: failed to get Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_hash</span><span class="p">)</span>
        <span class="n">mirage_labelled_metrics_panorama_not_anomalous</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mirage_labelled_metrics_panorama_not_anomalous</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">mirage_panorama_not_anomalous</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mirage_labelled_metrics_panorama_not_anomalous</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">all_timestamp_float_strings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">mirage_panorama_not_anomalous</span><span class="p">:</span>
        <span class="n">all_timestamp_float_strings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mirage_panorama_not_anomalous</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics :: </span><span class="si">%s</span><span class="s1"> all_timestamp_float_strings to check from the </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_timestamp_float_strings</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>
    <span class="n">timestamp_floats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">all_timestamp_float_strings</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">timestamp_float_string</span> <span class="ow">in</span> <span class="n">all_timestamp_float_strings</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">timestamp_float_string</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">timestamp_float_string</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">):</span>
                    <span class="n">timestamp_floats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp_float_string</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics :: found </span><span class="si">%s</span><span class="s1"> timestamp entries in range from the </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamp_floats</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>

    <span class="n">not_anomalous_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">not_anomalous_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">timestamp_float_string</span> <span class="ow">in</span> <span class="n">timestamp_floats</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp_float_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">mirage_panorama_not_anomalous</span><span class="p">[</span><span class="n">timestamp_float_string</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">timestamp_float_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

                <span class="c1"># @added 20220801 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_metric</span><span class="p">)</span>
                <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">i_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">i_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="n">labelled_metrics_base_names</span><span class="p">[</span><span class="n">i_metric</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">i_metric</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">metric_name</span><span class="p">:</span>
                                <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                <span class="n">labelled_metrics_base_names</span><span class="p">[</span><span class="n">i_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelled_metric_base_name</span>
                                <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_base_name</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">i_metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                        <span class="n">use_base_name_metric_ids</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">labelled_metric_base_name</span><span class="p">,</span> <span class="n">i_metric</span><span class="p">]:</span>
                            <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">base_name</span> <span class="o">!=</span> <span class="n">i_metric</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics :: found entry for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">use_base_name_metric_ids</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                            <span class="n">use_base_name_metric_ids</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_dict</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">)</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">timestamp_float_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_timestamp_dict</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">metric_timestamp</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">metric_timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">metric_timestamp_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_timestamp_dict</span><span class="p">:</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">metric_timestamp</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp_float_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">metric_timestamp</span><span class="p">][</span><span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp_float_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">]</span>
                    <span class="n">not_anomalous_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;labelled_metric_base_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelled_metric_base_name</span>
                <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: failed iterate mirage_panorama_not_anomalous entry&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;get_mirage_not_anomalous_metrics - not_anomalous_count: </span><span class="si">%s</span><span class="s1">, for base_name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">not_anomalous_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)))</span>

    <span class="c1"># @added 20210429 - Feature #3994: Panorama - mirage not anomalous</span>
    <span class="c1"># A hash is added to the ionosphere.panorama.not_anomalous_metrics for</span>
    <span class="c1"># every metric that is found to be not anomalous.</span>
    <span class="n">redis_hash</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.panorama.not_anomalous_metrics&#39;</span>
    <span class="n">ionosphere_panorama_not_anomalous</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="n">ionosphere_panorama_not_anomalous</span> <span class="o">=</span> <span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_hash</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics :: </span><span class="si">%s</span><span class="s1"> entries to check in the </span><span class="si">%s</span><span class="s1"> Redis hash key&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ionosphere_panorama_not_anomalous</span><span class="p">)),</span> <span class="n">redis_hash</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: failed to get Redis hash key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_hash</span><span class="p">)</span>
        <span class="n">ionosphere_panorama_not_anomalous</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ionosphere_all_timestamp_float_strings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">ionosphere_panorama_not_anomalous</span><span class="p">:</span>
        <span class="n">ionosphere_all_timestamp_float_strings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ionosphere_panorama_not_anomalous</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">ionosphere_timestamp_floats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">all_timestamp_float_strings</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">timestamp_float_string</span> <span class="ow">in</span> <span class="n">ionosphere_all_timestamp_float_strings</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">timestamp_float_string</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">timestamp_float_string</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">):</span>
                    <span class="n">ionosphere_timestamp_floats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp_float_string</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">timestamp_float_string</span> <span class="ow">in</span> <span class="n">ionosphere_timestamp_floats</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp_float_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">ionosphere_panorama_not_anomalous</span><span class="p">[</span><span class="n">timestamp_float_string</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">timestamp_float_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

                <span class="c1"># @added 20220801 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_metric</span><span class="p">)</span>
                <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">i_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">i_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="n">labelled_metrics_base_names</span><span class="p">[</span><span class="n">i_metric</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">i_metric</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">metric_name</span><span class="p">:</span>
                                <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                <span class="n">labelled_metrics_base_names</span><span class="p">[</span><span class="n">i_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelled_metric_base_name</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">i_metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                        <span class="n">use_base_name_metric_ids</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">use_base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">labelled_metric_base_name</span><span class="p">,</span> <span class="n">i_metric</span><span class="p">]:</span>
                            <span class="k">continue</span>

                <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">base_name</span> <span class="o">!=</span> <span class="n">i_metric</span><span class="p">:</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">use_base_name_metric_ids</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                            <span class="n">use_base_name_metric_ids</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_dict</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">)</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">del</span> <span class="n">metric_dict</span>
                <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="n">timestamp_float_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                <span class="c1"># try:</span>
                <span class="c1">#     metric_timestamp_dict = not_anomalous_dict[i_metric][&#39;timestamps&#39;][metric_timestamp]</span>
                <span class="c1"># except:</span>
                <span class="c1">#     not_anomalous_dict[i_metric][&#39;timestamps&#39;][metric_timestamp] = {}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_timestamp_dict</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">metric_timestamp</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">metric_timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">metric_timestamp_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_timestamp_dict</span><span class="p">:</span>
                    <span class="c1"># not_anomalous_dict[i_metric][&#39;timestamps&#39;][metric_timestamp][&#39;value&#39;] = timestamp_float_dict[i_metric][&#39;value&#39;]</span>
                    <span class="c1"># not_anomalous_dict[i_metric][&#39;timestamps&#39;][metric_timestamp][&#39;hours_to_resolve&#39;] = timestamp_float_dict[i_metric][&#39;hours_to_resolve&#39;]</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">metric_timestamp</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp_float_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">metric_timestamp</span><span class="p">][</span><span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp_float_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">]</span>
                    <span class="n">not_anomalous_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># not_anomalous_dict[i_metric][&#39;labelled_metric_base_name&#39;] = labelled_metric_base_name</span>
                <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">][</span><span class="s1">&#39;labelled_metric_base_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelled_metric_base_name</span>
                <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">use_base_name</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: failed iterate ionosphere_panorama_not_anomalous entry&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;get_mirage_not_anomalous_metrics - not_anomalous_count: </span><span class="si">%s</span><span class="s1"> (with ionosphere), for base_name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">not_anomalous_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)))</span>

    <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">get_anomalies</span><span class="p">:</span>
        <span class="n">check_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics - determining anomalies for </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">check_metrics</span><span class="p">)))</span>

        <span class="c1"># @modified 20220801 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                      Branch #4300: prometheus</span>
        <span class="c1"># Select all the anomalies for the period and then determine the</span>
        <span class="c1"># anomalies per metric, rather than making a query for each metric.</span>
        <span class="n">query_start_str</span> <span class="o">=</span> <span class="s1">&#39;SELECT metric_id,anomaly_timestamp,anomalous_datapoint,anomaly_end_timestamp,full_duration FROM anomalies&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> WHERE anomaly_timestamp &gt; </span><span class="si">%s</span><span class="s1"> AND anomaly_timestamp &lt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">query_start_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">))</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">mysql_select</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">a_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">a_end</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># anomalies.append([int(item[0]), int(float(item[1])), float(item[2]), int(float(item[3])), round(int(float(item[4])) / 3600)])</span>
                <span class="n">anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">a_end</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: querying MySQL - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics - determined </span><span class="si">%s</span><span class="s1"> anomalies between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))):</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">i_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">i_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="n">use_base_name_metric_ids</span><span class="p">[</span><span class="n">i_metric</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">i_metric</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
            <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
            <span class="c1"># But in this case the get_metric_id_from_base_name already checks</span>
            <span class="c1"># the DB if not found in Redis so the below DB query is unneeded</span>
            <span class="c1"># if not metric_id:</span>
            <span class="c1">#     query = &#39;SELECT id FROM metrics WHERE metric=\&#39;%s\&#39;&#39; % i_metric</span>
            <span class="c1">#     try:</span>
            <span class="c1">#         results = mysql_select(skyline_app, query)</span>
            <span class="c1">#         for item in results:</span>
            <span class="c1">#             metric_id = int(item[0])</span>
            <span class="c1">#             break</span>
            <span class="c1">#     except:</span>
            <span class="c1">#         logger.error(traceback.format_exc())</span>
            <span class="c1">#         logger.error(&#39;error :: get_mirage_not_anomalous_metrics :: querying MySQL - %s&#39; % query)</span>

            <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">)</span>
            <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)</span>
            <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>

            <span class="c1"># @added 20220801 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;labelled_metric_base_name&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;labelled_metric_base_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelled_metric_base_name</span>
            <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>

            <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">anomalies</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a_metric_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">anomaly_end_timestamp</span><span class="p">,</span> <span class="n">hours_to_resolve</span> <span class="ow">in</span> <span class="n">anomalies</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">a_metric_id</span> <span class="o">!=</span> <span class="n">metric_id</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">timestamp</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">timestamp</span><span class="p">][</span><span class="s1">&#39;hours_to_resolve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hours_to_resolve</span>
                    <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">timestamp</span><span class="p">][</span><span class="s1">&#39;end_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomaly_end_timestamp</span>

    <span class="c1"># @added 20210328 - Feature #3994: Panorama - mirage not anomalous</span>
    <span class="c1"># Save key to use in not_anomalous_metric</span>
    <span class="n">not_anomalous_dict_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.not_anomalous_dict.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">))</span>
    <span class="n">not_anomalous_dict_key_ttl</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
        <span class="n">not_anomalous_dict_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.not_anomalous_dict.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="n">not_anomalous_dict_key_ttl</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">not_anomalous_dict_key</span><span class="p">,</span> <span class="n">not_anomalous_dict_key_ttl</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics :: created Redis key - </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> TTL&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">not_anomalous_dict_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">not_anomalous_dict_key_ttl</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: failed to created Redis key - </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> TTL&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">not_anomalous_dict_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">not_anomalous_dict_key_ttl</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
        <span class="n">recent_not_anomalous_dict_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.not_anomalous_dict.recent&#39;</span>
        <span class="n">recent_not_anomalous_dict_key_ttl</span> <span class="o">=</span> <span class="mi">180</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">recent_not_anomalous_dict_key</span><span class="p">,</span> <span class="n">recent_not_anomalous_dict_key_ttl</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics :: created Redis key - </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> TTL&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">recent_not_anomalous_dict_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">recent_not_anomalous_dict_key_ttl</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: failed to created Redis key - </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> TTL&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">recent_not_anomalous_dict_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">recent_not_anomalous_dict_key_ttl</span><span class="p">)))</span>

    <span class="n">anomalies_dict_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.anomalies_dict.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">))</span>
    <span class="n">anomalies_dict_key_ttl</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
        <span class="n">anomalies_dict_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.anomalies_dict.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="n">anomalies_dict_key_ttl</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">anomalies_dict_key</span><span class="p">,</span> <span class="n">anomalies_dict_key_ttl</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalies_dict</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics :: created Redis key - </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> TTL&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">anomalies_dict_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalies_dict_key_ttl</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: failed to created Redis key - </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> TTL&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">anomalies_dict_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalies_dict_key_ttl</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
        <span class="n">recent_anomalies_dict_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.not_anomalous_dict.recent&#39;</span>
        <span class="n">recent_anomalies_dict_key_ttl</span> <span class="o">=</span> <span class="mi">180</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">recent_anomalies_dict_key</span><span class="p">,</span> <span class="n">recent_anomalies_dict_key_ttl</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalies_dict</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_mirage_not_anomalous_metrics :: created Redis key - </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> TTL&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">recent_anomalies_dict_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">recent_anomalies_dict_key_ttl</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_mirage_not_anomalous_metrics :: failed to created Redis key - </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> TTL&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">recent_anomalies_dict_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">recent_anomalies_dict_key_ttl</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">not_anomalous_dict</span><span class="p">,</span> <span class="n">anomalies_dict</span></div>


<span class="c1"># @added 20210328 - Feature #3994: Panorama - mirage not anomalous</span>
<div class="viewcode-block" id="plot_not_anomalous_metric"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.backend.plot_not_anomalous_metric">[docs]</a><span class="k">def</span> <span class="nf">plot_not_anomalous_metric</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="p">,</span> <span class="n">anomalies_dict</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the metric not anomalous or anomalies graph and return the file path</span>

<span class="sd">    :param not_anomalous_dict: the dictionary of not anomalous events for the</span>
<span class="sd">        metric</span>
<span class="sd">    :param anomalies_dict: the dictionary of anomalous events for the</span>
<span class="sd">        metric</span>
<span class="sd">    :type not_anomalous_dict: dict</span>
<span class="sd">    :type anomalies_dict: dict</span>
<span class="sd">    :type plot_type: str (&#39;not_anomalous&#39; or &#39;anomalies&#39;)</span>
<span class="sd">    :return: path and filename</span>
<span class="sd">    :rtype: str</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fail_msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: plot_not_anomalous_metric :: failed to get details for plot from not_anomalous_dict&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug: not_anomalous_dict: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="p">))</span>
        <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">from_timestamp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">until_timestamp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">plot_type</span><span class="p">:</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: plot_not_anomalous_metric :: failed to get details for plot&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>  <span class="c1"># to webapp to return in the UI</span>

    <span class="c1"># @added 20220801 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="n">data_source</span> <span class="o">=</span> <span class="s1">&#39;graphite&#39;</span>
    <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">base_name</span> <span class="ow">and</span> <span class="s1">&#39;}&#39;</span> <span class="ow">in</span> <span class="n">base_name</span> <span class="ow">and</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
        <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: plot_not_anomalous_metric :: get_metric_id_from_base_name failed with base_name: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
            <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric_name</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                <span class="n">data_source</span> <span class="o">=</span> <span class="s1">&#39;victoriametrics&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: plot_not_anomalous_metric :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
        <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="s1">&#39;victoriametrics&#39;</span>

    <span class="k">if</span> <span class="n">data_source</span> <span class="o">==</span> <span class="s1">&#39;graphite&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_graphite_metric</span><span class="p">(</span>
                <span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span>
                <span class="s1">&#39;object&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: plot_not_anomalous_metric :: failed to get timeseries from Graphite for details for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>

    <span class="k">if</span> <span class="n">data_source</span> <span class="o">==</span> <span class="s1">&#39;victoriametrics&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;getting victoriametrics data for </span><span class="si">%s</span><span class="s1"> - from_timestamp - </span><span class="si">%s</span><span class="s1">, until_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get_victoriametrics_metric automatically applies the rate and</span>
            <span class="c1"># step required no downsampling or nonNegativeDerivative is</span>
            <span class="c1"># required.</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_victoriametrics_metric</span><span class="p">(</span>
                <span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span>
                <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_victoriametrics_metric failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span>

    <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;not_anomalous&#39;</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span>
    <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;anomalies&#39;</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="n">anomalies_dict</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">plot_timestamps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">plot_timestamps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_not_anomalous_metric :: building not </span><span class="si">%s</span><span class="s1"> timeseries&#39;</span> <span class="o">%</span> <span class="n">plot_type</span><span class="p">)</span>
    <span class="n">plot_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">a_timestamps_done</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="n">anomaly</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_timestamp</span><span class="p">:</span>
            <span class="n">last_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="n">plot_timeseries</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span> <span class="n">anomaly</span><span class="p">])</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">a_timestamp</span> <span class="ow">in</span> <span class="n">plot_timestamps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a_timestamp</span> <span class="o">&lt;</span> <span class="n">last_timestamp</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">a_timestamp</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">a_timestamp</span> <span class="ow">in</span> <span class="n">a_timestamps_done</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">a_timestamp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))):</span>
                <span class="n">anomaly</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">a_timestamps_done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_timestamp</span><span class="p">)</span>
        <span class="n">plot_timeseries</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span> <span class="n">anomaly</span><span class="p">])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_not_anomalous_metric :: created </span><span class="si">%s</span><span class="s1"> timeseries&#39;</span> <span class="o">%</span> <span class="n">plot_type</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_not_anomalous_metric :: creating timeseries dataframe&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
        <span class="n">datetime_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">datetime_index</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: plot_not_anomalous_metric :: failed create timeseries dataframe to plot </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_not_anomalous_metric :: creating </span><span class="si">%s</span><span class="s1"> dataframe&#39;</span> <span class="o">%</span> <span class="n">plot_type</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">plot_timeseries</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
        <span class="n">datetime_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">plot_df</span> <span class="o">=</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">datetime_index</span><span class="p">)</span>
        <span class="n">plot_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: plot_not_anomalous_metric :: failed create not anomalous dataframe to plot </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_not_anomalous_metric :: loading plot from adtk.visualization&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">adtk.visualization</span> <span class="kn">import</span> <span class="n">plot</span>
        <span class="n">sane_metricname</span> <span class="o">=</span> <span class="n">filesafe_metricname</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="n">save_to_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/panorama/not_anomalous/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">sane_metricname</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span> <span class="n">sane_metricname</span><span class="p">)</span>
        <span class="n">save_to_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_to_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;not_anomalous&#39;</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Not anomalous analysis</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>
        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;anomalies&#39;</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Anomalies</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_to_path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">save_to_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: plot_not_anomalous_metric :: failed to create dir - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">save_to_path</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_to_path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_not_anomalous_metric :: plotting&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;not_anomalous&#39;</span><span class="p">:</span>
                    <span class="n">plot</span><span class="p">(</span>
                        <span class="n">df</span><span class="p">,</span> <span class="n">anomaly</span><span class="o">=</span><span class="n">plot_df</span><span class="p">,</span> <span class="n">anomaly_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                        <span class="n">ts_markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">anomaly_alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">save_to_file</span><span class="o">=</span><span class="n">save_to_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;anomalies&#39;</span><span class="p">:</span>
                    <span class="n">plot</span><span class="p">(</span>
                        <span class="n">df</span><span class="p">,</span> <span class="n">anomaly</span><span class="o">=</span><span class="n">plot_df</span><span class="p">,</span> <span class="n">anomaly_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                        <span class="n">ts_markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">anomaly_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">save_to_file</span><span class="o">=</span><span class="n">save_to_file</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: plot_not_anomalous_metric :: plot saved to - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">save_to_file</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: plot_not_anomalous_metric :: failed to plot - </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
                <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: plot_not_anomalous_metric :: plotting </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">plot_type</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">raise</span>  <span class="c1"># to webapp to return in the UI</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">save_to_file</span><span class="p">):</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: plot_not_anomalous_metric :: plotting </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> failed&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">save_to_file</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>  <span class="c1"># to webapp to return in the UI</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;panorama.not_anomalous_plots&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">save_to_file</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_not_anomalous_metric :: set Redis hash in panorama.not_anomalous_plots for clean up&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: plot_not_anomalous_metric :: failed to set save_to_file in Redis hash - panorama.not_anomalous_plots&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">save_to_file</span></div>


<span class="c1"># @added 20210617 - Feature #4144: webapp - stale_metrics API endpoint</span>
<span class="c1">#                   Feature #4076: CUSTOM_STALE_PERIOD</span>
<span class="c1">#                   Branch #1444: thunder</span>
<div class="viewcode-block" id="namespace_stale_metrics"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.backend.namespace_stale_metrics">[docs]</a><span class="k">def</span> <span class="nf">namespace_stale_metrics</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="n">exclude_sparsely_populated</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the metric not anomalous or anomalies graph and return the file path</span>

<span class="sd">    :param not_anomalous_dict: the dictionary of not anomalous events for the</span>
<span class="sd">        metric</span>
<span class="sd">    :param anomalies_dict: the dictionary of anomalous events for the</span>
<span class="sd">        metric</span>
<span class="sd">    :type not_anomalous_dict: dict</span>
<span class="sd">    :type anomalies_dict: dict</span>
<span class="sd">    :type plot_type: str (&#39;not_anomalous&#39; or &#39;anomalies&#39;)</span>
<span class="sd">    :return: path and filename</span>
<span class="sd">    :rtype: str</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fail_msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">namespaces_namespace_stale_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">unique_base_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN_DECODED</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="n">unique_base_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN_DECODED</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.unique_base_names&#39;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> namespaces checked for stale metrics discovered with thunder_stale_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_base_names</span><span class="p">))))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?stale_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">namespace_stale_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">namespace_recovered_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">namespace_stale_metrics_dict</span><span class="p">,</span> <span class="n">namespace_recovered_metrics_dict</span> <span class="o">=</span> <span class="n">thunder_stale_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?stale_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> namespaces checked for stale metrics discovered with thunder_stale_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">namespace_stale_metrics_dict</span><span class="p">))))</span>

    <span class="n">remote_stale_metrics_dicts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
        <span class="n">exclude_sparsely_populated_str</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>
        <span class="k">if</span> <span class="n">exclude_sparsely_populated</span><span class="p">:</span>
            <span class="n">exclude_sparsely_populated_str</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="n">remote_namespaces_namespace_stale_metrics_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># @modified 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                      Release #4562 - v3.0.4</span>
        <span class="c1"># Added cluster_call</span>
        <span class="n">stale_metrics_uri</span> <span class="o">=</span> <span class="s1">&#39;stale_metrics=true&amp;namespace=</span><span class="si">%s</span><span class="s1">&amp;exclude_sparsely_populated=</span><span class="si">%s</span><span class="s1">&amp;cluster_call=true&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">exclude_sparsely_populated_str</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remote_namespaces_namespace_stale_metrics_dicts</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">stale_metrics_uri</span><span class="p">,</span> <span class="s1">&#39;stale_metrics&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get remote_namespaces_namespace_stale_metrics_dict from the remote Skyline instances&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remote_namespaces_namespace_stale_metrics_dicts</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote namespace_stale_metrics_dicts instances from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_namespaces_namespace_stale_metrics_dicts</span><span class="p">)))</span>
            <span class="n">remote_stale_metrics_dicts</span> <span class="o">=</span> <span class="n">remote_namespaces_namespace_stale_metrics_dicts</span>

    <span class="n">stale_metrics_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_metrics_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_base_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">namespace</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="k">if</span> <span class="n">remote_stale_metrics_dicts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">remote_stale_metrics_dict</span> <span class="ow">in</span> <span class="n">remote_stale_metrics_dicts</span><span class="p">:</span>
                <span class="n">total_metrics_count</span> <span class="o">=</span> <span class="n">total_metrics_count</span> <span class="o">+</span> <span class="n">remote_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;total_metrics_count&#39;</span><span class="p">]</span>
        <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;total_metrics_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_metrics_count</span>
        <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">namespace_stale_metrics_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parent_namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespace_stale_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespace_stale_metrics_dict</span><span class="p">[</span><span class="n">parent_namespace</span><span class="p">][</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">stale_metrics_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">last_timestamp</span> <span class="o">=</span> <span class="n">namespace_stale_metrics_dict</span><span class="p">[</span><span class="n">parent_namespace</span><span class="p">][</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">]</span>
                    <span class="n">stale_for</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">))</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;last_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_timestamp</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;stale_for&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stale_for</span>
        <span class="k">if</span> <span class="n">remote_stale_metrics_dicts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">remote_stale_metrics_dict</span> <span class="ow">in</span> <span class="n">remote_stale_metrics_dicts</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">remote_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">stale_metrics_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">last_timestamp</span> <span class="o">=</span> <span class="n">remote_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;last_timestamp&#39;</span><span class="p">]</span>
                    <span class="n">stale_for</span> <span class="o">=</span> <span class="n">remote_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;stale_for&#39;</span><span class="p">]</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;last_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_timestamp</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;stale_for&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stale_for</span>
        <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stale_metrics_count</span>

    <span class="k">if</span> <span class="n">namespace_stale_metrics_dict</span> <span class="ow">and</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespace</span>
        <span class="n">full_namespace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">namespace</span>
        <span class="c1"># total_metrics_count = len([base_name for base_name in unique_base_names if base_name.startswith(namespace)])</span>
        <span class="n">total_metrics_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">base_name</span> <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">unique_base_names</span> <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">full_namespace</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">remote_stale_metrics_dicts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">remote_stale_metrics_dict</span> <span class="ow">in</span> <span class="n">remote_stale_metrics_dicts</span><span class="p">:</span>
                <span class="n">total_metrics_count</span> <span class="o">=</span> <span class="n">total_metrics_count</span> <span class="o">+</span> <span class="n">remote_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;total_metrics_count&#39;</span><span class="p">]</span>
        <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;total_metrics_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_metrics_count</span>
        <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">top_level_namespace</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">namespace_stale_metrics_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parent_namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespace_stale_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">parent_namespace</span> <span class="o">!=</span> <span class="n">top_level_namespace</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespace_stale_metrics_dict</span><span class="p">[</span><span class="n">parent_namespace</span><span class="p">][</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="c1"># if not base_name.startswith(namespace):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">full_namespace</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">stale_metrics_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">last_timestamp</span> <span class="o">=</span> <span class="n">namespace_stale_metrics_dict</span><span class="p">[</span><span class="n">parent_namespace</span><span class="p">][</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">]</span>
                    <span class="n">stale_for</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">))</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;last_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_timestamp</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;stale_for&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stale_for</span>
        <span class="k">if</span> <span class="n">remote_stale_metrics_dicts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">remote_stale_metrics_dict</span> <span class="ow">in</span> <span class="n">remote_stale_metrics_dicts</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">remote_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">stale_metrics_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">last_timestamp</span> <span class="o">=</span> <span class="n">remote_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;last_timestamp&#39;</span><span class="p">]</span>
                    <span class="n">stale_for</span> <span class="o">=</span> <span class="n">remote_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;stale_for&#39;</span><span class="p">]</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;last_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_timestamp</span>
                    <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;stale_for&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stale_for</span>
        <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">[</span><span class="s1">&#39;stale_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;stale_metrics_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stale_metrics_count</span>

    <span class="k">return</span> <span class="n">namespaces_namespace_stale_metrics_dict</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>