<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>webapp.webapp &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">webapp.webapp</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for webapp.webapp</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">webapp.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isdir</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">remove</span> <span class="k">as</span> <span class="n">os_remove</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">strftime</span><span class="p">,</span> <span class="n">gmtime</span>
<span class="c1"># @added 20201126 - Feature #3850: webapp - yhat_values API endoint</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>
<span class="c1"># @added 20160703 - Feature #1464: Webapp Redis browser</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># @modified 20180918 - Feature #2602: Graphs in search_features_profiles</span>
<span class="c1"># from datetime import datetime, timedelta</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="c1"># @added 20210415 - Feature #4014: Ionosphere - inference</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="c1"># For secret_key</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="c1"># @added 20170122 - Feature #1872: Ionosphere - features profile page by id only</span>
<span class="c1"># Determine the features profile dir path for a fp_id</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="c1"># @added 20180721 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Use a gzipped response as the response as raw preprocessed time series</span>
<span class="c1"># added cStringIO, gzip and functools to implement Gzip for particular views</span>
<span class="c1"># http://flask.pocoo.org/snippets/122/</span>
<span class="c1"># from cStringIO import StringIO as IO</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="c1"># @added 20180721 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Use a gzipped response as the response as raw preprocessed time series</span>
<span class="c1"># added cStringIO to implement Gzip for particular views</span>
<span class="c1"># http://flask.pocoo.org/snippets/122/</span>
<span class="kn">import</span> <span class="nn">io</span> <span class="k">as</span> <span class="nn">IO</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="c1"># @added 20191029 - Task #3302: Handle csv.reader in py3</span>
<span class="c1">#                   Branch #3262: py3</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="c1"># @added 20220722 - Task #4624: Change all dict copy to deepcopy</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">simplejson</span> <span class="k">as</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">msgpack</span> <span class="kn">import</span> <span class="n">Unpacker</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span>
    <span class="n">send_file</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">daemon</span> <span class="kn">import</span> <span class="n">runner</span>

<span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
<span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
<span class="c1"># Roll back change - breaking existing metrics with colons</span>
<span class="c1"># import urllib.parse</span>

<span class="c1"># flask things for rebrow</span>
<span class="c1"># @modified 20180918 - Feature #2602: Graphs in search_features_profiles</span>
<span class="c1"># from flask import session, g, url_for, flash, Markup, json</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">Markup</span>

<span class="c1"># @added 20170122 - Feature #1872: Ionosphere - features profile page by id only</span>
<span class="c1"># Determine the features profile dir path for a fp_id</span>
<span class="c1"># from pytz import timezone</span>
<span class="kn">import</span> <span class="nn">pytz</span>

<span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1"># Added auth to rebrow as per https://github.com/marians/rebrow/pull/20 by</span>
<span class="c1"># elky84</span>
<span class="kn">from</span> <span class="nn">six.moves.urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>

<span class="c1"># @modified 20180918 - Feature #2602: Graphs in search_features_profiles</span>
<span class="c1"># from features_profile import feature_name_id, calculate_features_profile</span>

<span class="c1"># @modified 20221208 - Feature #4756: Use gevent gunicorn worker_class</span>
<span class="c1">#                      Feature #4732: flux vortex</span>
<span class="c1"># A workaround process was added to handle tsfresh multiprocessing as it is not</span>
<span class="c1"># possible with the current webapp layout and gunicorn running a gevent</span>
<span class="c1"># worker_class.  This app uses the sync worker_class and allows for the</span>
<span class="c1"># normal calculate_features_profile function to be run.</span>
<span class="c1"># from features_profile import calculate_features_profile</span>

<span class="kn">from</span> <span class="nn">tsfresh_feature_names</span> <span class="kn">import</span> <span class="n">TSFRESH_VERSION</span>

<span class="c1"># @modified 20180526 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1"># Use PyJWT instead of pycryptodome</span>
<span class="c1"># from Crypto.Cipher import AES</span>
<span class="c1"># import base64</span>
<span class="c1"># @added 20180526 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="kn">import</span> <span class="nn">jwt</span>

<span class="c1"># @added 20180721 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Use a gzipped response as the response as raw preprocessed time series</span>
<span class="c1"># added cStringIO, gzip and functools to implement Gzip for particular views</span>
<span class="c1"># http://flask.pocoo.org/snippets/122/</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">after_this_request</span>
<span class="c1"># from cStringIO import StringIO as IO</span>

<span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
<span class="c1"># from logging.handlers import TimedRotatingFileHandler, MemoryHandler</span>

<span class="c1"># @added 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
<span class="c1">#                   Bug #2816: Cross-Site Scripting Security Vulnerability</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">flask_escape</span>

<span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
<span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
<span class="c1"># Roll back change - breaking existing metrics with colons</span>
<span class="c1"># from werkzeug.urls import iri_to_uri</span>

<span class="c1"># @added 20220823 - Task #2732: Prometheus to Skyline</span>
<span class="c1">#                   Branch #4300: prometheus</span>
<span class="c1"># Return namespaces, labels, values and elements with the response</span>
<span class="kn">from</span> <span class="nn">prometheus_client.parser</span> <span class="kn">import</span> <span class="n">_parse_labels</span> <span class="k">as</span> <span class="n">parse_labels</span>

<span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="kn">import</span> <span class="nn">settings</span>
    <span class="kn">from</span> <span class="nn">validate_settings</span> <span class="kn">import</span> <span class="n">validate_settings_variables</span>
    <span class="kn">import</span> <span class="nn">skyline_version</span>
    <span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">get_graphite_metric</span><span class="p">,</span>
        <span class="c1"># @added 20170604 - Feature #2034: analyse_derivatives</span>
        <span class="n">in_list</span><span class="p">,</span>
        <span class="c1"># @added 20180804 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
        <span class="n">set_metric_as_derivative</span><span class="p">,</span>
        <span class="c1"># @added 20190510 - Feature #2990: Add metrics id to relevant web pages</span>
        <span class="c1"># get_memcache_metric_object,</span>
        <span class="c1"># @added 20190920 - Feature #3230: users DB table</span>
        <span class="c1">#                   Ideas #2476: Label and relate anomalies</span>
        <span class="c1">#                   Feature #2516: Add label to features profile</span>
        <span class="n">get_user_details</span><span class="p">,</span>
        <span class="c1"># @added 20191030 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                   Branch #3262: py3</span>
        <span class="c1"># Added a single functions to deal with Redis connection and the</span>
        <span class="c1"># charset=&#39;utf-8&#39;, decode_responses=True arguments required in py3</span>
        <span class="n">get_redis_conn</span><span class="p">,</span> <span class="n">get_redis_conn_decoded</span><span class="p">,</span>
        <span class="c1"># @added 20200813 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
        <span class="n">historical_data_dir_exists</span><span class="p">,</span>
        <span class="c1"># @added 20201202- Feature #3858: skyline_functions - correlate_or_relate_with</span>
        <span class="c1"># @modified 20220504 - Task #4544: Handle EXTERNAL_SETTINGS in correlate_or_relate_with</span>
        <span class="c1"># Moved to new functions.metrics.correlate_or_relate_with</span>
        <span class="c1"># correlate_or_relate_with,</span>
        <span class="c1"># @added 20210324 - Feature #3642: Anomaly type classification</span>
        <span class="n">get_anomaly_type</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="kn">from</span> <span class="nn">backend</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">panorama_request</span><span class="p">,</span>
        <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
        <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
        <span class="c1"># Deprecated get_list and using get_ functions in weabpp instead</span>
        <span class="c1"># get_list,</span>
        <span class="c1"># @added 20180720 - Feature #2464: luminosity_remote_data</span>
        <span class="n">luminosity_remote_data</span><span class="p">,</span>
        <span class="c1"># @added 20200908 - Feature #3740: webapp - anomaly API endpoint</span>
        <span class="n">panorama_anomaly_details</span><span class="p">,</span>
        <span class="c1"># @added 20201103 - Feature #3824: get_cluster_data</span>
        <span class="n">get_cluster_data</span><span class="p">,</span>
        <span class="c1"># @added 20201125 - Feature #3850: webapp - yhat_values API endoint</span>
        <span class="n">get_yhat_values</span><span class="p">,</span>
        <span class="c1"># @added 20210326 - Feature #3994: Panorama - mirage not anomalous</span>
        <span class="n">get_mirage_not_anomalous_metrics</span><span class="p">,</span>
        <span class="c1"># @added 20210328 - Feature #3994: Panorama - mirage not anomalous</span>
        <span class="n">plot_not_anomalous_metric</span><span class="p">,</span>
        <span class="c1"># @added 20210617 - Feature #4144: webapp - stale_metrics API endpoint</span>
        <span class="c1">#                   Feature #4076: CUSTOM_STALE_PERIOD</span>
        <span class="c1">#                   Branch #1444: thunder</span>
        <span class="n">namespace_stale_metrics</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span> <span class="nn">ionosphere_backend</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">ionosphere_data</span><span class="p">,</span> <span class="n">ionosphere_metric_data</span><span class="p">,</span>
        <span class="c1"># @modified 20170114 - Feature #1854: Ionosphere learn</span>
        <span class="c1"># Decoupled create_features_profile from ionosphere_backend</span>
        <span class="c1"># ionosphere_get_metrics_dir, create_features_profile,</span>
        <span class="n">ionosphere_get_metrics_dir</span><span class="p">,</span>
        <span class="n">features_profile_details</span><span class="p">,</span>
        <span class="c1"># @added 20170118 - Feature #1862: Ionosphere features profiles search page</span>
        <span class="n">ionosphere_search</span><span class="p">,</span>
        <span class="c1"># @added 20170305 - Feature #1960: ionosphere_layers</span>
        <span class="n">create_ionosphere_layers</span><span class="p">,</span> <span class="n">feature_profile_layers_detail</span><span class="p">,</span>
        <span class="n">feature_profile_layer_alogrithms</span><span class="p">,</span>
        <span class="c1"># @added 20170308 - Feature #1960: ionosphere_layers</span>
        <span class="c1"># To present the operator with the existing layers and algorithms for the metric</span>
        <span class="n">metric_layers_alogrithms</span><span class="p">,</span>
        <span class="c1"># @added 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
        <span class="c1">#                   Task #2002: Review and correct incorrectly defined layers</span>
        <span class="n">edit_ionosphere_layers</span><span class="p">,</span>
        <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
        <span class="n">validate_fp</span><span class="p">,</span>
        <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
        <span class="n">save_training_data_dir</span><span class="p">,</span>
        <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
        <span class="n">features_profile_family_tree</span><span class="p">,</span> <span class="n">disable_features_profile_family_tree</span><span class="p">,</span>
        <span class="c1"># @added 20170916 - Feature #1996: Ionosphere - matches page</span>
        <span class="n">get_fp_matches</span><span class="p">,</span>
        <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
        <span class="n">get_matched_id_resources</span><span class="p">,</span>
        <span class="c1"># @added 20180812 - Feature #2430: Ionosphere validate learnt features profiles page</span>
        <span class="n">get_features_profiles_to_validate</span><span class="p">,</span>
        <span class="c1"># @added 20180815 - Feature #2430: Ionosphere validate learnt features profiles page</span>
        <span class="n">get_metrics_with_features_profiles_to_validate</span><span class="p">,</span>
        <span class="c1"># @added 20181205 - Bug #2746: webapp time out - Graphs in search_features_profiles</span>
        <span class="c1">#                   Feature #2602: Graphs in search_features_profiles</span>
        <span class="n">ionosphere_show_graphs</span><span class="p">,</span>
        <span class="c1"># @added 20190502 - Branch #2646: slack</span>
        <span class="n">webapp_update_slack_thread</span><span class="p">,</span>
        <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
        <span class="n">validate_ionosphere_match</span><span class="p">,</span>
        <span class="c1"># @added 20200226: Ideas #2476: Label and relate anomalies</span>
        <span class="c1">#                  Feature #2516: Add label to features profile</span>
        <span class="n">label_anomalies</span><span class="p">,</span>
        <span class="c1"># @added 20201213 - Feature #3890: metrics_manager - sync_cluster_files</span>
        <span class="n">expected_features_profiles_dirs</span><span class="p">,</span>
        <span class="c1"># @added 20210413 - Feature #4014: Ionosphere - inference</span>
        <span class="c1">#                   Branch #3590: inference</span>
        <span class="n">get_matched_motifs</span><span class="p">,</span>
        <span class="c1"># @added 20210419 - Feature #4014: Ionosphere - inference</span>
        <span class="n">get_matched_motif_id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># @added 20210107 - Feature #3934: ionosphere_performance</span>
    <span class="kn">from</span> <span class="nn">ionosphere_performance</span> <span class="kn">import</span> <span class="n">get_ionosphere_performance</span>

    <span class="c1"># @added 20210415 - Feature #4014: Ionosphere - inference</span>
    <span class="kn">from</span> <span class="nn">on_demand_motif_analysis</span> <span class="kn">import</span> <span class="n">on_demand_motif_analysis</span>

    <span class="c1"># @added 20210419 - Feature #4014: Ionosphere - inference</span>
    <span class="kn">from</span> <span class="nn">motif_plots</span> <span class="kn">import</span> <span class="n">plot_motif_match</span>

    <span class="c1"># from utilites import alerts_matcher</span>
    <span class="c1"># @added 20201212 - Feature #3880: webapp - utilities - match_metric</span>
    <span class="kn">from</span> <span class="nn">matched_or_regexed_in_list</span> <span class="kn">import</span> <span class="n">matched_or_regexed_in_list</span>

    <span class="c1"># @added 20170114 - Feature #1854: Ionosphere learn</span>
    <span class="c1"># Decoupled the create_features_profile from ionosphere_backend and moved to</span>
    <span class="c1"># ionosphere_functions so it can be used by ionosphere/learn</span>
    <span class="kn">from</span> <span class="nn">ionosphere_functions</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">create_features_profile</span><span class="p">,</span> <span class="n">get_ionosphere_learn_details</span><span class="p">,</span>
        <span class="c1"># @added 20180414 - Branch #2270: luminosity</span>
        <span class="n">get_correlations</span><span class="p">,</span>
        <span class="c1"># @added 20200113 - Feature #3390: luminosity related anomalies</span>
        <span class="c1">#                   Branch #2270: luminosity</span>
        <span class="n">get_related</span><span class="p">)</span>

    <span class="c1"># @added 20200420 - Feature #3500: webapp - crucible_process_metrics</span>
    <span class="c1">#                   Feature #1448: Crucible web UI</span>
    <span class="c1">#                   Branch #868: crucible</span>
    <span class="kn">from</span> <span class="nn">crucible_backend</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">submit_crucible_job</span><span class="p">,</span> <span class="n">get_crucible_jobs</span><span class="p">,</span> <span class="n">get_crucible_job</span><span class="p">,</span>
        <span class="n">send_crucible_job_metric_to_panorama</span><span class="p">)</span>

    <span class="c1"># @added 20210317 - Feature #3978: luminosity - classify_metrics</span>
    <span class="c1">#                   Feature #3642: Anomaly type classification</span>
    <span class="kn">from</span> <span class="nn">luminosity_backend</span> <span class="kn">import</span> <span class="n">get_classify_metrics</span>

    <span class="c1"># @added 20210604 - Branch #1444: thunder</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.get_top_level_namespaces</span> <span class="kn">import</span> <span class="n">get_top_level_namespaces</span>

    <span class="c1"># @added 20210617 - Feature #4144: webapp - stale_metrics API endpoint</span>
    <span class="c1">#                   Feature #4076: CUSTOM_STALE_PERIOD</span>
    <span class="c1">#                   Branch #1444: thunder</span>
    <span class="kn">from</span> <span class="nn">functions.redis.get_metric_timeseries</span> <span class="kn">import</span> <span class="n">get_metric_timeseries</span>
    <span class="kn">from</span> <span class="nn">functions.timeseries.determine_data_sparsity</span> <span class="kn">import</span> <span class="n">determine_data_sparsity</span>

    <span class="c1"># @added 20210710 - Bug #4168: webapp/ionosphere_backend.py - handle old features profile dir not been found</span>
    <span class="kn">from</span> <span class="nn">functions.database.queries.get_all_db_metric_names</span> <span class="kn">import</span> <span class="n">get_all_db_metric_names</span>

    <span class="c1"># @added 20210720 - Feature #4188: metrics_manager.boundary_metrics</span>
    <span class="kn">from</span> <span class="nn">get_boundary_metrics</span> <span class="kn">import</span> <span class="n">get_boundary_metrics</span>

    <span class="c1"># @added 20210727 - Feature #4206: webapp - saved_training_data page</span>
    <span class="kn">from</span> <span class="nn">get_saved_training_data</span> <span class="kn">import</span> <span class="n">get_saved_training_data</span>

    <span class="c1"># @added 20210825 - Feature #4164: luminosity - cloudbursts</span>
    <span class="kn">from</span> <span class="nn">luminosity_cloudbursts</span> <span class="kn">import</span> <span class="n">get_cloudbursts</span>
    <span class="kn">from</span> <span class="nn">luminosity_plot_cloudburst</span> <span class="kn">import</span> <span class="n">get_cloudburst_plot</span>

    <span class="c1"># @added 20211001 - Feature #4264: luminosity - cross_correlation_relationships</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.get_related_metrics</span> <span class="kn">import</span> <span class="n">get_related_metrics</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.get_metric_id_from_base_name</span> <span class="kn">import</span> <span class="n">get_metric_id_from_base_name</span>
    <span class="c1"># from functions.database.queries.base_name_from_metric_id import base_name_from_metric_id</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.get_base_name_from_metric_id</span> <span class="kn">import</span> <span class="n">get_base_name_from_metric_id</span>
    <span class="kn">from</span> <span class="nn">functions.database.queries.get_metric_group_info</span> <span class="kn">import</span> <span class="n">get_metric_group_info</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.get_related_to_metric_groups</span> <span class="kn">import</span> <span class="n">get_related_to_metric_groups</span>

    <span class="c1"># @added 20211102 - Branch #3068: SNAB</span>
    <span class="c1">#                   Bug #4308: matrixprofile - fN on big drops</span>
    <span class="kn">from</span> <span class="nn">functions.database.queries.get_algorithms</span> <span class="kn">import</span> <span class="n">get_algorithms</span>
    <span class="kn">from</span> <span class="nn">functions.database.queries.get_algorithm_groups</span> <span class="kn">import</span> <span class="n">get_algorithm_groups</span>
    <span class="kn">from</span> <span class="nn">get_snab_results</span> <span class="kn">import</span> <span class="n">get_snab_results</span>

    <span class="c1"># @added 20211125 - Feature #4326: webapp - panorama_plot_anomalies</span>
    <span class="kn">from</span> <span class="nn">panorama_plot_anomalies</span> <span class="kn">import</span> <span class="n">panorama_plot_anomalies</span>

    <span class="c1"># @added 20220114 - Feature #4376: webapp - update_external_settings</span>
    <span class="kn">from</span> <span class="nn">functions.settings.manage_external_settings</span> <span class="kn">import</span> <span class="n">manage_external_settings</span>

    <span class="c1"># @added 20220117 - Feature #4324: flux - reload external_settings</span>
    <span class="c1">#                   Feature #4376: webapp - update_external_settings</span>
    <span class="c1"># from functions.flux.reload_flux import reload_flux</span>

    <span class="c1"># @added 20220128 - Feature #4376: webapp - update_external_settings</span>
    <span class="kn">from</span> <span class="nn">functions.settings.get_external_settings</span> <span class="kn">import</span> <span class="n">get_external_settings</span>

    <span class="c1"># @added 20220216 - Feature #4444: webapp - inactive_metrics</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.get_inactive_metrics</span> <span class="kn">import</span> <span class="n">get_inactive_metrics</span>

    <span class="c1"># @added 20220224 - Feature #4468: flux - remove_namespace_quota_metrics</span>
    <span class="c1">#                   Feature #4464: flux - quota - cluster_sync</span>
    <span class="kn">from</span> <span class="nn">functions.flux.remove_namespace_quota_metrics</span> <span class="kn">import</span> <span class="n">remove_namespace_quota_metrics</span>

    <span class="c1"># @added 20220317 - Feature #4540: Plot matched timeseries</span>
    <span class="c1">#                   Feature #4014: Ionosphere - inference</span>
    <span class="kn">from</span> <span class="nn">functions.ionosphere.get_matched_timeseries</span> <span class="kn">import</span> <span class="n">get_matched_timeseries</span>
    <span class="kn">from</span> <span class="nn">fp_match_plots</span> <span class="kn">import</span> <span class="n">plot_fp_match</span>

    <span class="c1"># @added 20220504 - Task #4544: Handle EXTERNAL_SETTINGS in correlate_or_relate_with</span>
    <span class="c1">#                   Feature #3858: skyline_functions - correlate_or_relate_with</span>
    <span class="c1"># New function to handle external_settings</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.correlate_or_relate_with</span> <span class="kn">import</span> <span class="n">correlate_or_relate_with</span>

    <span class="c1"># @added 202200504 - Feature #4530: namespace.analysed_events</span>
    <span class="kn">from</span> <span class="nn">api_get_metric_analysed_events</span> <span class="kn">import</span> <span class="n">api_get_metric_analysed_events</span>
    <span class="kn">from</span> <span class="nn">api_get_analysed_events</span> <span class="kn">import</span> <span class="n">api_get_analysed_events</span>

    <span class="c1"># @added 20220516 - Feature #2580: illuminance</span>
    <span class="kn">from</span> <span class="nn">functions.illuminance.get_illuminance_entries</span> <span class="kn">import</span> <span class="n">get_illuminance_entries</span>

    <span class="c1"># @added 20220517 - Feature #4578: webapp - api_get_fp_timeseries</span>
    <span class="kn">from</span> <span class="nn">api_get_fp_timeseries</span> <span class="kn">import</span> <span class="n">api_get_fp_timeseries</span>

    <span class="c1"># @added 20220727 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.get_base_name_from_labelled_metrics_name</span> <span class="kn">import</span> <span class="n">get_base_name_from_labelled_metrics_name</span>
    <span class="kn">from</span> <span class="nn">functions.victoriametrics.get_victoriametrics_metric</span> <span class="kn">import</span> <span class="n">get_victoriametrics_metric</span>

    <span class="c1"># @added 20221206 - Feature #4732: flux vortex</span>
    <span class="c1">#                   Feature #4734: mirage_vortex</span>
    <span class="kn">from</span> <span class="nn">functions.plots.vortex_training_data_graphs</span> <span class="kn">import</span> <span class="n">get_vortex_training_data_graphs</span>
    <span class="c1"># @added 20221207 - Feature #4734: mirage_vortex</span>
    <span class="c1">#                   Feature #4732: flux vortex</span>
    <span class="kn">from</span> <span class="nn">functions.mirage.get_vortex_metric_data_archive_filename</span> <span class="kn">import</span> <span class="n">get_vortex_metric_data_archive_filename</span>

    <span class="c1"># @added 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1">#                   Task #4778: v4.0.0 - update dependencies</span>
    <span class="kn">from</span> <span class="nn">functions.database.queries.get_apps</span> <span class="kn">import</span> <span class="n">get_apps</span>
    <span class="kn">from</span> <span class="nn">functions.database.queries.get_sources</span> <span class="kn">import</span> <span class="n">get_sources</span>
    <span class="kn">from</span> <span class="nn">functions.database.queries.get_hosts</span> <span class="kn">import</span> <span class="n">get_hosts</span>
    <span class="kn">from</span> <span class="nn">functions.database.queries.get_algorithms</span> <span class="kn">import</span> <span class="n">get_algorithms</span>

    <span class="c1"># @added 20220405 - Task #4514: Integrate opentelemetry</span>
    <span class="c1">#                   Feature #4516: flux - opentelemetry traces</span>
    <span class="n">OTEL_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">OTEL_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTEL_ENABLED</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">OTEL_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
        <span class="n">OTEL_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">OTEL_ENABLED</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">opentelemetry</span> <span class="kn">import</span> <span class="n">trace</span> <span class="k">as</span> <span class="n">otel_trace</span>
        <span class="kn">from</span> <span class="nn">opentelemetry.instrumentation.flask</span> <span class="kn">import</span> <span class="n">FlaskInstrumentor</span>
        <span class="kn">from</span> <span class="nn">opentelemetry.instrumentation.redis</span> <span class="kn">import</span> <span class="n">RedisInstrumentor</span>

    <span class="c1"># @added 20220509 - Feature #4564: authoritative_node</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.get_authoritative_node</span> <span class="kn">import</span> <span class="n">get_authoritative_node</span>

    <span class="c1"># @added 20220725 -</span>
    <span class="kn">from</span> <span class="nn">expose_metrics</span> <span class="kn">import</span> <span class="n">expose_metrics</span>

    <span class="kn">from</span> <span class="nn">timeseries_graph</span> <span class="kn">import</span> <span class="n">timeseries_graph</span>

    <span class="c1"># @added 20221018 - Feature #4650: ionosphere.bulk.training</span>
<span class="c1">#    from api_get_bulk_training_data import api_get_bulk_training_data</span>

    <span class="c1"># @added 20221204 - Feature #4754: csv_to_timeseries</span>
    <span class="c1">#                   Feature #4734: mirage_vortex</span>
    <span class="c1">#                   Branch #4728: vortex</span>
    <span class="kn">from</span> <span class="nn">functions.pandas.csv_to_timeseries</span> <span class="kn">import</span> <span class="n">csv_to_timeseries</span>
    <span class="kn">from</span> <span class="nn">functions.mirage.get_vortex_metric_data_from_archive</span> <span class="kn">import</span> <span class="n">get_vortex_metric_data_from_archive</span>
    <span class="kn">from</span> <span class="nn">vortex</span> <span class="kn">import</span> <span class="n">vortex_request</span>

    <span class="c1"># @added 20230127 - Feature #4830: webapp - panorama_plot_anomalies - all_events</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.get_metric_all_events</span> <span class="kn">import</span> <span class="n">get_metric_all_events</span>
    <span class="kn">from</span> <span class="nn">functions.plots.plot_metric_all_events</span> <span class="kn">import</span> <span class="n">plot_metric_all_events</span>

    <span class="c1"># @added 20230130 - Feature #4834: webapp - api - get_all_activity</span>
    <span class="c1">#                   Feature #4830: webapp - panorama_plot_anomalies - all_events</span>
    <span class="kn">from</span> <span class="nn">api_get_panorama_all_activity</span> <span class="kn">import</span> <span class="n">get_panorama_all_activity</span>

    <span class="c1"># @added 20230131 - Feature #4838: functions.metrics.get_namespace_metric.count</span>
    <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="kn">from</span> <span class="nn">api_get_namespace_metric_count</span> <span class="kn">import</span> <span class="n">api_get_namespace_metric_count</span>

    <span class="c1"># @added 20230202 - Feature #4842: webapp - api - get_flux_test_metrics</span>
    <span class="c1">#                   Feature #4840: flux - prometheus - x-test-only header</span>
    <span class="kn">from</span> <span class="nn">api_get_flux_test_metrics</span> <span class="kn">import</span> <span class="n">api_get_flux_test_metrics</span>

    <span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
    <span class="kn">from</span> <span class="nn">api_mute_alerts_on</span> <span class="kn">import</span> <span class="n">api_mute_alerts_on</span>

<span class="c1"># @added 20200516 - Feature #3538: webapp - upload_data endoint</span>
<span class="n">file_uploads_enabled</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">flux_process_uploads</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_PROCESS_UPLOADS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">flux_process_uploads</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">flux_process_uploads</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_uploads_enabled</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_ACCEPT_DATA_UPLOADS</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">file_uploads_enabled</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">file_uploads_enabled</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
    <span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">write_data_to_file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">DATA_UPLOADS_PATH</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DATA_UPLOADS_PATH</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># @modified 20230106 - Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># DATA_UPLOADS_PATH = &#39;/tmp/skyline/data_uploads&#39;</span>
        <span class="n">DATA_UPLOADS_PATH</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/data_uploads&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span>
    <span class="n">ALLOWED_EXTENSIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;xls&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="s1">&#39;gz&#39;</span><span class="p">}</span>
    <span class="n">ALLOWED_FORMATS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;xls&#39;</span><span class="p">}</span>
    <span class="c1"># @modified 20200520 - Bug #3552: flux.uploaded_data_worker - tar.gz</span>
    <span class="c1"># tar.gz needs more work</span>
    <span class="c1"># ALLOWED_ARCHIVES = {&#39;none&#39;, &#39;zip&#39;, &#39;gz&#39;, &#39;tar_gz&#39;}</span>
    <span class="n">ALLOWED_ARCHIVES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="s1">&#39;gz&#39;</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">flux_upload_keys</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_UPLOADS_KEYS</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">flux_upload_keys</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># @added 20200929 - Task #3748: POC SNAB</span>
<span class="c1">#                   Branch #3068: SNAB</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">SNAB_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SNAB_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SNAB_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">SNAB_ENABLED</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">snab_backend</span> <span class="kn">import</span> <span class="n">update_snab_result</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">update_snab_result</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># @added 20201127 - Feature #3820: HORIZON_SHARDS</span>
<span class="c1"># Added the HORIZON_SHARD variable to add to alerts for determining which</span>
<span class="c1"># Skyline instance sent the alert</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
    <span class="c1"># HORIZON_SHARDS = settings.HORIZON_SHARDS.copy()</span>
    <span class="n">HORIZON_SHARDS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">HORIZON_SHARDS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">HORIZON_SHARDS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">this_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">HORIZON_SHARD</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
    <span class="n">HORIZON_SHARD</span> <span class="o">=</span> <span class="n">HORIZON_SHARDS</span><span class="p">[</span><span class="n">this_host</span><span class="p">]</span>

<span class="c1"># @added 20201210 - Feature #3824: get_cluster_data</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">AUTH_DEBUG</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_DEBUG</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">AUTH_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">PASS_AUTH_ON_REDIRECT</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">PASS_AUTH_ON_REDIRECT</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">PASS_AUTH_ON_REDIRECT</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20210324 - Feature #3642: Anomaly type classification</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">skyline_version</span> <span class="o">=</span> <span class="n">skyline_version</span><span class="o">.</span><span class="n">__absolute_version__</span>

<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;webapp&#39;</span>
<span class="n">skyline_app_logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Log&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
<span class="n">skyline_app_logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
<span class="n">skyline_app_loglock</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">skyline_app_logwait</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wait&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>

<span class="c1"># werkzeug access log for Python errors</span>
<span class="n">access_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;werkzeug&#39;</span><span class="p">)</span>

<span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1"># @modified 20191030 - Bug #3266: py3 Redis binary objects not strings</span>
<span class="c1">#                      Branch #3262: py3</span>
<span class="c1"># Use get_redis_conn and get_redis_conn_decoded</span>
<span class="c1"># if settings.REDIS_PASSWORD:</span>
<span class="c1">#    # @modified 20190130 - Bug #3266: py3 Redis binary objects not strings</span>
<span class="c1">#    #                      Branch #3262: py3</span>
<span class="c1">#    # REDIS_CONN = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1">#    # REDIS_CONN = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH, charset=&#39;utf-8&#39;, decode_responses=True)</span>
<span class="c1">#    # @added 20191015 - Bug #3266: py3 Redis binary objects not strings</span>
<span class="c1">#    #                   Branch #3262: py3</span>
<span class="c1">#    # REDIS_CONN_UNDECODE = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1"># else:</span>
<span class="c1">#    # REDIS_CONN = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1">#    # REDIS_CONN = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH, charset=&#39;utf-8&#39;, decode_responses=True)</span>
<span class="c1">#    # @added 20191015 - Bug #3266: py3 Redis binary objects not strings</span>
<span class="c1">#    #                   Branch #3262: py3</span>
<span class="c1">#    # REDIS_CONN_UNDECODE = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>

<span class="c1"># @added 20220405 - Task #4514: Integrate opentelemetry</span>
<span class="c1">#                   Feature #4516: flux - opentelemetry traces</span>
<span class="k">if</span> <span class="n">OTEL_ENABLED</span><span class="p">:</span>

    <span class="c1"># @modified 20221102 - Bug #4714: opentelemetry check is_instrumented_by_opentelemetry</span>
    <span class="n">instrumented</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">instrumented</span> <span class="o">=</span> <span class="n">RedisInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">is_instrumented_by_opentelemetry</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: RedisInstrumentor().is_instrumented_by_opentelemetry failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">outer_err</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">instrumented</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting RedisInstrumentor&#39;</span><span class="p">)</span>
        <span class="c1"># Instrument redis</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">RedisInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;RedisInstrumentor().instrument() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outer_err</span><span class="p">)</span>

<span class="c1"># @added 20191030 - Bug #3266: py3 Redis binary objects not strings</span>
<span class="c1">#                   Branch #3262: py3</span>
<span class="c1"># Added a single functions to deal with Redis connection and the</span>
<span class="c1"># charset=&#39;utf-8&#39;, decode_responses=True arguments required in py3</span>
<span class="n">REDIS_CONN_UNDECODE</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
<span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>

<span class="n">ENABLE_WEBAPP_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># @added 20220405 - Task #4514: Integrate opentelemetry</span>
<span class="c1">#                   Feature #4516: flux - opentelemetry traces</span>
<span class="k">if</span> <span class="n">OTEL_ENABLED</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">FlaskInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="n">tracer</span> <span class="o">=</span> <span class="n">otel_trace</span><span class="o">.</span><span class="n">get_tracer</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;FlaskInstrumentor().instrument_app and tracer failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outer_err</span><span class="p">)</span>

<span class="c1"># @modified 20190502 - Branch #2646: slack</span>
<span class="c1"># Reduce logging, removed gunicorn</span>
<span class="c1"># gunicorn_error_logger = logging.getLogger(&#39;gunicorn.error&#39;)</span>
<span class="c1"># logger.handlers.extend(gunicorn_error_logger.handlers)</span>
<span class="c1"># logger.setLevel(logging.DEBUG)</span>

<span class="c1"># app.secret_key = str(uuid.uuid5(uuid.NAMESPACE_DNS, settings.GRAPHITE_HOST))</span>
<span class="n">secret_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid5</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">NAMESPACE_DNS</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">))</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secret_key</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PROPAGATE_EXCEPTIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">SESSION_COOKIE_NAME</span><span class="o">=</span><span class="s1">&#39;skyline&#39;</span><span class="p">,</span>
    <span class="n">SESSION_COOKIE_SECURE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">SECRET_KEY</span><span class="o">=</span><span class="n">secret_key</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">file_uploads_enabled</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MAX_CONTENT_LENGTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DATA_UPLOADS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATA_UPLOADS_PATH</span>

<span class="n">graph_url_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPH_URL</span><span class="p">)</span>
<span class="n">PANORAMA_GRAPH_URL</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">/render.*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">graph_url_string</span><span class="p">)</span>

<span class="c1"># @added 20160727 - Bug #1524: Panorama dygraph not aligning correctly</span>
<span class="c1"># Defaults for momentjs to work if the setttings.py was not updated</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">WEBAPP_USER_TIMEZONE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_USER_TIMEZONE</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">WEBAPP_USER_TIMEZONE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">WEBAPP_FIXED_TIMEZONE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_FIXED_TIMEZONE</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">WEBAPP_FIXED_TIMEZONE</span> <span class="o">=</span> <span class="s1">&#39;Etc/GMT+0&#39;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">WEBAPP_JAVASCRIPT_DEBUG</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_JAVASCRIPT_DEBUG</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">WEBAPP_JAVASCRIPT_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20190520 - Branch #3002: docker</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">GRAPHITE_RENDER_URI</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_RENDER_URI</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">GRAPHITE_RENDER_URI</span> <span class="o">=</span> <span class="s1">&#39;render&#39;</span>

<span class="c1"># @added 20200731 - Feature #3654: IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20200813 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">IONOSPHERE_HISTORICAL_DATA_FOLDER</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_HISTORICAL_DATA_FOLDER</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">IONOSPHERE_HISTORICAL_DATA_FOLDER</span> <span class="o">=</span> <span class="s1">&#39;/opt/skyline/ionosphere/historical_data&#39;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20210112 - Feature #3934: ionosphere_performance</span>
<span class="n">ionosphere_dir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">)</span>
<span class="n">performance_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/performance&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ionosphere_dir</span><span class="p">)</span>

<span class="c1"># @added 20210209 - Feature #1448: Crucible web UI</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">crucible_jobs_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/jobs&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CRUCIBLE_DATA_FOLDER</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">crucible_jobs_dir</span> <span class="o">=</span> <span class="s1">&#39;/opt/skyline/crucible/jobs&#39;</span>

<span class="c1"># @added 20210316 - Feature #3978: luminosity - classify_metrics</span>
<span class="c1">#                   Feature #3642: Anomaly type classification</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">luminosity_data_folder</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">LUMINOSITY_DATA_FOLDER</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">luminosity_data_folder</span> <span class="o">=</span> <span class="s1">&#39;/opt/skyline/luminosity&#39;</span>

<span class="c1"># @added 20220408 - Task #4514: Integrate opentelemetry</span>
<span class="c1">#                   Feature #4516: flux - opentelemetry traces</span>
<span class="n">WEBAPP_SERVE_JAEGER</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">WEBAPP_SERVE_JAEGER</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_SERVE_JAEGER</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="n">WEBAPP_SERVE_JAEGER</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="limit_remote_addr"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.limit_remote_addr">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="c1"># def setup_logging():</span>
<span class="c1">#    if not app.debug:</span>
<span class="c1">#        stream_handler = logging.StreamHandler()</span>
<span class="c1">#        stream_handler.setLevel(logging.DEBUG)</span>
<span class="c1">#        app.logger.addHandler(stream_handler)</span>
<span class="c1">#        import logging</span>
<span class="c1">#        from logging.handlers import TimedRotatingFileHandler, MemoryHandler</span>
<span class="c1">#        file_handler = MemoryHandler(app_logfile, mode=&#39;a&#39;)</span>
<span class="c1">#        file_handler.setLevel(logging.DEBUG)</span>
<span class="c1">#        app.logger.addHandler(file_handler)</span>
<span class="c1">#</span>
<span class="c1">#        formatter = logging.Formatter(&quot;%(asctime)s :: %(process)s :: %(message)s&quot;, datefmt=&quot;%Y-%m-%d %H:%M:%S&quot;)</span>
<span class="c1">#        handler = logging.handlers.TimedRotatingFileHandler(</span>
<span class="c1">#            app_logfile,</span>
<span class="c1">#            when=&quot;midnight&quot;,</span>
<span class="c1">#            interval=1,</span>
<span class="c1">#            backupCount=5)</span>
<span class="c1">#        handler.setLevel(logging.DEBUG)</span>
<span class="c1">#</span>
<span class="c1">#        memory_handler = logging.handlers.MemoryHandler(100,</span>
<span class="c1">#                                                        flushLevel=logging.DEBUG,</span>
<span class="c1">#                                                        target=handler)</span>
<span class="c1">#        handler.setFormatter(formatter)</span>
<span class="c1">#        app.logger.addHandler(memory_handler)</span>
<span class="c1">#        app.logger.addHandler(handler)</span>
<span class="k">def</span> <span class="nf">limit_remote_addr</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called to check if the requesting IP address is in the</span>
<span class="sd">    settings.WEBAPP_ALLOWED_IPS array, if not 403.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ip_allowed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">web_allowed_ip</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_ALLOWED_IPS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span> <span class="o">==</span> <span class="n">web_allowed_ip</span><span class="p">:</span>
            <span class="n">ip_allowed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP_RESTRICTED</span><span class="p">:</span>
        <span class="n">ip_allowed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ip_allowed</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>  <span class="c1"># Forbidden</span></div>


<span class="c1"># @added 20200514 - Feature #3538: webapp - upload_data endoint</span>
<div class="viewcode-block" id="allowed_file"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.allowed_file">[docs]</a><span class="k">def</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> \
           <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ALLOWED_EXTENSIONS</span></div>


<div class="viewcode-block" id="check_auth"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.check_auth">[docs]</a><span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function is called to check if a username /</span>
<span class="sd">    password combination is valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># @added 20200814 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
    <span class="c1"># Log full request</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">username</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER_PASSWORD</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="authenticate"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.authenticate">[docs]</a><span class="k">def</span> <span class="nf">authenticate</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends a 401 response that enables basic auth&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
        <span class="s1">&#39;Forbidden&#39;</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;WWW-Authenticate&#39;</span><span class="p">:</span> <span class="s1">&#39;Basic realm=&quot;Login Required&quot;&#39;</span><span class="p">})</span></div>


<div class="viewcode-block" id="requires_auth"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.requires_auth">[docs]</a><span class="k">def</span> <span class="nf">requires_auth</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authorization</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">auth</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">check_auth</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">auth</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">authenticate</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">decorated</span></div>


<span class="c1"># @added 20180721 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Use a gzipped response as the response as raw preprocessed time series with</span>
<span class="c1"># an implementation of Gzip for particular views</span>
<span class="c1"># http://flask.pocoo.org/snippets/122/</span>
<div class="viewcode-block" id="gzipped"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.gzipped">[docs]</a><span class="k">def</span> <span class="nf">gzipped</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">view_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nd">@after_this_request</span>
        <span class="k">def</span> <span class="nf">zipper</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
            <span class="n">accept_encoding</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;gzip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">accept_encoding</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="n">response</span><span class="o">.</span><span class="n">direct_passthrough</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">300</span> <span class="ow">or</span> <span class="s1">&#39;Content-Encoding&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">response</span>
            <span class="n">gzip_buffer</span> <span class="o">=</span> <span class="n">IO</span><span class="p">()</span>
            <span class="n">gzip_file</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">,</span>
                                      <span class="n">fileobj</span><span class="o">=</span><span class="n">gzip_buffer</span><span class="p">)</span>
            <span class="n">gzip_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">gzip_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">response</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">gzip_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Vary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Accept-Encoding&#39;</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">response</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">view_func</span></div>


<span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
<div class="viewcode-block" id="url_encode_metric_name"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.url_encode_metric_name">[docs]</a><span class="k">def</span> <span class="nf">url_encode_metric_name</span><span class="p">(</span><span class="n">metric_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    URL Encode a metric name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url_encoded_metric_name</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
        <span class="n">url_encoded_metric_name</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
        <span class="n">url_encoded_metric_name</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">url_encoded_metric_name</span><span class="p">:</span>
        <span class="n">metric_name</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;url encoded metric_name to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric_name</span></div>


<div class="viewcode-block" id="internal_error"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.internal_error">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show traceback in the browser when running a flask app on a production</span>
<span class="sd">    server.</span>
<span class="sd">    By default, flask does not show any useful information when running on a</span>
<span class="sd">    production server.</span>
<span class="sd">    By adding this view, we output the Python traceback to the error 500 page</span>
<span class="sd">    and log.</span>

<span class="sd">    As per:</span>
<span class="sd">    Show flask traceback when running on production server</span>
<span class="sd">    https://gist.github.com/probonopd/8616a8ff05c8a75e4601 - Python traceback</span>
<span class="sd">    rendered nicely by Jinja2</span>

<span class="sd">    This can be tested by hitting SKYLINE_URL/a_500</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fail_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback_format_exc</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: returning 500 as there was an error, why else would 500 be returned...&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: sending the user that caused the error to happen, this useful information&#39;</span><span class="p">)</span>
    <span class="c1"># logger.debug(&#39;debug :: but they or I may have already emailed it to you, you should check your inbox&#39;)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback_format_exc</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: which is accompanied with the message&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: request url :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: request referrer :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">referrer</span><span class="p">))</span>
    <span class="c1"># resp = &#39;&lt;pre&gt;%s&lt;/pre&gt;&lt;pre&gt;%s&lt;/pre&gt;&#39; % (str(message), str(traceback_format_exc))</span>
<span class="c1">#    return(resp), 500</span>
    <span class="n">server_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;traceback.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
        <span class="n">message</span><span class="o">=</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span> <span class="n">bad_machine</span><span class="o">=</span><span class="n">server_name</span><span class="p">),</span> <span class="mi">500</span></div>


<div class="viewcode-block" id="index"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.index">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;uh_oh&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;uh_oh.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Testing uh_oh&quot;</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render uh_oh.html: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;now.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">error_string</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render index.html: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<div class="viewcode-block" id="a_500"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.a_500">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/a_500&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">a_500</span><span class="p">():</span>

    <span class="k">if</span> <span class="s1">&#39;message&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: message - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="n">test_500_string</span> <span class="o">=</span> <span class="n">message</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: testing /a_500 route and app.errorhandler(500) internal_error function&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Testing app.errorhandler(500) internal_error function, if you are seeing this it works - OK&#39;</span>
        <span class="n">test_500_string</span> <span class="o">=</span> <span class="s1">&#39;This is a test to generate a ValueError and a HTTP response of 500 and display the traceback&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">test_errorhandler_500_internal_error</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_500_string</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;debug :: test_errorhandler_500_internal_error tests OK with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">test_errorhandler_500_internal_error</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: test OK&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;failed test of /a_500 route and app.errorhandler(500) internal_error function&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">error_msg</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">501</span></div>


<div class="viewcode-block" id="now"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.now">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/now&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;now.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">error_string</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render now.html: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<div class="viewcode-block" id="then"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.then">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/then&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">then</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;then.html&#39;</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">error_string</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render then.html: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<div class="viewcode-block" id="anomalies"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.anomalies">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/anomalies.json&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">anomalies</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">anomalies_json</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANOMALY_DUMP</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anomalies_json</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get anomalies.json: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="k">return</span> <span class="n">json_data</span><span class="p">,</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="panorama_anomalies"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.panorama_anomalies">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/panorama.json&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">panorama_anomalies</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">anomalies_json</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANOMALY_DUMP</span><span class="p">))</span>
        <span class="c1"># @modified 20191014 - Task #3270: Deprecate string.replace for py3</span>
        <span class="c1"># panorama_json = string.replace(str(anomalies_json), &#39;anomalies.json&#39;, &#39;panorama.json&#39;)</span>
        <span class="n">panorama_json</span> <span class="o">=</span> <span class="n">anomalies_json</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;anomalies.json&#39;</span><span class="p">,</span> <span class="s1">&#39;panorama.json&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;opening - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">panorama_json</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">panorama_json</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get panorama.json: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="k">return</span> <span class="n">json_data</span><span class="p">,</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="panorama_not_anomalous"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.panorama_not_anomalous">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/panorama_not_anomalous.json&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">panorama_not_anomalous</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">anomalies_json</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANOMALY_DUMP</span><span class="p">))</span>
        <span class="n">panorama_not_anomalous_json</span> <span class="o">=</span> <span class="n">anomalies_json</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;anomalies.json&#39;</span><span class="p">,</span> <span class="s1">&#39;panorama_not_anomalous.json&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;opening - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">panorama_not_anomalous_json</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">panorama_not_anomalous_json</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get panorama_not_anomalous.json: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="k">return</span> <span class="n">json_data</span><span class="p">,</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="app_settings"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.app_settings">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/app_settings&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">app_settings</span><span class="p">():</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">web_app_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;GRAPH_URL&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPH_URL</span><span class="p">,</span>
            <span class="s1">&#39;OCULUS_HOST&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">OCULUS_HOST</span><span class="p">,</span>
            <span class="s1">&#39;FULL_NAMESPACE&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span>
            <span class="s1">&#39;SKYLINE_VERSION&#39;</span><span class="p">:</span> <span class="n">skyline_version</span><span class="p">,</span>
            <span class="s1">&#39;PANORAMA_ENABLED&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">,</span>
            <span class="s1">&#39;PANORAMA_DATABASE&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DATABASE</span><span class="p">,</span>
            <span class="s1">&#39;PANORAMA_DBHOST&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBHOST</span><span class="p">,</span>
            <span class="s1">&#39;PANORAMA_DBPORT&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBPORT</span><span class="p">,</span>
            <span class="s1">&#39;PANORAMA_DBUSER&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBUSER</span><span class="p">,</span>
            <span class="s1">&#39;PANORAMA_DBUSERPASS&#39;</span><span class="p">:</span> <span class="s1">&#39;redacted&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PANORAMA_GRAPH_URL&#39;</span><span class="p">:</span> <span class="n">PANORAMA_GRAPH_URL</span><span class="p">,</span>
            <span class="s1">&#39;WEBAPP_USER_TIMEZONE&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_USER_TIMEZONE</span><span class="p">,</span>
            <span class="s1">&#39;WEBAPP_FIXED_TIMEZONE&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_FIXED_TIMEZONE</span><span class="p">,</span>
            <span class="s1">&#39;WEBAPP_JAVASCRIPT_DEBUG&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_JAVASCRIPT_DEBUG</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;error: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;app_settings&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">500</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">web_app_settings</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="version"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.version">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/version&#39;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">version</span><span class="p">():</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">version_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SKYLINE_VERSION&#39;</span><span class="p">:</span> <span class="n">skyline_version</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">version_settings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Not Found&quot;</span><span class="p">,</span> <span class="mi">404</span></div>


<div class="viewcode-block" id="api"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.api">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="c1"># @modified 20180720 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Rnamed def from data to api for the purpose of trying to add some</span>
<span class="c1"># documentation relating to the API endpoints and their required parameters,</span>
<span class="c1"># the results or error and status codes they return and the context in which</span>
<span class="c1"># they are used.</span>
<span class="c1"># def data():</span>
<span class="k">def</span> <span class="nf">api</span><span class="p">():</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># @added 20201110 - Feature #3824: get_cluster_data</span>
    <span class="c1"># Allow for the cluster_data argument to be added to certain api requests</span>
    <span class="c1"># to allow for data from all remote Skyline instances to be concatenated</span>
    <span class="c1"># into a single response</span>
    <span class="c1"># IMPORTANT: cluster_data MUST be the first argument that is evaluated as it</span>
    <span class="c1">#            is used and required by many of the following API methods</span>
    <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;cluster_data&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cluster_data_argument</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_data&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cluster_data_argument</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api request with cluster_data=true&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cluster_data_argument</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api request with cluster_data=false&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api request with invalid cluster_data argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_data_argument</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api request with invalid cluster_data argument&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
    <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
    <span class="c1">#                   Release #4562 - v3.0.4</span>
    <span class="c1"># Force cluster_data on appropriate methods</span>
    <span class="n">cluster_call</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cluster_call_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_call&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">cluster_call</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">cluster_call</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp error with api?thunder_no_data_remove_namespace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

    <span class="c1"># IMPORTANT: cluster_data ^^ MUST be the first argument that is evaluated as it</span>
    <span class="c1">#            is used and required by many of the following API methods</span>

    <span class="c1"># @added 20230504 - Feature #4564: authoritative_node</span>
    <span class="k">if</span> <span class="s1">&#39;authoritative_cluster_node&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?authoritative_cluster_node request for metric: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?authoritative_cluster_node request no metric argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">authoritative_node</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_host</span><span class="p">)</span>
        <span class="n">authoritative_fqdn</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span>
        <span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
            <span class="n">authoritative_node</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">authoritative_node</span> <span class="o">=</span> <span class="n">get_authoritative_node</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?authoritative_cluster_node - reports - </span><span class="si">%s</span><span class="s1"> as the authoritative cluster node&#39;</span> <span class="o">%</span> <span class="n">authoritative_node</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_authoritative_node failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
            <span class="n">authoritative_fqdn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">authoritative_fqdn</span> <span class="o">=</span> <span class="n">get_authoritative_node</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">return_fqdn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?authoritative_cluster_node - reports - </span><span class="si">%s</span><span class="s1"> as the authoritative cluster node FQDN&#39;</span> <span class="o">%</span> <span class="n">authoritative_fqdn</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_authoritative_node failed to determine authoritative_fqdn - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;authoritative_node&#39;</span><span class="p">:</span> <span class="n">authoritative_node</span><span class="p">,</span> <span class="s1">&#39;authoritative_fqdn&#39;</span><span class="p">:</span> <span class="n">authoritative_fqdn</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">}</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20230202 - Feature #4842: webapp - api - get_flux_test_metrics</span>
    <span class="c1">#                   Feature #4840: flux - prometheus - x-test-only header</span>
    <span class="k">if</span> <span class="s1">&#39;get_flux_test_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">start_get_flux_test_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_flux_test_metrics request with namespace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?get_flux_test_metrics request no namespace argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">flux_test_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flux_test_data</span> <span class="o">=</span> <span class="n">api_get_flux_test_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">cluster_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api_get_flux_test_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">end_flux_test_metrics_time</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">get_flux_test_metrics_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_flux_test_metrics_time</span> <span class="o">-</span> <span class="n">start_get_flux_test_metrics</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flux_test_data</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_flux_test_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;flux_test_metrics&#39;</span><span class="p">:</span> <span class="n">flux_test_data</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_flux_test_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;flux_test_metrics&#39;</span><span class="p">:</span> <span class="n">flux_test_data</span><span class="p">}}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_flux_test_metrics - responding with flux_test_data&#39;</span><span class="p">)</span>
        <span class="c1"># Flask jsonify baulk on the data with,</span>
        <span class="c1"># TypeError: &#39;&lt;&#39; not supported between instances of &#39;str&#39; and &#39;int&#39;</span>
        <span class="c1"># but json.dumps does not.  Flask uses simplejson not the built-in one.</span>
        <span class="c1"># return jsonify(data_dict), 200</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">response_class</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span>
            <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="c1"># @added 20230131 - Feature #4838: functions.metrics.get_namespace_metric.count</span>
    <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="k">if</span> <span class="s1">&#39;get_namespace_metric_count&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">start_get_namespace_metric_count</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_namespace_metric_count request with namespace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?get_namespace_metric_count request no namespace argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">namespace_metric_count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace_metric_count</span> <span class="o">=</span> <span class="n">api_get_namespace_metric_count</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api_get_namespace_metric_count failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">end_get_namespace_metric_count</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">get_namespace_metric_count_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_get_namespace_metric_count</span> <span class="o">-</span> <span class="n">start_get_namespace_metric_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace_metric_count</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_namespace_metric_count_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_namespace_metric_count_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">namespace_metric_count</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20230130 - Feature #4834: webapp - api - get_all_activity</span>
    <span class="c1">#                   Feature #4830: webapp - panorama_plot_anomalies - all_events</span>
    <span class="c1"># Added an api method to make the request to /panorama? which requires auth</span>
    <span class="c1"># and further the api is more suited to making cluster requests than the</span>
    <span class="c1"># panorama endpoint</span>
    <span class="k">if</span> <span class="s1">&#39;get_all_activity&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">start_get_all_activity</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">request_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_all_activity request with metric: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?get_all_activity request no metric argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">authoritative_node</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_host</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">authoritative_node</span> <span class="o">=</span> <span class="n">get_authoritative_node</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api get_authoritative_node - reports - </span><span class="si">%s</span><span class="s1"> as the authoritative cluster node for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">authoritative_node</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api get_authoritative_node failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">authoritative_node</span> <span class="o">!=</span> <span class="n">this_host</span><span class="p">:</span>
                <span class="n">find_host</span> <span class="o">=</span> <span class="n">this_host</span>
                <span class="n">replace_host</span> <span class="o">=</span> <span class="n">authoritative_node</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span> <span class="ow">in</span> <span class="n">request_url</span><span class="p">:</span>
                    <span class="n">find_host</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span>
                <span class="k">if</span> <span class="n">this_host</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request_url</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">authoritative_node</span><span class="p">:</span>
                            <span class="n">replace_host</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">find_host</span> <span class="o">!=</span> <span class="n">replace_host</span><span class="p">:</span>
                    <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">request_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">find_host</span><span class="p">,</span> <span class="n">replace_host</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_all_activity :: returning redirect to authoritative_node - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">all_activity_dict</span> <span class="o">=</span> <span class="n">get_panorama_all_activity</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_panorama_all_activity failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">end_get_all_activity</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">get_all_activity_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_get_all_activity</span> <span class="o">-</span> <span class="n">start_get_all_activity</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_activity_dict</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_all_activity_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_all_activity_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">all_activity_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20220517 - Feature #4578: webapp - api_get_fp_timeseries</span>
    <span class="k">if</span> <span class="s1">&#39;get_fp_timeseries&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">start_get_fp_timeseries</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">fp_timeseries_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fp_timeseries_dict</span> <span class="o">=</span> <span class="n">api_get_fp_timeseries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api_get_fp_timeseries failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">end_get_fp_timeseries</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">get_fp_timeseries_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_get_fp_timeseries</span> <span class="o">-</span> <span class="n">start_get_fp_timeseries</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_timeseries_dict</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_fp_timeseries_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_fp_timeseries_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">fp_timeseries_dict</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20220504 - Feature #4530: namespace.analysed_events</span>
    <span class="k">if</span> <span class="s1">&#39;get_analysed_events&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">start_get_analysed_events</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">analysed_events</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20220509 - Feature #4530: namespace.analysed_events</span>
            <span class="c1">#                      Release #4562 - v3.0.4</span>
            <span class="c1"># analysed_events = api_get_analysed_events(skyline_app, cluster_data=cluster_data)</span>
            <span class="n">analysed_events</span> <span class="o">=</span> <span class="n">api_get_analysed_events</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">cluster_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api_get_analysed_events failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">end_get_analysed_events</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">get_analysed_events_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_get_analysed_events</span> <span class="o">-</span> <span class="n">start_get_analysed_events</span><span class="p">)</span>
        <span class="c1"># @modified 20220509 - Feature #4530: namespace.analysed_events</span>
        <span class="c1">#                      Release #4562 - v3.0.4</span>
        <span class="c1"># Added handle 400</span>
        <span class="k">if</span> <span class="n">analysed_events</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysed_events</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_analysed_events_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;analysed_events&#39;</span><span class="p">:</span> <span class="n">analysed_events</span><span class="p">}</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_analysed_events_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 202200504 - Feature #4530: namespace.analysed_events</span>
    <span class="k">if</span> <span class="s1">&#39;get_metric_analysed_events&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">start_get_metric_analysed_events</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="n">analysed_events</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20220509 - Feature #4530: namespace.analysed_events</span>
            <span class="c1">#                      Release #4562 - v3.0.4</span>
            <span class="c1"># analysed_events = api_get_metric_analysed_events(skyline_app, cluster_data=cluster_data)</span>
            <span class="n">analysed_events</span> <span class="o">=</span> <span class="n">api_get_metric_analysed_events</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">cluster_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api_get_metric_analysed_events failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">end_get_metric_analysed_events</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">get_metric_analysed_events_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_get_metric_analysed_events</span> <span class="o">-</span> <span class="n">start_get_metric_analysed_events</span><span class="p">)</span>
        <span class="c1"># @modified 20220509 - Feature #4530: namespace.analysed_events</span>
        <span class="c1">#                      Release #4562 - v3.0.4</span>
        <span class="c1"># Added handle 400</span>
        <span class="k">if</span> <span class="n">analysed_events</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysed_events</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_metric_analysed_events_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;analysed_events&#39;</span><span class="p">:</span> <span class="n">analysed_events</span><span class="p">}</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_metric_analysed_events_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20220318 - Feature #4540: Plot matched timeseries</span>
    <span class="c1">#                   Feature #4014: Ionosphere - inference</span>
    <span class="k">if</span> <span class="s1">&#39;get_matched_timeseries&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">start_get_matched_timeseries</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">match_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">match_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;match_id&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_matched_timeseries with match_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">match_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api get_matched_timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">layers_match_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">layers_match_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;layers_match_id&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_matched_timeseries with layers_match_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">layers_match_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api get_matched_timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">strip_prefix</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plot_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_matched_timeseries with plot: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">plot_str</span><span class="p">)</span>
                <span class="n">strip_prefix</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;strip_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">strip_prefix</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">strip_prefix</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api get_matched_timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20220713 - Feature #4540: Plot matched timeseries</span>
        <span class="c1">#                   Feature #4014: Ionosphere - inference</span>
        <span class="c1"># Only for details_only parameter to be passed to strip out the time</span>
        <span class="c1"># series data</span>
        <span class="n">details_only</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">matched_timeseries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cache_data_fetched</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">details_only_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;details_only&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">details_only_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">details_only</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_matched_timeseries with details_only: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">details_only_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api get_matched_timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="k">if</span> <span class="n">details_only</span><span class="p">:</span>
            <span class="n">redis_key</span> <span class="o">=</span> <span class="s1">&#39;webapp.match_details.id.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_id</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">matched_timeseries_str</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">matched_timeseries_str</span><span class="p">:</span>
                    <span class="n">matched_timeseries</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">matched_timeseries_str</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_matched_timeseries with details_only cache data retrieved&#39;</span><span class="p">)</span>
                    <span class="n">cache_data_fetched</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_matched_timeseries with details_only no cache data retrieved running get_matched_timeseries&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api get_matched_timeseries :: failed to hget </span><span class="si">%s</span><span class="s1"> from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_timeseries</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">matched_timeseries</span> <span class="o">=</span> <span class="n">get_matched_timeseries</span><span class="p">(</span>
                    <span class="n">skyline_app</span><span class="p">,</span> <span class="n">match_id</span><span class="p">,</span> <span class="n">layers_match_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api get_matched_timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

            <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
                <span class="n">plotted_comparsion_image</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># @added 20220831 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="n">use_base_name</span> <span class="o">=</span> <span class="n">matched_timeseries</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">use_base_name</span> <span class="ow">and</span> <span class="s1">&#39;}&#39;</span> <span class="ow">in</span> <span class="n">use_base_name</span> <span class="ow">and</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">use_base_name</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_metric_id_from_base_name failed with base_name: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                    <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>

                <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.match_plot.png&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_timeseries</span><span class="p">[</span><span class="s1">&#39;match&#39;</span><span class="p">][</span><span class="s1">&#39;metric_timestamp&#39;</span><span class="p">]),</span>
                    <span class="c1"># matched_timeseries[&#39;metric&#39;])</span>
                    <span class="n">use_base_name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">plotted_comparsion_image</span><span class="p">,</span> <span class="n">plotted_match_comparison_image_file</span> <span class="o">=</span> <span class="n">plot_fp_match</span><span class="p">(</span>
                        <span class="c1"># skyline_app, matched_timeseries[&#39;metric&#39;],</span>
                        <span class="n">skyline_app</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">,</span>
                        <span class="n">matched_timeseries</span><span class="p">[</span><span class="s1">&#39;match&#39;</span><span class="p">][</span><span class="s1">&#39;fp_id&#39;</span><span class="p">],</span>
                        <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">matched_timeseries</span><span class="p">[</span><span class="s1">&#39;matched_fp_timeseries&#39;</span><span class="p">]],</span>
                        <span class="n">matched_timeseries</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">],</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">strip_prefix</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api plot_fp_match - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                <span class="k">if</span> <span class="n">plotted_comparsion_image</span><span class="p">:</span>
                    <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere_images?image=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">plotted_match_comparison_image_file</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;returning redirect to image url - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">details_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cache_data_fetched</span><span class="p">:</span>
            <span class="n">redis_key</span> <span class="o">=</span> <span class="s1">&#39;webapp.match_details.id.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_id</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">matched_timeseries_str</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">matched_timeseries_str</span><span class="p">:</span>
                    <span class="n">matched_timeseries</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">matched_timeseries_str</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?get_matched_timeseries with details_only cache data created from get_matched_timeseries retrieved&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: /api?get_matched_timeseries with details_only no cache data retrieved from get_matched_timeseries&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api get_matched_timeseries :: failed to hget </span><span class="si">%s</span><span class="s1"> from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="n">end_get_matched_timeseries</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">get_matched_timeseries_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_get_matched_timeseries</span> <span class="o">-</span> <span class="n">start_get_matched_timeseries</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_timeseries</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_matched_timeseries_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">matched_timeseries</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">get_matched_timeseries_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">matched_timeseries</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20220301 - Feature #4482: Test alerts</span>
    <span class="k">if</span> <span class="s1">&#39;test_alert&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">start_test_alert</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert with metric: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api test_alert request no metric argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">alerter_app</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">alerter_app</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert with app: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">alerter_app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api test_alert request no app argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">alerter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">alerter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alerter&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert with alerter: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">alerter</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api test_alert request no alerter argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">alerter_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">alerter_id_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alerter_id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alerter_id_str</span><span class="p">:</span>
                <span class="n">alerter_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">alerter_id_str</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert with alerter_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alerter_id</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api test_alert error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">test_alert_added</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">trigger_anomaly</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">trigger_anomaly_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trigger_anomaly&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trigger_anomaly_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">trigger_anomaly</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert with trigger_anomaly: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">trigger_anomaly_str</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api test_alert error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>

        <span class="c1"># @added 20220509 - Feature #4564: authoritative_node</span>
        <span class="c1">#                   Feature #4482: Test alerts</span>
        <span class="c1"># Ensure that the test alert is triggered on the correct cluster node</span>
        <span class="n">cluster_request</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
            <span class="n">authoritative_node</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">authoritative_node</span> <span class="o">=</span> <span class="n">get_authoritative_node</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api test_alert get_authoritative_node - reports - </span><span class="si">%s</span><span class="s1"> as the authoritative cluster node&#39;</span> <span class="o">%</span> <span class="n">authoritative_node</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api test_alert get_authoritative_node failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">authoritative_node</span> <span class="o">==</span> <span class="n">this_host</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api test_alert creating test alert from a cluster_call because this host is authoritative_node: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">authoritative_node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">authoritative_node</span> <span class="o">!=</span> <span class="n">this_host</span><span class="p">:</span>
                <span class="n">cluster_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">cluster_call</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cluster_call</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_call&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cluster_call</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api test_alert - requested test_alert but not authoritative_node so allowing </span><span class="si">%s</span><span class="s1"> to handle the request&#39;</span> <span class="o">%</span> <span class="n">authoritative_node</span><span class="p">)</span>
                        <span class="n">end_test_alert</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                        <span class="n">test_alert_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_test_alert</span> <span class="o">-</span> <span class="n">start_test_alert</span><span class="p">)</span>
                        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">test_alert_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;test alert added&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;cluster_node&quot;</span><span class="p">:</span> <span class="n">this_host</span><span class="p">,</span> <span class="s2">&quot;authoritative_node&quot;</span><span class="p">:</span> <span class="n">authoritative_node</span><span class="p">}}</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api test_alert - responding with: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api test_alert error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="k">if</span> <span class="n">cluster_request</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api test_alert - requesting test_alert from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">authoritative_node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
                <span class="n">test_alert_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">test_alert_uri</span> <span class="o">=</span> <span class="s1">&#39;test_alert&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;app=</span><span class="si">%s</span><span class="s1">&amp;alerter=</span><span class="si">%s</span><span class="s1">&amp;cluster_call=true&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="n">alerter_app</span><span class="p">,</span> <span class="n">alerter</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">alerter_id</span><span class="p">:</span>
                    <span class="n">test_alert_uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;alerter_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_alert_uri</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">alerter_id</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">trigger_anomaly</span><span class="p">:</span>
                    <span class="n">test_alert_uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;trigger_anomaly=true&#39;</span> <span class="o">%</span> <span class="n">test_alert_uri</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_alert_list</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">test_alert_uri</span><span class="p">,</span> <span class="s1">&#39;test alert added&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?test_alert get_cluster_data failed - could not get data from the remote Skyline instances - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">test_alert_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test alert added&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;app&#39;</span><span class="p">:</span> <span class="n">alerter_app</span><span class="p">,</span> <span class="s2">&quot;alerter&quot;</span><span class="p">:</span> <span class="n">alerter</span><span class="p">,</span> <span class="s2">&quot;trigger_anomaly&quot;</span><span class="p">:</span> <span class="n">trigger_anomaly</span><span class="p">,</span> <span class="s2">&quot;cluster_node&quot;</span><span class="p">:</span> <span class="n">this_host</span><span class="p">,</span> <span class="s2">&quot;authoritative_node&quot;</span><span class="p">:</span> <span class="n">authoritative_node</span><span class="p">}</span>
                    <span class="k">if</span> <span class="n">alerter_id</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alerter_id</span>
                    <span class="n">end_test_alert</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="n">test_alert_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_test_alert</span> <span class="o">-</span> <span class="n">start_test_alert</span><span class="p">)</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">test_alert_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api test_alert - got a True test_alert_added from a cluster node, responding with: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

        <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
        <span class="c1"># Allow for full testing with the injection of an anomaly on a</span>
        <span class="c1"># metric</span>
        <span class="k">if</span> <span class="n">trigger_anomaly</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alerter_app</span> <span class="o">!=</span> <span class="s1">&#39;mirage&#39;</span><span class="p">:</span>
                <span class="n">trigger_anomaly</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert trigger_anomaly set to False only available for Mirage&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trigger_anomaly</span><span class="p">:</span>
            <span class="n">key_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;alerter&#39;</span><span class="p">:</span> <span class="n">alerter</span><span class="p">,</span>
                <span class="s1">&#39;alerter_app&#39;</span><span class="p">:</span> <span class="n">alerter_app</span><span class="p">,</span> <span class="s1">&#39;alerter_id&#39;</span><span class="p">:</span> <span class="n">alerter_id</span><span class="p">,</span>
                <span class="s1">&#39;trigger_anomaly&#39;</span><span class="p">:</span> <span class="n">trigger_anomaly</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_alert_redis_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.test_alerts&#39;</span> <span class="o">%</span> <span class="n">alerter_app</span>
                <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">test_alert_redis_key</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_data</span><span class="p">))</span>
                <span class="n">test_alert_added</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to save test_alert dict to Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alert_test_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_alert_test.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">alerter_app</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alerter_id</span><span class="p">:</span>
                <span class="n">test_alert_data</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">alerter</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">alerter_id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_alert_data</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">alerter</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">write_data_to_file</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">alert_test_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">test_alert_data</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert - created test alert file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">alert_test_file</span><span class="p">)</span>
                <span class="n">test_alert_added</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to save test alert file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">alert_test_file</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test alert added&#39;</span><span class="p">:</span> <span class="n">test_alert_added</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;app&#39;</span><span class="p">:</span> <span class="n">alerter_app</span><span class="p">,</span> <span class="s2">&quot;alerter&quot;</span><span class="p">:</span> <span class="n">alerter</span><span class="p">,</span> <span class="s2">&quot;trigger_anomaly&quot;</span><span class="p">:</span> <span class="n">trigger_anomaly</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">alerter_id</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alerter_id</span>
        <span class="n">end_test_alert</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">test_alert_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_test_alert</span> <span class="o">-</span> <span class="n">start_test_alert</span><span class="p">)</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">test_alert_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api test_alert - responding with: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20220223 - Feature #4466: webapp - api - redis_data</span>
    <span class="k">if</span> <span class="s1">&#39;redis_data&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">allowed_redis_data_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;flux.namespace_metrics&#39;</span><span class="p">,</span>
            <span class="s1">&#39;flux.quota.namespace_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.analyzer.unique_base_names&#39;</span><span class="p">,</span>
            <span class="s1">&#39;metrics_manager.flux.aggregate_namespaces&#39;</span><span class="p">,</span>
            <span class="c1"># @added 20220302 - Feature #4400: flux - quota</span>
            <span class="s1">&#39;flux.quota.namespace_rejected_metrics&#39;</span><span class="p">,</span>
            <span class="c1"># @added 20220510 - Feature #4464: flux - quota - cluster_sync</span>
            <span class="c1">#                   Release #4562 - v3.0.4</span>
            <span class="c1"># Use single hash that contains all the flux.quota.namespace_metrics</span>
            <span class="s1">&#39;metrics_manager.flux.quota.namespace_metrics&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">start_redis_data</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?redis_data request failed to query key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">key_allowed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">allowed_redis_data_key</span> <span class="ow">in</span> <span class="n">allowed_redis_data_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">allowed_redis_data_key</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">key_allowed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_allowed</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?redis_data key not allowed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">key_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">]:</span>
                <span class="n">key_type</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?redis_data type not allowed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key_type</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?redis_data request failed to query type - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?redis_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;hash&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?redis_data - got list of length </span><span class="si">%s</span><span class="s1"> from Redis for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">key</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;hash&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?redis_data - got dict of length </span><span class="si">%s</span><span class="s1"> from Redis for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">key</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;key&#39;</span><span class="p">:</span>
                <span class="n">key_data</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">key_data</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?redis_data - got data from Redis for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?redis_data - failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">redis_data_lists</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># @modified 20220509 - Feature #3824: get_cluster_data</span>
            <span class="c1">#                      Release #4562 - v3.0.4</span>
            <span class="c1"># Added cluster_call</span>
            <span class="n">redis_data_uri</span> <span class="o">=</span> <span class="s1">&#39;redis_data&amp;type=</span><span class="si">%s</span><span class="s1">&amp;key=</span><span class="si">%s</span><span class="s1">&amp;cluster_call=true&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key_type</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">redis_data_lists</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">redis_data_uri</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?redis_data could not get redis_data from the remote Skyline instances - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">redis_data_lists</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?redis_data - got list of length </span><span class="si">%s</span><span class="s1"> from a remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">redis_data_lists</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">redis_data_lists</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">all_data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">redis_data_lists</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_data</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: /api?redis_data - got data from a remote Skyline instance for </span><span class="si">%s</span><span class="s1"> but not a list&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;hash&#39;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?redis_data - got list of dicts of length </span><span class="si">%s</span><span class="s1"> from a remote Skyline instance&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">redis_data_lists</span><span class="p">)))</span>
                        <span class="k">for</span> <span class="n">data_dict</span> <span class="ow">in</span> <span class="n">redis_data_lists</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">hash_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">hash_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">hash_key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;key&#39;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?redis_data - got data from a remote Skyline instances&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">redis_data_list</span> <span class="ow">in</span> <span class="n">redis_data_lists</span><span class="p">:</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">redis_data_list</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?redis_data failed to build data from remote data - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">redis_data_list</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: failed to get redis_data_lists from the remote Skyline instances&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;key&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="n">end_redis_data</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">redis_data_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_redis_data</span> <span class="o">-</span> <span class="n">start_redis_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?redis_data - took </span><span class="si">%.6f</span><span class="s1"> seconds - returning 404&#39;</span> <span class="o">%</span> <span class="n">redis_data_time</span><span class="p">)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">redis_data_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?redis_data - took </span><span class="si">%.6f</span><span class="s1"> seconds - returning data and 200&#39;</span> <span class="o">%</span> <span class="n">redis_data_time</span><span class="p">)</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">redis_data_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20220216 - Feature #4444: webapp - inactive_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;inactive_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?inactive_metrics&#39;</span><span class="p">)</span>
        <span class="n">inactive_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">start_inactive_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?inactive_metrics request falied to query namespace&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">namespace</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?inactive_metrics - namespace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?inactive_metrics - namespace parameter not passed&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inactive_metrics</span> <span class="o">=</span> <span class="n">get_inactive_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?inactive_metrics - get_inactive_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">inactive_metrics_lists</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">inactive_metrics_uri</span> <span class="o">=</span> <span class="s1">&#39;inactive_metrics&amp;cluster_call=true&#39;</span>
            <span class="k">if</span> <span class="n">namespace</span><span class="p">:</span>
                <span class="n">inactive_metrics_uri</span> <span class="o">=</span> <span class="s1">&#39;inactive_metrics?namespace=</span><span class="si">%s</span><span class="s1">&amp;cluster_call=true&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">inactive_metrics_lists</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">inactive_metrics_uri</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get inactive_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inactive_metrics_lists</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">inactive_metrics_dict</span> <span class="ow">in</span> <span class="n">inactive_metrics_lists</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got inactive_metrics_list of length </span><span class="si">%s</span><span class="s1"> from a remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inactive_metrics_dict</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">inactive_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">inactive_metrics</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">inactive_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: failed to get inactive_metrics_dicts from the remote Skyline instances&#39;</span><span class="p">)</span>
        <span class="n">end_inactive_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">inactive_metrics_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_inactive_metrics</span> <span class="o">-</span> <span class="n">start_inactive_metrics</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">inactive_metrics</span><span class="p">,</span> <span class="s2">&quot;metrics_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">inactive_metrics</span><span class="p">),</span> <span class="s2">&quot;metrics_properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;metric&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">}}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inactive_metrics</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">inactive_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">inactive_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20220128 - Feature #4376: webapp - update_external_settings</span>
    <span class="k">if</span> <span class="s1">&#39;external_settings&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?external_settings&#39;</span><span class="p">)</span>
        <span class="n">external_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">start_external_settings</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?external_settings request falied to query namespace&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">namespace</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?external_settings - namespace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?external_settings - namespace parameter not passed&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">external_settings</span> <span class="o">=</span> <span class="n">get_external_settings</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?external_settings - get_external_settings failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="n">end_external_settings</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">external_settings_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_external_settings</span> <span class="o">-</span> <span class="n">start_external_settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">external_settings</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">external_settings_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">external_settings</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">external_settings_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">external_settings</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20211006 - Feature #4264: luminosity - cross_correlation_relationships</span>
    <span class="k">if</span> <span class="s1">&#39;related_to_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?related_to_metrics&#39;</span><span class="p">)</span>
        <span class="n">related_to_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">start_related_to_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?related_to_metrics request with invalid metric&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric_id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?related_to_metrics request with metric_id argument&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">related_to_metrics_dict</span> <span class="o">=</span> <span class="n">get_related_to_metric_groups</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_related_to_metric_groups failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="n">end_related_to_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">related_to_metrics_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_related_to_metrics</span> <span class="o">-</span> <span class="n">start_related_to_metrics</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">related_to_metrics_dict</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">related_to_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">related_to_metrics_dict</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">related_to_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">related_to_metrics_dict</span><span class="p">}</span>
        <span class="c1"># The related_to_metrics dict is an ordered dict sorted by confidence</span>
        <span class="c1"># and avg_coefficient flask.jsonify does not preserve order so in this</span>
        <span class="c1"># case the response is created with json.dumps to maintain insertion</span>
        <span class="c1"># order in the dict.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">response_class</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">mimetype</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;JSONIFY_MIMETYPE&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="mi">200</span>

    <span class="c1"># @added 20211001 - Feature #4264: luminosity - cross_correlation_relationships</span>
    <span class="n">related_metrics_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;related_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">related_metrics_request</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?related_metrics&#39;</span><span class="p">)</span>
        <span class="n">start_related_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">related_metrics_request</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">full_details</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?related_metrics request with invalid metric&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric_id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?related_metrics request with metric_id argument&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span> <span class="ow">and</span> <span class="n">metric_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># metric = base_name_from_metric_id(skyline_app, metric_id)</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">get_base_name_from_metric_id</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: base_name_from_metric_id failed to determine metric from metric_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span> <span class="ow">and</span> <span class="n">metric</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_metric_id_from_base_name failed to determine metric_id from base_name: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?related_metrics request with invalid metric or metric_id argument&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
            <span class="n">end_related_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
            <span class="n">related_metrics_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_related_metrics</span> <span class="o">-</span> <span class="n">start_related_metrics</span><span class="p">)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">related_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;no metric found&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="k">if</span> <span class="s1">&#39;full_details&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">full_details_argument</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_details&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_details_argument</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">full_details</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api invalid full_details argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="n">related_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">related_metrics</span> <span class="o">=</span> <span class="n">get_related_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="n">full_details</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_related_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="n">end_related_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">related_metrics_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_related_metrics</span> <span class="o">-</span> <span class="n">start_related_metrics</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">related_metrics</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">related_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">related_metrics</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">related_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">related_metrics</span><span class="p">}</span>
        <span class="c1"># The related_metrics dict is an ordered dict sorted by avg_coefficient</span>
        <span class="c1"># flask.jsonify does not preserve order so in this case the response is</span>
        <span class="c1"># created with json.dumps to maintain insertion order in the dict.</span>
        <span class="c1"># return jsonify(data_dict), 200</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">response_class</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">mimetype</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;JSONIFY_MIMETYPE&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="mi">200</span>

    <span class="c1"># @added 20210619 - Feature #4148: analyzer.metrics_manager.resolutions</span>
    <span class="c1">#                   Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
    <span class="c1">#                   Feature #4144: webapp - stale_metrics API endpoint</span>
    <span class="c1">#                   Feature #4076: CUSTOM_STALE_PERIOD</span>
    <span class="c1">#                   Branch #1444: thunder</span>
    <span class="k">if</span> <span class="s1">&#39;metrics_resolutions&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_resolutions&#39;</span><span class="p">)</span>
        <span class="n">start_metrics_resolution</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?metrics_resolutions - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_resolutions - namespace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remove_prefix_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_prefix_str</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">remove_prefix</span> <span class="o">=</span> <span class="n">remove_prefix_str</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?metrics_resolutions - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_resolutions - remove_prefix: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">))</span>

        <span class="n">less_than</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">less_than_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;less_than&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">less_than_str</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">less_than</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">less_than_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">less_than</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?metrics_resolutions - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_resolutions - less_than: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">less_than</span><span class="p">))</span>
        <span class="n">greater_than</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">greater_than_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;greater_than&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">greater_than_str</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">greater_than</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">greater_than_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">greater_than</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?metrics_resolutions - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_resolutions - greater_than: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">greater_than</span><span class="p">))</span>
        <span class="n">count_by_resolution</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">count_by_resolution_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count_by_resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count_by_resolution_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">count_by_resolution</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">greater_than</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?metrics_resolutions - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_resolutions - count_by_resolution: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">count_by_resolution</span><span class="p">))</span>

        <span class="n">redis_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics_manager.resolutions&#39;</span>
        <span class="n">resolutions_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resolutions_dict</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_hash_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: /api?metrics_resolutions fail to query Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">redis_hash_key</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_resolutions_dicts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">redis_metric_data_uri</span> <span class="o">=</span> <span class="s1">&#39;metrics_resolutions&amp;cluster_call=true&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_resolutions_dicts</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">redis_metric_data_uri</span><span class="p">,</span> <span class="s1">&#39;resolutions&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get resolution from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_resolutions_dicts</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">remote_resolutions_dict</span> <span class="ow">in</span> <span class="n">remote_resolutions_dicts</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got remote_resolutions_dict of length </span><span class="si">%s</span><span class="s1"> from a remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_resolutions_dict</span><span class="p">)))</span>
                    <span class="n">new_resolutions_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">resolutions_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">remote_resolutions_dict</span><span class="p">}</span>
                    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
                    <span class="c1"># resolutions_dict = new_resolutions_dict.copy()</span>
                    <span class="n">resolutions_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_resolutions_dict</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">new_resolutions_dict</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: failed to get remote_resolutions_dicts from the remote Skyline instances&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> resolutions determined&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resolutions_dict</span><span class="p">))))</span>
        <span class="n">filtered_discarded</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">filtered_resolutions_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">resolutions_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">metric_data</span> <span class="o">=</span> <span class="n">resolutions_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
            <span class="n">use_metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">greater_than</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">greater_than</span><span class="p">:</span>
                    <span class="n">filtered_discarded</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">less_than</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">less_than</span><span class="p">:</span>
                    <span class="n">filtered_discarded</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">parent_namespace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">namespace</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">use_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">parent_namespace</span><span class="p">):</span>
                    <span class="n">filtered_discarded</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">remove_prefix</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">remove_prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                    <span class="n">remove_prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">)</span>
                <span class="n">use_metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">filtered_resolutions_dict</span><span class="p">[</span><span class="n">use_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
        <span class="n">resolutions_dict</span> <span class="o">=</span> <span class="n">filtered_resolutions_dict</span>
        <span class="k">if</span> <span class="n">remove_prefix</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed prefix </span><span class="si">%s</span><span class="s1"> from all metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;filtered out </span><span class="si">%s</span><span class="s1"> metrics from the response that did not match namespace </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">filtered_discarded</span><span class="p">),</span> <span class="n">namespace</span><span class="p">))</span>
        <span class="n">resolutions_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolutions_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count_by_resolution</span><span class="p">:</span>
            <span class="n">resolutions_count_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">resolutions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">metric_resolutions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">resolutions_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">resolutions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resolutions_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>
                <span class="n">metric_resolutions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric</span><span class="p">,</span> <span class="n">resolutions_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]])</span>
            <span class="n">unique_resolutions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">resolutions</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">resolution</span> <span class="ow">in</span> <span class="n">unique_resolutions</span><span class="p">:</span>
                <span class="n">int_resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
                <span class="n">resolutions_count_dict</span><span class="p">[</span><span class="n">int_resolution</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">metrics_matching_resolution</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">metric_resolutions</span> <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="n">resolution</span><span class="p">]</span>
                <span class="n">resolutions_count_dict</span><span class="p">[</span><span class="n">int_resolution</span><span class="p">][</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_matching_resolution</span>
                <span class="n">resolutions_count_dict</span><span class="p">[</span><span class="n">int_resolution</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_matching_resolution</span><span class="p">)</span>
            <span class="n">resolutions_dict</span> <span class="o">=</span> <span class="n">resolutions_count_dict</span>

        <span class="n">end_metrics_resolution</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">metrics_resolution_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_metrics_resolution</span> <span class="o">-</span> <span class="n">start_metrics_resolution</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resolutions_dict</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">metrics_resolution_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolutions&#39;</span><span class="p">:</span> <span class="n">resolutions_dict</span><span class="p">,</span> <span class="s1">&#39;resolution_results_count&#39;</span><span class="p">:</span> <span class="n">resolutions_count</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">metrics_resolution_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;resolutions&quot;</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;resolution_results_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

    <span class="c1"># @added 20210618 - Bug #4146: check_data_sparsity - incorrect on low fidelity and inconsistent metrics</span>
    <span class="c1">#                   Feature #4144: webapp - stale_metrics API endpoint</span>
    <span class="c1">#                   Feature #4076: CUSTOM_STALE_PERIOD</span>
    <span class="c1">#                   Branch #1444: thunder</span>
    <span class="k">if</span> <span class="s1">&#39;metrics_sparsity&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_sparsity&#39;</span><span class="p">)</span>
        <span class="n">start_metrics_sparsity</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?metrics_sparsity - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_sparsity - namespace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remove_prefix_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_prefix_str</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">remove_prefix</span> <span class="o">=</span> <span class="n">remove_prefix_str</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?metrics_sparsity - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_sparsity - remove_prefix: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">))</span>

        <span class="n">below</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">below_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;below&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">below_str</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">below</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">below_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">below</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?metrics_sparsity - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_sparsity - below: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">))</span>

        <span class="n">redis_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics_manager.hash_key.metrics_data_sparsity&#39;</span>
        <span class="n">sparsity_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sparsity_dict</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_hash_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: /api?metrics_sparsity fail to query Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">redis_hash_key</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_sparsity_dicts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">redis_metric_data_uri</span> <span class="o">=</span> <span class="s1">&#39;metrics_sparsity&amp;cluster_call=true&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_sparsity_dicts</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">redis_metric_data_uri</span><span class="p">,</span> <span class="s1">&#39;sparsity&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get timeseries from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_sparsity_dicts</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">remote_sparsity_dict</span> <span class="ow">in</span> <span class="n">remote_sparsity_dicts</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got remote_sparsity_dict of length </span><span class="si">%s</span><span class="s1"> from a remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_sparsity_dict</span><span class="p">)))</span>
                    <span class="n">new_sparsity_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">sparsity_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">remote_sparsity_dict</span><span class="p">}</span>
                    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
                    <span class="c1"># sparsity_dict = new_sparsity_dict.copy()</span>
                    <span class="n">sparsity_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_sparsity_dict</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">new_sparsity_dict</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: failed to get remote_sparsity_dicts from the remote Skyline instances&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> sparsity determined&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparsity_dict</span><span class="p">))))</span>
        <span class="n">filtered_discarded</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">filtered_sparsity_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sparsity_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">metric_data</span> <span class="o">=</span> <span class="n">sparsity_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
            <span class="n">use_metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">below</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">below</span><span class="p">:</span>
                    <span class="n">filtered_discarded</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">use_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">namespace</span><span class="p">):</span>
                    <span class="n">filtered_discarded</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">remove_prefix</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">remove_prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                    <span class="n">remove_prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">)</span>
                <span class="n">use_metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">filtered_sparsity_dict</span><span class="p">[</span><span class="n">use_metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
        <span class="n">sparsity_dict</span> <span class="o">=</span> <span class="n">filtered_sparsity_dict</span>
        <span class="k">if</span> <span class="n">remove_prefix</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed prefix </span><span class="si">%s</span><span class="s1"> from all metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;filtered out </span><span class="si">%s</span><span class="s1"> metrics from the response that did not match namespace </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">filtered_discarded</span><span class="p">),</span> <span class="n">namespace</span><span class="p">))</span>
        <span class="n">sparsity_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_dict</span><span class="p">)</span>

        <span class="n">end_metrics_sparsity</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">metrics_sparsity_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_metrics_sparsity</span> <span class="o">-</span> <span class="n">start_metrics_sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sparsity_dict</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">metrics_sparsity_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sparsity&#39;</span><span class="p">:</span> <span class="n">sparsity_dict</span><span class="p">,</span> <span class="s1">&#39;sparsity_results_count&#39;</span><span class="p">:</span> <span class="n">sparsity_count</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">metrics_sparsity_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;sparsity&quot;</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;sparsity_results_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

    <span class="c1"># @added 20210617 - Feature #4144: webapp - stale_metrics API endpoint</span>
    <span class="c1">#                   Feature #4076: CUSTOM_STALE_PERIOD</span>
    <span class="c1">#                   Branch #1444: thunder</span>
    <span class="k">if</span> <span class="s1">&#39;metrics_timestamp_resolutions&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_timestamp_resolutions&#39;</span><span class="p">)</span>
        <span class="n">start_metrics_timestamp_resolutions</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?metrics_timestamp_resolutions - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_timestamp_resolutions - namespace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remove_prefix_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_prefix_str</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">remove_prefix</span> <span class="o">=</span> <span class="n">remove_prefix_str</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?metrics_timestamp_resolutions - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metrics_timestamp_resolutions - remove_prefix: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">))</span>
        <span class="n">redis_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics_manager.hash_key.metrics_timestamp_resolutions&#39;</span>
        <span class="n">timestamp_resolutions_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp_resolutions_dict</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_hash_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: /api?metrics_timestamp_resolutions fail to query Redis hash key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">redis_hash_key</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_timestamp_resolutions_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">redis_metric_data_uri</span> <span class="o">=</span> <span class="s1">&#39;metrics_timestamp_resolutions&amp;cluster_call=true&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_timestamp_resolutions_dicts</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">redis_metric_data_uri</span><span class="p">,</span> <span class="s1">&#39;timestamp_resolutions&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get timeseries from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_timestamp_resolutions_dicts</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">remote_timestamp_resolutions_dict</span> <span class="ow">in</span> <span class="n">remote_timestamp_resolutions_dicts</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got remote_timestamp_resolutions_dict of length </span><span class="si">%s</span><span class="s1"> from a remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_timestamp_resolutions_dict</span><span class="p">)))</span>
                    <span class="n">new_timestamp_resolutions_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">timestamp_resolutions_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">remote_timestamp_resolutions_dict</span><span class="p">}</span>
                    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
                    <span class="c1"># timestamp_resolutions_dict = new_timestamp_resolutions_dict.copy()</span>
                    <span class="n">timestamp_resolutions_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_timestamp_resolutions_dict</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">new_timestamp_resolutions_dict</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: failed to get remote_timestamp_resolutions_dicts from the remote Skyline instances&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> timestamp_resolutions determined&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamp_resolutions_dict</span><span class="p">))))</span>
        <span class="n">filtered_discarded</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">filtered_timestamp_resolutions_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">timestamp_resolutions_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">metric_data</span> <span class="o">=</span> <span class="n">timestamp_resolutions_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
            <span class="n">use_metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">parent_namespace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">use_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">parent_namespace</span><span class="p">):</span>
                    <span class="n">filtered_discarded</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">remove_prefix</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">remove_prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                    <span class="n">remove_prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">)</span>
                <span class="n">use_metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">filtered_timestamp_resolutions_dict</span><span class="p">[</span><span class="n">use_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_data</span>
        <span class="n">timestamp_resolutions_dict</span> <span class="o">=</span> <span class="n">filtered_timestamp_resolutions_dict</span>
        <span class="k">if</span> <span class="n">remove_prefix</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed prefix </span><span class="si">%s</span><span class="s1"> from all metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;filtered out </span><span class="si">%s</span><span class="s1"> metrics from the response that did not match namespace </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">filtered_discarded</span><span class="p">),</span> <span class="n">namespace</span><span class="p">))</span>

        <span class="n">end_metrics_timestamp_resolutions</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">metrics_timestamp_resolutions_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_metrics_timestamp_resolutions</span> <span class="o">-</span> <span class="n">start_metrics_timestamp_resolutions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timestamp_resolutions_dict</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">metrics_timestamp_resolutions_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;timestamp_resolutions&#39;</span><span class="p">:</span> <span class="n">timestamp_resolutions_dict</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">metrics_timestamp_resolutions_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;timestamp_resolutions&quot;</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

    <span class="c1"># @added 20210617 - Feature #4144: webapp - stale_metrics API endpoint</span>
    <span class="c1">#                   Feature #4076: CUSTOM_STALE_PERIOD</span>
    <span class="c1">#                   Branch #1444: thunder</span>
    <span class="k">if</span> <span class="s1">&#39;determine_data_sparsity&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?determine_data_sparsity&#39;</span><span class="p">)</span>
        <span class="n">start_stale_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?determine_data_sparsity with metric: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api determine_data_sparsity request no metric argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_metric_timeseries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?determine_data_sparsity - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
                <span class="n">redis_metric_data_uri</span> <span class="o">=</span> <span class="s1">&#39;metric=</span><span class="si">%s</span><span class="s1">&amp;format=json&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">redis_metric_data_uri</span><span class="p">,</span> <span class="s1">&#39;timeseries&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get timeseries from the remote Skyline instances&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">timeseries</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got timeseries of length </span><span class="si">%s</span><span class="s1"> from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: failed to get timeseries from the remote Skyline instances&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;sparsity&quot;</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

        <span class="n">sparsity</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">timeseries</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sparsity</span> <span class="o">=</span> <span class="n">determine_data_sparsity</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?determine_data_sparsity - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sparsity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;sparsity&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">base_name</span><span class="p">:</span> <span class="n">sparsity</span><span class="p">}}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;sparsity&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">base_name</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span><span class="p">}}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

    <span class="c1"># @added 20210617 - Feature #4144: webapp - stale_metrics API endpoint</span>
    <span class="c1">#                   Feature #4076: CUSTOM_STALE_PERIOD</span>
    <span class="c1">#                   Branch #1444: thunder</span>
    <span class="k">if</span> <span class="s1">&#39;stale_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?stale_metrics&#39;</span><span class="p">)</span>
        <span class="n">start_stale_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?stale_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">exclude_sparsely_populated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exclude_sparsely_populated_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exclude_sparsely_populated&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exclude_sparsely_populated_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">exclude_sparsely_populated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">exclude_sparsely_populated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?stale_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="c1"># Add a key that functions.thunder.stale_metrics uses to determine if</span>
        <span class="c1"># webapp requests should include sparsely_populated_metrics or not</span>
        <span class="k">if</span> <span class="n">exclude_sparsely_populated</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;webapp.stale_metrics.exclude_sparsely_populated&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exclude_sparsely_populated</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?stale_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="n">namespaces_namespace_stale_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespaces_namespace_stale_metrics_dict</span> <span class="o">=</span> <span class="n">namespace_stale_metrics</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="n">exclude_sparsely_populated</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with api?stale_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> namespaces checked for stale metrics discovered with thunder_stale_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">))))</span>
        <span class="n">end_stale_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">stale_metrics_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_stale_metrics</span> <span class="o">-</span> <span class="n">start_stale_metrics</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">stale_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">namespaces_namespace_stale_metrics_dict</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">stale_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;stale_metrics&quot;</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

    <span class="c1"># @added 20210601 - Branch #1444: thunder</span>
    <span class="k">if</span> <span class="s1">&#39;thunder_stale_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?thunder_stale_metrics&#39;</span><span class="p">)</span>
        <span class="n">start_thunder_stale_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?thunder_stale_metrics request with no timestamp argument&#39;</span><span class="p">)</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;no timestamp passed&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="n">redis_key</span> <span class="o">=</span> <span class="s1">&#39;thunder.stale_metrics.alert.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">stale_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stale_metrics_raw</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stale_metrics_raw</span><span class="p">:</span>
                <span class="n">stale_metrics_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">stale_metrics_raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?thunder_stale_metrics fail to query Redis key </span><span class="si">%s</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">stale_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">end_thunder_stale_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">thunder_stale_metrics_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_thunder_stale_metrics</span> <span class="o">-</span> <span class="n">start_thunder_stale_metrics</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stale_metrics_dict</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">thunder_stale_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">stale_metrics_dict</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">thunder_stale_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

    <span class="c1"># @added 20210720 - Branch #1444: thunder</span>
    <span class="k">if</span> <span class="s1">&#39;thunder_no_data_remove_namespace&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?thunder_no_data_remove_namespace&#39;</span><span class="p">)</span>
        <span class="n">start_thunder_no_data_remove_namespace</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?thunder_no_data_remove_namespace request with no namespace argument&#39;</span><span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;no namespace passed&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

        <span class="c1"># @added 20220222 - Branch #1444: thunder</span>
        <span class="c1"># Add expiry to allow to pass a specific expiry time</span>
        <span class="n">expiry</span> <span class="o">=</span> <span class="mi">3600</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">expiry_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expiry&#39;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expiry_str</span><span class="p">:</span>
                <span class="n">expiry</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">expiry_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">expiry</span> <span class="o">=</span> <span class="mi">3600</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp error with api?metrics_timestamp_resolutions - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="n">redis_key</span> <span class="o">=</span> <span class="s1">&#39;webapp.thunder.remove.namespace.metrics.last_timeseries_timestamp&#39;</span>
        <span class="n">key_set</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20220222 - Branch #1444: thunder</span>
            <span class="c1"># Change to setex to set a specific expiry</span>
            <span class="c1"># REDIS_CONN.set(redis_key, str(namespace))</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_key</span><span class="p">,</span> <span class="n">expiry</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">))</span>
            <span class="n">key_set</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?thunder_no_data_remove_namespace fail to create Redis key </span><span class="si">%s</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">thunder_no_data_remove_namespace_uri</span> <span class="o">=</span> <span class="s1">&#39;thunder_no_data_remove_namespace&amp;namespace=</span><span class="si">%s</span><span class="s1">&amp;expiry=</span><span class="si">%s</span><span class="s1">&amp;cluster_call=true&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">expiry</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remove_namespace_from_no_data_check</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">thunder_no_data_remove_namespace_uri</span><span class="p">,</span> <span class="s1">&#39;remove_namespace_from_no_data_check&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get remove_namespace_from_no_data_check from the remote Skyline instances&#39;</span><span class="p">)</span>

        <span class="n">end_thunder_no_data_remove_namespace</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">thunder_no_data_remove_namespace_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_thunder_no_data_remove_namespace</span> <span class="o">-</span> <span class="n">start_thunder_no_data_remove_namespace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_set</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">thunder_no_data_remove_namespace_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="n">namespace</span><span class="p">,</span> <span class="s1">&#39;remove_namespace_from_no_data_check&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">thunder_no_data_remove_namespace_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="n">namespace</span><span class="p">,</span> <span class="s1">&#39;remove_namespace_from_no_data_check&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;failed to add key&#39;</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">500</span>

    <span class="c1"># @added 20220202 - Feature #4412: flux - quota - thunder alert</span>
    <span class="k">if</span> <span class="s1">&#39;thunder_metric_quota_exceeded&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?thunder_metric_quota_exceeded&#39;</span><span class="p">)</span>
        <span class="n">start_thunder_metric_quota_exceeded</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?thunder_metric_quota_exceeded request with no timestamp argument&#39;</span><span class="p">)</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;no timestamp passed&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="n">redis_key</span> <span class="o">=</span> <span class="s1">&#39;thunder.metric_quota_exceeded.alert.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">metric_quota_exceeded_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_quota_exceeded_raw</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric_quota_exceeded_raw</span><span class="p">:</span>
                <span class="n">metric_quota_exceeded_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">metric_quota_exceeded_raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?thunder_metric_quota_exceeded fail to query Redis key </span><span class="si">%s</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">metric_quota_exceeded_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">end_thunder_metric_quota_exceeded</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">thunder_metric_quota_exceeded_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_thunder_metric_quota_exceeded</span> <span class="o">-</span> <span class="n">start_thunder_metric_quota_exceeded</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metric_quota_exceeded_dict</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">thunder_metric_quota_exceeded_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">metric_quota_exceeded_dict</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">thunder_metric_quota_exceeded_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

    <span class="c1"># @added 20210720 - Feature #4188: metrics_manager.boundary_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;boundary_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?boundary_metrics&#39;</span><span class="p">)</span>
        <span class="n">start_boundary_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?boundary_metrics request evaluating metric parameter - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">namespaces</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespaces&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?boundary_metrics request evaluating namespaces parameter - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">namespaces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">namespaces_str</span> <span class="o">=</span> <span class="n">namespaces</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="n">namespaces_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?boundary_metrics - get_boundary_metrics with metrics: </span><span class="si">%s</span><span class="s1">, namespaces: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespaces</span><span class="p">)))</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="n">boundary_metrics</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">boundary_metrics</span> <span class="o">=</span> <span class="n">get_boundary_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?boundary_metrics get_boundary_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">end_boundary_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
            <span class="n">boundary_metrics_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_boundary_metrics</span> <span class="o">-</span> <span class="n">start_boundary_metrics</span><span class="p">)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">boundary_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">500</span>
        <span class="n">end_boundary_metrics</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">boundary_metrics_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_boundary_metrics</span> <span class="o">-</span> <span class="n">start_boundary_metrics</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">boundary_metrics</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">boundary_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;boundary_metrics&quot;</span><span class="p">:</span> <span class="n">boundary_metrics</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">boundary_metrics_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;boundary_metrics&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

    <span class="c1"># @added 20210211 - Feature - last_analyzed_timestamp</span>
    <span class="c1"># @added 20210211 - Feature #3968: webapp - last_analyzed_timestamp API endpoint</span>
    <span class="k">if</span> <span class="s1">&#39;last_analyzed_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?last_analyzed_timestamp&#39;</span><span class="p">)</span>
        <span class="n">start_last_analyzed_timestamp</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?last_analyzed_timestamp request with invalid metric argument&#39;</span><span class="p">)</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;no metric passed&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="n">redis_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.metrics.last_analyzed_timestamp&#39;</span>
        <span class="n">last_analyzed_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">last_analyzed_timestamp</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">redis_hash_key</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?last_analyzed_timestamp fail to query Redis hash key </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_hash_key</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">last_analyzed_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_analyzed_timestamp</span><span class="p">:</span>
            <span class="n">redis_hash_key</span> <span class="o">=</span> <span class="s1">&#39;analyzer.low_priority_metrics.last_analyzed_timestamp&#39;</span>
            <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
            <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
            <span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
            <span class="c1"># Roll back change - breaking existing metrics with colons</span>
            <span class="c1"># redis_metric_name = url_encode_metric_name(redis_metric_name)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">last_analyzed_timestamp</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">redis_hash_key</span><span class="p">,</span> <span class="n">redis_metric_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?last_analyzed_timestamp fail to query Redis hash key </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_hash_key</span><span class="p">,</span> <span class="n">redis_metric_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">last_analyzed_timestamp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20210714 - Feature #3884: ANALYZER_CHECK_LAST_TIMESTAMP</span>
        <span class="c1"># Alway return the last timestamp for the metric for the Redis metric</span>
        <span class="c1"># data if the ANALYZER_CHECK_LAST_TIMESTAMP feature is not enabled</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_analyzed_timestamp</span><span class="p">:</span>
            <span class="n">metric_timeseries</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_timeseries</span> <span class="o">=</span> <span class="n">get_metric_timeseries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?last_analyzed_timestamp get_metric_timeseries failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_metric_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">last_analyzed_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">metric_timeseries</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">last_analyzed_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?last_analyzed_timestamp failed to determine last timestamp for </span><span class="si">%s</span><span class="s1"> from metric_timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redis_metric_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">last_analyzed_timestamp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">last_analyzed_timestamp</span><span class="p">:</span>
            <span class="n">end_last_analyzed_timestamp</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
            <span class="n">last_analyzed_timestamp_time</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_last_analyzed_timestamp</span> <span class="o">-</span> <span class="n">start_last_analyzed_timestamp</span><span class="p">)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;remote_data&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">last_analyzed_timestamp_time</span><span class="p">),</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;last_analyzed_timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_analyzed_timestamp</span><span class="p">)}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="n">remote_last_analyzed_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">last_analyzed_timestamp_uri</span> <span class="o">=</span> <span class="s1">&#39;last_analyzed_timestamp&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;cluster_call=true&#39;</span> <span class="o">%</span> <span class="n">metric</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_last_analyzed_timestamps</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">last_analyzed_timestamp_uri</span><span class="p">,</span> <span class="s1">&#39;last_analyzed_timestamp&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?last_analyzed_timestamp fail to get last_analyzed_timestamp for </span><span class="si">%s</span><span class="s1"> from other cluster nodes - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">remote_last_analyzed_timestamps</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">remote_last_analyzed_timestamps</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="n">remote_last_analyzed_timestamp</span> <span class="o">=</span> <span class="n">item</span>
        <span class="n">end_last_analyzed_timestamp</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">last_analyzed_timestamp_time</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_last_analyzed_timestamp</span> <span class="o">-</span> <span class="n">start_last_analyzed_timestamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remote_last_analyzed_timestamp</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;remote_data&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">last_analyzed_timestamp_time</span><span class="p">),</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;last_analyzed_timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">remote_last_analyzed_timestamp</span><span class="p">)}}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;remote_data&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">last_analyzed_timestamp_time</span><span class="p">),</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no last analyzed timestamp found for the named metric, does not exist&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;last_analyzed_timestamp&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="n">status_code</span>

    <span class="c1"># @added 20201213 - Feature #3890: metrics_manager - sync_cluster_files</span>
    <span class="k">if</span> <span class="s1">&#39;expected_features_profiles_dir&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?expected_features_profiles_dir&#39;</span><span class="p">)</span>
        <span class="n">start_features_profiles_dir</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">features_profiles_dirs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">features_profiles_dirs</span> <span class="o">=</span> <span class="n">expected_features_profiles_dirs</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: expected_features_profiles_dirs failed returning 500&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">end_features_profiles_dir</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">features_profiles_dir_time</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_features_profiles_dir</span> <span class="o">-</span> <span class="n">start_features_profiles_dir</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;report </span><span class="si">%s</span><span class="s1"> expected features_profiles_dirs took, </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features_profiles_dirs</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">features_profiles_dir_time</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">features_profiles_dirs</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">features_profiles_dir_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;features_profile_dirs&quot;</span><span class="p">:</span> <span class="n">features_profiles_dirs</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">features_profiles_dir_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;features_profile_dirs&quot;</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

    <span class="c1"># @added 20201125 - Feature #3850: webapp - yhat_values API endoint</span>
    <span class="c1"># api?yhat_value=true&amp;metric=metric&amp;from=&lt;from&gt;&amp;until=&lt;until&gt;&amp;include_value=true&amp;include_mean=true&amp;include_yhat_real_lower=true</span>
    <span class="k">if</span> <span class="s1">&#39;yhat_values&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?yhat_values request&#39;</span><span class="p">)</span>
        <span class="c1"># @added 20201126 - Feature #3850: webapp - yhat_values API endoint</span>
        <span class="n">start_yhat</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?yhat_values request with invalid metric argument&#39;</span><span class="p">)</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;no metric passed&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?yhat_values request with invalid from argument&#39;</span><span class="p">)</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_timestamp</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid from argument passed&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;until&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?yhat_values request with invalid until argument&#39;</span><span class="p">)</span>
            <span class="n">until_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">until_timestamp</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid until argument passed&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="n">include_value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">include_value_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include_value&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_value_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">include_value</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">include_mean</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">include_mean_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_mean_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">include_mean</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">include_yhat_real_lower</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">include_yhat_real_lower_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include_yhat_real_lower&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_yhat_real_lower_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">include_yhat_real_lower</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># @modified 20210126 - Task #3958: Handle secondary algorithms in yhat_values</span>
        <span class="c1"># Added anomalous periods and remove prefix</span>
        <span class="n">include_anomalous_periods</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">include_anomalous_periods_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include_anomalous_periods&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_anomalous_periods_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">include_anomalous_periods</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remove_prefix_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_prefix_str</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">yhat_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># @added 20221025 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="n">redis_use_metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?yhat_values :: get_metric_id_from_base_name failed with base_name: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="n">redis_use_metric</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>

        <span class="c1"># @added 20201126 - Feature #3850: webapp - yhat_values API endoint</span>
        <span class="c1"># Cache request yhat_dict</span>
        <span class="n">yhat_dict_cache_key</span> <span class="o">=</span> <span class="s1">&#39;webapp.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="c1"># @modified 20221025 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                      Branch #4300: prometheus</span>
            <span class="c1"># metric, str(from_timestamp), str(until_timestamp),</span>
            <span class="n">redis_use_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">include_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">include_mean</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">include_yhat_real_lower</span><span class="p">))</span>

        <span class="n">yhat_dict_str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">yhat_dict_str</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">yhat_dict_cache_key</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">yhat_dict_cache_key</span><span class="p">)</span>
        <span class="n">use_cache_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">yhat_dict_str</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got yhat_values from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">yhat_dict_cache_key</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">yhat_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">yhat_dict_str</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp failed to literal_eval yhat_dict_str&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yhat_dict</span><span class="p">:</span>
            <span class="n">use_cache_data</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># @modified 20210126 - Task #3958: Handle secondary algorithms in yhat_values</span>
        <span class="c1"># Added anomalous_periods_dict</span>
        <span class="n">anomalous_periods_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">include_anomalous_periods</span><span class="p">:</span>
            <span class="n">anomalous_periods_dict_cache_key</span> <span class="o">=</span> <span class="s1">&#39;webapp.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.anomalous_periods&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">include_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">include_mean</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">include_yhat_real_lower</span><span class="p">))</span>
            <span class="n">anomalous_periods_dict_str</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomalous_periods_dict_str</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">anomalous_periods_dict_cache_key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">anomalous_periods_dict_cache_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">anomalous_periods_dict_str</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got anomalous_periods_dict from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">anomalous_periods_dict_cache_key</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">anomalous_periods_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">anomalous_periods_dict_str</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp failed to literal_eval anomalous_periods_dict_str&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">anomalous_periods_dict</span><span class="p">:</span>
                <span class="n">use_cache_data</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">yhat_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">yhat_dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;running get_yhat_values(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">include_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">include_mean</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">include_yhat_real_lower</span><span class="p">)))</span>
                <span class="c1"># @modified 20210126 - Task #3958: Handle secondary algorithms in yhat_values</span>
                <span class="c1"># Added anomalous_periods_dict and include_anomalous_periods</span>
                <span class="n">yhat_dict</span><span class="p">,</span> <span class="n">anomalous_periods_dict</span> <span class="o">=</span> <span class="n">get_yhat_values</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">include_value</span><span class="p">,</span> <span class="n">include_mean</span><span class="p">,</span> <span class="n">include_yhat_real_lower</span><span class="p">,</span> <span class="n">include_anomalous_periods</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: error in get_yhat_values(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">include_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">include_mean</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">include_yhat_real_lower</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: returning 500&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;yhat_values retrieved from Redis&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20201126 - Feature #3850: webapp - yhat_values API endoint</span>
        <span class="c1"># Added yhat_time</span>
        <span class="n">end_yhat</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">yhat_time</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_yhat</span> <span class="o">-</span> <span class="n">start_yhat</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;yhat_values calculations took </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">yhat_time</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">yhat_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: returning 500 yhat_dict is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">yhat_dict</span><span class="p">))</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">yhat_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20210126 - Task #3958: Handle secondary algorithms in yhat_values</span>
        <span class="c1"># Allow for the removal of a prefix from the metric name</span>
        <span class="k">if</span> <span class="n">remove_prefix</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">remove_prefix_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                    <span class="n">remove_prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">remove_prefix_str</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">remove_prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">remove_prefix_str</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove prefix </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix_str</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">yhat_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">include_anomalous_periods</span><span class="p">:</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">yhat_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;cached&quot;</span><span class="p">:</span> <span class="n">use_cache_data</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;yhat_values&quot;</span><span class="p">:</span> <span class="n">yhat_dict</span><span class="p">,</span> <span class="s2">&quot;anomalous_periods&quot;</span><span class="p">:</span> <span class="n">anomalous_periods_dict</span><span class="p">}}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">yhat_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;cached&quot;</span><span class="p">:</span> <span class="n">use_cache_data</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;yhat_values&quot;</span><span class="p">:</span> <span class="n">yhat_dict</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># @modified 20210112 - Feature #3850: webapp - yhat_values API endoint</span>
            <span class="c1"># Return a 204 with null rather than a 404</span>
            <span class="c1"># data_dict = {&quot;status&quot;: {&quot;request_time&quot;: yhat_time, &quot;response&quot;: 404}, &quot;data&quot;: {&quot;metric&quot;: metric, &quot;yhat_values&quot;: &#39;null&#39;}}</span>
            <span class="c1"># return jsonify(data_dict), 404</span>
            <span class="c1"># @modified 20210112 - Feature #3850: webapp - yhat_values API endoint</span>
            <span class="c1"># Return a 200 with null rather than 204 as 204 can have No content</span>
            <span class="c1"># data_dict = {&quot;status&quot;: {&quot;request_time&quot;: yhat_time, &quot;response&quot;: 204, &quot;cached&quot;: use_cache_data, &quot;no_data&quot;: &quot;true&quot;}, &quot;data&quot;: {&quot;metric&quot;: metric, &quot;yhat_values&quot;: &#39;null&#39;}}</span>
            <span class="c1"># return jsonify(data_dict), 204</span>
            <span class="k">if</span> <span class="n">include_anomalous_periods</span><span class="p">:</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">yhat_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;cached&quot;</span><span class="p">:</span> <span class="n">use_cache_data</span><span class="p">,</span> <span class="s2">&quot;no_data&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;yhat_values&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;anomalous_periods&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">yhat_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;cached&quot;</span><span class="p">:</span> <span class="n">use_cache_data</span><span class="p">,</span> <span class="s2">&quot;no_data&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;yhat_values&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20201103 - Feature #3770: webapp - analyzer_last_status API endoint</span>
    <span class="k">if</span> <span class="s1">&#39;analyzer_last_status&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?analyzer_last_status request&#39;</span><span class="p">)</span>
        <span class="n">analyzer_last_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">analyzer_last_status</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;analyzer&#39;</span><span class="p">))))</span>
        <span class="c1"># @added 20210511 - Feature #3770: webapp - analyzer_last_status API endoint</span>
        <span class="c1"># Handle a None result as a warning not an error</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: Webapp could not get the analyzer key from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the analyzer key from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?analyzer_last_status responding with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">analyzer_last_status</span><span class="p">))</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">analyzer_last_status</span><span class="p">}}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analyzer_last_status</span><span class="p">:</span>
            <span class="c1"># Return with status code 410 Gone</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?analyzer_last_status responding with status code 410 GONE&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">410</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20201007 - Feature #3770: webapp - batch_processing metrics API endoint</span>
    <span class="k">if</span> <span class="s1">&#39;batch_processing_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?batch_processing_metrics request&#39;</span><span class="p">)</span>
        <span class="n">batch_processing_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch_processing_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.batch_processing_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the aet.analyzer.batch_processing_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20201103 - Feature #3824: get_cluster_data</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_batch_processing_metrics</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_batch_processing_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;batch_processing_metrics&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get batch_processing_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_batch_processing_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote metrics from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_batch_processing_metrics</span><span class="p">)))</span>
                <span class="n">batch_processing_metrics_list</span> <span class="o">=</span> <span class="n">batch_processing_metrics</span> <span class="o">+</span> <span class="n">remote_batch_processing_metrics</span>
                <span class="n">batch_processing_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">batch_processing_metrics_list</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?batch_processing_metrics responding with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_processing_metrics</span><span class="p">)))</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">batch_processing_metrics</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200929 - Task #3748: POC SNAB</span>
    <span class="c1">#                   Branch #3068: SNAB</span>
    <span class="k">if</span> <span class="s1">&#39;snab&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?snab request&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SNAB_ENABLED</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?snab not handled and snab is not enabled&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">snab_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;snab_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">snab_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snab_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?snab request with snab_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_id</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?snab request with invalid snab_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;anomaly_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
                <span class="n">snab_id</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">snab_id</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?snab no valid snab_id parameter sent&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;anomaly_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomaly_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;anomaly_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?snab request with anomaly_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?snab request with invalid anomaly_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;anomaly_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
                <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">anomaly_id</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?snab no anomaly_id parameter sent&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?snab request with anomaly_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">)))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">snab_results</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tP&#39;</span><span class="p">,</span> <span class="s1">&#39;fP&#39;</span><span class="p">,</span> <span class="s1">&#39;tN&#39;</span><span class="p">,</span> <span class="s1">&#39;fN&#39;</span><span class="p">,</span> <span class="s1">&#39;unsure&#39;</span><span class="p">,</span> <span class="s1">&#39;NULL&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;result&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">snab_result</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">snab_result</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">snab_results</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?snab invalid result value sent - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">snab_result</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">snab_result</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?snab no result value was sent&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">snab_result_updated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">snab_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20201004 - Task #3748: POC SNAB</span>
            <span class="c1">#                      Branch #3068: SNAB</span>
            <span class="c1"># Allow results to be changed</span>
            <span class="c1"># snab_result_updated, base_name, anomaly_timestamp = update_snab_result(snab_id, anomaly_id, result)</span>
            <span class="n">snab_result_updated</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">anomaly_timestamp</span><span class="p">,</span> <span class="n">existing_result</span> <span class="o">=</span> <span class="n">update_snab_result</span><span class="p">(</span><span class="n">snab_id</span><span class="p">,</span> <span class="n">anomaly_id</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">snab_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;snab_id&#39;</span><span class="p">:</span> <span class="n">snab_id</span><span class="p">,</span>
                <span class="s1">&#39;anomaly_id&#39;</span><span class="p">:</span> <span class="n">anomaly_id</span><span class="p">,</span>
                <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">base_name</span><span class="p">,</span>
                <span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">:</span> <span class="n">anomaly_timestamp</span><span class="p">,</span>
                <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                <span class="s1">&#39;updated&#39;</span><span class="p">:</span> <span class="n">snab_result_updated</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with update_snab_result&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base_name</span> <span class="ow">and</span> <span class="n">anomaly_timestamp</span><span class="p">:</span>
            <span class="c1"># Using the snab_id instead of base_name, a bit of hack but works</span>
            <span class="n">slack_updated</span> <span class="o">=</span> <span class="n">webapp_update_slack_thread</span><span class="p">(</span><span class="n">snab_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">),</span> <span class="n">result</span><span class="p">,</span> <span class="s1">&#39;snab_result&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;slack_updated for snab evaluation - </span><span class="si">%s</span><span class="s1">, with result </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">slack_updated</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>

        <span class="c1"># @added 20201004 - Task #3748: POC SNAB</span>
        <span class="c1">#                   Branch #3068: SNAB</span>
        <span class="c1"># Allow results to be changed</span>
        <span class="k">if</span> <span class="n">existing_result</span><span class="p">:</span>
            <span class="n">slack_notified_of_change</span> <span class="o">=</span> <span class="n">webapp_update_slack_thread</span><span class="p">(</span><span class="n">snab_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">),</span> <span class="p">[</span><span class="n">existing_result</span><span class="p">,</span> <span class="n">result</span><span class="p">],</span> <span class="s1">&#39;snab_result_changed&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;slack_updated for snab evaluation - </span><span class="si">%s</span><span class="s1">, with result </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">slack_notified_of_change</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;snab_updated&quot;</span><span class="p">:</span> <span class="n">snab_dict</span><span class="p">}}</span>
        <span class="k">if</span> <span class="n">snab_result_updated</span> <span class="ow">and</span> <span class="n">snab_dict</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?snab request returning 200 with json data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?snab request returning 500 with json data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">500</span>

    <span class="c1"># @added 20200908 - Feature #3740: webapp - anomaly API endpoint</span>
    <span class="k">if</span> <span class="s1">&#39;anomaly&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?anomaly&#39;</span><span class="p">)</span>
        <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomaly_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?anomaly id parameter sent is not an int&#39;</span><span class="p">)</span>
                <span class="n">anomaly_id</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">anomaly_id</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?anomaly no id parameter sent&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?anomaly request with id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">)))</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">anomaly_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># anomaly_data = [int(anomaly_id), str(metric), anomalous_datapoint, anomaly_timestamp, full_duration, created_timestamp, anomaly_end_timestamp]</span>
            <span class="n">anomaly_data</span> <span class="o">=</span> <span class="n">panorama_anomaly_details</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with panorama_anomaly_details&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">anomaliesDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">matchesDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">anomaly_data</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">anomaly_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">requested_timestamp</span> <span class="o">=</span> <span class="n">anomaly_timestamp</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomaly_end_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">anomaly_end_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">related</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">related</span><span class="p">,</span> <span class="n">labelled_anomalies</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_related</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">anomaly_id</span><span class="p">,</span> <span class="n">anomaly_timestamp</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_related&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20220504 - Task #4544: Handle EXTERNAL_SETTINGS in correlate_or_relate_with</span>
            <span class="c1">#                   Feature #3858: skyline_functions - correlate_or_relate_with</span>
            <span class="n">external_settings</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_SETTINGS</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">external_settings</span> <span class="o">=</span> <span class="n">get_external_settings</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_external_settings failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">related_anomaly_id</span><span class="p">,</span> <span class="n">related_metric_id</span><span class="p">,</span> <span class="n">related_metric_name</span><span class="p">,</span> <span class="n">related_anomaly_timestamp</span><span class="p">,</span> <span class="n">related_full_duration</span> <span class="ow">in</span> <span class="n">related</span><span class="p">:</span>
                <span class="c1"># @added 20201202- Feature #3858: skyline_functions - correlate_or_relate_with</span>
                <span class="c1"># Filter only related anomalies that are in correlations group</span>
                <span class="c1"># @modified 20220504 - Task #4544: Handle EXTERNAL_SETTINGS in correlate_or_relate_with</span>
                <span class="c1">#                      Feature #3858: skyline_functions - correlate_or_relate_with</span>
                <span class="c1"># Added external_settings</span>
                <span class="n">correlate_or_relate</span> <span class="o">=</span> <span class="n">correlate_or_relate_with</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">related_metric_name</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">correlate_or_relate</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;metric_id&#39;</span><span class="p">:</span> <span class="n">related_metric_id</span><span class="p">,</span>
                    <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">related_metric_name</span><span class="p">,</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">related_anomaly_timestamp</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="n">anomaliesDict</span><span class="p">[</span><span class="n">related_anomaly_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_dict</span>
            <span class="n">related_matches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">related_metric</span> <span class="o">=</span> <span class="s1">&#39;get_related_matches&#39;</span>
            <span class="n">related_metric_like</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
            <span class="n">related_fp_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">related_layer_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">minus_two_minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">120</span>
            <span class="n">plus_two_minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">120</span>
            <span class="n">related_limited_by</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">related_ordered_by</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">related_matches</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_fp_matches</span><span class="p">(</span><span class="n">related_metric</span><span class="p">,</span> <span class="n">related_metric_like</span><span class="p">,</span> <span class="n">related_fp_id</span><span class="p">,</span> <span class="n">related_layer_id</span><span class="p">,</span> <span class="n">minus_two_minutes</span><span class="p">,</span> <span class="n">plus_two_minutes</span><span class="p">,</span> <span class="n">related_limited_by</span><span class="p">,</span> <span class="n">related_ordered_by</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_fp_matches for related_matches&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">related_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># @modified 20200908 - Feature #3740: webapp - anomaly API endpoint</span>
                <span class="c1"># Added match_anomaly_timestamp</span>
                <span class="c1"># @modified 20210413 - Feature #4014: Ionosphere - inference</span>
                <span class="c1">#                      Branch #3590: inference</span>
                <span class="c1"># Added related_motifs_matched_id</span>
                <span class="c1"># @modified 20221020 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                      Branch #4300: prometheus</span>
                <span class="c1"># Handle labelled_metric name added metric id</span>
                <span class="k">for</span> <span class="n">related_human_date</span><span class="p">,</span> <span class="n">related_match_id</span><span class="p">,</span> <span class="n">related_matched_by</span><span class="p">,</span> <span class="n">related_fp_id</span><span class="p">,</span> <span class="n">related_layer_id</span><span class="p">,</span> <span class="n">related_metric</span><span class="p">,</span> <span class="n">related_uri_to_matched_page</span><span class="p">,</span> <span class="n">related_validated</span><span class="p">,</span> <span class="n">match_anomaly_timestamp</span><span class="p">,</span> <span class="n">related_motifs_matched_id</span><span class="p">,</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="n">related_matches</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">related_matched_by</span> <span class="o">==</span> <span class="s1">&#39;no matches were found&#39;</span><span class="p">:</span>
                        <span class="n">related_matches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">related_matches</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> possible related matches found&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">related_matches</span><span class="p">))))</span>

                <span class="c1"># @added 20220504 - Task #4544: Handle EXTERNAL_SETTINGS in correlate_or_relate_with</span>
                <span class="c1">#                   Feature #3858: skyline_functions - correlate_or_relate_with</span>
                <span class="n">external_settings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_SETTINGS</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">external_settings</span> <span class="o">=</span> <span class="n">get_external_settings</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_external_settings failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @modified 20200908 - Feature #3740: webapp - anomaly API endpoint</span>
                <span class="c1"># Added match_anomaly_timestamp</span>
                <span class="c1"># @modified 20210413 - Feature #4014: Ionosphere - inference</span>
                <span class="c1">#                      Branch #3590: inference</span>
                <span class="c1"># Added related_motifs_matched_id</span>
                <span class="c1"># @modified 20221020 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                      Branch #4300: prometheus</span>
                <span class="c1"># Handle labelled_metric name added metric id</span>
                <span class="k">for</span> <span class="n">related_human_date</span><span class="p">,</span> <span class="n">related_match_id</span><span class="p">,</span> <span class="n">related_matched_by</span><span class="p">,</span> <span class="n">related_fp_id</span><span class="p">,</span> <span class="n">related_layer_id</span><span class="p">,</span> <span class="n">related_metric</span><span class="p">,</span> <span class="n">related_uri_to_matched_page</span><span class="p">,</span> <span class="n">related_validated</span><span class="p">,</span> <span class="n">match_anomaly_timestamp</span><span class="p">,</span> <span class="n">related_motifs_matched_id</span><span class="p">,</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="n">related_matches</span><span class="p">:</span>
                    <span class="c1"># @added 20201202- Feature #3858: skyline_functions - correlate_or_relate_with</span>
                    <span class="c1"># Filter only related matches that are in correlations group</span>
                    <span class="c1"># @modified 20220504 - Task #4544: Handle EXTERNAL_SETTINGS in correlate_or_relate_with</span>
                    <span class="c1">#                      Feature #3858: skyline_functions - correlate_or_relate_with</span>
                    <span class="c1"># Added external_settings</span>
                    <span class="n">correlate_or_relate</span> <span class="o">=</span> <span class="n">correlate_or_relate_with</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">related_metric</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">correlate_or_relate</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">related_metric</span><span class="p">,</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">match_anomaly_timestamp</span><span class="p">,</span>
                        <span class="s1">&#39;matched by&#39;</span><span class="p">:</span> <span class="n">related_matched_by</span><span class="p">,</span>
                        <span class="s1">&#39;fp id&#39;</span><span class="p">:</span> <span class="n">related_fp_id</span><span class="p">,</span>
                        <span class="s1">&#39;layer id&#39;</span><span class="p">:</span> <span class="n">related_layer_id</span><span class="p">,</span>
                        <span class="c1"># @modified 20210413 - Feature #4014: Ionosphere - inference</span>
                        <span class="c1">#                      Branch #3590: inference</span>
                        <span class="c1"># Added motifs_matched_id</span>
                        <span class="s1">&#39;motif id&#39;</span><span class="p">:</span> <span class="n">related_motifs_matched_id</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">matchesDict</span><span class="p">[</span><span class="n">related_match_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_dict</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">correlations</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_correlations</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">anomaly_id</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_correlations&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">correlationsDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># @added 20220504 - Task #4544: Handle EXTERNAL_SETTINGS in correlate_or_relate_with</span>
        <span class="c1">#                   Feature #3858: skyline_functions - correlate_or_relate_with</span>
        <span class="n">external_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_SETTINGS</span> <span class="ow">and</span> <span class="n">correlations</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">external_settings</span> <span class="o">=</span> <span class="n">get_external_settings</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_external_settings failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">correlation</span> <span class="ow">in</span> <span class="n">correlations</span><span class="p">:</span>
                <span class="n">correlated_metric</span> <span class="o">=</span> <span class="n">correlation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># @added 20201202- Feature #3858: skyline_functions - correlate_or_relate_with</span>
                <span class="c1"># Filter only correlations that are in correlations group</span>
                <span class="c1"># @modified 20220504 - Task #4544: Handle EXTERNAL_SETTINGS in correlate_or_relate_with</span>
                <span class="c1">#                      Feature #3858: skyline_functions - correlate_or_relate_with</span>
                <span class="c1"># Added external_settings</span>
                <span class="n">correlate_or_relate</span> <span class="o">=</span> <span class="n">correlate_or_relate_with</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">correlated_metric</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">correlate_or_relate</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">correlation</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s1">&#39;shifted&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">correlation</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="s1">&#39;shifted_coefficient&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">correlation</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="p">}</span>
                <span class="n">correlationsDict</span><span class="p">[</span><span class="n">correlated_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_dict</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_correlations&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @added 20210324 - Feature #3642: Anomaly type classification</span>
        <span class="n">anomaly_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomaly_types</span><span class="p">,</span> <span class="n">anomaly_type_ids</span> <span class="o">=</span> <span class="n">get_anomaly_type</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">anomaly_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_anomaly_type - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>

        <span class="n">anomaly_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># @modified 20201201 - Feature #3740: webapp - anomaly API endpoint</span>
            <span class="c1"># Due to the anomaly ids being used as json keys in the possible</span>
            <span class="c1"># related anomalies and matches the anomaly id is always typed as a</span>
            <span class="c1"># str</span>
            <span class="c1"># &#39;id&#39;: anomaly_id,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_id</span><span class="p">),</span>
            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">anomaly_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">anomaly_data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">anomaly_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s1">&#39;end_timestamp&#39;</span><span class="p">:</span> <span class="n">anomaly_end_timestamp</span><span class="p">,</span>
            <span class="s1">&#39;cross correlations&#39;</span><span class="p">:</span> <span class="n">correlationsDict</span><span class="p">,</span>
            <span class="c1"># @modified 20201201 - Feature #3740: webapp - anomaly API endpoint</span>
            <span class="c1"># Corrected the key names</span>
            <span class="c1"># &#39;possible related anomaly ids&#39;: anomaliesDict,</span>
            <span class="c1"># &#39;possible related match ids&#39;: matchesDict,</span>
            <span class="s1">&#39;possible related anomalies&#39;</span><span class="p">:</span> <span class="n">anomaliesDict</span><span class="p">,</span>
            <span class="s1">&#39;possible related matches&#39;</span><span class="p">:</span> <span class="n">matchesDict</span><span class="p">,</span>
            <span class="c1"># @added 20210324 - Feature #3642: Anomaly type classification</span>
            <span class="s1">&#39;anomaly_types&#39;</span><span class="p">:</span> <span class="n">anomaly_types</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;anomaly&quot;</span><span class="p">:</span> <span class="n">anomaly_dict</span><span class="p">}}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?anomaly request returning data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200611 - Feature #3578: Test alerts</span>
    <span class="k">if</span> <span class="s1">&#39;test_alert&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert request&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;skyline_app&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">test_skyline_app</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skyline_app&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_skyline_app</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?test_alert request no skyline_app parameter sent&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?test_alert request no metric parameter sent&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert request with skyline_app - </span><span class="si">%s</span><span class="s1"> and metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">test_skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
        <span class="n">test_alert_redis_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.test_alerts&#39;</span> <span class="o">%</span> <span class="n">test_skyline_app</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">test_alert_redis_key</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not add </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">test_skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">test_alert_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;skyline_app&#39;</span><span class="p">:</span> <span class="n">test_skyline_app</span><span class="p">,</span>
            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span>
        <span class="p">}</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;test_alert&quot;</span><span class="p">:</span> <span class="n">test_alert_dict</span><span class="p">}}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert request returning data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200517 - Feature #3538: webapp - upload_data endpoint</span>
    <span class="c1">#                   Feature #3550: flux.uploaded_data_worker</span>
    <span class="k">if</span> <span class="s1">&#39;upload_status&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?upload_status request&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_uploads_enabled</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span> <span class="mi">404</span>
        <span class="k">if</span> <span class="s1">&#39;upload_id_key&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">upload_id_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_id_key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">upload_id_key</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?upload_status request&#39;</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;no upload_id_key was passed&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?upload_status request for upload_id_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">upload_id_key</span><span class="p">)</span>
        <span class="n">upload_status_redis_key</span> <span class="o">=</span> <span class="s1">&#39;flux.upload_status.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">upload_id_key</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">upload_status</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">upload_status_redis_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">upload_status</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;not found&#39;</span><span class="p">:</span> <span class="s1">&#39;there is not status for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">upload_id_key</span><span class="p">)})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get the </span><span class="si">%s</span><span class="s1"> from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">upload_status_redis_key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?upload_status request&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">upload_status_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">upload_status</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">upload_status_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">upload_status</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not literal_eval the </span><span class="si">%s</span><span class="s1"> data from Redis&#39;</span> <span class="o">%</span> <span class="n">upload_status_redis_key</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="n">upload_status_dict</span><span class="p">}}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?upload_status request for upload_id_key - </span><span class="si">%s</span><span class="s1">, returning data&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">upload_id_key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200410 - Feature #3474: webapp api - training_data</span>
    <span class="c1">#                   Feature #3472: ionosphere.training_data Redis set</span>
    <span class="k">if</span> <span class="s1">&#39;training_data&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">metric_filter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timestamp_filter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metric_filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">timestamp_filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">training_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">training_data_raw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.training_data&#39;</span><span class="p">))</span>

        <span class="c1"># @added 20220822 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="k">if</span> <span class="n">metric_filter</span> <span class="ow">and</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">metric_filter</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_filter</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_metric_id_from_base_name failed with base_name: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_filter</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="n">metric_filter</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>

        <span class="c1"># @added 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
        <span class="c1"># Remove ionosphere.untrainable_metrics from the training data</span>
        <span class="c1"># when entries exist at the same resolution</span>
        <span class="n">ionosphere_untrainable_metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ionosphere_untrainable_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ionosphere_untrainable_metrics_redis_set</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.untrainable_metrics&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ionosphere_untrainable_metrics_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">ionosphere_untrainable_metrics_redis_set</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get the ionosphere.untrainable_metrics set from Redis&#39;</span><span class="p">)</span>
            <span class="n">ionosphere_untrainable_metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ionosphere_untrainable_metrics_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ionosphere_untrainable_metric_str</span> <span class="ow">in</span> <span class="n">ionosphere_untrainable_metrics_list</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ionosphere_untrainable_metric</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">ionosphere_untrainable_metric_str</span><span class="p">)</span>
                    <span class="n">ium_metric_name</span> <span class="o">=</span> <span class="n">ionosphere_untrainable_metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ium_resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ionosphere_untrainable_metric</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                    <span class="n">ionosphere_untrainable_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ium_metric_name</span><span class="p">,</span> <span class="n">ium_resolution</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to add to ionosphere_untrainable_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">training_data_str</span> <span class="ow">in</span> <span class="n">training_data_raw</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">training_data_item</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">training_data_str</span><span class="p">)</span>
                <span class="n">training_metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">training_data_item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">training_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">training_data_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># @added 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
                <span class="c1"># Added resolution_seconds</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">training_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">training_data_item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">training_resolution_seconds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">training_resolution_seconds</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALERTS</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">training_resolution_seconds</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">alert_match_pattern</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">metric_pattern</span> <span class="o">=</span> <span class="n">training_metric</span>
                        <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">alert_match_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">alert_match_pattern</span><span class="p">)</span>
                            <span class="n">pattern_match</span> <span class="o">=</span> <span class="n">alert_match_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">metric_pattern</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                                <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">training_metric</span><span class="p">:</span>
                                <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">training_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">training_resolution_seconds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">training_resolution_seconds</span><span class="p">:</span>
                    <span class="n">training_resolution_seconds</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span>

                <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">metric_filter</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric_filter</span> <span class="o">!=</span> <span class="n">training_metric</span><span class="p">:</span>
                        <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># @added 20200417 - Feature #3474: webapp api - training_data</span>
                    <span class="c1"># Allow to match namespaces too</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">add_to_response</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric_filter</span> <span class="ow">in</span> <span class="n">training_metric</span><span class="p">:</span>
                            <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">add_to_response</span><span class="p">:</span>
                        <span class="n">metric_filter_namespace_elements</span> <span class="o">=</span> <span class="n">metric_filter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="n">training_metric_namespace_elements</span> <span class="o">=</span> <span class="n">training_metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="n">elements_matched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metric_filter_namespace_elements</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">training_metric_namespace_elements</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements_matched</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_filter_namespace_elements</span><span class="p">):</span>
                            <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">timestamp_filter</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp_filter</span><span class="p">)</span> <span class="o">!=</span> <span class="n">training_timestamp</span><span class="p">:</span>
                        <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
                <span class="c1"># Remove ionosphere.untrainable_metrics from the training data</span>
                <span class="c1"># when entries exist at the same resolution</span>
                <span class="n">removed_as_untrainable</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">add_to_response</span> <span class="ow">and</span> <span class="n">ionosphere_untrainable_metrics</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ionosphere_untrainable_metric</span> <span class="ow">in</span> <span class="n">ionosphere_untrainable_metrics</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ium_metric_name</span> <span class="o">=</span> <span class="n">ionosphere_untrainable_metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">ium_metric_name</span> <span class="o">==</span> <span class="n">training_metric</span><span class="p">:</span>
                                <span class="n">ium_resolution</span> <span class="o">=</span> <span class="n">ionosphere_untrainable_metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">ium_resolution</span> <span class="o">==</span> <span class="n">training_resolution_seconds</span><span class="p">:</span>
                                    <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="c1"># logger.info(&#39;removed training data from response as identified as untrainable as has negative value/s - %s&#39; % str(ionosphere_untrainable_metric))</span>
                                    <span class="n">removed_as_untrainable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ium_metric_name</span><span class="p">)</span>
                                    <span class="k">break</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine if metric is in ionosphere.untrainable_metrics Redis set&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">removed_as_untrainable</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed </span><span class="si">%s</span><span class="s1"> training data sets from response as identified as untrainable&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">removed_as_untrainable</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">add_to_response</span><span class="p">:</span>
                    <span class="n">training_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">training_metric</span><span class="p">,</span> <span class="n">training_timestamp</span><span class="p">])</span>
                    <span class="c1"># @added 20220905 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="k">if</span> <span class="n">training_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">labelled_base_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">training_metric</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">labelled_base_name</span><span class="p">:</span>
                                <span class="n">training_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">labelled_base_name</span><span class="p">,</span> <span class="n">training_timestamp</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">training_metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: failed to iterate literal_eval of training_data_raw&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20201110 - Feature #3824: get_cluster_data</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_training_data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">training_data_uri</span> <span class="o">=</span> <span class="s1">&#39;training_data&#39;</span>
            <span class="k">if</span> <span class="n">metric_filter</span><span class="p">:</span>
                <span class="n">training_data_uri</span> <span class="o">=</span> <span class="s1">&#39;training_data&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;cluster_call=true&#39;</span> <span class="o">%</span> <span class="n">metric_filter</span>
            <span class="k">if</span> <span class="n">timestamp_filter</span><span class="p">:</span>
                <span class="n">training_data_uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;cluster_call=true&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">training_data_uri</span><span class="p">,</span> <span class="n">timestamp_filter</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_training_data</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">training_data_uri</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get remote_training_data from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_training_data</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote metrics training data instances from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_training_data</span><span class="p">)))</span>
                <span class="n">remote_training_data_list</span> <span class="o">=</span> <span class="n">training_data</span> <span class="o">+</span> <span class="n">remote_training_data</span>
                <span class="c1"># @modified 20201126 - Feature #3824: get_cluster_data</span>
                <span class="c1"># set cannot be used here as each training_data item includes a</span>
                <span class="c1"># list which is unhashable</span>
                <span class="c1"># training_data = list(set(remote_training_data_list))</span>
                <span class="n">training_data</span> <span class="o">=</span> <span class="n">remote_training_data_list</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">request_duration</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">request_duration</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">training_data</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200129 - Feature #3422: webapp api - alerting_metrics and non_alerting_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;non_alerting_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">non_alerting_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">non_alerting_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.non_smtp_alerter_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the aet.analyzer.smtp_alerter_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20201103 - Feature #3824: get_cluster_data</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_non_alerting_metrics</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_non_alerting_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;non_alerting_metrics&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get non_alerting_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_non_alerting_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote non_alerting_metrics from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_non_alerting_metrics</span><span class="p">)))</span>
                <span class="n">non_alerting_metrics_list</span> <span class="o">=</span> <span class="n">non_alerting_metrics</span> <span class="o">+</span> <span class="n">remote_non_alerting_metrics</span>
                <span class="n">non_alerting_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">non_alerting_metrics_list</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?non_alerting_metrics responding with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">non_alerting_metrics</span><span class="p">)))</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">non_alerting_metrics</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="k">if</span> <span class="s1">&#39;alerting_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">alerting_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">alerting_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.smtp_alerter_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the aet.analyzer.smtp_alerter_metrics list from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20201103 - Feature #3824: get_cluster_data</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_alerting_metrics</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_alerting_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;alerting_metrics&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get alerting_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_alerting_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote alerting_metrics from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_alerting_metrics</span><span class="p">)))</span>
                <span class="n">alerting_metrics_list</span> <span class="o">=</span> <span class="n">alerting_metrics</span> <span class="o">+</span> <span class="n">remote_alerting_metrics</span>
                <span class="n">alerting_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">alerting_metrics_list</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?non_alerting_metrics responding with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alerting_metrics</span><span class="p">)))</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">alerting_metrics</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200117 - Feature #3400: Identify air gaps in the metric data</span>
    <span class="k">if</span> <span class="s1">&#39;airgapped_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">airgapped_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">airgapped_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.airgapped_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the analyzer.airgapped_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;airgapped_metrics responding with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">airgapped_metrics</span><span class="p">)))</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">airgapped_metrics</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
    <span class="c1"># @added 20200205 - Feature #3400: Identify air gaps in the metric data</span>
    <span class="c1"># /api?airgap_filled&amp;metric=&lt;metric&gt;&amp;resoluion=&lt;resolution&gt;&amp;start=&lt;start-unix-timestamp&gt;&amp;end=&lt;end-unix-timestamp&gt;&amp;attempt&lt;attempts&gt;</span>
    <span class="k">if</span> <span class="s1">&#39;airgap_filled&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api?airgap_filled - request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no metric parameter was passed to /api?airgap_filled&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;resolution&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resolution</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no resolution parameter was passed to /api?airgap_filled&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;start&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no start parameter was passed to /api?airgap_filled&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;end&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no end parameter was passed to /api?airgap_filled&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;attempts&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">attempts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attempts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attempts</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no attempts parameter was passed to /api?airgap_filled&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="c1"># Check airgap is in the set</span>
        <span class="n">airgapped_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">airgapped_metrics</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.airgapped_metrics&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the analyzer.airgapped_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">airgap_present</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">airgap_str</span> <span class="ow">in</span> <span class="n">airgapped_metrics</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">airgap</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">airgap_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">airgap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">airgap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">airgap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">airgap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">attempts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">airgap</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="n">airgap_present</span> <span class="o">=</span> <span class="n">airgap</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to iterate literal_eval of airgapped_metrics&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">airgap_present</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api?airgap_filled responding with 404 no matching airgap found in analyzer.airgapped_metrics Redis set&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Not found&#39;</span><span class="p">,</span> <span class="mi">404</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removing airgapped metric item - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">airgap</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;analyzer.airgapped_metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">airgap</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not remove item from analyzer.airgapped_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: could not remove item from analyzer.airgapped_metrics Redis set&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">500</span>
        <span class="c1"># @added 20200501 - Feature #3400: Identify air gaps in the metric data</span>
        <span class="c1"># Handle airgaps filled so that once they have been submitted as filled</span>
        <span class="c1"># Analyzer will not identify them as airgapped again</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer.airgapped_metrics.filled&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">airgap</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not add item from analyzer.airgapped_metrics.filled Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;removed_airgap&quot;</span><span class="p">:</span> <span class="n">airgap</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20191231 - Feature #3368: webapp api - ionosphere_learn_work</span>
    <span class="k">if</span> <span class="s1">&#39;ionosphere_learn_work&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">ionosphere_learn_work</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ionosphere_learn_work</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.learn.work&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the ionosphere.learn.work list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20200109 - Feature #3380: Create echo features profile when a Mirage features profile is created</span>
        <span class="c1"># Add pending echo features profiles to the to response</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ionosphere_echo_work</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.echo.work&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the ionosphere.echo.work list from Redis&#39;</span><span class="p">)</span>
        <span class="n">echo_work_no_full_duration</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ionosphere_echo_work</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">ionosphere_echo_work</span><span class="p">:</span>
                <span class="n">work_list</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                <span class="n">work_no_fd</span> <span class="o">=</span> <span class="p">[</span><span class="n">work_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">work_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">work_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">work_list</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">work_list</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">work_list</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                <span class="n">echo_work_no_full_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work_no_fd</span><span class="p">)</span>
                <span class="c1"># @added 20201110 - Feature #3368: webapp api - ionosphere_learn_work</span>
                <span class="c1"># Just add as it is literal_evaled below or not</span>
                <span class="n">ionosphere_learn_work</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="c1"># if echo_work_no_full_duration:</span>
        <span class="c1">#     new_ionosphere_learn_work = ionosphere_learn_work + echo_work_no_full_duration</span>
        <span class="c1">#     ionosphere_learn_work = new_ionosphere_learn_work</span>

        <span class="c1"># @added 20201202 - Feature #3824: get_cluster_data</span>
        <span class="c1"># Added some debug logging</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: ionosphere_learn_work - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_learn_work</span><span class="p">))</span>

        <span class="c1"># @added 20201112 - Feature #3824: get_cluster_data</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_ionosphere_learn_work</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_ionosphere_learn_work</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;ionosphere_learn_work&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get ionosphere_learn_work from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_ionosphere_learn_work</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote ionosphere_learn_work from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_ionosphere_learn_work</span><span class="p">)))</span>
                <span class="n">ionosphere_learn_work_list</span> <span class="o">=</span> <span class="n">ionosphere_learn_work</span> <span class="o">+</span> <span class="n">remote_ionosphere_learn_work</span>
                <span class="c1"># @modified 20201202 - Feature #3824: get_cluster_data</span>
                <span class="c1"># Cannot use set on unhashable list and debug logging</span>
                <span class="c1"># ionosphere_learn_work = list(set(ionosphere_learn_work_list))</span>
                <span class="n">ionosphere_learn_work</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ionosphere_learn_work_list</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: remote_ionosphere_learn_work - ionosphere_learn_work - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_learn_work</span><span class="p">))</span>

        <span class="c1"># @added 20201104 - Feature #3368: webapp api - ionosphere_learn_work</span>
        <span class="c1"># Convert strings to json</span>
        <span class="n">convert_to_json</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;format&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">json_passed</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">json_passed</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                <span class="n">convert_to_json</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">convert_to_json</span><span class="p">:</span>
            <span class="c1"># @modified 20201208 - Feature #3368: webapp api - ionosphere_learn_work</span>
            <span class="c1"># Return an array of work</span>
            <span class="c1"># metrics_json = {}</span>
            <span class="n">work_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">str_item</span> <span class="ow">in</span> <span class="n">ionosphere_learn_work</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">str_item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">parent_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">generation</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">generation</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                    <span class="c1"># @modified 20201208 - Feature #3368: webapp api - ionosphere_learn_work</span>
                    <span class="c1"># Return an array of work</span>
                    <span class="c1"># metrics_json[item[3]] = {</span>
                    <span class="c1">#    &#39;deadline_type&#39;: item[0],</span>
                    <span class="c1">#    &#39;job_type&#39;: item[1],</span>
                    <span class="c1">#    &#39;timestamp&#39;: item[2],</span>
                    <span class="c1">#    &#39;parent_id&#39;: parent_id,</span>
                    <span class="c1">#    &#39;generation&#39;: generation</span>
                    <span class="n">work_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                        <span class="s1">&#39;deadline_type&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;job_type&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent_id</span><span class="p">,</span>
                        <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="n">generation</span>
                    <span class="p">}</span>
                    <span class="n">work_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work_dict</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not build the ionosphere_learn_work dict to jsonify - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">str_item</span><span class="p">))</span>
            <span class="c1"># @modified 20201208 - Feature #3368: webapp api - ionosphere_learn_work</span>
            <span class="c1"># Return an array of work</span>
            <span class="c1"># data_dict = {&quot;status&quot;: {&quot;cluster_data&quot;: cluster_data}, &quot;data&quot;: {&quot;metrics&quot;: metrics_json}}</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;work&quot;</span><span class="p">:</span> <span class="n">work_list</span><span class="p">}}</span>

            <span class="c1"># @added 20201202 - Feature #3824: get_cluster_data</span>
            <span class="c1"># Added some debug logging</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: data_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">ionosphere_learn_work</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20191203 - Feature #3350: webapp api - mirage_metrics and ionosphere_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;mirage_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mirage_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage.unique_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the mirage.unique_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20201112 - Feature #3824: get_cluster_data</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_mirage_metrics</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_mirage_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;mirage_metrics&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get mirage_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_mirage_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote mirage_metrics from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_mirage_metrics</span><span class="p">)))</span>
                <span class="n">mirage_metrics_list</span> <span class="o">=</span> <span class="n">mirage_metrics</span> <span class="o">+</span> <span class="n">remote_mirage_metrics</span>
                <span class="n">mirage_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mirage_metrics_list</span><span class="p">))</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">mirage_metrics</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20191203 - Feature #3350: webapp api - mirage_metrics and ionosphere_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;ionosphere_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ionosphere_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.unique_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the ionosphere.unique_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20201112 - Feature #3824: get_cluster_data</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_ionosphere_metrics</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remote_ionosphere_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;ionosphere_metrics&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get ionosphere_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_ionosphere_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote ionosphere_metrics from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_ionosphere_metrics</span><span class="p">)))</span>
                <span class="n">ionosphere_metrics_list</span> <span class="o">=</span> <span class="n">ionosphere_metrics</span> <span class="o">+</span> <span class="n">remote_ionosphere_metrics</span>
                <span class="n">ionosphere_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ionosphere_metrics_list</span><span class="p">))</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">},</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">ionosphere_metrics</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20191126 - Feature #3336: webapp api - derivative_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;derivative_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20211012 - Feature #4280: aet.metrics_manager.derivative_metrics Redis hash</span>
            <span class="c1"># derivative_metrics = list(REDIS_CONN.smembers(&#39;derivative_metrics&#39;))</span>
            <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the derivative_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20230519 - Feature #3336: webapp api - derivative_metrics</span>
        <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="c1"># To handle labelled_metrics, allow for the request to pass a metric</span>
        <span class="c1"># to determine if it is a derivative_metric or not</span>
        <span class="n">parameters_str_to_add</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">matched_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labelled_metric_request</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">include_labelled_metrics</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;include_labelled_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">include_labelled_metrics</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include_labelled_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_labelled_metrics</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">include_labelled_metrics</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">parameters_str_to_add</span> <span class="o">=</span> <span class="s1">&#39;&amp;include_labelled_metrics=true&#39;</span>
        <span class="n">derivative_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">include_labelled_metrics</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">derivative_labelled_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_labelled_metrics&#39;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the aet.metrics_manager.derivative_labelled_metrics set from Redis&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="k">if</span> <span class="n">derivative_labelled_metrics</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding </span><span class="si">%s</span><span class="s1"> derivative_labelled_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">derivative_labelled_metrics</span><span class="p">)))</span>
            <span class="n">derivative_metrics_list</span> <span class="o">=</span> <span class="n">derivative_metrics</span> <span class="o">+</span> <span class="n">derivative_labelled_metrics</span>
            <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">derivative_metrics_list</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;graph&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span> <span class="ow">and</span> <span class="s1">&#39;_tenant_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span><span class="p">:</span>
                <span class="n">labelled_metric_request</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;no_metric_passed&#39;</span><span class="p">)</span>
            <span class="n">parameters_str_to_add</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parameters_str_to_add</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>

        <span class="c1"># @added 20201112 - Feature #3824: get_cluster_data</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_derivative_metrics</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20230519 - Feature #3336: webapp api - derivative_metrics</span>
            <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="c1"># To handle labelled_metrics, allow for the request to pass a metric</span>
            <span class="c1"># to determine if it is a derivative_metric or not</span>
            <span class="n">get_cluster_data_str</span> <span class="o">=</span> <span class="s1">&#39;derivative_metrics&amp;cluster_call=true&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters_str_to_add</span><span class="p">):</span>
                <span class="n">get_cluster_data_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">get_cluster_data_str</span><span class="p">,</span> <span class="n">parameters_str_to_add</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20211012 - Feature #4280: aet.metrics_manager.derivative_metrics Redis hash</span>
                <span class="c1"># remote_derivative_metrics = get_cluster_data(&#39;derivative_metrics&#39;, &#39;metrics&#39;)</span>
                <span class="c1"># @modified 20230519 - Feature #3336: webapp api - derivative_metrics</span>
                <span class="c1">#                      Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                      Branch #4300: prometheus</span>
                <span class="c1"># To handle labelled_metrics, allow for the request to pass a metric</span>
                <span class="c1"># to determine if it is a derivative_metric or not</span>
                <span class="c1"># remote_derivative_metrics = get_cluster_data(&#39;derivative_metrics&amp;cluster_call=true&#39;, &#39;metrics&#39;)</span>
                <span class="n">remote_derivative_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">get_cluster_data_str</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get derivative_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_derivative_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote derivative_metrics from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_derivative_metrics</span><span class="p">)))</span>
                <span class="n">derivative_metrics_list</span> <span class="o">=</span> <span class="n">derivative_metrics</span> <span class="o">+</span> <span class="n">remote_derivative_metrics</span>
                <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">derivative_metrics_list</span><span class="p">))</span>

        <span class="c1"># @added 20230519 - Feature #3336: webapp api - derivative_metrics</span>
        <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="c1"># To handle labelled_metrics, allow for the request to pass a metric</span>
        <span class="c1"># to determine if it is a derivative_metric or not</span>
        <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
            <span class="n">matched_derivative_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">derivative_metrics</span> <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">matched_derivative_metrics</span><span class="p">:</span>
                <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">matched_derivative_metrics</span><span class="p">))</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">},</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">derivative_metrics</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># @added 20230519 - Feature #3336: webapp api - derivative_metrics</span>
        <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="c1"># To handle labelled_metrics, allow for the request to pass a metric</span>
        <span class="c1"># to determine if it is a derivative_metric or not</span>
        <span class="k">if</span> <span class="n">matched_derivative_metrics</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;derivative_metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20191008 - Feature #3252: webapp api - unique_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;unique_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>

        <span class="c1"># @added 20220823 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="c1"># Return cached response if present</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: request.args: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;webapp.api.unique_metrics&#39;</span>
        <span class="n">cache_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">details</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">strip_labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># @added 20230329 - Feature #3252: webapp api - unique_metrics</span>
        <span class="c1"># Add parameter to include inactive_metrics and set filter_namespace_str</span>
        <span class="c1"># to a default of None</span>
        <span class="n">include_inactive_metrics</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">filter_namespace_str</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;details&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">details</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;strip_labels&#39;</span><span class="p">:</span>
                <span class="n">strip_labels</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="c1"># @added 20230329 - Feature #3252: webapp api - unique_metrics</span>
            <span class="c1"># Add parameter to include inactive_metrics</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;include_inactive_metrics&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">include_inactive_metrics</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?unique_metrics include_inactive_metrics passed&#39;</span><span class="p">)</span>

        <span class="n">cache_data_str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cache_ttl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cache_data_str</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cache_data_str</span><span class="p">:</span>
                <span class="n">cache_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">cache_data_str</span><span class="p">)</span>
                <span class="n">cache_ttl</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">ttl</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to interpolate </span><span class="si">%s</span><span class="s1"> from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cache_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">include_inactive_metrics</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="n">cache_data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">][</span><span class="s1">&#39;request_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration</span>
            <span class="n">cache_data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">][</span><span class="s1">&#39;cache_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cache_data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">][</span><span class="s1">&#39;cache_ttl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache_ttl</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api/unique_metrics returning cache_data from </span><span class="si">%s</span><span class="s1"> with TTL: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_ttl</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">cache_data</span><span class="p">),</span> <span class="mi">200</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20220822 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">active_labelled_metrics_with_id</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.active_labelled_metrics_with_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">active_labelled_metrics_with_id</span><span class="p">:</span>
                <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the aet.metrics_manager.active_labelled_metrics_with_id from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="k">if</span> <span class="n">unique_labelled_metrics</span><span class="p">:</span>
            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="n">unique_metrics</span> <span class="o">+</span> <span class="n">unique_labelled_metrics</span>

        <span class="c1"># @added 20220509 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Release #4562 - v3.0.4</span>
        <span class="c1"># Force cluster_data on appropriate methods</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api forcing cluster_data=true&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_call</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api cluster_call forcing cluster_data=false&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20230131 - Feature #4838: functions.metrics.get_namespace_metric.count</span>
        <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="c1"># Added the filter_namespace and remove_full_namespace_prefix parameters</span>
        <span class="c1"># to the cluster request to reduce payload size and distribute filter work</span>
        <span class="c1"># because on a cluster with 15420 metrics returning filtered namespaces,</span>
        <span class="c1"># labels, values and elements added for labelled_metrics with details=true</span>
        <span class="c1"># results in a request_time of ~19.590527296066284 seconds.  On the</span>
        <span class="c1"># cluster this has a high time complexity, because the cluster_data=true</span>
        <span class="c1"># is calling it on all the cluster nodes and all the cluster nodes are</span>
        <span class="c1"># creating the labels, values, namespaces and namespace_elements for</span>
        <span class="c1"># all the metrics without filtering.</span>
        <span class="n">cluster_request_uri</span> <span class="o">=</span> <span class="s1">&#39;unique_metrics&amp;cluster_call=true&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;filter_namespace&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">filtered_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">filter_namespace_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filter_namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?unique_metrics filter_namespace passed filtering: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filter_namespace_str</span><span class="p">)</span>
            <span class="n">cluster_request_uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;filter_namespace=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cluster_request_uri</span><span class="p">,</span> <span class="n">filter_namespace_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;remove_full_namespace_prefix&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">remove_full_namespace_prefix_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_full_namespace_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_full_namespace_prefix_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">cluster_request_uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;remove_full_namespace_prefix=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cluster_request_uri</span><span class="p">,</span> <span class="n">remove_full_namespace_prefix_str</span><span class="p">)</span>

        <span class="c1"># @added 20230329 - Feature #3252: webapp api - unique_metrics</span>
        <span class="c1"># Add parameter to include inactive_metrics</span>
        <span class="k">if</span> <span class="n">include_inactive_metrics</span><span class="p">:</span>
            <span class="n">inactive_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">filter_namespace_str</span><span class="p">:</span>
                <span class="n">filter_on_namespace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\\</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">filter_namespace_str</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">inactive_metrics</span> <span class="o">=</span> <span class="n">get_inactive_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">filter_on_namespace</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api/unique_metrics  - get_inactive_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?unique_metrics </span><span class="si">%s</span><span class="s1"> inactive_metrics found&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inactive_metrics</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">inactive_metrics</span><span class="p">:</span>
                <span class="n">inactive_metric_names</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">inactive_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">:</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
                    <span class="n">inactive_metric_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_metrics</span> <span class="o">+</span> <span class="n">inactive_metric_names</span><span class="p">))</span>
            <span class="n">inactive_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">filter_namespace_str</span><span class="p">:</span>
                <span class="n">filter_on_namespace</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">filter_namespace_str</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">inactive_labelled_metrics_keys</span> <span class="o">=</span> <span class="n">get_inactive_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">filter_on_namespace</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api/unique_metrics  - get_inactive_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?unique_metrics </span><span class="si">%s</span><span class="s1"> inactive_labelled_metrics found&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inactive_labelled_metrics</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">inactive_labelled_metrics</span><span class="p">:</span>
                <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_metrics</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">inactive_labelled_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="c1"># @added 20201112 - Feature #3824: get_cluster_data</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
            <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
                    <span class="c1"># @modified 20230131 - Feature #4838: functions.metrics.get_namespace_metric.count</span>
                    <span class="c1">#                      Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                      Branch #4300: prometheus</span>
                    <span class="c1"># Due to size and time complexity being shaped on the cluster</span>
                    <span class="c1"># with this call, added the filter_namespace and</span>
                    <span class="c1"># remove_full_namespace_prefix parameters to the cluster</span>
                    <span class="c1"># request to reduce payload size and distribute filter work</span>
                    <span class="c1"># remote_unique_metrics = get_cluster_data(&#39;unique_metrics&amp;details=true&amp;cluster_call=true&#39;, &#39;metrics&#39;)</span>
                    <span class="n">cluster_request_uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;details=true&#39;</span> <span class="o">%</span> <span class="n">cluster_request_uri</span>
                    <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">cluster_request_uri</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># remote_unique_metrics = get_cluster_data(&#39;unique_metrics&amp;cluster_call=true&#39;, &#39;metrics&#39;)</span>
                    <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">cluster_request_uri</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get unique_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_unique_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote unique_metrics from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_unique_metrics</span><span class="p">)))</span>
                <span class="n">unique_metrics_list</span> <span class="o">=</span> <span class="n">unique_metrics</span> <span class="o">+</span> <span class="n">remote_unique_metrics</span>
                <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_metrics_list</span><span class="p">))</span>

        <span class="c1"># @added 20210416 - Feature #3252: webapp api - unique_metrics</span>
        <span class="c1"># Allow to filter by namespace and remove_full_namespace_prefix</span>
        <span class="n">total_unique_metrics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_metrics</span><span class="p">)</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">filter_namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># if &#39;filter_namespace&#39; in request.args:</span>
        <span class="k">if</span> <span class="n">filter_namespace_str</span><span class="p">:</span>
            <span class="n">filtered_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># filter_namespace_str = request.args.get(&#39;filter_namespace&#39;, &#39;&#39;)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?unique_metrics filter_namespace passed filtering: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filter_namespace_str</span><span class="p">)</span>
            <span class="n">filter_namespace</span> <span class="o">=</span> <span class="p">[</span><span class="n">filter_namespace_str</span><span class="p">]</span>

            <span class="c1"># @added 20220822 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">filter_namespace_str</span><span class="p">:</span>
                <span class="n">filter_namespace</span> <span class="o">=</span> <span class="n">filter_namespace_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20230329 - Feature #3252: webapp api - unique_metrics</span>
            <span class="c1"># Handle dotted and labelled metrics</span>
            <span class="n">filtered_namespaces</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filter_namespace</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">:</span>
                    <span class="n">dotted</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="se">\\</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dotted</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\\</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">f</span>
                <span class="n">filtered_namespaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>

                <span class="c1"># @added 20230531 - Feature #3252: webapp api - unique_metrics</span>
                <span class="c1"># Handle single dotted if the request requests the remove_full_namespace_prefix</span>
                <span class="n">single_dotted</span> <span class="o">=</span> <span class="s1">&#39;^</span><span class="si">%s</span><span class="se">\\</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">f</span>
                <span class="k">if</span> <span class="n">single_dotted</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_namespaces</span><span class="p">:</span>
                    <span class="n">filtered_namespaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_dotted</span><span class="p">)</span>

                <span class="n">labelled</span> <span class="o">=</span> <span class="s1">&#39;=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">f</span>
                <span class="n">filtered_namespaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelled</span><span class="p">)</span>
            <span class="n">filter_namespace</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filtered_namespaces</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?unique_metrics determined filter_namespace: </span><span class="si">%s</span><span class="s1">, filtering </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">filter_namespace</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_unique_metrics</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                <span class="n">pattern_match</span><span class="p">,</span> <span class="n">matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">filter_namespace</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                    <span class="n">filtered_unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?unique_metrics filtered_namespace found </span><span class="si">%s</span><span class="s1"> metrics from the </span><span class="si">%s</span><span class="s1"> unique_metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_unique_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_unique_metrics</span><span class="p">)))</span>
            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="n">filtered_unique_metrics</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">remove_full_namespace_prefix</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;remove_full_namespace_prefix&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">filtered_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">remove_full_namespace_prefix_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_full_namespace_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_full_namespace_prefix_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">remove_full_namespace_prefix</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?unique_metrics remove_full_namespace_prefix passed stripping: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_full_namespace_prefix</span><span class="p">:</span>
                <span class="n">basename_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span>
                    <span class="n">basename_unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?unique_metrics stripped: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">)</span>
            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="n">basename_unique_metrics</span>

        <span class="c1"># @added 20220823 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="c1"># Return namespaces, labels, values and elements with the response</span>
        <span class="c1"># request_time pre returning namespaces, labels, values and elements - 0.2227020263671875</span>
        <span class="c1"># request_time post returning namespaces, labels, values and elements - 0.33968615531921387</span>
        <span class="c1"># request_time with cache_key - 0.03976845741271973</span>
        <span class="c1"># @added 20230131 - Feature #4838: functions.metrics.get_namespace_metric.count</span>
        <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="c1"># Just added this comment for #4838 a cluster with 15420 metrics returning</span>
        <span class="c1"># filtered namespaces, labels, values and elements - request_time</span>
        <span class="c1"># 19.590527296066284 seconds.  On the cluster this has a high time</span>
        <span class="c1"># complexity, because the cluster_data=true is calling it on all the</span>
        <span class="c1"># cluster nodes.</span>
        <span class="n">namespaces_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">labels_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">values_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">metrics_and_labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;_tenant_id&#39;</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                    <span class="n">metric_labels</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_elements</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">namespace</span> <span class="o">=</span> <span class="n">metric_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">metric_labels_str</span> <span class="o">=</span> <span class="n">metric_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">metric_labels</span> <span class="o">=</span> <span class="n">metric_labels_str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to parse metric </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                    <span class="n">metrics_and_labels</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">metrics_and_labels</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">namespace</span><span class="p">]</span>
                    <span class="n">metrics_and_labels</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">metrics_and_labels</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">namespaces_dict_defined</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">namespaces_dict_defined</span> <span class="o">=</span> <span class="n">namespaces_dict</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">namespaces_dict</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">namespaces_dict</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">namespaces_dict</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">metric_labels</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">labels</span> <span class="o">=</span> <span class="n">parse_labels</span><span class="p">(</span><span class="n">metric_labels</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to parse labels </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">strip_labels</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">labels_dict_defined</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">labels_dict_defined</span> <span class="o">=</span> <span class="n">labels_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">labels_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">labels_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">labels_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                        <span class="n">values_dict_defined</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">values_dict_defined</span> <span class="o">=</span> <span class="n">values_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">values_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">values_dict</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">values_dict</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">namespaces_dict</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="n">namespaces_dict</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">metrics_and_labels</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="n">metrics_and_labels</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">labels_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
                        <span class="n">labels_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">values_dict</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
                        <span class="n">values_dict</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">namespace_elements</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="n">elements</span> <span class="o">=</span> <span class="n">elements</span> <span class="o">+</span> <span class="n">namespace_elements</span>
            <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespaces_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">namespaces_dict</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">namespaces_dict</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]))</span>
                <span class="n">namespaces_dict</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">namespaces_dict</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">labels_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]))</span>
                <span class="n">labels_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">values_dict</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values_dict</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]))</span>
                <span class="n">values_dict</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values_dict</span><span class="p">[</span><span class="n">value</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]))</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;cache_data&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;cache_ttl&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span>
                    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
                    <span class="s2">&quot;filtered&quot;</span><span class="p">:</span> <span class="n">filtered</span><span class="p">,</span>
                    <span class="s2">&quot;filter_namespace&quot;</span><span class="p">:</span> <span class="n">filter_namespace</span><span class="p">,</span>
                    <span class="s2">&quot;remove_full_namespace_prefix&quot;</span><span class="p">:</span> <span class="n">remove_full_namespace_prefix</span><span class="p">,</span>
                    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                    <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
                    <span class="s1">&#39;time_complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">unique_metrics</span><span class="p">,</span>
                    <span class="c1"># @added 20220823 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="c1"># Return namespaces, labels, values and elements with the response</span>
                    <span class="c1"># @modified 20230330 - Feature #3252: webapp api - unique_metrics</span>
                    <span class="c1"># Return a unique list as many are duplicated</span>
                    <span class="c1">#&quot;namespace_elements&quot;: elements,</span>
                    <span class="s2">&quot;namespace_elements&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">elements</span><span class="p">)),</span>
                    <span class="s2">&quot;namespaces&quot;</span><span class="p">:</span> <span class="n">namespaces_dict</span><span class="p">,</span>
                    <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">labels_dict</span><span class="p">,</span>
                    <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">values_dict</span><span class="p">,</span>
                    <span class="s2">&quot;metrics_and_labels&quot;</span><span class="p">:</span> <span class="n">metrics_and_labels</span><span class="p">,</span>
                    <span class="s1">&#39;time_complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;cache_data&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;cache_ttl&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span>
                    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
                    <span class="s2">&quot;filtered&quot;</span><span class="p">:</span> <span class="n">filtered</span><span class="p">,</span>
                    <span class="s2">&quot;filter_namespace&quot;</span><span class="p">:</span> <span class="n">filter_namespace</span><span class="p">,</span>
                    <span class="s2">&quot;remove_full_namespace_prefix&quot;</span><span class="p">:</span> <span class="n">remove_full_namespace_prefix</span><span class="p">,</span>
                    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                    <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
                    <span class="s1">&#39;time_complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">unique_metrics</span><span class="p">,</span>
                    <span class="s1">&#39;time_complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api/unique_metrics - set </span><span class="si">%s</span><span class="s1"> Redis key&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to set </span><span class="si">%s</span><span class="s1"> Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20180929</span>
    <span class="k">if</span> <span class="s1">&#39;get_json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">full_duration_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">valid_source</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;features_profile&#39;</span><span class="p">,</span> <span class="s1">&#39;training_data&#39;</span><span class="p">]:</span>
                <span class="n">valid_source</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_source</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: an invalid source parameter was passed to /api?get_json valid sources are features_profile or training_data&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: the required parameter source was not passed to /api?get_json - valid sources are features_profile or training_data&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no metric parameter was passed to /api?get_json&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no timestamp parameter was passed to /api?get_json&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">and</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="n">tuple_json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="n">metric</span>
            <span class="k">if</span> <span class="s1">&#39;full_duration_data&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">full_duration_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_duration_data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">full_duration_data</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">full_duration_in_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
                    <span class="n">tuple_json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.mirage.redis.</span><span class="si">%s</span><span class="s1">h.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_duration_in_hours</span><span class="p">))</span>
            <span class="n">metric_timeseries_dir</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
                <span class="n">source_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span> <span class="n">tuple_json_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span><span class="p">:</span>
                <span class="n">source_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span>
                    <span class="n">metric_timeseries_dir</span><span class="p">,</span> <span class="n">tuple_json_file</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;converting tuple data for </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> to json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">))</span>
            <span class="n">datapoints</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_file</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: file not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">source_file</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;404 data file not found&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">datapoints</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">}</span>
            <span class="n">datapoints</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">datapoints</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;datapoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datapoints</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;time_complexity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20180720 - Feature #2464: luminosity_remote_data</span>
    <span class="c1"># Added luminosity_remote_data endpoint, requires two request parameter:</span>
    <span class="k">if</span> <span class="s1">&#39;luminosity_remote_data&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?luminosity_remote_data&#39;</span><span class="p">)</span>
        <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;anomaly_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">anomaly_timestamp_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_timestamp_str</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?luminosity_remote_data - no anomaly_timestamp parameter was passed to /api?luminosity_remote_data&#39;</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no anomaly_timestamp parameter was passed to /api?luminosity_remote_data&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>

        <span class="c1"># @added 20201203 - Feature #3860: luminosity - handle low frequency data</span>
        <span class="c1"># Add the metric resolution</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="k">if</span> <span class="s1">&#39;resolution&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">resolution_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resolution_str</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="mi">60</span>

        <span class="c1"># @added 20230409 - Task #4872: Optimise luminosity for labelled_metrics</span>
        <span class="c1"># Added namespace for filter by namespace rather than surfacing the</span>
        <span class="c1"># entire Redis data</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;namespace&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">namespace_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">namespace_str</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">namespace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_str</span><span class="p">)</span>

        <span class="n">luminosity_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">anomaly_timestamp</span><span class="p">:</span>
            <span class="c1"># @modified 20201117 - Feature #3824: get_cluster_data</span>
            <span class="c1">#                      Feature #2464: luminosity_remote_data</span>
            <span class="c1">#                      Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># Wrapped in try</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20201203 - Feature #3860: luminosity - handle low frequency data</span>
                <span class="c1"># Added resolution</span>
                <span class="c1"># luminosity_data, success, message = luminosity_remote_data(anomaly_timestamp)</span>
                <span class="c1"># @added 20230409 - Task #4872: Optimise luminosity for labelled_metrics</span>
                <span class="c1"># Added namespace</span>
                <span class="n">luminosity_data</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">luminosity_remote_data</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">luminosity_data</span><span class="p">:</span>
                    <span class="c1"># @modified 20201123 - Feature #3824: get_cluster_data</span>
                    <span class="c1">#                      Feature #2464: luminosity_remote_data</span>
                    <span class="c1"># Change from json.dumps to jsonify</span>
                    <span class="c1"># resp = json.dumps(</span>
                    <span class="c1">#    {&#39;results&#39;: luminosity_data})</span>
                    <span class="c1"># return resp, 200</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">luminosity_data</span><span class="p">}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;No data found&#39;</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Error: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: luminosity_remote_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">500</span>
        <span class="c1"># @added 20201117 - Feature #3824: get_cluster_data</span>
        <span class="c1">#                   Feature #2464: luminosity_remote_data</span>
        <span class="c1"># Log 400 if no timestamp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?luminosity_remote_data - no anomaly_timestamp parameter was passed to /api?luminosity_remote_data, returning 400&#39;</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no anomaly_timestamp parameter was passed to /api?luminosity_remote_data&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="s1">&#39;graphite_metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;processing graphite_metric api request&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">missing_arguments</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;graphite_metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">missing_arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metric argument not found&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_timestamp</span><span class="p">:</span>
            <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">missing_arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;from_timestamp argument not found&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;from_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">until_timestamp</span><span class="p">:</span>
            <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">missing_arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;until_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_request</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Error: not all arguments where passed, missing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">missing_arguments</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;requesting data from graphite for </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)))</span>

        <span class="n">data_source</span> <span class="o">=</span> <span class="s1">&#39;graphite&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">data_source</span> <span class="o">=</span> <span class="s1">&#39;victoriametrics&#39;</span>
        <span class="k">if</span> <span class="n">data_source</span> <span class="o">==</span> <span class="s1">&#39;graphite&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_graphite_metric</span><span class="p">(</span>
                    <span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;object&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">500</span>
        <span class="k">if</span> <span class="n">data_source</span> <span class="o">==</span> <span class="s1">&#39;victoriametrics&#39;</span><span class="p">:</span>

            <span class="c1"># @added 20230519 - Feature #3336: webapp api - derivative_metrics</span>
            <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="c1"># To handle labelled_metrics, allow for the request to pass a metric</span>
            <span class="c1"># to determine if it is a derivative_metric or not</span>
            <span class="n">monotonic</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;monotonic&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">monotonic</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;monotonic&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">monotonic</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">monotonic</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># get_victoriametrics_metric automatically applies the rate and</span>
                <span class="c1"># step required no downsampling or nonNegativeDerivative is</span>
                <span class="c1"># required.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">monotonic</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_victoriametrics_metric</span><span class="p">(</span>
                        <span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;object&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_victoriametrics_metric</span><span class="p">(</span>
                        <span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="n">metric_data</span><span class="o">=</span><span class="p">{},</span> <span class="n">plot_parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">do_not_type</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;error :: get_victoriametrics_metric failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">500</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">timeseries</span><span class="p">})</span>
        <span class="n">cleaned_resp</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20191014 - Task #3270: Deprecate string.replace for py3</span>
            <span class="c1"># format_resp_1 = string.replace(str(resp), &#39;&quot;[[&#39;, &#39;[[&#39;)</span>
            <span class="c1"># cleaned_resp = string.replace(str(format_resp_1), &#39;]]&quot;&#39;, &#39;]]&#39;)</span>
            <span class="n">resp_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="n">format_resp_1</span> <span class="o">=</span> <span class="n">resp_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;[[&#39;</span><span class="p">,</span> <span class="s1">&#39;[[&#39;</span><span class="p">)</span>
            <span class="n">cleaned_resp</span> <span class="o">=</span> <span class="n">format_resp_1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]]&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;]]&#39;</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed string replace resp: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">cleaned_resp</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cleaned_resp</span><span class="p">,</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: failed to generate timeseries&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span>

    <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># @added 20220503 - Feature #4530: namespace.analysed_events</span>
        <span class="c1"># Handle cluster_data</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">raw_series</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20200225 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># raw_series = REDIS_CONN.get(metric)</span>
            <span class="n">raw_series</span> <span class="o">=</span> <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_series</span><span class="p">:</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
                <span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
                <span class="c1"># Roll back change - breaking existing metrics with colons</span>
                <span class="c1"># metric_name = url_encode_metric_name(metric_name)</span>
                <span class="n">raw_series</span> <span class="o">=</span> <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get raw data from Redis for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">raw_series</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">raw_series</span><span class="p">)</span>
                <span class="c1"># @modified 20201117 - Feature #3824: get_cluster_data</span>
                <span class="c1">#                      Feature #2464: luminosity_remote_data</span>
                <span class="c1">#                      Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># Replace redefinition of item from line 1338</span>
                <span class="c1"># timeseries = [item[:2] for item in unpacker]</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[</span><span class="n">ts_item</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">ts_item</span> <span class="ow">in</span> <span class="n">unpacker</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to unpack raw data from Redis for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="n">cluster_data</span><span class="p">:</span>
                <span class="n">redis_metric_data_uri</span> <span class="o">=</span> <span class="s1">&#39;metric=</span><span class="si">%s</span><span class="s1">&amp;format=json&amp;cluster_call=true&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="n">redis_metric_data_uri</span><span class="p">,</span> <span class="s1">&#39;timeseries&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get timeseries from the remote Skyline instances&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">timeseries</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got timeseries of length </span><span class="si">%s</span><span class="s1"> from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: failed to get timeseries from the remote Skyline instances&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: No metric by that name - try /api?metric=&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;metric_namespace&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">remove_full_namespace_prefix</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;remove_full_namespace_prefix&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">remove_full_namespace_prefix_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_full_namespace_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remove_full_namespace_prefix_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">remove_full_namespace_prefix</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">):</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;format&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">use_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">),</span> <span class="s1">&#39;pjson&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">use_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span>
                            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="n">use_format</span><span class="p">,</span>
                            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                            <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
                            <span class="s2">&quot;remove_full_namespace_prefix&quot;</span><span class="p">:</span> <span class="n">remove_full_namespace_prefix</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                            <span class="s2">&quot;timeseries&quot;</span><span class="p">:</span> <span class="n">timeseries</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">timeseries</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">200</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Error: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">500</span>

    <span class="c1"># @modified 20200128 - Feature #3424: webapp - api documentation</span>
    <span class="c1"># resp = json.dumps(</span>
    <span class="c1">#     {&#39;results&#39;: &#39;Error: No argument passed - try /api?metric= or /api?graphite_metric=&#39;})</span>
    <span class="c1"># return resp, 404</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;api.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<span class="c1"># @added 20200116: Feature #3396: http_alerter</span>
<div class="viewcode-block" id="mock_api"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.mock_api">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/mock_api&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">mock_api</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">&#39;alert_reciever&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># post_data = request.form.to_dict()</span>

                <span class="c1"># TESTING</span>
                <span class="n">raw_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mock_api :: /alert_reciever POST raw_data: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw_data</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: mock_api :: /alert_reciever request.get_json() failed trying request.json() to see if data is cached&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get alert details from the alert_reciever POST request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;malformed or missing data in the POST request&#39;</span><span class="p">})</span>
                        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mock_api :: /alert_reciever recieved </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">))</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">])</span>
                <span class="c1"># timestamp = int(request.form[&#39;timestamp&#39;])</span>
                <span class="c1"># value = float(request.form[&#39;value&#39;])</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                <span class="c1"># full_duration = int(request.form[&#39;full_duration&#39;])</span>
                <span class="c1"># expiry = int(request.form[&#39;expiry&#39;])</span>
                <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;full_duration&#39;</span><span class="p">])</span>
                <span class="n">expiry</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;expiry&#39;</span><span class="p">])</span>
                <span class="n">source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">])</span>
                <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;token&#39;</span><span class="p">])</span>
                <span class="n">metric_alert_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;full_duration&quot;</span><span class="p">:</span> <span class="n">full_duration</span><span class="p">,</span>
                    <span class="s2">&quot;expiry&quot;</span><span class="p">:</span> <span class="n">expiry</span><span class="p">,</span>
                    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
                    <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">token</span>
                <span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get alert details from the alert_reciever POST request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">))</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;malformed or missing data in the POST request&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
            <span class="n">testing_http_alerter</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">testing_http_alerter</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;testing with a 400&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;alert&quot;</span><span class="p">:</span> <span class="n">metric_alert_dict</span><span class="p">}}</span>
            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mock_api.alert_reciever.alerts&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
                <span class="c1"># @added 20200528 - Feature #3560: External alert config</span>
                <span class="c1"># Expire this set</span>
                <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added alert to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mock_api :: could not add data_dict to Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mock_api :: responding with 200 and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200528 - Feature #3560: External alert config</span>
    <span class="k">if</span> <span class="s1">&#39;alert_config&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="c1"># return &#39;Method Not Allowed&#39;, 405</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get token from the alert_config request, returning 400&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mock_api :: /alert_config recieved </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">))</span>
                <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;token&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
                <span class="c1"># semgrep - python-logger-credential-disclosure</span>
                <span class="c1"># logger.error(&#39;error :: Webapp could not get token from the alert_config POST request, returning 400 - %s&#39; % str(request.form))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get token from the alert_config POST request, returning 400&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;no token found&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">error_msg</span><span class="p">)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SELF_API_KEY</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;no token found&#39;</span>
            <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
            <span class="c1"># semgrep - python-logger-credential-disclosure</span>
            <span class="c1"># logger.error(&#39;error :: the token %s does not match settings.FLUX_SELF_API_KEY, returning 401&#39; % str(token))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: the token does not match settings.FLUX_SELF_API_KEY, returning 401&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">alerts_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALERTS</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">namespace</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mock_api :: alert_config :: could not determine namespace from alert_tuple - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alerter</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mock_api :: alert_config :: could not determine alerter from alert_tuple - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">expiration</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mock_api :: alert_config :: could not determine expiration from alert_tuple - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">second_order_resolution_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">second_order_resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">second_order_resolution_hours</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">second_order_resolution</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span>
            <span class="n">namespace_prefix_1</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">namespace_prefix_2</span> <span class="o">=</span> <span class="n">namespace_prefix_1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">namespace_prefix</span> <span class="o">=</span> <span class="n">namespace_prefix_2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">learn_days</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="n">count_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
            <span class="n">alerts_dict</span><span class="p">[</span><span class="n">count_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;alerter&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">alerter</span><span class="p">),</span>
                <span class="s1">&#39;expiration&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">expiration</span><span class="p">),</span>
                <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">),</span>
                <span class="s1">&#39;namespace_prefix&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_prefix</span><span class="p">),</span>
                <span class="s1">&#39;second_order_resolution&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution</span><span class="p">),</span>
                <span class="s1">&#39;learn_days&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_days</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">alerts_dict</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200528 - Feature #3560: External alert config</span>
    <span class="k">if</span> <span class="s1">&#39;test_alert_config&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">alerts_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">alerts_dict</span><span class="p">[</span><span class="s1">&#39;test_external_alert_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;alerter&#39;</span><span class="p">:</span> <span class="s1">&#39;http_alerter-mock_api&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expiration&#39;</span><span class="p">:</span> <span class="s1">&#39;60&#39;</span><span class="p">,</span>
            <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="s1">&#39;analyzer.runtime&#39;</span><span class="p">,</span>
            <span class="s1">&#39;namespace_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;skyline&#39;</span><span class="p">,</span>
            <span class="s1">&#39;second_order_resolution&#39;</span><span class="p">:</span> <span class="s1">&#39;604800&#39;</span><span class="p">,</span>
            <span class="s1">&#39;learn_days&#39;</span><span class="p">:</span> <span class="s1">&#39;30&#39;</span>
        <span class="p">}</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">alerts_dict</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20210601 - Feature #4000: EXTERNAL_SETTINGS</span>
    <span class="k">if</span> <span class="s1">&#39;test_external_settings&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">settings_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;test_external_settings&#39;</span><span class="p">,</span>
            <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="s1">&#39;skyline-test-external-settings&#39;</span><span class="p">,</span>
            <span class="s1">&#39;retention_1_resolution_seconds&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s1">&#39;retention_1_period_seconds&#39;</span><span class="p">:</span> <span class="mi">604800</span><span class="p">,</span>
            <span class="s1">&#39;retention_2_resolution_seconds&#39;</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
            <span class="s1">&#39;retention_2_period_seconds&#39;</span><span class="p">:</span> <span class="mi">63072000</span><span class="p">,</span>
            <span class="s1">&#39;full_duration&#39;</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span>
            <span class="s1">&#39;second_order_resolution_seconds&#39;</span><span class="p">:</span> <span class="mi">604800</span><span class="p">,</span>
            <span class="s1">&#39;learn_full_duration_seconds&#39;</span><span class="p">:</span> <span class="mi">2592000</span><span class="p">,</span>
            <span class="s1">&#39;flux_token&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;thunder_alert_endpoint&quot;</span><span class="p">:</span> <span class="s1">&#39;http://127.0.0.1:1500/mock_api?alert_reciever&#39;</span><span class="p">,</span>
            <span class="s1">&#39;thunder_alert_token&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;alert_on_no_data&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;stale_period&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;alert_on_stale_metrics&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;stale_period&#39;</span><span class="p">:</span> <span class="mi">900</span><span class="p">,</span>
                <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="c1"># @added 20220128 - Feature #4404: flux - external_settings - aggregation</span>
            <span class="s1">&#39;metric_limit&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s1">&#39;aggregate&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;skyline-test-external-settings.1&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;interval&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                    <span class="s1">&#39;zero_fill&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;last_known_value&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;method_suffix&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s1">&#39;skyline-test-external-settings.2&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;interval&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                    <span class="s1">&#39;zero_fill&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;last_known_value&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;method_suffix&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings_dict</span><span class="p">]</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;namespaces&quot;</span><span class="p">:</span> <span class="n">namespaces</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span></div>


<span class="c1"># @added 20180721 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Add a specific route for the luminosity_remote_data endpoint so that the</span>
<span class="c1"># response can be gzipped as even the preprocessed data can run into megabyte</span>
<span class="c1"># reponses.</span>
<div class="viewcode-block" id="luminosity_remote_data_endpoint"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.luminosity_remote_data_endpoint">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/luminosity_remote_data&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@gzipped</span>
<span class="k">def</span> <span class="nf">luminosity_remote_data_endpoint</span><span class="p">():</span>
    <span class="c1"># The luminosity_remote_data_endpoint, requires onerequest parameter:</span>
    <span class="k">if</span> <span class="s1">&#39;anomaly_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">anomaly_timestamp_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_timestamp_str</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no anomaly_timestamp parameter was passed to /luminosity_remote_data&#39;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
    <span class="n">luminosity_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">anomaly_timestamp</span><span class="p">:</span>
        <span class="n">luminosity_data</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">luminosity_remote_data</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">luminosity_data</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">luminosity_data</span><span class="p">})</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;returning gzipped response&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;No data found&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span></div>


<div class="viewcode-block" id="docs"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.docs">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/docs&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">docs</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;docs.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<div class="viewcode-block" id="panorama"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.panorama">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/panorama&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">panorama</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;uh_oh.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Panorama is not enabled, please see the Panorama section in the docs and settings.py&quot;</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request.url: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>

    <span class="c1"># @added 20211125 - Feature #4326: webapp - panorama_plot_anomalies</span>
    <span class="k">if</span> <span class="s1">&#39;plot_metric_anomalies&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">plot_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;from_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">from_timestamp</span><span class="p">:</span>
                <span class="n">new_from_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_from_timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">from_timestamp</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">from_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid from_timestamp&quot;</span><span class="p">}}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;until_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">until_timestamp</span><span class="p">:</span>
                <span class="n">new_until_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_until_timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">until_timestamp</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">until_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid until_timestamp&quot;</span><span class="p">}}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

        <span class="c1"># @added 20220801 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metric</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">base_name</span> <span class="ow">and</span> <span class="s1">&#39;}&#39;</span> <span class="ow">in</span> <span class="n">base_name</span> <span class="ow">and</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: plot_metric_anomalies :: get_metric_id_from_base_name failed with base_name: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                    <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>
                    <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/panorama?plot_metric_anomalies=true&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">labelled_metric_name</span>
                        <span class="n">new_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">redirect_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                        <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">new_redirect_url</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_metric_anomalies :: returning redirect on original request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">metric_name</span><span class="p">:</span>
                        <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="c1"># @added 20220519 - Feature #4326: webapp - panorama_plot_anomalies</span>
        <span class="c1"># Added matches</span>
        <span class="n">matches_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">matches_plot_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;plot_matches&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">plot_matches</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_matches&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_matches</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># @added 20230127 - Feature #4830: webapp - panorama_plot_anomalies - all_events</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">and</span> <span class="n">from_timestamp</span> <span class="o">&gt;</span> <span class="n">until_timestamp</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_metric_anomalies :: returning 400 as from_timestamp is greater than until_timestamp&#39;</span><span class="p">)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;from_timestamp is greater than until_timestamp&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

        <span class="n">plot_all_events</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">events_plot_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">use_format</span> <span class="o">=</span> <span class="s1">&#39;html&#39;</span>
        <span class="n">run_panorama_plot_anomalies</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">run_panorama_plot_anomalies</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;format&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">use_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;plot_all_events&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">plot_all_events</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_all_events&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_all_events</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">plot_all_events</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_all_events</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Do not incur the overhead as plot_all_events does matches and</span>
                <span class="c1"># anomalies</span>
                <span class="k">if</span> <span class="n">use_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                    <span class="n">run_panorama_plot_anomalies</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># @added 20230130 - Feature #4830: webapp - panorama_plot_anomalies - all_events</span>
        <span class="c1">#                   Feature #4834: webapp - api - get_all_activity</span>
        <span class="c1"># The redirect needs to happen first for plot_all_events if this is a</span>
        <span class="c1"># cluster because only the authoritative_node have the illuminance data</span>

        <span class="k">if</span> <span class="n">HORIZON_SHARDS</span> <span class="ow">and</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">authoritative_node</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_host</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">authoritative_node</span> <span class="o">=</span> <span class="n">get_authoritative_node</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_metric_anomalies :: reports </span><span class="si">%s</span><span class="s1"> as the authoritative cluster node for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">authoritative_node</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api get_authoritative_node failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">request_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">authoritative_node</span> <span class="o">!=</span> <span class="n">this_host</span><span class="p">:</span>
                <span class="n">find_host</span> <span class="o">=</span> <span class="n">this_host</span>
                <span class="n">replace_host</span> <span class="o">=</span> <span class="n">authoritative_node</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span> <span class="ow">in</span> <span class="n">request_url</span><span class="p">:</span>
                    <span class="n">find_host</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span>
                <span class="k">if</span> <span class="n">this_host</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request_url</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">authoritative_node</span><span class="p">:</span>
                            <span class="n">replace_host</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">find_host</span> <span class="o">!=</span> <span class="n">replace_host</span><span class="p">:</span>
                    <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">request_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">find_host</span><span class="p">,</span> <span class="n">replace_host</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_metric_anomalies :: returning redirect to authoritative_node - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>

        <span class="c1"># @added 20221115 - Feature #4326: webapp - panorama_plot_anomalies</span>
        <span class="c1"># Added timeseries_dict</span>
        <span class="n">timeseries_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># @modified 20230127 - Feature #4830: webapp - panorama_plot_anomalies - all_events</span>
        <span class="c1"># if metric:</span>
        <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">run_panorama_plot_anomalies</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_metric_anomalies :: running panorama_plot_anomalies&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># anomalies_dict, plot_file = panorama_plot_anomalies(metric, from_timestamp, until_timestamp)</span>
                <span class="c1"># @modified 20221115 - Feature #4326: webapp - panorama_plot_anomalies</span>
                <span class="c1"># Added timeseries_dict</span>
                <span class="n">anomalies_dict</span><span class="p">,</span> <span class="n">plot_file</span><span class="p">,</span> <span class="n">matches_dict</span><span class="p">,</span> <span class="n">matches_plot_file</span><span class="p">,</span> <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="n">timeseries_dict</span> <span class="o">=</span> <span class="n">panorama_plot_anomalies</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">matches</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using panorama_plot_anomalies&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @added 20230127 - Feature #4830: webapp - panorama_plot_anomalies - all_events</span>
        <span class="n">events_plot_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">all_events_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">plot_all_events</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;no metric parameter passed&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_metric_anomalies :: running get_metric_all_events&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">all_events_dict</span> <span class="o">=</span> <span class="n">get_metric_all_events</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_metric_all_events - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">all_events_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error ::  get_metric_id_from_base_name failed with base_name: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">use_format</span> <span class="o">!=</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">success</span><span class="p">,</span> <span class="n">events_plot_file</span> <span class="o">=</span> <span class="n">plot_metric_all_events</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">,</span>
                            <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">all_events_dict</span><span class="p">,</span>
                            <span class="n">plot_parameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">)})</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using plot_metric_all_timeseries - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @added 20221115 - Feature #4326: webapp - panorama_plot_anomalies</span>
        <span class="c1"># Added json response</span>
        <span class="k">if</span> <span class="s1">&#39;format&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">use_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">use_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                <span class="n">took</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_metric_anomalies :: took </span><span class="si">%s</span><span class="s1"> seconds, responding with json&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">took</span><span class="p">))</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;request_time&#39;</span><span class="p">:</span> <span class="n">took</span><span class="p">},</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;anomalies&quot;</span><span class="p">:</span> <span class="n">anomalies_dict</span><span class="p">,</span>
                        <span class="s2">&quot;matches&quot;</span><span class="p">:</span> <span class="n">matches_dict</span><span class="p">,</span>
                        <span class="s2">&quot;timeseries&quot;</span><span class="p">:</span> <span class="n">timeseries_dict</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">plot_all_events</span><span class="p">:</span>
                    <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">all_events_dict</span><span class="p">)</span>
                    <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span>
                    <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_id</span>
                    <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_timestamp</span>
                    <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">until_timestamp</span>
                    <span class="k">del</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot_metric_anomalies returned json&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;panorama.html&#39;</span><span class="p">,</span> <span class="n">plot_metric_anomalies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
            <span class="n">anomalies_dict</span><span class="o">=</span><span class="n">anomalies_dict</span><span class="p">,</span> <span class="n">plot_file</span><span class="o">=</span><span class="n">plot_file</span><span class="p">,</span>
            <span class="n">plot_matches</span><span class="o">=</span><span class="n">matches</span><span class="p">,</span> <span class="n">matches_dict</span><span class="o">=</span><span class="n">matches_dict</span><span class="p">,</span>
            <span class="n">matches_plot_file</span><span class="o">=</span><span class="n">matches_plot_file</span><span class="p">,</span>
            <span class="n">labelled_metric_name</span><span class="o">=</span><span class="n">labelled_metric_name</span><span class="p">,</span>
            <span class="n">labelled_metric_base_name</span><span class="o">=</span><span class="n">labelled_metric_base_name</span><span class="p">,</span>
            <span class="c1"># @added 20221115 - Feature #4326: webapp - panorama_plot_anomalies</span>
            <span class="n">timeseries_dict</span><span class="o">=</span><span class="n">timeseries_dict</span><span class="p">,</span>
            <span class="c1"># @added 20230127 - Feature #4830: webapp - panorama_plot_anomalies - all_events</span>
            <span class="n">plot_all_events</span><span class="o">=</span><span class="n">plot_all_events</span><span class="p">,</span> <span class="n">events_plot_file</span><span class="o">=</span><span class="n">events_plot_file</span><span class="p">,</span>
            <span class="n">all_events_dict</span><span class="o">=</span><span class="n">all_events_dict</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20210326 - Feature #3994: Panorama - mirage not anomalous</span>
    <span class="k">if</span> <span class="s1">&#39;not_anomalous&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">not_anomalous_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">not_anomalous_dict</span><span class="p">,</span> <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="n">get_mirage_not_anomalous_metrics</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_mirage_not_anomalous_metrics&#39;</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">output_format</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;format&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">output_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
        <span class="n">anomalies_param</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;anomalies&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">anomalies_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;anomalies&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">anomalies_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">anomalies_param</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">not_anomalous_dict</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">anomalies_dict</span><span class="p">:</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">204</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;no data&quot;</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;not anomalous&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;anomalies&quot;</span><span class="p">:</span> <span class="p">{}}}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">anomalies_param</span><span class="p">:</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;not anomalous&quot;</span><span class="p">:</span> <span class="n">not_anomalous_dict</span><span class="p">,</span> <span class="s2">&quot;anomalies&quot;</span><span class="p">:</span> <span class="n">anomalies_dict</span><span class="p">}}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;not anomalous&quot;</span><span class="p">:</span> <span class="n">not_anomalous_dict</span><span class="p">}}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_not_anomalous returned json with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

        <span class="n">not_anomalous_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">not_anomalous_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">not_anomalous_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">not_anomalous_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span>
                <span class="n">not_anomalous_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
                <span class="n">not_anomalous_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span>
                <span class="n">not_anomalous_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;labelled_metric_base_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;labelled_metric_base_name&#39;</span><span class="p">]</span>
                <span class="n">not_anomalous_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>

        <span class="n">anomalies_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">anomalies_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">anomalies_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">anomalies_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">anomalies_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span>
                <span class="n">anomalies_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
                <span class="n">anomalies_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;until&#39;</span><span class="p">]</span>
                <span class="n">anomalies_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;labelled_metric_base_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;labelled_metric_base_name&#39;</span><span class="p">]</span>
                <span class="n">anomalies_metrics_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomalies_dict</span><span class="p">[</span><span class="n">i_metric</span><span class="p">][</span><span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;panorama.html&#39;</span><span class="p">,</span> <span class="n">not_anomalous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">not_anomalous_dict</span><span class="o">=</span><span class="n">not_anomalous_dict</span><span class="p">,</span>
            <span class="n">not_anomalous_metrics_dict</span><span class="o">=</span><span class="n">not_anomalous_metrics_dict</span><span class="p">,</span>
            <span class="n">anomalies_dict</span><span class="o">=</span><span class="n">anomalies_dict</span><span class="p">,</span>
            <span class="n">anomalies_metrics_dict</span><span class="o">=</span><span class="n">anomalies_metrics_dict</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20210328 - Feature #3994: Panorama - mirage not anomalous</span>
    <span class="k">if</span> <span class="s1">&#39;not_anomalous_metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">anomalies_param</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;no metric parameter passed&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;from_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_timestamp</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;no from_timestamp parameter passed&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;until_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">until_timestamp</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;no until_timestamp parameter passed&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;anomalies&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">anomalies_arg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;anomalies&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">anomalies_arg</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">anomalies_param</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="nf">get_cache_dict</span><span class="p">(</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">):</span>
            <span class="n">data_dict_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.</span><span class="si">%s</span><span class="s1">_dict.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">plot_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
            <span class="n">metric_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">raw_data_dict</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data_dict_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">raw_data_dict</span><span class="p">:</span>
                    <span class="n">metric_data_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">raw_data_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_data_dict</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;key found: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_dict_key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_dict_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_data_dict</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;key not found: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_dict_key</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data_dict_all_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.</span><span class="si">%s</span><span class="s1">_dict.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">plot_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">))</span>
                    <span class="n">raw_data_dict_all</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data_dict_all_key</span><span class="p">)</span>
                    <span class="n">data_dict_all</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">raw_data_dict_all</span><span class="p">:</span>
                        <span class="n">data_dict_all</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">raw_data_dict_all</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data_dict_all</span><span class="p">:</span>
                        <span class="n">metric_data_dict</span> <span class="o">=</span> <span class="n">data_dict_all</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">data_dict</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;key found: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_dict_all_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_dict_all_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_data_dict</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;key not found: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_dict_all_key</span><span class="p">)</span>
                <span class="n">recent_data_dict_all_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.</span><span class="si">%s</span><span class="s1">_dict.recent&#39;</span> <span class="o">%</span> <span class="n">plot_type</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_data_dict_all</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">recent_data_dict_all_key</span><span class="p">)</span>
                    <span class="n">data_dict_all</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">raw_data_dict_all</span><span class="p">:</span>
                        <span class="n">data_dict_all</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">raw_data_dict_all</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data_dict_all</span><span class="p">:</span>
                        <span class="n">metric_data_dict</span> <span class="o">=</span> <span class="n">data_dict_all</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">data_dict</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;key found: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_dict_all_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">recent_data_dict_all_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric_data_dict</span><span class="p">:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_data_dict</span>
            <span class="k">return</span> <span class="n">data_dict</span>

        <span class="n">not_anomalous_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">not_anomalous_dict</span> <span class="o">=</span> <span class="n">get_cache_dict</span><span class="p">(</span><span class="s1">&#39;not_anomalous&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_mirage_not_anomalous_metrics&#39;</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="c1"># logger.info(&#39;not_anomalous_dict: %s&#39; % str(not_anomalous_dict))</span>

        <span class="c1"># @added 20221115 - Feature #4326: webapp - panorama_plot_anomalies</span>
        <span class="c1"># Added timeseries_dict</span>
        <span class="n">timeseries_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">anomalies_param</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;trying to get anomalies from cache&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="n">get_cache_dict</span><span class="p">(</span><span class="s1">&#39;anomalies&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_mirage_not_anomalous_metrics&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="c1"># logger.info(&#39;anomalies_dict: %s&#39; % str(anomalies_dict))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">not_anomalous_dict</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not_anomalous_dict data not found in Redis&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;calling get_mirage_not_anomalous_metrics(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">anomalies_param</span><span class="p">)))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">not_anomalous_dict</span><span class="p">,</span> <span class="n">anomalies_dict</span> <span class="o">=</span> <span class="n">get_mirage_not_anomalous_metrics</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">anomalies_param</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_mirage_not_anomalous_metrics&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">output_format</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;format&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">output_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">anomalies_param</span><span class="p">:</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;not anomalous&quot;</span><span class="p">:</span> <span class="n">not_anomalous_dict</span><span class="p">,</span> <span class="s2">&quot;anomalies&quot;</span><span class="p">:</span> <span class="n">anomalies_dict</span><span class="p">}}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;not anomalous&quot;</span><span class="p">:</span> <span class="n">not_anomalous_dict</span><span class="p">}}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">not_anomalous_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">not_anomalous_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">anomalies_param</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">anomalies_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anomalies_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">anomalies_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">anomalies_param</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_not_anomalous returned json with </span><span class="si">%s</span><span class="s1"> not_anomalous events and </span><span class="si">%s</span><span class="s1"> anomalies for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">not_anomalous_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">anomalies_count</span><span class="p">),</span> <span class="n">base_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mirage_not_anomalous returned json with </span><span class="si">%s</span><span class="s1"> not_anomalous events for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">not_anomalous_count</span><span class="p">),</span> <span class="n">base_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

        <span class="c1"># logger.debug(&#39;debug :: not_anomalous_dict: %s&#39; % str(not_anomalous_dict))</span>
        <span class="c1"># logger.debug(&#39;debug :: anomalies_dict: %s&#39; % str(anomalies_dict))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not_anomalous_dict length: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;anomalies_dict length: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">anomalies_dict</span><span class="p">)))</span>

        <span class="n">not_anomalous_plot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">not_anomalous_dict</span> <span class="ow">or</span> <span class="n">anomalies_dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">not_anomalous_plot</span> <span class="o">=</span> <span class="n">plot_not_anomalous_metric</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="p">,</span> <span class="n">anomalies_dict</span><span class="p">,</span> <span class="s1">&#39;not_anomalous&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_mirage_not_anomalous_metrics&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: no not_anomalous_dict or anomalies_dict to plot for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>

        <span class="n">anomalies_plot</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">anomalies_param</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">anomalies_dict</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">anomalies_plot</span> <span class="o">=</span> <span class="n">plot_not_anomalous_metric</span><span class="p">(</span><span class="n">not_anomalous_dict</span><span class="p">,</span> <span class="n">anomalies_dict</span><span class="p">,</span> <span class="s1">&#39;anomalies&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_mirage_not_anomalous_metrics&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: no anomalies_dict to plot for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>

        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">base_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
            <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_name</span><span class="p">:</span>
                    <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;panorama.html&#39;</span><span class="p">,</span> <span class="n">not_anomalous_metric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span>
            <span class="n">not_anomalous_dict</span><span class="o">=</span><span class="n">not_anomalous_dict</span><span class="p">,</span>
            <span class="n">from_timestamp</span><span class="o">=</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="o">=</span><span class="n">until_timestamp</span><span class="p">,</span>
            <span class="n">not_anomalous_plot</span><span class="o">=</span><span class="n">not_anomalous_plot</span><span class="p">,</span>
            <span class="n">anomalies_plot</span><span class="o">=</span><span class="n">anomalies_plot</span><span class="p">,</span>
            <span class="n">labelled_metric_name</span><span class="o">=</span><span class="n">labelled_metric_name</span><span class="p">,</span>
            <span class="n">labelled_metric_base_name</span><span class="o">=</span><span class="n">labelled_metric_base_name</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @modified 20230107 - Task #4022: Move mysql_select calls to SQLAlchemy</span>
    <span class="c1">#                      Task #4778: v4.0.0 - update dependencies</span>
    <span class="c1"># Use sqlalchemy rather than string-based query construction</span>
    <span class="c1"># Deprecated get_list and using get_ functions</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># apps = get_list(&#39;app&#39;)</span>
        <span class="n">apps_dict</span> <span class="o">=</span> <span class="n">get_apps</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="n">apps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">apps_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
        <span class="n">apps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># sources = get_list(&#39;source&#39;)</span>
        <span class="n">sources_dict</span> <span class="o">=</span> <span class="n">get_sources</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sources_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># algorithms = get_list(&#39;algorithm&#39;)</span>
        <span class="n">algorithms_dict</span> <span class="o">=</span> <span class="n">get_algorithms</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="n">algorithms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">algorithms_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
        <span class="n">algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># hosts = get_list(&#39;host&#39;)</span>
        <span class="n">hosts_dict</span> <span class="o">=</span> <span class="n">get_hosts</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="n">hosts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hosts_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
        <span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span>

    <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># @added 20200226: Ideas #2476: Label and relate anomalies</span>
    <span class="c1">#                  Feature #2516: Add label to features profile</span>
    <span class="n">label_anomalies_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;label_anomalies&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">label_anomalies_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;label_anomalies&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label_anomalies_request</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">label_anomalies_request</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">label_anomalies_request</span><span class="p">:</span>
        <span class="n">start_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">namespaces_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;start_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">start_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;start_timestamp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;end_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">end_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;end_timestamp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metrics&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;namespaces&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;namespaces&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">do_label_anomalies</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20230112 - Task #4778: v4.0.0 - update dependencies</span>
        <span class="c1"># Default end_timestamp to now</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">end_timestamp</span><span class="p">:</span>
            <span class="n">end_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">start_timestamp</span> <span class="ow">and</span> <span class="n">end_timestamp</span> <span class="ow">and</span> <span class="n">label</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">do_label_anomalies</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metrics_list</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;label_anomalies metrics_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">namespaces</span><span class="p">:</span>
                <span class="n">do_label_anomalies</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">namespaces_list</span> <span class="o">=</span> <span class="n">namespaces</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;label_anomalies namespaces_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespaces_list</span><span class="p">))</span>
        <span class="n">labelled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">anomalies_labelled</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">do_label_anomalies</span><span class="p">:</span>
            <span class="n">labelled</span><span class="p">,</span> <span class="n">anomalies_labelled</span> <span class="o">=</span> <span class="n">label_anomalies</span><span class="p">(</span><span class="n">start_timestamp</span><span class="p">,</span> <span class="n">end_timestamp</span><span class="p">,</span> <span class="n">metrics_list</span><span class="p">,</span> <span class="n">namespaces_list</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;panorama.html&#39;</span><span class="p">,</span> <span class="n">label_anomalies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">anomalies_labelled</span><span class="o">=</span><span class="n">anomalies_labelled</span><span class="p">,</span>
            <span class="n">start_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">start_timestamp</span><span class="p">),</span> <span class="n">end_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">end_timestamp</span><span class="p">),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">metrics_list</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20160803 - Sanitize request.args</span>
    <span class="n">REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;from_date&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;from_time&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;until_date&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;until_time&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;count_by_metric&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;metric&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;metric_like&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;app&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;host&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;algorithm&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;order&#39;</span><span class="p">,</span>
                    <span class="c1"># @added 20161127 - Branch #922: ionosphere</span>
                    <span class="s1">&#39;panorama_anomaly_id&#39;</span><span class="p">,</span>
                    <span class="p">]</span>

    <span class="c1"># @added 20190919 - Feature #3230: users DB table</span>
    <span class="c1">#                   Ideas #2476: Label and relate anomalies</span>
    <span class="c1">#                   Feature #2516: Add label to features profile</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authorization</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">username</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;Skyline&#39;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_details</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error : /panorama could not get_user_details(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: i - could not determine user_id&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /panorama get_user_details(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">) did not return an int&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: p - user_id not int&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="n">get_anomaly_id</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">request_args_present</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                <span class="c1"># Return data</span>
                <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

            <span class="c1"># @added 20161127 - Branch #922: ionosphere</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;panorama_anomaly_id&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">get_anomaly_id</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="n">value</span>
                    <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
                    <span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
                    <span class="c1"># Roll back change - breaking existing metrics with colons</span>
                    <span class="c1"># metric_name = url_encode_metric_name(metric_name)</span>

                    <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="c1"># @added 20221025 - Task #2732: Prometheus to Skyline</span>
                        <span class="c1">#                   Branch #4300: prometheus</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_metric_id_from_base_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">value</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                            <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>

                    <span class="c1"># @added 20230207 - Bug #4374: webapp - handle url encoded chars</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">encoded_metric_name</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;%3A&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">encoded_metric_name</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;encoded metric name found in unique_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">encoded_metric_name</span><span class="p">))</span>
                                <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: encoded metric name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">metric</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                    <span class="c1"># @added 20220722 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>

                        <span class="c1"># @added 20220727 - Task #2732: Prometheus to Skyline</span>
                        <span class="c1">#                   Branch #4300: prometheus</span>
                        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">metric_name</span><span class="p">:</span>
                                    <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                    <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                    <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                    <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">value</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">metric_id_str</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;looking up </span><span class="si">%s</span><span class="s1"> in aet.metrics_manager.metric_names_with_ids from Redis&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
                            <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.metric_names_with_ids&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the aet.metrics_manager.metric_names_with_ids from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                        <span class="n">has_redistimeseries</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">metric_id_str</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">redistimeseries_key</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_id_str</span>
                                <span class="n">has_redistimeseries</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">redistimeseries_key</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not check if redistimeseries_key exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">has_redistimeseries</span><span class="p">:</span>
                            <span class="n">append_metric</span> <span class="o">=</span> <span class="s1">&#39;metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span>
                            <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">append_metric</span><span class="p">)</span>

                    <span class="c1"># @added 20180423 - Feature #2034: analyse_derivatives</span>
                    <span class="c1">#                   Branch #2270: luminosity</span>
                    <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># @added 20190105 - Bug #2792: webapp 500 error on no metric</span>
                    <span class="c1"># This needs to be set before the below conditional check</span>
                    <span class="c1"># otherwise webapp return a 500 server error instead of a</span>
                    <span class="c1"># 404 if the metric does not exist</span>
                    <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                        <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
                        <span class="c1"># for redis_ip, redis_port in settings.OTHER_SKYLINE_REDIS_INSTANCES:</span>
                        <span class="k">for</span> <span class="n">redis_ip</span><span class="p">,</span> <span class="n">redis_port</span><span class="p">,</span> <span class="n">redis_password</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found_in_other_redis</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
                                        <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_password</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">))</span>
                                    <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">other_redis_conn</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">other_unique_metrics</span><span class="p">:</span>
                                    <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> found in derivative_metrics in Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>

                    <span class="c1"># @added 20201127 - Feature #3824: get_cluster_data</span>
                    <span class="c1">#                   Feature #3820: HORIZON_SHARDS</span>
                    <span class="c1"># Change from the deprecated OTHER_SKYLINE_REDIS_INSTANCES</span>
                    <span class="c1"># to use the REMOTE_SKYLINE_INSTANCES and get_cluster_data</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                        <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;unique_metrics&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get unique_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">remote_unique_metrics</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote unique_metrics from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_unique_metrics</span><span class="p">)))</span>
                            <span class="n">unique_metrics_list</span> <span class="o">=</span> <span class="n">unique_metrics</span> <span class="o">+</span> <span class="n">remote_unique_metrics</span>
                            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_metrics_list</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric_found_in_other_redis</span><span class="p">:</span>
                        <span class="c1"># @added 20200715 - Task #3648: webapp - fp_search - do not use Redis metric check</span>
                        <span class="c1"># Do not use the Redis metric check result in a webapp</span>
                        <span class="c1"># fp_search request as this allows retried metric fps to</span>
                        <span class="c1"># accessed</span>
                        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_search&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;check request.args -  </span><span class="si">%s</span><span class="s1"> not in Redis, but fp_search request so continuing&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no metric (fp_search not in request.args) - </span><span class="si">%s</span><span class="s1"> - exists in Redis&#39;</span> <span class="o">%</span> <span class="n">metric_name</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                            <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                            <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                            <span class="c1"># return resp, 404</span>
                            <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;count_by_metric&#39;</span><span class="p">:</span>
                <span class="n">count_by_metric_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                    <span class="n">count_by_metric_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">count_by_metric_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">count_by_metric_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                    <span class="c1"># Return data</span>
                    <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_like&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">metric_namespace_pattern</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="n">metric_namespace_pattern</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_namespace_pattern</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                    <span class="c1"># @added 20220729 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">active_labelled_metrics_with_id</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.active_labelled_metrics_with_id&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">active_labelled_metrics_with_id</span><span class="p">:</span>
                            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="n">unique_metrics</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="k">del</span> <span class="n">active_labelled_metrics_with_id</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding </span><span class="si">%s</span><span class="s1"> unique_labelled_metrics to unique_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labelled_metrics</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get aet.metrics_manager.active_labelled_metrics_with_id from Redis&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

                    <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="k">if</span> <span class="n">metric_namespace_pattern</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no metric like - </span><span class="si">%s</span><span class="s1"> - exists in Redis&#39;</span> <span class="o">%</span> <span class="n">metric_namespace_pattern</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;from_timestamp&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">:</span>
                <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># unix timestamp</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># %Y%m%d %H:%M timestamp</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">value_strip_colon</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">value_strip_colon</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                    <span class="c1"># Return data</span>
                    <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;app&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;host&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
                <span class="n">limit_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">limit_is_not_numeric</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">limit_is_not_numeric</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">limit_is_not_numeric</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> must be a numeric value - requested </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># return resp, 400</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                <span class="n">new_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">valid_value</span> <span class="o">=</span> <span class="n">new_value</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">valid_value</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">valid_value</span> <span class="ow">and</span> <span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">501</span><span class="p">:</span>
                    <span class="n">limit_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">limit_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> must be &lt; 500 - requested </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># return resp, 400</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span>
                <span class="n">order_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;DESC&#39;</span><span class="p">:</span>
                    <span class="n">order_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;ASC&#39;</span><span class="p">:</span>
                    <span class="n">order_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">order_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> must be DESC or ASC&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># return resp, 400</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

    <span class="c1"># @added 20161127 - Branch #922: ionosphere</span>
    <span class="k">if</span> <span class="n">get_anomaly_id</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">panorama_data</span> <span class="o">=</span> <span class="n">panorama_request</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: query: </span><span class="si">%s</span><span class="s1">, panorama_data: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">panorama_data</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get panorama: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: duration - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">duration</span><span class="p">))</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">panorama_data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render panorama.html: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="k">if</span> <span class="n">request_args_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">panorama_data</span> <span class="o">=</span> <span class="n">panorama_request</span><span class="p">()</span>
            <span class="c1"># logger.info(&#39;panorama_data - %s&#39; % str(panorama_data))</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;panorama.html&#39;</span><span class="p">,</span> <span class="n">anomalies</span><span class="o">=</span><span class="n">panorama_data</span><span class="p">,</span> <span class="n">app_list</span><span class="o">=</span><span class="n">apps</span><span class="p">,</span>
                <span class="n">source_list</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span> <span class="n">algorithm_list</span><span class="o">=</span><span class="n">algorithms</span><span class="p">,</span>
                <span class="n">host_list</span><span class="o">=</span><span class="n">hosts</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="s1">&#39;Latest anomalies&#39;</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get panorama: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count_request</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;count_by_metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">count_by_metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count_by_metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count_by_metric</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">count_request</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">panorama_data</span> <span class="o">=</span> <span class="n">panorama_request</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_WEBAPP_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;panorama_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">panorama_data</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: query - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: panorama_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">panorama_data</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: skyline_version - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">skyline_version</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ENABLE_DEBUG or ENABLE_WEBAPP_DEBUG are not set in settings.py&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get panorama_request: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">results_string</span> <span class="o">=</span> <span class="s1">&#39;Found anomalies for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: duration - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">duration</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;panorama.html&#39;</span><span class="p">,</span> <span class="n">anomalies</span><span class="o">=</span><span class="n">panorama_data</span><span class="p">,</span> <span class="n">app_list</span><span class="o">=</span><span class="n">apps</span><span class="p">,</span>
                <span class="n">source_list</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span> <span class="n">algorithm_list</span><span class="o">=</span><span class="n">algorithms</span><span class="p">,</span>
                <span class="n">host_list</span><span class="o">=</span><span class="n">hosts</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">results_string</span><span class="p">,</span> <span class="n">count_request</span><span class="o">=</span><span class="n">count_request</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render panorama.html: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<span class="c1"># Feature #1448: Crucible web UI - @earthgecko</span>
<span class="c1"># Branch #868: crucible - @earthgecko</span>
<span class="c1"># This may actually need Django, perhaps this is starting to move outside the</span>
<span class="c1"># realms of Flask..</span>
<div class="viewcode-block" id="crucible"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.crucible">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/crucible&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">crucible</span><span class="p">():</span>

    <span class="n">crucible_web_ui_implemented</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">crucible_web_ui_implemented</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;uh_oh.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sorry the Crucible web UI is not completed yet&quot;</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;uh_oh.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sorry the Crucible web UI is not completed yet&quot;</span><span class="p">),</span> <span class="mi">200</span>
    <span class="c1"># @added 20200420 - Feature #1448: Crucible web UI</span>
    <span class="c1">#                   Branch #868: crucible</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">namespaces_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;graphite&#39;</span>
    <span class="n">alert_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_EXPIRY_TIME</span><span class="p">)</span>
    <span class="n">crucible_job_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metrics_submitted_to_process</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">process_metrics</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">job_submitted</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crucible_jobs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">crucible_jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">crucible_job_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">crucible_job_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crucible_job_metric</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crucible_job_details</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">completed_job</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">has_anomalies</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">skyline_anomalies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">skyline_consensus_anomalies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">image_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">image_file_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">graph_image_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">send_anomalies_panorama</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">send_to_panorama_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">sent_to_panorama</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">panorama_done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">panorama_done_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">panorama_done_user_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">skyline_consensus_anomalies_present</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># @added 20200421 - Feature #3500: webapp - crucible_process_metrics</span>
    <span class="c1">#                   Feature #1448: Crucible web UI</span>
    <span class="n">add_to_panorama</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">add_to_panorama_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @added 20200422 - Feature #3500: webapp - crucible_process_metrics</span>
    <span class="c1">#                   Feature #1448: Crucible web UI</span>
    <span class="n">pad_timeseries</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># @added 20200428 - Feature #3500: webapp - crucible_process_metrics</span>
    <span class="c1">#                   Feature #1448: Crucible web UI</span>
    <span class="c1"># Paginate crucible_jobs page as when there are 1000s of jobs this page</span>
    <span class="c1"># fails to load</span>
    <span class="n">pagination_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pagination_end</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">total_crucible_jobs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pagination_start_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">offset_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @added 20200607 - Feature #3630: webapp - crucible_process_training_data</span>
    <span class="n">training_data_json</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20200817 - Feature #3682: SNAB - webapp - crucible_process - run_algorithms</span>
    <span class="c1"># Allow the user to pass algorithms to run --&gt;</span>
    <span class="n">run_algorithms</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALGORITHMS</span>

    <span class="c1"># @added 20220610 - Feature #3500: webapp - crucible_process_metrics</span>
    <span class="n">summarise</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">request_args_len</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;process_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;process_metrics&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">process_metrics_request</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">process_metrics</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;crucible_job&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">crucible_job_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;crucible_job&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">crucible_job_request</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">crucible_job_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">process_metrics</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;send_anomalies_panorama&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">send_to_panorama_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;send_anomalies_panorama&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">send_to_panorama_request</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">send_anomalies_panorama</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">send_to_panorama_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">process_metrics</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">crucible_job_request</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">process_metrics</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20200428 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                   Feature #1448: Crucible web UI</span>
        <span class="c1"># Added paginate crucible_jobs page</span>
        <span class="k">if</span> <span class="s1">&#39;pagination_start&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">pagination_start_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pagination_start&#39;</span><span class="p">),</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pagination_start_request</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pagination_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pagination_start_request</span><span class="p">)</span>
                    <span class="n">pagination_start_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">pagination_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;offset&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">offset_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">),</span> <span class="s1">&#39;100&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">offset_request</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                    <span class="n">offset_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">if</span> <span class="n">crucible_job_request</span> <span class="ow">or</span> <span class="n">send_to_panorama_request</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;crucible_job_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">crucible_job_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;crucible_job_id&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">crucible_job_metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crucible_job_id</span> <span class="ow">and</span> <span class="n">crucible_job_metric</span><span class="p">:</span>
            <span class="n">crucible_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CRUCIBLE_DATA_FOLDER</span><span class="p">)</span>
            <span class="n">crucible_job_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/jobs/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_path</span><span class="p">,</span> <span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">crucible_job_metric</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">crucible_job_request</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_job request for crucible_job_id </span><span class="si">%s</span><span class="s1"> and metric </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">crucible_job_metric</span><span class="p">)))</span>
        <span class="n">crucible_job_details</span><span class="p">,</span> <span class="n">completed_job</span><span class="p">,</span> <span class="n">has_anomalies</span><span class="p">,</span> <span class="n">skyline_anomalies</span><span class="p">,</span> <span class="n">skyline_consensus_anomalies</span><span class="p">,</span> <span class="n">panorama_done</span><span class="p">,</span> <span class="n">panorama_done_timestamp</span><span class="p">,</span> <span class="n">panorama_done_user_id</span><span class="p">,</span> <span class="n">image_files</span><span class="p">,</span> <span class="n">image_file_names</span><span class="p">,</span> <span class="n">graph_image_file</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_crucible_job</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">crucible_job_metric</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">process_metrics</span> <span class="ow">or</span> <span class="n">send_anomalies_panorama</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authorization</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">username</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;Skyline&#39;</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Allow the user_id to be passed as a request argument</span>
        <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">user_id_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id_str</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: the /crucible user_id argument is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id_str</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;400 Bad Request - invalid user_id argument&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_details</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /crucible could not get_user_details(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: i - could not determine user_id&#39;</span><span class="p">,</span> <span class="mi">500</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/crucible get_user_details() with </span><span class="si">%s</span><span class="s1"> returned user id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /crucible get_user_details() with </span><span class="si">%s</span><span class="s1"> did not return an int&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">)))</span>
                    <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: i - user_id not int&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="k">if</span> <span class="n">process_metrics_request</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;process_metrics request&#39;</span><span class="p">)</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">namespaces_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;graphite&#39;</span>
        <span class="n">alert_interval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_EXPIRY_TIME</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;from_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If int is used it does not work</span>
                <span class="c1"># from_timestamp = request.args.get(int(&#39;from_timestamp&#39;), 0)</span>
                <span class="n">str_from_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">str_from_timestamp</span><span class="p">:</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_from_timestamp</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: from_timestamp argument is not an int&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request - from_timestamp argument is not an int&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;until_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">str_until_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">str_until_timestamp</span><span class="p">:</span>
                    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_until_timestamp</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: until_timestamp argument is not an int&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request - until_timestamp argument is not an int&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metrics&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;namespaces&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;namespaces&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;alert_interval&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">str_alert_interval</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;alert_interval&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">str_alert_interval</span><span class="p">:</span>
                    <span class="n">alert_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_alert_interval</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: alert_interval argument is not an int&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request - alert_interval argument is not an int&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="c1"># @added 20200421 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                   Feature #1448: Crucible web UI</span>
        <span class="c1"># Added add_to_panorama</span>
        <span class="k">if</span> <span class="s1">&#39;add_to_panorama&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">add_to_panorama_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;add_to_panorama&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_to_panorama_request</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">add_to_panorama</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">add_to_panorama</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># @added 20200422 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                   Feature #1448: Crucible web UI</span>
        <span class="k">if</span> <span class="s1">&#39;pad_timeseries&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">str_pad_timeseries</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pad_timeseries&#39;</span><span class="p">),</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">str_pad_timeseries</span><span class="p">:</span>
                <span class="n">pad_timeseries</span> <span class="o">=</span> <span class="n">str_pad_timeseries</span>

        <span class="c1"># @added 20200607 - Feature #3630: webapp - crucible_process_training_data</span>
        <span class="k">if</span> <span class="s1">&#39;training_data_json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>

            <span class="n">training_data_json</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;training_data_json&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># @added 20200817 - Feature #3682: SNAB - webapp - crucible_process - run_algorithms</span>
        <span class="c1"># Allow the user to pass run_algorithms to run</span>
        <span class="k">if</span> <span class="s1">&#39;run_algorithms&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">known_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;detect_drop_off_cliff&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">s_algorithm</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALGORITHMS</span><span class="p">:</span>
                <span class="n">known_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_algorithm</span><span class="p">)</span>
            <span class="c1"># @added 20220430 - Feature #4118: crucible - custom_algorithms</span>
            <span class="c1">#                   Feature #3566: custom_algorithms</span>
            <span class="k">for</span> <span class="n">s_algorithm</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CUSTOM_ALGORITHMS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">known_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_algorithm</span><span class="p">)</span>
            <span class="n">run_algorithms_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;run_algorithms&#39;</span><span class="p">),</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALGORITHMS</span><span class="p">)</span>
            <span class="n">run_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">run_algorithms_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">run_algorithms</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALGORITHMS</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">run_algorithms</span><span class="p">:</span>
                <span class="n">run_algorithms_list</span> <span class="o">=</span> <span class="n">run_algorithms_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_process_metrics - run_algorithms passed, generated run_algorithms_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_algorithms_list</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">run_algorithms_list</span><span class="p">:</span>
                    <span class="n">run_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">r_algorithm</span> <span class="ow">in</span> <span class="n">run_algorithms_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">r_algorithm</span> <span class="ow">in</span> <span class="n">known_algorithms</span><span class="p">:</span>
                            <span class="n">run_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_algorithm</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: crucible_process_metrics - run_algorithms passed, with invalid algorithm - </span><span class="si">%s</span><span class="s1">, excluding&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">r_algorithm</span><span class="p">))</span>

        <span class="c1"># @added 20220610 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1"># Added summarise option</span>
        <span class="k">if</span> <span class="s1">&#39;summarise&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">summarise_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summarise&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">summarise_str</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">summarise</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">summarise_str</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">summarise</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">do_process_metrics</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">from_timestamp</span> <span class="ow">and</span> <span class="n">until_timestamp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">do_process_metrics</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metrics_list</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_process_metrics - metrics_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">namespaces</span><span class="p">:</span>
                <span class="n">do_process_metrics</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">namespaces_list</span> <span class="o">=</span> <span class="n">namespaces</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_process_metrics namespaces_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespaces_list</span><span class="p">))</span>

        <span class="c1"># @added 20200607 - Feature #3630: webapp - crucible_process_training_data</span>
        <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span> <span class="ow">and</span> <span class="n">training_data_json</span><span class="p">:</span>
            <span class="n">do_process_metrics</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">crucible_job_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metrics_submitted_to_process</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">do_process_metrics</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20200421 - Feature #3500: webapp - crucible_process_metrics</span>
                <span class="c1">#                      Feature #1448: Crucible web UI</span>
                <span class="c1"># Added add_to_panorama</span>
                <span class="c1"># crucible_job_id, metrics_submitted_to_process, message, trace = submit_crucible_job(from_timestamp, until_timestamp, metrics_list, namespaces_list, source, alert_interval, user_id, user)</span>
                <span class="c1"># @modified 20200422 - Feature #3500: webapp - crucible_process_metrics</span>
                <span class="c1">#                      Feature #1448: Crucible web UI</span>
                <span class="c1"># Added pad_timeseries</span>
                <span class="c1"># @added 20200607 - Feature #3630: webapp - crucible_process_training_data</span>
                <span class="c1"># Added training_data_json</span>
                <span class="c1"># @modified 20200817 - Feature #3682: SNAB - webapp - crucible_process - run_algorithms</span>
                <span class="c1"># Allow the user to pass run_algorithms to run</span>
                <span class="c1"># @modified 20220610 - Feature #3500: webapp - crucible_process_metrics</span>
                <span class="c1"># Added summarise option</span>
                <span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">metrics_submitted_to_process</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">submit_crucible_job</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">metrics_list</span><span class="p">,</span> <span class="n">namespaces_list</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">alert_interval</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">add_to_panorama</span><span class="p">,</span> <span class="n">pad_timeseries</span><span class="p">,</span> <span class="n">training_data_json</span><span class="p">,</span> <span class="n">run_algorithms</span><span class="p">,</span> <span class="n">summarise</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_process_metrics - submit_crucible_job returned (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_submitted_to_process</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trace</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using submit_crucible_job(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">namespaces_list</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert_interval</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">crucible_job_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">job_submitted</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">send_to_panorama_request</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;send_anomalies_panorama request&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;send_anomalies_panorama request for crucible_job_id </span><span class="si">%s</span><span class="s1"> and metric </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">crucible_job_metric</span><span class="p">)))</span>
        <span class="n">crucible_job_details</span><span class="p">,</span> <span class="n">completed_job</span><span class="p">,</span> <span class="n">has_anomalies</span><span class="p">,</span> <span class="n">skyline_anomalies</span><span class="p">,</span> <span class="n">skyline_consensus_anomalies</span><span class="p">,</span> <span class="n">panorama_done</span><span class="p">,</span> <span class="n">panorama_done_timestamp</span><span class="p">,</span> <span class="n">panorama_done_user_id</span><span class="p">,</span> <span class="n">image_files</span><span class="p">,</span> <span class="n">image_file_names</span><span class="p">,</span> <span class="n">graph_image_file</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_crucible_job</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">crucible_job_metric</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sent_to_panorama</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">send_crucible_job_metric_to_panorama</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">crucible_job_metric</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">skyline_consensus_anomalies</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;send_anomalies_panorama request sent </span><span class="si">%s</span><span class="s1"> anomalies to Panorama&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sent_to_panorama</span><span class="p">))</span>
            <span class="n">crucible_job_request</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_crucible_jobs&#39;</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">process_metrics_request</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">crucible_job_request</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">send_to_panorama_request</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_jobs_list request&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">crucible_jobs_list</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_crucible_jobs</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_jobs_list determined&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_crucible_jobs&#39;</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crucible_jobs_list</span><span class="p">:</span>

            <span class="c1"># @added 20200428 - Feature #3500: webapp - crucible_process_metrics</span>
            <span class="c1">#                   Feature #1448: Crucible web UI</span>
            <span class="c1"># Added pagination to crucible_jobs page</span>
            <span class="n">sorted_crucible_jobs_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">crucible_jobs_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># sorted_crucible_jobs = sorted(crucible_jobs, key=lambda x: x[8])</span>
            <span class="n">sorted_crucible_jobs_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">total_crucible_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">crucible_jobs_list</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_jobs_list has a total of </span><span class="si">%s</span><span class="s1"> jobs&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">total_crucible_jobs</span><span class="p">)))</span>
            <span class="n">paginated_crucible_jobs_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pagination_end</span> <span class="o">=</span> <span class="n">pagination_start</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">sorted_crucible_jobs_list</span><span class="p">[</span><span class="n">pagination_start</span><span class="p">:</span><span class="n">pagination_end</span><span class="p">]:</span>
                <span class="n">paginated_crucible_jobs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_jobs_list paginated from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">pagination_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">pagination_end</span><span class="p">)))</span>
            <span class="k">del</span> <span class="n">sorted_crucible_jobs_list</span>

            <span class="c1"># @modified 20200428 - Feature #3500: webapp - crucible_process_metrics</span>
            <span class="c1">#                      Feature #1448: Crucible web UI</span>
            <span class="c1"># Added pagination to crucible_jobs page</span>
            <span class="c1"># for metric_name, root, crucible_job_id, human_date, completed_job, has_anomalies, panorama_done, skyline_consensus_anomalies_present in crucible_jobs_list:</span>
            <span class="n">job_list_item</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">human_date</span><span class="p">,</span> <span class="n">completed_job</span><span class="p">,</span> <span class="n">has_anomalies</span><span class="p">,</span> <span class="n">panorama_done</span><span class="p">,</span> <span class="n">skyline_consensus_anomalies_present</span> <span class="ow">in</span> <span class="n">paginated_crucible_jobs_list</span><span class="p">:</span>
                <span class="n">crucible_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">human_date</span><span class="p">,</span> <span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">completed_job</span><span class="p">,</span> <span class="n">has_anomalies</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">panorama_done</span><span class="p">,</span> <span class="n">skyline_consensus_anomalies_present</span><span class="p">,</span> <span class="n">job_list_item</span><span class="p">])</span>
                <span class="n">job_list_item</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">del</span> <span class="n">paginated_crucible_jobs_list</span>

            <span class="k">if</span> <span class="n">crucible_jobs</span><span class="p">:</span>
                <span class="n">sorted_crucible_jobs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">crucible_jobs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># sorted_crucible_jobs = sorted(crucible_jobs, key=lambda x: x[8])</span>
                <span class="n">crucible_jobs</span> <span class="o">=</span> <span class="n">sorted_crucible_jobs</span>
                <span class="n">crucible_jobs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">sorted_crucible_jobs</span>
            <span class="k">del</span> <span class="n">crucible_jobs_list</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;crucible.html&#39;</span><span class="p">,</span> <span class="n">process_metrics</span><span class="o">=</span><span class="n">process_metrics</span><span class="p">,</span>
        <span class="n">crucible_job_id</span><span class="o">=</span><span class="n">crucible_job_id</span><span class="p">,</span>
        <span class="n">from_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="n">until_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span>
        <span class="n">metrics</span><span class="o">=</span><span class="n">metrics_list</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces_list</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
        <span class="n">alert_interval</span><span class="o">=</span><span class="n">alert_interval</span><span class="p">,</span> <span class="n">job_submitted</span><span class="o">=</span><span class="n">job_submitted</span><span class="p">,</span>
        <span class="n">metrics_submitted_to_process</span><span class="o">=</span><span class="n">metrics_submitted_to_process</span><span class="p">,</span>
        <span class="n">crucible_jobs</span><span class="o">=</span><span class="n">crucible_jobs</span><span class="p">,</span> <span class="n">crucible_job</span><span class="o">=</span><span class="n">crucible_job_request</span><span class="p">,</span>
        <span class="n">crucible_job_dir</span><span class="o">=</span><span class="n">crucible_job_dir</span><span class="p">,</span>
        <span class="n">crucible_job_metric</span><span class="o">=</span><span class="n">crucible_job_metric</span><span class="p">,</span>
        <span class="n">crucible_job_details</span><span class="o">=</span><span class="n">crucible_job_details</span><span class="p">,</span> <span class="n">completed_job</span><span class="o">=</span><span class="n">completed_job</span><span class="p">,</span>
        <span class="n">has_anomalies</span><span class="o">=</span><span class="n">has_anomalies</span><span class="p">,</span> <span class="n">skyline_anomalies</span><span class="o">=</span><span class="n">skyline_anomalies</span><span class="p">,</span>
        <span class="n">skyline_consensus_anomalies</span><span class="o">=</span><span class="n">skyline_consensus_anomalies</span><span class="p">,</span>
        <span class="n">skyline_consensus_anomalies_present</span><span class="o">=</span><span class="n">skyline_consensus_anomalies_present</span><span class="p">,</span>
        <span class="n">sent_to_panorama</span><span class="o">=</span><span class="n">sent_to_panorama</span><span class="p">,</span> <span class="n">panorama_done</span><span class="o">=</span><span class="n">panorama_done</span><span class="p">,</span>
        <span class="n">panorama_done_timestamp</span><span class="o">=</span><span class="n">panorama_done_timestamp</span><span class="p">,</span>
        <span class="n">panorama_done_user_id</span><span class="o">=</span><span class="n">panorama_done_user_id</span><span class="p">,</span>
        <span class="n">image_files</span><span class="o">=</span><span class="n">image_files</span><span class="p">,</span> <span class="n">image_file_names</span><span class="o">=</span><span class="n">image_file_names</span><span class="p">,</span>
        <span class="n">graph_image_file</span><span class="o">=</span><span class="n">graph_image_file</span><span class="p">,</span>
        <span class="n">crucible_enabled</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_CRUCIBLE</span><span class="p">,</span>
        <span class="c1"># @added 20200428 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                   Feature #1448: Crucible web UI</span>
        <span class="c1"># Added pagination to crucible_jobs page</span>
        <span class="n">pagination_start</span><span class="o">=</span><span class="n">pagination_start</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
        <span class="n">pagination_end</span><span class="o">=</span><span class="n">pagination_end</span><span class="p">,</span>
        <span class="n">total_crucible_jobs</span><span class="o">=</span><span class="n">total_crucible_jobs</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span></div>


<span class="c1"># @added 20161123 - Branch #922: ionosphere</span>
<span class="c1"># @modified 20221018 - Feature #4650: ionosphere.bulk.training</span>
<span class="c1"># Added POST</span>
<span class="c1"># @app.route(&#39;/ionosphere&#39;, methods=[&#39;GET&#39;])</span>
<div class="viewcode-block" id="ionosphere"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.ionosphere">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/ionosphere&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">ionosphere</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_ENABLED</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;uh_oh.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Ionosphere is not enabled, please see the Ionosphere section in the docs and settings.py&quot;</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># @added 20190919 - Feature #3230: users DB table</span>
    <span class="c1">#                   Ideas #2476: Label and relate anomalies</span>
    <span class="c1">#                   Feature #2516: Add label to features profile</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authorization</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">username</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;Skyline&#39;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># @added 20201210 - Feature #3824: get_cluster_data</span>
    <span class="k">if</span> <span class="n">AUTH_DEBUG</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: auth debug - username - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error ::auth debug - username&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: auth debug - password - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">password</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error ::auth debug - password&#39;</span><span class="p">)</span>

    <span class="c1"># @added 20191211 - Feature #3230: users DB table</span>
    <span class="c1">#                   Ideas #2476: Label and relate anomalies</span>
    <span class="c1">#                   Feature #2516: Add label to features profile</span>
    <span class="c1"># Allow the user_id to be passed as a request argument</span>
    <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">user_id_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id_str</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: the /ionosphere user_id argument is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id_str</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;400 Bad Request - invalid user_id argument&#39;</span><span class="p">,</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_details</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /ionosphere could not get_user_details(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: i - could not determine user_id&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/ionosphere get_user_details() with </span><span class="si">%s</span><span class="s1"> returned user id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /ionosphere get_user_details() with </span><span class="si">%s</span><span class="s1"> did not return an int&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">)))</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: i - user_id not int&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
    <span class="n">request_id_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
    <span class="n">request_id</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">request_id_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting ionosphere request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request.url: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
    <span class="c1"># logger.debug(&#39;request.args: %s&#39; % str(request.args))</span>

    <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">request_args_len</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

    <span class="c1"># @added 20180419 - Feature #1996: Ionosphere - matches page</span>
    <span class="c1">#                   Branch #2270: luminosity</span>
    <span class="c1"># Change the default search parameters to return all matches for the</span>
    <span class="c1"># past 24 hours</span>
    <span class="n">matched_request_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">default_matched_from_timestamp</span> <span class="o">=</span> <span class="n">matched_request_timestamp</span> <span class="o">-</span> <span class="mi">86400</span>
    <span class="n">matched_from_datetime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">default_matched_from_timestamp</span><span class="p">))</span>

    <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
    <span class="c1"># Added ionosphere_echo</span>
    <span class="n">echo_hdate</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># @added 20210417 - Feature #4014: Ionosphere - inference</span>
    <span class="c1">#                   Branch #3590: inference</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">top_matches</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_distance</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">saved_training_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20210727 - Feature #4206: webapp - saved_training_data page</span>
    <span class="n">ionosphere_saved_training_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20210415 - Feature #4014: Ionosphere - inference</span>
    <span class="c1">#                   Branch #3590: inference</span>
    <span class="n">motif_analysis_images</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">motif_analysis</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20210419 - Feature #4014: Ionosphere - inference</span>
    <span class="n">inference_match_motif_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">inference_match_motif_image</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20210422 - Feature #4014: Ionosphere - inference</span>
    <span class="c1"># Allow user to specify the range_padding</span>
    <span class="n">motif_range_padding</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20210425 - Feature #4014: Ionosphere - inference</span>
    <span class="c1"># Allow user to specify the difference between the areas under the</span>
    <span class="c1"># curve</span>
    <span class="n">motif_max_area_percent_diff</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20220822 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="n">valid_length_for_training</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># @added 20221018 - Feature #4650: ionosphere.bulk.training</span>
    <span class="n">bulk_training</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20220729 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="c1"># Look up base_name for labelled_metrics and determine base_name if the</span>
    <span class="c1"># metric_id is passed.</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">request_args_present</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">passed_metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">passed_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">passed_metric</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;passed labelled_metric_name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">labelled_metric_name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_id_str</span> <span class="o">=</span> <span class="n">labelled_metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">metric_id_str</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">metric_id_str</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine metric_id from passed_metric: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">passed_metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;metric_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">passed_metric_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">passed_metric_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">passed_metric_id</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;passed metric_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine valid metric_id from passed_metric_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">passed_metric_id</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">get_base_name_from_metric_id</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;base_name looked up for metric_id: </span><span class="si">%s</span><span class="s1">, base_name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="n">base_name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">base_name</span> <span class="ow">and</span> <span class="s1">&#39;}&#39;</span> <span class="ow">in</span> <span class="n">base_name</span> <span class="ow">and</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                        <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;determined labelled_metric_name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">labelled_metric_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_metric_id failed with metric_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">labelled_metric_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">labelled_metric_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_name</span><span class="p">:</span>
                    <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_base_name</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;base_name looked up from labelled_metric_name: </span><span class="si">%s</span><span class="s1">, base_name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="n">base_name</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metric_base_name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">labelled_metric_base_name</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

    <span class="c1"># @added 20221018 - Feature #4650: ionosphere.bulk.training</span>
    <span class="k">if</span> <span class="s1">&#39;bulk_training&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">bulk_training</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">trained</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">training_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;trained&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;trained&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                    <span class="n">trained</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;trained&#39;</span><span class="p">]</span>
        <span class="n">use_format</span> <span class="o">=</span> <span class="s1">&#39;html&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;format&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">use_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;trained&quot;</span><span class="p">:</span> <span class="n">trained</span><span class="p">}}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bulk_training returned json&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trained</span><span class="p">:</span>
            <span class="c1"># training_data = api_get_bulk_training_data(skyline_app)</span>
            <span class="n">training_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">bulk_training</span><span class="o">=</span><span class="n">bulk_training</span><span class="p">,</span> <span class="n">training_data</span><span class="o">=</span><span class="n">training_data</span><span class="p">,</span>
            <span class="n">trained</span><span class="o">=</span><span class="n">trained</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># This allows to plot best first, just makes an ordered list of the motif_id</span>
    <span class="c1"># in the dict ordered by dist, just to add some order to a dict :)</span>
    <span class="n">motif_analysis_motif_id_by_distance</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">motif_analysis_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;motif_analysis&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">MOTIF_ANALYSIS_ARGS</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;motif_analysis&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;requested_timestamp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;similarity&#39;</span><span class="p">,</span> <span class="s1">&#39;purge&#39;</span><span class="p">,</span>
            <span class="c1"># @added 20210417 - Feature #4014: Ionosphere - inference</span>
            <span class="c1"># Allow the user to define the batch_size per similarity search</span>
            <span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="s1">&#39;top_matches&#39;</span><span class="p">,</span> <span class="s1">&#39;max_distance&#39;</span><span class="p">,</span>
            <span class="c1"># @added 20210418 - Feature #4014: Ionosphere - inference</span>
            <span class="c1"># Allow for the similarity search on saved_training_data</span>
            <span class="s1">&#39;saved_training_data&#39;</span><span class="p">,</span>
            <span class="c1"># @added 20210422 - Feature #4014: Ionosphere - inference</span>
            <span class="c1"># Allow user to specify the range_padding</span>
            <span class="s1">&#39;range_padding&#39;</span><span class="p">,</span>
            <span class="c1"># @added 20210425 - Feature #4014: Ionosphere - inference</span>
            <span class="c1"># Allow user to specify the difference between the areas under the</span>
            <span class="c1"># curve</span>
            <span class="s1">&#39;max_area_percent_diff&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">motif_purge</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MOTIF_ANALYSIS_ARGS</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - not in MOTIF_ANALYSIS_ARGS&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;requested_timestamp&#39;</span><span class="p">:</span>
                <span class="n">requested_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;similarity&#39;</span><span class="p">:</span>
                <span class="n">similarity</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;purge&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">motif_purge</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># @added 20210417 - Feature #4014: Ionosphere - inference</span>
            <span class="c1"># Allow the user to define the batch_size per similarity search</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span>
                <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;top_matches&#39;</span><span class="p">:</span>
                <span class="n">top_matches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;max_distance&#39;</span><span class="p">:</span>
                <span class="n">max_distance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># @added 20210418 - Feature #4014: Ionosphere - inference</span>
            <span class="c1"># Allow for the similarity search on saved_training_data</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;saved_training_data&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">saved_training_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># @added 20210422 - Feature #4014: Ionosphere - inference</span>
            <span class="c1"># Allow user to specify the range_padding</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;range_padding&#39;</span><span class="p">:</span>
                <span class="n">motif_range_padding</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># @added 20210425 - Feature #4014: Ionosphere - inference</span>
            <span class="c1"># Allow user to specify the difference between the areas under the</span>
            <span class="c1"># curve</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;max_area_percent_diff&#39;</span><span class="p">:</span>
                <span class="n">max_area_percent_diff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">similarity</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">batch_size</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">top_matches</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">max_distance</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">motif_range_padding</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">max_area_percent_diff</span><span class="p">:</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
        <span class="c1"># Use previous if they exist</span>
        <span class="n">motif_metricname_dir</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="c1"># @modified 20210419 - Feature #4014: Ionosphere - inference</span>
        <span class="c1"># Create a unique dir for each batch_size, top_matches and max_distance</span>
        <span class="c1"># motif_metric_dir = &#39;%s/%s/%s/motifs&#39; % (</span>
        <span class="c1">#     settings.IONOSPHERE_DATA_FOLDER, str(timestamp), motif_metricname_dir)</span>
        <span class="n">motif_metric_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/motifs/batch_size.</span><span class="si">%s</span><span class="s1">/top_matches.</span><span class="si">%s</span><span class="s1">/max_distance.</span><span class="si">%s</span><span class="s1">/range_padding.</span><span class="si">%s</span><span class="s1">/max_area_percent_diff.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span>
            <span class="n">motif_metricname_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_size</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">top_matches</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">max_distance</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">motif_range_padding</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">max_area_percent_diff</span><span class="p">))</span>

        <span class="c1"># @added 20210418 - Feature #4014: Ionosphere - inference</span>
        <span class="c1"># Allow for the similarity search on saved_training_data</span>
        <span class="k">if</span> <span class="n">saved_training_data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># saved_motif_metric_dir = &#39;%s_saved/%s/%s/motifs&#39; % (</span>
                <span class="c1">#    settings.IONOSPHERE_DATA_FOLDER, str(timestamp), motif_metricname_dir)</span>
                <span class="n">saved_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_saved&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span>
                <span class="n">saved_motif_metric_dir</span> <span class="o">=</span> <span class="n">motif_metric_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="n">saved_data_dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saved_motif_metric_dir</span><span class="p">):</span>
                    <span class="n">motif_metric_dir</span> <span class="o">=</span> <span class="n">saved_motif_metric_dir</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;motif_analysis - using saved training_data dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">saved_motif_metric_dir</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: saved_training_data dir not found - </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span> <span class="n">motif_metricname_dir</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

        <span class="c1"># @modified 20210419 - Feature #4014: Ionosphere - inference</span>
        <span class="c1"># Create a unique dir for each batch_size, top_matches and max_distance</span>
        <span class="c1"># metric_motif_analysis_file = &#39;%s/motif.analysis.%s.%s.%s.dict&#39; % (</span>
        <span class="c1">#     motif_metric_dir, similarity, str(batch_size), str(max_distance))</span>
        <span class="n">metric_motif_analysis_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/motif.analysis.similarity_</span><span class="si">%s</span><span class="s1">.batch_size_</span><span class="si">%s</span><span class="s1">.top_matches_</span><span class="si">%s</span><span class="s1">.max_distance_</span><span class="si">%s</span><span class="s1">.range_padding_</span><span class="si">%s</span><span class="s1">.max_area_percent_diff_</span><span class="si">%s</span><span class="s1">.dict&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">motif_metric_dir</span><span class="p">,</span> <span class="n">similarity</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_size</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">top_matches</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">max_distance</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">motif_range_padding</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">max_area_percent_diff</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">motif_purge</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">motif_metric_dir</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rmtree</span><span class="p">(</span><span class="n">motif_metric_dir</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;motif_analysis - purge true - removed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">motif_metric_dir</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: motif_analysis - purge true - failed to rmtree </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">motif_metric_dir</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_motif_analysis_file</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_motif_analysis_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">motif_analysis_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">motif_analysis</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">motif_analysis_str</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to evaluate motif_analysis from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_motif_analysis_file</span><span class="p">)</span>
                <span class="n">motif_analysis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no previous motif_analysis file found </span><span class="si">%s</span><span class="s1">, running analysis&#39;</span> <span class="o">%</span> <span class="n">metric_motif_analysis_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">motif_analysis</span><span class="p">:</span>
            <span class="c1"># @modified 20210417 - Feature #4014: Ionosphere - inference</span>
            <span class="c1"># Allow the user to define the batch_size per similarity search</span>
            <span class="c1"># @modified 20210425 - Feature #4014: Ionospher - inference</span>
            <span class="c1"># Added max_area_percent_diff</span>
            <span class="n">motif_analysis</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">on_demand_motif_analysis</span><span class="p">(</span>
                <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">similarity</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">top_matches</span><span class="p">,</span>
                <span class="n">max_distance</span><span class="p">,</span> <span class="n">motif_range_padding</span><span class="p">,</span> <span class="n">max_area_percent_diff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;previous motif_analysis loaded from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_motif_analysis_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">motif_analysis</span><span class="p">:</span>
            <span class="n">motif_ids_found</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">motif_analysis</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;motifs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">motif_id_and_distance</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">motif_id_found</span> <span class="ow">in</span> <span class="n">motif_ids_found</span><span class="p">:</span>
                <span class="n">motif_id_and_distance</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">motif_id_found</span><span class="p">,</span> <span class="n">motif_analysis</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;motifs&#39;</span><span class="p">][</span><span class="n">motif_id_found</span><span class="p">][</span><span class="s1">&#39;distance&#39;</span><span class="p">]])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">motif_analysis</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;motifs&#39;</span><span class="p">][</span><span class="n">motif_id_found</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">]:</span>
                        <span class="n">motif_analysis_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motif_analysis</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;motifs&#39;</span><span class="p">][</span><span class="n">motif_id_found</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to append motif to motif_id_and_distance for motif_id_found: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">motif_id_found</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">ordered_motif_id_by_distance</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">motif_id_and_distance</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">all_motif_analysis_motif_id_by_distance</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ordered_motif_id_by_distance</span><span class="p">]</span>
            <span class="c1"># Now only add the one which have images</span>
            <span class="k">for</span> <span class="n">motif_id_found</span> <span class="ow">in</span> <span class="n">all_motif_analysis_motif_id_by_distance</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">has_image</span> <span class="o">=</span> <span class="n">motif_analysis</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;motifs&#39;</span><span class="p">][</span><span class="n">motif_id_found</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">has_image</span> <span class="ow">in</span> <span class="n">motif_analysis_images</span><span class="p">:</span>
                        <span class="n">motif_analysis_motif_id_by_distance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motif_id_found</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># logger.error(traceback.format_exc())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to evaluate if has image for motif_id_found: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">motif_id_found</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
        <span class="c1"># logger.debug(&#39;debug :: motif_analysis_motif_id_by_distance: %s&#39; % str(motif_analysis_motif_id_by_distance))</span>
        <span class="c1"># logger.debug(&#39;debug :: motif_analysis: %s&#39; % str(motif_analysis))</span>

    <span class="c1"># @added 20210413 - Feature #4014: Ionosphere - inference</span>
    <span class="c1">#                   Branch #3590: inference</span>
    <span class="n">motif_matches_req</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;motif_matches&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">motif_matches_req</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">MOTIF_MATCHES_ARGS</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;motif_matches&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_like&#39;</span><span class="p">,</span> <span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;validated_equals&#39;</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span>
            <span class="s1">&#39;primary_match&#39;</span><span class="p">,</span>
            <span class="c1"># @added 20210415 - Feature #4014: Ionosphere - inference</span>
            <span class="c1">#                   Branch #3590: inference</span>
            <span class="s1">&#39;sort_by&#39;</span><span class="p">,</span> <span class="s1">&#39;order_by&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metric_like</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>

        <span class="c1"># Validate a metric or metric_like parameter with all known metrics in</span>
        <span class="c1"># the DB not just Redis.  These parameters are validated as they are</span>
        <span class="c1"># passed to a database query in get_matched_motifs</span>
        <span class="n">known_db_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">known_db_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.metrics_manager.db.metric_names&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to known_db_metrics from Redis set aet.analyzer.metrics_manager.db.metric_names - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MOTIF_MATCHES_ARGS</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="n">metric_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_str</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric_str</span> <span class="ow">in</span> <span class="n">known_db_metrics</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="n">metric_str</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_like&#39;</span><span class="p">:</span>
                <span class="n">metric_like_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_like_str</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">metric_like</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">metric_like_namespace_str</span> <span class="o">=</span> <span class="n">metric_like_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="n">known_db_metrics</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric_like_namespace_str</span> <span class="ow">in</span> <span class="n">i_metric</span><span class="p">:</span>
                            <span class="n">metric_like</span> <span class="o">=</span> <span class="n">metric_like_str</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;from_timestamp&#39;</span><span class="p">:</span>
                <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">:</span>
                <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;validated_equals&#39;</span><span class="p">:</span>
                <span class="n">validated_equals</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span>
                <span class="nb">format</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># @added 20210415 - Feature #4014: Ionosphere - inference</span>
            <span class="c1">#                   Branch #3590: inference</span>
            <span class="c1"># Allow to sort_by, to enable sorting by distance as the larger the distance</span>
            <span class="c1"># the less similar</span>
            <span class="n">sort_by</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">valid_sort_by_columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_id&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_id&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span>
                <span class="s1">&#39;size&#39;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;sort_by&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">sort_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sort_by&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sort_by</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                    <span class="n">sort_by</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">sort_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_sort_by_columns</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
            <span class="k">if</span> <span class="s1">&#39;order_by&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">valid_order_by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DESC&#39;</span><span class="p">,</span> <span class="s1">&#39;ASC&#39;</span><span class="p">]</span>
                <span class="n">order_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_by&#39;</span><span class="p">,</span> <span class="s1">&#39;DESC&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">order_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_order_by</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

        <span class="n">matched_motifs</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_matched_motifs</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_like</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">matched_motifs</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;metric_like&quot;</span><span class="p">:</span> <span class="n">metric_like</span><span class="p">,</span> <span class="s2">&quot;matched_motifs&quot;</span><span class="p">:</span> <span class="n">matched_motifs</span><span class="p">}}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_motifs</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">204</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;metric_like&quot;</span><span class="p">:</span> <span class="n">metric_like</span><span class="p">,</span> <span class="s2">&quot;matched_motifs&quot;</span><span class="p">:</span> <span class="n">matched_motifs</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no data for query&quot;</span><span class="p">}}</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ionosphere motif_matches returned json with </span><span class="si">%s</span><span class="s1"> matched_motifs elements listed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_motifs</span><span class="p">)))</span>
            <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">motif_matches</span><span class="o">=</span><span class="n">motif_matches_req</span><span class="p">,</span>
            <span class="n">matched_motifs</span><span class="o">=</span><span class="n">matched_motifs</span><span class="p">,</span> <span class="n">for_metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
            <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20180812 - Feature #2430: Ionosphere validate learnt features profiles page</span>
    <span class="n">features_profiles_to_validate</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fp_validate_req</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;fp_validate&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">fp_validate_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_validate&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fp_validate_req</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">fp_validate_req</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">fp_validate_req</span><span class="p">:</span>
        <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
        <span class="c1"># timestamp = False</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># @added 20181013 - Feature #2430: Ionosphere validate learnt features profiles page</span>
        <span class="c1"># Added the validate_all context and function</span>
        <span class="n">validate_all</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">all_validated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># metric_id = False</span>
        <span class="n">validated_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

            <span class="c1"># @added 20181013 - Feature #2430: Ionosphere validate learnt features profiles page</span>
            <span class="c1"># Added the validate_all context and function</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;validate_all&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">validate_all</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;all_validated&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">all_validated</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Ensure that validate_all is set to False so another call</span>
                    <span class="c1"># is not made to the validate_all function</span>
                    <span class="n">validate_all</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_id&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: the metric_id request parameter was passed but is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;validated_count&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="n">validated_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: the validated_count request parameter was passed but is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;DESC&#39;</span><span class="p">:</span>
                    <span class="n">ordered_by</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;ASC&#39;</span><span class="p">:</span>
                    <span class="n">ordered_by</span> <span class="o">=</span> <span class="s1">&#39;ASC&#39;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span>
                    <span class="n">limited_by</span> <span class="o">=</span> <span class="n">test_limit</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: limit is not an integer - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>
                    <span class="n">limited_by</span> <span class="o">=</span> <span class="s1">&#39;30&#39;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">base_name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
                    <span class="n">limited_by</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">ordered_by</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>

                <span class="c1"># @added 20210710 - Bug #4168: webapp/ionosphere_backend.py - handle old features profile dir not been found</span>
                <span class="c1"># Check all known metrics not just those in Redis</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found</span><span class="p">:</span>
                    <span class="n">metric_names</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_names</span> <span class="o">=</span> <span class="n">get_all_db_metric_names</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get_all_db_metric_names - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">metric_names</span><span class="p">:</span>
                        <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">metric_name</span> <span class="o">=</span> <span class="n">base_name</span>

                <span class="c1"># @added 20220729 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Handle labelled_metrics</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found</span> <span class="ow">and</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">labelled_metric_base_name</span> <span class="ow">in</span> <span class="n">metric_names</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> found in in DB metrics list&#39;</span> <span class="o">%</span> <span class="n">labelled_metric_base_name</span><span class="p">)</span>
                        <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_base_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found</span><span class="p">:</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="n">base_name</span>
                    <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
                    <span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
                    <span class="c1"># Roll back change - breaking existing metrics with colons</span>
                    <span class="c1"># metric_name = url_encode_metric_name(metric_name)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                        <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># @added 20180423 - Feature #2034: analyse_derivatives</span>
                    <span class="c1">#                   Branch #2270: luminosity</span>
                    <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                        <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
                        <span class="c1"># for redis_ip, redis_port in settings.OTHER_SKYLINE_REDIS_INSTANCES:</span>
                        <span class="k">for</span> <span class="n">redis_ip</span><span class="p">,</span> <span class="n">redis_port</span><span class="p">,</span> <span class="n">redis_password</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found_in_other_redis</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
                                        <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_password</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">))</span>
                                    <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">other_redis_conn</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">other_unique_metrics</span><span class="p">:</span>
                                    <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> found in derivative_metrics in Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">metric_found</span><span class="p">:</span>

            <span class="c1"># @added 20181013 - Feature #2430: Ionosphere validate learnt features profiles page</span>
            <span class="c1"># Added the validate_all context and function, first do the</span>
            <span class="c1"># validate_all if it has been passed</span>
            <span class="k">if</span> <span class="n">validate_all</span> <span class="ow">and</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="n">features_profiles_to_validate_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">features_profiles_to_validate</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_features_profiles_to_validate</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="n">features_profiles_to_validate_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_profiles_to_validate</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> features profiles found that need validating for </span><span class="si">%s</span><span class="s1"> with metric_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">features_profiles_to_validate_count</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_features_profiles_to_validate(</span><span class="si">%s</span><span class="s1">) with metric_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">features_profiles_to_validate_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20190919 - Feature #3230: users DB table</span>
                        <span class="c1">#                      Ideas #2476: Label and relate anomalies</span>
                        <span class="c1">#                      Feature #2516: Add label to features profile</span>
                        <span class="c1"># Added user_id</span>
                        <span class="c1"># all_validated, fail_msg, traceback_format_exc = validate_fp(int(metric_id), &#39;metric_id&#39;)</span>
                        <span class="n">all_validated</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">validate_fp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="s1">&#39;metric_id&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validated all the enabled, unvalidated features profiles for metric_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">all_validated</span><span class="p">:</span>
                            <span class="n">validated_count</span> <span class="o">=</span> <span class="n">features_profiles_to_validate_count</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_features_profiles_to_validate(</span><span class="si">%s</span><span class="s1">) with metric_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="n">features_profiles_to_validate</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">metric_name</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">features_profiles_to_validate</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_features_profiles_to_validate</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="c1"># features_profiles_to_validate</span>
                    <span class="c1"># [ fp_id, metric_id, metric, full_duration, anomaly_timestamp,</span>
                    <span class="c1">#   fp_parent_id, parent_full_duration, parent_anomaly_timestamp,</span>
                    <span class="c1">#   fp_date, fp_graph_uri, parent_fp_date, parent_fp_graph_uri,</span>
                    <span class="c1">#   parent_prent_fp_id, fp_learn_graph_uri, parent_fp_learn_graph_uri,</span>
                    <span class="c1">#   minimum_full_duration, maximum_full_duration]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> features profiles found that need validating for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features_profiles_to_validate</span><span class="p">)),</span> <span class="n">base_name</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_features_profiles_to_validate(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">default_learn_full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_FULL_DURATION_DAYS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">default_learn_full_duration</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
            <span class="n">metrics_with_features_profiles_to_validate</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">features_profiles_to_validate</span><span class="p">:</span>
                <span class="c1"># metrics_with_features_profiles_to_validate</span>
                <span class="c1"># [[metric_id, metric, fps_to_validate_count]]</span>
                <span class="n">metrics_with_features_profiles_to_validate</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_metrics_with_features_profiles_to_validate</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_metrics_with_features_profiles_to_validate returned </span><span class="si">%s</span><span class="s1"> features profiles to validate&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_with_features_profiles_to_validate</span><span class="p">)))</span>

                <span class="c1"># @added 20190501 - Feature #2430: Ionosphere validate learnt features profiles page</span>
                <span class="c1"># Only add to features_profiles_to_validate if the metric is active</span>
                <span class="c1"># in Redis</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metrics_with_features_profiles_to_validate</span><span class="p">:</span>
                        <span class="n">active_metrics_with_features_profiles_to_validate</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                            <span class="c1"># @added 20220729 - Task #2732: Prometheus to Skyline</span>
                            <span class="c1">#                   Branch #4300: prometheus</span>
                            <span class="c1"># Handle labelled_metrics</span>
                            <span class="k">if</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                                <span class="n">i_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_base_name</span><span class="p">))</span>
                                <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_metric_name</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

                        <span class="c1"># @added 20220729 - Task #2732: Prometheus to Skyline</span>
                        <span class="c1">#                   Branch #4300: prometheus</span>
                        <span class="c1"># Handle labelled_metrics</span>
                        <span class="k">if</span> <span class="n">base_name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                            <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">active_labelled_metrics_with_id</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.active_labelled_metrics_with_id&#39;</span><span class="p">)</span>
                                <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                                <span class="k">del</span> <span class="n">active_labelled_metrics_with_id</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding </span><span class="si">%s</span><span class="s1"> unique_labelled_metrics to unique_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labelled_metrics</span><span class="p">)))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get aet.metrics_manager.active_labelled_metrics_with_id from Redis&#39;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                            <span class="k">for</span> <span class="n">i_metric</span> <span class="ow">in</span> <span class="n">unique_labelled_metrics</span><span class="p">:</span>
                                <span class="n">i_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_metric</span><span class="p">))</span>
                                <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_metric_name</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">i_metric_id</span><span class="p">,</span> <span class="n">i_metric</span><span class="p">,</span> <span class="n">fps_to_validate_count</span> <span class="ow">in</span> <span class="n">metrics_with_features_profiles_to_validate</span><span class="p">:</span>
                            <span class="n">i_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_metric</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">i_metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">active_metrics_with_features_profiles_to_validate</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i_metric_id</span><span class="p">,</span> <span class="n">i_metric</span><span class="p">,</span> <span class="n">fps_to_validate_count</span><span class="p">])</span>
                        <span class="k">del</span> <span class="n">unique_metrics</span>
                        <span class="n">metrics_with_features_profiles_to_validate</span> <span class="o">=</span> <span class="n">active_metrics_with_features_profiles_to_validate</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> active features profiles to validate&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_with_features_profiles_to_validate</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no features_profiles_to_validate was passed so determined metrics_with_features_profiles_to_validate&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20190503 - Branch #2646: slack</span>
            <span class="k">if</span> <span class="n">validated_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">slack_updated</span> <span class="o">=</span> <span class="n">webapp_update_slack_thread</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">validated_count</span><span class="p">,</span> <span class="s1">&#39;validated&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;slack_updated for validated features profiles </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">slack_updated</span><span class="p">))</span>

            <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">fp_validate</span><span class="o">=</span><span class="n">fp_validate_req</span><span class="p">,</span>
                <span class="n">features_profiles_to_validate</span><span class="o">=</span><span class="n">features_profiles_to_validate</span><span class="p">,</span>
                <span class="n">metrics_with_features_profiles_to_validate</span><span class="o">=</span><span class="n">metrics_with_features_profiles_to_validate</span><span class="p">,</span>
                <span class="n">for_metric</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ordered_by</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limited_by</span><span class="p">,</span>
                <span class="n">default_learn_full_duration</span><span class="o">=</span><span class="n">default_learn_full_duration</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="n">validate_all</span><span class="o">=</span><span class="n">validate_all</span><span class="p">,</span> <span class="n">all_validated</span><span class="o">=</span><span class="n">all_validated</span><span class="p">,</span>
                <span class="n">validated_count</span><span class="o">=</span><span class="n">validated_count</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
                <span class="c1"># @added 20190919 - Feature #3230: users DB table</span>
                <span class="c1">#                   Feature #2516: Add label to features profile</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="c1"># @added 20220729 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Handle labelled_metrics</span>
                <span class="n">labelled_metric_name</span><span class="o">=</span><span class="n">labelled_metric_name</span><span class="p">,</span>
                <span class="n">labelled_metric_base_name</span><span class="o">=</span><span class="n">labelled_metric_base_name</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20210727 - Feature #4206: webapp - saved_training_data page</span>
    <span class="n">saved_training_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;ionosphere_saved_training&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/ionosphere?ionosphere_saved_training&#39;</span><span class="p">)</span>
        <span class="n">REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;ionosphere_saved_training&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;namespaces&#39;</span><span class="p">,</span>
            <span class="s1">&#39;label_includes&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: ionosphere_saved_training request invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /ionosphere?ionosphere_saved_training request evaluating metric parameter - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">namespaces</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespaces&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">namespaces</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
                <span class="n">namespaces</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /ionosphere?ionosphere_saved_training request evaluating namespaces parameter - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">label_includes</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_includes&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label_includes</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">label_includes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">label_includes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">label_includes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /ionosphere?ionosphere_saved_training request evaluating namespaces parameter - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">namespaces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">namespaces_str</span> <span class="o">=</span> <span class="n">namespaces</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="n">namespaces_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/ionosphere?ionosphere_saved_training with metrics: </span><span class="si">%s</span><span class="s1">, namespaces: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespaces</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">saved_training_data_dict</span> <span class="o">=</span> <span class="n">get_saved_training_data</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;ionosphere&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="n">label_includes</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: get_saved_training_data failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">saved_training_data_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">saved_training_data_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">saved_training_data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">saved_training_data_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">saved_training_data_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">])</span>
            <span class="n">saved_training_data_metrics</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">saved_training_data_metrics</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">saved_training_data_page</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">saved_training_data_dict</span><span class="o">=</span><span class="n">saved_training_data_dict</span><span class="p">,</span>
            <span class="n">saved_training_data_metrics</span><span class="o">=</span><span class="n">saved_training_data_metrics</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
            <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20210107 - Feature #3934: ionosphere_performance</span>
    <span class="n">performance_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;performance&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">performance_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;performance&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">performance_req</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">performance_request</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">performance_request</span><span class="p">:</span>
        <span class="n">REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_like&#39;</span><span class="p">,</span> <span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;anomalies&#39;</span><span class="p">,</span> <span class="s1">&#39;new_fps&#39;</span><span class="p">,</span> <span class="s1">&#39;total_fps&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fps_matched_count&#39;</span><span class="p">,</span> <span class="s1">&#39;layers_matched_count&#39;</span><span class="p">,</span> <span class="s1">&#39;sum_matches&#39;</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_type&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_prefix&#39;</span><span class="p">,</span>
            <span class="c1"># @added 20210202 - Feature #3934: ionosphere_performance</span>
            <span class="c1"># Handle user timezone</span>
            <span class="s1">&#39;tz&#39;</span><span class="p">,</span>
            <span class="c1"># @added 20230418 - Feature #3934: ionosphere_performance</span>
            <span class="s1">&#39;full_duration&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metric_like</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>

        <span class="c1"># @added 20210128 - Feature #3934: ionosphere_performance</span>
        <span class="c1"># Improve performance and pass arguments to get_ionosphere_performance</span>
        <span class="c1"># for cache key</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">new_fps</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">fps_matched_count</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">layers_matched_count</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sum_matches</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">period</span> <span class="o">=</span> <span class="s1">&#39;weekly&#39;</span>
        <span class="n">height</span> <span class="o">=</span> <span class="s1">&#39;8&#39;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="s1">&#39;4&#39;</span>
        <span class="n">fp_type</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20210202 - Feature #3934: ionosphere_performance</span>
        <span class="c1"># Handle user timezone</span>
        <span class="n">timezone_str</span> <span class="o">=</span> <span class="s1">&#39;UTC&#39;</span>
        <span class="n">pytz_timezones</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pytz_timezone</span> <span class="ow">in</span> <span class="n">pytz</span><span class="o">.</span><span class="n">all_timezones</span><span class="p">:</span>
            <span class="n">pytz_timezones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pytz_timezone</span><span class="p">)</span>

        <span class="c1"># @added 20230418 - Feature #3934: ionosphere_performance</span>
        <span class="c1"># Allow for a minimum full_duration to differential between analyzer and</span>
        <span class="c1"># mirage anomalies</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span> <span class="o">&lt;</span> <span class="mi">604800</span><span class="p">:</span>
            <span class="n">min_full_duration</span> <span class="o">=</span> <span class="mi">604800</span>  <span class="o">-</span> <span class="mi">900</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span> <span class="o">-</span> <span class="mi">900</span><span class="p">)</span>

        <span class="n">performance_data_request</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric </span><span class="si">%s</span><span class="s1"> was passed&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">performance_data_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="c1"># @added 20220831 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric looked up - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">value</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                    <span class="n">performance_data_request</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">]:</span>
                <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># unix timestamp</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># %Y%m%d %H:%M timestamp</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">value_strip_colon</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">value_strip_colon</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;from_timestamp&#39;</span><span class="p">:</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">:</span>
                    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_like&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_like </span><span class="si">%s</span><span class="s1"> was passed&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">metric_like</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_like</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">performance_data_request</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                    <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;format </span><span class="si">%s</span><span class="s1"> was passed&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;new_fps&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                    <span class="n">new_fps</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;total_fps&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">fps_matched_count</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># @added 20230418 - Feature #3934: ionosphere_performance</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;full_duration&#39;</span><span class="p">:</span>
                <span class="n">min_full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remove_prefix_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_prefix_str</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># @added 20210202 - Feature #3934: ionosphere_performance</span>
        <span class="c1"># Handle user timezone</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timezone_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">,</span> <span class="s1">&#39;UTC&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">ionosphere_performance_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">performance_data_request</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ionosphere_performance_data</span> <span class="o">=</span> <span class="n">get_ionosphere_performance</span><span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="n">metric_like</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span>
                    <span class="c1"># @added 20210128 - Feature #3934: ionosphere_performance</span>
                    <span class="c1"># Improve performance and pass arguments to get_ionosphere_performance</span>
                    <span class="c1"># for cache key</span>
                    <span class="n">anomalies</span><span class="p">,</span> <span class="n">new_fps</span><span class="p">,</span> <span class="n">fps_matched_count</span><span class="p">,</span> <span class="n">layers_matched_count</span><span class="p">,</span>
                    <span class="n">sum_matches</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">fp_type</span><span class="p">,</span>
                    <span class="c1"># @added 20210202 - Feature #3934: ionosphere_performance</span>
                    <span class="c1"># Handle user timezone</span>
                    <span class="n">timezone_str</span><span class="p">,</span>
                    <span class="c1"># @added 20230418 - Feature #3934: ionosphere_performance</span>
                    <span class="n">min_full_duration</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_ionosphere_performance&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ionosphere_performance_data</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                    <span class="n">performance_json_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;metric_like&quot;</span><span class="p">:</span> <span class="n">metric_like</span><span class="p">,</span> <span class="s2">&quot;performance&quot;</span><span class="p">:</span> <span class="n">performance_json_dict</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no data for query&quot;</span><span class="p">}}</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ionosphere performance returned json with with no data from query&#39;</span><span class="p">)</span>
                    <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_performance_data</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp no ionosphere_performance_data&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">performance_json_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">performance_success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">ionosphere_performance_data</span><span class="p">:</span>
            <span class="n">performance_success</span> <span class="o">=</span> <span class="n">ionosphere_performance_data</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">performance_success</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ionosphere ionosphere_performance_data has length - </span><span class="si">%s</span><span class="s1"> performance elements listed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ionosphere_performance_data</span><span class="p">)))</span>
            <span class="n">performance_list</span> <span class="o">=</span> <span class="n">ionosphere_performance_data</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">performance_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">performance_list</span><span class="p">:</span>
                <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
            <span class="n">last_fps_total_count</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">fps_total_count_column</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">date_str</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
                <span class="n">performance_json_dict</span><span class="p">[</span><span class="n">date_str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">performance_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">date_str</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">performance_json_dict</span><span class="p">[</span><span class="n">date_str</span><span class="p">][</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
                            <span class="c1"># @added 20210127 - Feature #3934: ionosphere_performance</span>
                            <span class="c1"># Convert nan to null or 0 for valid json</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">column</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;nan&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="s1">&#39;fps_total_count&#39;</span><span class="p">:</span>
                                    <span class="n">fps_total_count_column</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">performance_json_dict</span><span class="p">[</span><span class="n">date_str</span><span class="p">][</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="k">if</span> <span class="n">last_fps_total_count</span><span class="p">:</span>
                                        <span class="n">performance_json_dict</span><span class="p">[</span><span class="n">date_str</span><span class="p">][</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_fps_total_count</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">performance_json_dict</span><span class="p">[</span><span class="n">date_str</span><span class="p">][</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="s1">&#39;fps_total_count&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">column</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
                                        <span class="n">last_fps_total_count</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fps_total_count_column</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">performance_json_dict</span><span class="p">[</span><span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;fps_total_count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">use_value</span> <span class="o">=</span> <span class="n">performance_json_dict</span><span class="p">[</span><span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]][</span><span class="s1">&#39;fps_total_count&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">use_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">performance_json_dict</span><span class="p">[</span><span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;fps_total_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_value</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ionosphere_performance_data changed last fps_total_count from 0 to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_value</span><span class="p">))</span>

        <span class="c1"># Allow for the removal of a prefix from the metric name</span>
        <span class="k">if</span> <span class="n">remove_prefix</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">remove_prefix_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                    <span class="n">remove_prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">remove_prefix_str</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">remove_prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">remove_prefix_str</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to remove prefix </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix_str</span><span class="p">),</span> <span class="n">metric</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;metric_like&quot;</span><span class="p">:</span> <span class="n">metric_like</span><span class="p">,</span> <span class="s2">&quot;performance&quot;</span><span class="p">:</span> <span class="n">performance_json_dict</span><span class="p">}}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">performance_success</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">204</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;metric_like&quot;</span><span class="p">:</span> <span class="n">metric_like</span><span class="p">,</span> <span class="s2">&quot;performance&quot;</span><span class="p">:</span> <span class="n">performance_json_dict</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no data for query&quot;</span><span class="p">}}</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ionosphere performance returned json with </span><span class="si">%s</span><span class="s1"> performance elements listed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">performance_json_dict</span><span class="p">)))</span>
            <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">performance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">performance_results</span><span class="o">=</span><span class="n">ionosphere_performance_data</span><span class="p">,</span>
            <span class="n">performance_json_dict</span><span class="o">=</span><span class="n">data_dict</span><span class="p">,</span>
            <span class="n">for_metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_like</span><span class="o">=</span><span class="n">metric_like</span><span class="p">,</span>
            <span class="n">from_timestamp</span><span class="o">=</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="o">=</span><span class="n">until_timestamp</span><span class="p">,</span>
            <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
            <span class="c1"># @added 20210202 - Feature #3934: ionosphere_performance</span>
            <span class="c1"># Handle user timezone</span>
            <span class="n">pytz_timezones</span><span class="o">=</span><span class="n">pytz_timezones</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20170220 - Feature #1862: Ionosphere features profiles search page</span>
    <span class="c1"># Ionosphere features profiles by generations</span>
    <span class="n">fp_search_req</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># @added 20170916 - Feature #1996: Ionosphere - matches page</span>
    <span class="c1"># Handle both fp_search and fp_matches</span>
    <span class="n">fp_search_or_matches_req</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s1">&#39;fp_search&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">fp_search_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_search&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fp_search_req</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">fp_search_req</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fp_search_or_matches_req</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fp_search_req</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20170916 - Feature #1996: Ionosphere - matches page</span>
    <span class="n">fp_matches_req</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;fp_matches&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">fp_matches_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_matches&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fp_matches_req</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">fp_matches_req</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fp_search_or_matches_req</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">until_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fp_matches_req</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @modified 20170916 - Feature #1996: Ionosphere - matches page</span>
    <span class="c1"># Handle both fp_search and fp_matches</span>
    <span class="c1"># if fp_search_req and request_args_len &gt; 1:</span>
    <span class="k">if</span> <span class="n">fp_search_or_matches_req</span> <span class="ow">and</span> <span class="n">request_args_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fp_search&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;metric_like&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;generation_greater_than&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20170315 - Feature #1960: ionosphere_layers</span>
                        <span class="s1">&#39;layers_id_greater_than&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
                        <span class="s1">&#39;validated_equals&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20170518 - Feature #1996: Ionosphere - matches page - matched_greater_than</span>
                        <span class="s1">&#39;matched_greater_than&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;full_duration&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;enabled&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;tsfresh_version&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;generation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;count_by_metric&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;count_by_matched&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;count_by_generation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;count_by_checked&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;order&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20170916 - Feature #1996: Ionosphere - matches page</span>
                        <span class="s1">&#39;fp_matches&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
                        <span class="s1">&#39;fp_id&#39;</span><span class="p">,</span> <span class="s1">&#39;layer_id&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20180804 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
                        <span class="s1">&#39;load_derivative_graphs&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20180917 - Feature #2602: Graphs in search_features_profiles</span>
                        <span class="s1">&#39;show_graphs&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20191212 - Feature #3230: users DB table</span>
                        <span class="c1">#                   Feature #2516: Add label to features profile</span>
                        <span class="c1"># Allow the user_id to be passed as a request argument</span>
                        <span class="s1">&#39;user_id&#39;</span><span class="p">,</span>
                        <span class="p">]</span>

        <span class="n">count_by_metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ordered_by</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">limited_by</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">get_metric_profiles</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">not_metric_wildcard</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># @added 20200710 - Feature #1996: Ionosphere - matches page</span>
        <span class="c1"># Moved from within the loop below</span>
        <span class="n">matching</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">metric_like</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">REQUEST_ARGS</span><span class="p">:</span>
                <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                <span class="c1"># Return data</span>
                <span class="c1"># logger.error(&#39;error :: invalid request argument - %s&#39; % (key))</span>
                <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;DESC&#39;</span><span class="p">:</span>
                    <span class="n">ordered_by</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;ASC&#39;</span><span class="p">:</span>
                    <span class="n">ordered_by</span> <span class="o">=</span> <span class="s1">&#39;ASC&#39;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span>
                    <span class="n">limited_by</span> <span class="o">=</span> <span class="n">test_limit</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: limit is not an integer - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>
                    <span class="n">limited_by</span> <span class="o">=</span> <span class="s1">&#39;30&#39;</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">]:</span>
                <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># unix timestamp</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># %Y%m%d %H:%M timestamp</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">value_strip_colon</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">value_strip_colon</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                    <span class="c1"># Return data</span>
                    <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                <span class="c1"># @added 20190524 - Bug #3050: Ionosphere - Skyline and Graphite feedback</span>
                <span class="c1">#                   Branch #3002: docker</span>
                <span class="c1"># Added the missing definition of these 2 variables in the</span>
                <span class="c1"># fp_matches context</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;from_timestamp&#39;</span><span class="p">:</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">:</span>
                    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;count_by_metric&#39;</span><span class="p">:</span>
                <span class="n">count_by_metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;count_by_metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count_by_metric</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">count_by_metric</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">count_by_metric</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                    <span class="n">not_metric_wildcard</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">get_metric_profiles</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">and</span> <span class="n">not_metric_wildcard</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
                <span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
                <span class="c1"># Roll back change - breaking existing metrics with colons</span>
                <span class="c1"># metric_name = url_encode_metric_name(metric_name)</span>

                <span class="c1"># @added 20221025 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_metric_id_from_base_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">value</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                        <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                <span class="c1"># @added 20221103 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                    <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="c1"># @added 20180423 - Feature #2034: analyse_derivatives</span>
                <span class="c1">#                   Branch #2270: luminosity</span>
                <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                    <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
                    <span class="c1"># for redis_ip, redis_port in settings.OTHER_SKYLINE_REDIS_INSTANCES:</span>
                    <span class="k">for</span> <span class="n">redis_ip</span><span class="p">,</span> <span class="n">redis_port</span><span class="p">,</span> <span class="n">redis_password</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found_in_other_redis</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
                                    <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_password</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">))</span>
                                <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">other_redis_conn</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">other_unique_metrics</span><span class="p">:</span>
                                <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> found in derivative_metrics in Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>

                <span class="c1"># @added 20201127 - Feature #3824: get_cluster_data</span>
                <span class="c1">#                   Feature #3820: HORIZON_SHARDS</span>
                <span class="c1"># Change from the deprecated OTHER_SKYLINE_REDIS_INSTANCES</span>
                <span class="c1"># to use the REMOTE_SKYLINE_INSTANCES and get_cluster_data</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                    <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;unique_metrics&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get unique_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">remote_unique_metrics</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote unique_metrics from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_unique_metrics</span><span class="p">)))</span>
                        <span class="n">unique_metrics_list</span> <span class="o">=</span> <span class="n">unique_metrics</span> <span class="o">+</span> <span class="n">remote_unique_metrics</span>
                        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_metrics_list</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric_found_in_other_redis</span><span class="p">:</span>
                    <span class="c1"># @added 20200715 - Task #3648: webapp - fp_search - do not use Redis metric check</span>
                    <span class="c1"># Do not use the Redis metric check result in a webapp</span>
                    <span class="c1"># fp_search request as this allows retried metric fps to</span>
                    <span class="c1"># accessed</span>
                    <span class="k">if</span> <span class="n">fp_search_req</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fp_search_or_matches_req - </span><span class="si">%s</span><span class="s1"> not in Redis, but fp_search request so continuing&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                        <span class="n">get_metric_profiles</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no metric (not fp_search_req) - </span><span class="si">%s</span><span class="s1"> - exists in Redis&#39;</span> <span class="o">%</span> <span class="n">metric_name</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">get_metric_profiles</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
            <span class="c1"># @modified 20170917 - Feature #1996: Ionosphere - matches page</span>
            <span class="c1"># Move outside the loop</span>
            <span class="c1"># matching = False</span>
            <span class="c1"># metric_like = False</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_like&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">metric_namespace_pattern</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="n">metric_namespace_pattern</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_namespace_pattern</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

                    <span class="c1"># @added 20220729 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="n">unique_labelled_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">active_labelled_metrics_with_id</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.active_labelled_metrics_with_id&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">active_labelled_metrics_with_id</span><span class="p">:</span>
                            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="n">unique_metrics</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labelled_metrics_with_id</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="k">del</span> <span class="n">active_labelled_metrics_with_id</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding </span><span class="si">%s</span><span class="s1"> unique_labelled_metrics to unique_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labelled_metrics</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get aet.metrics_manager.active_labelled_metrics_with_id from Redis&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

                    <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="k">if</span> <span class="n">metric_namespace_pattern</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no metric like - </span><span class="si">%s</span><span class="s1"> - exists in Redis&#39;</span> <span class="o">%</span> <span class="n">metric_namespace_pattern</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>
                    <span class="c1"># @added 20200710 - Feature #1996: Ionosphere - matches page</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_like </span><span class="si">%s</span><span class="s1"> was passed, </span><span class="si">%s</span><span class="s1"> metrics found matching&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">))))</span>
                    <span class="n">metric_like</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">matching</span><span class="p">:</span>
                    <span class="n">metric_like</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fp_search_req</span> <span class="ow">and</span> <span class="n">request_args_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">count_by_metric</span><span class="p">:</span>
            <span class="c1"># @modified 20180717 - Task #2446: Optimize Ionosphere</span>
            <span class="c1"># Added missing search_success variable</span>
            <span class="n">features_profiles</span><span class="p">,</span> <span class="n">fps_count</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">full_duration_list</span><span class="p">,</span> <span class="n">enabled_list</span><span class="p">,</span> <span class="n">tsfresh_version_list</span><span class="p">,</span> <span class="n">generation_list</span><span class="p">,</span> <span class="n">search_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_search</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fp_search_req returning response&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">fp_search</span><span class="o">=</span><span class="n">fp_search_req</span><span class="p">,</span>
                <span class="n">fp_search_results</span><span class="o">=</span><span class="n">fp_search_req</span><span class="p">,</span>
                <span class="n">features_profiles_count</span><span class="o">=</span><span class="n">fps_count</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ordered_by</span><span class="p">,</span>
                <span class="n">limit</span><span class="o">=</span><span class="n">limited_by</span><span class="p">,</span> <span class="n">matched_count</span><span class="o">=</span><span class="n">mc</span><span class="p">,</span> <span class="n">checked_count</span><span class="o">=</span><span class="n">cc</span><span class="p">,</span>
                <span class="n">generation_count</span><span class="o">=</span><span class="n">gc</span><span class="p">,</span> <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

        <span class="c1"># @added 20180917 - Feature #2602: Graphs in search_features_profiles</span>
        <span class="n">features_profiles_with_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">show_graphs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">get_metric_profiles</span><span class="p">:</span>
            <span class="n">search_success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fps</span><span class="p">,</span> <span class="n">fps_count</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">full_duration_list</span><span class="p">,</span> <span class="n">enabled_list</span><span class="p">,</span> <span class="n">tsfresh_version_list</span><span class="p">,</span> <span class="n">generation_list</span><span class="p">,</span> <span class="n">search_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_search</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with search_ionosphere&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">search_success</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20180917 - Feature #2602: Graphs in search_features_profiles</span>
            <span class="k">if</span> <span class="n">search_success</span> <span class="ow">and</span> <span class="n">fps</span><span class="p">:</span>
                <span class="n">show_graphs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;show_graphs&#39;</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">show_graphs</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">show_graphs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">search_success</span> <span class="ow">and</span> <span class="n">fps</span> <span class="ow">and</span> <span class="n">show_graphs</span><span class="p">:</span>
                <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
                <span class="c1"># query_context = &#39;features_profiles&#39;</span>

                <span class="k">for</span> <span class="n">fp_elements</span> <span class="ow">in</span> <span class="n">fps</span><span class="p">:</span>
                    <span class="c1"># Get images</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fp_id</span> <span class="o">=</span> <span class="n">fp_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">fp_elements</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">requested_timestamp</span> <span class="o">=</span> <span class="n">fp_elements</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

                        <span class="c1"># @modified 20181205 - Bug #2746: webapp time out - Graphs in search_features_profiles</span>
                        <span class="c1">#                      Feature #2602: Graphs in search_features_profiles</span>
                        <span class="c1"># This function was causing the webapp to time out due</span>
                        <span class="c1"># to fetching all the matched Graphite graphs</span>
                        <span class="c1"># mpaths, images, hdate, m_vars, ts_json, data_to_process, p_id, gimages, gmimages, times_matched, glm_images, l_id_matched, ts_fd, i_ts_json, anomalous_timeseries, f_id_matched, fp_details_list = ionosphere_metric_data(requested_timestamp, base_name, query_context, fp_id)</span>
                        <span class="n">images</span><span class="p">,</span> <span class="n">gimages</span> <span class="o">=</span> <span class="n">ionosphere_show_graphs</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">)</span>

                        <span class="n">new_fp</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">fp_element</span> <span class="ow">in</span> <span class="n">fp_elements</span><span class="p">:</span>
                            <span class="n">new_fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp_element</span><span class="p">)</span>

                        <span class="c1"># @added 20180918 - Feature #2602: Graphs in search_features_profiles</span>
                        <span class="c1"># The images are required to be sorted here in terms of</span>
                        <span class="c1"># only passing the Redis image (if present) and the</span>
                        <span class="c1"># full duration graph, as it is a bit too much</span>
                        <span class="c1"># achieve in the Jinja template.</span>
                        <span class="n">full_duration_float</span> <span class="o">=</span> <span class="n">fp_elements</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">full_duration_float</span><span class="p">)</span>
                        <span class="n">full_duration_in_hours</span> <span class="o">=</span> <span class="n">full_duration</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span>
                        <span class="n">full_duration_in_hours_image_string</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">h.png&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">full_duration_in_hours</span><span class="p">))</span>

                        <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
                        <span class="c1"># show_graph_images = []</span>

                        <span class="n">redis_image</span> <span class="o">=</span> <span class="s1">&#39;No Redis data graph&#39;</span>
                        <span class="n">full_duration_image</span> <span class="o">=</span> <span class="s1">&#39;No full duration graph&#39;</span>
                        <span class="c1"># @modified 20180918 - Feature #2602: Graphs in search_features_profiles</span>
                        <span class="c1"># Append individual redis_image and full_duration_image</span>
                        <span class="c1"># list elements instead of just added the images or</span>
                        <span class="c1">#  gimages list</span>
                        <span class="c1"># if images:</span>
                        <span class="c1">#     new_fp.append(images)</span>
                        <span class="c1"># else:</span>
                        <span class="c1">#     new_fp.append(gimages)</span>
                        <span class="k">if</span> <span class="n">images</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;.redis.plot&#39;</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                                    <span class="n">redis_image</span> <span class="o">=</span> <span class="n">image</span>
                                <span class="k">if</span> <span class="n">full_duration_in_hours_image_string</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                                    <span class="n">full_duration_image</span> <span class="o">=</span> <span class="n">image</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">gimages</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;.redis.plot&#39;</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                                    <span class="n">redis_image</span> <span class="o">=</span> <span class="n">image</span>
                                <span class="k">if</span> <span class="n">full_duration_in_hours_image_string</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                                    <span class="n">full_duration_image</span> <span class="o">=</span> <span class="n">image</span>
                        <span class="k">if</span> <span class="n">full_duration_image</span> <span class="o">==</span> <span class="s1">&#39;No full duration graph&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">gimages</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">full_duration_in_hours_image_string</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                                    <span class="n">full_duration_image</span> <span class="o">=</span> <span class="n">image</span>
                        <span class="n">new_fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_duration_image</span><span class="p">)</span>
                        <span class="n">new_fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">redis_image</span><span class="p">)</span>

                        <span class="n">features_profiles_with_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_fp</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">features_profiles_with_images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fps</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fp_elements</span> <span class="ow">in</span> <span class="n">fps</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_fp</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">fp_element</span> <span class="ow">in</span> <span class="n">fp_elements</span><span class="p">:</span>
                                <span class="n">new_fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp_element</span><span class="p">)</span>
                            <span class="n">new_fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                            <span class="n">features_profiles_with_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_fp</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

            <span class="c1"># @modified 20170912 - Feature #2056: ionosphere - disabled_features_profiles</span>
            <span class="c1"># Added enabled_list to display DISABLED in search_features_profiles</span>
            <span class="c1"># page results.</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">fp_search</span><span class="o">=</span><span class="n">fp_search_req</span><span class="p">,</span>
                <span class="n">fp_search_results</span><span class="o">=</span><span class="n">fp_search_req</span><span class="p">,</span> <span class="n">features_profiles</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                <span class="n">for_metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ordered_by</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limited_by</span><span class="p">,</span>
                <span class="n">matched_count</span><span class="o">=</span><span class="n">mc</span><span class="p">,</span> <span class="n">checked_count</span><span class="o">=</span><span class="n">cc</span><span class="p">,</span> <span class="n">generation_count</span><span class="o">=</span><span class="n">gc</span><span class="p">,</span>
                <span class="n">enabled_list</span><span class="o">=</span><span class="n">enabled_list</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="c1"># @added 20180917 - Feature #2602: Graphs in search_features_profiles</span>
                <span class="n">features_profiles_with_images</span><span class="o">=</span><span class="n">features_profiles_with_images</span><span class="p">,</span>
                <span class="n">show_graphs</span><span class="o">=</span><span class="n">show_graphs</span><span class="p">,</span>
                <span class="c1"># @added 20220729 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Handle labelled_metrics</span>
                <span class="n">labelled_metric_name</span><span class="o">=</span><span class="n">labelled_metric_name</span><span class="p">,</span>
                <span class="n">labelled_metric_base_name</span><span class="o">=</span><span class="n">labelled_metric_base_name</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20170916 - Feature #1996: Ionosphere - matches page</span>
    <span class="k">if</span> <span class="n">fp_matches_req</span><span class="p">:</span>
        <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
        <span class="c1"># Added by fp_id or layer_id as well</span>
        <span class="n">fp_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">layer_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># @added 20190619 - Feature #3084: Ionosphere - validated matches</span>
        <span class="n">validated_equals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fp_id&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request key </span><span class="si">%s</span><span class="s1"> set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                    <span class="c1"># test_fp_id = int(value) + 0</span>
                    <span class="c1"># if test_fp_id &gt; 0:</span>
                    <span class="c1">#     fp_id = str(test_fp_id)</span>
                    <span class="n">test_fp_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">test_fp_id</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">fp_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># Test that the fp_id is an int first</span>
                        <span class="c1"># fp_id = None</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - fp_id is not an int&#39;</span><span class="p">)</span>
                        <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                        <span class="c1"># Return data</span>
                        <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - fp_id is not an int&#39;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">200</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fp_id now set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: the fp_id argument was passed but not as an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># return resp, 404</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;layer_id&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request key </span><span class="si">%s</span><span class="s1"> set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_layer_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">test_layer_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">layer_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_layer_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">layer_id</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;layer_id now set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">layer_id</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: the layer_id argument was passed but not as an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># return resp, 404</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="c1"># @added 20190619 - Feature #3084: Ionosphere - validated matches</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;validated_equals&#39;</span><span class="p">:</span>
                <span class="n">validated_equals</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_fp_matches with arguments :: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_like</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">layer_id</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">limited_by</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">ordered_by</span><span class="p">)))</span>

        <span class="n">matches</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_fp_matches</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_like</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">limited_by</span><span class="p">,</span> <span class="n">ordered_by</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @added 20190619 - Feature #3084: Ionosphere - validated matches</span>
        <span class="k">if</span> <span class="n">validated_equals</span><span class="p">:</span>
            <span class="n">filter_matches</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">validated_equals</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">filter_matches</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">validated_equals</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">filter_match_validation</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">validated_equals</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">filter_match_validation</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">validated_equals</span> <span class="o">==</span> <span class="s1">&#39;invalid&#39;</span><span class="p">:</span>
                <span class="n">filter_match_validation</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">filter_matches</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;matches filtered by validated = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">filter_match_validation</span><span class="p">)))</span>

        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">fp_matches</span><span class="o">=</span><span class="n">fp_matches_req</span><span class="p">,</span> <span class="n">for_metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
            <span class="n">fp_matches_results</span><span class="o">=</span><span class="n">matches</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ordered_by</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limited_by</span><span class="p">,</span>
            <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
            <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @modified 20170118 - Feature #1862: Ionosphere features profiles search page</span>
    <span class="c1"># Added fp_search parameter</span>
    <span class="c1"># @modified 20170122 - Feature #1872: Ionosphere - features profile page by id only</span>
    <span class="c1"># Added fp_id parameter</span>
    <span class="c1"># @modified 20170305 - Feature #1960: ionosphere_layers</span>
    <span class="c1"># Added layers arguments d_condition to fp_layer</span>
    <span class="c1"># @modified 20160315 - Feature #1972: ionosphere_layers - use D layer boundary for upper limit</span>
    <span class="c1"># Added d_boundary_times</span>
    <span class="c1"># @modified 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
    <span class="c1"># Added layers_id and edit_fp_layers</span>
    <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
    <span class="n">IONOSPHERE_REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_td&#39;</span><span class="p">,</span> <span class="s1">&#39;a_dated_list&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp_td&#39;</span><span class="p">,</span>
        <span class="s1">&#39;requested_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_view&#39;</span><span class="p">,</span> <span class="s1">&#39;calc_features&#39;</span><span class="p">,</span> <span class="s1">&#39;add_fp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;features_profiles&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_search&#39;</span><span class="p">,</span> <span class="s1">&#39;learn&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_id&#39;</span><span class="p">,</span> <span class="s1">&#39;d_condition&#39;</span><span class="p">,</span>
        <span class="s1">&#39;d_boundary_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;d_boundary_times&#39;</span><span class="p">,</span> <span class="s1">&#39;e_condition&#39;</span><span class="p">,</span> <span class="s1">&#39;e_boundary_limit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;e_boundary_times&#39;</span><span class="p">,</span> <span class="s1">&#39;es_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;es_day&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_from_time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;f1_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;f2_until_time&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_layer_label&#39;</span><span class="p">,</span>
        <span class="s1">&#39;add_fp_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;layers_id&#39;</span><span class="p">,</span> <span class="s1">&#39;edit_fp_layers&#39;</span><span class="p">,</span> <span class="s1">&#39;validate_fp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;validated_equals&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20170616 - Feature #2048: D1 ionosphere layer</span>
        <span class="s1">&#39;d1_condition&#39;</span><span class="p">,</span> <span class="s1">&#39;d1_boundary_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;d1_boundary_times&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
        <span class="s1">&#39;save_training_data&#39;</span><span class="p">,</span> <span class="s1">&#39;saved_td_label&#39;</span><span class="p">,</span> <span class="s1">&#39;saved_training_data&#39;</span><span class="p">,</span>
        <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
        <span class="s1">&#39;disable_fp&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
        <span class="s1">&#39;matched_fp_id&#39;</span><span class="p">,</span> <span class="s1">&#39;matched_layer_id&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20180804 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
        <span class="s1">&#39;load_derivative_graphs&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
        <span class="s1">&#39;match_validation&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20190922 - Feature #2516: Add label to features profile</span>
        <span class="s1">&#39;label&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20191210 - Feature #3348: fp creation json response</span>
        <span class="s1">&#39;format&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20191212 - Feature #3230: users DB table</span>
        <span class="c1">#                   Feature #2516: Add label to features profile</span>
        <span class="c1"># Allow the user_id to be passed as a request argument</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20210413 - Feature #4014: Ionosphere - inference</span>
        <span class="c1">#                   Branch #3590: inference</span>
        <span class="s1">&#39;matched_motif_id&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20210415 - Feature #4014: Ionosphere - inference</span>
        <span class="s1">&#39;motif_analysis&#39;</span><span class="p">,</span> <span class="s1">&#39;similarity&#39;</span><span class="p">,</span> <span class="s1">&#39;purge&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20210416 - Feature #4014: Ionosphere - inference</span>
        <span class="s1">&#39;ionosphere_matched_id&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20210417 - Feature #4014: Ionosphere - inference</span>
        <span class="c1"># Allow the user to define the batch_size per similarity search</span>
        <span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="s1">&#39;top_matches&#39;</span><span class="p">,</span> <span class="s1">&#39;max_distance&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20210422 - Feature #4014: Ionosphere - inference</span>
        <span class="c1"># Allow the user to specify the range_padding</span>
        <span class="s1">&#39;range_padding&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20210425 - Feature #4014: Ionosphere - inference</span>
        <span class="c1"># Allow user to specify the difference between the areas under the</span>
        <span class="c1"># curve</span>
        <span class="s1">&#39;max_area_percent_diff&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20220728 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_id&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
    <span class="c1"># determine_metric = False</span>

    <span class="n">dated_list</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">td_requested_timestamp</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
    <span class="c1"># feature_profile_view = False</span>

    <span class="n">calculate_features</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">create_feature_profile</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fp_view</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fp_profiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># @added 20170118 - Feature #1862: Ionosphere features profiles search page</span>
    <span class="n">fp_search</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @added 20170120 -  Feature #1854: Ionosphere learn - generations</span>
    <span class="c1"># Added fp_learn and fp_fd_days parameters to allow the user to not learn at</span>
    <span class="c1"># use_full_duration_days</span>
    <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fp_fd_days</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_FULL_DURATION_DAYS</span>

    <span class="c1"># @added 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
    <span class="c1">#                   Task #2002: Review and correct incorrectly defined layers</span>
    <span class="c1"># Added the argument edit_fp_layers</span>
    <span class="n">edit_fp_layers</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">layers_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
    <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">saved_training_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">saved_td_label</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
    <span class="n">disable_fp</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
    <span class="n">matched_fp_id</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20220317 - Feature #4540: Plot matched timeseries</span>
    <span class="c1">#                   Feature #4014: Ionosphere - inference</span>
    <span class="n">matched_fp_plot</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">matched_layer_id</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20210413 - Feature #4014: Ionosphere - inference</span>
    <span class="c1">#                   Branch #3590: inference</span>
    <span class="n">matched_motif_id</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @added 20210416 - Feature #4014: Ionosphere - inference</span>
    <span class="n">ionosphere_matched_id</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
    <span class="n">match_validated</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># @added 20190922 - Feature #2516: Add label to features profile</span>
    <span class="n">fp_label</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20191210 - Feature #3348: fp creation json response</span>
    <span class="n">response_format</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20210422 - Feature #4014: Ionosphere - inference</span>
    <span class="c1"># Allow the user to specify the range_padding</span>
    <span class="n">motif_range_padding</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20220516 - Feature #2580: illuminance</span>
    <span class="c1"># illuminance_events_dict = False</span>
    <span class="n">illuminance_events_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># @added 20230626</span>
    <span class="n">insufficient_data_for_training</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">request_args_present</span><span class="p">:</span>
            <span class="n">timestamp_arg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">metric_arg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">metric_td_arg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">timestamp_td_arg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># @added 20180804 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
            <span class="n">set_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="s1">&#39;fp_view&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">fp_view</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_view&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">labelled_metric_base_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set base_name to labelled_metric_name&#39;</span><span class="p">)</span>

                <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
                <span class="k">if</span> <span class="s1">&#39;matched_fp_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">matched_fp_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;matched_fp_id&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;matched_layer_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">matched_layer_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;matched_layer_id&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
                <span class="k">if</span> <span class="s1">&#39;match_validation&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">match_validated_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;match_validation&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match_validated_str</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">match_validated</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match_validated_str</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - match_validation is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_validated_str</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                            <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                <span class="c1"># @added 20210413 - Feature #4014: Ionosphere - inference</span>
                <span class="c1">#                   Branch #3590: inference</span>
                <span class="k">if</span> <span class="s1">&#39;matched_motif_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">matched_motif_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;matched_motif_id&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;matched_motif_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_id</span><span class="p">))</span>
                    <span class="c1"># @added 20210422 - Feature #4014: Ionosphere - inference</span>
                    <span class="c1"># Allow the user to specify the range_padding</span>
                    <span class="k">if</span> <span class="s1">&#39;range_padding&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="n">motif_range_padding</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;range_padding&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;range_padding: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">motif_range_padding</span><span class="p">))</span>
                    <span class="c1"># @added 20210425 - Feature #4014: Ionosphere - inference</span>
                    <span class="c1"># Allow user to specify the difference between the areas under the</span>
                    <span class="c1"># curve</span>
                    <span class="k">if</span> <span class="s1">&#39;max_area_percent_diff&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="n">motif_max_area_percent_diff</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_area_percent_diff&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;max_area_percent_diff: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">motif_max_area_percent_diff</span><span class="p">))</span>

                <span class="c1"># @added 20210416 - Feature #4014: Ionosphere - inference</span>
                <span class="k">if</span> <span class="s1">&#39;ionosphere_matched_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">ionosphere_matched_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;ionosphere_matched_id&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;matched_motif_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_id</span><span class="p">))</span>

                <span class="c1"># @added 20170122 - Feature #1872: Ionosphere - features profile page by id only</span>
                <span class="c1"># Determine the features profile dir path for a fp_id</span>
                <span class="k">if</span> <span class="s1">&#39;fp_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="c1"># @added 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># Test that the fp_id is an int first</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test_fp_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_id&#39;</span><span class="p">))</span>
                        <span class="n">test_fp_id_valid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_fp_id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test_fp_id_valid tests OK with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_fp_id_valid</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - fp_id is not an int&#39;</span><span class="p">)</span>
                        <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                        <span class="c1"># Return data</span>
                        <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: the fp_id argument was passed but not as an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                    <span class="n">fp_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_id&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
                    <span class="c1"># metric_timestamp = 0</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fp_details</span><span class="p">,</span> <span class="n">fp_details_successful</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">,</span> <span class="n">fp_details_object</span> <span class="o">=</span> <span class="n">features_profile_details</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)</span>
                        <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">])</span>
                        <span class="n">created_timestamp</span> <span class="o">=</span> <span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;created_timestamp&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to get features profile details for id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_details_successful</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: features_profile_details failed&#39;</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

                    <span class="n">use_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">metric_timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                        <span class="n">metric_timeseries_dir</span> <span class="o">=</span> <span class="n">labelled_metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

                    <span class="c1"># @modified 20170126 - Feature #1872: Ionosphere - features profile page by id only</span>
                    <span class="c1"># The the incorrect logic, first it should be checked if</span>
                    <span class="c1"># there is a use_full_duration parent timestamp</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">created_timestamp</span><span class="p">)</span>
                    <span class="n">naive</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
                    <span class="n">pytz_tz</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_PYTZ_TIMEZONE</span>
                    <span class="n">local</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">pytz_tz</span><span class="p">)</span>
                    <span class="n">local_dt</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">naive</span><span class="p">,</span> <span class="n">is_dst</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">utc_dt</span> <span class="o">=</span> <span class="n">local_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                    <span class="n">unix_created_timestamp</span> <span class="o">=</span> <span class="n">utc_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">features_profiles_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">unix_created_timestamp</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">features_profiles_data_dir</span><span class="p">):</span>
                        <span class="n">use_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unix_created_timestamp</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;no timestamp feature profiles data dir found for feature profile id </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">features_profiles_data_dir</span><span class="p">)))</span>

                    <span class="c1"># @added 20170915 - Bug #2162: ionosphere - mismatching timestamp metadata</span>
                    <span class="c1">#                   Feature #1872: Ionosphere - features profile page by id only</span>
                    <span class="c1"># Iterate back a few seconds as the features profile dir and</span>
                    <span class="c1"># file resources may have a slight offset timestamp from the</span>
                    <span class="c1"># created_timestamp which is based on MySQL CURRENT_TIMESTAMP</span>
                    <span class="k">if</span> <span class="n">use_timestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">check_back_to_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unix_created_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span>
                        <span class="n">check_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unix_created_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="k">while</span> <span class="n">check_timestamp</span> <span class="o">&gt;</span> <span class="n">check_back_to_timestamp</span><span class="p">:</span>
                            <span class="n">features_profiles_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">check_timestamp</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">features_profiles_data_dir</span><span class="p">):</span>
                                <span class="n">use_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">check_timestamp</span><span class="p">)</span>
                                <span class="n">check_timestamp</span> <span class="o">=</span> <span class="n">check_back_to_timestamp</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">check_timestamp</span> <span class="o">-=</span> <span class="mi">1</span>

                    <span class="c1"># @added 20220729 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="k">if</span> <span class="n">use_timestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
                                <span class="n">features_profiles_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_str</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">features_profiles_data_dir</span><span class="p">):</span>
                                    <span class="n">use_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp_str</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - fp_id is not an int&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">use_timestamp</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">anomaly_timestamp</span><span class="p">:</span>
                        <span class="n">features_profiles_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">))</span>
                    <span class="c1"># @modified 20170126 - Feature #1872: Ionosphere - features profile page by id only</span>
                    <span class="c1"># This was the incorrect logic, first it should be checked if</span>
                    <span class="c1"># there is a use_full_duration parent timestamp</span>
                    <span class="k">if</span> <span class="n">use_timestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">features_profiles_data_dir</span><span class="p">):</span>
                            <span class="n">use_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;no timestamp feature profiles data dir found for feature profile id </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">features_profiles_data_dir</span><span class="p">)))</span>

                    <span class="k">if</span> <span class="n">use_timestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;no timestamp feature profiles data dir found for feature profile id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">))</span>

                        <span class="c1"># @added 20180420 - Branch #2270: luminosity</span>
                        <span class="c1"># Use settings.ALTERNATIVE_SKYLINE_URLS if they are</span>
                        <span class="c1"># declared</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALTERNATIVE_SKYLINE_URLS</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">if</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                            <span class="n">alternative_urls</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">alt_url</span> <span class="ow">in</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                                <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;fp_id=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">alt_url</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                                    <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;fp_id=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">alt_url</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">))</span>
                                <span class="n">alternative_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no timestamp feature profiles data dir found on this Skyline instance try at the alternative URLS listed below:&#39;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;passing alternative_urls - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alternative_urls</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                                    <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">display_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                                    <span class="n">alternative_urls</span><span class="o">=</span><span class="n">alternative_urls</span><span class="p">,</span>
                                    <span class="n">fp_view</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                                    <span class="n">print_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="mi">200</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no timestamp feature profiles data dir found for feature profile id - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - go on... nothing here.&#39;</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 400</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                    <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                        <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">labelled_metric_name</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;base redirect_url - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redirect_url</span><span class="p">)</span>

                    <span class="c1"># @added 20180815 - Feature #2430: Ionosphere validate learnt features profiles page</span>
                    <span class="n">validate_fp_req</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="s1">&#39;validate_fp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="n">validate_fp_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;validate_fp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">validate_fp_req</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                            <span class="n">validate_fp_req</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">validate_fp_req</span><span class="p">:</span>
                        <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;validate_fp=true&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                            <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;validate_fp=true&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">labelled_metric_name</span><span class="p">)</span>

                    <span class="c1"># @added 20180816 - Feature #2430: Ionosphere validate learnt features profiles page</span>
                    <span class="n">disable_fp_req</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="s1">&#39;disable_fp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="n">disable_fp_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;disable_fp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">disable_fp_id</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
                            <span class="n">disable_fp_req</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">disable_fp_req</span><span class="p">:</span>
                        <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;disable_fp=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">disable_fp_id</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                            <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;disable_fp=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span>
                                <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">disable_fp_id</span><span class="p">))</span>

                    <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
                    <span class="k">if</span> <span class="n">matched_fp_id</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">matched_fp_id</span> <span class="o">!=</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                            <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;matched_fp_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">matched_fp_id</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                                <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;matched_fp_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span>
                                    <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_fp_id</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">matched_layer_id</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">matched_layer_id</span> <span class="o">!=</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                            <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;matched_layer_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">matched_layer_id</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                                <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;matched_layer_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span>
                                    <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_layer_id</span><span class="p">))</span>

                    <span class="c1"># @added 20210413 - Feature #4014: Ionosphere - inference</span>
                    <span class="c1">#                   Branch #3590: inference</span>
                    <span class="k">if</span> <span class="n">matched_motif_id</span><span class="p">:</span>
                        <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;matched_motif_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_id</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                            <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;matched_motif_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span>
                                <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_id</span><span class="p">))</span>

                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;redirecting fp_id matched_motif_id request&#39;</span><span class="p">)</span>
                    <span class="c1"># @added 20210416 - Feature #4014: Ionosphere - inference</span>
                    <span class="k">if</span> <span class="n">ionosphere_matched_id</span><span class="p">:</span>
                        <span class="n">ionosphere_matched_id_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;ionosphere_matched_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">redirect_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_matched_id</span><span class="p">))</span>
                        <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">ionosphere_matched_id_redirect_url</span>

                    <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
                    <span class="c1"># @modified 20210413 Feature #4014: Ionosphere - inference</span>
                    <span class="c1">#                    Branch #3590: inference</span>
                    <span class="c1"># Added matched_motif_id</span>
                    <span class="k">if</span> <span class="n">matched_fp_id</span> <span class="ow">or</span> <span class="n">matched_layer_id</span> <span class="ow">or</span> <span class="n">matched_motif_id</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;match_validation&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">match_validated</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">validate_matched_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;match_validation=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">redirect_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_validated</span><span class="p">))</span>
                                <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">validate_matched_redirect_url</span>

                    <span class="c1"># @modified 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
                    <span class="c1">#                      Task #2002: Review and correct incorrectly defined layers</span>
                    <span class="c1"># Build the query string from the previous parameters</span>
                    <span class="k">if</span> <span class="s1">&#39;edit_fp_layers&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?timestamp=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">labelled_metric_name</span>
                            <span class="n">new_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">redirect_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                            <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">new_redirect_url</span>
                    <span class="k">if</span> <span class="s1">&#39;edit_fp_layers&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not returning redirect as edit_fp_layers request&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;returned redirect on original request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">))</span>
                        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IONOSPHERE_REQUEST_ARGS</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
                    <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                    <span class="c1"># Return data</span>
                    <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;calc_features&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">calculate_features</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;add_fp&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">create_feature_profile</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># @added 20191210 - Feature #3348: fp creation json response</span>
                        <span class="k">if</span> <span class="s1">&#39;format&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                            <span class="n">response_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">response_format</span> <span class="o">!=</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                                <span class="n">response_format</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># @added 20170317 - Feature #1960: ionosphere_layers - allow for floats</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d_boundary_limit&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">d_boundary_limit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1"> is not numeric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                        <span class="k">return</span> <span class="s1">&#39;Bad Request</span><span class="se">\n\n</span><span class="s1">invalid request argument - </span><span class="si">%s</span><span class="s1"> is not numeric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span> <span class="mi">400</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument OK - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">d_boundary_limit</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;e_boundary_limit&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">e_boundary_limit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1"> is not numeric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                        <span class="k">return</span> <span class="s1">&#39;Bad Request</span><span class="se">\n\n</span><span class="s1">invalid request argument - </span><span class="si">%s</span><span class="s1"> is not numeric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span> <span class="mi">400</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument OK - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e_boundary_limit</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fp_view&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">fp_view</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># @added 20170118 - Feature #1862: Ionosphere features profiles search page</span>
                <span class="c1"># Added fp_search parameter</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fp_search&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">fp_search</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># @added 20170120 -  Feature #1854: Ionosphere learn - generations</span>
                <span class="c1"># Added fp_learn parameter</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;learn&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># @added 20170305 - Feature #1960: ionosphere_layers</span>
                    <span class="c1"># Being passed through as a boolean from the Create features</span>
                    <span class="c1"># profile arguments and I cannot be arsed to track it down</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                        <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;features_profiles&#39;</span><span class="p">:</span>
                    <span class="n">fp_profiles</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="c1"># @added 20190503 - Branch #2646: slack - linting</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fp_profiles is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fp_profiles</span><span class="p">)</span>

                <span class="c1"># @added 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
                <span class="c1">#                   Task #2002: Review and correct incorrectly defined layers</span>
                <span class="c1"># Added layers and edit_fp_layers</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;layers_id&#39;</span><span class="p">:</span>
                    <span class="n">test_layer_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">layers_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_layer_id</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bad request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> not numeric&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: not a numeric id for the layers_id argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please pass a proper id&#39;</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;edit_fp_layers&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">edit_fp_layers</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                        <span class="n">edit_fp_layers</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">edit_fp_layers</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;edit_fp_layers is set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">edit_fp_layers</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;a_dated_list&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">dated_list</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;requested_timestamp&#39;</span><span class="p">:</span>
                    <span class="n">valid_rt_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                        <span class="n">valid_rt_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_rt_timestamp</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bad request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> not an epoch timestamp&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: not an epoch timestamp for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please pass a proper epoch timestamp&#39;</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">timestamp_numeric</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="n">valid_rt_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bad request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> not numeric&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: not a numeric epoch timestamp for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please pass a proper epoch timestamp&#39;</span><span class="p">})</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_rt_timestamp</span><span class="p">:</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 400</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;save_training_data&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;saved_td_label&#39;</span><span class="p">:</span>
                    <span class="n">saved_td_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;saved_training_data&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">saved_training_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">check_for_purged</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">saved_training_data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_view</span><span class="p">:</span>
                        <span class="n">check_for_purged</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span>
                    <span class="n">label_arg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">label_arg</span><span class="p">[:</span><span class="mi">255</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;label - </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp_td&#39;</span><span class="p">]:</span>
                    <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bad request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> not an epoch timestamp&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: not an epoch timestamp for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please pass a proper epoch timestamp&#39;</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">valid_timestamp</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">timestamp_numeric</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="c1"># @added 20190503 - Branch #2646: slack - linting</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;timestamp_numeric tests OK with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_numeric</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bad request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> not numeric&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: not a numeric epoch timestamp for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please pass a proper epoch timestamp&#39;</span><span class="p">})</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_timestamp</span><span class="p">:</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 400</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                    <span class="c1"># if not fp_view:</span>
                    <span class="k">if</span> <span class="n">check_for_purged</span><span class="p">:</span>
                        <span class="n">ionosphere_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">ionosphere_data_dir</span><span class="p">):</span>
                            <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                            <span class="n">purged_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_KEEP_TRAINING_TIMESERIES_FOR</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">purged_timestamp</span><span class="p">:</span>
                                <span class="c1"># @added 20200813 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
                                <span class="n">historical_training_data_exists</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span><span class="p">:</span>
                                    <span class="n">check_for_historical_training_data</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                                    <span class="c1"># @added 20200814 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
                                    <span class="c1"># Handle when a request is submitted to list</span>
                                    <span class="c1"># the training data for a timestamp, not for</span>
                                    <span class="c1"># a metric, e.g. ionosphere?timestamp_td=1597061559&amp;requested_timestamp=1597061559</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="s1">&#39;timestamp_td&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="s1">&#39;requested_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                                                <span class="n">check_for_historical_training_data</span> <span class="o">=</span> <span class="kc">True</span>

                                    <span class="k">for</span> <span class="n">historical_metric_namespace</span> <span class="ow">in</span> <span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span><span class="p">:</span>
                                        <span class="c1"># @added 20200814 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
                                        <span class="c1"># Handle when a request is submitted to list</span>
                                        <span class="c1"># the training data for a timestamp, so if</span>
                                        <span class="c1"># base_name is not set skip this check</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
                                            <span class="k">break</span>

                                        <span class="k">if</span> <span class="n">historical_metric_namespace</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                                            <span class="n">check_for_historical_training_data</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">break</span>
                                    <span class="k">if</span> <span class="n">check_for_historical_training_data</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checking for historical training data for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">ionosphere_data_dir</span><span class="p">))</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">historical_data</span><span class="p">,</span> <span class="n">ionosphere_data_dir</span> <span class="o">=</span> <span class="n">historical_data_dir_exists</span><span class="p">(</span><span class="s1">&#39;webapp&#39;</span><span class="p">,</span> <span class="n">ionosphere_data_dir</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">historical_data</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;using historical training data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ionosphere_data_dir</span><span class="p">)</span>
                                                <span class="n">historical_training_data_exists</span> <span class="o">=</span> <span class="kc">True</span>
                                                <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no historical training data found for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ionosphere_data_dir</span><span class="p">)</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                                            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: ionosphere_metric_data :: failed to determine whether this is historical training data&#39;</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">historical_training_data_exists</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> timestamp it to old to have training data&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: timestamp too old no training data exists, training data has been purged&#39;</span><span class="p">})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> no local training data dir found - </span><span class="si">%s</span><span class="s1"> will check other Skyline remote hosts&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">ionosphere_data_dir</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> no timestamp training data dir found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">ionosphere_data_dir</span><span class="p">))</span>

                                <span class="c1"># @added 20201127 - Feature #3824: get_cluster_data</span>
                                <span class="c1">#                   Feature #3820: HORIZON_SHARDS</span>
                                <span class="c1"># Determine which remote Skyline host the metric</span>
                                <span class="c1"># assigned to and return the client a redirect</span>
                                <span class="c1"># to the remote Skyline instance that will have</span>
                                <span class="c1"># the ionosphere training data for the metric</span>
                                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                    <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                                    <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
                                    <span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
                                    <span class="c1"># Roll back change - breaking existing metrics with colons</span>
                                    <span class="c1"># redis_metric_name = url_encode_metric_name(redis_metric_name)</span>

                                    <span class="n">metric_assigned_to</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checking which remote Skyline instance is assigned - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="kc">None</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;unique_metrics&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">,</span> <span class="n">only_host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get unique_metrics from the remote Skyline instance - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                            <span class="k">if</span> <span class="n">remote_unique_metrics</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> unique_metrics from the remote Skyline instance - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_unique_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                                                <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">remote_unique_metrics</span><span class="p">:</span>
                                                    <span class="n">metric_assigned_to</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;found </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                                                    <span class="k">break</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: checking which remote Skyline instance is assigned metric to check training_data&#39;</span><span class="p">)</span>

                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_assigned_to</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metric </span><span class="si">%s</span><span class="s1"> not found on any Skyline host&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no training data dir exists only any Skyline host - &#39;</span> <span class="o">+</span> <span class="n">ionosphere_data_dir</span> <span class="o">+</span> <span class="s1">&#39; - go on... nothing here.&#39;</span><span class="p">})</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># @modified 20201210 - Feature #3824: get_cluster_data</span>
                                        <span class="c1">#                      Feature #3820: HORIZON_SHARDS</span>
                                        <span class="c1"># alt_redirect_url = &#39;%s/ionosphere?timestamp=%s&amp;metric=%s&#39; % (str(metric_assigned_to), str(value), str(base_name))</span>
                                        <span class="n">url_protocol</span> <span class="o">=</span> <span class="s1">&#39;http&#39;</span>
                                        <span class="k">if</span> <span class="s1">&#39;https&#39;</span> <span class="ow">in</span> <span class="n">metric_assigned_to</span><span class="p">:</span>
                                            <span class="n">url_protocol</span> <span class="o">=</span> <span class="s1">&#39;https&#39;</span>
                                        <span class="c1"># @added 20201210 - Feature #3824: get_cluster_data</span>
                                        <span class="c1"># Handle authentication details passed</span>
                                        <span class="c1"># in the URL, badly as there is no other</span>
                                        <span class="c1"># way to handle it, other than badly,</span>
                                        <span class="c1"># not recommended, hence not adding to</span>
                                        <span class="c1"># settings, but sometimes necessary.</span>
                                        <span class="k">if</span> <span class="n">PASS_AUTH_ON_REDIRECT</span><span class="p">:</span>
                                            <span class="n">url_auth</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:\/\/</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_protocol</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">username</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">password</span><span class="p">))</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">url_auth</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:\/\/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_protocol</span><span class="p">)</span>
                                        <span class="n">replace_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:\/\/&#39;</span> <span class="o">%</span> <span class="n">url_protocol</span>
                                        <span class="n">url_with_auth</span> <span class="o">=</span> <span class="n">metric_assigned_to</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">replace_string</span><span class="p">,</span> <span class="n">url_auth</span><span class="p">)</span>
                                        <span class="c1"># alt_redirect_url = &#39;%s/ionosphere?&#39; % (str(metric_assigned_to))</span>
                                        <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">url_with_auth</span><span class="p">))</span>
                                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                                            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                                                    <span class="n">value</span> <span class="o">=</span> <span class="n">labelled_metric_name</span>
                                            <span class="n">new_alt_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                                            <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="n">new_alt_redirect_url</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;redirecting client to - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">alt_redirect_url</span><span class="p">)</span>
                                        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                                        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                                        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>

                                <span class="c1"># @added 20180713 - Branch #2270: luminosity</span>
                                <span class="c1"># Use settings.ALTERNATIVE_SKYLINE_URLS if they are</span>
                                <span class="c1"># declared</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALTERNATIVE_SKYLINE_URLS</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                                    <span class="n">alternative_urls</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="k">for</span> <span class="n">alt_url</span> <span class="ow">in</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                                        <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">alt_url</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                                            <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">alt_url</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_alternative_urls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                            <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                                            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>
                                        <span class="n">alternative_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>
                                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no training data dir exists on this Skyline instance try at the alternative URLS listed below:&#39;</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;passing alternative_urls - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alternative_urls</span><span class="p">))</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                                        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                                            <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">display_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                                            <span class="n">alternative_urls</span><span class="o">=</span><span class="n">alternative_urls</span><span class="p">,</span>
                                            <span class="n">fp_view</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                                            <span class="n">print_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="mi">200</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no training data dir exists - &#39;</span> <span class="o">+</span> <span class="n">ionosphere_data_dir</span> <span class="o">+</span> <span class="s1">&#39; - go on... nothing here.&#39;</span><span class="p">})</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_timestamp</span><span class="p">:</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span>
                    <span class="n">requested_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">timestamp_arg</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timestamp_td&#39;</span><span class="p">:</span>
                    <span class="n">timestamp_td_arg</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">requested_timestamp_td</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="c1"># determine_metric = True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;requested_timestamp&#39;</span><span class="p">:</span>
                    <span class="n">td_requested_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_td&#39;</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
                    <span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
                    <span class="c1"># Roll back change - breaking existing metrics with colons</span>
                    <span class="c1"># metric_name = url_encode_metric_name(metric_name)</span>

                    <span class="c1"># @added 20220727 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">metric_name</span><span class="p">:</span>
                                <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">value</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="c1"># @added 20221020 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="k">if</span> <span class="s1">&#39;tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                                <span class="n">unique_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">value</span>
                                <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                                <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                                <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_metric_id_from_base_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">value</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                    <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                        <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
                        <span class="c1"># for redis_ip, redis_port in settings.OTHER_SKYLINE_REDIS_INSTANCES:</span>
                        <span class="k">for</span> <span class="n">redis_ip</span><span class="p">,</span> <span class="n">redis_port</span><span class="p">,</span> <span class="n">redis_password</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                            <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
                                        <span class="n">OTHER_REDIS_CONN</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_password</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">OTHER_REDIS_CONN</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">))</span>
                                    <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OTHER_REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric found in Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">other_unique_metrics</span><span class="p">:</span>
                                <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># @added 20201127 - Feature #3824: get_cluster_data</span>
                    <span class="c1">#                   Feature #3820: HORIZON_SHARDS</span>
                    <span class="c1"># Change from the deprecated OTHER_SKYLINE_REDIS_INSTANCES</span>
                    <span class="c1"># to use the REMOTE_SKYLINE_INSTANCES and get_cluster_data</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                        <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;unique_metrics&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get unique_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">remote_unique_metrics</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> remote unique_metrics from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_unique_metrics</span><span class="p">)))</span>
                            <span class="n">unique_metrics_list</span> <span class="o">=</span> <span class="n">unique_metrics</span> <span class="o">+</span> <span class="n">remote_unique_metrics</span>
                            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_metrics_list</span><span class="p">))</span>

                    <span class="c1"># if metric_name not in unique_metrics:</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric_found</span><span class="p">:</span>
                        <span class="c1"># @added 20170917 - Bug #2158: webapp - redis metric check - existing but sparsely represented metrics</span>
                        <span class="c1"># If this is an fp_view=true, it means that either the</span>
                        <span class="c1"># metric is sparsely represented or no longer exists,</span>
                        <span class="c1"># but an fp exists so continue and do not 404</span>
                        <span class="k">if</span> <span class="n">fp_view</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in Redis, but fp passed so continuing&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                        <span class="c1"># @added 20200715 - Task #3648: webapp - fp_search - do not use Redis metric check</span>
                        <span class="c1"># Do not use the Redis metric check result in a webapp</span>
                        <span class="c1"># fp_search request as this allows retried metric fps to</span>
                        <span class="c1"># accessed</span>
                        <span class="k">elif</span> <span class="n">fp_search_req</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;IONOSPHERE_REQUEST_ARGS check - </span><span class="si">%s</span><span class="s1"> not in Redis, but fp_search request so continuing&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                        <span class="c1"># @added 20200808</span>
                        <span class="k">elif</span> <span class="n">saved_training_data</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;IONOSPHERE_REQUEST_ARGS check - </span><span class="si">%s</span><span class="s1"> not in Redis, but saved_training_data request so continuing&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no metric (not fp_view, fp_search_req or saved_training_data) - </span><span class="si">%s</span><span class="s1"> - exists in Redis&#39;</span> <span class="o">%</span> <span class="n">metric_name</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                            <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                            <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                            <span class="c1"># return resp, 404</span>
                            <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                    <span class="n">metric_arg</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># @added 20220729 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_id&#39;</span> <span class="ow">and</span> <span class="n">labelled_metric_name</span> <span class="ow">and</span> <span class="n">base_name</span> <span class="ow">and</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                    <span class="n">metric_arg</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_td&#39;</span><span class="p">:</span>
                    <span class="n">metric_td_arg</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">metric_arg</span> <span class="ow">or</span> <span class="n">metric_td_arg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_td&#39;</span><span class="p">]:</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
                        <span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
                        <span class="c1"># Roll back change - breaking existing metrics with colons</span>
                        <span class="c1"># base_name = url_encode_metric_name(base_name)</span>

                <span class="c1"># @added 20180804 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
                <span class="k">if</span> <span class="n">timestamp_arg</span> <span class="ow">and</span> <span class="n">metric_arg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;load_derivative_graphs&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                            <span class="n">set_derivative_metric</span> <span class="o">=</span> <span class="n">set_metric_as_derivative</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                            <span class="c1"># @added 20180918 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
                            <span class="c1"># Remove any graphite_now png files that are present</span>
                            <span class="c1"># so that the webapp recreates the pngs as</span>
                            <span class="c1"># nonNegativeDerivative graphs.</span>
                            <span class="c1"># TODO - handle caching</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                                <span class="n">ionosphere_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span>
                                    <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">)</span>
                                <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;graphite_now&#39;</span>
                                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">ionosphere_data_dir</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                                        <span class="n">remove_graphite_now_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ionosphere_data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_graphite_now_file</span><span class="p">)</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed graphite_now image at user request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">remove_graphite_now_file</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to remove graphite_now images&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">set_derivative_metric</span><span class="p">:</span>
                    <span class="n">return_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                        <span class="n">return_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">))</span>
                    <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">timestamp_arg</span> <span class="ow">and</span> <span class="n">metric_arg</span><span class="p">:</span>
                    <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

                    <span class="c1"># @added 20221020 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="k">if</span> <span class="s1">&#39;tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">labelled_metric_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to interpolate timeseries_dir from labelled_metric_name for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_view</span><span class="p">:</span>
                        <span class="n">ionosphere_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span>
                            <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">)</span>

                        <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
                        <span class="k">if</span> <span class="n">saved_training_data</span><span class="p">:</span>
                            <span class="n">ionosphere_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_saved/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span>
                                <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">)</span>

                        <span class="c1"># @added 20200813 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
                        <span class="n">historical_training_data_exists</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1"># @added 20200814 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
                        <span class="n">training_data_dir_found</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">ionosphere_data_dir</span><span class="p">):</span>

                            <span class="c1"># @added 20200813 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
                            <span class="n">historical_training_data_exists</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checking for historical training data for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ionosphere_data_dir</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">historical_data</span><span class="p">,</span> <span class="n">ionosphere_data_dir</span> <span class="o">=</span> <span class="n">historical_data_dir_exists</span><span class="p">(</span><span class="s1">&#39;webapp&#39;</span><span class="p">,</span> <span class="n">ionosphere_data_dir</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">historical_data</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;using historical training data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ionosphere_data_dir</span><span class="p">)</span>
                                        <span class="n">historical_training_data_exists</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="c1"># @added 20200814 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
                                        <span class="n">training_data_dir_found</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no historical training data found for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ionosphere_data_dir</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: ionosphere_metric_data :: failed to determine whether this is historical training data&#39;</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># @added 20200814 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
                            <span class="n">training_data_dir_found</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="c1"># @added 20201127 - Feature #3824: get_cluster_data</span>
                        <span class="c1">#                   Feature #3820: HORIZON_SHARDS</span>
                        <span class="c1"># Determine which remote Skyline host the metric</span>
                        <span class="c1"># assigned to</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">training_data_dir_found</span><span class="p">:</span>
                            <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                            <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
                            <span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
                            <span class="c1"># Roll back change - breaking existing metrics with colons</span>
                            <span class="c1"># redis_metric_name = url_encode_metric_name(redis_metric_name)</span>

                            <span class="n">metric_assigned_to</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checking which remote Skyline instance is assigned - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">remote_unique_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;unique_metrics&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">,</span> <span class="n">only_host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get unique_metrics from the remote Skyline instance - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                    <span class="k">if</span> <span class="n">remote_unique_metrics</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got </span><span class="si">%s</span><span class="s1"> unique_metrics from the remote Skyline instance - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_unique_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                                        <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">remote_unique_metrics</span><span class="p">:</span>
                                            <span class="n">metric_assigned_to</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;found </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                                            <span class="k">break</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: checking which remote Skyline instance is assigned metric to check training_data&#39;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_assigned_to</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;metric </span><span class="si">%s</span><span class="s1"> not found on any Skyline host&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># @modified 20201210 - Feature #3824: get_cluster_data</span>
                                <span class="c1">#                      Feature #3820: HORIZON_SHARDS</span>
                                <span class="c1"># alt_redirect_url = &#39;%s/ionosphere?timestamp=%s&amp;metric=%s&#39; % (str(metric_assigned_to), str(value), str(base_name))</span>
                                <span class="n">url_protocol</span> <span class="o">=</span> <span class="s1">&#39;http&#39;</span>
                                <span class="k">if</span> <span class="s1">&#39;https&#39;</span> <span class="ow">in</span> <span class="n">metric_assigned_to</span><span class="p">:</span>
                                    <span class="n">url_protocol</span> <span class="o">=</span> <span class="s1">&#39;https&#39;</span>
                                <span class="k">if</span> <span class="n">PASS_AUTH_ON_REDIRECT</span><span class="p">:</span>
                                    <span class="n">url_auth</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">@&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_protocol</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">username</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">password</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">url_auth</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:\/\/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_protocol</span><span class="p">)</span>
                                <span class="n">replace_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://&#39;</span> <span class="o">%</span> <span class="n">url_protocol</span>
                                <span class="n">url_with_auth</span> <span class="o">=</span> <span class="n">metric_assigned_to</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">replace_string</span><span class="p">,</span> <span class="n">url_auth</span><span class="p">)</span>
                                <span class="c1"># alt_redirect_url = &#39;%s/ionosphere?&#39; % (str(metric_assigned_to))</span>
                                <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">url_with_auth</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                                            <span class="n">value</span> <span class="o">=</span> <span class="n">labelled_metric_name</span>
                                    <span class="n">new_alt_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                                    <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="n">new_alt_redirect_url</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;redirecting client to - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">alt_redirect_url</span><span class="p">)</span>
                                <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>

                        <span class="c1"># @added 20200814 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
                        <span class="c1"># if not historical_training_data_exists:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">training_data_dir_found</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> no timestamp metric training data dir found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">ionosphere_data_dir</span><span class="p">))</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no training data dir exists - &#39;</span> <span class="o">+</span> <span class="n">ionosphere_data_dir</span> <span class="o">+</span> <span class="s1">&#39; - go on... nothing here.&#39;</span><span class="p">})</span>
                            <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                            <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                            <span class="c1"># return resp, 404</span>
                            <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ionosphere_profiles_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">,</span>
                            <span class="n">requested_timestamp</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">ionosphere_profiles_dir</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> no timestamp metric features profile dir found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">ionosphere_profiles_dir</span><span class="p">))</span>

                            <span class="c1"># @added 20180715 - Branch #2270: luminosity</span>
                            <span class="c1"># Use settings.ALTERNATIVE_SKYLINE_URLS if they are</span>
                            <span class="c1"># declared and redirect to alternative URL/s if no</span>
                            <span class="c1"># features profile directory exists on the Skyline</span>
                            <span class="c1"># instance.</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALTERNATIVE_SKYLINE_URLS</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                                <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="n">alternative_urls</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">alt_url</span> <span class="ow">in</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                                    <span class="n">alt_redirect_url_base</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alt_url</span><span class="p">)</span>
                                    <span class="n">request_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                                    <span class="n">request_endpoint</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">)</span>
                                    <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="n">request_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">request_endpoint</span><span class="p">,</span> <span class="n">alt_redirect_url_base</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_alternative_urls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;redirecting to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">))</span>
                                        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                                        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>
                                    <span class="n">alternative_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>
                                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no features profile dir exists on this Skyline instance try at the alternative URLS listed below:&#39;</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;passing alternative_urls - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alternative_urls</span><span class="p">))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

                                    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                                        <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">display_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                                        <span class="n">alternative_urls</span><span class="o">=</span><span class="n">alternative_urls</span><span class="p">,</span>
                                        <span class="n">fp_view</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                                        <span class="n">print_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="mi">200</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no features profile dir exists - &#39;</span> <span class="o">+</span> <span class="n">ionosphere_profiles_dir</span> <span class="o">+</span> <span class="s1">&#39; - go on... nothing here.&#39;</span><span class="p">})</span>
                                <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                                <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                                <span class="c1"># return resp, 404</span>
                                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;arguments validated - OK&#39;</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="n">debug_on</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">fp_view</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;features_profiles&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;training_data&#39;</span>

    <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
    <span class="k">if</span> <span class="n">saved_training_data</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;saved_training_data&#39;</span>

    <span class="n">fp_view_on</span> <span class="o">=</span> <span class="n">fp_view</span>

    <span class="n">do_first</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">fp_view</span><span class="p">:</span>
        <span class="n">do_first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_td&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp_td&#39;</span><span class="p">,</span>
            <span class="s1">&#39;requested_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;features_profiles&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_id&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i_arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i_arg</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">do_first</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">request_args_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dated_list</span><span class="p">:</span>
        <span class="n">do_first</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">do_first</span><span class="p">:</span>
        <span class="n">listed_by</span> <span class="o">=</span> <span class="s1">&#39;metric&#39;</span>
        <span class="k">if</span> <span class="n">dated_list</span><span class="p">:</span>
            <span class="n">listed_by</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20220729 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                      Branch #4300: prometheus</span>
            <span class="c1"># Added labelled_metric_base_names</span>
            <span class="n">mpaths</span><span class="p">,</span> <span class="n">unique_m</span><span class="p">,</span> <span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span><span class="p">,</span> <span class="n">labelled_metric_base_names</span> <span class="o">=</span> <span class="n">ionosphere_data</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">unique_metrics</span><span class="o">=</span><span class="n">unique_m</span><span class="p">,</span> <span class="n">list_by</span><span class="o">=</span><span class="n">listed_by</span><span class="p">,</span>
                <span class="n">unique_timestamps</span><span class="o">=</span><span class="n">unique_ts</span><span class="p">,</span> <span class="n">human_dates</span><span class="o">=</span><span class="n">hdates</span><span class="p">,</span>
                <span class="n">metric_td_dirs</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span><span class="p">),</span> <span class="n">td_files</span><span class="o">=</span><span class="n">mpaths</span><span class="p">,</span>
                <span class="n">requested_timestamp</span><span class="o">=</span><span class="n">td_requested_timestamp</span><span class="p">,</span> <span class="n">fp_view</span><span class="o">=</span><span class="n">fp_view_on</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="c1"># @modified 20220729 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                      Branch #4300: prometheus</span>
                <span class="c1"># Added labelled_metric_base_names</span>
                <span class="n">labelled_metric_base_names</span><span class="o">=</span><span class="n">labelled_metric_base_names</span><span class="p">,</span>
                <span class="n">labelled_metric_base_name</span><span class="o">=</span><span class="n">labelled_metric_base_name</span><span class="p">,</span>
                <span class="n">labelled_metric_name</span><span class="o">=</span><span class="n">labelled_metric_name</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="c1"># @added 20170118 - Feature #1862: Ionosphere features profiles search page</span>
    <span class="c1"># Added fp_search parameter</span>
    <span class="n">fp_search_param</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">fp_search</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: fp_search was True&#39;</span><span class="p">)</span>
        <span class="n">fp_search_param</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">listed_by</span> <span class="o">=</span> <span class="s1">&#39;search&#39;</span>
        <span class="c1"># get_options = [</span>
        <span class="c1">#     &#39;full_duration&#39;, &#39;enabled&#39;, &#39;tsfresh_version&#39;, &#39;generation&#39;]</span>
        <span class="n">fd_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20170221 - Feature #1862: Ionosphere features profiles search page</span>
            <span class="c1"># fd_list, en_list, tsfresh_list, gen_list, fail_msg, trace = ionosphere_search_defaults(get_options)</span>
            <span class="c1"># @modified 20200715 - Task #3648: webapp - fp_search - do not use Redis metric check</span>
            <span class="c1">#                      Task #2446: Optimize Ionosphere</span>
            <span class="c1"># Added missing search_success variable</span>
            <span class="c1"># features_profiles, fp_count, mc, cc, gc, fd_list, en_list, tsfresh_list, gen_list, fail_msg, trace = ionosphere_search(True, False)</span>
            <span class="n">features_profiles</span><span class="p">,</span> <span class="n">fp_count</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">fd_list</span><span class="p">,</span> <span class="n">en_list</span><span class="p">,</span> <span class="n">tsfresh_list</span><span class="p">,</span> <span class="n">gen_list</span><span class="p">,</span> <span class="n">search_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_search</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: fd_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fd_list</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fd_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                    <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">list_by</span><span class="o">=</span><span class="n">listed_by</span><span class="p">,</span> <span class="n">fp_search</span><span class="o">=</span><span class="n">fp_search_param</span><span class="p">,</span>
                    <span class="n">full_duration_list</span><span class="o">=</span><span class="n">fd_list</span><span class="p">,</span> <span class="n">enabled_list</span><span class="o">=</span><span class="n">en_list</span><span class="p">,</span>
                    <span class="n">tsfresh_version_list</span><span class="o">=</span><span class="n">tsfresh_list</span><span class="p">,</span> <span class="n">generation_list</span><span class="o">=</span><span class="n">gen_list</span><span class="p">,</span>
                    <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                    <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                    <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">metric_td_arg</span><span class="p">:</span>
        <span class="n">listed_by</span> <span class="o">=</span> <span class="s1">&#39;metric_td_dirs&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20220729 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                      Branch #4300: prometheus</span>
            <span class="c1"># Added labelled_metric_base_names</span>
            <span class="n">mpaths</span><span class="p">,</span> <span class="n">unique_m</span><span class="p">,</span> <span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span><span class="p">,</span> <span class="n">labelled_metric_base_names</span> <span class="o">=</span> <span class="n">ionosphere_data</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">metric_td_dirs</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span><span class="p">),</span>
                <span class="n">list_by</span><span class="o">=</span><span class="n">listed_by</span><span class="p">,</span> <span class="n">for_metric</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span> <span class="n">td_files</span><span class="o">=</span><span class="n">mpaths</span><span class="p">,</span>
                <span class="n">requested_timestamp</span><span class="o">=</span><span class="n">td_requested_timestamp</span><span class="p">,</span> <span class="n">fp_view</span><span class="o">=</span><span class="n">fp_view_on</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="c1"># @modified 20220729 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                      Branch #4300: prometheus</span>
                <span class="c1"># Added labelled_metric_base_names</span>
                <span class="n">labelled_metric_base_names</span><span class="o">=</span><span class="n">labelled_metric_base_names</span><span class="p">,</span>
                <span class="n">labelled_metric_base_name</span><span class="o">=</span><span class="n">labelled_metric_base_name</span><span class="p">,</span>
                <span class="n">labelled_metric_name</span><span class="o">=</span><span class="n">labelled_metric_name</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">timestamp_td_arg</span><span class="p">:</span>
        <span class="c1"># Note to self.  Can we carry the referring timestamp through and when</span>
        <span class="c1"># a metric is selected the time is the only one wrapped in &lt;code&gt; .e.g red?</span>
        <span class="n">listed_by</span> <span class="o">=</span> <span class="s1">&#39;timestamp_td_dirs&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20220729 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="c1"># Added labelled_metric_base_names</span>
            <span class="c1"># mpaths, unique_m, unique_ts, hdates = ionosphere_get_metrics_dir(requested_timestamp_td, context)</span>
            <span class="n">mpaths</span><span class="p">,</span> <span class="n">unique_m</span><span class="p">,</span> <span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span><span class="p">,</span> <span class="n">labelled_metric_base_names</span> <span class="o">=</span> <span class="n">ionosphere_get_metrics_dir</span><span class="p">(</span><span class="n">requested_timestamp_td</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">unique_metrics</span><span class="o">=</span><span class="n">unique_m</span><span class="p">,</span> <span class="n">list_by</span><span class="o">=</span><span class="n">listed_by</span><span class="p">,</span>
                <span class="n">unique_timestamps</span><span class="o">=</span><span class="n">unique_ts</span><span class="p">,</span> <span class="n">human_dates</span><span class="o">=</span><span class="n">hdates</span><span class="p">,</span> <span class="n">td_files</span><span class="o">=</span><span class="n">mpaths</span><span class="p">,</span>
                <span class="n">metric_td_dirs</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span><span class="p">),</span>
                <span class="n">requested_timestamp</span><span class="o">=</span><span class="n">td_requested_timestamp</span><span class="p">,</span> <span class="n">fp_view</span><span class="o">=</span><span class="n">fp_view_on</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="c1"># @modified 20220729 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                      Branch #4300: prometheus</span>
                <span class="c1"># Added labelled_metric_base_name</span>
                <span class="n">labelled_metric_base_name</span><span class="o">=</span><span class="n">labelled_metric_base_name</span><span class="p">,</span>
                <span class="n">labelled_metric_name</span><span class="o">=</span><span class="n">labelled_metric_name</span><span class="p">,</span>
                <span class="n">labelled_metric_base_names</span><span class="o">=</span><span class="n">labelled_metric_base_names</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="c1"># @added 20221230 - Feature #4772: webapp - link to current VictoriaMetrics graph</span>
    <span class="n">g_until_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">g_from_ts</span> <span class="o">=</span> <span class="n">g_until_ts</span> <span class="o">-</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">timestamp_arg</span> <span class="ow">and</span> <span class="n">metric_arg</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20170104 - Feature #1842: Ionosphere - Graphite now graphs</span>
            <span class="c1"># Added the full_duration_in_hours and changed graph color from blue to orange</span>
            <span class="c1"># full_duration_in_hours</span>
            <span class="c1"># GRAPH_URL = GRAPHITE_PROTOCOL + &#39;://&#39; + GRAPHITE_HOST + &#39;:&#39; + GRAPHITE_PORT + &#39;/render/?width=1400&amp;from=-&#39; + TARGET_HOURS + &#39;hour&amp;target=&#39;</span>
            <span class="c1"># A regex is required to change the TARGET_HOURS, no? extend do not modify?</span>
            <span class="c1"># Not certain will review after Dude morning excersion</span>
            <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
            <span class="c1"># graph_url = &#39;%scactiStyle(%s)%s&amp;colorList=blue&#39; % (</span>
            <span class="n">graph_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">cactiStyle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPH_URL</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">)</span>
            <span class="c1"># @added 20221230 - Feature #4772: webapp - link to current VictoriaMetrics graph</span>
            <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                <span class="n">graph_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/utilities?timeseries_graph=true&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;from_timestamp=</span><span class="si">%s</span><span class="s1">&amp;until_timestamp=</span><span class="si">%s</span><span class="s1">&amp;data_source=victoriametrics&amp;downsample_at=0&amp;downsample_by=mean&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="n">labelled_metric_name</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">g_from_ts</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">g_until_ts</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to interpolate graph_url - </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="n">graph_url</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20170604 - Feature #2034: analyse_derivatives</span>
        <span class="c1"># Added nonNegativeDerivative to strictly</span>
        <span class="c1"># increasing monotonically metrics in graph_url</span>
        <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20211012 - Feature #4280: aet.metrics_manager.derivative_metrics Redis hash</span>
            <span class="c1"># derivative_metrics = list(REDIS_CONN.smembers(&#39;derivative_metrics&#39;))</span>
            <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.metrics_manager.derivative_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
        <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
        <span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
        <span class="c1"># Roll back change - breaking existing metrics with colons</span>
        <span class="c1"># redis_metric_name = url_encode_metric_name(redis_metric_name)</span>

        <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">derivative_metrics</span><span class="p">:</span>
            <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;non_derivative_metrics&#39;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">skip_derivative</span> <span class="o">=</span> <span class="n">in_list</span><span class="p">(</span><span class="n">redis_metric_name</span><span class="p">,</span> <span class="n">non_derivative_metrics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">skip_derivative</span><span class="p">:</span>
                <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
                <span class="c1"># graph_url = &#39;%scactiStyle(nonNegativeDerivative(%s))%s&amp;colorList=blue&#39; % (</span>
                <span class="n">graph_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">cactiStyle(nonNegativeDerivative(</span><span class="si">%s</span><span class="s1">),</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">GRAPH_URL</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">)</span>
                <span class="c1"># @added 20221230 - Feature #4772: webapp - link to current VictoriaMetrics graph</span>
                <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                    <span class="n">graph_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/utilities?timeseries_graph=true&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;from_timestamp=</span><span class="si">%s</span><span class="s1">&amp;until_timestamp=</span><span class="si">%s</span><span class="s1">&amp;data_source=victoriametrics&amp;downsample_at=0&amp;downsample_by=mean&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="n">labelled_metric_name</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">g_from_ts</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">g_until_ts</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to interpolate graph_url - </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">graph_url</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
        <span class="c1">#                   Task #2002: Review and correct incorrectly defined layers</span>
        <span class="n">layers_updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;edit_fp_layers&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">edit_fp_layers_arg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edit_fp_layers&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">edit_fp_layers_arg</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">edit_fp_layers</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;editing layers id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">layers_id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not editing layers id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">layers_id</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">edit_fp_layers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;editing layers id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">layers_id</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">layers_updated</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">edit_ionosphere_layers</span><span class="p">(</span><span class="n">layers_id</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;updated layers id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">layers_id</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to update layer calling edit_ionosphere_layers&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">layers_updated</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to update layer&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not editing layers&#39;</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">f_calc</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">fp_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fp_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">calculate_features</span> <span class="ow">or</span> <span class="n">create_feature_profile</span> <span class="ow">or</span> <span class="n">fp_view</span><span class="p">:</span>
            <span class="n">successful</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fp_csv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20221208 - Feature #4756: Use gevent gunicorn worker_class</span>
                <span class="c1">#                      Feature #4732: flux vortex</span>
                <span class="c1"># Changed from calling calculate_features_profile directly as</span>
                <span class="c1"># gevent does not play nicely with multiprocessing that is</span>
                <span class="c1"># called by tsfresh.  Lots/every option was tried using gevent</span>
                <span class="c1"># threadpool, threading, etc, etc and although most of these</span>
                <span class="c1"># methods should work, they are end up hanging or erroring with</span>
                <span class="c1"># child watchers are only available on the default loop.</span>
                <span class="c1"># Attempts were made to not monkey patch thread and socket as</span>
                <span class="c1"># well to no avail.</span>
                <span class="c1"># The workaround that has been implemented is to start another</span>
                <span class="c1"># gunicorn process that has a worker_class of sync that</span>
                <span class="c1"># specifically handles running the calculate_features_profile.</span>
                <span class="c1"># This process is another flask app called webapp_features_profile.py</span>
                <span class="c1"># fp_csv, successful, fp_exists, fp_id, fail_msg, traceback_format_exc, f_calc = calculate_features_profile(skyline_app, requested_timestamp, base_name, context)</span>
                <span class="c1"># fp_csv, successful, fp_exists, fp_id, fail_msg, traceback_format_exc, f_calc = gevent_spawn(calculate_features_profile(skyline_app, requested_timestamp, base_name, context))</span>
                <span class="c1"># g = pool.spawn(calculate_features_profile, (skyline_app, requested_timestamp, base_name, context))</span>
                <span class="c1"># fp_csv, successful, fp_exists, fp_id, fail_msg, traceback_format_exc, f_calc = thread_pool.spawn(calculate_features_profile, skyline_app, requested_timestamp, base_name, context).get()</span>
                <span class="c1"># pool.join(timeout=60, raise_error=True)</span>
                <span class="c1"># fp_csv, successful, fp_exists, fp_id, fail_msg, traceback_format_exc, f_calc = pool.spawn(calculate_features_profile(skyline_app, requested_timestamp, base_name, context)).get()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fp_url</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1:</span><span class="si">%s</span><span class="s1">/ionosphere_features_profile&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">((</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_PORT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;requested_timestamp&#39;</span><span class="p">:</span> <span class="n">requested_timestamp</span><span class="p">,</span> <span class="s1">&#39;base_name&#39;</span><span class="p">:</span> <span class="n">base_name</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">}</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">fp_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
                    <span class="n">r_json</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="n">fp_csv</span> <span class="o">=</span> <span class="n">r_json</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;fp_csv&#39;</span><span class="p">]</span>
                    <span class="n">successful</span> <span class="o">=</span> <span class="n">r_json</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;successful&#39;</span><span class="p">]</span>
                    <span class="n">fp_exists</span> <span class="o">=</span> <span class="n">r_json</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;fp_exists&#39;</span><span class="p">]</span>
                    <span class="n">fp_id</span> <span class="o">=</span> <span class="n">r_json</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;fp_id&#39;</span><span class="p">]</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="n">r_json</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;fail_msg&#39;</span><span class="p">]</span>
                    <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">r_json</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;traceback_format_exc&#39;</span><span class="p">]</span>
                    <span class="n">f_calc</span> <span class="o">=</span> <span class="n">r_json</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;f_calc&#39;</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got fp_csv from webapp_features_profile app - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">fp_csv</span><span class="p">)))</span>

                    <span class="c1"># @added 20230626</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">successful</span> <span class="ow">and</span> <span class="n">fail_msg</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;insufficient data to create profile&#39;</span> <span class="ow">in</span> <span class="n">fail_msg</span><span class="p">:</span>
                            <span class="n">successful</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                            <span class="n">insufficient_data_for_training</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to get calculated features from webapp_features_profile app - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to calculate features&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="ow">not</span> <span class="n">successful</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp_csv</span><span class="p">)):</span>
                <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp_csv</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
                        <span class="c1"># @modified 20191029 - Task #3302: Handle csv.reader in py3</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># reader = csv.reader(fr, delimiter=&#39;,&#39;)</span>
                        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">iterdecode</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
                            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to read csv features from fp_csv - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_csv</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">generation_zero</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">create_feature_profile</span> <span class="ow">or</span> <span class="n">fp_view</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">create_feature_profile</span><span class="p">:</span>
                <span class="c1"># Submit to Ionosphere to run tsfresh on</span>
                <span class="n">create_feature_profile</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_id</span><span class="p">:</span>
                <span class="c1"># @modified 20170114 -  Feature #1854: Ionosphere learn - generations</span>
                <span class="c1"># Added parent_id and generation as all features profiles that</span>
                <span class="c1"># are created via the UI will be generation 0</span>
                <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">generation</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ionosphere_job</span> <span class="o">=</span> <span class="s1">&#39;learn_fp_human&#39;</span>
                <span class="c1"># @added 20190503 - Branch #2646: slack</span>
                <span class="c1"># Added slack_ionosphere_job</span>
                <span class="n">slack_ionosphere_job</span> <span class="o">=</span> <span class="n">ionosphere_job</span>

                <span class="c1"># @added 20200216 - Feature #3450: Handle multiple requests to create a features profile</span>
                <span class="c1"># Ensure that one features profile can only be created if</span>
                <span class="c1"># multiple requests are received to create a features profile</span>
                <span class="n">fp_pending</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;fp_pending.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                    <span class="n">fp_pending</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to determine if a features profile is pending&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">create_feature_profile</span> <span class="ow">and</span> <span class="n">fp_pending</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fp pending for - </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">response_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;pending&quot;</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;fp_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span>
                        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Notice: a features profile is already being created for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please click the back button and refresh the page&#39;</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">200</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20170120 -  Feature #1854: Ionosphere learn - generations</span>
                    <span class="c1"># Added fp_learn parameter to allow the user to not learn the</span>
                    <span class="c1"># use_full_duration_days</span>
                    <span class="c1"># fp_id, fp_in_successful, fp_exists, fail_msg, traceback_format_exc = create_features_profile(skyline_app, requested_timestamp, base_name, context, ionosphere_job, parent_id, generation, fp_learn)</span>
                    <span class="c1"># @modified 20190503 - Branch #2646: slack</span>
                    <span class="c1"># Added slack_ionosphere_job</span>
                    <span class="c1"># fp_id, fp_in_successful, fp_exists, fail_msg, traceback_format_exc = create_features_profile(skyline_app, requested_timestamp, base_name, context, ionosphere_job, parent_id, generation, fp_learn)</span>
                    <span class="c1"># @modified 20190919 - Feature #3230: users DB table</span>
                    <span class="c1">#                      Ideas #2476: Label and relate anomalies</span>
                    <span class="c1">#                      Feature #2516: Add label to features profile</span>
                    <span class="c1"># Added user_id and label</span>
                    <span class="c1"># fp_id, fp_in_successful, fp_exists, fail_msg, traceback_format_exc = create_features_profile(skyline_app, requested_timestamp, base_name, context, ionosphere_job, parent_id, generation, fp_learn, slack_ionosphere_job)</span>
                    <span class="n">fp_id</span><span class="p">,</span> <span class="n">fp_in_successful</span><span class="p">,</span> <span class="n">fp_exists</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">create_features_profile</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">ionosphere_job</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">generation</span><span class="p">,</span> <span class="n">fp_learn</span><span class="p">,</span> <span class="n">slack_ionosphere_job</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">create_feature_profile</span><span class="p">:</span>
                        <span class="n">generation_zero</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># @modified 20161209 -  - Branch #922: ionosphere</span>
                    <span class="c1">#                        Task #1658: Patterning Skyline Ionosphere</span>
                    <span class="c1"># Use raise and traceback.format_exc() to carry</span>
                    <span class="c1"># ionosphere_backend.py through to the rendered page for the user, e.g</span>
                    <span class="c1"># me.</span>
                    <span class="c1"># trace = traceback_format_exc</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to create features profile&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_in_successful</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile failed&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="s1">&#39;no traceback available&#39;</span><span class="p">)</span>

        <span class="n">fp_details</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp_details_object</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20170305  - Feature #1960: ionosphere_layers</span>
        <span class="n">l_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">l_details</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">l_details_object</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">la_details</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
        <span class="n">validated_fp_success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
        <span class="n">family_tree_fp_ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">disabled_fp_success</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">fp_view</span><span class="p">:</span>
            <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
            <span class="n">validate</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;validate_fp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">validate_arg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validate_fp&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">validate_arg</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">validate</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validate - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">validate</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validating - fp_ip </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20181013 - Feature #2430: Ionosphere validate learnt features profiles page</span>
                    <span class="c1"># Added the extended validate_fp parameter of id_column_name</span>
                    <span class="c1"># validated_fp_success, fail_msg, traceback_format_exc = validate_fp(fp_id)</span>
                    <span class="c1"># @modified 20190919 - Feature #3230: users DB table</span>
                    <span class="c1">#                      Ideas #2476: Label and relate anomalies</span>
                    <span class="c1">#                      Feature #2516: Add label to features profile</span>
                    <span class="c1"># Added user_id</span>
                    <span class="c1"># validated_fp_success, fail_msg, traceback_format_exc = validate_fp(fp_id, &#39;id&#39;)</span>
                    <span class="n">validated_fp_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">validate_fp</span><span class="p">(</span><span class="n">fp_id</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validated fp_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to validate features profile&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
            <span class="n">family_tree_fp_ids</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">features_profile_family_tree</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;disable_fp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;disable_fp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">disable_fp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;disable_fp is set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">disable_fp</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">disable_fp</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;disabling fp ids - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">family_tree_fp_ids</span><span class="p">))</span>
                <span class="n">disabled_fp_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">disable_features_profile_family_tree</span><span class="p">(</span><span class="n">family_tree_fp_ids</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20170114 -  Feature #1854: Ionosphere learn - generations</span>
                <span class="c1"># Return the fp_details_object so that webapp can pass the parent_id and</span>
                <span class="c1"># generation to the templates</span>
                <span class="c1"># fp_details, fp_details_successful, fail_msg, traceback_format_exc = features_profile_details(fp_id)</span>
                <span class="n">fp_details</span><span class="p">,</span> <span class="n">fp_details_successful</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">,</span> <span class="n">fp_details_object</span> <span class="o">=</span> <span class="n">features_profile_details</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># trace = traceback_format_exc</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to get features profile details&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_details_successful</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: features_profile_details failed&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20170305  - Feature #1960: ionosphere_layers</span>
            <span class="n">fp_layers_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fp_layers_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;layers_id&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">fp_layers_id</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @added 20190922 - Feature #2516: Add label to features profile</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fp_label</span> <span class="o">=</span> <span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">fp_label</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
            <span class="c1"># layer_details = None</span>

            <span class="n">layer_details_success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">fp_layers_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">l_details</span><span class="p">,</span> <span class="n">layer_details_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">,</span> <span class="n">l_details_object</span> <span class="o">=</span> <span class="n">feature_profile_layers_detail</span><span class="p">(</span><span class="n">fp_layers_id</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to get features profile layers details for id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_layers_id</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">la_details</span><span class="p">,</span> <span class="n">layer_algorithms_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">,</span> <span class="n">la_details_object</span> <span class="o">=</span> <span class="n">feature_profile_layer_alogrithms</span><span class="p">(</span><span class="n">fp_layers_id</span><span class="p">)</span>
                    <span class="n">l_id</span> <span class="o">=</span> <span class="n">fp_layers_id</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to get features profile layer algorithm details for id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_layers_id</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">valid_learning_duration</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20170308  - Feature #1960: ionosphere_layers - glm_images to m_app_context</span>
        <span class="n">glm_images</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">l_id_matched</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">m_app_context</span> <span class="o">=</span> <span class="s1">&#39;Analyzer&#39;</span>
        <span class="c1"># @added 20170309  - Feature #1960: ionosphere_layers - i_ts_json</span>
        <span class="n">i_ts_json</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sample_ts_json</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sample_i_ts_json</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20170331 - Task #1988: Review - Ionosphere layers - always show layers</span>
        <span class="c1">#                   Feature #1960: ionosphere_layers</span>
        <span class="n">anomalous_timeseries</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">f_id_matched</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp_details_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">f_id_created</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp_generation_created</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20170106 - Feature #1842: Ionosphere - Graphite now graphs</span>
            <span class="c1"># Added graphite_now_images gimages</span>
            <span class="c1"># @modified 20170107 - Feature #1852: Ionosphere - features_profile matched graphite graphs</span>
            <span class="c1"># Added graphite_matched_images gmimages</span>
            <span class="c1"># @modified 20170308 - Feature #1960: ionosphere_layers</span>
            <span class="c1"># Show the latest matched layers graphs as well added glm_images - graphite_layers_matched_images</span>
            <span class="c1"># @modified 20170309 - Feature #1960: ionosphere_layers</span>
            <span class="c1"># Also return the Analyzer FULL_DURATION timeseries if available in a Mirage</span>
            <span class="c1"># based features profile added i_ts_json</span>
            <span class="c1"># @added 20170331 - Task #1988: Review - Ionosphere layers - always show layers</span>
            <span class="c1">#                   Feature #1960: ionosphere_layers</span>
            <span class="c1"># Return the anomalous_timeseries as an array to sample and fp_id_matched</span>
            <span class="c1"># @added 20170401 - Task #1988: Review - Ionosphere layers - added fp_id_created</span>
            <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
            <span class="c1"># Added fp_anomaly_timestamp ionosphere_echo features profiles</span>
            <span class="n">mpaths</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">hdate</span><span class="p">,</span> <span class="n">m_vars</span><span class="p">,</span> <span class="n">ts_json</span><span class="p">,</span> <span class="n">data_to_process</span><span class="p">,</span> <span class="n">p_id</span><span class="p">,</span> <span class="n">gimages</span><span class="p">,</span> <span class="n">gmimages</span><span class="p">,</span> <span class="n">times_matched</span><span class="p">,</span> <span class="n">glm_images</span><span class="p">,</span> <span class="n">l_id_matched</span><span class="p">,</span> <span class="n">ts_fd</span><span class="p">,</span> <span class="n">i_ts_json</span><span class="p">,</span> <span class="n">anomalous_timeseries</span><span class="p">,</span> <span class="n">f_id_matched</span><span class="p">,</span> <span class="n">fp_details_list</span><span class="p">,</span> <span class="n">fp_anomaly_timestamp</span> <span class="o">=</span> <span class="n">ionosphere_metric_data</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: p_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_id</span><span class="p">))</span>

            <span class="c1"># @added 20221130 - Feature #4732: flux vortex</span>
            <span class="c1">#                   Feature #4734: mirage_vortex</span>
            <span class="n">vortex_training</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">vortex_metric_data_archive</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">vortex_metric_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">mpaths</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i_file</span><span class="p">,</span> <span class="n">metric_file</span> <span class="ow">in</span> <span class="n">mpaths</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;vortex.metric_data.&#39;</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;.json.gz&#39;</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
                            <span class="n">vortex_training</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">vortex_metric_data_archive</span> <span class="o">=</span> <span class="n">metric_file</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">vortex_training</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;vortex training data identified via </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">vortex_metric_data_archive</span><span class="p">))</span>
            <span class="n">vortex_fp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">m_vars</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">m_vars</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;added_by&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;mirage_vortex&#39;</span><span class="p">:</span>
                                <span class="n">vortex_fp</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;error: could not read metrics vars file&#39;</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to iterate m_vars: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">m_vars</span><span class="p">)))</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to iterate m_vars: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m_vars</span><span class="p">))</span>
                            <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to iterate m_vars: </span><span class="si">%s</span><span class="s1">, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">m_vars</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to iterate m_vars: </span><span class="si">%s</span><span class="s1">, err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m_vars</span><span class="p">),</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vortex_metric_data_archive</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vortex_metric_data</span> <span class="o">=</span> <span class="n">get_vortex_metric_data_from_archive</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">vortex_metric_data_archive</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">vortex_metric_data</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;loaded vortex_metric_data&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;get_vortex_metric_data_from_archive failed on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">vortex_metric_data_archive</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
            <span class="c1"># Remove anomalies and scores data</span>
            <span class="k">if</span> <span class="n">vortex_metric_data</span><span class="p">:</span>
                <span class="n">vortex_results_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vortex_results_algorithms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to determine vortex_results_algorithms from vortex_metric_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">vortex_algo</span> <span class="ow">in</span> <span class="n">vortex_results_algorithms</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">vortex_algo</span><span class="p">][</span><span class="s1">&#39;anomalies&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">vortex_metric_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;algorithms&#39;</span><span class="p">][</span><span class="n">vortex_algo</span><span class="p">][</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="c1"># @added 20230601 - Feature #4734: mirage_vortex</span>
            <span class="c1">#                   Branch #4728: vortex</span>
            <span class="c1"># Add results to training_data_dir to be loaded in the Ionosphere</span>
            <span class="c1"># training page</span>
            <span class="n">vortex_results_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">mpaths</span><span class="p">:</span>
                <span class="n">vortex_results_dict_file</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i_file</span><span class="p">,</span> <span class="n">metric_file</span> <span class="ow">in</span> <span class="n">mpaths</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;vortex.results.dict&#39;</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
                        <span class="n">vortex_results_dict_file</span> <span class="o">=</span> <span class="n">metric_file</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">vortex_results_dict_file</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;vortex results dict found </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">vortex_results_dict_file</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vortex_results_dict_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">vortex_results_dict_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">vortex_results_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">vortex_results_dict_str</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;vortex_results_dict evaluated to dict of len </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vortex_results_dict</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to load and eval vortex_results_dict_file: </span><span class="si">%s</span><span class="s1">,  err: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">vortex_results_dict_file</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20200711 - Feature #3634: webapp - ionosphere - report number of data points</span>
            <span class="n">ts_json_length</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">anomalous_timeseries_length</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @added 20170309  - Feature #1960: ionosphere_layers - i_ts_json</span>
            <span class="c1"># Show the last 30</span>
            <span class="k">if</span> <span class="n">ts_json</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sample_ts_json</span> <span class="o">=</span> <span class="n">ts_json</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">:]</span>
                    <span class="c1"># @added 20200711 - Feature #3634: webapp - ionosphere - report number of data points</span>
                    <span class="n">ts_json_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts_json</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to sample ts_json&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @modified 20170331 - Task #1988: Review - Ionosphere layers - always show layers</span>
            <span class="c1">#                      Feature #1960: ionosphere_layers</span>
            <span class="c1"># Return the anomalous_timeseries as an array to sample</span>
            <span class="c1"># if i_ts_json:</span>
            <span class="c1">#     sample_i_ts_json = i_ts_json[-30:]</span>
            <span class="k">if</span> <span class="n">anomalous_timeseries</span><span class="p">:</span>
                <span class="n">sample_i_ts_json</span> <span class="o">=</span> <span class="n">anomalous_timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">:]</span>
                <span class="c1"># @added 20200711 - Feature #3634: webapp - ionosphere - report number of data points</span>
                <span class="n">anomalous_timeseries_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anomalous_timeseries</span><span class="p">)</span>
                <span class="n">anomalous_timeseries_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">anomalous_timeseries</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">fp_details_list</span><span class="p">:</span>
                <span class="n">f_id_created</span> <span class="o">=</span> <span class="n">fp_details_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># @modified 20170729 - Feature #1854: Ionosphere learn - generations</span>
                <span class="c1"># Make backwards compatible with older features profiles</span>
                <span class="c1"># fp_generation_created = fp_details_list[8]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fp_generation_created</span> <span class="o">=</span> <span class="n">fp_details_list</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">fp_generation_created</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @added 20170120 -  Feature #1854: Ionosphere learn - generations</span>
            <span class="c1"># Added fp_learn parameter to allow the user to not learn the</span>
            <span class="c1"># use_full_duration_days so added fp_fd_days</span>
            <span class="n">use_full_duration</span><span class="p">,</span> <span class="n">valid_learning_duration</span><span class="p">,</span> <span class="n">fp_fd_days</span><span class="p">,</span> <span class="n">max_generations</span><span class="p">,</span> <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="n">get_ionosphere_learn_details</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>

            <span class="c1"># @added 20170104 - Feature #1842: Ionosphere - Graphite now graphs</span>
            <span class="c1"># Added the full_duration parameter so that the appropriate graphs can be</span>
            <span class="c1"># embedded for the user in the training data page</span>
            <span class="n">full_duration</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span>
            <span class="n">full_duration_in_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">full_duration</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="n">second_order_resolution_hours</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;full_duration&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">m_vars</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">m_full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">m_full_duration_in_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_full_duration</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m_full_duration</span> <span class="o">!=</span> <span class="n">full_duration</span><span class="p">:</span>
                    <span class="n">second_order_resolution_hours</span> <span class="o">=</span> <span class="n">m_full_duration_in_hours</span>
                    <span class="c1"># @added 20170305  - Feature #1960: ionosphere_layers - m_app_context</span>
                    <span class="n">m_app_context</span> <span class="o">=</span> <span class="s1">&#39;Mirage&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">m_full_duration</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">m_full_duration_in_hours</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :( :: m_vars - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">m_vars</span><span class="p">)</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20220822 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="c1"># Only enable training if there is sufficient data</span>
            <span class="k">if</span> <span class="n">second_order_resolution_hours</span> <span class="ow">and</span> <span class="n">ts_json</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">first_timestamp_in_anomalous_timeseries</span> <span class="o">=</span> <span class="n">ts_json</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">second_order_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">second_order_resolution_hours</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="mi">7200</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">86400</span><span class="p">:</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="mi">14400</span>
                    <span class="n">timestamp_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">second_order_resolution_seconds</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">first_timestamp_in_anomalous_timeseries</span> <span class="o">&gt;</span> <span class="n">timestamp_limit</span><span class="p">:</span>
                        <span class="n">valid_length_for_training</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;insufficient data for training last_timestamp: </span><span class="si">%s</span><span class="s1">, ts_full_duration: </span><span class="si">%s</span><span class="s1">, first_timestamp: </span><span class="si">%s</span><span class="s1">, timestamp_limit: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution_seconds</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">first_timestamp_in_anomalous_timeseries</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_limit</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not determine valid_length_for_training - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># @added 20190330 - Feature #2484: FULL_DURATION feature profiles</span>
            <span class="c1"># For Ionosphere echo and adding red borders on the matched graphs</span>
            <span class="k">if</span> <span class="n">m_full_duration_in_hours</span><span class="p">:</span>
                <span class="n">m_fd_in_hours_img_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">h.png&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">m_full_duration_in_hours</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m_fd_in_hours_img_str</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20170105 - Feature #1842: Ionosphere - Graphite now graphs</span>
            <span class="c1"># We want to sort the images so that the Graphite image is always</span>
            <span class="c1"># displayed first in he training_data.html page AND we want Graphite</span>
            <span class="c1"># now graphs at TARGET_HOURS, 24h, 7d, 30d to inform the operator</span>
            <span class="c1"># about the metric</span>
            <span class="n">sorted_images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

            <span class="c1"># @modified 20170105 - Feature #1842: Ionosphere - Graphite now graphs</span>
            <span class="c1"># Added matched_count and only displaying one graph for each 10</span>
            <span class="c1"># minute period if there are mulitple matches in a 10 minute period</span>
            <span class="c1"># @modified 20170114 -  Feature #1854: Ionosphere learn - generations</span>
            <span class="c1"># Added parent_id and generation</span>
            <span class="n">par_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
            <span class="n">fp_validated</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
            <span class="n">fp_enabled</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
            <span class="c1"># Added ionosphere_echo</span>
            <span class="n">echo_fp_value</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @added 20190619 - Feature #2990: Add metrics id to relevant web pages</span>
            <span class="c1"># metric_id = False</span>

            <span class="c1"># Determine the parent_id and generation as they were added to the</span>
            <span class="c1"># fp_details_object</span>
            <span class="c1"># if fp_details:</span>
            <span class="k">if</span> <span class="n">fp_details_object</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">par_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">])</span>
                    <span class="n">gen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;generation&#39;</span><span class="p">])</span>
                    <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
                    <span class="n">fp_validated</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;validated&#39;</span><span class="p">])</span>
                    <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">fp_enabled</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
                    <span class="c1"># Added ionosphere_echo</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">echo_fp_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;echo_fp&#39;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp failed to determine the echo_hdate from the fp_anomaly_timestamp&#39;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>

                    <span class="c1"># @added 20190619 - Feature #2990: Add metrics id to relevant web pages</span>
                    <span class="c1"># Determine the metric_id from the fp_details_object</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">])</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :( :: failed to determine parent or generation values from the fp_details_object&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

                <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
                <span class="c1"># Added ionosphere_echo</span>
                <span class="n">echo_hdate</span> <span class="o">=</span> <span class="n">hdate</span>
                <span class="k">if</span> <span class="n">echo_fp_value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># echo_hdate = datetime.datetime.utcfromtimestamp(fp_anomaly_timestamp).strftime(&#39;%Y-%m-%d %H:%M:%S&#39;)</span>
                        <span class="n">echo_hdate</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S %Z (%A)&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fp_anomaly_timestamp</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp failed to determine the echo_hdate from the fp_anomaly_timestamp&#39;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20170114 -  Feature #1854: Ionosphere learn - generations</span>
            <span class="c1"># The fp_id will be in the fp_details_object, but if this is a</span>
            <span class="c1"># generation zero features profile we what set</span>
            <span class="k">if</span> <span class="n">generation_zero</span><span class="p">:</span>
                <span class="n">par_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">gen</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @added 20170122 - Feature #1876: Ionosphere - training_data learn countdown</span>
            <span class="c1"># Add a countdown until Ionosphere will learn</span>
            <span class="n">countdown_to</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">requested_timestamp</span> <span class="ow">and</span> <span class="n">valid_learning_duration</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">request_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">vaild_learning_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_learning_duration</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">request_time</span> <span class="o">&lt;</span> <span class="n">vaild_learning_timestamp</span><span class="p">:</span>
                        <span class="n">countdown_to</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                            <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">vaild_learning_timestamp</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :( :: failed to determine parent or generation values from the fp_details_object&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20220727 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="k">if</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_base_name</span><span class="p">)</span>

            <span class="n">iono_metric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ionosphere_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.unique_metrics&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: Webapp could not get the ionosphere.unique_metrics list from Redis, this could be because there are none&#39;</span><span class="p">)</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>

                <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
                <span class="c1"># @modified 20220115 - Bug #4374: webapp - handle url encoded chars</span>
                <span class="c1"># Roll back change - breaking existing metrics with colons</span>
                <span class="c1"># metric_name = url_encode_metric_name(metric_name)</span>

                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">ionosphere_metrics</span><span class="p">:</span>
                    <span class="n">iono_metric</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># @added 20170303 - Feature #1960: ionosphere_layers</span>
            <span class="n">vconds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">]</span>

            <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
            <span class="c1"># condition_list = [&#39;&lt;&#39;, &#39;&gt;&#39;, &#39;==&#39;, &#39;!=&#39;, &#39;&lt;=&#39;, &#39;&gt;=&#39;, &#39;in&#39;, &#39;not in&#39;]</span>

            <span class="n">crit_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;from_time&#39;</span><span class="p">,</span> <span class="s1">&#39;until_time&#39;</span><span class="p">]</span>

            <span class="n">fp_layers</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;fp_layer&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">fp_layer_arg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_layer&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_layer_arg</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">fp_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">add_fp_layers</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;add_fp_layer&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">add_fp_layer_arg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;add_fp_layer&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">add_fp_layer_arg</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">add_fp_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">new_l_algos</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_l_algos_ids</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">add_fp_layers</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;learn&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;learn&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                        <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;fp_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">fp_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_id&#39;</span><span class="p">))</span>
                <span class="n">l_id</span><span class="p">,</span> <span class="n">layer_successful</span><span class="p">,</span> <span class="n">new_l_algos</span><span class="p">,</span> <span class="n">new_l_algos_ids</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">create_ionosphere_layers</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">layer_successful</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">webapp_update_slack_thread</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">,</span> <span class="s1">&#39;layers_created&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20170308 - Feature #1960: ionosphere_layers</span>
            <span class="c1"># To present the operator with the existing layers and algorithms for the metric</span>
            <span class="c1"># The metric layers algoritms are required to present the user with</span>
            <span class="c1"># if the add_fp=true argument is passed, which if so results in the</span>
            <span class="c1"># local variable of create_feature_profile being set and in the</span>
            <span class="c1"># fp_view</span>
            <span class="n">metric_layers_details</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">metric_layers_algorithm_details</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># @modified 20170331 - Task #1988: Review - Ionosphere layers - always show layers</span>
            <span class="c1"># Set to True so they are always displayed</span>
            <span class="c1"># get_metric_existing_layers = False</span>
            <span class="n">get_metric_existing_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">metric_lc</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">metric_lmc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">create_feature_profile</span><span class="p">:</span>
                <span class="n">get_metric_existing_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">fp_view</span> <span class="ow">and</span> <span class="n">fp_details</span><span class="p">:</span>
                <span class="n">get_metric_existing_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;add_fp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">get_layers_add_fp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;add_fp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">get_layers_add_fp</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">get_metric_existing_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">get_metric_existing_layers</span><span class="p">:</span>
                <span class="n">metric_layers_details</span><span class="p">,</span> <span class="n">metric_layers_algorithm_details</span><span class="p">,</span> <span class="n">metric_lc</span><span class="p">,</span> <span class="n">metric_lmc</span><span class="p">,</span> <span class="n">mlad_successful</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">metric_layers_alogrithms</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mlad_successful</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20170616 - Feature #2048: D1 ionosphere layer</span>
            <span class="n">fp_layer_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">metric_layers_algorithm_details</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i_layer_algorithm</span> <span class="ow">in</span> <span class="n">metric_layers_algorithm_details</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_layer_algorithm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">l_id</span><span class="p">):</span>
                            <span class="n">fp_layer_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_layer_algorithm</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: Webapp could not determine layer_algorithm in metric_layers_algorithm_details&#39;</span><span class="p">)</span>
            <span class="n">fp_current_layer</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">metric_layers_details</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i_layer</span> <span class="ow">in</span> <span class="n">metric_layers_details</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">l_id</span><span class="p">):</span>
                            <span class="n">fp_current_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_layer</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: Webapp could not determine layer in metric_layers_details&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
            <span class="n">training_data_saved</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">saved_td_details</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">save_training_data</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving training data&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">request_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">saved_hdate</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S %Z (%A)&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">request_time</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                        <span class="n">training_data_saved</span><span class="p">,</span> <span class="n">saved_td_details</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">save_training_data_dir</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="n">saved_td_label</span><span class="p">,</span> <span class="n">saved_hdate</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">training_data_saved</span><span class="p">,</span> <span class="n">saved_td_details</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">save_training_data_dir</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">saved_td_label</span><span class="p">,</span> <span class="n">saved_hdate</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saved training data&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not save_training_data_dir&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">saved_td_requested</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">saved_training_data</span><span class="p">:</span>
                <span class="n">saved_td_requested</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                        <span class="n">training_data_saved</span><span class="p">,</span> <span class="n">saved_td_details</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">save_training_data_dir</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">training_data_saved</span><span class="p">,</span> <span class="n">saved_td_details</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">save_training_data_dir</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got saved training data details&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get saved training_data details&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
            <span class="n">matched_id_resources</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">matched_graph_image_file</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20210415 - Feature #4014: Ionosphere - inference</span>
            <span class="c1">#                   Branch #3590: inference</span>
            <span class="c1"># Noow that the matched_details_object is being used set the default</span>
            <span class="n">matched_details_object</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">matched_fp_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">matched_fp_id</span> <span class="o">!=</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                    <span class="n">matched_id_resources</span><span class="p">,</span> <span class="n">successful</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">matched_details_object</span><span class="p">,</span> <span class="n">matched_graph_image_file</span> <span class="o">=</span> <span class="n">get_matched_id_resources</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">matched_fp_id</span><span class="p">),</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">)</span>
                    <span class="c1"># @added 20220317 - Feature #4540: Plot matched timeseries</span>
                    <span class="c1">#                   Feature #4014: Ionosphere - inference</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_motif_id</span><span class="p">:</span>
                        <span class="n">matched_fp_plot_file</span> <span class="o">=</span> <span class="n">matched_graph_image_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;matched&#39;</span><span class="p">,</span> <span class="s1">&#39;match_compare&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">matched_fp_plot_file</span><span class="p">):</span>
                            <span class="n">output_file</span> <span class="o">=</span> <span class="n">matched_fp_plot_file</span>
                            <span class="n">layers_match_id</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">matched_timeseries</span> <span class="o">=</span> <span class="n">get_matched_timeseries</span><span class="p">(</span>
                                <span class="n">skyline_app</span><span class="p">,</span> <span class="n">matched_fp_id</span><span class="p">,</span> <span class="n">layers_match_id</span><span class="p">)</span>

                            <span class="c1"># @added 20220831 - Task #2732: Prometheus to Skyline</span>
                            <span class="c1">#                   Branch #4300: prometheus</span>
                            <span class="n">use_base_name</span> <span class="o">=</span> <span class="n">matched_timeseries</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
                            <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">use_base_name</span> <span class="ow">and</span> <span class="s1">&#39;}&#39;</span> <span class="ow">in</span> <span class="n">use_base_name</span> <span class="ow">and</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">use_base_name</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_metric_id_from_base_name failed with base_name: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                                    <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">labelled_metric_name</span><span class="p">:</span>
                                <span class="n">use_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">)</span>

                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;calling plot_fp_match with matched_timeseries dict&#39;</span><span class="p">)</span>
                            <span class="n">plotted_comparsion_image</span><span class="p">,</span> <span class="n">plotted_match_comparison_image_file</span> <span class="o">=</span> <span class="n">plot_fp_match</span><span class="p">(</span>
                                <span class="c1"># skyline_app, matched_timeseries[&#39;metric&#39;],</span>
                                <span class="n">skyline_app</span><span class="p">,</span> <span class="n">use_base_name</span><span class="p">,</span>
                                <span class="n">matched_timeseries</span><span class="p">[</span><span class="s1">&#39;match&#39;</span><span class="p">][</span><span class="s1">&#39;fp_id&#39;</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">matched_timeseries</span><span class="p">[</span><span class="s1">&#39;matched_fp_timeseries&#39;</span><span class="p">]],</span>
                                <span class="n">matched_timeseries</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">],</span> <span class="n">output_file</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">plotted_comparsion_image</span><span class="p">:</span>
                                <span class="n">matched_fp_plot</span> <span class="o">=</span> <span class="n">plotted_match_comparison_image_file</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">matched_fp_plot</span> <span class="o">=</span> <span class="n">matched_fp_plot_file</span>

            <span class="k">if</span> <span class="n">matched_layer_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">matched_layer_id</span> <span class="o">!=</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                    <span class="n">matched_id_resources</span><span class="p">,</span> <span class="n">successful</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">matched_details_object</span><span class="p">,</span> <span class="n">matched_graph_image_file</span> <span class="o">=</span> <span class="n">get_matched_id_resources</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">matched_layer_id</span><span class="p">),</span> <span class="s1">&#39;layers&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">)</span>

            <span class="c1"># @added 20210413 - Feature #4014: Ionosphere - inference</span>
            <span class="c1">#                   Branch #3590: inference</span>
            <span class="k">if</span> <span class="n">matched_motif_id</span><span class="p">:</span>
                <span class="n">matched_id_resources</span><span class="p">,</span> <span class="n">successful</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">matched_details_object</span><span class="p">,</span> <span class="n">matched_graph_image_file</span> <span class="o">=</span> <span class="n">get_matched_id_resources</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">matched_motif_id</span><span class="p">),</span> <span class="s1">&#39;motif&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">)</span>

            <span class="c1"># @added 20180620 - Feature #2404: Ionosphere - fluid approximation</span>
            <span class="c1"># Added minmax scaling</span>
            <span class="n">minmax</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">matched_fp_id</span><span class="p">:</span>
                <span class="n">minmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">matched_details_object</span><span class="p">[</span><span class="s1">&#39;minmax&#39;</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the fp match has minmax set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">minmax</span><span class="p">))</span>

            <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
            <span class="c1"># Update the DB that the match has been validated or invalidated</span>
            <span class="n">validated_match_successful</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">match_validated_db_value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># @modified 20210413 - Feature #4014: Ionosphere - inference</span>
            <span class="c1"># Added matched_motif_id</span>
            <span class="k">if</span> <span class="n">matched_fp_id</span> <span class="ow">or</span> <span class="n">matched_layer_id</span> <span class="ow">or</span> <span class="n">matched_motif_id</span><span class="p">:</span>
                <span class="n">match_validated_db_value</span> <span class="o">=</span> <span class="n">matched_details_object</span><span class="p">[</span><span class="s1">&#39;validated&#39;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the match_validated_db_value is set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_validated_db_value</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the match_validated is set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_validated</span><span class="p">))</span>
                <span class="c1"># Only update if the value in the DB is different from the value</span>
                <span class="c1"># in the argument, due to there being a difficulty in the</span>
                <span class="c1"># removal of the match_validation argument due to the</span>
                <span class="c1"># redirect_url function being applied earlier ^^ in the process.</span>
                <span class="c1"># Unfortunately without the redirect_url function being applied</span>
                <span class="c1"># this match_validation and match_validated would not work as</span>
                <span class="c1"># the matched context the redirect_url function is used.  Hence</span>
                <span class="c1"># more F.</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">match_validated_db_value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match_validated</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;match_validation&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">match_validated</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validating match&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">matched_fp_id</span><span class="p">:</span>
                                <span class="n">match_id</span> <span class="o">=</span> <span class="n">matched_fp_id</span>
                                <span class="n">validate_context</span> <span class="o">=</span> <span class="s1">&#39;ionosphere_matched&#39;</span>
                            <span class="k">if</span> <span class="n">matched_layer_id</span><span class="p">:</span>
                                <span class="n">match_id</span> <span class="o">=</span> <span class="n">matched_layer_id</span>
                                <span class="n">validate_context</span> <span class="o">=</span> <span class="s1">&#39;ionosphere_layers_matched&#39;</span>
                            <span class="c1"># @added 20210414 - Feature #4014: Ionosphere - inference</span>
                            <span class="c1">#                   Branch #3590: inference</span>
                            <span class="k">if</span> <span class="n">matched_motif_id</span><span class="p">:</span>
                                <span class="n">match_id</span> <span class="o">=</span> <span class="n">matched_motif_id</span>
                                <span class="n">validate_context</span> <span class="o">=</span> <span class="s1">&#39;matched_motifs&#39;</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># @modified 20190920 -</span>
                                <span class="c1"># Added user_id</span>
                                <span class="c1"># validated_match_successful = validate_ionosphere_match(match_id, validate_context, match_validated)</span>
                                <span class="n">validated_match_successful</span> <span class="o">=</span> <span class="n">validate_ionosphere_match</span><span class="p">(</span><span class="n">match_id</span><span class="p">,</span> <span class="n">validate_context</span><span class="p">,</span> <span class="n">match_validated</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
                                <span class="c1"># @added 20190921 - Feature #3234: Ionosphere - related matches vaildation</span>
                                <span class="c1"># TODO - here related matches will also be validated</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validated match&#39;</span><span class="p">)</span>
                                <span class="n">match_validated_db_value</span> <span class="o">=</span> <span class="n">match_validated</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with search_ionosphere&#39;</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20180921 - Feature #2558: Ionosphere - fluid approximation - approximately_close on layers</span>
            <span class="n">approx_close</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">matched_layer_id</span><span class="p">:</span>
                <span class="n">approx_close</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">matched_details_object</span><span class="p">[</span><span class="s1">&#39;approx_close&#39;</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the layers match has approx_close set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">approx_close</span><span class="p">))</span>

            <span class="c1"># @added 20180414 - Branch #2270: luminosity</span>
            <span class="c1"># Add correlations to features_profile and training_data pages if a</span>
            <span class="c1"># panorama_anomaly_id is present</span>
            <span class="n">correlations</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">correlations_with_graph_links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: before get_correlations p_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">p_id</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: get_correlations with p_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_id</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">correlations</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_correlations</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">p_id</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_correlations&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">correlations</span><span class="p">:</span>
                    <span class="c1"># @added 20180723 - Feature #2470: Correlations Graphite graph links</span>
                    <span class="c1">#                   Branch #2270: luminosity</span>
                    <span class="c1"># Added Graphite graph links to Correlations block</span>
                    <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">coefficient</span><span class="p">,</span> <span class="n">shifted</span><span class="p">,</span> <span class="n">shifted_coefficient</span> <span class="ow">in</span> <span class="n">correlations</span><span class="p">:</span>
                        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_full_duration</span>
                        <span class="n">graphite_from</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">graphite_until</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">unencoded_graph_title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">correlated with anomaly id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_id</span><span class="p">))</span>
                        <span class="n">graph_title_string</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">unencoded_graph_title</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">graph_title</span> <span class="o">=</span> <span class="s1">&#39;&amp;title=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">graph_title_string</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="c1"># @modified 20190520 - Branch #3002: docker</span>
                            <span class="c1"># correlation_graphite_link = &#39;%s://%s:%s/render/?from=%s&amp;until=%s&amp;target=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (settings.GRAPHITE_PROTOCOL, settings.GRAPHITE_HOST, settings.GRAPHITE_PORT, str(graphite_from), str(graphite_until), metric_name, settings.GRAPHITE_GRAPH_SETTINGS, graph_title)</span>
                            <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
                            <span class="c1"># correlation_graphite_link = &#39;%s://%s:%s/%s/?from=%s&amp;until=%s&amp;target=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (</span>
                            <span class="n">correlation_graphite_link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/?from=</span><span class="si">%s</span><span class="s1">&amp;until=</span><span class="si">%s</span><span class="s1">&amp;target=cactiStyle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span><span class="p">,</span> <span class="n">GRAPHITE_RENDER_URI</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">graphite_from</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_until</span><span class="p">),</span> <span class="n">metric_name</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">,</span> <span class="n">graph_title</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># @modified 20190520 - Branch #3002: docker</span>
                            <span class="c1"># correlation_graphite_link = &#39;%s://%s/render/?from=%s&amp;until=%starget=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (settings.GRAPHITE_PROTOCOL, settings.GRAPHITE_HOST, str(graphite_from), str(graphite_until), metric_name, settings.GRAPHITE_GRAPH_SETTINGS, graph_title)</span>
                            <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
                            <span class="c1"># correlation_graphite_link = &#39;%s://%s/%s/?from=%s&amp;until=%starget=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (</span>
                            <span class="n">correlation_graphite_link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/?from=</span><span class="si">%s</span><span class="s1">&amp;until=</span><span class="si">%s</span><span class="s1">target=cactiStyle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">,</span>
                                <span class="n">GRAPHITE_RENDER_URI</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_from</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">graphite_until</span><span class="p">),</span> <span class="n">metric_name</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">,</span> <span class="n">graph_title</span><span class="p">)</span>
                        <span class="n">correlations_with_graph_links</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">coefficient</span><span class="p">,</span> <span class="n">shifted</span><span class="p">,</span> <span class="n">shifted_coefficient</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">correlation_graphite_link</span><span class="p">)])</span>

            <span class="c1"># @added 20200808 - Feature #3568: Ionosphere - report anomalies in training period</span>
            <span class="n">labelled_anomalies</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20220909 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                      Branch #4300: prometheus</span>
            <span class="c1"># Apply correlate_or_relate_with to labelled_metrics</span>
            <span class="n">base_name_to_correlate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                <span class="n">base_name_to_correlate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_base_name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">external_settings</span> <span class="o">=</span> <span class="n">get_external_settings</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_external_settings failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20200113 - Feature #3390: luminosity related anomalies</span>
            <span class="c1">#                   Branch #2270: luminosity</span>
            <span class="n">related</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">related_with_graph_links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">related_matches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">p_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200808 - Feature #3568: Ionosphere - report anomalies in training period</span>
                    <span class="c1"># related, fail_msg, trace = get_related(skyline_app, p_id, requested_timestamp)</span>
                    <span class="n">related</span><span class="p">,</span> <span class="n">labelled_anomalies</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_related</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">p_id</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_related&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">related</span><span class="p">:</span>

                    <span class="c1"># Added Graphite graph links to Related block</span>
                    <span class="k">for</span> <span class="n">related_anomaly_id</span><span class="p">,</span> <span class="n">related_metric_id</span><span class="p">,</span> <span class="n">related_metric_name</span><span class="p">,</span> <span class="n">related_anomaly_timestamp</span><span class="p">,</span> <span class="n">related_full_duration</span> <span class="ow">in</span> <span class="n">related</span><span class="p">:</span>

                        <span class="c1"># @added 20220909 - Task #2732: Prometheus to Skyline</span>
                        <span class="c1">#                      Branch #4300: prometheus</span>
                        <span class="c1"># Apply correlate_or_relate_with to labelled_metrics</span>
                        <span class="n">related_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">related_metric_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">related_metric_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                            <span class="n">related_base_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">related_metric_name</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">correlate_or_relate</span> <span class="o">=</span> <span class="n">correlate_or_relate_with</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name_to_correlate</span><span class="p">,</span> <span class="n">related_base_name</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">correlate_or_relate</span><span class="p">:</span>
                                <span class="k">continue</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="n">related_from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">related_anomaly_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="n">related_full_duration</span>
                        <span class="n">related_graphite_from</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">related_from_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">related_graphite_until</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">related_anomaly_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">related_unencoded_graph_title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">related with anomaly id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">related_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_id</span><span class="p">))</span>
                        <span class="n">related_graph_title_string</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">related_unencoded_graph_title</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">related_graph_title</span> <span class="o">=</span> <span class="s1">&#39;&amp;title=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">related_graph_title_string</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
                            <span class="c1"># related_graphite_link = &#39;%s://%s:%s/%s/?from=%s&amp;until=%s&amp;target=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (</span>
                            <span class="n">related_graphite_link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/?from=</span><span class="si">%s</span><span class="s1">&amp;until=</span><span class="si">%s</span><span class="s1">&amp;target=cactiStyle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span><span class="p">,</span> <span class="n">GRAPHITE_RENDER_URI</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">related_graphite_from</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">related_graphite_until</span><span class="p">),</span> <span class="n">related_metric_name</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">,</span> <span class="n">related_graph_title</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
                            <span class="c1"># related_graphite_link = &#39;%s://%s/%s/?from=%s&amp;until=%starget=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (</span>
                            <span class="n">related_graphite_link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/?from=</span><span class="si">%s</span><span class="s1">&amp;until=</span><span class="si">%s</span><span class="s1">target=cactiStyle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">,</span>
                                <span class="n">GRAPHITE_RENDER_URI</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">related_graphite_from</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">related_graphite_until</span><span class="p">),</span> <span class="n">related_metric_name</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">,</span> <span class="n">related_graph_title</span><span class="p">)</span>
                        <span class="n">related_human_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">related_anomaly_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">related_metric_name</span> <span class="ow">and</span> <span class="s1">&#39;}&#39;</span> <span class="ow">in</span> <span class="n">related_metric_name</span> <span class="ow">and</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">related_metric_name</span><span class="p">:</span>
                            <span class="n">related_graphite_link</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">related_with_graph_links</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">related_anomaly_id</span><span class="p">,</span> <span class="n">related_metric_name</span><span class="p">,</span> <span class="n">related_anomaly_timestamp</span><span class="p">,</span> <span class="n">related_full_duration</span><span class="p">,</span> <span class="n">related_human_timestamp</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">related_graphite_link</span><span class="p">)])</span>
                <span class="n">related_metric</span> <span class="o">=</span> <span class="s1">&#39;get_related_matches&#39;</span>
                <span class="n">related_metric_like</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
                <span class="n">related_fp_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">related_layer_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">minus_two_minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">120</span>
                <span class="n">plus_two_minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">120</span>
                <span class="n">related_limited_by</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">related_ordered_by</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">related_matches</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_fp_matches</span><span class="p">(</span><span class="n">related_metric</span><span class="p">,</span> <span class="n">related_metric_like</span><span class="p">,</span> <span class="n">related_fp_id</span><span class="p">,</span> <span class="n">related_layer_id</span><span class="p">,</span> <span class="n">minus_two_minutes</span><span class="p">,</span> <span class="n">plus_two_minutes</span><span class="p">,</span> <span class="n">related_limited_by</span><span class="p">,</span> <span class="n">related_ordered_by</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_fp_matches for related_matches&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">related_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># @modified 20200908 - Feature #3740: webapp - anomaly API endpoint</span>
                    <span class="c1"># Added match_anomaly_timestamp</span>
                    <span class="c1"># @modified 20210413 - Feature #4014: Ionosphere - inference</span>
                    <span class="c1">#                      Branch #3590: inference</span>
                    <span class="c1"># Added related_motifs_matched_id</span>
                    <span class="c1"># @modified 20220801 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                      Branch #4300: prometheus</span>
                    <span class="c1"># Handle labelled_metric name added metric id</span>
                    <span class="k">for</span> <span class="n">related_human_date</span><span class="p">,</span> <span class="n">related_match_id</span><span class="p">,</span> <span class="n">related_matched_by</span><span class="p">,</span> <span class="n">related_fp_id</span><span class="p">,</span> <span class="n">related_layer_id</span><span class="p">,</span> <span class="n">related_metric</span><span class="p">,</span> <span class="n">related_uri_to_matched_page</span><span class="p">,</span> <span class="n">related_validated</span><span class="p">,</span> <span class="n">match_anomaly_timestamp</span><span class="p">,</span> <span class="n">related_motifs_matched_id</span><span class="p">,</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="n">related_matches</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">related_matched_by</span> <span class="o">==</span> <span class="s1">&#39;no matches were found&#39;</span><span class="p">:</span>
                            <span class="n">related_matches</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="n">related_matches</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> possible related matches found&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">related_matches</span><span class="p">))))</span>
                    <span class="c1"># @added 20220909 - Task #2732: Prometheus to Skyline</span>
                    <span class="c1">#                   Branch #4300: prometheus</span>
                    <span class="c1"># Apply correlate_or_relate_with to labelled_metrics</span>
                    <span class="n">correlate_or_relate_with_matches</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">related_human_date</span><span class="p">,</span> <span class="n">related_match_id</span><span class="p">,</span> <span class="n">related_matched_by</span><span class="p">,</span> <span class="n">related_fp_id</span><span class="p">,</span> <span class="n">related_layer_id</span><span class="p">,</span> <span class="n">related_metric</span><span class="p">,</span> <span class="n">related_uri_to_matched_page</span><span class="p">,</span> <span class="n">related_validated</span><span class="p">,</span> <span class="n">match_anomaly_timestamp</span><span class="p">,</span> <span class="n">related_motifs_matched_id</span><span class="p">,</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="n">related_matches</span><span class="p">:</span>
                        <span class="n">related_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">related_metric</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">related_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                            <span class="n">related_base_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">related_metric</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">correlate_or_relate</span> <span class="o">=</span> <span class="n">correlate_or_relate_with</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name_to_correlate</span><span class="p">,</span> <span class="n">related_base_name</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">correlate_or_relate</span><span class="p">:</span>
                                <span class="k">continue</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">correlate_or_relate_with_matches</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">related_human_date</span><span class="p">,</span> <span class="n">related_match_id</span><span class="p">,</span> <span class="n">related_matched_by</span><span class="p">,</span> <span class="n">related_fp_id</span><span class="p">,</span> <span class="n">related_layer_id</span><span class="p">,</span> <span class="n">related_metric</span><span class="p">,</span> <span class="n">related_uri_to_matched_page</span><span class="p">,</span> <span class="n">related_validated</span><span class="p">,</span> <span class="n">match_anomaly_timestamp</span><span class="p">,</span> <span class="n">related_motifs_matched_id</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">])</span>
                    <span class="n">related_matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">correlate_or_relate_with_matches</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> possible related matches found (after correlate_or_relate_with)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">related_matches</span><span class="p">))))</span>

                <span class="c1"># @added 20200808 - Feature #3568: Ionosphere - report anomalies in training period</span>
                <span class="k">if</span> <span class="n">labelled_anomalies</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> labelled anomalies found in the period&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labelled_anomalies</span><span class="p">))))</span>

            <span class="c1"># @added 20230111 - Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="c1"># Debug applying correlate_or_relate_with to labelled_metrics</span>
            <span class="c1"># because an issue was identified with LOCAL_EXTERNAL_SETTINGS</span>
            <span class="c1"># being overrridden by _global settings in terms of possible</span>
            <span class="c1"># related events that did not match correlate_or_relate_with</span>
            <span class="c1"># but were being added to the final illuminance_events_dict</span>
            <span class="n">illuminance_items_checked</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">illuminance_items_used</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">illuminance_items_discarded_on_correlate_with</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @added 20220516 - Feature #2580: illuminance</span>
            <span class="k">if</span> <span class="n">p_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;determining illuminance_events_dict with </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">minus_two_minutes</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">plus_two_minutes</span><span class="p">)))</span>
                    <span class="n">illuminance_events_dict</span> <span class="o">=</span> <span class="n">get_illuminance_entries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">minus_two_minutes</span><span class="p">,</span> <span class="n">plus_two_minutes</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_illuminance_entries failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># In the webapp context only one date_str is passed</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">illuminance_events_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">illuminance_events_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">illuminance_events_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">break</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;determined illuminance_events_dict with </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">, having </span><span class="si">%s</span><span class="s1"> items: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">minus_two_minutes</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">plus_two_minutes</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">illuminance_events_dict</span><span class="p">)),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">illuminance_events_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>

                <span class="c1"># Reorder by timestamp not app</span>
                <span class="n">ill_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">illuminance_app</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">illuminance_events_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">timestamp_hash</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">illuminance_events_dict</span><span class="p">[</span><span class="n">illuminance_app</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

                            <span class="c1"># @modified 20230111 - Task #4778: v4.0.0 - update dependencies</span>
                            <span class="c1">#                      Task #2732: Prometheus to Skyline</span>
                            <span class="c1">#                      Branch #4300: prometheus</span>
                            <span class="c1"># Debug applying correlate_or_relate_with to labelled_metrics</span>
                            <span class="c1"># timestamp_hash_date_string = str(strftime(&#39;%Y-%m-%d %H:%M:%S UTC&#39;, gmtime(timestamp_hash)))</span>
                            <span class="n">ill_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp_hash</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
                            <span class="n">ill_dt_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ill_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">))</span>
                            <span class="n">timestamp_hash_date_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">gmtime</span><span class="p">(</span><span class="n">ill_dt_ts</span><span class="p">)))</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">key_set</span> <span class="o">=</span> <span class="n">ill_dict</span><span class="p">[</span><span class="n">timestamp_hash_date_string</span><span class="p">]</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">del</span> <span class="n">key_set</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">ill_dict</span><span class="p">[</span><span class="n">timestamp_hash_date_string</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                            <span class="c1"># @added 20230111 - Task #4778: v4.0.0 - update dependencies</span>
                            <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                            <span class="c1">#                   Branch #4300: prometheus</span>
                            <span class="c1"># Debug applying correlate_or_relate_with to labelled_metrics</span>
                            <span class="k">if</span> <span class="n">timestamp_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">illuminance_events_dict</span><span class="p">[</span><span class="n">illuminance_app</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: no events for </span><span class="si">%s</span><span class="s1"> in timestamp_hash: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">illuminance_app</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_hash</span><span class="p">)))</span>
                                <span class="k">continue</span>

                            <span class="k">for</span> <span class="n">ill_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">illuminance_events_dict</span><span class="p">[</span><span class="n">illuminance_app</span><span class="p">][</span><span class="n">timestamp_hash</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

                                <span class="c1"># @added 20230111 - Task #4778: v4.0.0 - update dependencies</span>
                                <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                                <span class="c1">#                   Branch #4300: prometheus</span>
                                <span class="c1"># Debug applying correlate_or_relate_with to labelled_metrics</span>
                                <span class="n">illuminance_items_checked</span> <span class="o">+=</span> <span class="mi">1</span>

                                <span class="c1"># @added 20220909 - Task #2732: Prometheus to Skyline</span>
                                <span class="c1">#                   Branch #4300: prometheus</span>
                                <span class="c1"># Apply correlate_or_relate_with to labelled_metrics</span>
                                <span class="n">related_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ill_metric</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">ill_metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                                    <span class="n">related_base_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">ill_metric</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">correlate_or_relate</span> <span class="o">=</span> <span class="n">correlate_or_relate_with</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name_to_correlate</span><span class="p">,</span> <span class="n">related_base_name</span><span class="p">,</span> <span class="n">external_settings</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">correlate_or_relate</span><span class="p">:</span>
                                        <span class="c1"># @added 20230111 - Task #4778: v4.0.0 - update dependencies</span>
                                        <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                                        <span class="c1">#                   Branch #4300: prometheus</span>
                                        <span class="c1"># Debug applying correlate_or_relate_with to labelled_metrics</span>
                                        <span class="n">illuminance_items_discarded_on_correlate_with</span> <span class="o">+=</span> <span class="mi">1</span>

                                        <span class="k">continue</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: correlate_or_relate_with failed for </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">base_name_to_correlate</span><span class="p">,</span> <span class="n">related_base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                <span class="n">ill_metric_dict</span> <span class="o">=</span> <span class="n">illuminance_events_dict</span><span class="p">[</span><span class="n">illuminance_app</span><span class="p">][</span><span class="n">timestamp_hash</span><span class="p">][</span><span class="n">ill_metric</span><span class="p">]</span>
                                <span class="n">ill_metric_dict</span><span class="p">[</span><span class="s1">&#39;app&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">illuminance_app</span>
                                <span class="n">ill_dict</span><span class="p">[</span><span class="n">timestamp_hash_date_string</span><span class="p">][</span><span class="n">ill_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">ill_metric_dict</span>
                                <span class="c1"># @added 20230111 - Task #4778: v4.0.0 - update dependencies</span>
                                <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                                <span class="c1">#                   Branch #4300: prometheus</span>
                                <span class="c1"># Debug applying correlate_or_relate_with to labelled_metrics</span>
                                <span class="n">illuminance_items_used</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: iterating illuminance_events_dict for illuminance_app: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">illuminance_app</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">ill_dict</span><span class="p">:</span>
                    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
                    <span class="c1"># illuminance_events_dict = ill_dict.copy()</span>
                    <span class="n">illuminance_events_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ill_dict</span><span class="p">)</span>

                <span class="c1"># @added 20230111 - Task #4778: v4.0.0 - update dependencies</span>
                <span class="c1">#                   Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Debug applying correlate_or_relate_with to labelled_metrics</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: illuminance_events_dict checked - items_checked: </span><span class="si">%s</span><span class="s1">, used: </span><span class="si">%s</span><span class="s1">, discarded (did not correlate_or_relate_with): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">illuminance_items_checked</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">illuminance_items_used</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">illuminance_items_discarded_on_correlate_with</span><span class="p">)))</span>

            <span class="c1"># @added 20230108 - Task #4778: v4.0.0 - update dependencies</span>
            <span class="c1"># Added look up to stop the metric id ever being reported as</span>
            <span class="c1"># None in the UI</span>
            <span class="k">if</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                <span class="n">check_base_name</span> <span class="o">=</span> <span class="n">labelled_metric_base_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check_base_name</span> <span class="o">=</span> <span class="n">base_name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">check_base_name</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_id looked up base_name: </span><span class="si">%s</span><span class="s1"> and got metric_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_metric_id_from_base_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric id is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>

            <span class="c1"># @added 20190510 - Feature #2990: Add metrics id to relevant web pages</span>
            <span class="c1"># By this point in the request the previous function calls will have</span>
            <span class="c1"># populated memcache with the metric details</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.mysql_ids.metrics.metric.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span>
                    <span class="n">metric_id_msg_pack</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># @modified 20191015 - Bug #3266: py3 Redis binary objects not strings</span>
                    <span class="c1">#                      Branch #3262: py3</span>
                    <span class="c1"># metric_id_msg_pack = REDIS_CONN.get(cache_key)</span>
                    <span class="n">metric_id_msg_pack</span> <span class="o">=</span> <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">metric_id_msg_pack</span><span class="p">:</span>
                        <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">metric_id_msg_pack</span><span class="p">)</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">unpacker</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics id is </span><span class="si">%s</span><span class="s1"> from Redis key -</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="n">cache_key</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Webapp could not get metric id from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get metric id from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>

            <span class="c1"># @added 20190502 - Branch #2646: slack</span>
            <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span><span class="p">:</span>
                <span class="n">update_slack</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Do not update if a fp_id is present</span>
                <span class="k">if</span> <span class="n">fp_id</span><span class="p">:</span>
                    <span class="n">update_slack</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Do not update slack when extract features is run</span>
                <span class="k">if</span> <span class="n">calculate_features</span><span class="p">:</span>
                    <span class="n">update_slack</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">update_slack</span><span class="p">:</span>
                    <span class="n">slack_updated</span> <span class="o">=</span> <span class="n">webapp_update_slack_thread</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;training_data_viewed&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;slack_updated for training_data_viewed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">slack_updated</span><span class="p">))</span>

            <span class="n">show_motif_match</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;saved_training_data&#39;</span><span class="p">:</span>
                <span class="n">inference_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.inference.matched_motifs.dict&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">ionosphere_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inference_file</span><span class="p">):</span>
                    <span class="n">show_motif_match</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># @added 20210419 - Feature #4014: Ionosphere - inference</span>
            <span class="c1"># Plot the macthed motif</span>
            <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;saved_training_data&#39;</span> <span class="ow">and</span> <span class="n">matched_motif_id</span><span class="p">:</span>
                <span class="n">show_motif_match</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">show_motif_match</span><span class="p">:</span>
                <span class="n">inference_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.inference.matched_motifs.dict&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">ionosphere_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
                <span class="n">matched_motifs_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inference_file</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inference_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">matched_motifs_dict_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">matched_motifs_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">matched_motifs_dict_str</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to evaluate matched_motifs_dict from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">inference_file</span><span class="p">)</span>
                        <span class="n">matched_motifs_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">matched_motif</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">matched_motifs_dict</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">matched_motif</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matched_motifs_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">inference_match_motif_dict</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">]</span>
                        <span class="n">matched_motif_fp_id</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;fp_id&#39;</span><span class="p">]</span>
                        <span class="n">f_id_matched</span> <span class="o">=</span> <span class="n">matched_motif_fp_id</span>
                        <span class="n">matched_motif_timestamp</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                        <span class="n">matched_motif_fp_index</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>
                        <span class="n">matched_motif_size</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                        <span class="c1"># Add the id to the dictionery, inference does not know</span>
                        <span class="c1"># the id when the dict is created</span>
                        <span class="n">matched_motif_id</span><span class="p">,</span> <span class="n">motif_validated</span><span class="p">,</span> <span class="n">ionosphere_matched_id</span> <span class="o">=</span> <span class="n">get_matched_motif_id</span><span class="p">(</span>
                            <span class="n">matched_motif_fp_id</span><span class="p">,</span> <span class="n">matched_motif_timestamp</span><span class="p">,</span>
                            <span class="n">matched_motif_fp_index</span><span class="p">,</span> <span class="n">matched_motif_size</span><span class="p">)</span>
                        <span class="n">inference_match_motif_dict</span><span class="p">[</span><span class="s1">&#39;matched_motif_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_motif_id</span>
                        <span class="n">inference_match_motif_dict</span><span class="p">[</span><span class="s1">&#39;ionosphere_matched_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ionosphere_matched_id</span>
                        <span class="n">inference_match_motif_dict</span><span class="p">[</span><span class="s1">&#39;validated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">motif_validated</span>
                        <span class="n">match_validated_db_value</span> <span class="o">=</span> <span class="n">motif_validated</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">matched_motif_distance</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">matched_motif_distance</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>
                        <span class="n">matched_motif_type_id</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>
                        <span class="n">matched_motif_type</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                        <span class="n">matched_motif_full_duration</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;full_duration&#39;</span><span class="p">]</span>
                        <span class="n">matched_motif_sequence</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;motif_sequence&#39;</span><span class="p">]</span>
                        <span class="n">matched_motif_fp_generation</span> <span class="o">=</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;generation&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">matched_motif_fp_generation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">generation_str</span> <span class="o">=</span> <span class="s1">&#39;trained&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">generation_str</span> <span class="o">=</span> <span class="s1">&#39;LEARNT&#39;</span>
                        <span class="n">relate_dataset</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">matched_motifs_dict</span><span class="p">[</span><span class="n">matched_motif</span><span class="p">][</span><span class="s1">&#39;fp_motif_sequence&#39;</span><span class="p">]]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine plot parameters from matched_motifs_dict&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">matched_motif</span><span class="p">:</span>
                    <span class="n">motif_graph_image_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.matched_motif.</span><span class="si">%s</span><span class="s1">.fp_id.</span><span class="si">%s</span><span class="s1">.index.</span><span class="si">%s</span><span class="s1">.size.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">ionosphere_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_fp_id</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_fp_index</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_size</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_type</span><span class="p">))</span>
                    <span class="c1"># Plot an invalid motif with a red line</span>
                    <span class="k">if</span> <span class="n">motif_validated</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">motif_graph_image_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.matched_motif.</span><span class="si">%s</span><span class="s1">.fp_id.</span><span class="si">%s</span><span class="s1">.index.</span><span class="si">%s</span><span class="s1">.size.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.INVALIDATED.png&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">ionosphere_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_fp_id</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_fp_index</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_size</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">matched_motif_type</span><span class="p">))</span>
                        <span class="c1"># Use type_id as 5 to indicate invalidated</span>
                        <span class="n">matched_motif_type_id</span> <span class="o">=</span> <span class="mi">5</span>

                    <span class="n">plotted_motif_image</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">motif_graph_image_file</span><span class="p">):</span>
                        <span class="n">use_on_demand_motif_analysis</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;calling plot_motif_match to create inference_match_motif_image&#39;</span><span class="p">)</span>
                        <span class="n">plotted_motif_image</span><span class="p">,</span> <span class="n">inference_match_motif_image</span> <span class="o">=</span> <span class="n">plot_motif_match</span><span class="p">(</span>
                            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">matched_motif_timestamp</span><span class="p">,</span> <span class="n">matched_motif_fp_id</span><span class="p">,</span>
                            <span class="n">matched_motif_full_duration</span><span class="p">,</span>
                            <span class="n">generation_str</span><span class="p">,</span> <span class="n">matched_motif_id</span><span class="p">,</span>
                            <span class="n">matched_motif_fp_index</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">matched_motif_size</span><span class="p">),</span>
                            <span class="n">matched_motif_distance</span><span class="p">,</span> <span class="n">matched_motif_type_id</span><span class="p">,</span>
                            <span class="n">relate_dataset</span><span class="p">,</span> <span class="n">matched_motif_sequence</span><span class="p">,</span>
                            <span class="n">motif_graph_image_file</span><span class="p">,</span> <span class="n">use_on_demand_motif_analysis</span><span class="p">)</span>
                        <span class="n">inference_match_motif_dict</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inference_match_motif_image</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plotted_motif_image</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">inference_match_motif_image</span> <span class="o">=</span> <span class="n">motif_graph_image_file</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plot already exists - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">plotted_motif_image</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">motif_graph_image_file</span><span class="p">)))</span>
                        <span class="n">inference_match_motif_dict</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inference_match_motif_image</span>

            <span class="c1"># @added 20191210 - Feature #3348: fp creation json response</span>
            <span class="k">if</span> <span class="n">create_feature_profile</span> <span class="ow">and</span> <span class="n">fp_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">response_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fp_created_successful</span> <span class="o">=</span> <span class="n">fp_in_successful</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">fp_created_successful</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">fp_created_successful</span><span class="p">:</span>
                        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;fp_id&quot;</span><span class="p">:</span> <span class="n">fp_id</span><span class="p">}}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fp_exists</span><span class="p">:</span>
                            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;already exists&quot;</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;fp_id&quot;</span><span class="p">:</span> <span class="n">fp_id</span><span class="p">}}</span>
                    <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

            <span class="c1"># @added 20200731 - Feature #3654: IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span>
            <span class="n">graphite_now_graphs_title</span> <span class="o">=</span> <span class="s1">&#39;NOW&#39;</span>
            <span class="k">if</span> <span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span><span class="p">:</span>
                <span class="n">graphite_now_graphs_title</span> <span class="o">=</span> <span class="s1">&#39;THEN&#39;</span>

            <span class="c1"># @added 20200813 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
            <span class="n">historical_training_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">mpaths</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">IONOSPHERE_HISTORICAL_DATA_FOLDER</span> <span class="ow">in</span> <span class="n">mpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">historical_training_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not determine if this is historical training data&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20210324 - Feature #3642: Anomaly type classification</span>
            <span class="n">anomaly_types</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">anomaly_type_ids</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">LUMINOSITY_CLASSIFY_ANOMALIES</span> <span class="ow">and</span> <span class="n">p_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">anomaly_types</span><span class="p">,</span> <span class="n">anomaly_type_ids</span> <span class="o">=</span> <span class="n">get_anomaly_type</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_id</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_anomaly_type - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>

            <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

            <span class="k">if</span> <span class="n">insufficient_data_for_training</span><span class="p">:</span>
                <span class="n">valid_length_for_training</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">requested_timestamp</span><span class="p">,</span>
                <span class="n">for_metric</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span> <span class="n">metric_vars</span><span class="o">=</span><span class="n">m_vars</span><span class="p">,</span> <span class="n">metric_files</span><span class="o">=</span><span class="n">mpaths</span><span class="p">,</span>
                <span class="n">metric_images</span><span class="o">=</span><span class="n">sorted_images</span><span class="p">,</span> <span class="n">metric_images_str</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sorted_images</span><span class="p">),</span>
                <span class="n">human_date</span><span class="o">=</span><span class="n">hdate</span><span class="p">,</span> <span class="n">timeseries</span><span class="o">=</span><span class="n">ts_json</span><span class="p">,</span>
                <span class="n">data_ok</span><span class="o">=</span><span class="n">data_to_process</span><span class="p">,</span> <span class="n">td_files</span><span class="o">=</span><span class="n">mpaths</span><span class="p">,</span>
                <span class="n">panorama_anomaly_id</span><span class="o">=</span><span class="n">p_id</span><span class="p">,</span> <span class="n">graphite_url</span><span class="o">=</span><span class="n">graph_url</span><span class="p">,</span>
                <span class="n">extracted_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">calc_time</span><span class="o">=</span><span class="n">f_calc</span><span class="p">,</span>
                <span class="n">features_profile_id</span><span class="o">=</span><span class="n">fp_id</span><span class="p">,</span> <span class="n">features_profile_exists</span><span class="o">=</span><span class="n">fp_exists</span><span class="p">,</span>
                <span class="n">fp_view</span><span class="o">=</span><span class="n">fp_view_on</span><span class="p">,</span> <span class="n">features_profile_details</span><span class="o">=</span><span class="n">fp_details</span><span class="p">,</span>
                <span class="n">redis_full_duration</span><span class="o">=</span><span class="n">full_duration</span><span class="p">,</span>
                <span class="n">redis_full_duration_in_hours</span><span class="o">=</span><span class="n">full_duration_in_hours</span><span class="p">,</span>
                <span class="n">metric_full_duration</span><span class="o">=</span><span class="n">m_full_duration</span><span class="p">,</span>
                <span class="n">metric_full_duration_in_hours</span><span class="o">=</span><span class="n">m_full_duration_in_hours</span><span class="p">,</span>
                <span class="n">metric_second_order_resolution_hours</span><span class="o">=</span><span class="n">second_order_resolution_hours</span><span class="p">,</span>
                <span class="n">tsfresh_version</span><span class="o">=</span><span class="n">TSFRESH_VERSION</span><span class="p">,</span> <span class="n">graphite_now_images</span><span class="o">=</span><span class="n">gimages</span><span class="p">,</span>
                <span class="n">graphite_matched_images</span><span class="o">=</span><span class="n">gmimages</span><span class="p">,</span> <span class="n">matched_count</span><span class="o">=</span><span class="n">times_matched</span><span class="p">,</span>
                <span class="n">parent_id</span><span class="o">=</span><span class="n">par_id</span><span class="p">,</span> <span class="n">generation</span><span class="o">=</span><span class="n">gen</span><span class="p">,</span> <span class="n">learn</span><span class="o">=</span><span class="n">fp_learn</span><span class="p">,</span>
                <span class="n">use_full_duration_days</span><span class="o">=</span><span class="n">fp_fd_days</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="n">countdown_to</span><span class="p">,</span>
                <span class="n">ionosphere_metric</span><span class="o">=</span><span class="n">iono_metric</span><span class="p">,</span> <span class="n">value_condition_list</span><span class="o">=</span><span class="n">vconds</span><span class="p">,</span>
                <span class="n">criteria_types</span><span class="o">=</span><span class="n">crit_types</span><span class="p">,</span> <span class="n">fp_layer</span><span class="o">=</span><span class="n">fp_layers</span><span class="p">,</span>
                <span class="n">layer_id</span><span class="o">=</span><span class="n">l_id</span><span class="p">,</span> <span class="n">layers_algorithms</span><span class="o">=</span><span class="n">new_l_algos</span><span class="p">,</span>
                <span class="n">layers_algorithms_ids</span><span class="o">=</span><span class="n">new_l_algos_ids</span><span class="p">,</span>
                <span class="n">layer_details</span><span class="o">=</span><span class="n">l_details</span><span class="p">,</span>
                <span class="n">layer_details_object</span><span class="o">=</span><span class="n">l_details_object</span><span class="p">,</span>
                <span class="n">layer_algorithms_details</span><span class="o">=</span><span class="n">la_details</span><span class="p">,</span>
                <span class="n">existing_layers</span><span class="o">=</span><span class="n">metric_layers_details</span><span class="p">,</span>
                <span class="n">existing_algorithms</span><span class="o">=</span><span class="n">metric_layers_algorithm_details</span><span class="p">,</span>
                <span class="n">metric_layers_count</span><span class="o">=</span><span class="n">metric_lc</span><span class="p">,</span>
                <span class="n">metric_layers_matched_count</span><span class="o">=</span><span class="n">metric_lmc</span><span class="p">,</span>
                <span class="n">graphite_layers_matched_images</span><span class="o">=</span><span class="n">glm_images</span><span class="p">,</span>
                <span class="n">layers_id_matched</span><span class="o">=</span><span class="n">l_id_matched</span><span class="p">,</span> <span class="n">ts_full_duration</span><span class="o">=</span><span class="n">ts_fd</span><span class="p">,</span>
                <span class="n">app_context</span><span class="o">=</span><span class="n">m_app_context</span><span class="p">,</span> <span class="n">ionosphere_json</span><span class="o">=</span><span class="n">i_ts_json</span><span class="p">,</span>
                <span class="n">baseline_fd</span><span class="o">=</span><span class="n">full_duration</span><span class="p">,</span> <span class="n">last_ts_json</span><span class="o">=</span><span class="n">sample_ts_json</span><span class="p">,</span>
                <span class="n">last_i_ts_json</span><span class="o">=</span><span class="n">sample_i_ts_json</span><span class="p">,</span> <span class="n">layers_updated</span><span class="o">=</span><span class="n">layers_updated</span><span class="p">,</span>
                <span class="n">fp_id_matched</span><span class="o">=</span><span class="n">f_id_matched</span><span class="p">,</span> <span class="n">fp_id_created</span><span class="o">=</span><span class="n">f_id_created</span><span class="p">,</span>
                <span class="n">fp_generation</span><span class="o">=</span><span class="n">fp_generation_created</span><span class="p">,</span> <span class="n">validated</span><span class="o">=</span><span class="n">fp_validated</span><span class="p">,</span>
                <span class="n">validated_fp_successful</span><span class="o">=</span><span class="n">validated_fp_success</span><span class="p">,</span>
                <span class="n">profile_layer_algorithms</span><span class="o">=</span><span class="n">fp_layer_algorithms</span><span class="p">,</span>
                <span class="n">current_layer</span><span class="o">=</span><span class="n">fp_current_layer</span><span class="p">,</span>
                <span class="n">save_metric_td</span><span class="o">=</span><span class="n">save_training_data</span><span class="p">,</span>
                <span class="n">saved_metric_td_label</span><span class="o">=</span><span class="n">saved_td_label</span><span class="p">,</span>
                <span class="n">saved_metric_td</span><span class="o">=</span><span class="n">saved_training_data</span><span class="p">,</span>
                <span class="n">metric_training_data_saved</span><span class="o">=</span><span class="n">training_data_saved</span><span class="p">,</span>
                <span class="n">saved_metric_td_requested</span><span class="o">=</span><span class="n">saved_td_requested</span><span class="p">,</span>
                <span class="n">saved_metric_td_details</span><span class="o">=</span><span class="n">saved_td_details</span><span class="p">,</span>
                <span class="n">profile_enabled</span><span class="o">=</span><span class="n">fp_enabled</span><span class="p">,</span> <span class="n">disable_feature_profile</span><span class="o">=</span><span class="n">disable_fp</span><span class="p">,</span>
                <span class="n">disabled_fp_successful</span><span class="o">=</span><span class="n">disabled_fp_success</span><span class="p">,</span>
                <span class="n">family_tree_ids</span><span class="o">=</span><span class="n">family_tree_fp_ids</span><span class="p">,</span>
                <span class="n">matched_fp_id</span><span class="o">=</span><span class="n">matched_fp_id</span><span class="p">,</span> <span class="n">matched_layer_id</span><span class="o">=</span><span class="n">matched_layer_id</span><span class="p">,</span>
                <span class="n">matched_id_resources</span><span class="o">=</span><span class="n">matched_id_resources</span><span class="p">,</span>
                <span class="n">matched_graph_image_file</span><span class="o">=</span><span class="n">matched_graph_image_file</span><span class="p">,</span>
                <span class="c1"># @added 20180620 - Feature #2404: Ionosphere - fluid approximation</span>
                <span class="c1"># Added minmax scaling</span>
                <span class="n">minmax</span><span class="o">=</span><span class="n">minmax</span><span class="p">,</span>
                <span class="n">correlations</span><span class="o">=</span><span class="n">correlations</span><span class="p">,</span>
                <span class="c1"># @added 20180723 - Feature #2470: Correlations Graphite graph links</span>
                <span class="c1">#                   Branch #2270: luminosity</span>
                <span class="c1"># Added Graphite graph links to the Correlations block in</span>
                <span class="c1"># the correlations.html and training_data.html templates</span>
                <span class="n">correlations_with_graph_links</span><span class="o">=</span><span class="n">correlations_with_graph_links</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="c1"># @added 20180921 - Feature #2558: Ionosphere - fluid approximation - approximately_close on layers</span>
                <span class="n">approx_close</span><span class="o">=</span><span class="n">approx_close</span><span class="p">,</span>
                <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
                <span class="c1"># Added ionosphere_echo</span>
                <span class="n">echo_fp</span><span class="o">=</span><span class="n">echo_fp_value</span><span class="p">,</span> <span class="n">echo_human_date</span><span class="o">=</span><span class="n">echo_hdate</span><span class="p">,</span>
                <span class="n">metric_full_duration_in_hours_image_str</span><span class="o">=</span><span class="n">m_fd_in_hours_img_str</span><span class="p">,</span>
                <span class="c1"># @added 20190510 - Feature #2990: Add metrics id to relevant web pages</span>
                <span class="n">metric_id</span><span class="o">=</span><span class="n">metric_id</span><span class="p">,</span>
                <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
                <span class="n">match_validated</span><span class="o">=</span><span class="n">match_validated</span><span class="p">,</span>
                <span class="n">match_validated_db_value</span><span class="o">=</span><span class="n">match_validated_db_value</span><span class="p">,</span>
                <span class="n">validated_match_successful</span><span class="o">=</span><span class="n">validated_match_successful</span><span class="p">,</span>
                <span class="c1"># @added 20190922 - Feature #2516: Add label to features profile</span>
                <span class="n">fp_label</span><span class="o">=</span><span class="n">fp_label</span><span class="p">,</span>
                <span class="c1"># @added 20200113 - Feature #3390: luminosity related anomalies</span>
                <span class="c1">#                   Branch #2270: luminosity</span>
                <span class="n">related</span><span class="o">=</span><span class="n">related</span><span class="p">,</span> <span class="n">related_with_graph_links</span><span class="o">=</span><span class="n">related_with_graph_links</span><span class="p">,</span>
                <span class="n">related_matches</span><span class="o">=</span><span class="n">related_matches</span><span class="p">,</span>
                <span class="c1"># @added 20200711 - Feature #3634: webapp - ionosphere - report number of data points</span>
                <span class="n">ts_json_length</span><span class="o">=</span><span class="n">ts_json_length</span><span class="p">,</span>
                <span class="n">anomalous_timeseries_length</span><span class="o">=</span><span class="n">anomalous_timeseries_length</span><span class="p">,</span>
                <span class="c1"># @added 20200731 - Feature #3654: IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span>
                <span class="n">graphite_now_graphs_title</span><span class="o">=</span><span class="n">graphite_now_graphs_title</span><span class="p">,</span>
                <span class="c1"># @added 20200808 - Feature #3568: Ionosphere - report anomalies in training period</span>
                <span class="n">labelled_anomalies</span><span class="o">=</span><span class="n">labelled_anomalies</span><span class="p">,</span>
                <span class="c1"># @added 20200813 - Feature #3670: IONOSPHERE_CUSTOM_KEEP_TRAINING_TIMESERIES_FOR</span>
                <span class="n">historical_training_data</span><span class="o">=</span><span class="n">historical_training_data</span><span class="p">,</span>
                <span class="c1"># @added 20210324 - Feature #3642: Anomaly type classification</span>
                <span class="n">anomaly_types</span><span class="o">=</span><span class="n">anomaly_types</span><span class="p">,</span> <span class="n">anomaly_type_ids</span><span class="o">=</span><span class="n">anomaly_type_ids</span><span class="p">,</span>
                <span class="c1"># @added 20210413 - Feature #4014: Ionosphere - inference</span>
                <span class="c1">#                   Branch #3590: inference</span>
                <span class="n">matched_motif_id</span><span class="o">=</span><span class="n">matched_motif_id</span><span class="p">,</span>
                <span class="c1"># @added 20210415 - Feature #4014: Ionosphere - inference</span>
                <span class="c1">#                   Branch #3590: inference</span>
                <span class="n">matched_details_object</span><span class="o">=</span><span class="n">matched_details_object</span><span class="p">,</span>
                <span class="n">motif_analysis</span><span class="o">=</span><span class="n">motif_analysis</span><span class="p">,</span>
                <span class="n">motif_analysis_images</span><span class="o">=</span><span class="n">motif_analysis_images</span><span class="p">,</span>
                <span class="n">motif_analysis_motif_id_by_distance</span><span class="o">=</span><span class="n">motif_analysis_motif_id_by_distance</span><span class="p">,</span>
                <span class="c1"># @added 20210416 - Feature #4014: Ionosphere - inference</span>
                <span class="n">ionosphere_matched_id</span><span class="o">=</span><span class="n">ionosphere_matched_id</span><span class="p">,</span>
                <span class="c1"># @added 20210417 - Feature #4014: Ionosphere - inference</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">top_matches</span><span class="o">=</span><span class="n">top_matches</span><span class="p">,</span>
                <span class="n">max_distance</span><span class="o">=</span><span class="n">max_distance</span><span class="p">,</span>
                <span class="c1"># @added 20210419 - Feature #4014: Ionosphere - inference</span>
                <span class="n">matched_motif_dict</span><span class="o">=</span><span class="n">inference_match_motif_dict</span><span class="p">,</span>
                <span class="n">inference_match_motif_image</span><span class="o">=</span><span class="n">inference_match_motif_image</span><span class="p">,</span>
                <span class="c1"># @added 20210422 - Feature #4014: Ionosphere - inference</span>
                <span class="c1"># Allow the user to specify the range_padding</span>
                <span class="n">motif_range_padding</span><span class="o">=</span><span class="n">motif_range_padding</span><span class="p">,</span>
                <span class="c1"># @added 20210425 - Feature #4014: Ionosphere - inference</span>
                <span class="c1"># Allow user to specify the difference between the areas under the</span>
                <span class="c1"># curve</span>
                <span class="n">motif_max_area_percent_diff</span><span class="o">=</span><span class="n">motif_max_area_percent_diff</span><span class="p">,</span>
                <span class="c1"># @added 20220317 - Feature #4540: Plot matched timeseries</span>
                <span class="c1">#                   Feature #4014: Ionosphere - inference</span>
                <span class="n">matched_fp_plot</span><span class="o">=</span><span class="n">matched_fp_plot</span><span class="p">,</span>
                <span class="c1"># @added 20220516 - Feature #2580: illuminance</span>
                <span class="n">illuminance_events_dict</span><span class="o">=</span><span class="n">illuminance_events_dict</span><span class="p">,</span>
                <span class="n">illuminance_events_count</span><span class="o">=</span><span class="n">illuminance_items_used</span><span class="p">,</span>
                <span class="c1"># @added 20220728 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="n">labelled_metric_base_name</span><span class="o">=</span><span class="n">labelled_metric_base_name</span><span class="p">,</span>
                <span class="n">labelled_metric_name</span><span class="o">=</span><span class="n">labelled_metric_name</span><span class="p">,</span>
                <span class="c1"># @added 20220822 - Task #2732: Prometheus to Skyline</span>
                <span class="c1">#                   Branch #4300: prometheus</span>
                <span class="c1"># Only enable training if there is sufficient data</span>
                <span class="n">valid_length_for_training</span><span class="o">=</span><span class="n">valid_length_for_training</span><span class="p">,</span>
                <span class="c1"># @added 20221202 - Feature #4732: flux vortex</span>
                <span class="c1">#                   Feature #4734: mirage_vortex</span>
                <span class="n">vortex_training</span><span class="o">=</span><span class="n">vortex_training</span><span class="p">,</span> <span class="n">vortex_fp</span><span class="o">=</span><span class="n">vortex_fp</span><span class="p">,</span>
                <span class="n">vortex_metric_data</span><span class="o">=</span><span class="n">vortex_metric_data</span><span class="p">,</span>
                <span class="c1"># @added 20230601 - Feature #4734: mirage_vortex</span>
                <span class="c1">#                   Branch #4728: vortex</span>
                <span class="c1"># Add results to training_data_dir to be loaded in the Ionosphere</span>
                <span class="c1"># training page</span>
                <span class="n">vortex_results_dict</span><span class="o">=</span><span class="n">vortex_results_dict</span><span class="p">,</span>
                <span class="c1"># @added 20230626</span>
                <span class="n">insufficient_data_for_training</span><span class="o">=</span><span class="n">insufficient_data_for_training</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Unknown request&#39;</span>
        <span class="c1"># @added 20221026 - Feature #4706: Add request_id and timing to ionosphere requests</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;completed ionosphere request_id: </span><span class="si">%s</span><span class="s1">, took: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">display_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
            <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span></div>


<div class="viewcode-block" id="ionosphere_images"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.ionosphere_images">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/ionosphere_images&#39;</span><span class="p">)</span>
<span class="c1"># @added 20210316 - Feature #3978: luminosity - classify_metrics</span>
<span class="c1">#                   Feature #3642: Anomaly type classification</span>
<span class="c1"># Serve the luminosity_images endpoint as well, for classify_metrics plots</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/luminosity_images&#39;</span><span class="p">)</span>
<span class="c1"># @added 20210328 - Feature #3994: Panorama - mirage not anomalous</span>
<span class="c1"># Serve the panorama_file endpoint as well</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/panorama_images&#39;</span><span class="p">)</span>
<span class="c1"># @added 20211103 - Branch #3068: SNAB</span>
<span class="c1">#                   Bug #4308: matrixprofile - fN on big drops</span>
<span class="c1"># Serve the snab_images endpoint as well</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/snab_images&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ionosphere_images</span><span class="p">():</span>

    <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: request arguments have no length - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_args_len</span><span class="p">))</span>

    <span class="n">IONOSPHERE_REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">request_args_present</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IONOSPHERE_REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                <span class="c1"># Return data</span>
                <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;No content&#39;</span><span class="p">,</span> <span class="mi">204</span>

                <span class="c1"># @added 20201214 - Feature #3890: metrics_manager - sync_cluster_files</span>
                <span class="c1"># Even though authenticated only allow specific paths</span>
                <span class="n">IONOSPHERE_IMAGE_ALLOWED_PATHS</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span>
                    <span class="c1"># @added 20210112 - Feature #3934: ionosphere_performance</span>
                    <span class="n">performance_dir</span><span class="p">,</span>
                    <span class="c1"># @added 20210209 - Feature #1448: Crucible web UI</span>
                    <span class="n">crucible_jobs_dir</span><span class="p">,</span>
                    <span class="c1"># @added 20210316 - Feature #3978: luminosity - classify_metrics</span>
                    <span class="c1">#                   Feature #3642: Anomaly type classification</span>
                    <span class="n">luminosity_data_folder</span><span class="p">,</span>
                    <span class="c1"># @added 20210328 - Feature #3994: Panorama - mirage not anomalous</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="n">allowed_path</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">allowed_image_path</span> <span class="ow">in</span> <span class="n">IONOSPHERE_IMAGE_ALLOWED_PATHS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">allowed_image_path</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">allowed_path</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_path</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;forbidden filename, returning 403 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;Forbidden&#39;</span><span class="p">,</span> <span class="mi">403</span>
                <span class="k">if</span> <span class="s1">&#39;.png&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;forbidden filename, not png, returning 403 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;Forbidden&#39;</span><span class="p">,</span> <span class="mi">403</span>

                <span class="c1"># @added 20220112 - Bug #4374: webapp - handle url encoded chars</span>
                <span class="c1"># if not os.path.isfile(filename):</span>
                <span class="c1">#     r_url = iri_to_uri(request.url)</span>
                <span class="c1">#     logger.info(&#39;r_url: %s&#39; % r_url)</span>

                <span class="c1"># @added 20221206 - Feature #4732: flux vortex</span>
                <span class="c1">#                   Feature #4734: mirage_vortex</span>
                <span class="c1"># Generate vortex algorithm graphs on-demand if they do not</span>
                <span class="c1"># exist.</span>
                <span class="n">file_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">generate_vortex_images</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">file_basename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;vortex.algorithm.&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">file_basename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                            <span class="n">generate_vortex_images</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;image not found will attempt to get_vortex_training_data_graphs to create </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">generate_vortex_images</span><span class="p">:</span>
                    <span class="n">training_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">metric_data_archive</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_data_archive</span> <span class="o">=</span> <span class="n">get_vortex_metric_data_archive_filename</span><span class="p">(</span><span class="n">training_dir</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_vortex_metric_data_archive_filename failed to determine metric_data_archive from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">training_dir</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">vortex_graphs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">metric_data_archive</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">vortex_graphs</span> <span class="o">=</span> <span class="n">get_vortex_training_data_graphs</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_data_archive</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;get_vortex_training_data_graphs encountered an error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>
                            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">vortex_graphs</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;image created </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :( - could not return </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">image_404_path</span> <span class="o">=</span> <span class="s1">&#39;webapp/static/images/skyline.ionosphere.image.404.png&#39;</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">image_404_path</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :( - could not return </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span></div>


<span class="c1"># @added 20201213 - Feature #3890: metrics_manager - sync_cluster_files</span>
<div class="viewcode-block" id="ionosphere_files"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.ionosphere_files">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/ionosphere_files&#39;</span><span class="p">)</span>
<span class="c1"># @added 20210316 - Feature #3978: luminosity - classify_metrics</span>
<span class="c1">#                   Feature #3642: Anomaly type classification</span>
<span class="c1"># Serve the luminosity_file endpoint as well, for classify_metrics plots</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/luminosity_files&#39;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">ionosphere_files</span><span class="p">():</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_files request arguments have no length - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_args_len</span><span class="p">))</span>

    <span class="c1"># @modified 20210316 - Feature #3978: luminosity - classify_metrics</span>
    <span class="c1">#                      Feature #3642: Anomaly type classification</span>
    <span class="c1"># Added algorithm_name and classify_metrics</span>
    <span class="n">IONOSPHERE_FILES_REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithm_name&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">IONOSPHERE_FILES_ALLOWED_DIR_TYPES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;training_data&#39;</span><span class="p">,</span> <span class="s1">&#39;features_profiles&#39;</span><span class="p">,</span> <span class="s1">&#39;classify_metrics&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">allowed_source_dir</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">request_args_present</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IONOSPHERE_FILES_REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_files invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">IONOSPHERE_FILES_ALLOWED_DIR_TYPES</span><span class="p">:</span>
                    <span class="n">allowed_source_dir</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_source_dir</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_files not in IONOSPHERE_FILES_ALLOWED_DIR_TYPES - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">source</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span>
                <span class="n">timestamp_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp_str</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_files timestamp is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">timestamp_str</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># @added 20210316 - Feature #3978: luminosity - classify_metrics</span>
            <span class="c1">#                   Feature #3642: Anomaly type classification</span>
            <span class="c1"># Added algorithm_name</span>
            <span class="n">algorithm_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;algorithm_name&#39;</span><span class="p">:</span>
                <span class="n">algorithm_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_files no metric passed&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>

    <span class="c1"># @added 20230331 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="n">use_metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;_tenant_id=&quot;&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
        <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?ionospherere_files :: get_metric_id_from_base_name failed with base_name: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
            <span class="n">use_metric</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>

    <span class="n">required_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">allowed_source_dir</span> <span class="ow">and</span> <span class="n">timestamp</span> <span class="ow">and</span> <span class="n">metric</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20230331 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                      Branch #4300: prometheus</span>
            <span class="c1"># metric_timeseries_dir = metric.replace(&#39;.&#39;, &#39;/&#39;)</span>
            <span class="n">metric_timeseries_dir</span> <span class="o">=</span> <span class="n">use_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;features_profiles&#39;</span><span class="p">:</span>
                <span class="n">required_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span><span class="p">:</span>
                <span class="n">required_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span>
                    <span class="n">metric_timeseries_dir</span><span class="p">)</span>
            <span class="c1"># @added 20210316 - Feature #3978: luminosity - classify_metrics</span>
            <span class="c1">#                   Feature #3642: Anomaly type classification</span>
            <span class="c1"># Added classify_metrics</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;classify_metrics&#39;</span><span class="p">:</span>
                <span class="n">required_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">luminosity_data_folder</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">algorithm_name</span><span class="p">,</span>
                    <span class="n">metric_timeseries_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_files failed to interpolate required_dir&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="n">files_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">required_dir</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">required_dir</span><span class="p">):</span>
            <span class="c1"># @modified 20201216 - Feature #3890: metrics_manager - sync_cluster_files</span>
            <span class="c1"># Remove the entry from the ionosphere.training data Redis set if</span>
            <span class="c1"># the directory does not exist on this node</span>
            <span class="c1"># logger.info(&#39;ionosphere_files required_dir does not exist - %s, returning 404&#39; % str(required_dir))</span>
            <span class="c1"># return &#39;Not Found&#39;, 404</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;features_profiles dir&quot;</span><span class="p">:</span> <span class="s2">&quot;not found&quot;</span><span class="p">}}</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ionosphere_training_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.training_data&#39;</span><span class="p">))</span>
                    <span class="n">training_data_removed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">training_data_item</span> <span class="ow">in</span> <span class="n">ionosphere_training_data</span><span class="p">:</span>
                        <span class="n">training_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">training_data_item</span><span class="p">)</span>
                        <span class="c1"># @modified 20230331 - Task #2732: Prometheus to Skyline</span>
                        <span class="c1">#                      Branch #4300: prometheus</span>
                        <span class="c1"># if training_data[0] == metric:</span>
                        <span class="k">if</span> <span class="n">training_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">use_metric</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">training_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;ionosphere.training_data&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">training_data</span><span class="p">))</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ionosphere_files removed item from ionosphere.training_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">training_data</span><span class="p">))</span>
                                    <span class="n">training_data_removed</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_files failed to remove item from ionosphere.training_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">training_data</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_files failed to try and remove the unfound training data dir for </span><span class="si">%s</span><span class="s1"> from ionosphere.training_data&#39;</span> <span class="o">%</span> <span class="n">required_dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">training_data_removed</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ionosphere_files found no item to remove from ionosphere.training_data for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ionosphere_files dir not found for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">, returning 404&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)))</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;training_data dir&quot;</span><span class="p">:</span> <span class="s2">&quot;not found&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>

        <span class="k">for</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">required_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                        <span class="n">path_and_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">required_dir</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                        <span class="n">files_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_and_file</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_files failed to build files_list from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">required_dir</span><span class="p">))</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">files_dict</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: ionosphere_files no files in required_dir - </span><span class="si">%s</span><span class="s1"> - returning 404&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">required_dir</span><span class="p">))</span>
        <span class="c1"># return &#39;Not Found&#39;, 404</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="s2">&quot;not found&quot;</span><span class="p">}}</span>
        <span class="k">if</span> <span class="n">algorithm_name</span> <span class="ow">and</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;classify_metrics&#39;</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="s2">&quot;algorithm_name&quot;</span><span class="p">:</span> <span class="n">algorithm_name</span><span class="p">,</span> <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="s2">&quot;not found&quot;</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span>
    <span class="k">if</span> <span class="n">files_dict</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">files_dict</span><span class="p">}}</span>
        <span class="c1"># @added 20210316 - Feature #3978: luminosity - classify_metrics</span>
        <span class="c1">#                   Feature #3642: Anomaly type classification</span>
        <span class="c1"># Added algorithm_name for classify_metrics</span>
        <span class="k">if</span> <span class="n">algorithm_name</span> <span class="ow">and</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;classify_metrics&#39;</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">},</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
                    <span class="s2">&quot;algorithm_name&quot;</span><span class="p">:</span> <span class="n">algorithm_name</span><span class="p">,</span> <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">files_dict</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ionosphere_files returned json with </span><span class="si">%s</span><span class="s1"> files listed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files_dict</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span></div>


<span class="c1"># TODO @gzipped this?  But really bandwidth is more available than CPU</span>
<span class="c1"># @added 20201213 - Feature #3890: metrics_manager - sync_cluster_files</span>
<div class="viewcode-block" id="ionosphere_file"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.ionosphere_file">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/ionosphere_file&#39;</span><span class="p">)</span>
<span class="c1"># @added 20210316 - Feature #3978: luminosity - classify_metrics</span>
<span class="c1">#                   Feature #3642: Anomaly type classification</span>
<span class="c1"># Serve the luminosity_file endpoint as well, for classify_metrics plots</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/luminosity_file&#39;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">ionosphere_file</span><span class="p">():</span>

    <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_file request arguments have no length - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_args_len</span><span class="p">))</span>

    <span class="n">IONOSPHERE_FILE_REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
    <span class="n">IONOSPHERE_FILE_ALLOWED_PATHS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span>
        <span class="c1"># @added 20210112 - Feature #3934: ionosphere_performance</span>
        <span class="n">performance_dir</span><span class="p">,</span>
        <span class="c1"># @added 20210223 - Feature #2054: ionosphere.save.training_data</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span> <span class="o">+</span> <span class="s1">&#39;_saved&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20210316 - Feature #3978: luminosity - classify_metrics</span>
        <span class="c1">#                   Feature #3642: Anomaly type classification</span>
        <span class="n">luminosity_data_folder</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">request_args_present</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IONOSPHERE_FILE_REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># logger.info(&#39;request argument - %s=%s&#39; % (key, str(value)))</span>

            <span class="n">allowed_file</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">allowed_path</span> <span class="ow">in</span> <span class="n">IONOSPHERE_FILE_ALLOWED_PATHS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">allowed_path</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">allowed_file</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_file</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_file not in allowed paths - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
            <span class="k">if</span> <span class="n">allowed_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                    <span class="n">mimetype</span> <span class="o">=</span> <span class="s1">&#39;application/octet-stream&#39;</span>
                    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">):</span>
                        <span class="n">mimetype</span> <span class="o">=</span> <span class="s1">&#39;image/png&#39;</span>
                    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">):</span>
                        <span class="n">mimetype</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
                    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">):</span>
                        <span class="n">mimetype</span> <span class="o">=</span> <span class="s1">&#39;text/plain&#39;</span>
                    <span class="c1"># @added 20210112 - Feature #3934: ionosphere_performance</span>
                    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
                        <span class="n">mimetype</span> <span class="o">=</span> <span class="s1">&#39;text/csv&#39;</span>
                    <span class="c1"># @added 20230510 - Feature #4734: mirage_vortex</span>
                    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;json.gz&#39;</span><span class="p">):</span>
                        <span class="n">mimetype</span> <span class="o">=</span> <span class="s1">&#39;application/gzip&#39;</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="n">mimetype</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ionosphere_file failed to send_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: ionosphere_file not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span> <span class="mi">404</span>
    <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span></div>


<span class="c1"># @added 20170102 - Feature #1838: utilites - ALERTS matcher</span>
<span class="c1">#                   Branch #922: ionosphere</span>
<span class="c1">#                   Task #1658: Patterning Skyline Ionosphere</span>
<span class="c1"># Added utilities TODO</span>
<div class="viewcode-block" id="utilities"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.utilities">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/utilities&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">utilities</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># @added 20210604 - Branch #1444: thunder</span>
    <span class="n">metrics_match</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">match_metric</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">thunder_testing</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">thunder_no_data_test</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">thunder_no_data_test_key_added</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">thunder_stale_metrics_test</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">thunder_stale_metrics_test_key_added</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20220228 - Feature #4468: flux - remove_namespace_quota_metrics</span>
    <span class="n">remove_flux_namespace_quota_metrics</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dry_run</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">removed_quota_metrics_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">removed_quota_metrics</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># @added 20220301 - Feature #4482: Test alerts</span>
    <span class="n">test_alert</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">alert_on_metric</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">alerter_app</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">alerter</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">http_alerters</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">parent_namespaces</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># @added 20220802 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="n">labelled_metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">labelled_metrics_names</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20220808 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="n">timeseries_graph_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">timeseries_graph_image</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20221204 - Feature #4754: csv_to_timeseries</span>
    <span class="c1">#                   Feature #4734: mirage_vortex</span>
    <span class="c1">#                   Branch #4728: vortex</span>
    <span class="n">csv_to_timeseries_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">temporary_key</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
    <span class="n">mute_alerts_on</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">muted_alerts_on</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">muted_metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metric_patterns</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">UTILITIES_REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;settings_list&#39;</span><span class="p">,</span> <span class="s1">&#39;match_with&#39;</span><span class="p">,</span> <span class="s1">&#39;thunder_testing&#39;</span><span class="p">,</span>
        <span class="s1">&#39;thunder_no_data_test&#39;</span><span class="p">,</span> <span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;stale_period&#39;</span><span class="p">,</span> <span class="s1">&#39;expiry&#39;</span><span class="p">,</span>
        <span class="s1">&#39;thunder_no_data_test_key_added&#39;</span><span class="p">,</span> <span class="s1">&#39;thunder_stale_metrics_test&#39;</span><span class="p">,</span>
        <span class="s1">&#39;thunder_stale_metrics_test_key_added&#39;</span><span class="p">,</span> <span class="s1">&#39;match_metric&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20220228 - Feature #4468: flux - remove_namespace_quota_metrics</span>
        <span class="s1">&#39;remove_flux_namespace_quota_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;dry_run&#39;</span><span class="p">,</span>
        <span class="s1">&#39;removed_quota_metrics_key&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20220301 - Feature #4482: Test alerts</span>
        <span class="s1">&#39;test_alert&#39;</span><span class="p">,</span> <span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;alerter&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20220315 - Feature #4482: Test alerts</span>
        <span class="s1">&#39;alerter_id&#39;</span><span class="p">,</span> <span class="s1">&#39;trigger_anomaly&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20220802 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="s1">&#39;labelled_metrics_names&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20220808 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                   Branch #4300: prometheus</span>
        <span class="s1">&#39;timeseries_graph&#39;</span><span class="p">,</span> <span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;data_source&#39;</span><span class="p">,</span>
        <span class="s1">&#39;downsample_at&#39;</span><span class="p">,</span> <span class="s1">&#39;downsample_by&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20221204 - Feature #4754: csv_to_timeseries</span>
        <span class="c1">#                   Feature #4734: mirage_vortex</span>
        <span class="c1">#                   Branch #4728: vortex</span>
        <span class="s1">&#39;csv_to_timeseries&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;data_file&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
        <span class="s1">&#39;mute_alerts_on&#39;</span><span class="p">,</span> <span class="s1">&#39;list_muted_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_patterns&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">request_args_len</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">UTILITIES_REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;thunder_testing&#39;</span><span class="p">:</span>
                <span class="n">thunder_testing</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metrics_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;thunder_testing running get_top_level_namespaces&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parent_namespaces</span> <span class="o">=</span> <span class="n">get_top_level_namespaces</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;get_top_level_namespaces failed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;thunder_no_data_test&#39;</span><span class="p">:</span>
                <span class="n">thunder_no_data_test</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metrics_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;thunder_no_data_test running get_top_level_namespaces&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parent_namespaces</span> <span class="o">=</span> <span class="n">get_top_level_namespaces</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;get_top_level_namespaces failed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;thunder_stale_metrics_test&#39;</span><span class="p">:</span>
                <span class="n">thunder_stale_metrics_test</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metrics_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;thunder_stale_metrics_test running get_top_level_namespaces&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parent_namespaces</span> <span class="o">=</span> <span class="n">get_top_level_namespaces</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;get_top_level_namespaces failed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="c1"># @added 20220228 - Feature #4468: flux - remove_namespace_quota_metrics</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;match_metric&#39;</span><span class="p">:</span>
                <span class="n">match_metric</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;remove_flux_namespace_quota_metrics&#39;</span><span class="p">:</span>
                <span class="n">remove_flux_namespace_quota_metrics</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metrics_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_flux_namespace_quota_metrics request&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;dry_run&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_flux_namespace_quota_metrics request dry_run: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dry_run</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">dry_run</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">dry_run</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;removed_quota_metrics_key&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">removed_quota_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;remove_flux_namespace_quota_metrics :: failed to get Redis set </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="c1"># @added 20220301 - Feature #4482: Test alerts</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;test_alert&#39;</span><span class="p">:</span>
                <span class="n">test_alert</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">http_alerters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">HTTP_ALERTERS_OPTS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">metrics_match</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># @added 20220802 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;labelled_metrics_names&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_names request&#39;</span><span class="p">)</span>
                <span class="n">metrics_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">labelled_metrics_names</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;labelled_metric_base_name&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                        <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;labelled_metric_base_name&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">labelled_metric_base_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_names labelled_metric_base_name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_base_name</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="s1">&#39;labelled_metric_name&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                        <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">labelled_metric_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_names labelled_metric_name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_name</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">labelled_metric_base_name</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">labelled_metric_name</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_base_name_from_labelled_metrics_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">labelled_metric_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">labelled_metric_base_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_metric_id_from_base_name failed for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">labelled_metric_base_name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">labelled_metric_name</span> <span class="ow">and</span> <span class="n">labelled_metric_base_name</span><span class="p">:</span>
                    <span class="n">labelled_metric_name</span> <span class="o">=</span> <span class="s1">&#39;labelled_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)</span>
                <span class="n">labelled_metric_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;metric_id&#39;</span><span class="p">:</span> <span class="n">metric_id</span><span class="p">,</span>
                    <span class="s1">&#39;labelled_metric_name&#39;</span><span class="p">:</span> <span class="n">labelled_metric_name</span><span class="p">,</span>
                    <span class="s1">&#39;labelled_metric_base_name&#39;</span><span class="p">:</span> <span class="n">labelled_metric_base_name</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">metric_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">labelled_metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelled_metrics_names labelled_metric_dict: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelled_metric_dict</span><span class="p">))</span>
                <span class="k">if</span> <span class="s1">&#39;format&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                    <span class="n">use_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">use_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">labelled_metric_dict</span><span class="p">}</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;utilites returned labelled_metric_dict json: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

            <span class="c1"># @added 20220808 - Task #2732: Prometheus to Skyline</span>
            <span class="c1">#                   Branch #4300: prometheus</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timeseries_graph&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;timeseries_graph request&#39;</span><span class="p">)</span>
                <span class="n">metrics_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">timeseries_graph_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timeseries_graph_image</span> <span class="o">=</span> <span class="n">timeseries_graph</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: timeseries_graph failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># @added 20221204 - Feature #4754: csv_to_timeseries</span>
            <span class="c1">#                   Feature #4734: mirage_vortex</span>
            <span class="c1">#                   Branch #4728: vortex</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;csv_to_timeseries&#39;</span><span class="p">:</span>
                <span class="n">csv_to_timeseries_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metrics_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">match_metric</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">temporary_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
                <span class="n">redis_temporary_upload_key</span> <span class="o">=</span> <span class="s1">&#39;csv_to_timeseries.tmp.temporary_upload_key.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">temporary_key</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_temporary_upload_key</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">temporary_key</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_temporary_upload_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not add Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_temporary_upload_key</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

            <span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;mute_alerts_on&#39;</span><span class="p">:</span>
                <span class="n">mute_alerts_on</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metrics_match</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;utilities.html&#39;</span><span class="p">,</span> <span class="n">metrics_match</span><span class="o">=</span><span class="n">metrics_match</span><span class="p">,</span> <span class="n">match_metric</span><span class="o">=</span><span class="n">match_metric</span><span class="p">,</span>
            <span class="n">thunder_testing</span><span class="o">=</span><span class="n">thunder_testing</span><span class="p">,</span>
            <span class="n">thunder_no_data_test</span><span class="o">=</span><span class="n">thunder_no_data_test</span><span class="p">,</span>
            <span class="n">parent_namespaces</span><span class="o">=</span><span class="n">parent_namespaces</span><span class="p">,</span>
            <span class="n">thunder_no_data_test_key_added</span><span class="o">=</span><span class="n">thunder_no_data_test_key_added</span><span class="p">,</span>
            <span class="n">thunder_stale_metrics_test</span><span class="o">=</span><span class="n">thunder_stale_metrics_test</span><span class="p">,</span>
            <span class="n">thunder_stale_metrics_test_key_added</span><span class="o">=</span><span class="n">thunder_stale_metrics_test_key_added</span><span class="p">,</span>
            <span class="n">remove_flux_namespace_quota_metrics</span><span class="o">=</span><span class="n">remove_flux_namespace_quota_metrics</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span> <span class="n">removed_quota_metrics</span><span class="o">=</span><span class="n">removed_quota_metrics</span><span class="p">,</span>
            <span class="n">test_alert</span><span class="o">=</span><span class="n">test_alert</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">alert_on_metric</span><span class="p">,</span> <span class="n">alerter_app</span><span class="o">=</span><span class="n">alerter_app</span><span class="p">,</span>
            <span class="n">alerter</span><span class="o">=</span><span class="n">alerter</span><span class="p">,</span> <span class="n">http_alerters</span><span class="o">=</span><span class="n">http_alerters</span><span class="p">,</span>
            <span class="n">labelled_metrics_names</span><span class="o">=</span><span class="n">labelled_metrics_names</span><span class="p">,</span>
            <span class="n">labelled_metric_dict</span><span class="o">=</span><span class="n">labelled_metric_dict</span><span class="p">,</span>
            <span class="n">timeseries_graph</span><span class="o">=</span><span class="n">timeseries_graph_request</span><span class="p">,</span>
            <span class="n">timeseries_graph_image</span><span class="o">=</span><span class="n">timeseries_graph_image</span><span class="p">,</span>
            <span class="n">csv_to_timeseries</span><span class="o">=</span><span class="n">csv_to_timeseries_request</span><span class="p">,</span>
            <span class="n">temporary_upload_key</span><span class="o">=</span><span class="n">temporary_key</span><span class="p">,</span>
            <span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
            <span class="n">mute_alerts_on</span><span class="o">=</span><span class="n">mute_alerts_on</span><span class="p">,</span> <span class="n">muted_alerts_on</span><span class="o">=</span><span class="n">muted_alerts_on</span><span class="p">,</span>
            <span class="n">muted_metrics</span><span class="o">=</span><span class="n">muted_metrics</span><span class="p">,</span> <span class="n">metric_patterns</span><span class="o">=</span><span class="n">metric_patterns</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to render utilities.html: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span></div>


<span class="c1"># @added 20200516 - Feature #3538: webapp - upload_data endpoint</span>
<span class="c1">#                   Feature #3550: flux.uploaded_data_worker</span>
<div class="viewcode-block" id="flux_frontend"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.flux_frontend">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/flux_frontend&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">flux_frontend</span><span class="p">():</span>
    <span class="n">debug_on</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># file_uploads_enabled = True</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/flux_frontend request&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">FLUX_UPLOAD_DATA_REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;parent_metric_namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;data_file_uploaded&#39;</span><span class="p">,</span> <span class="s1">&#39;info_file_uploaded&#39;</span><span class="p">,</span>
        <span class="s1">&#39;upload_id&#39;</span><span class="p">,</span> <span class="s1">&#39;upload_id_key&#39;</span>
    <span class="p">]</span>

    <span class="n">parent_metric_namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data_file_uploaded</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">info_file_uploaded</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">upload_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">upload_id_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">request_arguments</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">request_args_len</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FLUX_UPLOAD_DATA_REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">request_arguments</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;parent_metric_namespace&#39;</span><span class="p">:</span>
                <span class="n">parent_metric_namespace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;data_file_uploaded&#39;</span><span class="p">:</span>
                <span class="n">data_file_uploaded</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;info_file_uploaded&#39;</span><span class="p">:</span>
                <span class="n">info_file_uploaded</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;upload_id&#39;</span><span class="p">:</span>
                <span class="n">upload_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;upload_id_key&#39;</span><span class="p">:</span>
                <span class="n">upload_id_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">upload_id_key</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">upload_id</span><span class="p">:</span>
            <span class="n">upload_id_key</span> <span class="o">=</span> <span class="n">upload_id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>

    <span class="c1"># To enable uploads via the webapp Flux endpoint using the</span>
    <span class="c1"># settings.FLUX_SELF_API_KEY a shortlived FLUX_UPLOADS_KEYS is created in</span>
    <span class="c1"># in Redis and passed the the upload_data template to submit as the key</span>
    <span class="n">temporary_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">redis_temporary_upload_key</span> <span class="o">=</span> <span class="s1">&#39;flux.tmp.temporary_upload_key.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">temporary_key</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_temporary_upload_key</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">temporary_key</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_temporary_upload_key</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not add Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_temporary_upload_key</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;flux_frontend.html&#39;</span><span class="p">,</span> <span class="n">upload_data_enabled</span><span class="o">=</span><span class="n">file_uploads_enabled</span><span class="p">,</span>
            <span class="n">parent_metric_namespace</span><span class="o">=</span><span class="n">parent_metric_namespace</span><span class="p">,</span>
            <span class="n">data_file_uploaded</span><span class="o">=</span><span class="n">data_file_uploaded</span><span class="p">,</span>
            <span class="n">info_file_uploaded</span><span class="o">=</span><span class="n">info_file_uploaded</span><span class="p">,</span>
            <span class="n">upload_id</span><span class="o">=</span><span class="n">upload_id</span><span class="p">,</span> <span class="n">upload_id_key</span><span class="o">=</span><span class="n">upload_id_key</span><span class="p">,</span>
            <span class="n">temporary_upload_key</span><span class="o">=</span><span class="n">temporary_key</span><span class="p">,</span>
            <span class="n">flux_identifier</span><span class="o">=</span><span class="n">temporary_key</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
            <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span></div>


<span class="c1"># @added 20200514 - Feature #3538: webapp - upload_data endpoint</span>
<span class="c1">#                   Feature #3550: flux.uploaded_data_worker</span>
<div class="viewcode-block" id="upload_data"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.upload_data">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/upload_data&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">upload_data</span><span class="p">():</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/upload_data request&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_uploads_enabled</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span> <span class="mi">404</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">api_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parent_metric_namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">timezone</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">format</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">info_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">info_file_in_archive</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">date_orientation</span> <span class="o">=</span> <span class="s1">&#39;rows&#39;</span>
    <span class="n">skip_rows</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">header_row</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">columns_to_ignore</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">columns_to_process</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">resample_method</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
    <span class="n">json_response</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">flux_identifier</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># @added 20200521 - Feature #3538: webapp - upload_data endpoint</span>
    <span class="c1">#                   Feature #3550: flux.uploaded_data_worker</span>
    <span class="c1"># Added the ability to ignore_submitted_timestamps and not</span>
    <span class="c1"># check flux.last metric timestamp</span>
    <span class="n">ignore_submitted_timestamps</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">upload_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: not a POST requests, returning 400&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span> <span class="mi">405</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;json_response&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">json_response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;json_response&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">json_response</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">json_response</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable json_response - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_response</span><span class="p">))</span>

        <span class="c1"># If there is no key a 401 is returned with no info</span>
        <span class="k">if</span> <span class="s1">&#39;key&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;no key in the POST variables&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request with key - </span><span class="si">%s</span><span class="s1">, using as api_key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">api_key</span><span class="p">))</span>

        <span class="c1"># Do not process requests that do not come from the Flux frontend if</span>
        <span class="c1"># they do not have json_response set.</span>
        <span class="k">if</span> <span class="s1">&#39;flux_identifier&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">json_response</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">flux_frontend_request</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;flux_identifier&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">flux_identifier</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;flux_identifier&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flux_identifier</span><span class="p">:</span>
                <span class="n">flux_identifier_key</span> <span class="o">=</span> <span class="s1">&#39;flux.tmp.temporary_upload_key.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_identifier</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">flux_frontend_request</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flux_identifier_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could query Redis for flux_identifier_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_identifier_key</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flux_frontend_request</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;flux_identifier has expired or is not valid, please reload the Flux page&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;flux_identifier - </span><span class="si">%s</span><span class="s1"> - has expired or is not valid, returning 400&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">flux_identifier</span><span class="p">))</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                             <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                                 <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

        <span class="n">required_post_variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;parent_metric_namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;timezone&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;archive&#39;</span><span class="p">,</span>
            <span class="s1">&#39;date_orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;header_row&#39;</span><span class="p">,</span> <span class="s1">&#39;columns_to_metrics&#39;</span><span class="p">,</span>
            <span class="s1">&#39;info_file_in_archive&#39;</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">r_var</span> <span class="ow">in</span> <span class="n">required_post_variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;no </span><span class="si">%s</span><span class="s1"> in the POST variables&#39;</span> <span class="o">%</span> <span class="n">r_var</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                             <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                                 <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="n">return_400</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">parent_metric_namespace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;parent_metric_namespace&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">parent_metric_namespace</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;blank parent_metric_namespace variable passed&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
            <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">known_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">flux_upload_keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parent_metric_namespace_key</span> <span class="o">=</span> <span class="n">flux_upload_keys</span><span class="p">[</span><span class="n">parent_metric_namespace</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;a key found for </span><span class="si">%s</span><span class="s1"> in flux_upload_keys&#39;</span> <span class="o">%</span> <span class="n">parent_metric_namespace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parent_metric_namespace_key</span> <span class="o">==</span> <span class="n">api_key</span><span class="p">:</span>
                    <span class="n">known_key</span> <span class="o">=</span> <span class="n">api_key</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the key matches the key found for </span><span class="si">%s</span><span class="s1"> in flux_upload_keys&#39;</span> <span class="o">%</span> <span class="n">parent_metric_namespace</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the key variable passed does not match the key found for </span><span class="si">%s</span><span class="s1"> in flux_upload_keys&#39;</span> <span class="o">%</span> <span class="n">parent_metric_namespace</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no known key found for </span><span class="si">%s</span><span class="s1"> in flux_upload_keys&#39;</span> <span class="o">%</span> <span class="n">parent_metric_namespace</span><span class="p">)</span>
                <span class="n">known_key</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># @added 20210114 - Task #3936: Allow for FLUX_API_KEYS rotation</span>
            <span class="c1"># Allow multiple keys per namespace to allow for key rotation</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">known_key</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i_key</span> <span class="ow">in</span> <span class="n">flux_upload_keys</span><span class="p">:</span>
                        <span class="n">parent_metric_namespace_for_key</span> <span class="o">=</span> <span class="n">flux_upload_keys</span><span class="p">[</span><span class="n">i_key</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">parent_metric_namespace_for_key</span> <span class="o">==</span> <span class="n">parent_metric_namespace</span><span class="p">:</span>
                            <span class="n">known_key</span> <span class="o">=</span> <span class="n">i_key</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;a key match for the key found for </span><span class="si">%s</span><span class="s1"> in flux_upload_keys was found&#39;</span> <span class="o">%</span> <span class="n">parent_metric_namespace</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: iterating flux_upload_keys&#39;</span><span class="p">)</span>
                    <span class="n">known_key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">known_key</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no key match was found for </span><span class="si">%s</span><span class="s1"> in flux_upload_keys&#39;</span> <span class="o">%</span> <span class="n">parent_metric_namespace</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">known_key</span><span class="p">:</span>
            <span class="n">redis_temporary_upload_key</span> <span class="o">=</span> <span class="s1">&#39;flux.tmp.temporary_upload_key.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">api_key</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">known_key</span> <span class="o">=</span> <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_temporary_upload_key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;attempt to check </span><span class="si">%s</span><span class="s1"> key in Redis got - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">redis_temporary_upload_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">known_key</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could query Redis for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_temporary_upload_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">known_key</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: unknown key passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">api_key</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable parent_metric_namespace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_metric_namespace</span><span class="p">))</span>
            <span class="n">timezone</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">timezone</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not an accepted timezone&#39;</span> <span class="o">%</span> <span class="n">timezone</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable timezone - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">timezone</span><span class="p">))</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_FORMATS</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not an accepted format&#39;</span> <span class="o">%</span> <span class="nb">format</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable format - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">format</span><span class="p">))</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;archive&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">archive</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_ARCHIVES</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not an accepted archive type&#39;</span> <span class="o">%</span> <span class="n">archive</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable archive - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">archive</span><span class="p">))</span>
            <span class="n">date_orientation</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;date_orientation&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">date_orientation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">]:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a valid date_orientation&#39;</span> <span class="o">%</span> <span class="n">date_orientation</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable date_orientation - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">date_orientation</span><span class="p">))</span>
            <span class="n">header_row_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;header_row&#39;</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header_row_str</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a valid header_row&#39;</span> <span class="o">%</span> <span class="n">header_row_str</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable header_row - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">header_row</span><span class="p">))</span>
            <span class="n">columns_to_metrics</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;columns_to_metrics&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                         <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                             <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable columns_to_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">columns_to_metrics</span><span class="p">))</span>
        <span class="n">info_file_in_archive_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;info_file_in_archive&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">info_file_in_archive_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">info_file_in_archive</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable info_file_in_archive - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_file_in_archive</span><span class="p">))</span>

        <span class="n">info_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Check if the POST request has the data_file part</span>
        <span class="n">no_data_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;data_file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">no_data_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no data_file in the POST&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;data_file&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">data_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data_file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: blank data_file variable&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">no_data_file</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">no_data_file</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                         <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                             <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

        <span class="n">create_info_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">info_file_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;skip_rows&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;skip_rows&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">skip_rows</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">skip_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;skip_rows&#39;</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;skip_row must be none or int&#39;</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                                 <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                                     <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable skip_rows - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">skip_rows</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;columns_to_ignore&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">columns_to_ignore</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;columns_to_ignore&#39;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable columns_to_ignore - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">columns_to_ignore</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;columns_to_process&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">columns_to_process</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;columns_to_process&#39;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable columns_to_process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">columns_to_process</span><span class="p">))</span>
        <span class="n">resample_method</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;resample_method&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">resample_method_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;resample_method&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">resample_method_str</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
                <span class="n">resample_method</span> <span class="o">=</span> <span class="s1">&#39;sum&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable columns_to_process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">columns_to_process</span><span class="p">))</span>
        <span class="c1"># @added 20200521 - Feature #3538: webapp - upload_data endpoint</span>
        <span class="c1">#                   Feature #3550: flux.uploaded_data_worker</span>
        <span class="c1"># Added the ability to ignore_submitted_timestamps and not</span>
        <span class="c1"># check flux.last metric timestamp</span>
        <span class="k">if</span> <span class="s1">&#39;ignore_submitted_timestamps&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">ignore_submitted_timestamps_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ignore_submitted_timestamps&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ignore_submitted_timestamps_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">ignore_submitted_timestamps</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable json_response - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_response</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;info_file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">create_info_file</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;info_file&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">info_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;info_file&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable info_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_file</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">info_file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">create_info_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">create_info_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">create_info_file</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request with no info_file uploaded, attempting to create from variables&#39;</span><span class="p">)</span>
            <span class="n">return_400</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">info_file_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parent_metric_namespace&quot;</span><span class="p">:</span> <span class="n">parent_metric_namespace</span><span class="p">,</span>
                <span class="s2">&quot;timezone&quot;</span><span class="p">:</span> <span class="n">timezone</span><span class="p">,</span>
                <span class="s2">&quot;archive&quot;</span><span class="p">:</span> <span class="n">archive</span><span class="p">,</span>
                <span class="s2">&quot;skip_rows&quot;</span><span class="p">:</span> <span class="n">skip_rows</span><span class="p">,</span>
                <span class="s2">&quot;header_row&quot;</span><span class="p">:</span> <span class="n">header_row</span><span class="p">,</span>
                <span class="s2">&quot;date_orientation&quot;</span><span class="p">:</span> <span class="n">date_orientation</span><span class="p">,</span>
                <span class="s2">&quot;columns_to_metrics&quot;</span><span class="p">:</span> <span class="n">columns_to_metrics</span><span class="p">,</span>
                <span class="s2">&quot;columns_to_ignore&quot;</span><span class="p">:</span> <span class="n">columns_to_ignore</span><span class="p">,</span>
                <span class="s2">&quot;columns_to_process&quot;</span><span class="p">:</span> <span class="n">columns_to_process</span><span class="p">,</span>
                <span class="s2">&quot;info_file_in_archive&quot;</span><span class="p">:</span> <span class="n">info_file_in_archive</span><span class="p">,</span>
                <span class="s2">&quot;resample_method&quot;</span><span class="p">:</span> <span class="n">resample_method</span><span class="p">,</span>
                <span class="s2">&quot;ignore_submitted_timestamps&quot;</span><span class="p">:</span> <span class="n">ignore_submitted_timestamps</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">info_file_saved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">parent_metric_namespace_dirname</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">parent_metric_namespace</span><span class="p">)</span>
        <span class="n">upload_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DATA_UPLOADS_PATH</span><span class="p">,</span> <span class="n">parent_metric_namespace_dirname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="n">upload_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_metric_namespace_dirname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="n">upload_id_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_metric_namespace_dirname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">create_info_file</span><span class="p">:</span>
            <span class="n">info_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;info_file&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">info_file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">info_file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">info_filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">info_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request with info file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_filename</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">):</span>
                        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">)</span>
                    <span class="n">info_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">,</span> <span class="n">info_filename</span><span class="p">))</span>
                    <span class="n">info_file_saved</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request saved info file - </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">upload_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_filename</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to save info file&#39;</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">json_response</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">data_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">data_file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">data_file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">data_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request with data file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_filename</span><span class="p">))</span>
                <span class="c1"># @modified 20200520 - Bug #3552: flux.uploaded_data_worker - tar.gz</span>
                <span class="c1"># tar.gz needs more work</span>
                <span class="k">if</span> <span class="n">data_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;tar.gz&#39;</span><span class="p">):</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error - tar.gz archives are not accepted&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;tar.gz archives are not accepted - </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_file</span><span class="p">))</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                                 <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                                     <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">):</span>
                    <span class="n">mkdir_p</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">)</span>
                <span class="n">data_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">,</span> <span class="n">data_filename</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request saved data file - </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">upload_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_filename</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to save data file&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">json_response</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">info_file_dict</span> <span class="ow">and</span> <span class="n">data_filename</span><span class="p">:</span>
            <span class="n">info_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.info.json&#39;</span> <span class="o">%</span> <span class="n">data_filename</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST creating info file from POST variables - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_filename</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">info_file_in_archive</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request with info_file_in_archive True, but still creating a parent info file from variables&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">):</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">)</span>
            <span class="n">info_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">upload_data_dir</span><span class="p">,</span> <span class="n">info_filename</span><span class="p">)</span>
            <span class="c1"># info_file_data = jsonify(info_file_dict)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">write_data_to_file</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">info_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_file_dict</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST - saved inferred info file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">info_file</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to save inferred info file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">info_file</span><span class="p">)</span>

        <span class="n">upload_data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;parent_metric_namespace&quot;</span><span class="p">:</span> <span class="n">parent_metric_namespace</span><span class="p">,</span>
            <span class="s2">&quot;timezone&quot;</span><span class="p">:</span> <span class="n">timezone</span><span class="p">,</span>
            <span class="s2">&quot;upload_id&quot;</span><span class="p">:</span> <span class="n">upload_id</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span>
            <span class="s2">&quot;archive&quot;</span><span class="p">:</span> <span class="n">archive</span><span class="p">,</span>
            <span class="s2">&quot;data_filename&quot;</span><span class="p">:</span> <span class="n">data_filename</span><span class="p">,</span>
            <span class="s2">&quot;info_filename&quot;</span><span class="p">:</span> <span class="n">info_filename</span><span class="p">,</span>
            <span class="s2">&quot;info_file_in_archive&quot;</span><span class="p">:</span> <span class="n">info_file_in_archive</span><span class="p">,</span>
            <span class="s2">&quot;skip_rows&quot;</span><span class="p">:</span> <span class="n">skip_rows</span><span class="p">,</span>
            <span class="s2">&quot;header_row&quot;</span><span class="p">:</span> <span class="n">header_row</span><span class="p">,</span>
            <span class="s2">&quot;resample_method&quot;</span><span class="p">:</span> <span class="n">resample_method</span><span class="p">,</span>
            <span class="s2">&quot;ignore_submitted_timestamps&quot;</span><span class="p">:</span> <span class="n">ignore_submitted_timestamps</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.uploaded_data&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">upload_data_dict</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not add item to flux.uploaded_data Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">json_response</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">upload_status_redis_key</span> <span class="o">=</span> <span class="s1">&#39;flux.upload_status.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">upload_id_key</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">upload_status_redis_key</span><span class="p">,</span> <span class="mi">2592000</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">upload_data_dict</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added Redis key </span><span class="si">%s</span><span class="s1"> with new status&#39;</span> <span class="o">%</span> <span class="n">upload_status_redis_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not add item to flux.uploaded_data Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">json_response</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span>
                         <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                             <span class="s2">&quot;feature maturity&quot;</span><span class="p">:</span> <span class="s2">&quot;EXPERIMENTAL&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;successful&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;upload_id&quot;</span><span class="p">:</span> <span class="n">upload_id</span><span class="p">,</span>
                             <span class="s2">&quot;upload_id_key&quot;</span><span class="p">:</span> <span class="n">upload_id_key</span><span class="p">,</span>
                             <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
                             <span class="s2">&quot;parent_metric_namespace&quot;</span><span class="p">:</span> <span class="n">parent_metric_namespace</span><span class="p">,</span>
                             <span class="s2">&quot;data file&quot;</span><span class="p">:</span> <span class="n">data_filename</span><span class="p">}}</span>
            <span class="k">if</span> <span class="n">info_file_saved</span><span class="p">:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;info file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_filename</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;responding to upload_data POST request with json response - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">if</span> <span class="n">flux_frontend_request</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;flux_frontend&#39;</span><span class="p">,</span>
                                    <span class="n">parent_metric_namespace</span><span class="o">=</span><span class="n">parent_metric_namespace</span><span class="p">,</span>
                                    <span class="n">data_file_uploaded</span><span class="o">=</span><span class="n">data_filename</span><span class="p">,</span>
                                    <span class="n">info_file_uploaded</span><span class="o">=</span><span class="n">info_filename</span><span class="p">,</span>
                                    <span class="n">upload_id</span><span class="o">=</span><span class="n">upload_id</span><span class="p">,</span>
                                    <span class="n">upload_id_key</span><span class="o">=</span><span class="n">upload_id_key</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span></div>


<span class="c1"># @added 20220403 - Task #4514: Integrate opentelemetry</span>
<span class="c1">#                   Feature #4516: flux - opentelemetry traces</span>
<div class="viewcode-block" id="otel_trace"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.otel_trace">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/otel_trace&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">otel_trace</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">opentelemetry.proto.trace.v1</span> <span class="kn">import</span> <span class="n">trace_pb2</span>
    <span class="kn">from</span> <span class="nn">google.protobuf</span> <span class="kn">import</span> <span class="n">json_format</span> <span class="k">as</span> <span class="n">_json_format</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/otel_trace request&#39;</span><span class="p">)</span>
    <span class="n">all_headers</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">all_headers</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /otel_trace :: req.headers() error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: /otel_trace :: headers - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_headers</span><span class="p">))</span>

    <span class="c1"># TESTING</span>
    <span class="c1"># raw_data = request.get_data()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">traceP</span> <span class="o">=</span> <span class="n">trace_pb2</span><span class="o">.</span><span class="n">TracesData</span><span class="p">()</span>
        <span class="n">traceP</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">())</span>
        <span class="n">trace_dict</span> <span class="o">=</span> <span class="n">_json_format</span><span class="o">.</span><span class="n">MessageToDict</span><span class="p">(</span><span class="n">traceP</span><span class="p">)</span>
        <span class="c1"># write_data_to_file(skyline_app, &#39;/tmp/test.otel_trace&#39;, &#39;wb&#39;, raw_data)</span>
        <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;test.otel.traces&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trace_dict</span><span class="p">))</span>
        <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="s1">&#39;test.otel.traces&#39;</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not write otel_trace data to file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="c1"># logger.info(&#39;otel_trace :: /otel_trace POST raw_data: %s&#39; % str(raw_data))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;otel_trace :: /otel_trace POST done&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="mi">200</span></div>

<span class="c1"># @added 20220413 - Feature #4526: flux - logstash</span>
<div class="viewcode-block" id="logstash_test"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.logstash_test">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/logstash_test&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">logstash_test</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/logstash_test request&#39;</span><span class="p">)</span>
    <span class="n">all_headers</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">all_headers</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /logstash_test :: req.headers() error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: /logstash_test :: headers - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_headers</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># raw_data = request.get_data()</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
        <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;test.logstash&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">))</span>
        <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="s1">&#39;test.logstash&#39;</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not write logstash_test data to Redis hash test.logstash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/logstash_test POST done&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="mi">200</span></div>


<span class="c1"># @added 20201212 - Feature #3880: webapp - utilities - match_metric</span>
<div class="viewcode-block" id="match_metric"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.match_metric">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/match_metric&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">match_metric</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/match_metric request&#39;</span><span class="p">)</span>

    <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">settings_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">use_settings_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">match_with</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: not a POST requests, returning 400&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span> <span class="mi">405</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling match_metric POST request&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_settings</span><span class="p">(</span><span class="n">settings_string</span><span class="p">):</span>
            <span class="c1"># return getattr(sys.modules[&#39;settings&#39;], settings_string)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">],</span> <span class="n">settings_string</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: handling match_metric, getattr failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling match_metric POST with variable metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling match_metric, return 400 no metric&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;settings_list&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">settings_list</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;settings_list&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling match_metric POST with variable settings_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings_list</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings_list</span><span class="p">:</span>
            <span class="n">settings_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">settings_list</span><span class="p">:</span>
            <span class="n">use_settings_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">use_settings_list</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">settings_list</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not interpolate settings_list - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">settings_list</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_settings_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;match_with&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                <span class="n">match_with</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;match_with&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">match_with</span><span class="p">:</span>
                    <span class="n">match_with</span> <span class="o">=</span> <span class="n">match_with</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling match_metric POST with variable match_with - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_with</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">metric</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_settings_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match_with</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling match_metric, return 400 no settings_list or match_with&#39;</span><span class="p">)</span>
                    <span class="c1"># return &#39;Bad request&#39;, 400</span>
                    <span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics_match&quot;</span><span class="p">:</span> <span class="s2">&quot;fail&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s1">&#39;no settings_list attribute for match_with to compare with&#39;</span><span class="p">}}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="n">status_code</span>

        <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_settings_list</span><span class="p">:</span>
                <span class="n">pattern_match</span><span class="p">,</span> <span class="n">matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">use_settings_list</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_settings_list</span> <span class="ow">and</span> <span class="n">match_with</span><span class="p">:</span>
                <span class="n">pattern_match</span><span class="p">,</span> <span class="n">matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="p">[</span><span class="n">match_with</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not determine if metric matched - error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pattern_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling match_metric, pattern_match is None, return 400&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;utilities.html&#39;</span><span class="p">,</span> <span class="n">match_metric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                <span class="n">settings_list</span><span class="o">=</span><span class="n">settings_list</span><span class="p">,</span> <span class="n">match_with</span><span class="o">=</span><span class="n">match_with</span><span class="p">,</span>
                <span class="n">pattern_match</span><span class="o">=</span><span class="n">pattern_match</span><span class="p">,</span> <span class="n">matched_by</span><span class="o">=</span><span class="n">matched_by</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not render_template utilities.html - error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span></div>


<span class="c1"># @added 20210604 - Branch #1444: thunder</span>
<div class="viewcode-block" id="thunder_test"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.thunder_test">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/thunder_test&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">thunder_test</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/thunder_test request&#39;</span><span class="p">)</span>

    <span class="n">thunder_test_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stale_period</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">expiry</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stale_count</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">thunder_no_data_test</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">thunder_stale_metrics_test</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">thunder_no_data_test_key_added</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">thunder_stale_metrics_test_key_added</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: not a POST requests, returning 405&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span> <span class="mi">405</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling thunder_test POST request&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;thunder_test_type&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">thunder_test_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;thunder_test_type&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling thunder_test POST with variable thunder_test - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">thunder_test_type</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thunder_test_type</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling thunder_test, return 400 no thunder_test&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;namespace&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling thunder_test POST with variable namespace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling thunder_test, return 400 no namespace&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;stale_period&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">stale_period</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;stale_period&#39;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling thunder_test POST with variable stale_period - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">stale_period</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stale_period</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stale_period</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling thunder_test, return 400 no stale_period&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;stale_count&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">stale_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;stale_count&#39;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling stale_count POST with variable stale_count - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">stale_count</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stale_count</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stale_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling thunder_test, return 400 no stale_count&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;expiry&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">expiry</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling thunder_test POST with variable expiry - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expiry</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expiry</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expiry</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling thunder_test, return 400 no expiry&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="n">thunder_test_type</span> <span class="o">==</span> <span class="s1">&#39;no_data&#39;</span><span class="p">:</span>
            <span class="n">thunder_test_alert_key</span> <span class="o">=</span> <span class="s1">&#39;thunder.test.alert.no_data.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">namespace</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stale_period&#39;</span><span class="p">:</span> <span class="n">stale_period</span><span class="p">,</span> <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="n">expiry</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">thunder_test_type</span> <span class="o">==</span> <span class="s1">&#39;stale_metrics&#39;</span><span class="p">:</span>
            <span class="n">thunder_test_alert_key</span> <span class="o">=</span> <span class="s1">&#39;thunder.test.alert.stale_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">namespace</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stale_count&#39;</span><span class="p">:</span> <span class="n">stale_count</span><span class="p">,</span> <span class="s1">&#39;stale_period&#39;</span><span class="p">:</span> <span class="n">stale_period</span><span class="p">,</span> <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="n">expiry</span><span class="p">}</span>

        <span class="n">thunder_test_key_added</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thunder_test_key_added</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">thunder_test_alert_key</span><span class="p">,</span> <span class="n">expiry</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">thunder_test_key_added</span><span class="p">:</span>
                <span class="n">thunder_test_key_added</span> <span class="o">=</span> <span class="n">thunder_test_alert_key</span>
                <span class="k">if</span> <span class="n">thunder_test_type</span> <span class="o">==</span> <span class="s1">&#39;no_data&#39;</span><span class="p">:</span>
                    <span class="n">thunder_no_data_test_key_added</span> <span class="o">=</span> <span class="n">thunder_test_alert_key</span>
                    <span class="n">thunder_no_data_test</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">thunder_test_type</span> <span class="o">==</span> <span class="s1">&#39;stale_metrics&#39;</span><span class="p">:</span>
                    <span class="n">thunder_stale_metrics_test_key_added</span> <span class="o">=</span> <span class="n">thunder_test_alert_key</span>
                    <span class="n">thunder_stale_metrics_test</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">thunder_test_alert_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not add Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thunder_test_alert_key</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;utilities.html&#39;</span><span class="p">,</span> <span class="n">match_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">thunder_testing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">thunder_no_data_test</span><span class="o">=</span><span class="n">thunder_no_data_test</span><span class="p">,</span>
                <span class="n">thunder_no_data_test_key_added</span><span class="o">=</span><span class="n">thunder_no_data_test_key_added</span><span class="p">,</span>
                <span class="n">thunder_stale_metrics_test</span><span class="o">=</span><span class="n">thunder_stale_metrics_test</span><span class="p">,</span>
                <span class="n">thunder_stale_metrics_test_key_added</span><span class="o">=</span><span class="n">thunder_stale_metrics_test_key_added</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not render_template utilities.html - error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span></div>


<span class="c1"># @added 20220114 - Feature #4376: webapp - update_external_settings</span>
<div class="viewcode-block" id="update_external_settings"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.update_external_settings">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/update_external_settings&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">update_external_settings</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">start_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/update_external_settings&#39;</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: not a POST requests, returning 405&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span> <span class="mi">405</span>
    <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_external_settings - no POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_external_settings, return 400 no POST data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;cluster_data&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_external_settings - evaluation of  post_data[</span><span class="se">\&#39;</span><span class="s1">data</span><span class="se">\&#39;</span><span class="s1">][</span><span class="se">\&#39;</span><span class="s1">cluster_data</span><span class="se">\&#39;</span><span class="s1">] failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_external_settings, return 400 no key&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SELF_API_KEY</span><span class="p">:</span>
        <span class="n">bad_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_external_settings, return 401 bad key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bad_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_SETTINGS</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">request_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start_timer</span><span class="p">)</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;update_external_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">request_time</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;external_settings&quot;</span><span class="p">:</span> <span class="s1">&#39;no EXTERNAL_SETTINGS configured nothing to update&#39;</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="n">status_code</span>

    <span class="c1"># @added 20230531 - TEMPORARY DISABLED ON STAGE</span>
    <span class="c1"># anomify API calling every minute</span>
<span class="c1">#    end = timer()</span>
<span class="c1">#    request_time = (end - start_timer)</span>
<span class="c1">#    status_code = 200</span>
<span class="c1">#    data_dict = {&quot;status&quot;: {&quot;update_external_settings&quot;: &quot;success&quot;, &quot;response&quot;: 200, &quot;request_time&quot;: request_time}, &quot;data&quot;: {&quot;updated&quot;: True, &quot;external_settings&quot;: &#39;temporarily unavailable due to maintainance&#39;}}</span>
<span class="c1">#    return jsonify(data_dict), status_code</span>

    <span class="n">external_settings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">external_from_cache</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">remote_external_settings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># if key:</span>
    <span class="c1">#     if settings.EXTERNAL_SETTINGS:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_external_settings - managing external_settings&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">external_settings</span><span class="p">,</span> <span class="n">external_from_cache</span> <span class="o">=</span> <span class="n">manage_external_settings</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_external_settings - fetch_external_settings failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">err</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">external_settings</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;update_external_settings - </span><span class="si">%s</span><span class="s1"> external_settings from cache </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">external_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()))),</span> <span class="nb">str</span><span class="p">(</span><span class="n">external_from_cache</span><span class="p">)))</span>
        <span class="c1"># @added 20220117 - Feature #4324: flux - reload external_settings</span>
        <span class="c1">#                   Feature #4376: webapp - update_external_settings</span>
        <span class="n">flux_pid_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/flux.pid&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PID_PATH</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">flux_pid_file</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings.update.flux&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added Redis key skyline.external_settings.update.flux&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_external_settings - failed to create Redis key skyline.external_settings.update.flux&#39;</span><span class="p">)</span>

            <span class="c1"># @modified 20220128 - Feature #4400: flux - quota</span>
            <span class="c1">#                      Feature #4324: flux - reload external_settings</span>
            <span class="c1">#                      Feature #4376: webapp - update_external_settings</span>
            <span class="c1"># Reload flux from metrics_manager as the flux aggregation and quota</span>
            <span class="c1"># keys need to be updated.</span>
            <span class="c1"># logger.info(&#39;initiating reload_flux&#39;)</span>
            <span class="c1"># try:</span>
            <span class="c1">#     flux_pids = reload_flux(skyline_app, flux_pid_file)</span>
            <span class="c1">#     if flux_pids:</span>
            <span class="c1">#         logger.info(&#39;update_external_settings - reload_flux reports %s flux pids&#39; % str(len(flux_pids)))</span>
            <span class="c1"># except Exception as err:</span>
            <span class="c1">#     logger.error(&#39;error :: update_external_settings - reload_flux error - %s&#39; % err)</span>

            <span class="c1"># @added 20220128 - Feature #4400: flux - quota</span>
            <span class="c1">#                   Feature #4324: flux - reload external_settings</span>
            <span class="c1">#                   Feature #4376: webapp - update_external_settings</span>
            <span class="c1"># Set key to inform metrics_manager to update</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings.update.metrics_manager&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added Redis key skyline.external_settings.update.metrics_manager&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: update_external_settings - failed to create Redis key skyline.external_settings.update.flux&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
        <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">cluster_data</span><span class="p">:</span>
        <span class="n">endpoint_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;api_endpoint&#39;</span><span class="p">:</span> <span class="s1">&#39;update_external_settings&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data_required&#39;</span><span class="p">:</span> <span class="s1">&#39;updated&#39;</span><span class="p">,</span>
            <span class="s1">&#39;only_host&#39;</span><span class="p">:</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="s1">&#39;post_data&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
                    <span class="s1">&#39;cluster_data&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;cluster_call&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remote_external_settings</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;update_external_settings&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="n">only_host</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">endpoint_params</span><span class="o">=</span><span class="n">endpoint_params</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: webapp could not get update_external_settings from the remote Skyline instances&#39;</span><span class="p">)</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">request_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start_timer</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">external_settings</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;update_external_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">request_time</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;update_external_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">request_time</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;external_settings&quot;</span><span class="p">:</span> <span class="n">external_settings</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="n">status_code</span>
    <span class="k">if</span> <span class="n">external_settings</span> <span class="ow">and</span> <span class="n">remote_external_settings</span><span class="p">:</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;update_external_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">request_time</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;remote_external_settings&quot;</span><span class="p">:</span> <span class="n">remote_external_settings</span><span class="p">}}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;update_external_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">request_time</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;remote_external_settings&quot;</span><span class="p">:</span> <span class="n">remote_external_settings</span><span class="p">}}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="n">status_code</span></div>


<span class="c1"># @added 20220224 - Feature #4468: flux - remove_namespace_quota_metrics</span>
<span class="c1">#                   Feature #4464: flux - quota - cluster_sync</span>
<div class="viewcode-block" id="remove_namespace_quota"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.remove_namespace_quota">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/remove_namespace_quota_metrics&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">remove_namespace_quota</span><span class="p">():</span>
    <span class="n">start_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/remove_namespace_quota_metrics&#39;</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: not a POST requests, returning 405&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span> <span class="mi">405</span>

    <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dry_run</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># @added 20230322 - Feature #4468: flux - remove_namespace_quota_metrics</span>
    <span class="c1">#                   Feature #4464: flux - quota - cluster_sync</span>
    <span class="c1"># Allow for the namespace prefix to be removed</span>
    <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Test whether form or json POST</span>
    <span class="n">form_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cluster_data_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;cluster_data&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cluster_data_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">dry_run_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;dry_run&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dry_run_str</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
            <span class="n">dry_run</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">dry_run_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">dry_run</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">form_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, form POST&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, cluster_data: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cluster_data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, dry_run: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dry_run</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/remove_namespace_quota_metrics no form data trying json&#39;</span><span class="p">)</span>

    <span class="n">post_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">form_data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: remove_namespace_quota_metrics - no POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, return 400 no POST data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;cluster_data&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cluster_data</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics - cluster_data passed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: remove_namespace_quota_metrics - evaluation of  post_data[</span><span class="se">\&#39;</span><span class="s1">data</span><span class="se">\&#39;</span><span class="s1">][</span><span class="se">\&#39;</span><span class="s1">cluster_data</span><span class="se">\&#39;</span><span class="s1">] failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, return 400 no key&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SELF_API_KEY</span><span class="p">:</span>
            <span class="n">bad_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, return 401 bad key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bad_key</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>
        <span class="c1"># @added 20230322 - Feature #4468: flux - remove_namespace_quota_metrics</span>
        <span class="c1">#                   Feature #4464: flux - quota - cluster_sync</span>
        <span class="c1"># Allow for the namespace prefix to be removed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remove_prefix</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;remove_prefix&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="n">parent_namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;parent_namespace&#39;</span><span class="p">]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SELF_API_KEY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_namespace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;parent_namespace&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">parent_namespace</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics - parent_namespace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">parent_namespace</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">parent_namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_namespace</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, return 400 no parent_namespace&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
    <span class="c1"># This prevents the removal of metrics arbitarily, 400 if not flux quota</span>
    <span class="n">flux_quota</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">flux_quota_str</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">,</span> <span class="n">parent_namespace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flux_quota_str</span><span class="p">:</span>
            <span class="n">flux_quota</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">flux_quota_str</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: remove_namespace_quota_metrics :: failed to hget </span><span class="si">%s</span><span class="s1"> from metrics_manager.flux.namespace_quotas Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">parent_namespace</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">flux_quota</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, return 400 because there is no flux quota for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">parent_namespace</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>

    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="n">metrics_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: remove_namespace_quota_metrics - metrics is not a list for parent_namespace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">parent_namespace</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics - </span><span class="si">%s</span><span class="s1"> metrics passed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: remove_namespace_quota_metrics - evaluation of  post_data[</span><span class="se">\&#39;</span><span class="s1">data</span><span class="se">\&#39;</span><span class="s1">][</span><span class="se">\&#39;</span><span class="s1">metrics</span><span class="se">\&#39;</span><span class="s1">] failed for parent_namespace </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">parent_namespace</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
    <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="n">patterns_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;patterns&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, form_data patterns_str: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">patterns_str</span><span class="p">)</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="n">patterns_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">patterns</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
                <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;patterns&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: remove_namespace_quota_metrics - patterns is not a list for parent_namespace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">parent_namespace</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics - </span><span class="si">%s</span><span class="s1"> patterns passed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">patterns</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: remove_namespace_quota_metrics - evaluation of  post_data[</span><span class="se">\&#39;</span><span class="s1">data</span><span class="se">\&#39;</span><span class="s1">][</span><span class="se">\&#39;</span><span class="s1">patterns</span><span class="se">\&#39;</span><span class="s1">] failed for parent_namespace </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">parent_namespace</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metrics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: remove_namespace_quota_metrics - no metrics or patterns for parent_namespace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">parent_namespace</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="n">dry_run</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;dry_run&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics - DRY RUN - dry_run passed, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dry_run</span><span class="p">))</span>
                <span class="n">dry_run</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">dry_run</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, parent_namespace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_namespace</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, patterns: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">patterns</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics, dry_run: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dry_run</span><span class="p">))</span>

    <span class="n">removed_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">removed_metrics</span> <span class="o">=</span> <span class="n">remove_namespace_quota_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">parent_namespace</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics - got </span><span class="si">%s</span><span class="s1"> removed metrics from remove_namespace_quota_metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">removed_metrics</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: remove_namespace_quota_metrics - remove_namespace_quota_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
        <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">cluster_data</span><span class="p">:</span>
        <span class="n">endpoint_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;api_endpoint&#39;</span><span class="p">:</span> <span class="s1">&#39;/remove_namespace_quota_metrics&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data_required&#39;</span><span class="p">:</span> <span class="s1">&#39;metrics&#39;</span><span class="p">,</span>
            <span class="s1">&#39;only_host&#39;</span><span class="p">:</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="s1">&#39;post_data&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;cluster_data&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
                    <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">,</span>
                    <span class="s1">&#39;parent_namespace&#39;</span><span class="p">:</span> <span class="n">parent_namespace</span><span class="p">,</span>
                    <span class="s1">&#39;patterns&#39;</span><span class="p">:</span> <span class="n">patterns</span><span class="p">,</span>
                    <span class="s1">&#39;dry_run&#39;</span><span class="p">:</span> <span class="n">dry_run</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remote_removed_metrics</span> <span class="o">=</span> <span class="n">get_cluster_data</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics&amp;cluster_call=true&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">,</span> <span class="n">only_host</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">endpoint_params</span><span class="o">=</span><span class="n">endpoint_params</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: remove_namespace_quota_metrics - could not get remove_namespace_quota_metrics from the remote Skyline instances&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics - got </span><span class="si">%s</span><span class="s1"> removed metrics from the remote Skyline instances&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_removed_metrics</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">remote_removed_metrics</span><span class="p">:</span>
            <span class="n">removed_metrics</span> <span class="o">=</span> <span class="n">removed_metrics</span> <span class="o">+</span> <span class="n">remote_removed_metrics</span>
            <span class="n">removed_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">removed_metrics</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remove_namespace_quota_metrics - </span><span class="si">%s</span><span class="s1"> removed metrics from parent_namespace </span><span class="si">%s</span><span class="s1"> quota metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">removed_metrics</span><span class="p">)),</span> <span class="n">parent_namespace</span><span class="p">))</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">request_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start_timer</span><span class="p">)</span>

    <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;webapp.remove_namespace_quota_metrics.</span><span class="si">%s</span><span class="s1">.removed_metrics&#39;</span> <span class="o">%</span> <span class="n">parent_namespace</span>
    <span class="k">if</span> <span class="n">removed_metrics</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">removed_metrics</span><span class="p">))</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;remove_namespace_quota_metrics :: could not add removed_metrics to Redis set </span><span class="si">%s</span><span class="s1"> - error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">redis_set</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/remove_namespace_quota_metrics took </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_time</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">form_data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;utilities.html&#39;</span><span class="p">,</span> <span class="n">remove_flux_namespace_quota_metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span> <span class="n">removed_quota_metrics_key</span><span class="o">=</span><span class="n">redis_set</span><span class="p">,</span>
                <span class="n">removed_quota_metrics</span><span class="o">=</span><span class="n">removed_metrics</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not render_template utilities.html - error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="c1"># @added 20230322 - Feature #4468: flux - remove_namespace_quota_metrics</span>
    <span class="c1">#                   Feature #4464: flux - quota - cluster_sync</span>
    <span class="c1"># Allow for the namespace prefix to be removed</span>
    <span class="k">if</span> <span class="n">remove_prefix</span><span class="p">:</span>
        <span class="n">remove_prefix_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">)</span>
        <span class="n">stripped_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">removed_metrics</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">remove_prefix_str</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">stripped_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="n">removed_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stripped_metrics</span><span class="p">)</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">request_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start_timer</span><span class="p">)</span>
    <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;remove_namespace_quota_metrics&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">request_time</span><span class="p">,</span>
            <span class="s2">&quot;dry_run&quot;</span><span class="p">:</span> <span class="n">dry_run</span>
        <span class="p">},</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">removed_metrics</span><span class="p">,</span>
            <span class="s2">&quot;removed_metrics_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">removed_metrics</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="n">status_code</span></div>

<span class="c1"># @added 20230605 - Feature #4932: mute_alerts_on</span>
<div class="viewcode-block" id="mute_alerts_on"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.mute_alerts_on">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/mute_alerts_on&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">mute_alerts_on</span><span class="p">():</span>
    <span class="n">start_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/mute_alerts_on&#39;</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">return_error</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">error_reason</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: not a POST requests, returning 405&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span> <span class="mi">405</span>

    <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Test whether form or json POST</span>
    <span class="n">form_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cluster_data_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;cluster_data&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cluster_data_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">form_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on, form POST&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on, cluster_data: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cluster_data</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/mute_alerts_on no form data trying json&#39;</span><span class="p">)</span>

    <span class="n">post_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">form_data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mute_alerts_on - no POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on, return 400 no POST data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;cluster_data&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cluster_data</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on - cluster_data passed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mute_alerts_on - evaluation of  post_data[</span><span class="se">\&#39;</span><span class="s1">data</span><span class="se">\&#39;</span><span class="s1">][</span><span class="se">\&#39;</span><span class="s1">cluster_data</span><span class="se">\&#39;</span><span class="s1">] failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on, return 400 no key&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SELF_API_KEY</span><span class="p">:</span>
            <span class="n">bad_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on, return 401 bad key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bad_key</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>
        <span class="c1"># @added 20230322 - Feature #4468: flux - remove_namespace_quota_metrics</span>
        <span class="c1">#                   Feature #4464: flux - quota - cluster_sync</span>
        <span class="c1"># Allow for the namespace prefix to be removed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remove_prefix</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;remove_prefix&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SELF_API_KEY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">namespace</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on - namespace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">namespace</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">namespace</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="n">separator</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;separator&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">separator</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;separator&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>

    <span class="n">metric_patterns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="n">metric_patterns_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;metric_patterns&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on, form_data metric_patterns: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_patterns_str</span><span class="p">)</span>
            <span class="n">metric_patterns</span> <span class="o">=</span> <span class="n">metric_patterns_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric_patterns</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
                <span class="n">metric_patterns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">metric_patterns</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">metric_patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metric_patterns</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;metric_patterns&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">metric_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_patterns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mute_alerts_on - metric_patterns is not a list for namespace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">namespace</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on - </span><span class="si">%s</span><span class="s1"> metric_patterns passed&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_patterns</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">metric_patterns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">metric_patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mute_alerts_on - evaluation of  post_data[</span><span class="se">\&#39;</span><span class="s1">data</span><span class="se">\&#39;</span><span class="s1">][</span><span class="se">\&#39;</span><span class="s1">metric_patterns</span><span class="se">\&#39;</span><span class="s1">] failed for namespace </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">namespace</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Bad request&#39;</span><span class="p">,</span> <span class="mi">400</span>
    <span class="n">list_muted_metrics</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="n">list_muted_metrics</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;list_muted_metrics&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">list_muted_metrics</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">list_muted_metrics</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">list_muted_metrics</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">list_muted_metrics</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">list_muted_metrics</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;list_muted_metrics&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">list_muted_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on - list_muted_metrics passed, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">list_muted_metrics</span><span class="p">))</span>
                <span class="n">list_muted_metrics</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">list_muted_metrics</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_patterns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">list_muted_metrics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">namespace</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mute_alerts_on - no metric_patterns or list_muted_metrics or namespace passed to filter on&#39;</span><span class="p">)</span>
        <span class="n">return_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">error_reason</span> <span class="o">=</span> <span class="s1">&#39;no namespace or metric_patterns passed to filter on&#39;</span>

    <span class="n">expiry</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="n">expiry</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expiry</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">expiry</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on - expiry passed, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">expiry</span><span class="p">))</span>
            <span class="n">expiry</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">expiry</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">expiry</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">output_format</span> <span class="o">=</span> <span class="s1">&#39;html&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="n">output_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_format</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">output_format</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>

    <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="n">remove_prefix</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;remove_prefix&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remove_prefix</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;remove_prefix&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">remove_prefix</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">remove_prefix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on, namespace: </span><span class="si">%s</span><span class="s1">, metric_patterns: </span><span class="si">%s</span><span class="s1">, separator: </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, expiry: </span><span class="si">%s</span><span class="s1">, list_muted_metrics: </span><span class="si">%s</span><span class="s1">, remove_prefix: </span><span class="si">%s</span><span class="s1">, format: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_patterns</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">separator</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">expiry</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">list_muted_metrics</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_format</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">list_muted_metrics</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric_patterns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_error</span><span class="p">:</span>
            <span class="n">return_error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">error_reason</span> <span class="o">=</span> <span class="s1">&#39;no namespace or metric_patterns passed to filter on&#39;</span>
        <span class="k">if</span> <span class="n">namespace</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">expiry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_error</span><span class="p">:</span>
            <span class="n">return_error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">error_reason</span> <span class="o">=</span> <span class="s1">&#39;no expiry passed&#39;</span>
        <span class="k">if</span> <span class="n">metric_patterns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">expiry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_error</span><span class="p">:</span>
            <span class="n">return_error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">error_reason</span> <span class="o">=</span> <span class="s1">&#39;no expiry passed&#39;</span>
    <span class="k">if</span> <span class="n">return_error</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;mute_alerts_on&quot;</span><span class="p">:</span> <span class="s2">&quot;fail&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Bad request&quot;</span><span class="p">,</span> <span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> 
            <span class="p">},</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">error_reason</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

    <span class="n">muted_metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">muted_metrics</span> <span class="o">=</span> <span class="n">api_mute_alerts_on</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">metric_patterns</span><span class="p">,</span> <span class="n">expiry</span><span class="p">,</span> <span class="n">list_muted_metrics</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mute_alerts_on - got </span><span class="si">%s</span><span class="s1"> muted metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">muted_metrics</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mute_alerts_on - api_mute_alerts_on failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">request_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start_timer</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/mute_alerts_on took </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_time</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">form_data</span> <span class="ow">and</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;utilities.html&#39;</span><span class="p">,</span> <span class="n">mute_alerts_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">metrics_muted</span><span class="o">=</span><span class="n">muted_metrics</span><span class="p">,</span> <span class="n">muted_alerts_on</span><span class="o">=</span><span class="n">muted_metrics</span><span class="p">,</span>
                <span class="n">list_muted_metrics</span><span class="o">=</span><span class="n">list_muted_metrics</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
                <span class="n">metric_patterns</span><span class="o">=</span><span class="n">metric_patterns</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not render_template utilities.html - error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="c1"># Allow for the namespace prefix to be removed</span>
    <span class="k">if</span> <span class="n">remove_prefix</span><span class="p">:</span>
        <span class="n">remove_prefix_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">remove_prefix</span><span class="p">)</span>
        <span class="n">stripped_muted_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">muted_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">stripped_metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">remove_prefix_str</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">stripped_muted_metrics</span><span class="p">[</span><span class="n">stripped_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">muted_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
        <span class="n">muted_metrics</span> <span class="o">=</span> <span class="n">stripped_muted_metrics</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">request_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start_timer</span><span class="p">)</span>
    <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;mute_alerts_on&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">request_time</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">muted_metrics</span><span class="p">,</span>
            <span class="s2">&quot;muted_metrics_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">muted_metrics</span><span class="p">),</span>
            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="n">namespace</span><span class="p">,</span>
            <span class="s2">&quot;metric_patterns&quot;</span><span class="p">:</span> <span class="n">metric_patterns</span><span class="p">,</span>
            <span class="s2">&quot;remove_prefix&quot;</span><span class="p">:</span> <span class="n">remove_prefix</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="n">status_code</span></div>

<span class="c1"># @added 20210316 - Feature #3978: luminosity - classify_metrics</span>
<span class="c1">#                   Feature #3642: Anomaly type classification</span>
<div class="viewcode-block" id="luminosity"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.luminosity">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/luminosity&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">luminosity</span><span class="p">():</span>
    <span class="n">debug_on</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># file_uploads_enabled = True</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/luminosity request&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">LUMINOSITY_REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;classify_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithm&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;significant&#39;</span><span class="p">,</span>
        <span class="s1">&#39;classification&#39;</span><span class="p">,</span> <span class="s1">&#39;classify_metric&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20210825 - Feature #4164: luminosity - cloudbursts</span>
        <span class="s1">&#39;cloudbursts&#39;</span><span class="p">,</span> <span class="s1">&#39;base_name&#39;</span><span class="p">,</span> <span class="s1">&#39;namespaces&#39;</span><span class="p">,</span> <span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;cloudbursts_plot&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_cloudburst&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cloudburst_id&#39;</span><span class="p">,</span> <span class="s1">&#39;all_in_period&#39;</span><span class="p">,</span> <span class="s1">&#39;shift&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20211001 - Feature #4264: luminosity - cross_correlation_relationships</span>
        <span class="s1">&#39;related_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;related_to_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_id&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster_data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;metric_related_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;namespaces&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20230322 - Feature #4874: luminosity - related_metrics - labelled_metrics</span>
        <span class="c1"># Allow related metrics to be returned as json</span>
        <span class="s1">&#39;format&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">classify_metrics</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">algorithm</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="n">significant</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">classification</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">classify_metric</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">request_arguments</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># @added 20210825 - Feature #4164: luminosity - cloudbursts</span>
    <span class="n">cloudbursts_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cloudbursts_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cloudburst_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plot_cloudburst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">cloudbursts_plot</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">cloudburst_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">all_in_period</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># @added 20211001 - Feature #4264: luminosity - cross_correlation_relationships</span>
    <span class="n">related_metrics</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">related_to_metrics</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">metric_related_metrics</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">related_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">related_metrics_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">related_to_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># @added 20230322 - Feature #4874: luminosity - related_metrics - labelled_metrics</span>
    <span class="c1"># Allow related metrics to be returned as json</span>
    <span class="n">use_format</span> <span class="o">=</span> <span class="s1">&#39;html&#39;</span>
 
    <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">request_args_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">classify_metrics</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="mi">86400</span><span class="p">)</span>

    <span class="c1"># IMPORTANT: cluster_data MUST be the first argument that is evaluated as it</span>
    <span class="c1">#            is used and required by many of the following API methods</span>
    <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;cluster_data&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cluster_data_argument</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_data&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cluster_data_argument</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;luminosity request with cluster_data=true&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cluster_data_argument</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">cluster_data</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;luminosity request with cluster_data=false&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: api request with invalid cluster_data argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_data_argument</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /luminosity request with invalid cluster_data argument&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="n">request_args_len</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">classification</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># @added 20211001 - Feature #4264: luminosity - cross_correlation_relationships</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;related_metrics&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">related_metrics</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_related_metrics&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">metric_related_metrics</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;related_to_metrics&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">related_to_metrics</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_id&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;namespaces&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">namespaces_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">namespaces</span> <span class="o">=</span> <span class="n">namespaces_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;filtering on namespaces: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespaces</span><span class="p">))</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="c1"># @added 20230322 - Feature #4874: luminosity - related_metrics - labelled_metrics</span>
            <span class="c1"># Allow related metrics to be returned as json</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span>
                <span class="n">use_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">classification</span><span class="p">:</span>
            <span class="n">algorithm</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">LUMINOSITY_REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">request_arguments</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;classify_metrics&#39;</span><span class="p">:</span>
                <span class="n">classify_metrics</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span>
                <span class="n">algorithm</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;significant&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">significant</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">classification</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;classify_metric&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">classify_metric</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># @added 20210825 - Feature #4164: luminosity - cloudbursts</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;cloudbursts&#39;</span><span class="p">:</span>
                <span class="n">cloudbursts_request</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">namespaces</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;namespaces&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">namespaces</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: TypeError from namespaces parameter&#39;</span><span class="p">)</span>
                        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">]:</span>
                <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># unix timestamp</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># %Y%m%d %H:%M timestamp</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">value_strip_colon</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">value_strip_colon</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;from_timestamp&#39;</span><span class="p">:</span>
                <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">from_timestamp</span><span class="p">:</span>
                    <span class="n">new_from_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_from_timestamp</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">from_timestamp</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">:</span>
                <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">until_timestamp</span><span class="p">:</span>
                    <span class="n">new_until_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_until_timestamp</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">until_timestamp</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;plot_cloudburst&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">plot_cloudburst</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;cloudburst_id&#39;</span><span class="p">:</span>
                <span class="n">cloudburst_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;all_in_period&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">all_in_period</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;shift&#39;</span><span class="p">:</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/luminosity request_arguments: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_arguments</span><span class="p">))</span>

    <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">classify_metrics</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">timestamp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">algorithm</span><span class="p">:</span>
            <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_request</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;classify_metrics&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;required parameter not passed&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;algorithm&quot;</span><span class="p">:</span> <span class="n">algorithm</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="n">status_code</span>
        <span class="k">if</span> <span class="n">request_args_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="mi">86400</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">classification</span> <span class="ow">and</span> <span class="n">valid_request</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">algorithm</span><span class="p">:</span>
            <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_request</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;classification&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;required parameter not passed&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;algorithm&quot;</span><span class="p">:</span> <span class="n">algorithm</span><span class="p">}}</span>

    <span class="c1"># @added 20210825 - Feature #4164: luminosity - cloudbursts</span>
    <span class="k">if</span> <span class="n">cloudbursts_request</span> <span class="ow">and</span> <span class="n">valid_request</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">from_timestamp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">until_timestamp</span><span class="p">:</span>
            <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_request</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cloudbursts&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;required parameter not passed&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;from_timestamp&quot;</span><span class="p">:</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="s2">&quot;until_timestamp&quot;</span><span class="p">:</span> <span class="n">until_timestamp</span><span class="p">}}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_request</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="n">status_code</span>

    <span class="n">classify_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">classified_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">classify_metrics</span> <span class="ow">or</span> <span class="n">classify_metric</span> <span class="ow">or</span> <span class="n">classification</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">classify_metrics_dict</span><span class="p">,</span> <span class="n">classified_metrics</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_classify_metrics</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">significant</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not determine if metric matched - error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">classification</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="ow">and</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">classification</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">classify_metrics</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>

    <span class="n">classification_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">siginificant_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">classify_metrics_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="c1"># classification_count = classify_metrics_dict[metric][algorithm][&#39;classifications&#39;]</span>
            <span class="c1"># siginificant_count = classify_metrics_dict[metric][algorithm][&#39;significant&#39;]</span>
            <span class="k">for</span> <span class="n">current_algorithm</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">classify_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">classification_count</span> <span class="o">+=</span> <span class="n">classify_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">current_algorithm</span><span class="p">][</span><span class="s1">&#39;classifications&#39;</span><span class="p">]</span>
                <span class="n">siginificant_count</span> <span class="o">+=</span> <span class="n">classify_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">current_algorithm</span><span class="p">][</span><span class="s1">&#39;significant&#39;</span><span class="p">]</span>
            <span class="n">classify_metrics</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">classification</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># @added 20210825 - Feature #4164: luminosity - cloudbursts</span>
    <span class="k">if</span> <span class="n">cloudbursts_request</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">from_timestamp</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cloudbursts_dict</span> <span class="o">=</span> <span class="n">get_cloudbursts</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;get_cloudbursts failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cloudbursts_dict</span><span class="p">:</span>
        <span class="n">cloudburst_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cloudbursts_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cloudburst_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cloudbursts_dict</span><span class="p">[</span><span class="n">cloudburst_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;returning </span><span class="si">%s</span><span class="s1"> cloudbursts with cloudburst_keys: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cloudbursts_dict</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">cloudburst_keys</span><span class="p">)))</span>

    <span class="c1"># @added 20210826 - Feature #4164: luminosity - cloudbursts</span>
    <span class="n">cloudburst_plot_image</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cloudburst_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">plot_cloudburst</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cloudburst_dict</span><span class="p">,</span> <span class="n">cloudburst_plot_image</span> <span class="o">=</span> <span class="n">get_cloudburst_plot</span><span class="p">(</span><span class="n">cloudburst_id</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">all_in_period</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;get_cloudbursts failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cloudburst_dict</span><span class="p">:</span>
            <span class="n">cloudburst_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cloudburst_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># @added 20211004 - Feature #4264: luminosity - cross_correlation_relationships</span>
    <span class="k">if</span> <span class="n">related_metrics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_group_info</span> <span class="o">=</span> <span class="n">get_metric_group_info</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;namespaces&#39;</span><span class="p">:</span> <span class="n">namespaces</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">metric_group_info</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">metric_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_group_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">related_metrics_dict</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_group_info</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">related_metrics_keys</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">related_metrics_dict</span><span class="p">[</span><span class="n">metric_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">related_metrics_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;get_cloudbursts failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="n">metric_related_metrics_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">metric_related_metrics</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">full_details</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># @added 20230322 - Feature #4874: luminosity - related_metrics - labelled_metrics</span>
            <span class="c1"># Allow related metrics to be returned as json and to pass a</span>
            <span class="c1"># labelled_metric_name</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">and</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;labelled_metrics.&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="n">get_base_name_from_labelled_metrics_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;related_to_metric request :: get_base_name_from_labelled_metrics_name failed to determine base_name from </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># @added 20230322 - Feature #4874: luminosity - related_metrics - labelled_metrics</span>
                <span class="c1"># Allow related metrics to be returned as json and to pass a</span>
                <span class="c1"># metric_id only or a labelled_metric_name</span>
                <span class="k">if</span> <span class="n">metric_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="n">get_base_name_from_metric_id</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;related_to_metric request :: get_base_name_from_metric_id failed to determine base_name from metric_id: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;related_to_metric request :: get_metric_id_from_base_name failed to determine metric_id from metric: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">metric_related_metrics</span> <span class="o">=</span> <span class="n">get_related_metrics</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">cluster_data</span><span class="p">,</span> <span class="n">full_details</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric_related_metrics</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">related_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_related_metrics</span><span class="p">[</span><span class="s1">&#39;related_metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_related_metrics_keys</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_related_metrics</span><span class="p">[</span><span class="s1">&#39;related_metrics&#39;</span><span class="p">][</span><span class="n">related_metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">metric_related_metrics_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_related_metrics failed to set metric_related_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="c1"># @added 20230322 - Feature #4874: luminosity - related_metrics - labelled_metrics</span>
        <span class="c1"># Allow related metrics to be returned as json</span>
        <span class="k">if</span> <span class="n">use_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_data</span><span class="p">,</span>
                    <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="n">use_format</span><span class="p">,</span>
                    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                    <span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                    <span class="s2">&quot;metric_related_metrics&quot;</span><span class="p">:</span> <span class="n">metric_related_metrics</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20211006 - Feature #4264: luminosity - cross_correlation_relationships</span>
    <span class="n">related_to_metrics_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">related_to_metrics</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request no metric parameter&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_id</span> <span class="o">=</span> <span class="n">get_metric_id_from_base_name</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;related_to_metric request :: get_metric_id_from_base_name failed to determine metric_id from metric: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">related_to_metrics_dict</span> <span class="o">=</span> <span class="n">get_related_to_metric_groups</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_related_to_metric_groups failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">related_to_metrics_dict</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - metric not found&#39;</span> <span class="o">%</span> <span class="n">metric</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">related_to_metrics_dict</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">related_to_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">related_to_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;related_to_metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">related_to_metrics_keys</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">related_to_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;related_to_metrics&#39;</span><span class="p">][</span><span class="n">related_to_metric</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">related_to_metrics_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: related_to_metrics_dict: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">related_to_metrics_dict</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: related_to_metrics_keys: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">related_to_metrics_keys</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;get_related_to_metric_groups output failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">related_to_metrics_dict</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;luminosity.html&#39;</span><span class="p">,</span> <span class="n">classify_metrics</span><span class="o">=</span><span class="n">classify_metrics</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">,</span>
            <span class="n">classify_metrics_dict</span><span class="o">=</span><span class="n">classify_metrics_dict</span><span class="p">,</span>
            <span class="n">classification_count</span><span class="o">=</span><span class="n">classification_count</span><span class="p">,</span>
            <span class="n">siginificant_count</span><span class="o">=</span><span class="n">siginificant_count</span><span class="p">,</span>
            <span class="n">classified_metrics</span><span class="o">=</span><span class="n">classified_metrics</span><span class="p">,</span>
            <span class="n">classification</span><span class="o">=</span><span class="n">classification</span><span class="p">,</span>
            <span class="n">classify_metric</span><span class="o">=</span><span class="n">classify_metric</span><span class="p">,</span>
            <span class="c1"># @added 20210825 - Feature #4164: luminosity - cloudbursts</span>
            <span class="n">cloudbursts</span><span class="o">=</span><span class="n">cloudbursts_request</span><span class="p">,</span> <span class="n">cloudbursts_dict</span><span class="o">=</span><span class="n">cloudbursts_dict</span><span class="p">,</span>
            <span class="n">cloudburst_keys</span><span class="o">=</span><span class="n">cloudburst_keys</span><span class="p">,</span> <span class="n">plot_cloudburst</span><span class="o">=</span><span class="n">plot_cloudburst</span><span class="p">,</span>
            <span class="n">cloudburst_plot_image</span><span class="o">=</span><span class="n">cloudburst_plot_image</span><span class="p">,</span>
            <span class="n">cloudburst_id</span><span class="o">=</span><span class="n">cloudburst_id</span><span class="p">,</span> <span class="n">cloudburst_dict</span><span class="o">=</span><span class="n">cloudburst_dict</span><span class="p">,</span>
            <span class="n">all_in_period</span><span class="o">=</span><span class="n">all_in_period</span><span class="p">,</span>
            <span class="n">related_metrics</span><span class="o">=</span><span class="n">related_metrics_dict</span><span class="p">,</span>
            <span class="n">related_metrics_keys</span><span class="o">=</span><span class="n">related_metrics_keys</span><span class="p">,</span>
            <span class="n">metric_related_metrics</span><span class="o">=</span><span class="n">metric_related_metrics</span><span class="p">,</span>
            <span class="n">metric_related_metrics_keys</span><span class="o">=</span><span class="n">metric_related_metrics_keys</span><span class="p">,</span>
            <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">,</span> <span class="n">metric_id</span><span class="o">=</span><span class="n">metric_id</span><span class="p">,</span>
            <span class="n">related_to_metrics</span><span class="o">=</span><span class="n">related_to_metrics_dict</span><span class="p">,</span>
            <span class="n">related_to_metrics_keys</span><span class="o">=</span><span class="n">related_to_metrics_keys</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
            <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span></div>


<span class="c1"># @added 20211102 - Branch #3068: SNAB</span>
<span class="c1">#                   Bug #4308: matrixprofile - fN on big drops</span>
<div class="viewcode-block" id="snab"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.snab">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/snab&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">snab</span><span class="p">():</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/snab request&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">results_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">filter_on</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;algorithm_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">algorithms</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">algorithms</span> <span class="o">=</span> <span class="n">get_algorithms</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /snab :: failed to get algorithms - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

    <span class="n">algorithm_groups</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">algorithm_groups</span> <span class="o">=</span> <span class="n">get_algorithm_groups</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /snab :: failed to get algorithm_groups - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

    <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespaces</span>
    <span class="k">if</span> <span class="s1">&#39;namespaces&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">namespaces_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">namespaces</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespaces&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">namespaces</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">namespaces_list</span> <span class="o">=</span> <span class="n">namespaces</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespaces_list</span>
        <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">algorithm</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">algorithm_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;algorithm_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithm_id</span>
    <span class="k">if</span> <span class="s1">&#39;algorithm&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">algorithm</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;algorithm&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">algorithm</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">algorithm_id</span> <span class="o">=</span> <span class="n">algorithms</span><span class="p">[</span><span class="n">algorithm</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Unknown algorithm - </span><span class="si">%s</span><span class="s1">, no ID found&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">algorithm_id</span><span class="p">:</span>
                <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;algorithm_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithm_id</span>
                <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithm</span>

    <span class="n">algorithm_group</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">algorithm_group_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;algorithm_group_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithm_group_id</span>
    <span class="k">if</span> <span class="s1">&#39;algorithm_group&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">algorithm_group</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;algorithm_group&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">algorithm_group</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">algorithm_group_id</span> <span class="o">=</span> <span class="n">algorithm_groups</span><span class="p">[</span><span class="n">algorithm_group</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Unknown algorithm_group - </span><span class="si">%s</span><span class="s1">, no ID found&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">algorithm_group</span><span class="p">)</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">algorithm_group_id</span><span class="p">:</span>
                <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;algorithm_group_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithm_group_id</span>
                <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;algorithm_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithm_group</span>

    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_timestamp</span>
    <span class="k">if</span> <span class="s1">&#39;from_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">from_timestamp</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">from_timestamp</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_from_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: /snab :: failed to unix timestamp from from_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_from_timestamp</span><span class="p">)</span>
            <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">from_timestamp</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: /snab :: no from_timestamp parameter was passed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="s1">&#39;until_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">until_timestamp</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">until_timestamp</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_until_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: snab :: failed to unix timestamp from until_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_until_timestamp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">until_timestamp</span><span class="p">:</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">if</span> <span class="s1">&#39;result&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tP&#39;</span><span class="p">,</span> <span class="s1">&#39;fP&#39;</span><span class="p">,</span> <span class="s1">&#39;fN&#39;</span><span class="p">,</span> <span class="s1">&#39;tN&#39;</span><span class="p">,</span> <span class="s1">&#39;unsure&#39;</span><span class="p">]:</span>
            <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">plot_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">filter_on</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results_data</span> <span class="o">=</span> <span class="n">get_snab_results</span><span class="p">(</span><span class="n">filter_on</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: snab :: failed to unix timestamp from until_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
    <span class="n">results_data_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">do_not_use_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;runtime&#39;</span><span class="p">,</span> <span class="s1">&#39;app_id&#39;</span><span class="p">,</span> <span class="s1">&#39;snab_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;slack_thread_ts&#39;</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">results_data</span><span class="p">:</span>
        <span class="n">snab_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_data</span><span class="p">[</span><span class="n">snab_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">do_not_use_keys</span><span class="p">:</span>
                <span class="n">results_data_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;snab.html&#39;</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="n">algorithms</span><span class="p">,</span>
            <span class="n">algorithm_groups</span><span class="o">=</span><span class="n">algorithm_groups</span><span class="p">,</span>
            <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="o">=</span><span class="n">from_timestamp</span><span class="p">,</span>
            <span class="n">until_timestamp</span><span class="o">=</span><span class="n">until_timestamp</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
            <span class="n">results_data</span><span class="o">=</span><span class="n">results_data</span><span class="p">,</span> <span class="n">results_data_keys</span><span class="o">=</span><span class="n">results_data_keys</span><span class="p">,</span>
            <span class="n">filter_on</span><span class="o">=</span><span class="n">filter_on</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span></div>


<span class="c1"># @added 20210612 - Branch #1444: thunder</span>
<div class="viewcode-block" id="webapp_up"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.webapp_up">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/webapp_up&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">webapp_up</span><span class="p">():</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/webapp_up request&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">thunder_key_set</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">thunder_key_set</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;webapp&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added Redis key webapp&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not add item to flux.uploaded_data Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">request_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">thunder_key_set</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">request_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;up&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;request_time&quot;</span><span class="p">:</span> <span class="n">request_time</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;up&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">404</span></div>


<div class="viewcode-block" id="get_prometheus_scrape_metrics"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.get_prometheus_scrape_metrics">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/metrics&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_prometheus_scrape_metrics</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expose Prometheus-like metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/metrics request&#39;</span><span class="p">)</span>
    <span class="n">scrape_response</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">scrape_response</span> <span class="o">=</span> <span class="n">expose_metrics</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/metrics request expose_metrics called&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;expose_metrics failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scrape_response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scrape_response</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span> <span class="mi">404</span></div>


<span class="c1"># @added 20221204 - Feature #4754: csv_to_timeseries</span>
<span class="c1">#                   Feature #4734: mirage_vortex</span>
<span class="c1">#                   Branch #4728: vortex</span>
<div class="viewcode-block" id="csv_to_timeseries_data"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.csv_to_timeseries_data">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/csv_to_timeseries&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">csv_to_timeseries_data</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/csv_to_timeseries request&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_uploads_enabled</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span> <span class="mi">404</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: not a POST requests, returning 400&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span> <span class="mi">405</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling csv_to_timeseries POST request&#39;</span><span class="p">)</span>
    <span class="c1"># If there is no key a 401 is returned with no info</span>
    <span class="k">if</span> <span class="s1">&#39;key&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;no key in the POST variables&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
    <span class="n">known_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">temporary_upload_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">redis_temporary_upload_key</span> <span class="o">=</span> <span class="s1">&#39;csv_to_timeseries.tmp.temporary_upload_key.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">api_key</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">temporary_upload_key</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_temporary_upload_key</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got temporary_upload_key from Redis&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not get Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_temporary_upload_key</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">api_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">flux_upload_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="n">api_key</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SELF_API_KEY</span> <span class="ow">or</span> <span class="n">temporary_upload_key</span><span class="p">:</span>
        <span class="n">known_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling csv_to_timeseries - key valid&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">known_key</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: unknown key passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>
    <span class="n">data_filename</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">no_data_file</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;data_file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="n">no_data_file</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no data_file in the POST&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;data_file&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="n">data_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data_file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: blank data_file variable&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
            <span class="n">no_data_file</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">no_data_file</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;timeseries&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

    <span class="n">data_filename</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">saved_csv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">data_file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">data_file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">data_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling csv_to_timeseries POST request with data file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_filename</span><span class="p">))</span>
            <span class="n">saved_csv</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_TMP_DIR</span><span class="p">,</span> <span class="n">data_filename</span><span class="p">)</span>
            <span class="n">data_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">saved_csv</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling csv_to_timeseries POST request saved data file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">saved_csv</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to save data file&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">saved_csv</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: handling csv_to_timeseries POST no saved_csv&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">saved_csv</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: handling csv_to_timeseries POST no saved_csv - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">saved_csv</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">csv_to_timeseries</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">saved_csv</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: csv_to_timeseries failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">saved_csv</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling csv_to_timeseries removed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">saved_csv</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: csv_to_timeseries failed to remove </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">saved_csv</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;succes&quot;</span><span class="p">:</span> <span class="n">success</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;timeseries&quot;</span><span class="p">:</span> <span class="n">timeseries</span><span class="p">}}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span> <span class="ow">and</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">][</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;timeseries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span></div>


<span class="c1"># @added 20221210 - Feature #4734: mirage_vortex</span>
<span class="c1">#                   Branch #4728: vortex</span>
<div class="viewcode-block" id="vortex"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.vortex">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/vortex&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">vortex</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/vortex request&#39;</span><span class="p">)</span>
    <span class="n">run_algorithms</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">metric</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">vortex_request</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;json_output&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="mi">200</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;vortex.html&#39;</span><span class="p">,</span> <span class="n">vortex_algorithms</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_ALGORITHMS</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span></div>


<span class="c1"># @added 20160703 - Feature #1464: Webapp Redis browser</span>
<span class="c1"># A port of Marian Steinbach&#39;s rebrow - https://github.com/marians/rebrow</span>
<span class="c1"># Description of info keys</span>
<span class="c1"># TODO: to be continued.</span>
<span class="n">serverinfo_meta</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;aof_current_rewrite_time_sec&#39;</span><span class="p">:</span> <span class="s2">&quot;Duration of the on-going &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; rewrite operation if any&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_enabled&#39;</span><span class="p">:</span> <span class="s2">&quot;Flag indicating &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; logging is activated&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_last_bgrewrite_status&#39;</span><span class="p">:</span> <span class="s2">&quot;Status of the last &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; rewrite operation&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_last_rewrite_time_sec&#39;</span><span class="p">:</span> <span class="s2">&quot;Duration of the last &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; rewrite operation in seconds&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_last_write_status&#39;</span><span class="p">:</span> <span class="s2">&quot;Status of last &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; write operation&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_rewrite_in_progress&#39;</span><span class="p">:</span> <span class="s2">&quot;Flag indicating a &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; rewrite operation is on-going&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_rewrite_scheduled&#39;</span><span class="p">:</span> <span class="s2">&quot;Flag indicating an &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; rewrite operation will be scheduled once the on-going RDB save is complete&quot;</span><span class="p">,</span>
    <span class="s1">&#39;arch_bits&#39;</span><span class="p">:</span> <span class="s1">&#39;Architecture (32 or 64 bits)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;blocked_clients&#39;</span><span class="p">:</span> <span class="s1">&#39;Number of clients pending on a blocking call (BLPOP, BRPOP, BRPOPLPUSH)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;client_biggest_input_buf&#39;</span><span class="p">:</span> <span class="s1">&#39;biggest input buffer among current client connections&#39;</span><span class="p">,</span>
    <span class="s1">&#39;client_longest_output_list&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_client&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the client command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_config&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the config command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_dbsize&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the dbsize command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_del&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the del command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_dump&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the dump command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_expire&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the expire command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_flushall&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the flushall command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_get&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the get command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_hgetall&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the hgetall command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_hkeys&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the hkeys command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_hmset&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the hmset command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_info&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the info command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_keys&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the keys command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_llen&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the llen command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_ping&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the ping command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_psubscribe&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the psubscribe command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_pttl&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the pttl command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_sadd&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the sadd command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_scan&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the scan command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_select&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the select command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_set&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the set command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_smembers&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the smembers command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_sscan&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the sscan command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_ttl&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the ttl command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the type command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zadd&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zadd command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zcard&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zcard command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zrange&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zrange command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zremrangebyrank&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zremrangebyrank command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zrevrange&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zrevrange command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zscan&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zscan command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;config_file&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;connected_clients&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;connected_slaves&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;db0&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;evicted_keys&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;expired_keys&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;gcc_version&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;hz&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;instantaneous_ops_per_sec&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;keyspace_hits&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;keyspace_misses&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;latest_fork_usec&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;loading&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;lru_clock&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;master_repl_offset&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;mem_allocator&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;mem_fragmentation_ratio&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;multiplexing_api&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;os&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;process_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;pubsub_channels&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;pubsub_patterns&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_bgsave_in_progress&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_changes_since_last_save&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_current_bgsave_time_sec&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_last_bgsave_status&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_last_bgsave_time_sec&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_last_save_time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;redis_build_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;redis_git_dirty&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;redis_git_sha1&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;redis_mode&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;redis_version&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rejected_connections&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;repl_backlog_active&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;repl_backlog_first_byte_offset&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;repl_backlog_histlen&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;repl_backlog_size&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;run_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;sync_full&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;sync_partial_err&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;sync_partial_ok&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;tcp_port&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;total_commands_processed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;total_connections_received&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;uptime_in_days&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;uptime_in_seconds&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_cpu_sys&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_cpu_sys_children&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_cpu_user&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_cpu_user_children&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory_human&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory_lua&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory_peak&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory_peak_human&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory_rss&#39;</span><span class="p">:</span> <span class="kc">None</span>
<span class="p">}</span>


<span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1"># Added auth to rebrow as per https://github.com/marians/rebrow/pull/20 by</span>
<span class="c1"># elky84</span>
<span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
<span class="c1">#                      Branch #3262: py3</span>
<span class="c1"># def get_redis(host, port, db, password):</span>
<div class="viewcode-block" id="get_redis"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.get_redis">[docs]</a><span class="k">def</span> <span class="nf">get_redis</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">decode</span><span class="p">):</span>
    <span class="c1"># @modified 20230110 - Task #4778: v4.0.0 - update dependencies</span>
    <span class="c1"># Added nosec B105 for bandit</span>
    <span class="c1"># if password == &quot;&quot;:</span>
    <span class="k">if</span> <span class="n">password</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>  <span class="c1"># nosec B105</span>
        <span class="c1"># @modified 20190517 - Branch #3002: docker</span>
        <span class="c1"># Allow rebrow to connect to Redis on the socket too</span>
        <span class="k">if</span> <span class="n">host</span> <span class="o">==</span> <span class="s1">&#39;unix_socket&#39;</span><span class="p">:</span>
            <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># return redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH, db=db)</span>
            <span class="k">if</span> <span class="n">decode</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># return redis.StrictRedis(host=host, port=port, db=db)</span>
            <span class="k">if</span> <span class="n">decode</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">host</span> <span class="o">==</span> <span class="s1">&#39;unix_socket&#39;</span><span class="p">:</span>
            <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># return redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH, db=db)</span>
            <span class="k">if</span> <span class="n">decode</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># return redis.StrictRedis(host=host, port=port, db=db, password=password)</span>
            <span class="k">if</span> <span class="n">decode</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span></div>


<span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1"># Added token, client_id and salt to replace password parameter and determining</span>
<span class="c1"># client protocol</span>
<div class="viewcode-block" id="get_client_details"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.get_client_details">[docs]</a><span class="k">def</span> <span class="nf">get_client_details</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the first X-Forwarded-For address and sets as the IP address.</span>
<span class="sd">    Gets the client_id by simply using a md5 hash of the client IP address</span>
<span class="sd">    and user agent.</span>
<span class="sd">    Determines whether the request was proxied.</span>
<span class="sd">    Determines the client protocol.</span>

<span class="sd">    :return: client_id, protocol, proxied, salt</span>
<span class="sd">    :rtype: str, str, boolean, str</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proxied</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;X-Forwarded-For&#39;</span><span class="p">):</span>
        <span class="n">client_ip</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;X-Forwarded-For&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: client ip set from X-Forwarded-For[0] to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)))</span>
        <span class="n">proxied</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client_ip</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: client ip set from remote_addr to </span><span class="si">%s</span><span class="s1">, no X-Forwarded-For header was found&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)))</span>
    <span class="n">client_user_agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: </span><span class="si">%s</span><span class="s1"> client_user_agent set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">client_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_user_agent</span><span class="p">)))</span>
    <span class="n">client_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client_ip</span><span class="p">,</span> <span class="n">client_user_agent</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># @modified 20200808 - Task #3608: Update Skyline to Python 3.8.3 and deps</span>
        <span class="c1"># Added nosec for bandit [B303:blacklist] Use of insecure MD2, MD4, MD5,</span>
        <span class="c1"># or SHA1 hash function.  For internal use only.</span>
        <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
        <span class="c1"># semgrep - python.lang.security.insecure-hash-algorithms.insecure-hash-algorithm-md5</span>
        <span class="c1"># client_id = hashlib.md5(client_id).hexdigest()  # nosec</span>
        <span class="n">client_id</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># @modified 20200808 - Task #3608: Update Skyline to Python 3.8.3 and deps</span>
        <span class="c1"># Added nosec for bandit [B303:blacklist] Use of insecure MD2, MD4, MD5,</span>
        <span class="c1"># or SHA1 hash function.  For internal use only.</span>
        <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
        <span class="c1"># semgrep - python.lang.security.insecure-hash-algorithms.insecure-hash-algorithm-md5</span>
        <span class="c1"># client_id = hashlib.md5(client_id.encode(&#39;utf-8&#39;)).hexdigest()  # nosec</span>
        <span class="n">client_id</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">client_id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: </span><span class="si">%s</span><span class="s1"> has client_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">client_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_id</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;X-Forwarded-Proto&#39;</span><span class="p">):</span>
        <span class="n">protocol_list</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;X-Forwarded-Proto&#39;</span><span class="p">)</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">protocol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: protocol for </span><span class="si">%s</span><span class="s1"> was set from X-Forwarded-Proto to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client_ip</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">protocol</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: protocol for </span><span class="si">%s</span><span class="s1"> was not set from X-Forwarded-Proto to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client_ip</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">protocol</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">proxied</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: Skyline is not set up correctly, the expected X-Forwarded-For header was not found&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span></div>


<div class="viewcode-block" id="decode_token"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.decode_token">[docs]</a><span class="k">def</span> <span class="nf">decode_token</span><span class="p">(</span><span class="n">client_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use the app.secret, client_id and salt to decode the token JWT encoded</span>
<span class="sd">    payload and determine the Redis password.</span>

<span class="sd">    :param client_id: the client_id string</span>
<span class="sd">    :type client_id: str</span>
<span class="sd">    :return: token, decoded_redis_password, fail_msg, trace</span>
<span class="sd">    :rtype: str, str, str, str</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fail_msg</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
    <span class="c1"># semgrep - python-logger-credential-disclosure</span>
    <span class="c1"># logger.info(&#39;decode_token for client_id - %s&#39; % str(client_id))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;decode_token for client_id OK&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">):</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;No token url parameter was passed, please log into Redis again through rebrow&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
        <span class="c1"># semgrep - python-logger-credential-disclosure</span>
        <span class="c1"># logger.info(&#39;token found in request.args - %s&#39; % str(token))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;token found in request.args - OK&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;No token url parameter was passed, please log into Redis again through rebrow&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>

    <span class="n">client_token_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
                <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># redis_conn = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># redis_conn = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;rebrow.token.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">token</span>
            <span class="n">client_token_data</span> <span class="o">=</span> <span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;Failed to get client_token_data from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
            <span class="n">client_token_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">client_id_match</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                      Branch #3262: py3</span>
    <span class="c1"># if client_token_data is not None:</span>
    <span class="k">if</span> <span class="n">client_token_data</span><span class="p">:</span>
        <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
        <span class="c1"># semgrep - python-logger-credential-disclosure</span>
        <span class="c1"># logger.info(&#39;client_token_data retrieved from Redis - %s&#39; % str(client_token_data))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;client_token_data retrieved from Redis - OK&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">client_token_data</span><span class="p">)</span>
            <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
            <span class="c1"># semgrep - python-logger-credential-disclosure</span>
            <span class="c1"># logger.info(&#39;client_token_data - %s&#39; % str(client_token_data))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;client_token_data - OK&#39;</span><span class="p">)</span>
            <span class="n">client_data_client_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;client_data_client_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_data_client_id</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: failed to get client data from Redis key&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err_msg</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid token. Please log into Redis through rebrow again.&#39;</span>
            <span class="n">client_data_client_id</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">client_data_client_id</span> <span class="o">!=</span> <span class="n">client_id</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
                <span class="c1"># semgrep - python-logger-credential-disclosure</span>
                <span class="c1"># &#39;rebrow access :: error :: the client_id does not match the client_id of the token - %s - %s&#39; %</span>
                <span class="c1"># (str(client_data_client_id), str(client_id)))</span>
                <span class="s1">&#39;rebrow access :: error :: the client_id does not match the client_id of the token&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
                    <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
                    <span class="c1">#                      Branch #3262: py3</span>
                    <span class="c1"># redis_conn = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                    <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># redis_conn = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                    <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;rebrow.token.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">token</span>
                <span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
                <span class="c1"># semgrep - python-logger-credential-disclosure</span>
                <span class="c1"># logger.info(&#39;due to possible attempt at unauthorised use of the token, deleted the Redis key - %s&#39; % str(key))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;due to possible attempt at unauthorised use of the token, deleted the Redis key&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;The request data did not match the token data, due to possible attempt at unauthorised use of the token it has been deleted.&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;this was a dodgy request&#39;</span>
            <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client_id_match</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid token, there was no data found associated with the token, it has probably expired.  Please log into Redis again through rebrow&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">client_token_data</span>
        <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">client_data_salt</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">client_data_jwt_payload</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">client_id_match</span><span class="p">:</span>
        <span class="n">client_data_salt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">client_data_jwt_payload</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">decoded_redis_password</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">client_data_salt</span> <span class="ow">and</span> <span class="n">client_data_jwt_payload</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">jwt_secret</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_data_salt</span><span class="p">)</span>
            <span class="n">jwt_decoded_dict</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">client_data_jwt_payload</span><span class="p">,</span> <span class="n">jwt_secret</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">])</span>
            <span class="n">jwt_decoded_redis_password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">jwt_decoded_dict</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">])</span>
            <span class="n">decoded_redis_password</span> <span class="o">=</span> <span class="n">jwt_decoded_redis_password</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: failed to decode the JWT token with the salt and client_id&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err_msg</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;failed to decode the JWT token with the salt and client_id. Please log into rebrow again.&#39;</span>
            <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">token</span><span class="p">,</span> <span class="n">decoded_redis_password</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span></div>


<div class="viewcode-block" id="rebrow"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.rebrow">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/rebrow&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="c1"># def login():</span>
<span class="k">def</span> <span class="nf">rebrow</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># TODO: test connection, handle failures</span>
        <span class="n">host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">])</span>
        <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
        <span class="n">db</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">])</span>
        <span class="c1"># @modified 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Added auth to rebrow as per https://github.com/marians/rebrow/pull/20 by</span>
        <span class="c1"># elky84</span>
        <span class="c1"># url = url_for(&#39;rebrow_server_db&#39;, host=host, port=port, db=db)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>

        <span class="c1"># @added 20180529 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="n">token_valid_for</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;token_valid_for&#39;</span><span class="p">])</span>
        <span class="c1"># if token_valid_for &gt; 3600:</span>
        <span class="c1">#     token_valid_for = 3600</span>
        <span class="k">if</span> <span class="n">token_valid_for</span> <span class="o">&gt;</span> <span class="mi">86400</span><span class="p">:</span>
            <span class="n">token_valid_for</span> <span class="o">=</span> <span class="mi">86400</span>
        <span class="k">if</span> <span class="n">token_valid_for</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">token_valid_for</span> <span class="o">=</span> <span class="mi">30</span>

        <span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Added auth to rebrow as per https://github.com/marians/rebrow/pull/20 by</span>
        <span class="c1"># elky84 and add encryption to the password URL parameter trying to use</span>
        <span class="c1"># pycrypto/pycryptodome to encode it, but no, used PyJWT instead</span>
        <span class="c1"># padded_password = password.rjust(32)</span>
        <span class="c1"># secret_key = &#39;1234567890123456&#39; # create new &amp; store somewhere safe</span>
        <span class="c1"># cipher = AES.new(app.secret_key,AES.MODE_ECB) # never use ECB in strong systems obviously</span>
        <span class="c1"># encoded = base64.b64encode(cipher.encrypt(padded_password))</span>

        <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Added client_id, token and salt</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>

        <span class="c1"># @added 20180526 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Use pyjwt - JSON Web Token implementation to encode the password and</span>
        <span class="c1"># pass a token in the URL password parameter, the password in the POST</span>
        <span class="c1"># data should be encrypted via the reverse proxy SSL endpoint</span>
        <span class="c1"># encoded = jwt.encode({&#39;some&#39;: &#39;payload&#39;}, &#39;secret&#39;, algorithm=&#39;HS256&#39;)</span>
        <span class="c1"># jwt.decode(encoded, &#39;secret&#39;, algorithms=[&#39;HS256&#39;])</span>
        <span class="c1"># {&#39;some&#39;: &#39;payload&#39;}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">jwt_secret</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">salt</span><span class="p">)</span>
            <span class="n">jwt_encoded_payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">({</span><span class="s1">&#39;auth&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">password</span><span class="p">)},</span> <span class="n">jwt_secret</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;HS256&#39;</span><span class="p">)</span>
            <span class="c1"># @added 20191014 - Bug #3268: webapp - rebrow - jwt.encode generating bytes instead of a string in py3</span>
            <span class="c1">#                   Branch #3262: py3</span>
            <span class="c1"># As per https://github.com/jpadilla/pyjwt/issues/391 - jwt.encode generating bytes instead of a string</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># @modified 20220110 - Task #4344: Update dependencies</span>
                <span class="c1">#                      Task #4362: snyk - numpy and pillow updates</span>
                <span class="c1"># PyJWT change no longer str</span>
                <span class="c1"># jwt_encoded_payload = jwt_encoded_payload.decode(&#39;UTF-8&#39;)</span>
                <span class="c1"># AttributeError: &#39;str&#39; object has no attribute &#39;decode&#39;</span>
                <span class="c1"># jwt_encoded_payload = jwt_encoded_payload.decode(&#39;UTF-8&#39;)</span>
                <span class="n">jwt_encoded_payload</span> <span class="o">=</span> <span class="n">jwt_encoded_payload</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to create set jwt_encoded_payload for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">client_id</span>
            <span class="n">rtrace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">rtrace</span><span class="p">)</span>

        <span class="c1"># HERE WE WANT TO PUT THIS INTO REDIS with a TTL key and give the key</span>
        <span class="c1"># a salt and have the client use that as their token</span>
        <span class="n">client_token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
        <span class="c1"># semgrep - python-logger-credential-disclosure</span>
        <span class="c1"># logger.info(&#39;rebrow access :: generated client_token %s for client_id %s&#39; % (client_token, client_id))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: generated client_token for client_id OK&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
                <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># redis_conn = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># redis_conn = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;rebrow.token.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">client_token</span>
            <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="n">jwt_encoded_payload</span><span class="p">)</span>
            <span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">token_valid_for</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: set Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to set Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @modified 20180526 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Change password parameter to token parameter</span>
        <span class="c1"># url = url_for(&quot;rebrow_server_db&quot;, host=host, port=port, db=db, password=password)</span>
        <span class="c1"># @modified 20201103 - Feature #3824: get_cluster_data</span>
        <span class="c1"># Change default page from Server to Keys</span>
        <span class="c1"># url = url_for(</span>
        <span class="c1">#     &quot;rebrow_server_db&quot;, host=host, port=port, db=db, token=client_token)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span>
            <span class="s2">&quot;rebrow_keys&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">client_token</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Added client_id</span>
        <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>

        <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Added client message to give relevant messages on the login page</span>
        <span class="n">client_message</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20190519 - Branch #3002: docker</span>
        <span class="n">display_redis_password</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">host_input_value</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
        <span class="n">rebrow_redis_password</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">running_on_docker</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DOCKER</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">running_on_docker</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">running_on_docker</span><span class="p">:</span>
            <span class="n">host_input_value</span> <span class="o">=</span> <span class="s1">&#39;unix_socket&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">display_redis_password</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DOCKER_DISPLAY_REDIS_PASSWORD_IN_REBROW</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">display_redis_password</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">display_redis_password</span><span class="p">:</span>
                <span class="n">rebrow_redis_password</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;rebrow_login.html&#39;</span><span class="p">,</span>
            <span class="c1"># @modified 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
            <span class="c1"># Change password parameter to token parameter and added protocol,</span>
            <span class="c1"># proxied</span>
            <span class="c1"># redis_password=redis_password,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span><span class="o">=</span><span class="n">proxied</span><span class="p">,</span> <span class="n">client_message</span><span class="o">=</span><span class="n">client_message</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
            <span class="c1"># @added 20190519 - Branch #3002: docker</span>
            <span class="n">running_on_docker</span><span class="o">=</span><span class="n">running_on_docker</span><span class="p">,</span>
            <span class="n">rebrow_redis_password</span><span class="o">=</span><span class="n">rebrow_redis_password</span><span class="p">,</span>
            <span class="n">display_redis_password</span><span class="o">=</span><span class="n">display_redis_password</span><span class="p">,</span>
            <span class="n">host_input_value</span><span class="o">=</span><span class="n">host_input_value</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span></div>


<div class="viewcode-block" id="rebrow_server_db"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.rebrow_server_db">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/rebrow_server_db/&lt;host&gt;:&lt;int:port&gt;/&lt;int:db&gt;/&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">rebrow_server_db</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all databases and show info on server</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># @modified 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># r = redis.StrictRedis(host=host, port=port, db=0)</span>
    <span class="c1"># @modified 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># Use client_id and JWT token</span>
    <span class="c1"># password = False</span>
    <span class="c1"># url_password = False</span>
    <span class="c1"># if request.args.getlist(&#39;password&#39;):</span>
    <span class="c1">#     password = request.args.get(&#39;password&#39;, default=&#39;&#39;, type=str)</span>
    <span class="c1">#     url_password = quote(password, safe=&#39;&#39;)</span>
    <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># Added client_id and token</span>
    <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">rtrace</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fail_msg</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">rtrace</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># r = get_redis(host, port, db, redis_password)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">get_redis</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: rebrow access :: failed to login to Redis with token&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to get INFO all from Redis, this could be an issue with the Redis password you entered.&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="n">dbsize</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dbsize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;rebrow_server_db.html&#39;</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
        <span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># password=password,</span>
        <span class="c1"># url_password=url_password,</span>
        <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
        <span class="n">dbsize</span><span class="o">=</span><span class="n">dbsize</span><span class="p">,</span>
        <span class="n">serverinfo_meta</span><span class="o">=</span><span class="n">serverinfo_meta</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span></div>


<div class="viewcode-block" id="rebrow_keys"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.rebrow_keys">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/rebrow_keys/&lt;host&gt;:&lt;int:port&gt;/&lt;int:db&gt;/keys/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">rebrow_keys</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List keys for one database</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># @modified 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># r = redis.StrictRedis(host=host, port=port, db=db)</span>
    <span class="c1"># @modified 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># password = request.args.get(&#39;password&#39;, default=&#39;&#39;, type=str)</span>
    <span class="c1"># url_password = quote(password, safe=&#39;&#39;)</span>
    <span class="c1"># r = get_redis(host, port, db, password)</span>
    <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># Added client_id and token</span>
    <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">rtrace</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fail_msg</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">rtrace</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># r = get_redis(host, port, db, redis_password)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">get_redis</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: rebrow access :: failed to login to Redis with token&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;delkey&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to delete Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Key </span><span class="si">%s</span><span class="s1"> has been deleted.&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: deleted Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Key </span><span class="si">%s</span><span class="s1"> could not be deleted.&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: could not deleted Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
        <span class="c1"># @modified 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># List more keys per page</span>
        <span class="c1"># perpage = int(request.args.get(&#39;perpage&#39;, &#39;10&#39;))</span>
        <span class="n">perpage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perpage&#39;</span><span class="p">,</span> <span class="s1">&#39;50&#39;</span><span class="p">))</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20220224 - Feature #4470: rebrow - filter keys - exclude and type</span>
        <span class="c1"># Allow to filter by exclude patterns and by key type</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exclude&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">key_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key_type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">key_types</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dbsize</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dbsize</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to determine Redis dbsize&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @modified 20230330 - Feature #4468: flux - remove_namespace_quota_metrics</span>
        <span class="c1"># Use scan_iter</span>
        <span class="c1"># keys = sorted(r.keys(pattern))</span>
        <span class="c1"># keys = []</span>
        <span class="c1"># try:</span>
        <span class="c1">#     for key in r.scan_iter(pattern):</span>
        <span class="c1">#         keys.append(key)</span>
        <span class="c1"># except Exception as err:</span>
        <span class="c1">#     message = &#39;rebrow - failed to scan_iter(\&#39;%s\&#39;) on Redis - %s&#39; % (str(pattern), err)</span>
        <span class="c1">#     trace = traceback.format_exc()</span>
        <span class="c1">#     return internal_error(message, trace)</span>
        <span class="c1"># keys = sorted(keys)</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>

        <span class="n">num_keys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

        <span class="c1"># @added 20220224 - Feature #4470: rebrow - filter keys - exclude and type</span>
        <span class="n">filtered_out</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exclude_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_found_keys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exclude</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">exclude_list</span> <span class="o">=</span> <span class="n">exclude</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">included_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">pattern_match</span><span class="p">,</span> <span class="n">matched_by</span> <span class="o">=</span> <span class="n">matched_or_regexed_in_list</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">exclude_list</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">matched_by</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_match</span><span class="p">:</span>
                    <span class="n">included_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">included_keys</span><span class="p">)</span>
            <span class="n">filtered_out</span> <span class="o">=</span> <span class="n">total_found_keys</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

        <span class="n">types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># @modified 20220224 - Feature #4470: rebrow - filter keys - exclude and type</span>
        <span class="c1"># Added ability to filter by key type</span>
        <span class="n">key_sizes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">limited_keys</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">offset</span><span class="p">:(</span><span class="n">perpage</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">limited_keys</span><span class="p">:</span>
                <span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">key_sizes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key_types</span> <span class="o">=</span> <span class="n">key_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">included_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="n">offset</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">included_keys</span><span class="p">)</span> <span class="o">==</span> <span class="n">perpage</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">k_type</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k_type</span> <span class="ow">in</span> <span class="n">key_types</span><span class="p">:</span>
                    <span class="n">included_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_type</span>
                    <span class="n">key_sizes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">included_keys</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">perpage</span><span class="p">:</span>
                <span class="n">num_keys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">included_keys</span><span class="p">)</span>
            <span class="n">limited_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">included_keys</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: returned keys list&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;rebrow_keys.html&#39;</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
            <span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
            <span class="c1"># password=password,</span>
            <span class="c1"># url_password=url_password,</span>
            <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
            <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
            <span class="n">dbsize</span><span class="o">=</span><span class="n">dbsize</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">limited_keys</span><span class="p">,</span>
            <span class="n">types</span><span class="o">=</span><span class="n">types</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
            <span class="n">perpage</span><span class="o">=</span><span class="n">perpage</span><span class="p">,</span>
            <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
            <span class="n">num_keys</span><span class="o">=</span><span class="n">num_keys</span><span class="p">,</span>
            <span class="c1"># @added 20220224 - Feature #4470: rebrow - filter keys - exclude and type</span>
            <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span> <span class="n">filtered_out</span><span class="o">=</span><span class="n">filtered_out</span><span class="p">,</span>
            <span class="n">total_found_keys</span><span class="o">=</span><span class="n">total_found_keys</span><span class="p">,</span> <span class="n">exclude_list</span><span class="o">=</span><span class="n">exclude_list</span><span class="p">,</span>
            <span class="n">key_type</span><span class="o">=</span><span class="n">key_type</span><span class="p">,</span> <span class="n">key_types</span><span class="o">=</span><span class="n">key_types</span><span class="p">,</span> <span class="n">key_sizes</span><span class="o">=</span><span class="n">key_sizes</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span></div>


<div class="viewcode-block" id="rebrow_key"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.rebrow_key">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/rebrow_key/&lt;host&gt;:&lt;int:port&gt;/&lt;int:db&gt;/keys/&lt;key&gt;/&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">rebrow_key</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show a specific key.</span>
<span class="sd">    key is expected to be URL-safe base64 encoded</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># @added 20160703 - Feature #1464: Webapp Redis browser</span>
    <span class="c1"># metrics encoded with msgpack</span>
    <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
    <span class="c1"># original_key not used</span>
    <span class="c1"># original_key = key</span>

    <span class="n">msg_pack_key</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># if key.startswith(&#39;metrics.&#39;):</span>
    <span class="c1">#     msg_packed_key = True</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># @modified 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># r = redis.StrictRedis(host=host, port=port, db=db)</span>
    <span class="c1"># @modified 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># Use client_id and token</span>
    <span class="c1"># password = request.args.get(&#39;password&#39;, default=&#39;&#39;, type=str)</span>
    <span class="c1"># url_password = quote(password, safe=&#39;&#39;)</span>
    <span class="c1"># r = get_redis(host, port, db, password)</span>
    <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># Added client_id and token</span>
    <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">rtrace</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fail_msg</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">rtrace</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">get_redis</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: rebrow access :: failed to login to Redis with token&#39;</span><span class="p">)</span>
    <span class="c1"># @modified 20210504 -</span>
    <span class="c1"># try:</span>
    <span class="c1">#    r_d = get_redis(host, port, db, redis_password, True)</span>
    <span class="c1"># except:</span>
    <span class="c1">#     logger.error(traceback.format_exc())</span>
    <span class="c1">#     logger.error(&#39;error :: rebrow access :: failed to login to Redis with token&#39;)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># dump = r.dump(key)</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dump</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">dump_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">dump</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dump_key</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: got key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dump_key</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to dump Redis key - </span><span class="si">%s</span><span class="s1">, decoded key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">dump_key</span><span class="p">))</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dump</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="c1"># if t is None:</span>
    <span class="c1">#    abort(404)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dump</span><span class="p">)</span>
    <span class="c1"># @modified 20170809 - Bug #2136: Analyzer stalling on no metrics</span>
    <span class="c1"># Added except to all del methods to prevent stalling if any object does</span>
    <span class="c1"># not exist</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">dump</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to del dump&#39;</span><span class="p">)</span>

    <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                      Branch #3262: py3</span>
    <span class="c1"># t = r.type(key)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">dump_key</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: got key - </span><span class="si">%s</span><span class="s1">, of type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dump_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to decode Redis key - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="n">ttl</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">pttl</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">:</span>
        <span class="c1"># @modified 20160703 - Feature #1464: Webapp Redis browser</span>
        <span class="c1"># metrics encoded with msgpack</span>
        <span class="c1"># val = r.get(key)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

        <span class="c1"># @added 20220311 - Bug #4500: Handle unicode chars in webapp rebrow</span>
        <span class="n">try_msgpack</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @modified 20200610 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># Try decode val so that bytes-like objects are decoded, this will fail</span>
        <span class="c1"># sliently and if it is a msg_packed_key</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="c1"># @modified 20220311 - Bug #4500: Handle unicode chars in webapp rebrow</span>
        <span class="c1"># except (UnicodeDecodeError, AttributeError):</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="n">try_msgpack</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># test_string = all(c in string.printable for c in val)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">test_string</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">test_string</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20220311 - Bug #4500: Handle unicode chars in webapp rebrow</span>
        <span class="c1"># The test_string test above fails on strings with extended ascii or</span>
        <span class="c1"># unicode characters in them, however msgpack strings generally fail</span>
        <span class="c1"># with a UnicodeDecodeError</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_string</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">try_msgpack</span><span class="p">:</span>
                <span class="n">test_string</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># @added 20170920 - Bug #2166: panorama incorrect mysql_id cache keys</span>
        <span class="c1"># There are SOME cache key msgpack values that DO == string.printable</span>
        <span class="c1"># for example [73] msgpacks to I</span>
        <span class="c1"># panorama.mysql_ids will always be msgpack</span>
        <span class="k">if</span> <span class="s1">&#39;panorama.mysql_ids&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">test_string</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_string</span><span class="p">:</span>
            <span class="n">raw_result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">raw_result</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpacker</span><span class="p">)</span>
            <span class="n">msg_pack_key</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: msgpack key unpacked - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dump_key</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;list&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lrange</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;hash&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="c1"># @modified 20200610 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># Try decode val so that bytes-like objects are decoded</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: set key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;zset&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">zrange</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">withscores</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;TSDB-TYPE&#39;</span><span class="p">:</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">until_timestamp</span> <span class="o">-</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># RedisTimeSeries uses milliseconds</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">ts</span><span class="p">()</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">from_timestamp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span> <span class="p">(</span><span class="n">until_timestamp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
        <span class="c1"># logger.debug(&#39;debug :: rebrow :: TSDB key value - %s&#39; % str(val))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;rebrow_key.html&#39;</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
        <span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># password=password,</span>
        <span class="c1"># url_password=url_password,</span>
        <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
        <span class="n">ttl</span><span class="o">=</span><span class="n">ttl</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">,</span>
        <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
        <span class="n">expiration</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">ttl</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">),</span>
        <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">serve_jaeger</span><span class="o">=</span><span class="n">WEBAPP_SERVE_JAEGER</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
        <span class="n">msg_packed_key</span><span class="o">=</span><span class="n">msg_pack_key</span><span class="p">)</span></div>


<div class="viewcode-block" id="urlsafe_base64_encode"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.urlsafe_base64_encode">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">template_filter</span><span class="p">(</span><span class="s1">&#39;urlsafe_base64&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">urlsafe_base64_encode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="c1"># @modified 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># if type(s) == &#39;Markup&#39;:</span>
    <span class="c1">#     s = s.unescape()</span>

    <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                      Branch #3262: py3</span>
    <span class="c1"># if isinstance(s, Markup):</span>
    <span class="c1">#     s = s.unescape()</span>
    <span class="c1"># elif isinstance(s, bytes):</span>
    <span class="c1">#     s = s.decode(&#39;utf-8&#39;)</span>
    <span class="c1"># s = s.encode(&#39;utf8&#39;)</span>
    <span class="c1"># s = base64.urlsafe_b64encode(s)</span>
    <span class="n">s_original</span> <span class="o">=</span> <span class="n">s</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Markup</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">unescape</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c1"># logger.info(&#39;debug :: rebrow :: %s urlsafe_b64encode as %s&#39; % (str(s_original), str(s)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to urlsafe_b64encode - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="c1"># @added 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                   Branch #3262: py3</span>
    <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">decoded_s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">decoded_s</span>
        <span class="c1"># logger.info(&#39;debug more :: rebrow :: %s urlsafe_b64encode decoded as %s&#39; % (str(s_original), str(decoded_s)))</span>

    <span class="k">return</span> <span class="n">Markup</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>
<span class="c1"># END rebrow</span>


<div class="viewcode-block" id="App"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.App">[docs]</a><span class="k">class</span> <span class="nc">App</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdin_path</span> <span class="o">=</span> <span class="s1">&#39;/dev/null&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.pid&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PID_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_timeout</span> <span class="o">=</span> <span class="mi">5</span>

<div class="viewcode-block" id="App.run"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.App.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Log management to prevent overwriting</span>
        <span class="c1"># Allow the bin/&lt;skyline_app&gt;.d to manage the log</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os_remove</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logwait</span><span class="p">)</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1">#        log_wait_for = now + 5</span>
        <span class="n">log_wait_for</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">log_wait_for</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">log_wait_for</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting </span><span class="si">%s</span><span class="s1"> run&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - bin/</span><span class="si">%s</span><span class="s1">.d log management seems to have failed, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os_remove</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;log lock file removed&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app_loglock</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bin/</span><span class="si">%s</span><span class="s1">.d log management done&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_version</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting </span><span class="si">%s</span><span class="s1"> - version UNKNOWN&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;hosted at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;running on port </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_PORT</span><span class="p">)</span>

        <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_PORT</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start the Webapp server</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PID_PATH</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pid directory does not exist at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PID_PATH</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;log directory does not exist at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> :: </span><span class="si">%(process)s</span><span class="s2"> :: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">TimedRotatingFileHandler</span><span class="p">(</span>
        <span class="n">logfile</span><span class="p">,</span>
        <span class="n">when</span><span class="o">=</span><span class="s2">&quot;midnight&quot;</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">backupCount</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">memory_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">MemoryHandler</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span>
                                                    <span class="n">flushLevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                                                    <span class="n">target</span><span class="o">=</span><span class="n">handler</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">memory_handler</span><span class="p">)</span>

    <span class="c1"># Validate settings variables</span>
    <span class="n">valid_settings</span> <span class="o">=</span> <span class="n">validate_settings_variables</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_settings</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error :: invalid variables in settings.py - cannot start&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_SERVER</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_SERVER&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_SERVER&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_IP&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_IP&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_PORT</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_PORT&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_PORT&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_ENABLED&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_ENABLED&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP_RESTRICTED</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_IP_RESTRICTED&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_IP_RESTRICTED&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_USER&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_USER&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER_PASSWORD</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_USER_PASSWORD&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_USER_PASSWORD&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_ALLOWED_IPS</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_ALLOWED_IPS&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_ALLOWED_IPS&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_GUNICORN_WORKERS</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;notice :: settings.WEBAPP_GUNICORN_WORKERS is set to </span><span class="si">%s</span><span class="s1">, decreased to 2 as more than 2 are not required with the gevent worker_class&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_GUNICORN_WORKERS</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">notice</span><span class="p">(</span><span class="s1">&#39;notice :: settings.WEBAPP_GUNICORN_WORKERS is set to </span><span class="si">%s</span><span class="s1">, decreased to 2 as more than 2 are not required with the gevent worker_class&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_GUNICORN_WORKERS</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine WEBAPP_GUNICORN_WORKERS from settings.py&#39;</span><span class="p">)</span>

    <span class="n">webapp</span> <span class="o">=</span> <span class="n">App</span><span class="p">()</span>

<span class="c1"># Does this make it log?</span>
<span class="c1">#    if len(sys.argv) &gt; 1 and sys.argv[1] == &#39;run&#39;:</span>
<span class="c1">#        webapp.run()</span>
<span class="c1">#    else:</span>
<span class="c1">#        daemon_runner = runner.DaemonRunner(webapp)</span>
<span class="c1">#        daemon_runner.daemon_context.files_preserve = [handler.stream]</span>
<span class="c1">#        daemon_runner.do_action()</span>

    <span class="n">daemon_runner</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">DaemonRunner</span><span class="p">(</span><span class="n">webapp</span><span class="p">)</span>
    <span class="n">daemon_runner</span><span class="o">.</span><span class="n">daemon_context</span><span class="o">.</span><span class="n">files_preserve</span> <span class="o">=</span> <span class="p">[</span><span class="n">handler</span><span class="o">.</span><span class="n">stream</span><span class="p">]</span>
    <span class="n">daemon_runner</span><span class="o">.</span><span class="n">do_action</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>