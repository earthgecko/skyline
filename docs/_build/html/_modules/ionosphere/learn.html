

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ionosphere.learn &mdash; Skyline 1.2.9-stable documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Skyline 1.2.9-stable documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Skyline
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html#smaller-deployments">Smaller deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html#reliability">Reliability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debian-and-vagrant-installation-tips.html">Debian and Vagrant Installation Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">What&#8217;s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Skyline</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>ionosphere.learn</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ionosphere.learn</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="kn">from</span> <span class="nn">ast</span> <span class="k">import</span> <span class="n">literal_eval</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">version_info</span>

<span class="kn">from</span> <span class="nn">redis</span> <span class="k">import</span> <span class="n">StrictRedis</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">mysql.connector</span>
<span class="kn">from</span> <span class="nn">mysql.connector</span> <span class="k">import</span> <span class="n">errorcode</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="k">import</span> <span class="n">select</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">settings</span>
<span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">get_graphite_metric</span><span class="p">,</span> <span class="n">send_anomalous_metric_to</span><span class="p">,</span>
    <span class="c1"># @added 20170603 - Feature #2034: analyse_derivatives</span>
    <span class="n">nonNegativeDerivative</span><span class="p">,</span> <span class="n">in_list</span><span class="p">,</span>
    <span class="c1"># @added 20170825 - Task #2132: Optimise Ionosphere DB usage</span>
    <span class="n">get_memcache_metric_object</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">features_profile</span> <span class="k">import</span> <span class="n">calculate_features_profile</span>

<span class="kn">from</span> <span class="nn">database</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">get_engine</span><span class="p">,</span> <span class="n">ionosphere_table_meta</span><span class="p">,</span> <span class="n">metrics_table_meta</span><span class="p">)</span>

<span class="c1"># @added 2017014 - Feature #1854: Ionosphere learn</span>
<span class="kn">from</span> <span class="nn">ionosphere_functions</span> <span class="k">import</span> <span class="n">create_features_profile</span>

<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;ionosphere&#39;</span>
<span class="n">skyline_app_logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Log&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
<span class="n">skyline_app_logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
<span class="n">skyline_app_loglock</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">skyline_app_logwait</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wait&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>

<span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">this_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Converting one settings variable into a local variable, just because it is a</span>
<span class="c1"># long string otherwise.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ENABLE_IONOSPHERE_DEBUG</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: cannot determine ENABLE_IONOSPHERE_DEBUG from settings&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
    <span class="n">ENABLE_IONOSPHERE_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
    <span class="k">if</span> <span class="n">SERVER_METRIC_PATH</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">learn_full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_FULL_DURATION_DAYS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86400</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">learn_full_duration</span> <span class="o">=</span> <span class="mi">86400</span> <span class="o">*</span> <span class="mi">30</span>  <span class="c1"># 2592000</span>

<span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
    <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
<span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;ionosphere_learn&#39;</span>


<div class="viewcode-block" id="learn_load_metric_vars"><a class="viewcode-back" href="../../skyline.ionosphere.html#ionosphere.learn.learn_load_metric_vars">[docs]</a><span class="k">def</span> <span class="nf">learn_load_metric_vars</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the metric variables for a check from a metric check variables file</span>

<span class="sd">    :param metric_vars_file: the path and filename to the metric variables files</span>
<span class="sd">    :type metric_vars_file: str</span>
<span class="sd">    :return: the metric_vars list or ``False``</span>
<span class="sd">    :rtype: list</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;learn :: loading metric variables from metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;error :: learn :: loading metric variables from metric_check_file - file not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">metric_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">no_new_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">no_equal_line</span> <span class="o">=</span> <span class="n">no_new_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; = &#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">array</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">no_equal_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">add_line</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">metric_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_line</span><span class="p">)</span>

    <span class="n">string_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;anomaly_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;added_by&#39;</span><span class="p">,</span> <span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">]</span>
    <span class="n">float_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="c1"># @modified 20170127 - Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
    <span class="c1"># Added ionosphere_parent_id, always zero from Analyzer and Mirage</span>
    <span class="n">int_keys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;added_at&#39;</span><span class="p">,</span> <span class="s1">&#39;full_duration&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ionosphere_parent_id&#39;</span><span class="p">]</span>
    <span class="n">array_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">,</span> <span class="s1">&#39;triggered_algorithms&#39;</span><span class="p">]</span>
    <span class="n">boolean_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;graphite_metric&#39;</span><span class="p">,</span> <span class="s1">&#39;run_crucible_tests&#39;</span><span class="p">]</span>

    <span class="n">metric_vars_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">string_keys</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">float_keys</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">int_keys</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">array_keys</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">boolean_keys</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">metric_vars_array</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_vars_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: learn :: loading metric variables - none found&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_file</span><span class="p">)))</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: metric_vars for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_vars_array</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">metric_vars_array</span></div>


<div class="viewcode-block" id="get_learn_json"><a class="viewcode-back" href="../../skyline.ionosphere.html#ionosphere.learn.get_learn_json">[docs]</a><span class="k">def</span> <span class="nf">get_learn_json</span><span class="p">(</span>
        <span class="n">learn_json_file</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">use_full_duration</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span>
        <span class="n">learn_full_duration_days</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`~learn` to surface a use_full_duration timeseries for the</span>
<span class="sd">    metric from Graphite and save as json.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
    <span class="n">ts_json</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">use_full_duration</span><span class="p">)</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;learn :: getting Graphite timeseries json at </span><span class="si">%s</span><span class="s1"> days - from_timestamp - </span><span class="si">%s</span><span class="s1">, until_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)))</span>
        <span class="n">ts_json</span> <span class="o">=</span> <span class="n">get_graphite_metric</span><span class="p">(</span>
            <span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
            <span class="n">learn_json_file</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: getting Graphite timeseries json&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ts_json</span></div>


<div class="viewcode-block" id="get_metric_from_metrics"><a class="viewcode-back" href="../../skyline.ionosphere.html#ionosphere.learn.get_metric_from_metrics">[docs]</a><span class="k">def</span> <span class="nf">get_metric_from_metrics</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`~learn` and returns the metric id and metric db object</span>

<span class="sd">    :param timestamp: timestamp at which learn was called</span>
<span class="sd">    :type timestamp: int</span>
<span class="sd">    :return: tuple</span>
<span class="sd">    :rtype: (int, object)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
    <span class="n">metrics_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">metric_db_object</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Get the metrics_table metadata</span>
    <span class="n">metrics_table</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">metrics_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">metrics_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: metrics_table OK for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to get metrics_table meta for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">metrics_table</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">metrics_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">metric_db_object</span> <span class="o">=</span> <span class="n">row</span>
        <span class="n">metrics_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: could not determine id from metrics table for - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">metrics_id</span><span class="p">,</span> <span class="n">metric_db_object</span></div>


<span class="c1"># @added 20170117 - Feature #1854: Ionosphere learn - learn_fp_learnt</span>
<span class="c1"># To determine origin fp features sum</span>
<div class="viewcode-block" id="get_ionosphere_fp_ids"><a class="viewcode-back" href="../../skyline.ionosphere.html#ionosphere.learn.get_ionosphere_fp_ids">[docs]</a><span class="k">def</span> <span class="nf">get_ionosphere_fp_ids</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">metrics_id</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`~learn` and returns the fp_ids list</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
    <span class="n">fp_ids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ionosphere_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: ionosphere_table OK&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to get ionosphere_table meta for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fp_ids</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">ionosphere_table</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ionosphere_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric_id</span> <span class="o">==</span> <span class="n">metrics_id</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">fp_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">fp_ids_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_ids</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: detemined </span><span class="si">%s</span><span class="s1"> fp ids for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp_ids_count</span><span class="p">),</span> <span class="n">base_name</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get the fp_ids_db_object_count from the DB for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fp_ids</span></div>


<span class="c1"># @added 20170114 - Feature #1854: Ionosphere learn - Redis ionosphere.learn.work namespace</span>
<div class="viewcode-block" id="get_ionosphere_record"><a class="viewcode-back" href="../../skyline.ionosphere.html#ionosphere.learn.get_ionosphere_record">[docs]</a><span class="k">def</span> <span class="nf">get_ionosphere_record</span><span class="p">(</span><span class="n">fp_id</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`~learn` and returns the fp row object</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ionosphere_table</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_table_meta</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to get ionosphere_table meta for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">ionosphere_table</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ionosphere_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">fp_id</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get the fp_ids_db_object_count from the DB for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">row</span></div>

<span class="c1"># @added 20170114 - Feature #1854: Ionosphere learn - Redis ionosphere.learn.work namespace</span>
<span class="c1"># Make a reusable function to remove the work from the Redis set</span>


<div class="viewcode-block" id="remove_work_list_from_redis_set"><a class="viewcode-back" href="../../skyline.ionosphere.html#ionosphere.learn.remove_work_list_from_redis_set">[docs]</a><span class="k">def</span> <span class="nf">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`~learn` to remove a work item from the Redis set</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
    <span class="n">work_set</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.learn.work&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="n">work_set</span><span class="p">,</span> <span class="n">learn_metric_list</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: removed work item - </span><span class="si">%s</span><span class="s1"> - from Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">),</span> <span class="n">work_set</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to remove work item list from Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">work_set</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>

<span class="c1"># @modified 20170113 - Feature #1854: Ionosphere learn - Redis ionosphere.learn.work namespace</span>
<span class="c1"># Added work deadlines and changed to learn.py understanding and mangaing its</span>
<span class="c1"># own work queue so that anything can just queue work to learn.  Under this</span>
<span class="c1"># methodolgy, learn will run every minute if there is work in its queue that</span>
<span class="c1"># is nearing deadline, let us add and do some real-time computing</span>


<span class="c1"># def learn(metric_check_file):</span>
<span class="c1"># @modified 20170117 - Feature #1854: Ionosphere learn - generations</span>
<span class="c1"># Renamed the function from simple learn to the meme it has become</span>
<span class="c1"># learn(timestamp)</span>
<span class="c1"># def learn(timestamp):</span>
<div class="viewcode-block" id="ionosphere_learn"><a class="viewcode-back" href="../../skyline.ionosphere.html#ionosphere.learn.ionosphere_learn">[docs]</a><span class="k">def</span> <span class="nf">ionosphere_learn</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :class:`~skyline.skyline.Ionosphere.spawn_learn_process` to</span>
<span class="sd">    re-evaluate anomalies and such, like creating learning features profiles,</span>
<span class="sd">    when a human makes a features profile and the automated creation of learnt</span>
<span class="sd">    features profiles and learn features profiles.</span>

<span class="sd">    :param timestamp: timestamp at which learn was called</span>
<span class="sd">    :type timestamp: int</span>
<span class="sd">    :return: True or False</span>
<span class="sd">    :rtype: boolean</span>

<span class="sd">    learn uses a Redis set as a work queue.  This set is populated with the</span>
<span class="sd">    learn jobs, jobs being pieces of work that learn needs to do.  The learn</span>
<span class="sd">    Redis work set list item has the following elements:</span>

<span class="sd">    ``[str(deadline_type), str(job_type), int(metric_timestamp), str(base_name), int(parent_id), int(generation)]``</span>

<span class="sd">    Each job_type has a deadline_time that learn calculates from the job_type</span>

<span class="sd">    ionosphere.learn.work deadlines - deadline_types</span>

<span class="sd">    - Hard - missing a deadline is a total system failure.</span>
<span class="sd">    - Firm - infrequent deadline misses are tolerable, but may degrade the</span>
<span class="sd">      system&#39;s quality of service. The usefulness of a result is zero after</span>
<span class="sd">      its deadline.</span>
<span class="sd">    - Soft - the usefulness of a result degrades after its deadline, thereby</span>
<span class="sd">      degrading the system&#39;s quality of service.</span>

<span class="sd">    references:</span>

<span class="sd">    - Brian L. Troutwine @bltroutwine - seminal Belgium 2014 devopsdays</span>
<span class="sd">      presentation - Automation with Humans in Mind: Making Complex Systems Predictable, Reliable and Humane -</span>
<span class="sd">      https://legacy.devopsdays.org/events/2014-belgium/proposals/automation-with-humans-in-mind/ -</span>
<span class="sd">      video - http://www.ustream.tv/recorded/54703629</span>
<span class="sd">    - https://en.wikipedia.org/wiki/Real-time_computing#Criteria_for_real-time_computing</span>

<span class="sd">    learn work types:</span>

<span class="sd">    - **learn_fp_human** - Create a features profile for the human created features profile</span>
<span class="sd">      after ``LEARN_VALID_TIMESERIES_OLDER_THAN_SECONDS`` at ``LEARN_FULL_DURATION_DAYS``</span>
<span class="sd">      whatever those maybe it, will find out.  Copy the training_data dir to</span>
<span class="sd">      :mod:`settings.IONOSPHERE_LEARN_FOLDER` and the metric_check_file is rewritten</span>
<span class="sd">      with the determined (``LEARN_FULL_DURATION_DAYS`` * 86400) as the new</span>
<span class="sd">      full_duration.  Then this features profile is created as a generation 0</span>
<span class="sd">      features profile at the learn use_full_duration seconds.  This jobs is</span>
<span class="sd">      only ever add via the Ionosphere UI</span>
<span class="sd">      `~skyline.ionosphere_functions.create_features_profile`</span>
<span class="sd">      TODO: now_timestamp/ where the now_timestamp relaces the metric_timestamp</span>
<span class="sd">      context and as the metric_check_file has been replaced and this features</span>
<span class="sd">      profile was created later.  This prevents the pollution of metric_timestamp</span>
<span class="sd">      training data features profile.  This is a new features profile.  Is it</span>
<span class="sd">      generation 0 or generation 1?  The more I think I am edging to generation</span>
<span class="sd">      1, however as long as the first automated full_duration profiles that they</span>
<span class="sd">      create are generation 1 as well... hmm the generation game... TDB</span>
<span class="sd">      - deadline: &#39;Soft&#39;</span>

<span class="sd">    - **learn_fp_automatic** - Create a features profile for the automatic</span>
<span class="sd">      created features profile as per the learn_fp_human above.</span>
<span class="sd">      - deadline: &#39;Soft&#39;</span>

<span class="sd">    - **learn_fp_generation** - Create a features profile for the Ionosphere</span>
<span class="sd">      training_data metric after ``LEARN_VALID_TIMESERIES_OLDER_THAN_SECONDS`` at</span>
<span class="sd">      ``LEARN_FULL_DURATION_DAYS`` have passed and compare to other known</span>
<span class="sd">      ``LEARN_FULL_DURATION_DAYS`` features profiles.  If it matches any, then the</span>
<span class="sd">      metric training_data is added as features profile incremented by 1</span>
<span class="sd">      generation if ``MAX_GENERATIONS`` is not breached.</span>
<span class="sd">      - deadline: &#39;Soft&#39;</span>

<span class="sd">    - **learn_fp_learnt** - Create a features profile for the Ionosphere learnt</span>
<span class="sd">      features profile after ``LEARN_VALID_TIMESERIES_OLDER_THAN_SECONDS`` at ``LEARN_FULL_DURATION_DAYS``</span>
<span class="sd">      whatever those maybe it, will find out.  Copies the training_data dir to</span>
<span class="sd">      :mod:`settings.IONOSPHERE_LEARN_FOLDER`/now_timestamp/ where the now_timestamp</span>
<span class="sd">      relaces the metric_timestamp context and the metric_check_file has the</span>
<span class="sd">      full_duration replace by the relevant use_full_duration.  Then this</span>
<span class="sd">      features profile is created as an incremented generation features profile</span>
<span class="sd">      at use_full_duration via learn.</span>
<span class="sd">      - deadline: &#39;Soft&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
    <span class="n">child_process_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: child_process_pid - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_process_pid</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">learn_get_an_engine</span><span class="p">():</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: learn :: get_an_engine :: failed to get MySQL engine&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>

    <span class="k">def</span> <span class="nf">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: MySQL engine disposed of&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: calling engine.dispose()&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: no MySQL engine to dispose of&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># @added 20170112 - Feature #1854: Ionosphere learn - Redis ionosphere.learn.work namespace</span>
    <span class="c1"># Ionosphere learn needs Redis works sets</span>
    <span class="c1"># When a features profile is created there needs to be work added to a Redis</span>
    <span class="c1"># set</span>
    <span class="c1"># When a human makes a features profile, we want Ionosphere to make a</span>
    <span class="c1"># use_full_duration_days features profile valid_learning_duration (e.g.</span>
    <span class="c1"># 3361) later. Jack White style Redis work queue why not?  A departure from</span>
    <span class="c1"># check files the normal check files method, but this is fairly lite weight</span>
    <span class="c1"># in Redis terms.</span>
    <span class="c1"># @added 20170113 - Feature #1854: Ionosphere learn - Redis ionosphere.learn.work namespace</span>
    <span class="c1"># work_set and work deadlines</span>

    <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
        <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
    <span class="n">work_set</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.learn.work&#39;</span>
    <span class="n">learn_work</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">learn_work</span> <span class="o">=</span> <span class="n">redis_conn</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">work_set</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: got Redis </span><span class="si">%s</span><span class="s1"> set&#39;</span> <span class="o">%</span> <span class="n">work_set</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: could not query Redis for ionosphere.learn.work - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">work_set</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">learn_work</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: no work ready to be done&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">work_items_todo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">learn_work</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">work_items_todo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: no work do&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: work items in queue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">work_items_todo</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ionosphere_learn_work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">learn_work</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">learn_metric_list</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">ionosphere_learn_work</span><span class="p">)</span>
            <span class="c1"># @modified 20170308 - Feature #1960: ionosphere_layers</span>
            <span class="c1"># Not currently used</span>
            <span class="c1"># deadline = str(learn_metric_list[0])</span>
            <span class="n">work</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">learn_metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">learn_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;learn_fp_generation&#39;</span><span class="p">:</span>
                <span class="n">learn_parent_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">learn_generation</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: could not determine details from work item&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: checking work item - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)))</span>

        <span class="c1"># @added 20170127 - Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
        <span class="c1"># If the work is older than 7200 seconds</span>

        <span class="c1"># The metric learn work variables now known so we can process the metric</span>
        <span class="c1"># Determine the metric details from the database</span>
        <span class="n">metrics_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metric_db_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20170825 - Task #2132: Optimise Ionosphere DB usage</span>
        <span class="c1"># Get the metric db object data to memcache it is exists</span>
        <span class="n">metric_db_object</span> <span class="o">=</span> <span class="n">get_memcache_metric_object</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">learn_base_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metric_db_object</span><span class="p">:</span>
            <span class="n">metrics_id</span> <span class="o">=</span> <span class="n">metric_db_object</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># @modified 20170825 - Task #2132: Optimise Ionosphere DB usage</span>
            <span class="c1"># Only if no memcache data</span>
            <span class="c1"># Get a MySQL engine</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">learn_get_an_engine</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">log_msg</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: could not get a MySQL engine to get metric_db_object&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: engine not obtained to get metric_db_object&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as database may be available again before the work expires&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">metrics_id</span><span class="p">,</span> <span class="n">metric_db_object</span> <span class="o">=</span> <span class="n">get_metric_from_metrics</span><span class="p">(</span><span class="n">learn_base_name</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed get the metric details from the database&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as database may be available again before the work expires&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">metrics_id</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed get the metrics_id from the database&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as database may be available again before the work expires&#39;</span><span class="p">)</span>
                <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_db_object</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed get the metric_db_object from the database&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as database may be available again before the work expires&#39;</span><span class="p">)</span>
                <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="n">learn_valid_ts_older_than</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_learn_valid_ts_older_than</span> <span class="o">=</span> <span class="n">metric_db_object</span><span class="p">[</span><span class="s1">&#39;learn_valid_ts_older_than&#39;</span><span class="p">]</span>
            <span class="n">learn_valid_ts_older_than</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_learn_valid_ts_older_than</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed get the determine the learn_valid_ts_older_than from the metric_db_object&#39;</span><span class="p">)</span>
            <span class="n">use_full_duration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">learn_valid_ts_older_than</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as database may be available again before the work expires&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">time_check</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
        <span class="n">work_age</span> <span class="o">=</span> <span class="n">time_check</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">learn_metric_timestamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">work_age</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">learn_valid_ts_older_than</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: this work is not ready&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: this work is ready - work_age - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">work_age</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: processing </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">learn_base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)))</span>

        <span class="c1"># First learn checks if the metric_training_data_dir exists, if it does not</span>
        <span class="c1"># there is nothing to learn with.</span>
        <span class="n">metric_timeseries_dir</span> <span class="o">=</span> <span class="n">learn_base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">metric_training_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_metric_timestamp</span><span class="p">),</span>
            <span class="n">metric_timeseries_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_training_data_dir</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: cannot process as the training data directory no longer exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_training_data_dir</span><span class="p">))</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: metric_training_data_dir exists - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_training_data_dir</span><span class="p">))</span>

        <span class="c1"># If a learning directory does not exist, create it and populate it with the</span>
        <span class="c1"># training data directory image files and the check file, this is required</span>
        <span class="c1"># to ensure that the IONOSPHERE_DATA_FOLDER is not polluted and learn</span>
        <span class="c1"># namespace resources do not conflict with any training data resources a</span>
        <span class="c1"># learn directory is created.  As otherwise the new use_full_duration_days</span>
        <span class="c1"># transposed csv would overwrite the training data transposed csv</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;learn_fp_learnt&#39;</span><span class="p">:</span>
            <span class="n">metric_learn_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_FOLDER</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_metric_timestamp</span><span class="p">),</span>
                <span class="n">metric_timeseries_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metric_learn_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_metric_timestamp</span><span class="p">),</span>
                <span class="n">metric_timeseries_dir</span><span class="p">)</span>

        <span class="n">original_metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_training_data_dir</span><span class="p">,</span> <span class="n">learn_base_name</span><span class="p">)</span>
        <span class="n">metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_learn_data_dir</span><span class="p">,</span> <span class="n">learn_base_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_learn_data_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">metric_learn_data_dir</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: learning data dir created - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_learn_data_dir</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to create learning data dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_learn_data_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20170117 - Feature #1854: Ionosphere learn</span>
                <span class="c1"># This is causing a bug where if the check file or dir is</span>
                <span class="c1"># present shutil is creating a dir with the full learn/opt/skyline</span>
                <span class="c1"># path. TODO: fixed DONE</span>
                <span class="c1"># shutil.copy(original_metric_check_file, metric_learn_data_dir)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: reading original_metric_check_file to metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">original_metric_check_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fr</span><span class="p">:</span>
                            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to read original_metric_check_file&#39;</span> <span class="o">%</span> <span class="n">original_metric_check_file</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: writing metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: created metric_check_file from training data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">original_metric_check_file</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to write metric_check_file&#39;</span><span class="p">)</span>
            <span class="c1"># except shutil.Error as e:</span>
            <span class="c1">#    trace = traceback.format_exc()</span>
            <span class="c1">#    logger.error(&#39;%s&#39; % trace)</span>
            <span class="c1">#    logger.error(&#39;error :: learn :: shutil error - training data not copied to %s&#39; % metric_learn_data_dir)</span>
            <span class="c1">#    logger.error(&#39;error :: learn :: %s&#39; % (e))</span>
            <span class="c1"># # Any error saying that the directory doesn&#39;t exist</span>
            <span class="c1"># except OSError as e:</span>
            <span class="c1">#    trace = traceback.format_exc()</span>
            <span class="c1">#    logger.error(&#39;%s&#39; % trace)</span>
            <span class="c1">#    logger.error(&#39;error :: learn :: OSError error - training data not copied to %s&#39; % metric_learn_data_dir)</span>
            <span class="c1">#    logger.error(&#39;error :: %s&#39; % (e))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to write the metric_check_file&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;learn_fp_learnt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">metric_learn_data_dir</span><span class="p">):</span>
                <span class="n">data_files</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">glob_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/*.*&#39;</span> <span class="o">%</span> <span class="n">metric_training_data_dir</span>
                    <span class="n">data_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">glob_path</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: glob training data not copied to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_learn_data_dir</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i_file</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">:</span>
                    <span class="c1"># Only copy images, no data</span>
                    <span class="k">if</span> <span class="n">i_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">):</span>
                        <span class="n">copying_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i_file</span><span class="p">)</span>
                        <span class="n">dest_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_learn_data_dir</span><span class="p">,</span> <span class="n">copying_filename</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest_file</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">i_file</span><span class="p">,</span> <span class="n">metric_learn_data_dir</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: training data copied - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
                            <span class="k">except</span> <span class="n">shutil</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: shutil error - training data not copied to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_learn_data_dir</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">))</span>
                            <span class="c1"># Any error saying that the directory doesn&#39;t exist</span>
                            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: OSError error - training data not copied to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_learn_data_dir</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: training data not copied to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_learn_data_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: file not found - metric_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">)))</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">check_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: check_file_name - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_name</span><span class="p">)</span>
        <span class="n">check_file_timestamp</span> <span class="o">=</span> <span class="n">check_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: check_file_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">check_file_timestamp</span><span class="p">))</span>
        <span class="n">check_file_metricname_txt</span> <span class="o">=</span> <span class="n">check_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: check_file_metricname_txt - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_metricname_txt</span><span class="p">)</span>
        <span class="n">check_file_metricname</span> <span class="o">=</span> <span class="n">check_file_metricname_txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: check_file_metricname - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_metricname</span><span class="p">)</span>
        <span class="n">check_file_metricname_dir</span> <span class="o">=</span> <span class="n">check_file_metricname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: check_file_metricname_dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_file_metricname_dir</span><span class="p">)</span>

        <span class="n">metric_vars_array</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_vars_array</span> <span class="o">=</span> <span class="n">learn_load_metric_vars</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to load metric variables from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_vars_array</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: no metric_vars_array available from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Test metric variables</span>
        <span class="c1"># We use a pythonic methodology to test if the variables are defined,</span>
        <span class="c1"># this ensures that if any of the variables are not set for some reason</span>
        <span class="c1"># we can handle unexpected data or situations gracefully and try and</span>
        <span class="c1"># ensure that the process does not hang.</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;metric&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">metric</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: metric variable - metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to read metric variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to load metric variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># @modified 20170308 - Feature #1960: ionosphere_layers</span>
            <span class="c1"># Not currently used</span>
            <span class="c1"># anomalous_value = value</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: metric variable - value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to read value variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to load value variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;from_timestamp&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: metric variable - from_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to read from_timestamp variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>

        <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;metric_timestamp&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: metric variable - metric_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to read metric_timestamp variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_timestamp</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to load metric_timestamp variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># @added 20170117 - Feature #1854: Ionosphere learn - generations</span>
        <span class="c1"># This metric var is required as it was contirbuting to ionosphere_learn</span>
        <span class="c1"># not logging some 2nd generation work due to send_anomalous_metric_to</span>
        <span class="c1"># being sent ionosphere_learn which has no own logger per se</span>
        <span class="n">added_by</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;added_by&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">added_by</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: metric variable - added_by - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">added_by</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to read added_by variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">added_by</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">added_by</span><span class="p">:</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;added_at&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">added_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: metric variable - added_at - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">added_at</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to read added_at variable from check file setting to all - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">added_at</span> <span class="o">=</span> <span class="n">metric_timestamp</span>

        <span class="n">full_duration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;full_duration&#39;</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">metric_vars_array</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_IONOSPHERE_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: metric variable - full_duration - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_duration</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to read full_duration variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">full_duration</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">full_duration</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to determine full_duration variable from check file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_check_file</span><span class="p">))</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Before we continue, now that we have the actual metric_db_object</span>
        <span class="n">learn_full_duration_days</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">learn_full_duration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">use_full_duration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">learn_full_duration_days</span> <span class="o">=</span> <span class="n">metric_db_object</span><span class="p">[</span><span class="s1">&#39;learn_full_duration_days&#39;</span><span class="p">]</span>
            <span class="n">learn_full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86400</span>
            <span class="n">use_full_duration</span> <span class="o">=</span> <span class="n">learn_full_duration</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed get the determine the learn_full_duration_days from the metric_db_object&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as database may be available again before the work expires&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;learn_fp_learnt&#39;</span><span class="p">:</span>
            <span class="n">learn_metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_learn_data_dir</span><span class="p">,</span> <span class="n">check_file_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;learn_fp_learnt&#39;</span><span class="p">:</span>
            <span class="c1"># Write a new metric check file with the learn_full_duration</span>
            <span class="n">old_metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.original.training&#39;</span> <span class="o">%</span> <span class="n">metric_check_file</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">old_metric_check_file</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">metric_check_file</span><span class="p">,</span> <span class="n">old_metric_check_file</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: moving metric_check_file in the learning data dir&#39;</span><span class="p">)</span>
                    <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="n">learn_metric_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_learn_data_dir</span><span class="p">,</span> <span class="n">check_file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">learn_metric_check_file</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: reading metric_check_file to replace full_duration - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">old_metric_check_file</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">old_metric_check_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fr</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;full_duration&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">full_duration</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_full_duration</span><span class="p">))</span>
                            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to read metric_check_file&#39;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: writing learn_metric_check_file to replace full_duration - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">learn_metric_check_file</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">learn_metric_check_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to write learn_metric_check_file&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">learn_metric_check_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: learn_metric_check_file not created&#39;</span><span class="p">)</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># @added 20180811 - Bug #2506: nonNegativeDerivative applied twice in learn.py to existing json data</span>
        <span class="c1"># With the introduction of calculating the nonNegativeDerivative in both</span>
        <span class="c1"># Analyzer and Mirage before the initial analysis, both apps are now</span>
        <span class="c1"># passing the preprocessed time series to the send_anomalous_metric_to</span>
        <span class="c1"># function. However in skyline/ionosphere/learn.py the metric is still</span>
        <span class="c1"># being checked to determine if it is in derivative_metrics and the</span>
        <span class="c1"># nonNegativeDerivative function is being applied to the existing json</span>
        <span class="c1"># data, if the json data already exists. This is incorrect. It is</span>
        <span class="c1"># correct in the context of learn.py having to fetch the the data from</span>
        <span class="c1"># Graphite, however applying nonNegativeDerivative to existing json data</span>
        <span class="c1"># is incorrect and does not have the desired result.</span>
        <span class="n">preprocessed_learn_json_data_exists</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Create a learn json data if it does not exist</span>
        <span class="n">got_learn_json</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">learn_json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_learn_data_dir</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">learn_json_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: learning data ts json available - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">learn_json_file</span><span class="p">))</span>
            <span class="n">got_learn_json</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># @added 20180811 - Bug #2506: nonNegativeDerivative applied twice in learn.py to existing json data</span>
            <span class="n">preprocessed_learn_json_data_exists</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;learn :: need learning data ts json from Graphite at </span><span class="si">%s</span><span class="s1"> days - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">),</span> <span class="n">learn_json_file</span><span class="p">))</span>
                <span class="n">got_learn_json</span> <span class="o">=</span> <span class="n">get_learn_json</span><span class="p">(</span>
                    <span class="n">learn_json_file</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">use_full_duration</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span>
                    <span class="n">learn_full_duration_days</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: learn_json call failed&#39;</span><span class="p">)</span>
                <span class="n">got_learn_json</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">got_learn_json</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;error :: learn :: failed to get timeseries json from Graphite for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> second for anomaly at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_full_duration</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as Graphite may be available again before the work expires&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># @added 20170123 - Feature #1854: Ionosphere learn - generations</span>
        <span class="c1"># TODO</span>
        <span class="c1"># ionosphere_learn needs to test that use_full_duration_days data is available</span>
        <span class="c1"># before any use_full_duration_days features profiles are created a metric, this</span>
        <span class="c1"># ensures that newly added metrics are not learnt in the use_full_duration_days</span>
        <span class="c1"># until there is use_full_duration_days available</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">((</span><span class="n">learn_json_file</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># @modified 20170131 - Feature #1854: Ionosphere learn - generations</span>
                <span class="c1">#                      Feature #1886 Ionosphere learn - child like parent with evolutionary maturity</span>
                <span class="c1"># Corrected method</span>
                <span class="c1"># timeseries = json.loads(f.read())</span>
                <span class="n">raw_timeseries</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">timeseries_array_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw_timeseries</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">timeseries_array_str</span><span class="p">)</span>
                <span class="c1"># @modified 20180811 - Bug #2506: nonNegativeDerivative applied twice in learn.py to existing json data</span>
                <span class="c1"># Not required if the preprocessed json exists</span>
                <span class="c1"># datapoints = timeseries</span>

            <span class="c1"># @added 20180811 - Bug #2506: nonNegativeDerivative applied twice in learn.py to existing json data</span>
            <span class="c1"># Only calculate the derivative_timeseries if the preprocessed json</span>
            <span class="c1"># data did not exist and the data was fetched from Graphite by</span>
            <span class="c1"># wrapping the entire derivate block in this if condition</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">preprocessed_learn_json_data_exists</span><span class="p">:</span>

                <span class="c1"># @added 20170603 - Feature #2034: analyse_derivatives</span>
                <span class="c1"># Convert the values of metrics strictly increasing monotonically</span>
                <span class="c1"># to their deriative products</span>
                <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;derivative_metrics&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">derivative_metrics</span><span class="p">:</span>
                    <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">non_derivative_monotonic_metrics</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">NON_DERIVATIVE_MONOTONIC_METRICS</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">non_derivative_monotonic_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">skip_derivative</span> <span class="o">=</span> <span class="n">in_list</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">non_derivative_monotonic_metrics</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">skip_derivative</span><span class="p">:</span>
                        <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">derivative_timeseries</span> <span class="o">=</span> <span class="n">nonNegativeDerivative</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                        <span class="n">datapoints</span> <span class="o">=</span> <span class="n">derivative_timeseries</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: nonNegativeDerivative failed&#39;</span><span class="p">)</span>

                    <span class="n">validated_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">datapoint</span> <span class="ow">in</span> <span class="n">datapoints</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_datapoint</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                            <span class="n">validated_timeseries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_datapoint</span><span class="p">)</span>
                        <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
                        <span class="c1"># Added nosec to exclude from bandit tests</span>
                        <span class="k">except</span><span class="p">:</span>  <span class="c1"># nosec</span>
                            <span class="k">continue</span>
                    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">validated_timeseries</span>

                    <span class="c1"># @modified 20170129 - Bug #1898: Ionosphere - missing json</span>
                    <span class="c1"># logger.info(&#39;learn :: data points surfaced :: %s&#39; % (len(timeseries)))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: data points surfaced :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">))))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to read learning data ts json - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">learn_json_file</span><span class="p">))</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Tested and Graphite returns null, the Mirage json converted pattern</span>
        <span class="c1"># discards null.</span>
        <span class="c1"># [1483552680.0, 0.0]</span>
        <span class="c1"># gary@mc11:/tmp$ date -d @1483552680</span>
        <span class="c1"># Wed Jan  4 17:58:00 GMT 2017</span>
        <span class="c1"># gary@mc11:/tmp$</span>
        <span class="c1"># This should be 24 Dec 2016 as that is a request for 30 days data, so a simple check would be...</span>
        <span class="c1"># If first data point not on the first day of the use_full_duration_days then not valid to learn.</span>
        <span class="n">first_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to determine the first timestamp from learning data ts json - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">learn_json_file</span><span class="p">))</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">first_timestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: no first timestamp from learning data ts json - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">learn_json_file</span><span class="p">))</span>
            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># TODO still calculate age and discard if no data from the first day of</span>
        <span class="c1"># use_full_duration_days</span>

        <span class="c1"># Calculate the features and a features profile for the learn_json_file</span>
        <span class="n">calculated_feature_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.tsfresh.input.csv.features.transposed.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_learn_data_dir</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="n">calculated_feature_file_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fp_csv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">calculated_feature_file</span><span class="p">):</span>
            <span class="n">calculated_feature_file_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fp_csv</span> <span class="o">=</span> <span class="n">calculated_feature_file</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: calculated features file is available - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">calculated_feature_file</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">got_learn_json</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calculated_feature_file_found</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: need to calculate features from learning data ts json - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">learn_json_file</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fp_csv</span><span class="p">,</span> <span class="n">successful</span><span class="p">,</span> <span class="n">fp_exists</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">,</span> <span class="n">f_calc</span> <span class="o">=</span> <span class="n">calculate_features_profile</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to calculate features&#39;</span><span class="p">)</span>
                    <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: using available calculated features file&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">calculated_feature_file</span><span class="p">):</span>
            <span class="n">calculated_feature_file_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fp_csv</span> <span class="o">=</span> <span class="n">calculated_feature_file</span>

        <span class="c1"># @added 20170131 - Feature #1886 Ionosphere learn - child like parent with evolutionary maturity</span>
        <span class="n">allowed_to_learn</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20170116 - Feature #1854: Ionosphere learn - generations</span>
        <span class="c1"># Rate limit by generation and by max_percent_diff_from_origin</span>
        <span class="n">max_generations</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_max_generations</span> <span class="o">=</span> <span class="n">metric_db_object</span><span class="p">[</span><span class="s1">&#39;max_generations&#39;</span><span class="p">]</span>
            <span class="n">max_generations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_max_generations</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to determine the max_generations from the metric_db_object&#39;</span><span class="p">)</span>
            <span class="n">use_full_duration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">max_generations</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as database may be available again before the work expires&#39;</span><span class="p">)</span>
            <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;learn_fp_learnt&#39;</span> <span class="ow">and</span> <span class="n">calculated_feature_file_found</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">learn_generation</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_generations</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: learn :: a </span><span class="si">%s</span><span class="s1"> job has been added to try and create a </span><span class="si">%s</span><span class="s1"> generation features profile from features profile id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_generation</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_parent_id</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: learn :: a </span><span class="si">%s</span><span class="s1"> job was </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)))</span>
                <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_max_percent_diff_from_origin</span> <span class="o">=</span> <span class="n">metric_db_object</span><span class="p">[</span><span class="s1">&#39;max_percent_diff_from_origin&#39;</span><span class="p">]</span>
                <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_max_percent_diff_from_origin</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to determine the max_percent_diff_from_origin from the metric_db_object&#39;</span><span class="p">)</span>
                <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">max_percent_diff_from_origin</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as database may be available again before the work expires&#39;</span><span class="p">)</span>
                <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># The metric learn work variables now known so we can process the metric</span>
            <span class="c1"># Determine the metric details from the database</span>
            <span class="n">fp_ids</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @modified 20170804 - Bug #2130: MySQL - Aborted_clients</span>
            <span class="c1"># Set a conditional here to only get_an_engine if no engine, this</span>
            <span class="c1"># is probably responsible for the Aborted_clients, as it would have</span>
            <span class="c1"># left the accquired engine orphaned</span>
            <span class="c1"># Testing on skyline-dev-3-40g-gra1 Fri Aug  4 16:08:14 UTC 2017</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">engine</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># Get a MySQL engine</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">engine</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">learn_get_an_engine</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">log_msg</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: could not get a MySQL engine to get fp_ids_db_object&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: engine not obtained to get fp_ids_db_object&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as database may be available again before the work expires&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">fp_ids</span> <span class="o">=</span> <span class="n">get_ionosphere_fp_ids</span><span class="p">(</span><span class="n">learn_base_name</span><span class="p">,</span> <span class="n">metrics_id</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="c1"># learn_engine_disposal(engine)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed get the fp_ids from the database&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as database may be available again before the work expires&#39;</span><span class="p">)</span>
                <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># if not fp_ids:</span>
            <span class="k">if</span> <span class="n">fp_ids</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed get the fp_ids from the database&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work but not removing work item, as database may be available again before the work expires&#39;</span><span class="p">)</span>
                <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Determine the sum of the origin features profile which means</span>
            <span class="c1"># having to trace back from the learn_parent_id to the origin</span>
            <span class="n">origin_fp_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">origin_features_profile_sum</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># @modified 20170308 - Feature #1960: ionosphere_layers</span>
            <span class="c1"># Not currently used</span>
            <span class="c1"># origin_fp_full_duration = None</span>
            <span class="n">current_parent_id</span> <span class="o">=</span> <span class="n">learn_parent_id</span>
            <span class="n">current_generation</span> <span class="o">=</span> <span class="n">learn_generation</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_generation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: ionosphere_learn does not handle generation </span><span class="si">%s</span><span class="s1"> profiles&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_generation</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work and removing work item&#39;</span><span class="p">)</span>
                <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: determining the id and features sum value for the origin features profile from the fp_ids for fp id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_parent_id</span><span class="p">))</span>
            <span class="k">while</span> <span class="n">current_generation</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fp_id</span> <span class="ow">in</span> <span class="n">fp_ids</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_parent_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_id</span><span class="p">):</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="n">get_ionosphere_record</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span> <span class="n">engine</span><span class="p">)</span>
                            <span class="n">current_fp_parent_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">])</span>
                            <span class="n">current_fp_generation</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;generation&#39;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">current_fp_parent_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">origin_features_profile_sum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;features_sum&#39;</span><span class="p">])</span>
                                <span class="n">origin_fp_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_parent_id</span><span class="p">)</span>
                                <span class="c1"># @modified 20170308 - Feature #1960: ionosphere_layers</span>
                                <span class="c1"># Not currently used</span>
                                <span class="c1"># origin_fp_full_duration = int(row[&#39;full_duration&#39;])</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s1">&#39;learn :: origin fp id </span><span class="si">%s</span><span class="s1"> of generation </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">current_parent_id</span><span class="p">),</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">current_fp_generation</span><span class="p">)))</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s1">&#39;learn :: origin fp id features sum - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">origin_features_profile_sum</span><span class="p">)))</span>
                                <span class="n">current_generation</span> <span class="o">=</span> <span class="n">current_fp_generation</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: fp id </span><span class="si">%s</span><span class="s1"> of generation </span><span class="si">%s</span><span class="s1"> has parent fp id </span><span class="si">%s</span><span class="s1"> of generation </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">current_parent_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_generation</span><span class="p">),</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">current_fp_parent_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_fp_generation</span><span class="p">)))</span>
                                <span class="n">current_parent_id</span> <span class="o">=</span> <span class="n">current_fp_parent_id</span>
                                <span class="n">current_generation</span> <span class="o">=</span> <span class="n">current_fp_generation</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: determining parent id of the 0 generation origin&#39;</span><span class="p">)</span>
                        <span class="k">break</span>

            <span class="c1"># @added 20170131 - Feature #1886 Ionosphere learn - child like parent with evolutionary maturity</span>
            <span class="c1"># TODO: here a check may be required to evaluate whether the origin_fp_id</span>
            <span class="c1">#       had a use_full_duration features profile created, however</span>
            <span class="c1">#       due to the fact that it is in learn, suggests that it did</span>
            <span class="c1">#       have, not 100% sure.</span>
            <span class="n">child_use_full_duration_count_of_origin_fp_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
                <span class="c1"># Added nosec to exclude from bandit tests</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s1">&#39;SELECT COUNT(id) FROM ionosphere WHERE parent_id=</span><span class="si">%s</span><span class="s1"> AND full_duration=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">origin_fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_full_duration</span><span class="p">)))</span>  <span class="c1"># nosec</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">child_fp_count</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;COUNT(id)&#39;</span><span class="p">]</span>
                <span class="n">child_use_full_duration_count_of_origin_fp_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">child_fp_count</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: determining parent id of the 0 generation origin&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">child_use_full_duration_count_of_origin_fp_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: the origin_fp_id </span><span class="si">%s</span><span class="s1"> was allowed to learn, allowing to learn&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">origin_fp_id</span><span class="p">))</span>
                <span class="n">allowed_to_learn</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: the origin_fp_id </span><span class="si">%s</span><span class="s1"> was not allowed to learn, not allowing learning&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">origin_fp_id</span><span class="p">))</span>

            <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">origin_features_profile_sum</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: exiting this work and removing as the origin fp features sum could not be determined&#39;</span><span class="p">)</span>
                <span class="c1"># TODO: remove this just testing</span>
                <span class="c1"># remove_work_list_from_redis_set(learn_metric_list)</span>
                <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;learn :: the origin zero generation features profile </span><span class="si">%s</span><span class="s1"> - features_sum - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">origin_fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">origin_features_profile_sum</span><span class="p">)))</span>
            <span class="c1"># Determine the features sum from the training data features profile</span>
            <span class="c1"># details file</span>
            <span class="n">learnt_features_profile_details_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.fp.details.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">metric_learn_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                <span class="n">base_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">learnt_features_profile_details_file</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: the learnt features profile fp details file is no longer available - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">learnt_features_profile_details_file</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: cannot calculate the percent diff of the learnt features_profiles to the origin&#39;</span><span class="p">)</span>
                <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">learnt_fp_features_sum</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">learnt_features_profile_details_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">fp_details_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">fp_details_array</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">fp_details_str</span><span class="p">)</span>
                <span class="n">learnt_fp_features_sum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fp_details_array</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error: failed to read from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">learnt_features_profile_details_file</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">learnt_fp_features_sum</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: could not determine the features sum from the learnt features profile fp details file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">learnt_features_profile_details_file</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: cannot calculate the percent diff of the learnt features_profiles to the origin&#39;</span><span class="p">)</span>
                <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># TODO: base this on common features</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: checking the percent difference for the origin features sum&#39;</span><span class="p">)</span>
            <span class="n">percent_different</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">sums_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">origin_features_profile_sum</span><span class="p">,</span> <span class="n">learnt_fp_features_sum</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">calc_percent_different</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sums_array</span><span class="p">)</span> <span class="o">/</span> <span class="n">sums_array</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.</span>
                <span class="n">percent_different</span> <span class="o">=</span> <span class="n">calc_percent_different</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;learn :: percent_different between features sums of the learnt training data and origin fp_id </span><span class="si">%s</span><span class="s1"> is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">origin_fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">percent_different</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to calculate percent_different&#39;</span><span class="p">)</span>
                <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># Check that the max_percent_diff_from_origin is not breached</span>
            <span class="k">if</span> <span class="n">percent_different</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_pdiff</span> <span class="o">=</span> <span class="n">percent_different</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">percent_different</span> <span class="o">=</span> <span class="n">new_pdiff</span>

            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">percent_different</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;learn :: the calculated features sum breaches the max_percent_diff_from_origin of </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">),</span> <span class="n">base_name</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: cannot use training_data as a learnt features profile - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">learnt_features_profile_details_file</span><span class="p">)</span>
                <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="c1"># @modified 20170116 - Feature #1854: Ionosphere learn - generations</span>
        <span class="c1"># A features profile can be created in the learn_fp_human and in the</span>
        <span class="c1"># learn_fp_learnt context</span>
        <span class="c1"># if str(work) == &#39;learn_fp_human&#39; and calculated_feature_file_found:</span>
        <span class="n">create_a_learn_features_profile</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">calculated_feature_file_found</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;learn_fp_human&#39;</span><span class="p">:</span>
                <span class="n">create_a_learn_features_profile</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">profile_context</span> <span class="o">=</span> <span class="s1">&#39;human generated&#39;</span>
                <span class="n">ionosphere_job</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;learn_fp_automatic&#39;</span><span class="p">:</span>
                <span class="n">create_a_learn_features_profile</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">profile_context</span> <span class="o">=</span> <span class="s1">&#39;automatically generated&#39;</span>
                <span class="n">ionosphere_job</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;learn_fp_learnt&#39;</span><span class="p">:</span>
                <span class="n">create_a_learn_features_profile</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">profile_context</span> <span class="o">=</span> <span class="s1">&#39;automatically generated&#39;</span>
                <span class="n">ionosphere_job</span> <span class="o">=</span> <span class="s1">&#39;learn_fp_automatic&#39;</span>
                <span class="c1"># TODO: make Graphite NOW graphs.  A simple requests call?</span>

        <span class="c1"># @added 20170118 - Feature #1854: Ionosphere learn - generations</span>
        <span class="c1">#                   Feature #1842: Ionosphere - Graphite now graphs</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;learn_fp_learnt&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: requesting Ionosphere webapp training_data page to generate Graphite NOW graphs&#39;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">requests</span>
            <span class="c1"># @modified 20170122 - Feature #1854: Ionosphere learn - generations</span>
            <span class="c1">#                      Feature #1842: Ionosphere - Graphite now graphs</span>
            <span class="c1"># Corrected typos in url</span>
            <span class="c1"># url = &#39;%s/ionosphere?timestamp=%smetric=%s&#39; % (</span>
            <span class="c1">#    settings.SKYLINE_URL, str(learn_base_name), str(metric_timestamp))</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_base_name</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: training_data URL - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
            <span class="c1"># @modified 20170308 - Feature #1960: ionosphere_layers</span>
            <span class="c1"># Not currently used</span>
            <span class="c1"># ionosphere_resp = None</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER</span><span class="p">)</span>
                <span class="n">password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER_PASSWORD</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="c1"># @modified 20170308 - Feature #1960: ionosphere_layers</span>
                    <span class="c1"># Not currently used</span>
                    <span class="c1"># ionosphere_resp = True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: Graphite NOW graphs for training_data created&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get anomaly id from panorama: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">create_a_learn_features_profile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fp_csv</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: </span><span class="si">%s</span><span class="s1"> :: fp_csv for create_features_profile - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">profile_context</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_csv</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;learn_fp_learnt&#39;</span><span class="p">:</span>
                <span class="n">fp_created_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;learn_fp_learnt&#39;</span><span class="p">:</span>
                <span class="n">fp_created_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="n">metric_new_fp_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_FOLDER</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_created_at</span><span class="p">),</span>
                    <span class="n">metric_timeseries_dir</span><span class="p">)</span>

                <span class="c1"># Create a new timestamped directory at the timestamp that this features</span>
                <span class="c1"># profile is created</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metric_new_fp_data_dir</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: </span><span class="si">%s</span><span class="s1"> :: creating new timestamped learning dir - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">profile_context</span><span class="p">,</span> <span class="n">metric_new_fp_data_dir</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">metric_learn_data_dir</span><span class="p">,</span> <span class="n">metric_new_fp_data_dir</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: </span><span class="si">%s</span><span class="s1"> :: moved original learning dir to new timestamped learning dir&#39;</span> <span class="o">%</span> <span class="n">profile_context</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: </span><span class="si">%s</span><span class="s1"> :: failed to create the new features profile learn directory&#39;</span> <span class="o">%</span> <span class="n">profile_context</span><span class="p">)</span>
                        <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                        <span class="k">continue</span>

                <span class="n">original_fp_details_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.fp.details.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric_new_fp_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
                <span class="n">new_fp_details_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.fp.details.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric_new_fp_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_created_at</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">new_fp_details_file</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">original_fp_details_file</span><span class="p">,</span> <span class="n">new_fp_details_file</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: </span><span class="si">%s</span><span class="s1"> :: renaming features details file to the new timestamp&#39;</span> <span class="o">%</span> <span class="n">profile_context</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">new_fp_details_file</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: </span><span class="si">%s</span><span class="s1"> :: the new_fp_details_file does not exist - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">profile_context</span><span class="p">,</span> <span class="n">new_fp_details_file</span><span class="p">))</span>
                    <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: </span><span class="si">%s</span><span class="s1"> :: timestamped learning dir exists&#39;</span> <span class="o">%</span> <span class="n">profile_context</span><span class="p">)</span>

            <span class="c1"># Create a use_full_duration learn features profile</span>
            <span class="n">generation</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">learn_generation</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">generation</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_generations</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: learn :: </span><span class="si">%s</span><span class="s1"> :: not creating a features profile as it would breach max_generations as would be generation </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">profile_context</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">generation</span><span class="p">)))</span>
                <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: </span><span class="si">%s</span><span class="s1"> :: generation limit OK at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">profile_context</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">generation</span><span class="p">)))</span>

            <span class="c1"># @added 20170129 - Feature #1886 Ionosphere learn - child like parent with evolutionary maturity</span>
            <span class="c1"># Before a features profile can be created by a child, a check must</span>
            <span class="c1"># be made to determine if the parent was allowed to learn.  If a</span>
            <span class="c1"># features profile was initially created but not set to learn, then</span>
            <span class="c1"># the child should not pass learn either, by default, unless the</span>
            <span class="c1"># child features profile is later found to match a KNOWN learn</span>
            <span class="c1"># use_full_duration profile that DOES match.  At this point the</span>
            <span class="c1"># timeseries has reached maturity in its current state.  It could be</span>
            <span class="c1"># considered that the timeseries has achieved a more stable Active</span>
            <span class="c1"># Brownian Motion https://github.com/blue-yonder/tsfresh/pull/143#issuecomment-272314801</span>
            <span class="c1"># Whatever anomalies the operator did not want to ship in or learn</span>
            <span class="c1"># are no longer part of the use_full_duration_days profile.  At this</span>
            <span class="c1"># point even if the parent could not learn, other generations agree</span>
            <span class="c1"># that the current timeseries has now matured since the original</span>
            <span class="c1"># parent generation that use_full_duration_days is now normal.</span>
            <span class="c1"># At this point the generation restriction is removed and Skyline</span>
            <span class="c1"># can learn at use_full_duration_days as well.  Easier than it</span>
            <span class="c1"># sounds...</span>
            <span class="n">do_not_learn</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_to_learn</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: the origin parent was not allowed to learn so setting do_not_learn to True&#39;</span><span class="p">)</span>
                <span class="n">do_not_learn</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: the origin parent was allowed to learn so do_not_learn is set to False&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20170120 -  Feature #1854: Ionosphere learn - generations</span>
                <span class="c1"># Added fp_learn parameter to allow the user to not learn the</span>
                <span class="c1"># use_full_duration_days, this can be passed via the UI as False</span>
                <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># @added 20170129 - Feature #1886 Ionosphere learn - child like parent with evolutionary maturity</span>
                <span class="k">if</span> <span class="n">do_not_learn</span><span class="p">:</span>
                    <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">fp_id</span><span class="p">,</span> <span class="n">fp_in_successful</span><span class="p">,</span> <span class="n">fp_exists</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">create_features_profile</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">fp_created_at</span><span class="p">,</span> <span class="n">learn_base_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">ionosphere_job</span><span class="p">,</span> <span class="n">learn_parent_id</span><span class="p">,</span> <span class="n">generation</span><span class="p">,</span> <span class="n">fp_learn</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: </span><span class="si">%s</span><span class="s1"> :: failed to create a features profile&#39;</span> <span class="o">%</span> <span class="n">profile_context</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_in_successful</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: </span><span class="si">%s</span><span class="s1"> :: create_features_profile failed&#39;</span> <span class="o">%</span> <span class="n">profile_context</span><span class="p">)</span>
                <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;learn :: </span><span class="si">%s</span><span class="s1"> :: new generation </span><span class="si">%s</span><span class="s1"> features profile with id </span><span class="si">%s</span><span class="s1"> using </span><span class="si">%s</span><span class="s1"> days data based on the human generated parent feature profile with id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">profile_context</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">generation</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_parent_id</span><span class="p">)))</span>

            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># @added 20170116 - Feature #1854: Ionosphere learn - generations</span>
        <span class="c1"># This is it.  Here we go! Learn!</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;learn_fp_generation&#39;</span> <span class="ow">and</span> <span class="n">calculated_feature_file_found</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: fp_csv for create_features_profile - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_csv</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;learn :: adding an Ionosphere check file&#39;</span><span class="p">)</span>
            <span class="c1"># These are not required in the Ionosphere check context</span>
            <span class="n">triggered_algorithms</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># @modified 20170129 - Feature #1854: Ionosphere learn - generations</span>
            <span class="c1">#                      Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
            <span class="c1"># For learn_fp_generation the learn_parent_id is not set so set to 0</span>
            <span class="n">learn_parent_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">send_anomalous_metric_to</span><span class="p">(</span>
                    <span class="c1"># @modified 20170118 - Feature #1854: Ionosphere learn - generations</span>
                    <span class="c1"># Fixed bug, as the current_skyline_app must have a logger</span>
                    <span class="c1"># and added send_to_app as ionosphere_learn_to_ionosphere</span>
                    <span class="c1"># which is handled in the send_anomalous_metric_to function</span>
                    <span class="c1"># now.</span>
                    <span class="c1"># &#39;ionosphere_learn&#39;, &#39;ionosphere&#39;, metric_learn_data_dir,</span>
                    <span class="c1"># @modified 20170127 - Feature #1886: Ionosphere learn - child like parent with evolutionary maturity</span>
                    <span class="c1"># Added parent_id</span>
                    <span class="s1">&#39;ionosphere&#39;</span><span class="p">,</span> <span class="s1">&#39;ionosphere_learn_to_ionosphere&#39;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_learn_data_dir</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_timestamp</span><span class="p">),</span>
                    <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span>
                    <span class="n">triggered_algorithms</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_full_duration</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">learn_parent_id</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;learn :: ionosphere check added at </span><span class="si">%s</span><span class="s1"> full_duration for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">use_full_duration</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_csv</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: learn :: failed to send_anomalous_metric_to to Ionosphere at </span><span class="si">%s</span><span class="s1"> full_duration for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">use_full_duration</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_csv</span><span class="p">)))</span>

            <span class="n">remove_work_list_from_redis_set</span><span class="p">(</span><span class="n">learn_metric_list</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
        <span class="n">learn_engine_disposal</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">return</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2018, Gary Wilson.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.2.9-stable',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>