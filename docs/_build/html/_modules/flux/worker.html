<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>flux.worker &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">flux.worker</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for flux.worker</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">worker.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">kill</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">getpid</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="c1"># @modified 20191115 - Branch #3262: py3</span>
<span class="c1"># from multiprocessing import Queue, Process</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Empty</span>  <span class="c1"># Python 2.7</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span>  <span class="c1"># Python 3</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

<span class="c1"># @added 20201019 - Feature #3790: flux - pickle to Graphite</span>
<span class="c1"># bandit [B403:blacklist] Consider possible security implications associated</span>
<span class="c1"># with pickle module.  These have been considered.</span>
<span class="kn">import</span> <span class="nn">pickle</span>  <span class="c1"># nosec B403</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
<span class="c1"># Better handle multiple workers</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from redis import StrictRedis</span>
<span class="kn">import</span> <span class="nn">graphyte</span>
<span class="kn">import</span> <span class="nn">statsd</span>

<span class="kn">from</span> <span class="nn">logger</span> <span class="kn">import</span> <span class="n">set_up_logging</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>

<span class="c1"># @modified 20191115 - Branch #3262: py3</span>
<span class="c1"># This prevents flake8 E402 - module level import not at top of file</span>
<span class="n">load_settings</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">load_settings</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">settings</span>
    <span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="c1"># @modified 20220726 - Task #2732: Prometheus to Skyline</span>
        <span class="c1">#                      Branch #4300: prometheus</span>
        <span class="c1"># Moved send_graphite_metric</span>
        <span class="c1"># send_graphite_metric,</span>
        <span class="c1"># @added 20191111 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                   Branch #3262: py3</span>
        <span class="n">get_redis_conn</span><span class="p">,</span> <span class="n">get_redis_conn_decoded</span><span class="p">)</span>
    <span class="c1"># @added 20220429 - Feature #4536: Handle Redis failure</span>
    <span class="kn">from</span> <span class="nn">functions.flux.get_last_metric_data</span> <span class="kn">import</span> <span class="n">get_last_metric_data</span>
    <span class="c1"># @added 20220726 - Task #2732: Prometheus to Skyline</span>
    <span class="c1">#                   Branch #4300: prometheus</span>
    <span class="kn">from</span> <span class="nn">functions.graphite.send_graphite_metric</span> <span class="kn">import</span> <span class="n">send_graphite_metric</span>

<span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
<span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">functions.memcache.get_memcache_key</span> <span class="kn">import</span> <span class="n">get_memcache_key</span>
    <span class="kn">from</span> <span class="nn">functions.memcache.set_memcache_key</span> <span class="kn">import</span> <span class="n">set_memcache_key</span>
    <span class="kn">from</span> <span class="nn">functions.memcache.delete_memcache_key</span> <span class="kn">import</span> <span class="n">delete_memcache_key</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">get_memcache_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">set_memcache_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">delete_memcache_key</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># @modified 20191129 - Branch #3262: py3</span>
<span class="c1"># Consolidate flux logging</span>
<span class="c1"># logger = set_up_logging(&#39;worker&#39;)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_logging</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
    <span class="k">if</span> <span class="n">SERVER_METRIC_PATH</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SERVER_METRIC_PATH</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># @added 20200827 - Feature #3708: FLUX_ZERO_FILL_NAMESPACES</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_ZERO_FILL_NAMESPACES</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_ZERO_FILL_NAMESPACES</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_ZERO_FILL_NAMESPACES</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># added 20201016 - Feature #3788: snab_flux_load_test</span>
<span class="c1"># Wrap per metric logging in if FLUX_VERBOSE_LOGGING</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_VERBOSE_LOGGING</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_VERBOSE_LOGGING</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_VERBOSE_LOGGING</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># @added 20201018 - Feature #3798: FLUX_PERSIST_QUEUE</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_PERSIST_QUEUE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_PERSIST_QUEUE</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_PERSIST_QUEUE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20201020 - Feature #3796: FLUX_CHECK_LAST_TIMESTAMP</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_CHECK_LAST_TIMESTAMP</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_CHECK_LAST_TIMESTAMP</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_CHECK_LAST_TIMESTAMP</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">VISTA_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">VISTA_ENABLED</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VISTA_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20201120 - Feature #3796: FLUX_CHECK_LAST_TIMESTAMP</span>
<span class="c1">#                   Feature #3400: Identify air gaps in the metric data</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">IDENTIFY_AIRGAPS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IDENTIFY_AIRGAPS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">IDENTIFY_AIRGAPS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">parent_skyline_app</span> <span class="o">=</span> <span class="s1">&#39;flux&#39;</span>

<span class="c1"># @added 20191010 - Feature #3250: Allow Skyline to send metrics to another Carbon host</span>
<span class="c1"># Added missing skyline_app required for send_graphite_metric</span>
<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;flux&#39;</span>

<span class="n">skyline_app_graphite_namespace</span> <span class="o">=</span> <span class="s1">&#39;skyline.</span><span class="si">%s%s</span><span class="s1">.worker&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_skyline_app</span><span class="p">,</span> <span class="n">SERVER_METRIC_PATH</span><span class="p">)</span>

<span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
<span class="n">listen_graphite_namespace</span> <span class="o">=</span> <span class="s1">&#39;skyline.</span><span class="si">%s%s</span><span class="s1">.listen&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_skyline_app</span><span class="p">,</span> <span class="n">SERVER_METRIC_PATH</span><span class="p">)</span>

<span class="n">LOCAL_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SEND_TO_CARBON</span><span class="p">:</span>
    <span class="n">GRAPHITE_METRICS_PREFIX</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">CARBON_HOST</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_CARBON_HOST</span>
    <span class="n">CARBON_PORT</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_CARBON_PORT</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">graphyte</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">CARBON_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">CARBON_PORT</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: succeeded to graphyte.init with host: </span><span class="si">%s</span><span class="s1">, port: </span><span class="si">%s</span><span class="s1">, prefix: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">CARBON_HOST</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">CARBON_PORT</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">GRAPHITE_METRICS_PREFIX</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to run graphyte.init with host: </span><span class="si">%s</span><span class="s1">, port: </span><span class="si">%s</span><span class="s1">, prefix: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">CARBON_HOST</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">CARBON_PORT</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">GRAPHITE_METRICS_PREFIX</span><span class="p">)))</span>
<span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SEND_TO_STATSD</span><span class="p">:</span>
    <span class="n">STATSD_HOST</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_STATSD_HOST</span>
    <span class="n">STATSD_PORT</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_STATSD_PORT</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">statsd_conn</span> <span class="o">=</span> <span class="n">statsd</span><span class="o">.</span><span class="n">StatsClient</span><span class="p">(</span><span class="n">STATSD_HOST</span><span class="p">,</span> <span class="n">STATSD_PORT</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: initialized statsd.StatsClient with STATSD_HOST: </span><span class="si">%s</span><span class="s1">, STATSD_PORT: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">STATSD_HOST</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">STATSD_PORT</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to initialize statsd.StatsClient with STATSD_HOST: </span><span class="si">%s</span><span class="s1">, STATSD_PORT: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">STATSD_HOST</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">STATSD_PORT</span><span class="p">)))</span>


<div class="viewcode-block" id="Worker"><a class="viewcode-back" href="../../skyline.flux.html#flux.worker.Worker">[docs]</a><span class="k">class</span> <span class="nc">Worker</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The worker processes metric from the queue and sends them to Graphite.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">parent_pid</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Worker</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># @modified 20191115 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># if settings.REDIS_PASSWORD:</span>
        <span class="c1">#     self.redis_conn = StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self.redis_conn = StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
        <span class="c1"># @added 20191115 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                   Branch #3262: py3</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: get_redis_conn failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: get_redis_conn_decoded failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span> <span class="o">=</span> <span class="n">parent_pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">()</span>

<div class="viewcode-block" id="Worker.check_if_parent_is_alive"><a class="viewcode-back" href="../../skyline.flux.html#flux.worker.Worker.check_if_parent_is_alive">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_parent_is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Self explanatory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># @added 20201203 - Bug #3856: Handle boring sparsely populated metrics in derivative_metrics</span>
            <span class="c1"># Log warning</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;warning :: parent process is dead&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Worker.run"><a class="viewcode-back" href="../../skyline.flux.html#flux.worker.Worker.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the process intializes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">pickle_data_to_graphite</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>

            <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;!L&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">payload</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to pickle to send to Graphite&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">CARBON_HOST</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_CARBON_PICKLE_PORT</span><span class="p">))</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send pickle data to Graphite&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to pickle metric data into message&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="nf">submit_pickle_data_to_graphite</span><span class="p">(</span><span class="n">pickle_data</span><span class="p">):</span>

            <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">number_of_datapoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pickle_data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: could not determine number_of_datapoints from len(pickle_data) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">data_points_sent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">smallListOfMetricTuples</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tuples_added</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">pickle_data</span><span class="p">:</span>
                <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">smallListOfMetricTuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">tuples_added</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">tuples_added</span> <span class="o">&gt;=</span> <span class="mi">480</span><span class="p">:</span>
                        <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">pickle_data_sent</span> <span class="o">=</span> <span class="n">pickle_data_to_graphite</span><span class="p">(</span><span class="n">smallListOfMetricTuples</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: pickle_data_to_graphite error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                            <span class="n">pickle_data_sent</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="c1"># Reduce the speed of submissions to Graphite</span>
                        <span class="c1"># if there are lots of data points</span>
                        <span class="k">if</span> <span class="n">number_of_datapoints</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">:</span>
                            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">pickle_data_sent</span><span class="p">:</span>
                            <span class="n">data_points_sent</span> <span class="o">+=</span> <span class="n">tuples_added</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: sent </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> data points to Graphite via pickle&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">tuples_added</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_points_sent</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">number_of_datapoints</span><span class="p">)))</span>
                            <span class="n">smallListOfMetricTuples</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">tuples_added</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send </span><span class="si">%s</span><span class="s1"> data points to Graphite via pickle&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">tuples_added</span><span class="p">)))</span>
                            <span class="k">return</span> <span class="kc">False</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: error handling data in pickle_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">smallListOfMetricTuples</span><span class="p">:</span>
                <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tuples_to_send</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">smallListOfMetricTuples</span><span class="p">)</span>
                    <span class="n">pickle_data_sent</span> <span class="o">=</span> <span class="n">pickle_data_to_graphite</span><span class="p">(</span><span class="n">smallListOfMetricTuples</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pickle_data_sent</span><span class="p">:</span>
                        <span class="n">data_points_sent</span> <span class="o">+=</span> <span class="n">tuples_to_send</span>
                        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: sent the last </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> data points to Graphite via pickle&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">tuples_to_send</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_points_sent</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">number_of_datapoints</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to send the last </span><span class="si">%s</span><span class="s1"> data points to Graphite via pickle&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">tuples_to_send</span><span class="p">)))</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: error in smallListOfMetricTuples pickle_data_to_graphite - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
        <span class="k">def</span> <span class="nf">add_to_memcache_flux_workers_metrics_sent</span><span class="p">(</span><span class="n">metrics_to_add</span><span class="p">):</span>
            <span class="n">current_all_metrics_sent</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_all_metrics_sent</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">current_all_metrics_sent</span><span class="p">:</span>
                    <span class="n">current_all_metrics_sent</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: add_to_memcache_flux_workers_metrics_sent failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
                <span class="n">current_all_metrics_sent</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_all_metrics_sent</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">current_all_metrics_sent</span> <span class="o">+</span> <span class="n">metrics_to_add</span><span class="p">))</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">,</span> <span class="n">current_all_metrics_sent</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to add </span><span class="si">%s</span><span class="s1"> metrics to memcache flux.workers.metrics_sent while Redis unavailable&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_to_add</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">success</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: starting worker&#39;</span><span class="p">)</span>

        <span class="c1"># Determine a master worker that zerofills and last_known_value</span>
        <span class="n">worker_pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">()</span>
        <span class="n">main_process_pid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">main_process_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flux.main_process_pid&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">main_process_pid</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: main_process_pid found in Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">main_process_pid</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">main_process_pid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
        <span class="n">main_process_pid_from_memcache</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">main_process_pid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">main_process_pid</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.main_process_pid&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">main_process_pid</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: main_process_pid found in memcache key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">main_process_pid</span><span class="p">))</span>
                        <span class="n">main_process_pid_from_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">main_process_pid</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: could get flux.main_process_pid from memcache - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="n">main_process_pid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">main_process_pid</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: no main_process_pid known, exiting&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">primary_worker_key</span> <span class="o">=</span> <span class="s1">&#39;flux.primary_worker_pid.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">main_process_pid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: starting primary_worker election using primary_worker_key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">primary_worker_key</span><span class="p">)</span>
        <span class="n">sleep_for</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>  <span class="c1"># nosec B311</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: starting primary_worker election - sleeping for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sleep_for</span><span class="p">))</span>
        <span class="n">sleep</span><span class="p">(</span><span class="n">sleep_for</span><span class="p">)</span>
        <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">primary_worker_pid</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_pid found in Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.worker.primary_worker_key&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">primary_worker_pid</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_key found in memcache key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">primary_worker_pid</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: no primary_worker found, becoming primary_worker&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">worker_pid</span><span class="p">)</span>
                <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: set self pid to primary_worker - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.worker.primary_worker_key&#39;</span><span class="p">,</span> <span class="n">worker_pid</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.worker.primary_worker_key&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">primary_worker_pid</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_key found in memcache key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                                <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">primary_worker</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">primary_worker_pid</span> <span class="o">==</span> <span class="n">worker_pid</span><span class="p">:</span>
            <span class="n">primary_worker</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_pid is set to </span><span class="si">%s</span><span class="s1">, primary_worker: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker</span><span class="p">)))</span>

        <span class="n">last_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
        <span class="n">metrics_sent_to_graphite</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># @added 20200827 - Feature #3708: FLUX_ZERO_FILL_NAMESPACES</span>
        <span class="n">last_zero_fill_to_graphite</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">metrics_sent</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">remove_from_flux_queue_redis_set</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># @added 20201019 - Feature #3790: flux - pickle to Graphite</span>
        <span class="n">pickle_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># send_to_reciever = &#39;line&#39;</span>
        <span class="n">send_to_reciever</span> <span class="o">=</span> <span class="s1">&#39;pickle&#39;</span>

        <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_data_queue_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: could not determine metric_data_queue_size - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">metric_data_queue_size</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">metric_data_queue_size</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">send_to_reciever</span> <span class="o">=</span> <span class="s1">&#39;pickle&#39;</span>

        <span class="c1"># @added 202011120 - Feature #3790: flux - pickle to Graphite</span>
        <span class="c1"># Debug Redis set</span>
        <span class="n">metrics_data_sent</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># @added 20201020 - Feature #3796: FLUX_CHECK_LAST_TIMESTAMP</span>
        <span class="c1"># Even if flux.last Redis keys are disabled in flux they are used in</span>
        <span class="c1"># Vista</span>
        <span class="n">vista_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">FLUX_CHECK_LAST_TIMESTAMP</span> <span class="ow">and</span> <span class="n">VISTA_ENABLED</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vista_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sscan_iter</span><span class="p">(</span><span class="s1">&#39;vista.metrics&#39;</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">vista_metrics</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># @added 20210407 - Bug #4002: Change flux FLUX_ZERO_FILL_NAMESPACES to pickle</span>
        <span class="c1"># Set the variable to default</span>
        <span class="n">last_zero_fill_to_graphite</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
        <span class="n">sent_add_to_memcache</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_timed_out_empty_log</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

        <span class="c1"># Populate API keys and tokens in memcache</span>
        <span class="c1"># python-2.x and python3.x handle while 1 and while True differently</span>
        <span class="c1"># while 1:</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">running</span><span class="p">:</span>
            <span class="c1"># Make sure Redis is up</span>
            <span class="n">redis_up</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">redis_up</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">redis_up</span> <span class="ow">and</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: Redis has RECOVERED&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">redis_up</span><span class="p">:</span>
                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">continue</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;worker :: cannot connect to redis at socket path </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">))</span>
                        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># @modified 20191115 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># Use get_redis_conn and get_redis_conn_decoded</span>
                <span class="c1"># if settings.REDIS_PASSWORD:</span>
                <span class="c1">#     self.redis_conn = StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="c1"># else:</span>
                <span class="c1">#     self.redis_conn = StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">redis_up</span><span class="p">:</span>
                                <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: Redis connection established - RECOVERED&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">redis_up</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;worker :: Redis connection not established&#39;</span><span class="p">)</span>
                            <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: could not get_redis_conn - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: could not get_redis_conn_decoded - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                    <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                    <span class="n">redis_up</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: worker :: Redis is unavailable, no further Redis errors will be logged in this run, failed_over_to_memcache: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">failed_over_to_memcache</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_data_queue_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: debug :: flux.httpMetricDataQueue queue size - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data_queue_size</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to determine size of queue flux.httpMetricDataQueue&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
            <span class="c1"># Set this dictionary variable so it can be surfaced from memcache</span>
            <span class="c1"># and used in the event of a Redis failure</span>
            <span class="n">memcache_flux_last_metric_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">new_memcache_flux_last_metric_data</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">metric_data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get a metric from the queue with a 1 second timeout, each</span>
                <span class="c1"># metric item on the queue is a list e.g.</span>
                <span class="c1"># metric_data = [metricName, metricValue, metricTimestamp]</span>
                <span class="n">metric_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pickle_data</span><span class="p">:</span>
                    <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pickle_data_submitted</span> <span class="o">=</span> <span class="n">submit_pickle_data_to_graphite</span><span class="p">(</span><span class="n">pickle_data</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: queue Empty failed to submit_pickle_data_to_graphite - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                        <span class="n">pickle_data_submitted</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">pickle_data_submitted</span><span class="p">:</span>
                        <span class="n">pickle_data</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                    <span class="k">if</span> <span class="n">sent_add_to_memcache</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="n">add_to_memcache_flux_workers_metrics_sent</span><span class="p">(</span><span class="n">sent_add_to_memcache</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: added </span><span class="si">%s</span><span class="s1"> sent metrics to flux.workers.metrics_sent memcache key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sent_add_to_memcache</span><span class="p">)))</span>
                    <span class="n">sent_add_to_memcache</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="n">last_timed_out_empty_log</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: queue is empty and timed out, </span><span class="si">%s</span><span class="s1"> - primary_worker: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker</span><span class="p">)))</span>
                    <span class="n">last_timed_out_empty_log</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># @added 20201017 - Feature #3788: snab_flux_load_test</span>
                <span class="c1"># Send to Graphite even if worker gets no metrics</span>
                <span class="n">current_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">last_sent_to_graphite</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>

                    <span class="c1"># @added 20210407 - Bug #4002: Change flux FLUX_ZERO_FILL_NAMESPACES to pickle</span>
                    <span class="c1"># Added to FLUX_ZERO_FILL_NAMESPACES to the empty queue</span>
                    <span class="c1"># block as well as it was only execute in the final block</span>
                    <span class="c1"># which resulted in missing data if the loop exited on the</span>
                    <span class="c1"># empty queue.</span>
                    <span class="c1"># Send 0 for any metric in the flux.zero_fill_metrics Redis set that</span>
                    <span class="c1"># has not submitted data in the last 60 seconds.  The flux.last</span>
                    <span class="c1"># Redis key is not updated for these sent 0 values so if the source</span>
                    <span class="c1"># sends data for a timestamp in the period later (due to a lag, etc),</span>
                    <span class="c1"># it will be valid and sent to Graphite.</span>
                    <span class="c1"># @modified 20210406 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                    <span class="c1"># Now that the zero_fill setting can be passed in the</span>
                    <span class="c1"># FLUX_AGGREGATE_NAMESPACES settings check the Redis set</span>
                    <span class="c1"># if FLUX_ZERO_FILL_NAMESPACES:</span>
                    <span class="c1"># if not last_zero_fill_to_graphite:</span>
                    <span class="c1">#     last_zero_fill_to_graphite = current_time - 60</span>
                    <span class="k">if</span> <span class="n">primary_worker</span><span class="p">:</span>
                        <span class="n">flux_zero_fill_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">flux_zero_fill_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;flux.zero_fill_metrics&#39;</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to generate a list from flux.zero_fill_metrics Redis set&#39;</span><span class="p">)</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">flux_zero_fill_metrics</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.zero_fill_metrics&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">flux_zero_fill_metrics</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: flux_zero_fill_metrics found in memcache&#39;</span><span class="p">)</span>
                                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">flux_zero_fill_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">flux_zero_fill_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="c1"># @modified 20210408 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                        <span class="c1"># Use Redis set</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">all_metrics_sent</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to generate a list from flux.workers.metrics_sent Redis set&#39;</span><span class="p">)</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">all_metrics_sent</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">all_metrics_sent</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: all_metrics_sent found in memcache&#39;</span><span class="p">)</span>
                                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">all_metrics_sent</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">all_metrics_sent</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                        <span class="n">metrics_which_were_zero_filled</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="k">for</span> <span class="n">flux_zero_fill_metric</span> <span class="ow">in</span> <span class="n">flux_zero_fill_metrics</span><span class="p">:</span>
                            <span class="c1"># if flux_zero_fill_metric not in metrics_sent:</span>
                            <span class="k">if</span> <span class="n">flux_zero_fill_metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_metrics_sent</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">tuple_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_zero_fill_metric</span><span class="p">,</span> <span class="p">(</span><span class="n">last_sent_to_graphite</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                                    <span class="n">pickle_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tuple_data</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: zero fill - added </span><span class="si">%s</span><span class="s1"> to pickle_data&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tuple_data</span><span class="p">)))</span>
                                    <span class="n">metrics_sent_to_graphite</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">metrics_sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_zero_fill_metric</span><span class="p">)</span>
                                    <span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                                    <span class="c1"># Better handle multiple workers</span>
                                    <span class="c1"># @modified 20220428 - Feature #4536: Handle Redis failure</span>
                                    <span class="c1"># Do in 1 requests and use memcache if fail</span>
                                    <span class="c1"># try:</span>
                                    <span class="c1">#     self.redis_conn.sadd(&#39;flux.workers.metrics_sent&#39;, flux_zero_fill_metric)</span>
                                    <span class="c1"># except:</span>
                                    <span class="c1">#     pass</span>
                                    <span class="n">metrics_which_were_zero_filled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_zero_fill_metric</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: zero fill - failed to add metric data to pickle for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">flux_zero_fill_metric</span><span class="p">))</span>
                                    <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                        <span class="k">if</span> <span class="n">metrics_which_were_zero_filled</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_which_were_zero_filled</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">success</span> <span class="o">=</span> <span class="n">add_to_memcache_flux_workers_metrics_sent</span><span class="p">(</span><span class="n">metrics_which_were_zero_filled</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to add </span><span class="si">%s</span><span class="s1"> zero filled metrics to memcache flux.workers.metrics_sent as Redis unavailable - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_which_were_zero_filled</span><span class="p">)),</span> <span class="n">err</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: added </span><span class="si">%s</span><span class="s1"> zero filled metrics to memcache flux.workers.metrics_sent as Redis unavailable&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_which_were_zero_filled</span><span class="p">)))</span>
                                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="n">last_zero_fill_to_graphite</span> <span class="o">=</span> <span class="n">current_time</span>

                        <span class="n">flux_last_known_value_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">flux_last_known_value_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;flux.last_known_value_metrics&#39;</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to generate a list from flux.last_known_value_metrics Redis set&#39;</span><span class="p">)</span>
                            <span class="n">flux_last_known_value_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">flux_last_known_value_metrics</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.last_known_value_metrics&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">flux_last_known_value_metrics</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: lux_last_known_value_metrics found in memcache&#39;</span><span class="p">)</span>
                                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">flux_last_known_value_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">flux_last_known_value_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                        <span class="n">metrics_which_were_last_known_value_filled</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="k">for</span> <span class="n">flux_last_known_value_metric</span> <span class="ow">in</span> <span class="n">flux_last_known_value_metrics</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">flux_last_known_value_metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics_sent</span><span class="p">:</span>
                                <span class="n">last_known_value</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">last_known_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;flux.last_known_value&#39;</span><span class="p">,</span> <span class="n">flux_last_known_value_metric</span><span class="p">))</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                        <span class="c1"># logger.error(traceback.format_exc())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: last_known_value - failed to get last known value for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">flux_last_known_value_metric</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                                    <span class="n">last_known_value</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">memcache_flux_last_metric_data</span><span class="p">:</span>
                                            <span class="c1"># Only check once and fail once</span>
                                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">memcache_flux_last_metric_data</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">:</span>
                                                <span class="k">try</span><span class="p">:</span>
                                                    <span class="n">memcache_flux_last_metric_data</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.last.metric_data&#39;</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">memcache_flux_last_metric_data</span><span class="p">:</span>
                                                        <span class="c1"># Only check once and fail once</span>
                                                        <span class="n">memcache_flux_last_metric_data</span> <span class="o">=</span> <span class="kc">False</span>
                                                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: worker :: get_memcache_key flux.last.metric_data no data found&#39;</span><span class="p">)</span>
                                                    <span class="k">else</span><span class="p">:</span>
                                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: get_memcache_key flux.last.metric_data data loaded&#39;</span><span class="p">)</span>
                                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: get_memcache_key failed for flux.last.metric_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                        <span class="n">err</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="n">memcache_flux_last_metric_data</span><span class="p">:</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">last_known_value</span> <span class="o">=</span> <span class="n">memcache_flux_last_metric_data</span><span class="p">[</span><span class="n">flux_last_known_value_metric</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                                <span class="n">last_known_value</span> <span class="o">=</span> <span class="kc">None</span>

                                <span class="k">if</span> <span class="n">last_known_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">tuple_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_last_known_value_metric</span><span class="p">,</span> <span class="p">(</span><span class="n">last_sent_to_graphite</span><span class="p">,</span> <span class="n">last_known_value</span><span class="p">))</span>
                                        <span class="n">pickle_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tuple_data</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: last_known_value - added </span><span class="si">%s</span><span class="s1"> to pickle_data&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tuple_data</span><span class="p">)))</span>
                                        <span class="n">metrics_sent_to_graphite</span> <span class="o">+=</span> <span class="mi">1</span>
                                        <span class="n">metrics_sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_last_known_value_metric</span><span class="p">)</span>
                                        <span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                                        <span class="c1"># Better handle multiple workers</span>
                                        <span class="c1"># @modified 20220428 - Feature #4536: Handle Redis failure</span>
                                        <span class="c1"># Do in 1 requests and use memcache if fail</span>
                                        <span class="c1"># try:</span>
                                        <span class="c1">#     self.redis_conn.sadd(&#39;flux.workers.metrics_sent&#39;, flux_last_known_value_metric)</span>
                                        <span class="c1"># except:</span>
                                        <span class="c1">#     pass</span>
                                        <span class="n">metrics_which_were_last_known_value_filled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_last_known_value_metric</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: last_known_value - failed to add metric data to pickle for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">flux_last_known_value_metric</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                        <span class="k">if</span> <span class="n">metrics_which_were_last_known_value_filled</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_which_were_last_known_value_filled</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to generate a list from flux.last_known_value_metrics Redis set&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">success</span> <span class="o">=</span> <span class="n">add_to_memcache_flux_workers_metrics_sent</span><span class="p">(</span><span class="n">metrics_which_were_last_known_value_filled</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to add </span><span class="si">%s</span><span class="s1"> last known value filled metrics to memcache flux.workers.metrics_sent as Redis unavailable - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_which_were_zero_filled</span><span class="p">)),</span> <span class="n">err</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: added </span><span class="si">%s</span><span class="s1"> last known value filled metrics to memcache flux.workers.metrics_sent as Redis unavailable&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_which_were_zero_filled</span><span class="p">)))</span>
                                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: metrics_sent_to_graphite in last 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sent_to_graphite</span><span class="p">))</span>
                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.metrics_sent_to_graphite&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                    <span class="k">if</span> <span class="n">primary_worker</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20191008 - Feature #3250: Allow Skyline to send metrics to another Carbon host</span>
                            <span class="c1"># graphyte.send(skyline_metric, metrics_sent_to_graphite, time_now)</span>
                            <span class="c1"># @modified 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                            <span class="c1"># Better handle multiple workers get count from the key</span>
                            <span class="c1"># send_graphite_metric(self, skyline_app, skyline_metric, metrics_sent_to_graphite)</span>
                            <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metrics_sent_to_graphite</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                                <span class="c1"># all_metrics_sent_to_graphite = len(list(self.redis_conn_decoded.smembers(&#39;flux.workers.metrics_sent&#39;)))</span>
                                <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">)</span>
                                <span class="c1"># @modified 20220427 - Feature #4536: Handle Redis failure</span>
                                <span class="c1"># Add flux required data to memcache as well</span>
                                <span class="c1"># self.redis_conn.delete(&#39;flux.workers.metrics_sent&#39;)</span>
                                <span class="c1"># @modified 20220510 - Feature #3824: get_cluster_data</span>
                                <span class="c1">#                      Release #4562 - v3.0.4</span>
                                <span class="c1"># Only rename if exists</span>
                                <span class="k">if</span> <span class="n">all_metrics_sent_to_graphite</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.flux.workers.metrics_sent&#39;</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="c1"># pass</span>
                                <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to generate a list from flux.workers.metrics_sent Redis set&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">all_metrics_sent_to_graphite</span><span class="p">:</span>
                                            <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_metrics_sent_to_graphite</span><span class="p">)</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: all_metrics_sent_to_graphite found in flux.workers.metrics_sent memcache key&#39;</span><span class="p">)</span>
                                            <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">success</span> <span class="o">=</span> <span class="n">delete_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">)</span>
                                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to delete memcache key flux.workers.metrics_sent - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                    <span class="n">err</span><span class="p">))</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get memcache key flux.workers.metrics_sent - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">err</span><span class="p">))</span>
                                        <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metrics_sent_to_graphite</span><span class="p">)</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">all_metrics_sent_to_graphite</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: all_metrics_sent_to_graphite in last 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_metrics_sent_to_graphite</span><span class="p">))</span>
                            <span class="n">last_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                            <span class="n">metrics_sent_to_graphite</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sent_to_graphite</span><span class="p">)))</span>

                        <span class="c1"># @added 20220329 - Feature #4018: thunder - skyline.errors</span>
                        <span class="c1"># Report app up</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;flux.worker&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set flux.worker Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">err</span><span class="p">))</span>

                        <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># use_backfill = False</span>
                        <span class="c1"># timestamp_for_metrics = int(time())</span>
                        <span class="n">discarded_already_received</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.already_received&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                            <span class="c1"># discarded_already_received = len(list(self.redis_conn_decoded.smembers(&#39;flux.workers.discarded.already_received&#39;)))</span>
                            <span class="n">discarded_already_received</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.workers.discarded.already_received&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.workers.discarded.already_received&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.workers.discarded.already_received - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: discarded_already_received in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">discarded_already_received</span><span class="p">))</span>
                        <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="c1"># skyline_metric_data = [skyline_metric, discarded_already_received, timestamp_for_metrics, use_backfill]</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                        <span class="c1"># except Exception as e:</span>
                        <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                        <span class="c1">#         str(metric_data), e))</span>
                        <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">discarded_already_received</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">discarded_already_received</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                        <span class="n">listen_discarded_invalid_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.invalid_timestamp&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                            <span class="c1"># listen_discarded_invalid_timestamp = len(list(self.redis_conn_decoded.smembers(&#39;flux.listen.discarded.invalid_timestamp&#39;)))</span>
                            <span class="n">listen_discarded_invalid_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_timestamp&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_timestamp&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.discarded.invalid_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_discarded_invalid_timestamp in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_timestamp</span><span class="p">))</span>
                        <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_invalid_timestamp, timestamp_for_metrics, use_backfill]</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                        <span class="c1"># except Exception as e:</span>
                        <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                        <span class="c1">#         str(metric_data), e))</span>
                        <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_discarded_invalid_timestamp</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_timestamp</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                        <span class="n">listen_discarded_metric_name</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.metric_name&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                            <span class="c1"># listen_discarded_metric_name = len(list(self.redis_conn_decoded.smembers(&#39;flux.listen.discarded.metric_name&#39;)))</span>
                            <span class="n">listen_discarded_metric_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.metric_name&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.metric_name&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.discarded.metric_name - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_discarded_metric_name in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_metric_name</span><span class="p">))</span>
                        <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_metric_name, timestamp_for_metrics, use_backfill]</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                        <span class="c1"># except Exception as e:</span>
                        <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                        <span class="c1">#         str(metric_data), e))</span>
                        <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_discarded_metric_name</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_metric_name</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                        <span class="n">listen_discarded_invalid_value</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.invalid_value&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                            <span class="c1"># listen_discarded_invalid_value = len(list(self.redis_conn_decoded.smembers(&#39;flux.listen.discarded.invalid_value&#39;)))</span>
                            <span class="n">listen_discarded_invalid_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_value&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_value&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.discarded.invalid_value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_discarded_invalid_value in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_value</span><span class="p">))</span>
                        <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_metric_name, timestamp_for_metrics, use_backfill]</span>
                        <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_invalid_value, timestamp_for_metrics, use_backfill]</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                        <span class="c1"># except Exception as e:</span>
                        <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                        <span class="c1">#         str(metric_data), e))</span>
                        <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_discarded_invalid_value</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_value</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                        <span class="n">listen_discarded_invalid_key</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.invalid_key&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                            <span class="c1"># listen_discarded_invalid_key = len(list(self.redis_conn_decoded.smembers(&#39;flux.listen.discarded.invalid_key&#39;)))</span>
                            <span class="n">listen_discarded_invalid_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_key&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_key&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.discarded.invalid_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_discarded_invalid_key in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_key</span><span class="p">))</span>
                        <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_invalid_key, timestamp_for_metrics, use_backfill]</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                        <span class="c1"># except Exception as e:</span>
                        <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                        <span class="c1">#         str(metric_data), e))</span>
                        <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_discarded_invalid_key</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_key</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                        <span class="n">listen_discarded_invalid_parameters</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.invalid_parameters&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                            <span class="c1"># listen_discarded_invalid_parameters = len(list(self.redis_conn_decoded.smembers(&#39;flux.listen.discarded.invalid_parameters&#39;)))</span>
                            <span class="n">listen_discarded_invalid_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.discarded.invalid_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_discarded_invalid_parameters in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_parameters</span><span class="p">))</span>
                        <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_invalid_parameters, timestamp_for_metrics, use_backfill]</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                        <span class="c1"># except Exception as e:</span>
                        <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                        <span class="c1">#         str(metric_data), e))</span>
                        <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_discarded_invalid_parameters</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_parameters</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                        <span class="n">listen_added_to_queue</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.added_to_queue&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">listen_added_to_queue_str</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="c1"># @modified 20230205 - Task #4844: Replace Redis getset with set with get</span>
                            <span class="c1"># As of Redis version 6.2.0, this command is regarded as deprecated.</span>
                            <span class="c1"># It can be replaced by SET with the GET argument when migrating or writing new code.</span>
                            <span class="c1"># listen_added_to_queue_str = self.redis_conn_decoded.getset(&#39;flux.listen.added_to_queue&#39;, 0)</span>
                            <span class="n">listen_added_to_queue_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flux.listen.added_to_queue&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">listen_added_to_queue_str</span><span class="p">:</span>
                                <span class="n">listen_added_to_queue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">listen_added_to_queue_str</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis key flux.listen.added_to_queue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">listen_added_to_queue</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.listen.added_to_queue&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">listen_added_to_queue</span><span class="p">:</span>
                                        <span class="n">listen_added_to_queue</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">listen_added_to_queue</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">if</span> <span class="n">listen_added_to_queue</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">success</span> <span class="o">=</span> <span class="n">delete_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;flux.listen.added_to_queue&#39;</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to delete memcache flux.listen.added_to_queue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: deleted flux.listen.added_to_queue memcache key as Redis available&#39;</span><span class="p">)</span>

                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_added_to_queue in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_added_to_queue</span><span class="p">))</span>
                        <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="c1"># skyline_metric_data = [skyline_metric, listen_added_to_queue, timestamp_for_metrics, use_backfill]</span>
                        <span class="c1"># try:</span>
                        <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                        <span class="c1"># except Exception as e:</span>
                        <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                        <span class="c1">#         str(metric_data), e))</span>
                        <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                        <span class="c1"># via flux queue which could send to a different Graphite</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_added_to_queue</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_added_to_queue</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                        <span class="c1"># @added 20220302 - Feature #4400: flux - quota</span>
                        <span class="c1"># If there are flux namespace quotas add a metric to track</span>
                        <span class="c1"># over quota count and dropped_non_numeric_metrics</span>
                        <span class="n">flux_namespace_quotas</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">flux_namespace_quotas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to hgetall metrics_manager.flux.namespace_quotas - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">flux_namespace_quotas</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">flux_namespace_quotas</span><span class="p">:</span>
                                        <span class="n">flux_namespace_quotas</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">flux_namespace_quotas</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">flux_namespace_quotas</span><span class="p">:</span>
                            <span class="n">over_quota_count</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.over_quota_metrics_count&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">over_quota_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">over_quota_count</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.over_quota.rejected_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                                <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">over_quota_count_list</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">over_quota_count_list</span><span class="p">:</span>
                                            <span class="n">over_quota_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">over_quota_count</span><span class="p">)</span>
                                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">success</span> <span class="o">=</span> <span class="n">delete_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">)</span>
                                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to delete memcache flux.listen.over_quota.rejected_metrics key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: deleted flux.listen.over_quota.rejected_metrics memcache key&#39;</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">over_quota_count</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">over_quota_count</span> <span class="o">=</span> <span class="mi">0</span>

                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen namespaces over_quota metric count in last 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">over_quota_count</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">over_quota_count</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">over_quota_count</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">dropped_non_numeric_metrics_count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.dropped_non_numeric_metrics&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dropped_non_numeric_metrics_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.dropped_non_numeric_metrics&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">dropped_non_numeric_metrics_count</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;flux.listen.dropped_non_numeric_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.flux.listen.dropped_non_numeric_metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.dropped_non_numeric_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen dropped_non_numeric_metrics count in last 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dropped_non_numeric_metrics_count</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">dropped_non_numeric_metrics_count</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dropped_non_numeric_metrics_count</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

                        <span class="c1"># @added 20220303 - Feature #4400: flux - quota</span>
                        <span class="n">listen_added_to_aggregation_queue</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.added_to_aggregation_queue&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">listen_added_to_aggregation_queue</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="c1"># @modified 20230205 - Task #4844: Replace Redis getset with set with get</span>
                            <span class="c1"># As of Redis version 6.2.0, this command is regarded as deprecated.</span>
                            <span class="c1"># It can be replaced by SET with the GET argument when migrating or writing new code.</span>
                            <span class="c1"># listen_added_to_aggregation_queue_str = self.redis_conn_decoded.getset(&#39;flux.listen.added_to_aggregation_queue&#39;, 0)</span>
                            <span class="n">listen_added_to_aggregation_queue_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flux.listen.added_to_aggregation_queue&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">listen_added_to_aggregation_queue_str</span><span class="p">:</span>
                                <span class="n">listen_added_to_aggregation_queue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">listen_added_to_aggregation_queue_str</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.added_to_aggregation_queue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen added_to_aggregation_queue in last 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_added_to_aggregation_queue</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_added_to_aggregation_queue</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_added_to_aggregation_queue</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

                    <span class="n">metric_data_queue_size</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_data_queue_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: flux.httpMetricDataQueue queue size - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data_queue_size</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to determine size of queue flux.httpMetricDataQueue&#39;</span><span class="p">)</span>
                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.httpMetricDataQueue.size&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                    <span class="k">if</span> <span class="n">primary_worker</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">metric_data_queue_size</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sent_to_graphite</span><span class="p">)))</span>
                    <span class="c1"># @added 20201019 - Feature #3790: flux - pickle to Graphite</span>
                    <span class="k">if</span> <span class="n">metric_data_queue_size</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">send_to_reciever</span> <span class="o">=</span> <span class="s1">&#39;pickle&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">send_to_reciever</span> <span class="o">=</span> <span class="s1">&#39;line&#39;</span>
                    <span class="n">send_to_reciever</span> <span class="o">=</span> <span class="s1">&#39;pickle&#39;</span>

                    <span class="c1"># @added 202011120 - Feature #3790: flux - pickle to Graphite</span>
                    <span class="c1"># Debug Redis set</span>
                    <span class="n">metrics_data_sent_strs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">metrics_data_sent</span><span class="p">:</span>
                        <span class="n">metrics_data_sent_strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">metrics_data_sent_strs</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.metrics_data_sent&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_data_sent_strs</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: added </span><span class="si">%s</span><span class="s1"> items to the flux.metrics_data_sent Redis set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_data_sent</span><span class="p">)))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to determine size of flux.queue Redis set&#39;</span><span class="p">)</span>
                        <span class="n">metrics_data_sent</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_set</span> <span class="o">=</span> <span class="s1">&#39;aet.flux.metrics_data_sent.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to current_pid for aet.flux.metrics_data_sent Redis set name&#39;</span><span class="p">)</span>
                            <span class="n">new_set</span> <span class="o">=</span> <span class="s1">&#39;aet.flux.metrics_data_sent&#39;</span>
                        <span class="k">if</span> <span class="n">primary_worker</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;flux.metrics_data_sent&#39;</span><span class="p">,</span> <span class="n">new_set</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: renamed flux.metrics_data_sent Redis set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">new_set</span><span class="p">)</span>
                            <span class="c1"># @added 20201128 - Feature #3820: HORIZON_SHARDS</span>
                            <span class="c1"># With metrics that come in at a frequency of less</span>
                            <span class="c1"># than 60 seconds, it is possible that this key will</span>
                            <span class="c1"># not exist as flux has not been sent metric data</span>
                            <span class="c1"># so this operation will error with no such key</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">traceback_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="s1">&#39;no such key&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;warning :: worker :: failed to rename flux.metrics_data_sent to </span><span class="si">%s</span><span class="s1"> Redis set - flux has not recieved data in 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback_str</span><span class="p">)</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to rename flux.metrics_data_sent to </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="n">new_set</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">new_set</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set 600 seconds TTL on </span><span class="si">%s</span><span class="s1"> Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                    <span class="c1"># @added 20201018 - Feature #3798: FLUX_PERSIST_QUEUE</span>
                    <span class="k">if</span> <span class="n">FLUX_PERSIST_QUEUE</span><span class="p">:</span>
                        <span class="n">redis_set_size</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_set_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.queue&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to determine size of flux.queue Redis set&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker - flux.queue Redis set size of </span><span class="si">%s</span><span class="s1"> before removal of </span><span class="si">%s</span><span class="s1"> items&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">redis_set_size</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_from_flux_queue_redis_set</span><span class="p">))))</span>
                        <span class="k">if</span> <span class="n">remove_from_flux_queue_redis_set</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;flux.queue&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_from_flux_queue_redis_set</span><span class="p">))</span>
                                <span class="n">remove_from_flux_queue_redis_set</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to remove multiple items from flux.queue Redis set&#39;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">redis_set_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.queue&#39;</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to determine size of flux.queue Redis set&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker - flux.queue Redis set size of </span><span class="si">%s</span><span class="s1"> after the removal of items&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">redis_set_size</span><span class="p">)))</span>
                            <span class="n">remove_from_flux_queue_redis_set</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># @added 20201020 - Feature #3796: FLUX_CHECK_LAST_TIMESTAMP</span>
                    <span class="c1"># Even if flux.last Redis keys are disabled in flux they are used in</span>
                    <span class="c1"># Vista</span>
                    <span class="n">vista_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">FLUX_CHECK_LAST_TIMESTAMP</span> <span class="ow">and</span> <span class="n">VISTA_ENABLED</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">vista_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sscan_iter</span><span class="p">(</span><span class="s1">&#39;vista.metrics&#39;</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">vista_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># @added 20210407 - Bug #4002: Change flux FLUX_ZERO_FILL_NAMESPACES to pickle</span>
                    <span class="c1"># Reset metrics_sent</span>
                    <span class="n">metrics_sent</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">primary_worker_pid</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_pid found in Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.worker.primary_worker_key&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">primary_worker_pid</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_key found in memcache key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                                    <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">primary_worker_pid</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: no primary_worker found, taking role&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">worker_pid</span><span class="p">)</span>
                            <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: set self pid to primary_worker - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.worker.primary_worker_key&#39;</span><span class="p">,</span> <span class="n">worker_pid</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set memcache primary_worker_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                    <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="n">worker_pid</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_key set in memcache primary_worker_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">primary_worker_pid</span> <span class="ow">and</span> <span class="n">primary_worker</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">primary_worker_pid</span> <span class="o">!=</span> <span class="n">worker_pid</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker role has been taken over by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                            <span class="n">primary_worker</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">primary_worker_pid</span> <span class="o">==</span> <span class="n">worker_pid</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">primary_worker</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: taking over primary_worker role&#39;</span><span class="p">)</span>
                        <span class="n">primary_worker</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                    <span class="c1"># Swap to using a Redis hash instead of the</span>
                    <span class="c1"># flux.last.&lt;metric&gt; keys</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span> <span class="ow">and</span> <span class="n">primary_worker</span><span class="p">:</span>
                        <span class="n">redis_last_metrics_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_last_metrics_data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;flux.last.metric_data&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to hgetall flux.last.metric_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">err</span><span class="p">))</span>
                        <span class="c1"># Use the local data to update the memcache data, each</span>
                        <span class="c1"># worker will update the data</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">redis_last_metrics_data_dict</span><span class="p">:</span>
                            <span class="n">memcache_flux_last_metric_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">memcache_flux_last_metric_data_dict</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.last.metric_data&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">memcache_flux_last_metric_data_dict</span><span class="p">:</span>
                                    <span class="n">memcache_flux_last_metric_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed get_memcache_key flux.last.metric_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">err</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_memcache_flux_last_metric_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="n">memcache_flux_last_metric_data_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_memcache_flux_last_metric_data</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                            <span class="n">redis_last_metrics_data_dict</span> <span class="o">=</span> <span class="n">memcache_flux_last_metric_data_dict</span>
                        <span class="k">if</span> <span class="n">redis_last_metrics_data_dict</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.last.metric_data&#39;</span><span class="p">,</span> <span class="n">redis_last_metrics_data_dict</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set memcache key flux.last.metric_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">err</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: set memcache key flux.last.metric_data&#39;</span><span class="p">)</span>

                    <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                    <span class="n">set_in_redis</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">primary_worker</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">worker_pid</span><span class="p">)</span>
                            <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: set Redis primary_worker_key key to self pid to primary_worker - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="n">set_in_redis</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set Redis primary_worker_key key to self pid - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.worker.primary_worker_key&#39;</span><span class="p">,</span> <span class="n">worker_pid</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set memcache primary_worker_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                    <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="n">worker_pid</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_key set in memcache primary_worker_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                        <span class="k">if</span> <span class="n">set_in_redis</span> <span class="ow">and</span> <span class="n">main_process_pid_from_memcache</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: trying to set flux.main_process_pid in Redis as retrieved from memcache&#39;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flux.main_process_pid&#39;</span><span class="p">,</span> <span class="n">main_process_pid</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set Redis flux.main_process_pid key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="n">main_process_pid_from_memcache</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: set flux.main_process_pid in Redis, deleting memcache key as Redis available&#39;</span><span class="p">)</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="n">delete_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;flux.main_process_pid&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to delete memcache primary_worker_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: deleted flux.main_process_pid memcache key as Redis available&#39;</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">last_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

            <span class="c1"># except NotImplementedError:</span>
            <span class="c1">#    pass</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: server has been issued a user signal to terminate - KeyboardInterrupt&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: server was interrupted - SystemExit&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

            <span class="c1"># @added 20200206 - Feature #3444: Allow flux to backfill</span>
            <span class="c1"># Added backfill</span>
            <span class="n">backfill</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20201018 - Feature #3798: FLUX_PERSIST_QUEUE</span>
            <span class="k">if</span> <span class="n">metric_data</span> <span class="ow">and</span> <span class="n">FLUX_PERSIST_QUEUE</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Do not remove each individual metrics from the flux.queue</span>
                    <span class="c1"># Redis set, add to a list that is removed in one srem *set</span>
                    <span class="c1"># operation each 60 seconds.  This is a more perfomant</span>
                    <span class="c1"># method and requires a single blocking call for a batch of</span>
                    <span class="c1"># metrics, rather than a blocking call for every metric.</span>
                    <span class="c1"># self.redis_conn.srem(&#39;flux.queue&#39;, str(metric_data))</span>
                    <span class="n">remove_from_flux_queue_redis_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="n">metric_data</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="c1"># @added 20200206 - Feature #3444: Allow flux to backfill</span>
                    <span class="c1"># Added backfill, convert the boolean to an int</span>
                    <span class="n">backfill</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: debug :: queue item found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to interpolate metric, value, timestamp from metric_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="c1"># @added 20201020 - Feature #3796: FLUX_CHECK_LAST_TIMESTAMP</span>
                <span class="c1"># Only check flux.last key if this is not backfill and</span>
                <span class="c1"># FLUX_CHECK_LAST_TIMESTAMP is enable or it is in VISTA_ENABLED</span>
                <span class="n">cache_key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># if FLUX_CHECK_LAST_TIMESTAMP:</span>
                <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;flux.last.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span>
                <span class="n">check_flux_last_key</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">backfill</span> <span class="ow">and</span> <span class="n">FLUX_CHECK_LAST_TIMESTAMP</span><span class="p">:</span>
                    <span class="n">check_flux_last_key</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">VISTA_ENABLED</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">vista_metrics</span><span class="p">:</span>
                        <span class="n">check_flux_last_key</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SEND_TO_CARBON</span><span class="p">:</span>
                    <span class="c1"># Best effort de-duplicate the data</span>
                    <span class="n">valid_data</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># @added 20200818 - Feature #3694: flux - POST multiple metrics</span>
                    <span class="c1"># Handle Redis and literal_eval separately</span>
                    <span class="n">redis_last_metric_data</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># @modified 20200206 - Feature #3444: Allow flux to backfill</span>
                    <span class="c1"># Only check flux.last key if this is not backfill</span>
                    <span class="c1"># @modified 20201020 - Feature #3796: FLUX_CHECK_LAST_TIMESTAMP</span>
                    <span class="c1"># Use the check_flux_last_key value determined above</span>
                    <span class="c1"># if not backfill:</span>
                    <span class="k">if</span> <span class="n">check_flux_last_key</span><span class="p">:</span>
                        <span class="c1"># @modified 20201020 - Feature #3796: FLUX_CHECK_LAST_TIMESTAMP</span>
                        <span class="c1"># Set cache_key outside the conditional block</span>
                        <span class="c1"># cache_key = &#39;flux.last.%s&#39; % metric</span>
                        <span class="n">last_metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                        <span class="c1"># Swap to using a Redis hash instead of the</span>
                        <span class="c1"># flux.last.&lt;metric&gt; keys</span>
                        <span class="n">redis_last_metric_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_last_metric_data_dict</span> <span class="o">=</span> <span class="n">get_last_metric_data</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: get_last_metric_data failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">err</span><span class="p">))</span>

                        <span class="n">use_old_timestamp_keys</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">redis_last_metric_data_dict</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">last_metric_timestamp</span> <span class="o">=</span> <span class="n">redis_last_metric_data_dict</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                                <span class="n">use_old_timestamp_keys</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">last_metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get timestamp from - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">redis_last_metric_data_dict</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                                <span class="n">last_metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="n">redis_last_metric_data</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_metric_timestamp</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># @modified 20191128 - Bug #3266: py3 Redis binary objects not strings</span>
                                <span class="c1">#                      Branch #3262: py3</span>
                                <span class="c1"># redis_last_metric_data = self.redis_conn.get(cache_key)</span>
                                <span class="n">redis_last_metric_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to determine last_metric_timestamp from Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">cache_key</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                                <span class="n">redis_last_metric_data</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="c1"># @modified 20200818 - Feature #3694: flux - POST multiple metrics</span>
                        <span class="c1"># Handle Redis and literal_eval separately, only</span>
                        <span class="c1"># literal_eval if Redis had data for the key</span>
                        <span class="k">if</span> <span class="n">redis_last_metric_data</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">last_metric_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">redis_last_metric_data</span><span class="p">)</span>
                                <span class="n">last_metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_metric_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: debug :: last_metric_timestamp for </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_metric_timestamp</span><span class="p">)))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to determine last_metric_timestamp from Redis key </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">cache_key</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                                <span class="n">last_metric_timestamp</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">if</span> <span class="n">last_metric_timestamp</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&lt;=</span> <span class="n">last_metric_timestamp</span><span class="p">:</span>
                                <span class="n">valid_data</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: debug :: not valid data - the queue data timestamp </span><span class="si">%s</span><span class="s1"> is &lt;= to the last_metric_timestamp </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: debug :: not valid data - the queue data timestamp </span><span class="si">%s</span><span class="s1"> is &lt;= to the last_metric_timestamp </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_metric_timestamp</span><span class="p">),</span> <span class="n">metric</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">valid_data</span><span class="p">:</span>
                        <span class="n">submittedToGraphite</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">send_to_reciever</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">graphyte</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
                                <span class="n">submittedToGraphite</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="c1"># modified 20201016 - Feature #3788: snab_flux_load_test</span>
                                <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: sent </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> to Graphite - via graphyte&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)))</span>
                                <span class="n">metrics_sent_to_graphite</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="c1"># @added 20200827 - Feature #3708: FLUX_ZERO_FILL_NAMESPACES</span>
                                <span class="n">metrics_sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                <span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                                <span class="c1"># Better handle multiple workers</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="c1"># pass</span>
                                    <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                        <span class="n">sent_add_to_memcache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

                                <span class="c1"># @added 202011120 - Feature #3790: flux - pickle to Graphite</span>
                                <span class="c1"># Debug Redis set</span>
                                <span class="n">metrics_data_sent</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">])</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send metric data to Graphite for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                                <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">send_to_reciever</span> <span class="o">==</span> <span class="s1">&#39;pickle&#39;</span><span class="p">:</span>
                            <span class="c1"># @modified 20201212 - Task #3864: flux - try except everything</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">tuple_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                                <span class="n">pickle_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tuple_data</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: sending </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> to Graphite - via pickle&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)))</span>
                                <span class="n">submittedToGraphite</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">metrics_sent_to_graphite</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">metrics_sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                <span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                                <span class="c1"># Better handle multiple workers</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to add metric to flux.workers.metrics_sent Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                                    <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                        <span class="n">sent_add_to_memcache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

                                <span class="c1"># @added 202011120 - Feature #3790: flux - pickle to Graphite</span>
                                <span class="c1"># Debug Redis set</span>
                                <span class="n">metrics_data_sent</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to append to pickle_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">submittedToGraphite</span><span class="p">:</span>
                            <span class="c1"># Update the metric Redis flux key</span>
                            <span class="c1"># @modified 20200206 - Feature #3444: Allow flux to backfill</span>
                            <span class="c1"># Only update the flux.last key if this is not backfill</span>
                            <span class="c1"># @modified 20201020 - Feature #3796: FLUX_CHECK_LAST_TIMESTAMP</span>
                            <span class="c1"># Use the check_flux_last_key value determined above</span>
                            <span class="c1"># if not backfill:</span>
                            <span class="k">if</span> <span class="n">check_flux_last_key</span><span class="p">:</span>
                                <span class="n">metric_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>

                                <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
                                <span class="k">if</span> <span class="n">use_old_timestamp_keys</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="c1"># @modified 20220428 - Feature #4536: Handle Redis failure</span>
                                        <span class="c1"># Swap to using a Redis hash instead of the</span>
                                        <span class="c1"># flux.last.&lt;metric&gt; keys make existing keys</span>
                                        <span class="c1"># expire</span>
                                        <span class="c1"># self.redis_conn.set(cache_key, str(metric_data))</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set check_flux_last_key Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                                <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                                <span class="c1"># Swap to using a Redis hash instead of the</span>
                                <span class="c1"># flux.last.&lt;metric&gt; keys</span>
                                <span class="n">metric_data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
                                <span class="n">new_memcache_flux_last_metric_data</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_data_dict</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;flux.last.metric_data&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data_dict</span><span class="p">))</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set flux.last.metric_data Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

                            <span class="c1"># @added 20200213 - Bug #3448: Repeated airgapped_metrics</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># @added 20201120 - Feature #3796: FLUX_CHECK_LAST_TIMESTAMP</span>
                                <span class="c1">#                   Feature #3400: Identify air gaps in the metric data</span>
                                <span class="c1"># Only execute if IDENTIFY_AIRGAPS is enabled</span>
                                <span class="k">if</span> <span class="n">IDENTIFY_AIRGAPS</span><span class="p">:</span>
                                    <span class="c1"># @added 20200213 - Bug #3448: Repeated airgapped_metrics</span>
                                    <span class="c1"># Add a flux.filled key to Redis with a expiry</span>
                                    <span class="c1"># set to FULL_DURATION so that Analyzer knows to</span>
                                    <span class="c1"># sort and deduplicate the Redis time series</span>
                                    <span class="c1"># data as carbon-relay will send it to Horizon</span>
                                    <span class="c1"># and the datapoints will be out of order in the</span>
                                    <span class="c1"># Redis key</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">flux_filled_key</span> <span class="o">=</span> <span class="s1">&#39;flux.filled.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
                                            <span class="n">flux_filled_key</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">,</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: set Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">flux_filled_key</span><span class="p">)))</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to could not set Redis flux.filled key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># modified 20201016 - Feature #3788: snab_flux_load_test</span>
                        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: discarded </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> as a data point for </span><span class="si">%s</span><span class="s1"> has already been submitted to Graphite&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)))</span>

                        <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.workers.discarded.already_received&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to add metric to Redis set flux.workers.discarded.already_received - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: settings.FLUX_SEND_TO_CARBON is set to </span><span class="si">%s</span><span class="s1">, discarded </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SEND_TO_CARBON</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SEND_TO_STATSD</span><span class="p">:</span>
                    <span class="n">statsd_conn</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
                    <span class="c1"># modified 20201016 - Feature #3788: snab_flux_load_test</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker sent </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> to statsd&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)))</span>
                    <span class="c1"># @added 20200827 - Feature #3708: FLUX_ZERO_FILL_NAMESPACES</span>
                    <span class="n">metrics_sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                    <span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                    <span class="c1"># Better handle multiple workers</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="n">submit_pickle_data</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">pickle_data</span><span class="p">:</span>
                    <span class="n">number_of_datapoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pickle_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">number_of_datapoints</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">:</span>
                        <span class="n">submit_pickle_data</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_data_queue_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">metric_data_queue_size</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">metric_data_queue_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">submit_pickle_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">submit_pickle_data</span><span class="p">:</span>
                    <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pickle_data_submitted</span> <span class="o">=</span> <span class="n">submit_pickle_data_to_graphite</span><span class="p">(</span><span class="n">pickle_data</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: submit_pickle_data_to_graphite failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                        <span class="n">pickle_data_submitted</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">pickle_data_submitted</span><span class="p">:</span>
                        <span class="n">pickle_data</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                    <span class="k">if</span> <span class="n">sent_add_to_memcache</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="n">add_to_memcache_flux_workers_metrics_sent</span><span class="p">(</span><span class="n">sent_add_to_memcache</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: added </span><span class="si">%s</span><span class="s1"> sent metrics to flux.workers.metrics_sent memcache key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sent_add_to_memcache</span><span class="p">)))</span>
                    <span class="n">sent_add_to_memcache</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">time_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time_now</span> <span class="o">-</span> <span class="n">last_sent_to_graphite</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>

                <span class="c1"># @added 20200827 - Feature #3708: FLUX_ZERO_FILL_NAMESPACES</span>
                <span class="c1"># Send 0 for any metric in the flux.zero_fill_metrics Redis set that</span>
                <span class="c1"># has not submitted data in the last 60 seconds.  The flux.last</span>
                <span class="c1"># Redis key is not updated for these sent 0 values so if the source</span>
                <span class="c1"># sends data for a timestamp in the period later (due to a lag, etc),</span>
                <span class="c1"># it will be valid and sent to Graphite.</span>

                <span class="c1"># @modified 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                <span class="c1"># Better handle multiple workers, only do on the primary</span>
                <span class="c1"># worker and now that the zero_fill setting can be passed in the</span>
                <span class="c1"># FLUX_AGGREGATE_NAMESPACES settings check the Redis set</span>
                <span class="c1"># if FLUX_ZERO_FILL_NAMESPACES:</span>
                <span class="k">if</span> <span class="n">primary_worker</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_zero_fill_to_graphite</span><span class="p">:</span>
                        <span class="n">last_zero_fill_to_graphite</span> <span class="o">=</span> <span class="n">time_now</span> <span class="o">-</span> <span class="mi">60</span>
                    <span class="n">run_fill</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Check that it was not run in the empty exception</span>
                    <span class="c1"># immediately before</span>
                    <span class="k">if</span> <span class="n">last_zero_fill_to_graphite</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">((</span><span class="n">time_now</span> <span class="o">-</span> <span class="mi">5</span><span class="p">),</span> <span class="n">time_now</span><span class="p">)):</span>
                        <span class="n">run_fill</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">run_fill</span><span class="p">:</span>
                        <span class="n">flux_zero_fill_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">flux_zero_fill_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;flux.zero_fill_metrics&#39;</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to generate a list from flux.zero_fill_metrics Redis set&#39;</span><span class="p">)</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">flux_zero_fill_metrics</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.zero_fill_metrics&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">flux_zero_fill_metrics</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: flux_zero_fill_metrics found in flux.zero_fill_metrics memcache key&#39;</span><span class="p">)</span>
                                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">flux_zero_fill_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get memcache key flux.zero_fill_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">err</span><span class="p">))</span>
                                    <span class="n">flux_zero_fill_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="c1"># @added 20210408 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                        <span class="c1"># Use Redis set</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">all_metrics_sent</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to generate a list from flux.workers.metrics_sent Redis set&#39;</span><span class="p">)</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">all_metrics_sent</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">all_metrics_sent</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: all_metrics_sent found in flux.workers.metrics_sent memcache key&#39;</span><span class="p">)</span>
                                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">all_metrics_sent</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get memcache key flux.workers.metrics_sent - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">err</span><span class="p">))</span>
                                    <span class="n">all_metrics_sent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metrics_sent_to_graphite</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">flux_zero_fill_metric</span> <span class="ow">in</span> <span class="n">flux_zero_fill_metrics</span><span class="p">:</span>
                            <span class="c1"># if flux_zero_fill_metric not in metrics_sent:</span>
                            <span class="k">if</span> <span class="n">flux_zero_fill_metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_metrics_sent</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># @modified 20210406 - Bug #4002: Change flux FLUX_ZERO_FILL_NAMESPACES to pickle</span>
                                    <span class="c1"># Do not use graphyte to send zeros as it can</span>
                                    <span class="c1"># result in missing data, add date to the pickle</span>
                                    <span class="c1"># graphyte.send(flux_zero_fill_metric, 0.0, time_now)</span>
                                    <span class="n">tuple_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_zero_fill_metric</span><span class="p">,</span> <span class="p">(</span><span class="n">last_zero_fill_to_graphite</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                                    <span class="n">pickle_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tuple_data</span><span class="p">)</span>

                                    <span class="c1"># modified 20201016 - Feature #3788: snab_flux_load_test</span>
                                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                        <span class="c1"># @modified 20210406 - Bug #4002: Change flux FLUX_ZERO_FILL_NAMESPACES to pickle</span>
                                        <span class="c1"># logger.info(&#39;worker :: zero fill - sent %s, %s, %s to Graphite&#39; % (str(flux_zero_fill_metric), str(0.0), str(time_now)))</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: zero fill - added </span><span class="si">%s</span><span class="s1"> to pickle_data&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tuple_data</span><span class="p">)))</span>
                                    <span class="n">metrics_sent_to_graphite</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">metrics_sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_zero_fill_metric</span><span class="p">)</span>
                                    <span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                                    <span class="c1"># Better handle multiple workers</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">,</span> <span class="n">flux_zero_fill_metric</span><span class="p">)</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="c1"># pass</span>
                                        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">success</span> <span class="o">=</span> <span class="n">add_to_memcache_flux_workers_metrics_sent</span><span class="p">([</span><span class="n">flux_zero_fill_metric</span><span class="p">])</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="k">pass</span>
                                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                                <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: zero fill - failed to add metric data to pickle for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">flux_zero_fill_metric</span><span class="p">))</span>
                                    <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">last_zero_fill_to_graphite</span> <span class="o">=</span> <span class="n">time_now</span>

                <span class="c1"># @added 20210406 - Bug #4002: Change flux FLUX_ZERO_FILL_NAMESPACES to pickle</span>
                <span class="c1"># Reset metrics_sent</span>
                <span class="n">metrics_sent</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="n">pickle_data</span><span class="p">:</span>
                    <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pickle_data_submitted</span> <span class="o">=</span> <span class="n">submit_pickle_data_to_graphite</span><span class="p">(</span><span class="n">pickle_data</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: submit_pickle_data_to_graphite failed last_sent_to_graphite &gt;= 60 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                        <span class="n">pickle_data_submitted</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">pickle_data_submitted</span><span class="p">:</span>
                        <span class="n">pickle_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: metrics_sent_to_graphite in last 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sent_to_graphite</span><span class="p">))</span>
                <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.metrics_sent_to_graphite&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                <span class="k">if</span> <span class="n">primary_worker</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20191008 - Feature #3250: Allow Skyline to send metrics to another Carbon host</span>
                        <span class="c1"># graphyte.send(skyline_metric, metrics_sent_to_graphite, time_now)</span>
                        <span class="c1"># @modified 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                        <span class="c1"># Better handle multiple workers get count from the key</span>
                        <span class="c1"># send_graphite_metric(self, skyline_app, skyline_metric, metrics_sent_to_graphite)</span>
                        <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metrics_sent_to_graphite</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                            <span class="c1"># all_metrics_sent_to_graphite = len(list(self.redis_conn_decoded.smembers(&#39;flux.workers.metrics_sent&#39;)))</span>
                            <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set all_metrics_sent_to_graphite in last 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">all_metrics_sent_to_graphite</span><span class="p">:</span>
                                        <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_metrics_sent_to_graphite</span><span class="p">)</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: all_metrics_sent_to_graphite found in flux.workers.metrics_sent memcache key&#39;</span><span class="p">)</span>
                                        <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">success</span> <span class="o">=</span> <span class="n">delete_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.workers.metrics_sent&#39;</span><span class="p">)</span>
                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to delete memcache key flux.workers.metrics_sent - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="n">err</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get memcache key flux.workers.metrics_sent - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">err</span><span class="p">))</span>
                                    <span class="n">all_metrics_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metrics_sent_to_graphite</span><span class="p">)</span>

                        <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">all_metrics_sent_to_graphite</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: all_metrics_sent_to_graphite in last 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_metrics_sent_to_graphite</span><span class="p">))</span>
                        <span class="n">last_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                        <span class="n">metrics_sent_to_graphite</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sent_to_graphite</span><span class="p">)))</span>

                    <span class="c1"># @added 20220329 - Feature #4018: thunder - skyline.errors</span>
                    <span class="c1"># Report app up</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;flux.worker&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set flux.worker Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>

                    <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># use_backfill = False</span>
                    <span class="c1"># timestamp_for_metrics = int(time())</span>

                    <span class="n">discarded_already_received</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.already_received&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                        <span class="c1"># discarded_already_received = len(list(self.redis_conn_decoded.smembers(&#39;flux.workers.discarded.already_received&#39;)))</span>
                        <span class="n">discarded_already_received</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.workers.discarded.already_received&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.workers.discarded.already_received&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.workers.discarded.already_received - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: discarded_already_received in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">discarded_already_received</span><span class="p">))</span>
                    <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="c1"># skyline_metric_data = [skyline_metric, discarded_already_received, timestamp_for_metrics, use_backfill]</span>
                    <span class="c1"># try:</span>
                    <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                    <span class="c1"># except Exception as e:</span>
                    <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                    <span class="c1">#         str(metric_data), e))</span>
                    <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">discarded_already_received</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">discarded_already_received</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                    <span class="n">listen_discarded_invalid_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.invalid_timestamp&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                        <span class="c1"># listen_discarded_invalid_timestamp = len(list(self.redis_conn_decoded.smembers(&#39;flux.listen.discarded.invalid_timestamp&#39;)))</span>
                        <span class="n">listen_discarded_invalid_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_timestamp&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_timestamp&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.discarded.invalid_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_discarded_invalid_timestamp in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_timestamp</span><span class="p">))</span>
                    <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_invalid_timestamp, timestamp_for_metrics, use_backfill]</span>
                    <span class="c1"># try:</span>
                    <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                    <span class="c1"># except Exception as e:</span>
                    <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                    <span class="c1">#         str(metric_data), e))</span>
                    <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_discarded_invalid_timestamp</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_timestamp</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                    <span class="n">listen_discarded_metric_name</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.metric_name&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                        <span class="c1"># listen_discarded_metric_name = len(list(self.redis_conn_decoded.smembers(&#39;flux.listen.discarded.metric_name&#39;)))</span>
                        <span class="n">listen_discarded_metric_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.metric_name&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.metric_name&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.discarded.metric_name - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_discarded_metric_name in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_metric_name</span><span class="p">))</span>
                    <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_metric_name, timestamp_for_metrics, use_backfill]</span>
                    <span class="c1"># try:</span>
                    <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                    <span class="c1"># except Exception as e:</span>
                    <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                    <span class="c1">#         str(metric_data), e))</span>
                    <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_discarded_metric_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_metric_name</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                    <span class="n">listen_discarded_invalid_value</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.invalid_value&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                        <span class="c1"># listen_discarded_invalid_value = len(list(self.redis_conn_decoded.smembers(&#39;flux.listen.discarded.invalid_value&#39;)))</span>
                        <span class="n">listen_discarded_invalid_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_value&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_value&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.discarded.invalid_value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_discarded_invalid_value in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_value</span><span class="p">))</span>
                    <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_metric_name, timestamp_for_metrics, use_backfill]</span>
                    <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_invalid_value, timestamp_for_metrics, use_backfill]</span>
                    <span class="c1"># try:</span>
                    <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                    <span class="c1"># except Exception as e:</span>
                    <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                    <span class="c1">#         str(metric_data), e))</span>
                    <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_discarded_invalid_value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_value</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                    <span class="n">listen_discarded_invalid_key</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.invalid_key&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                        <span class="c1"># listen_discarded_invalid_key = len(list(self.redis_conn_decoded.smembers(&#39;flux.listen.discarded.invalid_key&#39;)))</span>
                        <span class="n">listen_discarded_invalid_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_key&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_key&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.discarded.invalid_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_discarded_invalid_key in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_key</span><span class="p">))</span>
                    <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_invalid_key, timestamp_for_metrics, use_backfill]</span>
                    <span class="c1"># try:</span>
                    <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                    <span class="c1"># except Exception as e:</span>
                    <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                    <span class="c1">#         str(metric_data), e))</span>
                    <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_discarded_invalid_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_key</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                    <span class="n">listen_discarded_invalid_parameters</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.discarded.invalid_parameters&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20230401 - Feature #4886: analyzer - operation_timings</span>
                        <span class="c1"># listen_discarded_invalid_parameters = len(list(self.redis_conn_decoded.smembers(&#39;flux.listen.discarded.invalid_parameters&#39;)))</span>
                        <span class="n">listen_discarded_invalid_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.discarded.invalid_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_discarded_invalid_parameters in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_parameters</span><span class="p">))</span>
                    <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="c1"># skyline_metric_data = [skyline_metric, listen_discarded_invalid_parameters, timestamp_for_metrics, use_backfill]</span>
                    <span class="c1"># try:</span>
                    <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                    <span class="c1"># except Exception as e:</span>
                    <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                    <span class="c1">#         str(metric_data), e))</span>
                    <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_discarded_invalid_parameters</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_discarded_invalid_parameters</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                    <span class="n">listen_added_to_queue</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.added_to_queue&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">listen_added_to_queue_str</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="c1"># @modified 20230205 - Task #4844: Replace Redis getset with set with get</span>
                        <span class="c1"># As of Redis version 6.2.0, this command is regarded as deprecated.</span>
                        <span class="c1"># It can be replaced by SET with the GET argument when migrating or writing new code.</span>
                        <span class="c1"># listen_added_to_queue_str = self.redis_conn_decoded.getset(&#39;flux.listen.added_to_queue&#39;, 0)</span>
                        <span class="n">listen_added_to_queue_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flux.listen.added_to_queue&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">listen_added_to_queue_str</span><span class="p">:</span>
                            <span class="n">listen_added_to_queue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">listen_added_to_queue_str</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.added_to_queue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">listen_added_to_queue</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.listen.added_to_queue&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">listen_added_to_queue</span><span class="p">:</span>
                                    <span class="n">listen_added_to_queue</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">listen_added_to_queue</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="n">listen_added_to_queue</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="n">delete_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;flux.listen.added_to_queue&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to delete memcache flux.listen.added_to_queue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: deleted flux.listen.added_to_queue memcache key as Redis available&#39;</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen_added_to_queue in last 60 seconds (in empty queue block) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_added_to_queue</span><span class="p">))</span>
                    <span class="c1"># @modified 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="c1"># skyline_metric_data = [skyline_metric, listen_added_to_queue, timestamp_for_metrics, use_backfill]</span>
                    <span class="c1"># try:</span>
                    <span class="c1">#     self.q.put(skyline_metric_data, block=False)</span>
                    <span class="c1"># except Exception as e:</span>
                    <span class="c1">#     logger.error(&#39;error :: worker :: failed to add data %s to send to Graphite to flux.httpMetricDataQueue - %s&#39; % (</span>
                    <span class="c1">#         str(metric_data), e))</span>
                    <span class="c1"># @added 20210729 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="c1"># Send to the Graphite that collects skyline metrics not</span>
                    <span class="c1"># via flux queue which could send to a different Graphite</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_added_to_queue</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_added_to_queue</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                    <span class="c1"># @added 20220302 - Feature #4400: flux - quota</span>
                    <span class="c1"># If there are flux namespace quotas add a metric to track</span>
                    <span class="c1"># over quota count and dropped_non_numeric_metrics</span>
                    <span class="n">flux_namespace_quotas</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">flux_namespace_quotas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to hgetall metrics_manager.flux.namespace_quotas - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                        <span class="n">last_known_value</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">flux_namespace_quotas</span><span class="p">:</span>
                        <span class="n">over_quota_count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.over_quota_metrics_count&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">over_quota_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">over_quota_count</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.over_quota.rejected_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">over_quota_count_list</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">over_quota_count_list</span><span class="p">:</span>
                                        <span class="n">over_quota_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">over_quota_count</span><span class="p">)</span>
                                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">success</span> <span class="o">=</span> <span class="n">delete_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">)</span>
                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to delete memcache flux.listen.over_quota.rejected_metrics key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: deleted flux.listen.over_quota.rejected_metrics memcache key&#39;</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">over_quota_count</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">over_quota_count</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen namespaces over_quota metric count in last 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">over_quota_count</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">over_quota_count</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">over_quota_count</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">dropped_non_numeric_metrics_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.dropped_non_numeric_metrics&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dropped_non_numeric_metrics_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.listen.dropped_non_numeric_metrics&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dropped_non_numeric_metrics_count</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;flux.listen.dropped_non_numeric_metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;aet.flux.listen.dropped_non_numeric_metrics&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.dropped_non_numeric_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen dropped_non_numeric_metrics count in last 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dropped_non_numeric_metrics_count</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">dropped_non_numeric_metrics_count</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dropped_non_numeric_metrics_count</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

                    <span class="c1"># @added 20220303 - Feature #4400: flux - quota</span>
                    <span class="n">listen_added_to_aggregation_queue</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.added_to_aggregation_queue&#39;</span> <span class="o">%</span> <span class="n">listen_graphite_namespace</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">listen_added_to_aggregation_queue</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="c1"># @modified 20230205 - Task #4844: Replace Redis getset with set with get</span>
                        <span class="c1"># As of Redis version 6.2.0, this command is regarded as deprecated.</span>
                        <span class="c1"># It can be replaced by SET with the GET argument when migrating or writing new code.</span>
                        <span class="c1"># listen_added_to_aggregation_queue_str = self.redis_conn_decoded.getset(&#39;flux.listen.added_to_aggregation_queue&#39;, 0)</span>
                        <span class="n">listen_added_to_aggregation_queue_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flux.listen.added_to_aggregation_queue&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">listen_added_to_aggregation_queue_str</span><span class="p">:</span>
                            <span class="n">listen_added_to_aggregation_queue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">listen_added_to_aggregation_queue_str</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to get Redis set flux.listen.added_to_aggregation_queue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: listen added_to_aggregation_queue in last 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_added_to_aggregation_queue</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">listen_added_to_aggregation_queue</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listen_added_to_aggregation_queue</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

                <span class="n">metric_data_queue_size</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_data_queue_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: flux.httpMetricDataQueue queue size - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data_queue_size</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to determine size of queue flux.httpMetricDataQueue&#39;</span><span class="p">)</span>
                <span class="n">skyline_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.httpMetricDataQueue.size&#39;</span> <span class="o">%</span> <span class="n">skyline_app_graphite_namespace</span>
                <span class="k">if</span> <span class="n">primary_worker</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">send_graphite_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_metric</span><span class="p">,</span> <span class="n">metric_data_queue_size</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to send_graphite_metric </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">skyline_metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_sent_to_graphite</span><span class="p">)))</span>
                <span class="c1"># @added 20201019 - Feature #3790: flux - pickle to Graphite</span>
                <span class="k">if</span> <span class="n">metric_data_queue_size</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">send_to_reciever</span> <span class="o">=</span> <span class="s1">&#39;pickle&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">send_to_reciever</span> <span class="o">=</span> <span class="s1">&#39;line&#39;</span>

                <span class="c1"># @added 20210406 - Bug #4002: Change flux FLUX_ZERO_FILL_NAMESPACES to pickle</span>
                <span class="c1"># Only use pickle</span>
                <span class="n">send_to_reciever</span> <span class="o">=</span> <span class="s1">&#39;pickle&#39;</span>

                <span class="c1"># @added 202011120 - Feature #3790: flux - pickle to Graphite</span>
                <span class="c1"># Debug Redis set</span>
                <span class="n">metrics_data_sent_strs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">metrics_data_sent</span><span class="p">:</span>
                    <span class="n">metrics_data_sent_strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">metrics_data_sent_strs</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.metrics_data_sent&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_data_sent_strs</span><span class="p">))</span>
                        <span class="c1"># @added 20220706 - Feature #3790: flux - pickle to Graphite</span>
                        <span class="c1"># Added expire because if there are multiple workers and</span>
                        <span class="c1"># the primary worker does not process any requests and</span>
                        <span class="c1"># the other workers do, this set will not be managed.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="s1">&#39;flux.metrics_data_sent&#39;</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>

                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: added </span><span class="si">%s</span><span class="s1"> items to the flux.metrics_data_sent Redis set&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_data_sent</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to determine size of flux.queue Redis set&#39;</span><span class="p">)</span>
                    <span class="n">metrics_data_sent</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># @modified 20220706 - Feature #3790: flux - pickle to Graphite</span>
                <span class="c1"># Unindented out of if metrics_data_sent_strs because if there</span>
                <span class="c1"># are multiple workers and the primary worker does not process</span>
                <span class="c1"># any requests and the other workers do, this set will not be</span>
                <span class="c1"># managed.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_set</span> <span class="o">=</span> <span class="s1">&#39;aet.flux.metrics_data_sent.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pid</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to current_pid for aet.flux.metrics_data_sent Redis set name&#39;</span><span class="p">)</span>
                    <span class="n">new_set</span> <span class="o">=</span> <span class="s1">&#39;aet.flux.metrics_data_sent&#39;</span>
                <span class="k">if</span> <span class="n">primary_worker</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;flux.metrics_data_sent&#39;</span><span class="p">,</span> <span class="n">new_set</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: renamed flux.metrics_data_sent Redis set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">new_set</span><span class="p">)</span>
                    <span class="c1"># @modified 20201128 - Feature #3820: HORIZON_SHARDS</span>
                    <span class="c1"># With metrics that come in at a frequency of less</span>
                    <span class="c1"># than 60 seconds, it is possible that this key will</span>
                    <span class="c1"># not exist as flux has not been sent metric data</span>
                    <span class="c1"># so this operation will error with no such key</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">traceback_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;no such key&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;warning :: worker :: failed to rename flux.metrics_data_sent to </span><span class="si">%s</span><span class="s1"> Redis set - flux has not recieved data in 60 seconds - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_set</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback_str</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to rename flux.metrics_data_sent to </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="n">new_set</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">new_set</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set 600 seconds TTL on </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="n">new_set</span><span class="p">)</span>

                <span class="c1"># @added 20201018 - Feature #3798: FLUX_PERSIST_QUEUE</span>
                <span class="k">if</span> <span class="n">FLUX_PERSIST_QUEUE</span><span class="p">:</span>
                    <span class="n">redis_set_size</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_set_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.queue&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to determine size of flux.queue Redis set&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker - flux.queue Redis set size </span><span class="si">%s</span><span class="s1"> before removal of </span><span class="si">%s</span><span class="s1"> items&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">redis_set_size</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_from_flux_queue_redis_set</span><span class="p">))))</span>
                    <span class="k">if</span> <span class="n">remove_from_flux_queue_redis_set</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;flux.queue&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_from_flux_queue_redis_set</span><span class="p">))</span>
                            <span class="n">remove_from_flux_queue_redis_set</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to remove multiple items from flux.queue Redis set&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_set_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="s1">&#39;flux.queue&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to determine size of flux.queue Redis set&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker - flux.queue Redis set size of </span><span class="si">%s</span><span class="s1"> after the removal of items&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">redis_set_size</span><span class="p">)))</span>
                        <span class="n">remove_from_flux_queue_redis_set</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># @added 20201020 - Feature #3796: FLUX_CHECK_LAST_TIMESTAMP</span>
                <span class="c1"># Even if flux.last Redis keys are disabled in flux they are used in</span>
                <span class="c1"># Vista</span>
                <span class="n">vista_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">FLUX_CHECK_LAST_TIMESTAMP</span> <span class="ow">and</span> <span class="n">VISTA_ENABLED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">vista_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">sscan_iter</span><span class="p">(</span><span class="s1">&#39;vista.metrics&#39;</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">vista_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                <span class="c1"># Swap to using a Redis hash instead of the</span>
                <span class="c1"># flux.last.&lt;metric&gt; keys</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span> <span class="ow">and</span> <span class="n">primary_worker</span><span class="p">:</span>
                    <span class="n">redis_last_metrics_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_last_metrics_data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;flux.last.metric_data&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to hgetall flux.last.metric_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                    <span class="c1"># Use the local data to update the memcache data, each</span>
                    <span class="c1"># worker will update the data</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">redis_last_metrics_data_dict</span><span class="p">:</span>
                        <span class="n">memcache_flux_last_metric_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">memcache_flux_last_metric_data_dict</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.last.metric_data&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">memcache_flux_last_metric_data_dict</span><span class="p">:</span>
                                <span class="n">memcache_flux_last_metric_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed get_memcache_key flux.last.metric_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_memcache_flux_last_metric_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">memcache_flux_last_metric_data_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_memcache_flux_last_metric_data</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                        <span class="n">redis_last_metrics_data_dict</span> <span class="o">=</span> <span class="n">memcache_flux_last_metric_data_dict</span>
                    <span class="k">if</span> <span class="n">redis_last_metrics_data_dict</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.last.metric_data&#39;</span><span class="p">,</span> <span class="n">redis_last_metrics_data_dict</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set memcache key flux.last.metric_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: set memcache key flux.last.metric_data&#39;</span><span class="p">)</span>

                <span class="c1"># @added 20210407 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                <span class="c1"># Better handle multiple workers</span>
                <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">primary_worker_pid</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_pid found in Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.worker.primary_worker_key&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">primary_worker_pid</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_key found in memcache key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                                <span class="n">failed_over_to_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">primary_worker_pid</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: no primary_worker found, taking role&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">worker_pid</span><span class="p">)</span>
                        <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: set self pid to primary_worker - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.worker.primary_worker_key&#39;</span><span class="p">,</span> <span class="n">worker_pid</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set memcache primary_worker_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="n">worker_pid</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_key set in memcache primary_worker_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">primary_worker_pid</span> <span class="ow">and</span> <span class="n">primary_worker</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">primary_worker_pid</span> <span class="o">!=</span> <span class="n">worker_pid</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker role has been taken over by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                        <span class="n">primary_worker</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">primary_worker_pid</span> <span class="o">==</span> <span class="n">worker_pid</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">primary_worker</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: taking over primary_worker role&#39;</span><span class="p">)</span>
                    <span class="n">primary_worker</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">primary_worker</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">worker_pid</span><span class="p">)</span>
                        <span class="n">primary_worker_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">primary_worker_key</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: set Redis primary_worker_key key to self pid to primary_worker - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set Redis primary_worker_key key to self pid - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                        <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.worker.primary_worker_key&#39;</span><span class="p">,</span> <span class="n">worker_pid</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set memcache primary_worker_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: primary_worker_key set in memcache primary_worker_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">primary_worker_pid</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">main_process_pid_from_memcache</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: trying to set flux.main_process_pid in Redis as retrieved from memcache&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flux.main_process_pid&#39;</span><span class="p">,</span> <span class="n">main_process_pid</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed_over_to_memcache</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set Redis flux.main_process_pid key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">main_process_pid_from_memcache</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: set flux.main_process_pid in Redis, deleting memcache key as Redis available&#39;</span><span class="p">)</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="n">delete_memcache_key</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;flux.main_process_pid&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to delete memcache primary_worker_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: deleted flux.main_process_pid memcache key as Redis available&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_sent_to_graphite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="n">metrics_sent_to_graphite</span> <span class="o">=</span> <span class="mi">0</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>