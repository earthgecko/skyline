<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>flux.listen &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">flux.listen</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for flux.listen</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">listen.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="c1"># from multiprocessing import Queue</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

<span class="c1"># @added 20220209 - Feature #4284: flux - telegraf</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<span class="c1"># @added 20220722 - Task #4624: Change all dict copy to deepcopy</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="c1"># @added 20221118 - Feature #4732: flux vortex</span>
<span class="c1">#                   Feature #4734: mirage_vortex</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">logger</span> <span class="kn">import</span> <span class="n">set_up_logging</span>

<span class="kn">import</span> <span class="nn">falcon</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>

<span class="c1"># @modified 20191115 - Branch #3262: py3</span>
<span class="c1"># This prevents flake8 E402 - module level import not at top of file</span>
<span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">settings</span>
    <span class="kn">import</span> <span class="nn">flux</span>
    <span class="c1"># @added 20201018 - Feature #3798: FLUX_PERSIST_QUEUE</span>
    <span class="c1"># @modified 20210406 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
    <span class="c1"># Added get_redis_conn_decoded</span>
    <span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="n">get_redis_conn</span><span class="p">,</span> <span class="n">get_redis_conn_decoded</span>
    <span class="c1"># @added 20220208 - Feature #4432: functions.metrics.skip_metric</span>
    <span class="kn">from</span> <span class="nn">functions.metrics.skip_metric</span> <span class="kn">import</span> <span class="n">skip_metric</span>

    <span class="c1"># @added 20220405 - Feature #4516: flux - opentelemetry traces</span>
    <span class="n">FLUX_OTEL_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">FLUX_OTEL_ENABLED</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_OTEL_ENABLED</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">FLUX_OTEL_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
        <span class="n">FLUX_OTEL_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">FLUX_OTEL_ENABLED</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">opentelemetry.proto.trace.v1</span> <span class="kn">import</span> <span class="n">trace_pb2</span>
        <span class="kn">from</span> <span class="nn">google.protobuf</span> <span class="kn">import</span> <span class="n">json_format</span> <span class="k">as</span> <span class="n">pb_json_format</span>

    <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">functions.memcache.get_memcache_key</span> <span class="kn">import</span> <span class="n">get_memcache_key</span>
        <span class="kn">from</span> <span class="nn">functions.memcache.set_memcache_key</span> <span class="kn">import</span> <span class="n">set_memcache_key</span>
        <span class="kn">from</span> <span class="nn">functions.memcache.delete_memcache_key</span> <span class="kn">import</span> <span class="n">delete_memcache_key</span>
        <span class="kn">from</span> <span class="nn">functions.memcache.incr_memcache_key</span> <span class="kn">import</span> <span class="n">incr_memcache_key</span>
        <span class="kn">from</span> <span class="nn">functions.memcache.append_memcache_key</span> <span class="kn">import</span> <span class="n">append_memcache_key</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">get_memcache_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">set_memcache_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">delete_memcache_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">incr_memcache_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">append_memcache_key</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># @added 20200818 - Feature #3694: flux - POST multiple metrics</span>
<span class="c1"># Added validation of FLUX_API_KEYS</span>
<span class="n">valid_keys</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_SELF_API_KEY</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SELF_API_KEY</span>
    <span class="n">valid_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FLUX_SELF_API_KEY</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">FLUX_API_KEYS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
    <span class="c1"># FLUX_API_KEYS = settings.FLUX_API_KEYS.copy()</span>
    <span class="n">FLUX_API_KEYS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLUX_API_KEYS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">if</span> <span class="n">FLUX_API_KEYS</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">flux_api_key</span> <span class="ow">in</span> <span class="n">FLUX_API_KEYS</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">valid_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">flux_api_key</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># @added 20201006 - Feature #3764: flux validate metric name</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_GRAPHITE_WHISPER_PATH</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_GRAPHITE_WHISPER_PATH</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_GRAPHITE_WHISPER_PATH</span> <span class="o">=</span> <span class="s1">&#39;/opt/graphite/storage/whisper&#39;</span>

<span class="c1"># added 20201016 - Feature #3788: snab_flux_load_test</span>
<span class="c1"># Wrap per metric logging in if FLUX_VERBOSE_LOGGING</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_VERBOSE_LOGGING</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_VERBOSE_LOGGING</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_VERBOSE_LOGGING</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># @added 20201018 - Feature #3798: FLUX_PERSIST_QUEUE</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_PERSIST_QUEUE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_PERSIST_QUEUE</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_PERSIST_QUEUE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20210406 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
    <span class="c1"># FLUX_AGGREGATE_NAMESPACES = settings.FLUX_AGGREGATE_NAMESPACES.copy()</span>
    <span class="n">FLUX_AGGREGATE_NAMESPACES</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLUX_AGGREGATE_NAMESPACES</span><span class="p">)</span>
    <span class="c1"># aggregate_namespaces = list(FLUX_AGGREGATE_NAMESPACES.keys())</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_AGGREGATE_NAMESPACES</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># aggregate_namespaces = []</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">FLUX_EXTERNAL_AGGREGATE_NAMESPACES</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_EXTERNAL_AGGREGATE_NAMESPACES</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FLUX_EXTERNAL_AGGREGATE_NAMESPACES</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20221129 - Feature #4732: flux vortex</span>
<span class="c1">#                   Feature #4734: mirage_vortex</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">VORTEX_TIMESERIES_JSON_TO_DISK</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_TIMESERIES_JSON_TO_DISK</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VORTEX_TIMESERIES_JSON_TO_DISK</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">HORIZON_SHARDS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">HORIZON_SHARDS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">HORIZON_SHARDS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">HORIZON_SHARD_DEBUG</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">HORIZON_SHARD_DEBUG</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">HORIZON_SHARD_DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">number_of_horizon_shards</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">this_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">HORIZON_SHARD</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
    <span class="n">number_of_horizon_shards</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">HORIZON_SHARDS</span><span class="p">)</span>
    <span class="n">HORIZON_SHARD</span> <span class="o">=</span> <span class="n">HORIZON_SHARDS</span><span class="p">[</span><span class="n">this_host</span><span class="p">]</span>
<span class="n">number_of_horizon_test_shards</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">HORIZON_TEST_SHARD</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">HORIZON_TEST_SHARDS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">HORIZON_TEST_SHARDS</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">HORIZON_TEST_SHARDS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">if</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">:</span>
    <span class="n">number_of_horizon_shards</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">HORIZON_TEST_SHARDS</span><span class="p">)</span>
    <span class="n">HORIZON_TEST_SHARD</span> <span class="o">=</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">[</span><span class="n">this_host</span><span class="p">]</span>
<span class="k">if</span> <span class="n">HORIZON_SHARDS</span> <span class="ow">or</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">zlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">VORTEX_ALLOWED_SHARD_TEST_KEYS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_ALLOWED_SHARD_TEST_KEYS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VORTEX_ALLOWED_SHARD_TEST_KEYS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;URG3U7IrNo18VheSZwP7Jyvg0jWs55Sn&#39;</span><span class="p">]</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">VORTEX_MAX_ALGORITHMS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">VORTEX_MAX_ALGORITHMS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VORTEX_MAX_ALGORITHMS</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># @modified 20191129 - Branch #3262: py3</span>
<span class="c1"># Consolidate flux logging</span>
<span class="c1"># logger = set_up_logging(&#39;listen&#39;)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_logging</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="n">LOCAL_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># @added 20230531 - SAVE_DEBUG_INFO</span>
<span class="n">SAVE_DEBUG_INFO</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
<span class="c1"># This is a debug feature that allows to enable timing of functions to ensure</span>
<span class="c1"># performance is maintained as much as possible</span>
<span class="n">TIMINGS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @modified 20220209 - Feature #4284: flux - telegraf</span>
<span class="c1"># Allow :</span>
<span class="c1"># ALLOWED_CHARS = [&#39;+&#39;, &#39;-&#39;, &#39;%&#39;, &#39;.&#39;, &#39;_&#39;, &#39;/&#39;, &#39;=&#39;]</span>
<span class="n">ALLOWED_CHARS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">:</span>
    <span class="n">ALLOWED_CHARS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
<span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">:</span>
    <span class="n">ALLOWED_CHARS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
<span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">:</span>
    <span class="n">ALLOWED_CHARS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

<span class="c1"># @added 20201018 - Feature #3798: FLUX_PERSIST_QUEUE</span>
<span class="c1"># @modified 20220426 - Feature #4536: Handle Redis failure</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">redis_conn</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">redis_conn_decoded</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># @added 20220208 - Feature #4432: functions.metrics.skip_metric</span>
<span class="c1">#                   Feature #4400: flux - quota</span>
<span class="n">external_settings_namespaces</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20210406 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
<span class="n">aggregate_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">if</span> <span class="n">FLUX_AGGREGATE_NAMESPACES</span> <span class="ow">or</span> <span class="n">FLUX_EXTERNAL_AGGREGATE_NAMESPACES</span><span class="p">:</span>
    <span class="c1"># redis_conn_decoded = get_redis_conn_decoded(&#39;flux&#39;)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">aggregate_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.aggregate_metrics&#39;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: there are </span><span class="si">%s</span><span class="s1"> metrics in the metrics_manager.flux.aggregate_metrics Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aggregate_metrics</span><span class="p">))))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not get Redis set metrics_manager.flux.aggregate_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">outer_err</span><span class="p">))</span>
        <span class="n">aggregate_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
        <span class="c1"># Add flux required data to memcache as well</span>
        <span class="k">if</span> <span class="n">get_memcache_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">aggregate_metrics</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics_manager.flux.aggregate_metrics&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">aggregate_metrics</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: there are </span><span class="si">%s</span><span class="s1"> metrics in the metrics_manager.flux.aggregate_metrics memcache set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aggregate_metrics</span><span class="p">))))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">aggregate_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: failed to get metrics_manager.flux.aggregate_metrics memcache list&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err2</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not get memcache set metrics_manager.flux.aggregate_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">outer_err2</span><span class="p">))</span>
                <span class="n">aggregate_metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">external_flux_keys</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">skyline_external_settings</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">skyline_external_settings_raw</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">skyline_external_settings_raw</span><span class="p">:</span>
        <span class="n">skyline_external_settings</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">skyline_external_settings_raw</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not get Redis set skyline.external_settings - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">outer_err</span><span class="p">))</span>
    <span class="n">skyline_external_settings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
    <span class="c1"># Add flux required data to memcache as well</span>
    <span class="k">if</span> <span class="n">get_memcache_key</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">skyline_external_settings</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;skyline.external_settings&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">skyline_external_settings</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: there are </span><span class="si">%s</span><span class="s1"> items in the skyline.external_settings memcache dict&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">skyline_external_settings</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">skyline_external_settings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: failed to get skyline.external_settings memcache dict&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not get memcache set skyline.external_settings - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">outer_err2</span><span class="p">))</span>
            <span class="n">skyline_external_settings</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">if</span> <span class="n">skyline_external_settings</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">settings_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">skyline_external_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">external_setting_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="s1">&#39;flux_token&#39;</span> <span class="ow">in</span> <span class="n">external_setting_keys</span><span class="p">:</span>
            <span class="n">flux_token</span> <span class="o">=</span> <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">][</span><span class="s1">&#39;flux_token&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">flux_token</span><span class="p">:</span>
                <span class="n">valid_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">flux_token</span><span class="p">))</span>
                <span class="n">external_flux_keys</span><span class="p">[</span><span class="n">flux_token</span><span class="p">]</span> <span class="o">=</span> <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span>
        <span class="c1"># @added 20220208 - Feature #4432: functions.metrics.skip_metric</span>
        <span class="c1">#                   Feature #4400: flux - quota</span>
        <span class="k">if</span> <span class="s1">&#39;namespace&#39;</span> <span class="ow">in</span> <span class="n">external_setting_keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">external_settings_namespaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not append skyline_external_settings[</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">][</span><span class="se">\&#39;</span><span class="s1">namespace</span><span class="se">\&#39;</span><span class="s1">] to external_settings_namespaces - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">settings_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">outer_err</span><span class="p">)))</span>

<span class="c1"># @added 20220208 - Feature #4432: functions.metrics.skip_metric</span>
<span class="n">ALL_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ALL_SKIP_LIST</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKIP_LIST</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="n">ALL_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ALL_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DO_NOT_SKIP_LIST</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">if</span> <span class="n">skyline_external_settings</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">settings_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">skyline_external_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">external_setting_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">external_namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">external_namespace</span> <span class="o">=</span> <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">external_namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">external_namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;skip_metrics&#39;</span> <span class="ow">in</span> <span class="n">external_setting_keys</span><span class="p">:</span>
            <span class="n">skip_metrics</span> <span class="o">=</span> <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">][</span><span class="s1">&#39;skip_metrics&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">skip_metrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skip_metrics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">external_namespace</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">skip_metrics</span><span class="p">:</span>
                            <span class="n">metric_namespaces</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">external_namespace</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
                            <span class="n">ALL_SKIP_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_namespaces</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ALL_SKIP_LIST</span> <span class="o">=</span> <span class="n">ALL_SKIP_LIST</span> <span class="o">+</span> <span class="n">skip_metrics</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">][</span><span class="s1">&#39;skip_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">do_not_skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;do_not_skip_metrics&#39;</span> <span class="ow">in</span> <span class="n">external_setting_keys</span><span class="p">:</span>
            <span class="n">do_not_skip_metrics</span> <span class="o">=</span> <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">][</span><span class="s1">&#39;do_not_skip_metrics&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">do_not_skip_metrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">do_not_skip_metrics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">external_namespace</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">do_not_skip_metrics</span><span class="p">:</span>
                            <span class="n">metric_namespaces</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">external_namespace</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
                            <span class="n">ALL_DO_NOT_SKIP_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_namespaces</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="n">ALL_DO_NOT_SKIP_LIST</span> <span class="o">+</span> <span class="n">do_not_skip_metrics</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">settings_key</span><span class="p">][</span><span class="s1">&#39;do_not_skip_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># @added 20220126 - Feature #4400: flux - quota</span>
<span class="n">namespace_quotas_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">namespace_quotas_dict</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to hgetall metrics_manager.flux.namespace_quotas Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">outer_err</span><span class="p">))</span>
    <span class="n">namespace_quotas_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
    <span class="c1"># Add flux required data to memcache as well</span>
    <span class="k">if</span> <span class="n">get_memcache_key</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">namespace_quotas_dict</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics_manager.flux.namespace_quotas&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">namespace_quotas_dict</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: there are </span><span class="si">%s</span><span class="s1"> items in the namespace_quotas_dict memcache dict&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">namespace_quotas_dict</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: failed to get namespace_quotas_dict memcache dict&#39;</span><span class="p">)</span>
                <span class="n">namespace_quotas_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not get memcache dict metrics_manager.flux.namespace_quotas - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">outer_err2</span><span class="p">))</span>
            <span class="n">namespace_quotas_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">namespaces_with_quotas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespace_quotas_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">namespaces_with_quotas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>

<span class="c1"># @added 20220202 - Feature #4412: flux - quota - thunder alert</span>
<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;flux&#39;</span>
<span class="k">if</span> <span class="n">namespaces_with_quotas</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">functions.thunder.send_event</span> <span class="kn">import</span> <span class="n">thunder_send_event</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">thunder_send_event</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># @added 20220128 - Feature #4404: flux - external_settings - aggregation</span>
<span class="c1">#                   Feature #4324: flux - reload external_settings</span>
<span class="c1">#                   Feature #4376: webapp - update_external_settings</span>
<span class="n">aggregate_namespaces_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">aggregate_namespaces_dict</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.aggregate_namespaces&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to hgetall metrics_manager.flux.aggregate_namespaces Redis hash key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">outer_err</span><span class="p">))</span>
    <span class="n">aggregate_namespaces_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
    <span class="c1"># Add flux required data to memcache as well</span>
    <span class="k">if</span> <span class="n">get_memcache_key</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aggregate_namespaces_dict</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics_manager.flux.aggregate_namespaces&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">aggregate_namespaces_dict</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: there are </span><span class="si">%s</span><span class="s1"> items in the aggregate_namespaces_dict memcache dict&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aggregate_namespaces_dict</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aggregate_namespaces_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: failed to get metrics_manager.flux.aggregate_namespaces memcache dict&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_err2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not get memcache dict metrics_manager.flux.aggregate_namespaces - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">outer_err2</span><span class="p">))</span>
            <span class="n">aggregate_namespaces_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">aggregate_namespaces_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">aggregate_namespaces_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">aggregate_namespaces_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>


<span class="c1"># @added 20220117 - Feature #4324: flux - reload external_settings</span>
<span class="c1">#                   Feature #4376: webapp - update_external_settings</span>
<div class="viewcode-block" id="check_validate_key_update"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.check_validate_key_update">[docs]</a><span class="k">def</span> <span class="nf">check_validate_key_update</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>

    <span class="n">updated_valid_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">UPDATED_FLUX_SELF_API_KEY</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SELF_API_KEY</span>
        <span class="n">updated_valid_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UPDATED_FLUX_SELF_API_KEY</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">UPDATED_FLUX_API_KEYS</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
        <span class="c1"># UPDATED_FLUX_API_KEYS = settings.FLUX_API_KEYS.copy()</span>
        <span class="n">UPDATED_FLUX_API_KEYS</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLUX_API_KEYS</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">UPDATED_FLUX_API_KEYS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">updated_flux_api_key</span> <span class="ow">in</span> <span class="n">UPDATED_FLUX_API_KEYS</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">updated_valid_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">updated_flux_api_key</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="n">updated_external_flux_keys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">updated_skyline_external_settings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">updated_skyline_external_settings_raw</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">updated_skyline_external_settings_raw</span><span class="p">:</span>
            <span class="n">updated_skyline_external_settings</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">updated_skyline_external_settings_raw</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: </span><span class="si">%s</span><span class="s1"> - could get Redis set skyline.external_settings - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">updated_skyline_external_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
        <span class="c1"># Add flux required data to memcache as well</span>
        <span class="k">if</span> <span class="n">get_memcache_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">updated_skyline_external_settings</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;skyline.external_settings&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">updated_skyline_external_settings</span><span class="p">:</span>
                    <span class="n">updated_skyline_external_settings</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could get memcache set skyline.external_settings - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">updated_skyline_external_settings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">updated_skyline_external_settings</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">updated_setting</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">updated_skyline_external_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="s1">&#39;flux_token&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">updated_skyline_external_settings</span><span class="p">[</span><span class="n">updated_setting</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">new_flux_token</span> <span class="o">=</span> <span class="n">updated_skyline_external_settings</span><span class="p">[</span><span class="n">updated_setting</span><span class="p">][</span><span class="s1">&#39;flux_token&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">new_flux_token</span><span class="p">:</span>
                    <span class="n">updated_valid_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_flux_token</span><span class="p">))</span>
                    <span class="n">updated_external_flux_keys</span><span class="p">[</span><span class="n">new_flux_token</span><span class="p">]</span> <span class="o">=</span> <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">updated_setting</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">updated_valid_keys</span><span class="p">,</span> <span class="n">updated_external_flux_keys</span><span class="p">)</span></div>


<div class="viewcode-block" id="validate_key"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.validate_key">[docs]</a><span class="k">def</span> <span class="nf">validate_key</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">apikey</span><span class="p">):</span>

    <span class="c1"># @added 20200818 - Feature #3694: flux - POST multiple metrics</span>
    <span class="c1"># Added metric_namespace_prefix which is declared via the FLUX_API_KEYS</span>
    <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">keyValid</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">isAlNum</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">isAlNum</span> <span class="o">=</span> <span class="n">apikey</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">isAlNum</span><span class="p">:</span>
            <span class="n">keyLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">apikey</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyLength</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
                <span class="c1"># Check to determine if it is a valid API key</span>
                <span class="n">keyValid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
                <span class="c1"># semgrep - python-logger-credential-disclosure</span>
                <span class="c1"># logger.error(&#39;error :: %s :: invalid api key length of %s - %s&#39; % (</span>
                <span class="c1">#     caller, str(keyLength), str(apikey)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: invalid api key length&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">caller</span><span class="p">))</span>
        <span class="c1"># @added 20200818 - Feature #3694: flux - POST multiple metrics</span>
        <span class="c1"># Added validation of FLUX_API_KEYS</span>
        <span class="k">if</span> <span class="n">valid_keys</span> <span class="ow">and</span> <span class="n">keyValid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">apikey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_keys</span><span class="p">:</span>
                <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
                <span class="c1"># semgrep - python-logger-credential-disclosure</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: invalid api key - not known&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="c1"># caller, str(keyLength), str(apikey)))</span>
                    <span class="n">caller</span><span class="p">))</span>
                <span class="n">keyValid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">keyValid</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_API_KEYS</span><span class="p">[</span><span class="n">apikey</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">apikey</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">external_flux_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="n">external_flux_keys</span><span class="p">[</span><span class="n">apikey</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20220117 - Feature #4324: flux - reload external_settings</span>
        <span class="c1">#                   Feature #4376: webapp - update_external_settings</span>
        <span class="n">update_keys</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keyValid</span><span class="p">:</span>
            <span class="n">last_valid_keys_update</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">update_external_settings_key</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">last_valid_keys_update</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flux.last_valid_keys_update&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could get flux.last_valid_keys_update from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">last_valid_keys_update</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">last_valid_keys_update</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_valid_keys_update</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="mi">30</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: last valid key update check was more than 30 seconds ago, checking update&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">caller</span><span class="p">))</span>
                    <span class="n">update_keys</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">update_keys</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">update_external_settings_key</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skyline.external_settings.update.flux&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could get skyline.external_settings.update.flux from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="n">last_valid_keys_update</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">update_external_settings_key</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: skyline.external_settings.update.flux, updating keys&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">caller</span><span class="p">))</span>
                    <span class="n">update_keys</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">updated_valid_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">updated_external_flux_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">update_keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">updated_valid_keys</span><span class="p">,</span> <span class="n">updated_external_flux_keys</span> <span class="o">=</span> <span class="n">check_validate_key_update</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: check_validate_key_update failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">updated_valid_keys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">updated_external_flux_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">updated_valid_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">uv_key</span> <span class="ow">in</span> <span class="n">updated_valid_keys</span><span class="p">:</span>
                <span class="n">valid_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uv_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">updated_external_flux_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">uv_key</span> <span class="ow">in</span> <span class="n">updated_external_flux_keys</span><span class="p">:</span>
                <span class="n">valid_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uv_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_keys</span> <span class="ow">and</span> <span class="n">valid_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">apikey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_keys</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: invalid api key - not known&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">caller</span><span class="p">))</span>
                <span class="n">keyValid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">keyValid</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_API_KEYS</span><span class="p">[</span><span class="n">apikey</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">apikey</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">external_flux_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="n">external_flux_keys</span><span class="p">[</span><span class="n">apikey</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keyValid</span><span class="p">:</span>
            <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
            <span class="c1"># semgrep - python-logger-credential-disclosure</span>
            <span class="c1"># logger.error(&#39;error :: %s :: invalid api key - %s&#39; % (</span>
            <span class="c1">#    caller, str(apikey)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: invalid api key&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">caller</span><span class="p">))</span>
            <span class="c1"># resp.status = falcon.HTTP_400</span>
            <span class="c1"># @modified 20200818 - Feature #3694: flux - POST multiple metrics</span>
            <span class="c1"># Added metric_namespace_prefix</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">metric_namespace_prefix</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="c1"># @modified 20210421 - Task #4030: refactoring</span>
        <span class="c1"># semgrep - python-logger-credential-disclosure</span>
        <span class="c1"># logger.error(&#39;error :: %s :: failed to validate api key - %s&#39; % (</span>
        <span class="c1">#     caller, str(apikey)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: failed to validate api key&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">caller</span><span class="p">))</span>
        <span class="c1"># resp.status = falcon.HTTP_400</span>
        <span class="c1"># @modified 20200818 - Feature #3694: flux - POST multiple metrics</span>
        <span class="c1"># Added metric_namespace_prefix</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">metric_namespace_prefix</span>

    <span class="c1"># @modified 20200818 - Feature #3694: flux - POST multiple metrics</span>
    <span class="c1"># Added metric_namespace_prefix</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">metric_namespace_prefix</span></div>


<div class="viewcode-block" id="validate_timestamp"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.validate_timestamp">[docs]</a><span class="k">def</span> <span class="nf">validate_timestamp</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>

    <span class="n">timestampInvalidReason</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: the timestamp is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)))</span>
        <span class="n">timestampInvalidReason</span> <span class="o">=</span> <span class="s1">&#39;timestamp is not an int&#39;</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">timestampInvalidReason</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: the timestamp value is not 10 digits - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">caller</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)))</span>
            <span class="n">timestampInvalidReason</span> <span class="o">=</span> <span class="s1">&#39;timestamp is not a valid current unix timestamp&#39;</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">timestampInvalidReason</span>
        <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

        <span class="c1"># @added 20200107 - Task #3376: Enable vista and flux to deal with lower frequency data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flux_max_age</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_MAX_AGE</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: validate_timestamp FLUX_MAX_AGE is not set in settings.py, set to the default 3600 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">caller</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">flux_max_age</span> <span class="o">=</span> <span class="mi">3600</span>

        <span class="c1"># @modified 20200107 - Task #3376: Enable vista and flux to deal with lower frequency data</span>
        <span class="c1"># tooOld = now - settings.STALE_PERIOD</span>
        <span class="n">tooOld</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">flux_max_age</span>

        <span class="n">timestampValid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">timestampInvalidReason</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">tooOld</span><span class="p">:</span>
            <span class="n">timestampInvalidReason</span> <span class="o">=</span> <span class="s1">&#39;timestamp is too old, older than </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">flux_max_age</span><span class="p">)</span>
            <span class="n">timestampValid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># @modified 20200828 - Task #3718: Allow flux to handle timestamp in the same minute period</span>
        <span class="c1"># if timestamp &gt; now:</span>
        <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="mi">60</span><span class="p">):</span>
            <span class="c1"># @modified 20200828 - Task #3718: Allow flux to handle timestamp in the same minute period</span>
            <span class="c1"># timestampInvalidReason = &#39;timestamp is in the future&#39;</span>
            <span class="n">timestampInvalidReason</span> <span class="o">=</span> <span class="s1">&#39;timestamp is more than 1 minute in the future&#39;</span>
            <span class="n">timestampValid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestampValid</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: timestamp in request data is not a valid timestamp - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">caller</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestampInvalidReason</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)))</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">timestampInvalidReason</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: validating timestamp argument value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)))</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">timestampInvalidReason</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">timestampInvalidReason</span></div>


<span class="c1"># @added 20201006 - Feature #3764: flux validate metric name</span>
<div class="viewcode-block" id="validate_metric_name"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.validate_metric_name">[docs]</a><span class="k">def</span> <span class="nf">validate_metric_name</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>

    <span class="c1"># @modified 20220211 - Feature #4380: flux - return reason with 400</span>
    <span class="c1"># Added reason</span>
    <span class="n">reason</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">vchar</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vchar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_CHARS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: invalid char in metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">caller</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)))</span>
            <span class="c1"># @modified 20220211 - Feature #4380: flux - return reason with 400</span>
            <span class="c1"># Added reason</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;invalid characters in name&#39;</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">reason</span>
    <span class="c1"># Check for prohibited chars</span>
    <span class="c1"># prohibitedTagChars = &#39;;!^=&#39;</span>
    <span class="c1"># for char in metric:</span>
    <span class="c1">#     if char in prohibitedTagChars:</span>
    <span class="c1">#         return False</span>

    <span class="c1"># Linux has a maximum filename length of 255 characters for most filesystems</span>
    <span class="c1"># and a maximum path of 4096 characters.</span>
    <span class="c1"># @modified 20201020 - Feature #3764: flux validate metric name</span>
    <span class="c1"># By elements not by metric name</span>
    <span class="c1"># if (len(metric) + 4) &gt; 255:   # +4 for .wsp</span>
    <span class="n">metric_elements</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: metric longer than 255 chars - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)))</span>
        <span class="c1"># @modified 20220211 - Feature #4380: flux - return reason with 400</span>
        <span class="c1"># Added reason</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;longer than 255 characters&#39;</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">reason</span>
    <span class="n">metric_dir</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">full_whisper_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.wsp&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FLUX_GRAPHITE_WHISPER_PATH</span><span class="p">,</span> <span class="n">metric_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_whisper_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> :: metric path longer than 4096 chars - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_whisper_path</span><span class="p">)))</span>
        <span class="c1"># @modified 20220211 - Feature #4380: flux - return reason with 400</span>
        <span class="c1"># Added reason</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;name too long&#39;</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">reason</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">reason</span></div>


<span class="c1"># @added 20210406 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
<span class="c1"># To reduce the overhead of making a redis query for every metric</span>
<span class="c1"># submitted, the metric name is checked against the initial loaded</span>
<span class="c1"># aggregate_metrics list, if not found in there then the elements of the</span>
<span class="c1"># metric name are checked to see if element could any possible match an</span>
<span class="c1"># aggregation namespace, only then is Redis queried.</span>
<span class="c1"># @modified 20220128 - Feature #4404: flux - external_settings - aggregation</span>
<span class="c1">#                      Feature #4324: flux - reload external_settings</span>
<span class="c1">#                     Feature #4376: webapp - update_external_settings</span>
<span class="c1"># def add_to_aggregate_metric_queue(metric, metric_data, aggregate_metrics_list):</span>
<div class="viewcode-block" id="add_to_aggregate_metric_queue"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.add_to_aggregate_metric_queue">[docs]</a><span class="k">def</span> <span class="nf">add_to_aggregate_metric_queue</span><span class="p">(</span>
        <span class="n">metric</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">aggregate_metrics_list</span><span class="p">,</span> <span class="n">aggregate_namespaces_lst</span><span class="p">):</span>
    <span class="n">added_to_aggregation_queue</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">return_status_code</span> <span class="o">=</span> <span class="mi">204</span>
    <span class="n">aggregate_metric</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># First check the list of aggregate_metrics created at startup from</span>
    <span class="c1"># the analyzer/metrics_manager metrics_manager.flux.aggregate_metrics Redis</span>
    <span class="c1"># set and if not in there try the Redis metrics_manager.flux.aggregate_metrics.hash</span>
    <span class="k">if</span> <span class="n">aggregate_metrics_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">aggregate_metrics_list</span><span class="p">:</span>
            <span class="n">aggregate_metric</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># @modified 20220128 - Feature #4404: flux - external_settings - aggregation</span>
    <span class="c1">#                      Feature #4324: flux - reload external_settings</span>
    <span class="c1">#                     Feature #4376: webapp - update_external_settings</span>
    <span class="c1"># Do not use query Redis, use lists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">aggregate_metric</span> <span class="ow">and</span> <span class="n">aggregate_namespaces_lst</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">agg_namespace</span> <span class="ow">in</span> <span class="n">aggregate_namespaces_lst</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">agg_namespace</span><span class="p">):</span>
                <span class="n">aggregate_metric</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

    <span class="n">aggregate_metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @modified 20220128 - Feature #4404: flux - external_settings - aggregation</span>
    <span class="c1">#                      Feature #4324: flux - reload external_settings</span>
    <span class="c1">#                     Feature #4376: webapp - update_external_settings</span>
    <span class="c1"># Do not use query Redis, use lists</span>
    <span class="c1"># if not aggregate_metric:</span>
    <span class="k">if</span> <span class="n">aggregate_metric_timestamp</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># current_redis_conn_decoded = get_redis_conn_decoded(&#39;flux&#39;)</span>
            <span class="n">aggregate_metric_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.aggregate_metrics.hash&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could get metric </span><span class="si">%s</span><span class="s1"> from Redis hash metrics_manager.flux.aggregate_metrics.hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="n">aggregate_metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">aggregate_metric_timestamp</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">aggregate_metric_timestamp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">):</span>
                <span class="n">aggregate_metric</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">aggregate_metric_timestamp</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;metrics_manager.flux.aggregate_metrics.hash&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: deleted metric </span><span class="si">%s</span><span class="s1"> from Redis hash metrics_manager.flux.aggregate_metrics.hash as entry is 12 hours old&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not delete metric </span><span class="si">%s</span><span class="s1"> from Redis hash metrics_manager.flux.aggregate_metrics.hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                        <span class="n">aggregate_metric_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># @added 20210718</span>
    <span class="c1"># Added aggregate</span>
    <span class="n">aggregate_passed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">aggregate_passed</span> <span class="o">=</span> <span class="n">metric_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">aggregate_passed</span><span class="p">:</span>
            <span class="n">aggregate_metric</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">aggregate_passed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: add_to_aggregate_metric_queue could determine aggregate from metric_data for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">aggregate_passed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Add the metric to the flux/aggregator queue</span>
    <span class="k">if</span> <span class="n">aggregate_metric</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.aggregator.queue&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
            <span class="n">added_to_aggregation_queue</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">return_status_code</span> <span class="o">=</span> <span class="mi">204</span>
            <span class="c1"># if FLUX_VERBOSE_LOGGING:</span>
            <span class="c1">#     logger.info(&#39;listen :: data added to flux.aggregator.queue Redis set - %s&#39; % str(metric_data))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># logger.error(traceback.format_exc())</span>
            <span class="c1"># logger.error(&#39;error :: listen :: failed to add data to flux.aggregator.queue Redis set - %s&#39; % str(metric_data))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add data to flux.aggregator.queue Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">return_status_code</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="n">added_to_aggregation_queue</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># return added_to_aggregation_queue, return_status_code</span>
            <span class="c1"># @added 20220429 - Feature #4536: Handle Redis failure</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">memcache_data</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="n">append_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.aggregator.queue&#39;</span><span class="p">,</span> <span class="n">memcache_data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to append to memcache flux.aggregator.queue key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">added_to_aggregation_queue</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">return_status_code</span> <span class="o">=</span> <span class="mi">204</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: data added to flux.aggregator.queue memcache key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">memcache_data</span><span class="p">))</span>

    <span class="c1"># @added 20220429 - Feature #4536: Handle Redis failure</span>
    <span class="k">if</span> <span class="n">added_to_aggregation_queue</span><span class="p">:</span>
        <span class="n">return_status_code</span> <span class="o">=</span> <span class="mi">204</span>
        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: data added to flux.aggregator.queue Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">added_to_aggregation_queue</span><span class="p">,</span> <span class="n">return_status_code</span></div>


<span class="c1"># @added 20220126 - Feature #4400: flux - quota</span>
<div class="viewcode-block" id="get_namespace_quota"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.get_namespace_quota">[docs]</a><span class="k">def</span> <span class="nf">get_namespace_quota</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">):</span>
    <span class="n">quota</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">quota_str</span> <span class="o">=</span> <span class="n">namespace_quotas_dict</span><span class="p">[</span><span class="n">metric_namespace_prefix</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">quota_str</span><span class="p">:</span>
            <span class="n">quota</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">quota_str</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">quota</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">quota</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">quota</span></div>


<div class="viewcode-block" id="MetricData"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.MetricData">[docs]</a><span class="k">class</span> <span class="nc">MetricData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<div class="viewcode-block" id="MetricData.on_get"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.MetricData.on_get">[docs]</a>    <span class="k">def</span> <span class="nf">on_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The /flux/metric_data endpoint is called via a GET with the URI</span>
<span class="sd">        parameters as defined below, with the optional fill parameter to allow</span>
<span class="sd">        flux to backfill airgap data for a metric:</span>
<span class="sd">        /flux/metric_data?metric=&lt;metric|str&gt;&amp;timestamp=&lt;timestamp|int&gt;&amp;value=&lt;value|float&gt;&amp;key=&lt;key|str&gt;[&amp;fill=true]</span>
<span class="sd">        For example:</span>
<span class="sd">        /flux/metric_data?metric=vista.nodes.skyline-1.cpu.user&amp;timestamp=1478021700&amp;value=1.0&amp;key=YOURown32charSkylineAPIkeySecret</span>
<span class="sd">        /flux/metric_data?metric=vista.nodes.skyline-1.cpu.user&amp;timestamp=1478021700&amp;value=1.0&amp;key=YOURown32charSkylineAPIkeySecret&amp;fill=true</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: GET request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">))</span>

        <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
        <span class="n">start_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

        <span class="c1"># @modified 20200115 - Feature #3394: flux health check</span>
        <span class="c1"># Added status parameter so that the flux listen process can be monitored</span>
        <span class="c1"># @modified 20200206 - Feature #3444: Allow flux to backfill</span>
        <span class="c1"># Added the fill parameter</span>
        <span class="c1"># @modified 20230223 - Feature #4840: flux - prometheus - x-test-only header</span>
        <span class="c1"># Added test argument</span>
        <span class="n">validGetArguments</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;query_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)</span>

        <span class="n">apikey</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">valid_value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20200206 - Feature #3444: Allow flux to backfill</span>
        <span class="c1"># This needs to be iterated amd determined before the timestamp is</span>
        <span class="c1"># checked</span>
        <span class="n">backfill</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">request_param_key</span><span class="p">,</span> <span class="n">request_param_value</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;fill&#39;</span><span class="p">:</span>
                    <span class="n">fill</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fill</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">backfill</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not validate the fill key GET request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

        <span class="k">for</span> <span class="n">request_param_key</span><span class="p">,</span> <span class="n">request_param_value</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">validGetArguments</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: invalid key in request arguments - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>

                    <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_parameters&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Invalid parameter received - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                    <span class="k">return</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: validating request arguments - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>

                <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_parameters&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Invalid parameters&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="c1"># @added 20200115 - Feature #3394: flux health check</span>
            <span class="c1"># Added status parameter</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: GET </span><span class="si">%s</span><span class="s1"> - ok&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">))</span>

                    <span class="c1"># @added 20220329 - Feature #4018: thunder - skyline.errors</span>
                    <span class="c1"># Report app up</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;flux.listen&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: set flux.listen failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                    <span class="k">return</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not validate the status key GET request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="c1"># @modified 20200818 - Feature #3694: flux - POST multiple metrics</span>
            <span class="c1"># Added metric_namespace_prefix</span>
            <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;key&#39;</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">)</span>
                    <span class="c1"># @modified 20200818 - Feature #3694: flux - POST multiple metrics</span>
                    <span class="c1"># Added metric_namespace_prefix</span>
                    <span class="n">keyValid</span><span class="p">,</span> <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="n">validate_key</span><span class="p">(</span><span class="s1">&#39;listen :: MetricData GET&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">keyValid</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: invalid key in GET request arguments - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>

                        <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_key&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                        <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid key&#39;</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                        <span class="c1"># @modified 20210909</span>
                        <span class="c1"># Return 401 if bad key</span>
                        <span class="c1"># resp.status = falcon.HTTP_400</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_401</span>
                        <span class="k">return</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

                <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_key&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid key&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                <span class="c1"># @modified 20210909 - Feature #4380: flux - return reason with 400</span>
                <span class="c1"># Return 401 if bad key</span>
                <span class="c1"># resp.status = falcon.HTTP_400</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_401</span>
                <span class="k">return</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span>
                    <span class="c1"># @modified 20200206 - Feature #3444: Allow flux to backfill</span>
                    <span class="c1"># Only valid_timestamp is this is not a backfill request</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">backfill</span><span class="p">:</span>
                        <span class="c1"># @modified 20220114 - lint message</span>
                        <span class="n">valid_timestamp_message</span> <span class="o">=</span> <span class="s1">&#39;listen :: MetricData GET - parameter - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">)</span>
                        <span class="c1"># valid_timestamp = validate_timestamp(&#39;listen :: MetricData GET - parameter - %s&#39;, str(request_param_value))</span>
                        <span class="c1"># @modified 20220211 - Feature #4380: flux - return reason with 400</span>
                        <span class="c1"># Added reason</span>
                        <span class="n">valid_timestamp</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">validate_timestamp</span><span class="p">(</span><span class="n">valid_timestamp_message</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">valid_timestamp</span><span class="p">:</span>
                        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="n">unique_value</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">r_param_key</span><span class="p">,</span> <span class="n">r_param_value</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">r_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">r_param_value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">))</span>
                            <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_timestamp&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_timestamp&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                        <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                        <span class="c1"># @modified 20220211 - Feature #4380: flux - return reason with 400</span>
                        <span class="c1"># Added reason</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid timestamp - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                        <span class="k">return</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: invalid timestamp value from the GET request argument - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>

                <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                <span class="n">unique_value</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">r_param_key</span><span class="p">,</span> <span class="n">r_param_value</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">r_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">r_param_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">))</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_timestamp&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_timestamp&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid timestamp&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">)</span>
                <span class="c1"># @added 20201006 - Feature #3764: flux validate metric name</span>
                <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20220211 - Feature #4380: flux - return reason with 400</span>
                    <span class="c1"># Added reason</span>
                    <span class="n">valid_metric_name</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">validate_metric_name</span><span class="p">(</span><span class="s1">&#39;listen :: MetricData GET&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could validate_metric_name - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                    <span class="n">valid_metric_name</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_metric_name</span><span class="p">:</span>

                    <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.metric_name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.metric_name&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.metric_name - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                    <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                    <span class="c1"># @modified 20220211 - Feature #4380: flux - return reason with 400</span>
                    <span class="c1"># Added reason</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid metric - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                    <span class="k">return</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">)</span>
                    <span class="c1"># valid_value is used as in terms of Python if value evalatuion</span>
                    <span class="c1"># if value was 0.0 (or 0) they evaluate as False</span>
                    <span class="n">valid_value</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: invalid value from GET request argument - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>

                    <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_value&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_value&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                    <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">)</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                    <span class="k">return</span>

            <span class="n">request_param_key_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span>
            <span class="n">payload</span><span class="p">[</span><span class="n">request_param_key_str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: no key in the GET request arguments - </span><span class="si">%s</span><span class="s1"> - returning 400&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>

            <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
            <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_key&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no key parameter passed&#39;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: no metric in the GET request arguments - </span><span class="si">%s</span><span class="s1"> - returning 400&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>

            <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.metric_name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.metric_name&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.metric_name - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no metric parameter passed&#39;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_value</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: no valid value in the GET request arguments - </span><span class="si">%s</span><span class="s1"> - returning 400&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>

            <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_value&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_value&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no value parameter passed&#39;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
            <span class="k">return</span>

        <span class="c1"># TODO</span>
        <span class="c1"># token? in request header Authorization</span>
        <span class="c1"># Validate key and token</span>
        <span class="c1"># API keys and tokens stored in memcache and populated by worker?</span>
        <span class="c1"># Fetch key token</span>
        <span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># token = redis_conn.get(key)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

        <span class="c1"># @added 20220128 - Feature #4400: flux - quota</span>
        <span class="n">namespace_quota</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_namespace_metric_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">namespace_metrics_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rejected_metric_over_quota</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">check_namespace_quota</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
        <span class="c1"># Add flux required data to memcache as well</span>
        <span class="n">quota_metrics_from_memcache</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric_namespace_prefix</span><span class="p">:</span>
                <span class="n">check_namespace_quota</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check_namespace_quota</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">check_namespace_quota</span> <span class="ow">in</span> <span class="n">namespaces_with_quotas</span><span class="p">:</span>
                <span class="n">namespace_quota</span> <span class="o">=</span> <span class="n">get_namespace_quota</span><span class="p">(</span><span class="n">check_namespace_quota</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">namespace_quota</span><span class="p">:</span>
                <span class="n">namespace_quota_key_reference_timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                <span class="n">namespace_quota_redis_key</span> <span class="o">=</span> <span class="s1">&#39;flux.namespace_quota.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">check_namespace_quota</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_quota_key_reference_timestamp</span><span class="p">))</span>
                <span class="n">current_namespace_metric_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_namespace_metric_count</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="n">namespace_quota_redis_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">current_namespace_metric_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">quota_namespace_metrics_redis_key</span> <span class="o">=</span> <span class="s1">&#39;flux.quota.namespace_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_namespace_quota</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">quota_namespace_metrics_redis_key</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
                    <span class="c1"># Add flux required data to memcache as well</span>
                    <span class="k">if</span> <span class="n">get_memcache_key</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="n">quota_namespace_metrics_redis_key</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace_metrics</span><span class="p">:</span>
                                <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">quota_metrics_from_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could get memcache set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">quota_namespace_metrics_redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">namespace_metrics_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">namespace_metrics</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error determining namespace_quota, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">namespace_quota</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_namespace_metric_count</span> <span class="o">&gt;=</span> <span class="n">namespace_quota</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: will not accept new metric in this minute, over quota&#39;</span><span class="p">)</span>
                <span class="n">rejected_metric_over_quota</span> <span class="o">=</span> <span class="n">metric</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rejected_metric_over_quota</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">namespace_metrics</span><span class="p">:</span>
                        <span class="n">new_metric_count</span> <span class="o">=</span> <span class="n">namespace_metrics_count</span> <span class="o">+</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_metric_count</span> <span class="o">=</span> <span class="n">namespace_metrics_count</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">new_metric_count</span> <span class="o">&gt;</span> <span class="n">namespace_quota</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: will not accept new metric, over quota&#39;</span><span class="p">)</span>
                        <span class="n">rejected_metric_over_quota</span> <span class="o">=</span> <span class="n">metric</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error determining new metric for namespace_quota, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rejected_metric_over_quota</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;over metric quota&#39;</span><span class="p">,</span>
                <span class="s1">&#39;rejected metric&#39;</span><span class="p">:</span> <span class="n">rejected_metric_over_quota</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;over quota - this account is allowed </span><span class="si">%s</span><span class="s1"> metrics and an additional metric was posted that has been rejected&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">namespace_quota</span><span class="p">))</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                    <span class="s1">&#39;rejected metric&#39;</span><span class="p">:</span> <span class="n">rejected_metric_over_quota</span>
                <span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error building 400 body, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400 on metric_namespace_prefix: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">message</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">check_namespace_quota</span><span class="p">)))</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
            <span class="k">return</span>

        <span class="c1"># @added 20220128 - Feature #4400: flux - quota</span>
        <span class="k">if</span> <span class="n">namespace_quota</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namespace_metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">quota_namespace_metrics_redis_key</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric</span><span class="p">,</span> <span class="n">quota_namespace_metrics_redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error adding metric to quota_namespace_metrics_redis_key, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">namespace_quota_redis_key</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                <span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">namespace_quota_redis_key</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">metric</span><span class="p">,</span> <span class="n">namespace_quota_redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="c1"># @added 20210430 - Bug #4046: flux - metric_namespace_prefix on FLUX_SELF_API_KEY conflicting with FLUX_API_KEYS</span>
        <span class="c1"># If metrics are being submitted to flux internally (vista) using</span>
        <span class="c1"># the FLUX_SELF_API_KEY for a namespace if that namespace is added</span>
        <span class="c1"># to FLUX_API_KEYS, flux will begin to also append the namespace</span>
        <span class="c1"># prefix from the FLUX_API_KEYS for metrics submitted with the</span>
        <span class="c1"># FLUX_SELF_API_KEY</span>
        <span class="k">if</span> <span class="n">metric_namespace_prefix</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">):</span>
                <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @modified 20200818 - Feature #3694: flux - POST multiple metrics</span>
        <span class="c1"># Added metric_namespace_prefix which is declared via the FLUX_API_KEYS</span>
        <span class="k">if</span> <span class="n">metric_namespace_prefix</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">),</span> <span class="n">metric</span><span class="p">)</span>

        <span class="c1"># metric to add to queue</span>
        <span class="c1"># @modified 20200206 - Feature #3444: Allow flux to backfill</span>
        <span class="c1"># Added backfill</span>
        <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">backfill</span><span class="p">]</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;metric_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add metric_data to payload - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="c1"># @added 20230223 - Feature #4840: flux - prometheus - x-test-only header</span>
        <span class="n">test_only</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">test_only_metrics_submitted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">test_only_str</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;x-test-only&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">test_only_str</span><span class="p">:</span>
                <span class="n">test_only</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: get_header(</span><span class="se">\&#39;</span><span class="s1">x-test-only</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">request_param_key</span><span class="p">,</span> <span class="n">request_param_value</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">test_only</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
                        <span class="n">test_only_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">test_only_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                            <span class="n">test_only</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: get_header(</span><span class="se">\&#39;</span><span class="s1">x-test-only</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">test_only</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: test_only request&#39;</span><span class="p">)</span>
            <span class="n">test_only_metrics_submitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="n">current_aligned_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="n">test_only_redis_key</span> <span class="o">=</span> <span class="s1">&#39;flux.prometheus.test_only.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">))</span>
            <span class="n">test_only_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_only_data</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">test_only_redis_key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to hgetall </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">test_only_redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">test_only_data</span><span class="p">:</span>
                <span class="n">existing_test_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing_test_metrics</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">test_only_data</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">existing_test_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">all_test_metrics</span> <span class="o">=</span> <span class="n">test_only_metrics_submitted</span> <span class="o">+</span> <span class="n">existing_test_metrics</span>
                <span class="n">test_metrics_that_would_be_ingested</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_test_metrics</span><span class="p">))</span>
                <span class="n">existing_dropped_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing_dropped_metrics</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">test_only_redis_key</span><span class="p">[</span><span class="s1">&#39;dropped&#39;</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">existing_dropped_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">all_dropped_metrics</span> <span class="o">=</span> <span class="n">existing_dropped_metrics</span>
                <span class="n">test_metrics_that_would_be_dropped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_dropped_metrics</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_metrics_that_would_be_ingested</span> <span class="o">=</span> <span class="n">test_only_metrics_submitted</span>
                <span class="n">test_metrics_that_would_be_dropped</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ingest_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_metrics_that_would_be_ingested</span><span class="p">)</span>
            <span class="n">drop_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_metrics_that_would_be_dropped</span><span class="p">)</span>
            <span class="n">test_only_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">),</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;metric ingestion test, no metrics were ingested only counts are reported&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ingest_count&#39;</span><span class="p">:</span> <span class="n">ingest_count</span><span class="p">,</span>
                <span class="s1">&#39;drop_count&#39;</span><span class="p">:</span> <span class="n">drop_count</span><span class="p">,</span>
                <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_metrics_that_would_be_ingested</span><span class="p">),</span>
                <span class="s1">&#39;dropped&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_metrics_that_would_be_dropped</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: test_only creating Redis hash </span><span class="si">%s</span><span class="s1"> with ingest_count: </span><span class="si">%s</span><span class="s1">, drop_count: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">test_only_redis_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ingest_count</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">drop_count</span><span class="p">)))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">test_only_redis_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">test_only_data</span><span class="p">)</span>
                <span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">test_only_redis_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to hset </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">test_only_redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: test_only request completed&#39;</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">test_only_data</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
            <span class="k">return</span>

        <span class="c1"># @added 20201018 - Feature #3798: FLUX_PERSIST_QUEUE</span>
        <span class="c1"># Add to data to the flux.queue Redis set</span>
        <span class="k">if</span> <span class="n">FLUX_PERSIST_QUEUE</span> <span class="ow">and</span> <span class="n">metric_data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.queue&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># @added 20210406 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
        <span class="c1"># To reduce the overhead of making a redis query for every metric</span>
        <span class="c1"># submitted, the metric name is checked against the initial loaded</span>
        <span class="c1"># aggregate_metrics list, if not found in there then the elements of the</span>
        <span class="c1"># metric name are checked to see if element could any possible match an</span>
        <span class="c1"># aggregation namespace, only then is Redis queried.</span>
        <span class="k">if</span> <span class="n">aggregate_metrics</span> <span class="ow">or</span> <span class="n">aggregate_namespaces_list</span><span class="p">:</span>
            <span class="n">added_to_aggregation_queue</span><span class="p">,</span> <span class="n">return_status_code</span> <span class="o">=</span> <span class="n">add_to_aggregate_metric_queue</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">aggregate_metrics</span><span class="p">,</span> <span class="n">aggregate_namespaces_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">added_to_aggregation_queue</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">return_status_code</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                <span class="k">if</span> <span class="n">return_status_code</span> <span class="o">==</span> <span class="mi">204</span><span class="p">:</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_204</span>
                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">queue_size</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">httpMetricDataAggregatorQueue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: flux.httpMetricDataAggregatorQueue.qsize - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">queue_size</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to determine flux.httpMetricDataAggregatorQueue.qsize&#39;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># Queue the metric</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flux</span><span class="o">.</span><span class="n">httpMetricDataQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">metric_data</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># modified 20201016 - Feature #3788: snab_flux_load_test</span>
            <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: GET request data added to flux.httpMetricDataQueue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add GET request data to flux.httpMetricDataQueue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
            <span class="k">return</span>
        <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">redis_conn</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s1">&#39;flux.listen.added_to_queue&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># logger.error(&#39;error :: listen :: failed to increment to Redis key flux.listen.added_to_queue - %s&#39; % e)</span>
            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">incr_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.listen.added_to_queue&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">queue_size</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">httpMetricDataQueue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: flux.httpMetricDataQueue.qsize - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">queue_size</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to determine flux.httpMetricDataQueue.qsize&#39;</span><span class="p">)</span>

        <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
        <span class="n">end_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: GET request took </span><span class="si">%.6f</span><span class="s1"> seconds to process&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">end_request_timer</span> <span class="o">-</span> <span class="n">start_request_timer</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to calculate request time - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>

            <span class="c1"># @modified 20201207 - Task #3864: flux - try except everything</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to json.dumps(payload) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_204</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="MetricDataPost"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.MetricDataPost">[docs]</a><span class="k">class</span> <span class="nc">MetricDataPost</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<div class="viewcode-block" id="MetricDataPost.on_post"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.MetricDataPost.on_post">[docs]</a>    <span class="k">def</span> <span class="nf">on_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The /flux/metric_data_post endpoint is called via a POST with a json</span>
<span class="sd">        object as defined below, with the optional fill parameter to allow</span>
<span class="sd">        flux to backfill airgap data for a metric:</span>

<span class="sd">        For example::</span>

<span class="sd">            {</span>
<span class="sd">                &quot;metric&quot;: &quot;metric|str&quot;,</span>
<span class="sd">                &quot;timestamp&quot;: timestamp|int,</span>
<span class="sd">                &quot;value&quot;: value|float,</span>
<span class="sd">                &quot;key&quot;: &quot;api_key|str&quot;,</span>
<span class="sd">                &quot;fill&quot;: &quot;boolean|optional&quot;</span>
<span class="sd">            }</span>

<span class="sd">        For example::</span>

<span class="sd">            {</span>
<span class="sd">                &quot;metric&quot;: &quot;vista.nodes.skyline-1.cpu.user&quot;,</span>
<span class="sd">                &quot;timestamp&quot;: 1478021700,</span>
<span class="sd">                &quot;value&quot;: 1.0,</span>
<span class="sd">                &quot;key&quot;: &quot;YOURown32charSkylineAPIkeySecret&quot;</span>
<span class="sd">            }</span>

<span class="sd">            {</span>
<span class="sd">                &quot;metric&quot;: &quot;vista.nodes.skyline-1.cpu.user&quot;,</span>
<span class="sd">                &quot;timestamp&quot;: 1478021700,</span>
<span class="sd">                &quot;value&quot;: 1.0,</span>
<span class="sd">                &quot;key&quot;: &quot;YOURown32charSkylineAPIkeySecret&quot;,</span>
<span class="sd">                &quot;fill&quot;: &quot;true&quot;</span>
<span class="sd">            }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">postData</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">post_req_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

            <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
            <span class="n">start_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

            <span class="c1"># @added 20210512 - Feature #4060: skyline.flux.worker.discarded metrics</span>
            <span class="c1"># Preserve the request for debugging</span>
            <span class="n">postData_obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">postData_obj</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: req.stream.read() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># @added 20220208 - Feature #4284: flux - telegraf</span>
            <span class="c1"># Allow for gzip data</span>
            <span class="c1"># DEBUG</span>
            <span class="c1"># all_headers = None</span>
            <span class="c1"># try:</span>
            <span class="c1">#     all_headers = str(req.headers)</span>
            <span class="c1"># except Exception as err:</span>
            <span class="c1">#     logger.error(&#39;listen :: req.headers() error - %s&#39; % str(err))</span>
            <span class="c1"># logger.info(&#39;debug :: listen :: headers - %s&#39; % str(all_headers))</span>
            <span class="n">content_encoding</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">content_encoding</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;content-encoding&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: get_header(</span><span class="se">\&#39;</span><span class="s1">content-encoding</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="c1"># if content_encoding:</span>
            <span class="c1">#     logger.info(&#39;debug :: listen :: content_encoding: %s&#39; % str(content_encoding))</span>
            <span class="c1"># else:</span>
            <span class="c1">#     logger.info(&#39;debug :: listen :: no content_encoding: %s&#39; % str(content_encoding))</span>
            <span class="k">if</span> <span class="n">content_encoding</span> <span class="o">==</span> <span class="s1">&#39;gzip&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: content_encoding: </span><span class="si">%s</span><span class="s1">, decompressing&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">content_encoding</span><span class="p">))</span>
                    <span class="n">start_gzip_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">postData_obj</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">postData_obj</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: gzip.decompress(postData_obj) failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                    <span class="n">end_gzip_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: gzip decompression took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_gzip_timer</span> <span class="o">-</span> <span class="n">start_gzip_timer</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @added 20210512 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                <span class="c1"># postData = json.loads(req.stream.read())</span>
                <span class="n">postData</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">postData_obj</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid json data&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: invalid post data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: request arguments and POST data - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">)))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">postData</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: no POST data recieved&#39;</span><span class="p">)</span>

                <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_parameters no POST data&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_parameters no POST data- </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_post_data&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData_obj</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to data to Redis set flux.listen.discarded.invalid_post_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no POST data received&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="c1"># Add metric to add to queue</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">valid_value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># @added 20200206 - Feature #3444: Allow flux to backfill</span>
            <span class="n">backfill</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20210718</span>
            <span class="n">aggregate</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20220208 - Feature #4284: flux - telegraf</span>
            <span class="n">telegraf</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">telegraf_metric_prefix</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20220222 - Feature #4284: flux - telegraf</span>
            <span class="c1"># Drop telegraf metrics with a string/boolean value</span>
            <span class="n">dropped_telegraf_non_numeric_value_metrics</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dropped_telegraf_non_numeric_value_base_names</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">metrics_added_to_aggregation</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># @added 20211018 - Feature #4284: flux - telegraf</span>
            <span class="c1"># Allow the key to be passed as a HTTP header rather than in the json</span>
            <span class="c1"># payload</span>
            <span class="n">header_apikey</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header_apikey</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: get_header(</span><span class="se">\&#39;</span><span class="s1">key</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">header_apikey</span><span class="p">:</span>
                <span class="c1"># FOR DEBUG</span>
                <span class="c1"># logger.info(&#39;debug :: listen :: get_header(\&#39;key\&#39;) - %s&#39; % str(header_apikey))</span>
                <span class="c1"># @added 20220208 - Feature #4284: flux - telegraf</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">telegraf</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;telegraf&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: get_header(</span><span class="se">\&#39;</span><span class="s1">telegraf</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">telegraf</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: telegraf header - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">telegraf</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: get_header(</span><span class="se">\&#39;</span><span class="s1">telegraf</span><span class="se">\&#39;</span><span class="s1">) - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">telegraf</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">telegraf_metric_prefix</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: get_header(</span><span class="se">\&#39;</span><span class="s1">prefix</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20200115 - Feature #3394: flux health check</span>
            <span class="c1"># Added status parameter so that the flux listen process can be monitored</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>

                <span class="n">status_code</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">status_code</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: status status_code test, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">status_code</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">status_code</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">status_code</span><span class="p">:</span>
                    <span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;Status code test - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">207</span><span class="p">:</span>
                        <span class="n">rejected_metrics_over_quota</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;server-1.unknown.metric&#39;</span><span class="p">,</span> <span class="s1">&#39;server-1.some-other-unknown.metric&#39;</span><span class="p">]</span>
                        <span class="n">processed_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;server-1.known.metric&#39;</span><span class="p">,</span> <span class="s1">&#39;server-1.some-other-known.metric&#39;</span><span class="p">]</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">rejected_metrics_over_quota</span><span class="p">:</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">})</span>
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">processed_metrics</span><span class="p">:</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">204</span><span class="p">})</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;TEST - over quota - this account is allowed x metrics and an additional y new metrics were posted that have been rejected&#39;</span>
                        <span class="n">notice_msg</span> <span class="o">=</span> <span class="s1">&#39;TEST - 2 metrics were processed and 2 metrics were rejected&#39;</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
                            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">notice_msg</span><span class="p">,</span>
                            <span class="s1">&#39;rejected metrics&#39;</span><span class="p">:</span> <span class="n">rejected_metrics_over_quota</span><span class="p">,</span>
                            <span class="s1">&#39;rejected metrics count&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="s1">&#39;processed metrics&#39;</span><span class="p">:</span> <span class="n">processed_metrics</span><span class="p">,</span>
                            <span class="s1">&#39;processed metrics count&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="s1">&#39;submitted metrics count&#39;</span><span class="p">:</span> <span class="mi">4</span>
                        <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
                            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: status - status_code test: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)))</span>
                    <span class="c1"># logger.debug(&#39;debug :: listen :: %s&#39; % str(body))</span>
                    <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">207</span><span class="p">:</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_207</span>
                    <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                    <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_401</span>
                    <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_204</span>
                    <span class="k">return</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: POST status - ok&#39;</span><span class="p">)</span>

                    <span class="c1"># @added 20220329 - Feature #4018: thunder - skyline.errors</span>
                    <span class="c1"># Report app up</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;flux.listen&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: setex on flux.listen failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not validate the status key POST request argument - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                    <span class="k">return</span>

            <span class="c1"># @added 20200818 - Feature #3694: flux - POST multiple metrics</span>
            <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20211018 - Feature #4284: flux - telegraf</span>
            <span class="c1"># Allow the key to be passed as a HTTP header rather than in the json</span>
            <span class="c1"># payload</span>
            <span class="k">if</span> <span class="n">header_apikey</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">header_apikey</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no key passed&#39;</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                    <span class="k">return</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="c1"># @modified 20220222 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># Never log POST data as it can be massive</span>
                    <span class="c1"># logger.error(&#39;error :: listen :: could not determine the key from POST data - %s - %s&#39; % (</span>
                    <span class="c1">#     str(postData), err))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not determine the key from POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20211018 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Allow the key to be passed as a HTTP header or in the json payload</span>
                <span class="c1"># key = str(postData[&#39;key&#39;])</span>

                <span class="c1"># @modified 20200818 - Feature #3694: flux - POST multiple metrics</span>
                <span class="c1"># Added metric_namespace_prefix</span>
                <span class="n">keyValid</span><span class="p">,</span> <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="n">validate_key</span><span class="p">(</span><span class="s1">&#39;listen :: MetricDataPOST POST&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">keyValid</span><span class="p">:</span>
                    <span class="c1"># @modified 20220222 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># Never log POST data as it can be massive</span>
                    <span class="c1"># logger.error(&#39;error :: listen :: invalid key in POST data - %s - %s&#39; % (</span>
                    <span class="c1">#     key, str(postData)))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: invalid key in POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">key</span><span class="p">))</span>

                    <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_key&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                    <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid key&#39;</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: </span><span class="si">%s</span><span class="s1">, returning 401&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                    <span class="c1"># @modified 20210909</span>
                    <span class="c1"># Return 401 if bad key</span>
                    <span class="c1"># resp.status = falcon.HTTP_400</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_401</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: valid key, metric_namespace_prefix set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="c1"># @modified 20220222 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Never log POST data as it can be massive</span>
                <span class="c1"># logger.error(&#39;error :: listen :: could not validate the key from POST data - %s - %s&#39; % (</span>
                <span class="c1">#     str(postData), err))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not validate the key from POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_key&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid key&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: </span><span class="si">%s</span><span class="s1">, returning 401&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                <span class="c1"># @modified 20210909</span>
                <span class="c1"># Return 401 if bad key</span>
                <span class="c1"># resp.status = falcon.HTTP_400</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_401</span>
                <span class="k">return</span>

            <span class="c1"># @added 20211103 - Feature #4316: flux - validate_key</span>
            <span class="n">validated_key</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">validated_key</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;validate_key&#39;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: validate_key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">validated_key</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">validated_key</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to determine validated_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">validated_key</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;key valid&quot;</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: validate_key returning 200&#39;</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to response to validate_key request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20230223 - Feature #4840: flux - prometheus - x-test-only header</span>
            <span class="n">test_only</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">test_only_metrics_submitted</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_only_str</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;x-test-only&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">test_only_str</span><span class="p">:</span>
                    <span class="n">test_only</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: get_header(</span><span class="se">\&#39;</span><span class="s1">x-test-only</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">test_only</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_only</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: test: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_only</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">test_only</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to determine test - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20200818 - Feature #3694: flux - POST multiple metrics</span>
            <span class="c1"># Determine if the POST data is for a single metric or multiple metrics</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: metrics is set in the POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: metrics item - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: metrics item - metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># @modified 20220222 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Never log POST data as it can be massive</span>
                <span class="c1"># logger.error(&#39;error :: listen :: metrics was passed in the request POST data but an error was encountered - returned 400 - %s - %s&#39; % (</span>
                <span class="c1">#     str(postData), err))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: metrics was passed in the request POST data but an error was encountered - returned 400 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>

                <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_parameters&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid metrics element&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="c1"># @added 20220208 - Feature #4284: flux - telegraf</span>
            <span class="c1"># Convert a single metric post to a multiple metric post.  This</span>
            <span class="c1"># replaces and deprecates the handling of a single metric POST format in</span>
            <span class="c1"># duplicated code.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="p">}</span>
                    <span class="c1"># @added 20230208 - Feature #3444: Allow flux to backfill</span>
                    <span class="c1"># Add the fill key if it is passed on a single metric</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;fill&#39;</span> <span class="ow">in</span> <span class="n">metric_data</span><span class="p">:</span>
                            <span class="n">fill</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">fill</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">]:</span>
                                <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to get metric data from POST to create metric_data and add to metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="c1"># @added 20230531 - SAVE_DEBUG_INFO</span>
                    <span class="k">if</span> <span class="n">SAVE_DEBUG_INFO</span><span class="p">:</span>
                        <span class="n">debug_time_now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                        <span class="n">current_aligned_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">debug_time_now</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;flux.debug.bad.posts.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">debug_time_now</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">))</span>
                            <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">hash_key</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: postData from failed POST saved to Redis hash </span><span class="si">%s</span><span class="s1">, postData: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">hash_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: postData from failed POST saved to Redis hash </span><span class="si">%s</span><span class="s1">, postData: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">hash_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20211018 - Feature #4284: flux - telegraf</span>
            <span class="c1"># Allow the key to be passed as a HTTP header rather than in the json</span>
            <span class="c1"># payload</span>
            <span class="n">telegraf_payload</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">telegraf_keys_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">metrics</span> <span class="ow">and</span> <span class="n">telegraf</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="n">telegraf_keys_list</span><span class="p">:</span>
                                <span class="n">telegraf_payload</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">telegraf_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">telegraf_metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">telegraf_payload</span><span class="p">:</span>

                <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Added TIMINGS</span>
                <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                    <span class="n">start_telegraf_conversion_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">metric_dict</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                    <span class="c1"># {&#39;fields&#39;: {&#39;accepts&#39;: 17819,</span>
                    <span class="c1">#    &#39;active&#39;: 4,</span>
                    <span class="c1">#    &#39;handled&#39;: 17819,</span>
                    <span class="c1">#    &#39;reading&#39;: 0,</span>
                    <span class="c1">#    &#39;requests&#39;: 218369,</span>
                    <span class="c1">#    &#39;waiting&#39;: 3,</span>
                    <span class="c1">#    &#39;writing&#39;: 1},</span>
                    <span class="c1">#   &#39;name&#39;: &#39;nginx&#39;,</span>
                    <span class="c1">#   &#39;tags&#39;: {&#39;a_0_tag&#39;: &#39;nginx&#39;,</span>
                    <span class="c1">#    &#39;host&#39;: &#39;nginx-server-1&#39;,</span>
                    <span class="c1">#    &#39;port&#39;: &#39;81&#39;,</span>
                    <span class="c1">#    &#39;server&#39;: &#39;127.0.0.1&#39;},</span>
                    <span class="c1">#   &#39;timestamp&#39;: 1644320940}</span>
                    <span class="c1"># Using the same as the telegraf Graphite template pattern</span>
                    <span class="c1"># template = &quot;host.tags.measurement.field&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">telegraf_metric_prefix</span><span class="p">:</span>
                            <span class="n">metric_parent_namespace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">telegraf_metric_prefix</span><span class="p">),</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">][</span><span class="s1">&#39;host&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">metric_parent_namespace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">][</span><span class="s1">&#39;host&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;host&#39;</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                            <span class="n">metric_parent_namespace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_parent_namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                        <span class="n">metric_parent_namespace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_parent_namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">key_str</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                            <span class="n">key_str</span> <span class="o">=</span> <span class="n">key_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_parent_namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_str</span><span class="p">))</span>
                            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>

                            <span class="c1"># @added 20220303 - Feature #4284: flux - telegraf</span>
                            <span class="c1"># Drop telegraf metrics with a string or boolean value</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">add_dropped_metric</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                                    <span class="n">add_dropped_metric</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                                    <span class="n">add_dropped_metric</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="n">add_dropped_metric</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">metric_namespace_prefix</span><span class="p">:</span>
                                        <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                    <span class="n">dropped_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
                                    <span class="n">dropped_telegraf_non_numeric_value_metrics</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dropped_dict</span><span class="p">)</span>
                                    <span class="n">dropped_telegraf_non_numeric_value_base_names</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dropped_dict</span><span class="p">)</span>
                                    <span class="k">continue</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to determine if telegraf non-numeric metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                                <span class="k">continue</span>

                            <span class="n">telegraf_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="n">telegraf_metrics_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">})</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to determine metric from telegraf data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;test.flux.telegraf.metrics_data&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: set test.flux.telegraf.metrics_data failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                    <span class="n">end_telegraf_conversion_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: telegraf conversion took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_telegraf_conversion_timer</span> <span class="o">-</span> <span class="n">start_telegraf_conversion_timer</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">telegraf_metrics_list</span> <span class="ow">and</span> <span class="n">telegraf_payload</span><span class="p">:</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">telegraf_metrics_list</span><span class="p">)</span>

            <span class="c1"># @added 20220208 - Feature #4284: flux - telegraf</span>
            <span class="c1"># After convert a single metric post to a multiple metric post, if there</span>
            <span class="c1"># are no metrics in the POST data return a 400</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no metric data passed&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="c1"># @added 20220202 - Feature #4412: flux - quota - thunder alert</span>
            <span class="n">test_metric_quota_exceeded_alert</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20220208 - Feature #4432: functions.metrics.skip_metric</span>
            <span class="c1">#                   Feature #4400: flux - quota</span>
            <span class="n">not_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">original_redis_not_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">original_redis_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">skipped_metrics_query_redis</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">original_base_names_in_post</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">metrics_in_post</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">skipped_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">not_skipped_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">received_namespaces</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">metric_data</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">])</span>
                        <span class="n">original_base_names_in_post</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metric_namespace_prefix</span><span class="p">:</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                        <span class="n">metrics_in_post</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">received_namespaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not determine metrics in post - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">received_namespaces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">received_namespaces</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">ALL_SKIP_LIST</span><span class="p">:</span>
                <span class="n">namespace_not_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">skipped_metrics_query_redis</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">skipped_metrics_query_redis</span><span class="p">:</span>
                    <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># Added TIMINGS</span>
                    <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                        <span class="n">start_not_skipped_metrics_dict_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">received_namespace</span> <span class="ow">in</span> <span class="n">received_namespaces</span><span class="p">:</span>
                        <span class="n">flux_not_skipped_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;flux.not_skipped_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">received_namespace</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">namespace_not_skipped_metrics_dict</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">flux_not_skipped_metrics_key</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">get_memcache_key</span><span class="p">:</span>
                                <span class="c1"># logger.error(traceback.format_exc())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not hgetall </span><span class="si">%s</span><span class="s1"> from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">flux_not_skipped_metrics_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
                            <span class="c1"># Add flux required data to memcache as well</span>
                            <span class="k">if</span> <span class="n">get_memcache_key</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">namespace_not_skipped_metrics_dict</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="n">flux_not_skipped_metrics_key</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace_not_skipped_metrics_dict</span><span class="p">:</span>
                                        <span class="n">namespace_not_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could get memcache set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">flux_not_skipped_metrics_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                    <span class="n">namespace_not_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">namespace_not_skipped_metrics_dict</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespace_not_skipped_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="n">not_skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespace_not_skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                                <span class="n">original_redis_not_skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespace_not_skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                                <span class="n">not_skipped_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                        <span class="n">end_not_skipped_metrics_dict_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: not_skipped_metrics_dict from Redis took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_not_skipped_metrics_dict_timer</span> <span class="o">-</span> <span class="n">start_not_skipped_metrics_dict_timer</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">skipped_metrics_query_redis</span><span class="p">:</span>
                    <span class="n">flux_not_skipped_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;flux.not_skipped_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">received_namespaces</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="n">metrics_in_post</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">not_skipped_metric</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">not_skipped_metric</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">flux_not_skipped_metrics_key</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">get_memcache_key</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not check </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">metric</span><span class="p">,</span> <span class="n">flux_not_skipped_metrics_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
                        <span class="c1"># Add flux required data to memcache as well</span>
                        <span class="k">if</span> <span class="n">get_memcache_key</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">namespace_not_skipped_metrics_dict</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="n">flux_not_skipped_metrics_key</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace_not_skipped_metrics_dict</span><span class="p">:</span>
                                    <span class="n">namespace_not_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could get memcache set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">flux_not_skipped_metrics_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                <span class="n">namespace_not_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">if</span> <span class="n">namespace_not_skipped_metrics_dict</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">not_skipped_metric</span> <span class="o">=</span> <span class="n">namespace_not_skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="n">not_skipped_metric</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">not_skipped_metric</span><span class="p">:</span>
                        <span class="n">not_skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_skipped_metric</span>
                        <span class="n">original_redis_not_skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_skipped_metric</span>
                        <span class="n">not_skipped_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

            <span class="c1"># @added 20220126 - Feature #4400: flux - quota</span>
            <span class="n">namespace_quota</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">current_namespace_metric_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">namespace_metrics_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">over_quota</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">rejected_metrics_over_quota</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">processed_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">newly_added_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">check_namespace_quota</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
            <span class="c1"># Add flux required data to memcache as well</span>
            <span class="n">quota_metrics_from_memcache</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metric_namespace_prefix</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: data for metric_namespace_prefix: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">))</span>
                    <span class="n">check_namespace_quota</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">received_namespaces</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">check_namespace_quota</span> <span class="o">=</span> <span class="n">received_namespaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">check_namespace_quota</span> <span class="ow">in</span> <span class="n">namespaces_with_quotas</span><span class="p">:</span>
                    <span class="n">namespace_quota</span> <span class="o">=</span> <span class="n">get_namespace_quota</span><span class="p">(</span><span class="n">check_namespace_quota</span><span class="p">)</span>

                <span class="c1"># @added 20230223 - Feature #4840: flux - prometheus - x-test-only header</span>
                <span class="c1"># Do not check namespace_quota for test metrics</span>
                <span class="k">if</span> <span class="n">test_only</span><span class="p">:</span>
                    <span class="n">namespace_quota</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">namespace_quota</span><span class="p">:</span>
                    <span class="n">namespace_quota_key_reference_timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                    <span class="n">namespace_quota_redis_key</span> <span class="o">=</span> <span class="s1">&#39;flux.namespace_quota.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">check_namespace_quota</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_quota_key_reference_timestamp</span><span class="p">))</span>
                    <span class="n">current_namespace_metric_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">current_namespace_metric_count</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">scard</span><span class="p">(</span><span class="n">namespace_quota_redis_key</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">current_namespace_metric_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">quota_namespace_metrics_redis_key</span> <span class="o">=</span> <span class="s1">&#39;flux.quota.namespace_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_namespace_quota</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">quota_namespace_metrics_redis_key</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
                        <span class="c1"># Add flux required data to memcache as well</span>
                        <span class="k">if</span> <span class="n">get_memcache_key</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="n">quota_namespace_metrics_redis_key</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace_metrics</span><span class="p">:</span>
                                    <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">quota_metrics_from_memcache</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could get memcache set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">quota_namespace_metrics_redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">namespace_metrics_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">namespace_metrics</span><span class="p">)</span>

                    <span class="c1"># @added 20220202 - Feature #4412: flux - quota - thunder alert</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test_metric_quota_exceeded_alert</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;metric_quota_exceeded_test&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">test_metric_quota_exceeded_alert</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: metric_quota_exceeded_test is set in the POST data&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">test_metric_quota_exceeded_alert</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: checking metric_quota_exceeded_test in the POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                        <span class="n">test_metric_quota_exceeded_alert</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error determining namespace_quota, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="c1"># added 20201211 - Feature #3694: flux - POST multiple metrics</span>
                <span class="c1"># Added metric count</span>
                <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: POST mulitple metric data received with </span><span class="si">%s</span><span class="s1"> entries&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not report number of entries submitted in POST mulitple metric data&#39;</span><span class="p">)</span>

                <span class="c1"># @added 20220209 - Feature #4432: functions.metrics.skip_metric</span>
                <span class="n">metrics_found_in_redis</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">namespace_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">ALL_SKIP_LIST</span><span class="p">:</span>

                    <span class="n">not_found_in_not_skipped</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># Added TIMINGS</span>
                    <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                        <span class="n">start_skip_metrics_redis_resources_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_in_post</span><span class="p">)):</span>
                        <span class="n">not_skipped_metric</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">not_skipped_metrics_dict</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">not_skipped_metric</span> <span class="o">=</span> <span class="n">not_skipped_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">not_skipped_metric</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">not_skipped_metric</span><span class="p">:</span>
                            <span class="n">metrics_found_in_redis</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;do_not_skip&#39;</span>
                            <span class="n">not_skipped_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">not_found_in_not_skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: metrics_found_in_redis count after not_skipped_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_found_in_redis</span><span class="p">)))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: not_found_in_not_skipped count after not_skipped_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_found_in_not_skipped</span><span class="p">)))</span>

                    <span class="k">if</span> <span class="n">not_found_in_not_skipped</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">skipped_metrics_query_redis</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                                <span class="n">start_skipped_metrics_dict_redis_resources_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">received_namespace</span> <span class="ow">in</span> <span class="n">received_namespaces</span><span class="p">:</span>
                                <span class="n">flux_skipped_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;flux.skipped_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">received_namespace</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">namespace_skipped_metrics_dict</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">flux_skipped_metrics_key</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">get_memcache_key</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not hgetall flux.skipped_metrics from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                                    <span class="n">namespace_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
                                    <span class="c1"># Add flux required data to memcache as well</span>
                                    <span class="k">if</span> <span class="n">get_memcache_key</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">namespace_skipped_metrics_dict</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="n">flux_skipped_metrics_key</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace_skipped_metrics_dict</span><span class="p">:</span>
                                                <span class="n">namespace_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could get memcache set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="n">flux_skipped_metrics_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                            <span class="n">namespace_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="k">if</span> <span class="n">namespace_skipped_metrics_dict</span><span class="p">:</span>
                                    <span class="c1"># This is used to only update the flux.skipped_metrics</span>
                                    <span class="c1"># periodically and not every time, otherwise</span>
                                    <span class="c1"># updating all the skipped metrics key every</span>
                                    <span class="c1"># submission would incur unnecessary Redis</span>
                                    <span class="c1"># overhead</span>
                                    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
                                    <span class="c1"># original_redis_skipped_metrics_dict[received_namespace] = namespace_skipped_metrics_dict.copy()</span>
                                    <span class="n">original_redis_skipped_metrics_dict</span><span class="p">[</span><span class="n">received_namespace</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">namespace_skipped_metrics_dict</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">skipped_metrics_dict</span><span class="p">:</span>
                                        <span class="n">skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namespace_skipped_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                        <span class="n">skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespace_skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>

                            <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                                <span class="n">end_skipped_metrics_dict_redis_resources_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">skipped_metrics_dict</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: skipped_metrics_dict with </span><span class="si">%s</span><span class="s1"> metrics from Redis took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped_metrics_dict</span><span class="p">)),</span> <span class="p">(</span><span class="n">end_skipped_metrics_dict_redis_resources_timer</span> <span class="o">-</span> <span class="n">start_skipped_metrics_dict_redis_resources_timer</span><span class="p">)))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: no skipped_metrics_dict from Redis took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="p">(</span><span class="n">end_skipped_metrics_dict_redis_resources_timer</span> <span class="o">-</span> <span class="n">start_skipped_metrics_dict_redis_resources_timer</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">received_namespace</span> <span class="o">=</span> <span class="n">received_namespaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">base_name</span> <span class="o">=</span> <span class="n">metrics_in_post</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">flux_skipped_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;flux.not_skipped_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">received_namespace</span><span class="p">)</span>
                            <span class="n">namespace_skipped_metric</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">namespace_skipped_metric</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">flux_skipped_metrics_key</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">get_memcache_key</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not hget flux.skipped_metrics from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                                <span class="n">namespace_skipped_metric</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="c1"># @added 20220426 - Feature #4536: Handle Redis failure</span>
                                <span class="c1"># Add flux required data to memcache as well</span>
                                <span class="k">if</span> <span class="n">get_memcache_key</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">namespace_skipped_metrics_dict</span> <span class="o">=</span> <span class="n">get_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="n">flux_skipped_metrics_key</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace_skipped_metrics_dict</span><span class="p">:</span>
                                            <span class="n">namespace_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could get memcache set </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">flux_skipped_metrics_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                                        <span class="n">namespace_skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="k">if</span> <span class="n">namespace_skipped_metrics_dict</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">namespace_skipped_metric</span> <span class="o">=</span> <span class="n">namespace_skipped_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                            <span class="n">namespace_skipped_metric</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">namespace_skipped_metric</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">skipped_metrics_dict</span><span class="p">:</span>
                                    <span class="n">skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="n">skipped_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespace_skipped_metric</span>
                                <span class="k">if</span> <span class="n">skipped_metrics_dict</span><span class="p">:</span>
                                    <span class="c1"># This is used to only update the flux.skipped_metrics</span>
                                    <span class="c1"># periodically and not every time, otherwise</span>
                                    <span class="c1"># updating all the skipped metrics key every</span>
                                    <span class="c1"># submission would incur unnecessary Redis</span>
                                    <span class="c1"># overhead</span>
                                    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
                                    <span class="c1"># original_redis_skipped_metrics_dict[received_namespace] = skipped_metrics_dict.copy()</span>
                                    <span class="n">original_redis_skipped_metrics_dict</span><span class="p">[</span><span class="n">received_namespace</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">skipped_metrics_dict</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">skipped_metrics_dict</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">not_found_in_not_skipped</span><span class="p">:</span>
                                <span class="n">skipped</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">skipped</span> <span class="o">=</span> <span class="n">skipped_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="n">skipped</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">skipped</span><span class="p">:</span>
                                    <span class="n">metrics_found_in_redis</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;skip&#39;</span>
                                    <span class="n">skipped_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                        <span class="n">end_skip_metrics_redis_resources_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: skip_metrics_redis_resources took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_skip_metrics_redis_resources_timer</span> <span class="o">-</span> <span class="n">start_skip_metrics_redis_resources_timer</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: metrics_found_in_redis count after skipped_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_found_in_redis</span><span class="p">)))</span>

                <span class="c1"># @added 20220208 - Feature #4432: functions.metrics.skip_metric</span>
                <span class="c1"># Performance of functions.metrics.skip_metric on a POST with</span>
                <span class="c1"># 932 metrics and substantial SKIP_LIST and DO_NOT_SKIP_LIST</span>
                <span class="c1"># took 0.322734 seconds</span>
                <span class="c1"># metrics:  932 , skipped:  681 , not_skipped:  251 , SKIP_LIST:  83 , DO_NOT_SKIP_LIST: 32</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">skipped_metrics_dict</span><span class="p">:</span>
                    <span class="n">skipped_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="n">ALL_SKIP_LIST</span><span class="p">:</span>

                    <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># Added TIMINGS</span>
                    <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                        <span class="n">start_skip_metrics_lists_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

                    <span class="c1"># Minimise the SKIP_LIST and DO_NOT_SKIP_LIST lengths to reduce</span>
                    <span class="c1"># runtime, only use the appropriate skip lists</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">SKIP_LIST</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKIP_LIST</span><span class="p">)</span>
                        <span class="n">DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DO_NOT_SKIP_LIST</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">check_namespace_quota</span> <span class="ow">in</span> <span class="n">external_settings_namespaces</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">conf_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">skyline_external_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">conf_id</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">check_namespace_quota</span><span class="p">:</span>
                                        <span class="n">SKIP_LIST</span> <span class="o">=</span> <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">conf_id</span><span class="p">][</span><span class="s1">&#39;skip_metrics&#39;</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">conf_id</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">check_namespace_quota</span><span class="p">:</span>
                                        <span class="n">DO_NOT_SKIP_LIST</span> <span class="o">=</span> <span class="n">skyline_external_settings</span><span class="p">[</span><span class="n">conf_id</span><span class="p">][</span><span class="s1">&#39;do_not_skip_metrics&#39;</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">continue</span>
                        <span class="n">skip_exceptions</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">SKIP_LIST</span><span class="p">:</span>
                            <span class="n">metrics_found_in_redis_count</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">metrics_not_found_in_redis_count</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                                <span class="n">metrics_in_post_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_in_post</span><span class="p">)))</span>
                            <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_in_post</span><span class="p">)):</span>
                                <span class="n">found_in_redis</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">found_in_redis</span> <span class="o">=</span> <span class="n">metrics_found_in_redis</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="n">found_in_redis</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">found_in_redis</span><span class="p">:</span>
                                    <span class="n">metrics_found_in_redis_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>
                                <span class="c1"># Now do the performance heavy check</span>
                                <span class="n">metrics_not_found_in_redis_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">skip</span> <span class="o">=</span> <span class="n">skip_metric</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">SKIP_LIST</span><span class="p">,</span> <span class="n">DO_NOT_SKIP_LIST</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
                                    <span class="n">skipped_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">skipped_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">post_req_start</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">skip_exceptions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;skipped_metrics_dict&#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()]</span>
                                    <span class="c1"># If it is Explicitly skipped remove it from the</span>
                                    <span class="c1"># flux.not_skipped_metrics if it exists</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">received_namespace</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="n">flux_not_skipped_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;flux.not_skipped_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">received_namespace</span><span class="p">)</span>
                                        <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="n">flux_not_skipped_metrics_key</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">skip_exceptions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;skipped_metrics_dict&#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">not_skipped_metrics_dict</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">post_req_start</span>
                                    <span class="n">not_skipped_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">not_skipped_metrics</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">metrics_in_post</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">not_skipped_metrics</span><span class="p">))</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">skip_exceptions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metrics_in_post&#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()]</span>
                        <span class="k">if</span> <span class="n">skip_exceptions</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: if ALL_SKIP_LIST skip_exceptions: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">skip_exceptions</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not determine metrics to skip - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                        <span class="n">end_skip_metrics_lists_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: skip_metrics_lists took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_skip_metrics_lists_timer</span> <span class="o">-</span> <span class="n">start_skip_metrics_lists_timer</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: skip_metrics_lists total unique metrics in post: </span><span class="si">%s</span><span class="s1">, found_in_redis: </span><span class="si">%s</span><span class="s1">, skip_checked: </span><span class="si">%s</span><span class="s1">, not_skipped_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metrics_in_post_count</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metrics_found_in_redis_count</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metrics_not_found_in_redis_count</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_skipped_metrics</span><span class="p">))))</span>

                <span class="c1"># @added 20220126 - Feature #4400: flux - quota</span>
                <span class="k">if</span> <span class="n">namespace_quota</span><span class="p">:</span>

                    <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># Added TIMINGS</span>
                    <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                        <span class="n">start_namespace_quota_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">known_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">new_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">skipped_metrics_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skipped_metrics_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">skipped_metrics_dict_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">skipped_metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="k">for</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_in_post</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">namespace_metrics</span><span class="p">:</span>
                                <span class="n">known_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">skipped_metrics_dict_list</span><span class="p">:</span>
                                <span class="n">known_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">new_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>

                        <span class="c1"># @added 20220202 - Feature #4412: flux - quota - thunder alert</span>
                        <span class="k">if</span> <span class="n">test_metric_quota_exceeded_alert</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: TEST - test_metric_quota_exceeded_alert set, not accepting data testing&#39;</span><span class="p">)</span>
                            <span class="n">namespace_quota</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">known_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">new_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics_in_post</span><span class="p">)</span>
                            <span class="n">namespace_metrics</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="n">new_metric_count</span> <span class="o">=</span> <span class="n">namespace_metrics_count</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_metrics</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">new_metric_count</span> <span class="o">&gt;</span> <span class="n">namespace_quota</span><span class="p">:</span>
                            <span class="n">over_quota</span> <span class="o">=</span> <span class="n">new_metric_count</span> <span class="o">-</span> <span class="n">namespace_quota</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: will not accept some new metrics, over quota by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">over_quota</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error determining known and new metrics for namespace_quota, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                        <span class="n">end_namespace_quota_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: namespace_quota checks per metric took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_namespace_quota_timer</span> <span class="o">-</span> <span class="n">start_namespace_quota_timer</span><span class="p">))</span>

                <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Added TIMINGS</span>
                <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                    <span class="n">start_metrics_processing_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">metric_data</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>

                    <span class="c1"># Add metric to add to queue</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">valid_value</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">backfill</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">])</span>

                        <span class="c1"># @added 20201006 - Feature #3764: flux validate metric name</span>
                        <span class="c1"># @modified 20220211 - Feature #4380: flux - return reason with 400</span>
                        <span class="c1"># Added reason</span>
                        <span class="n">valid_metric_name</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">validate_metric_name</span><span class="p">(</span><span class="s1">&#39;listen :: MetricDataPOST POST multiple metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_metric_name</span><span class="p">:</span>

                            <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.metric_name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.metric_name&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.metric_name - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                            <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                            <span class="c1"># @modified 20220211 - Feature #4380: flux - return reason with 400</span>
                            <span class="c1"># Added reason</span>
                            <span class="c1"># @modified 20220222 - Feature #4380: flux - return reason with 400</span>
                            <span class="c1"># Add the metric allowing for more user debug</span>
                            <span class="c1"># message = &#39;invalid metric - %s - %s&#39; % (str(metric_data[&#39;metric&#39;]), str(reason))</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid metric - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span>
                            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                            <span class="k">return</span>

                        <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: metric from postData set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="c1"># @modified 20220222 - Feature #4284: flux - telegraf</span>
                        <span class="c1"># Never log POST data as it can be massive</span>
                        <span class="c1"># logger.error(&#39;error :: listen :: no valid metric in the request POST metrics data - returned 400 - %s&#39; % (</span>
                        <span class="c1">#     str(postData)))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: no valid metric in the request POST metrics data - returned 400 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>

                        <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;none.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.metric_name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.metric_name&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.metric_name - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                        <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                        <span class="c1"># @modified 20220222 - Feature #4380: flux - return reason with 400</span>
                        <span class="c1"># Add the metric allowing for more user debug</span>
                        <span class="c1"># message = &#39;invalid metric&#39;</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                        <span class="k">return</span>

                    <span class="n">original_base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

                    <span class="c1"># @added 20210430 - Bug #4046: flux - metric_namespace_prefix on FLUX_SELF_API_KEY conflicting with FLUX_API_KEYS</span>
                    <span class="c1"># If metrics are being submitted to flux internally (vista) using</span>
                    <span class="c1"># the FLUX_SELF_API_KEY for a namespace if that namespace is added</span>
                    <span class="c1"># to FLUX_API_KEYS, flux will begin to also append the namespace</span>
                    <span class="c1"># prefix from the FLUX_API_KEYS for metrics submitted with the</span>
                    <span class="c1"># FLUX_SELF_API_KEY</span>
                    <span class="k">if</span> <span class="n">metric_namespace_prefix</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">):</span>
                            <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># Added metric_namespace_prefix which is declared via the FLUX_API_KEYS</span>
                    <span class="k">if</span> <span class="n">metric_namespace_prefix</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">),</span> <span class="n">metric</span><span class="p">)</span>

                    <span class="c1"># @added 20220208 - Feature #4432: functions.metrics.skip_metric</span>
                    <span class="n">skip_base_name</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">skip_base_name</span> <span class="o">=</span> <span class="n">skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">skip_base_name</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">skip_base_name</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">post_req_start</span>
                            <span class="n">skipped_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error updating metric in skipped_metrics_dict - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="c1"># @added 20220126 - Feature #4400: flux - quota</span>
                    <span class="k">if</span> <span class="n">over_quota</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_namespace_metrics_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">namespace_metrics</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">new_namespace_metrics_count</span> <span class="o">&gt;=</span> <span class="n">namespace_quota</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namespace_metrics</span><span class="p">:</span>
                                    <span class="n">rejected_metrics_over_quota</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">original_base_name</span><span class="p">)</span>
                                    <span class="k">continue</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error adding to rejected_metrics_over_quota, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">namespace_quota</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namespace_metrics</span><span class="p">:</span>
                            <span class="n">newly_added_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fill</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">fill</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">]:</span>
                            <span class="n">backfill</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">backfill</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">timestamp_present</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">timestamp_present</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">timestamp_present</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">backfill</span><span class="p">:</span>
                                <span class="c1"># @modified 20220211 - Feature #4380: flux - return reason with 400</span>
                                <span class="c1"># Added reason</span>
                                <span class="n">valid_timestamp</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">validate_timestamp</span><span class="p">(</span><span class="s1">&#39;listen :: MetricDataPOST POST multiple metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_present</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">valid_timestamp</span><span class="p">:</span>
                                <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp_present</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                                <span class="n">unique_value</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_present</span><span class="p">))</span>
                                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_timestamp&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_timestamp&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                                <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                                <span class="c1"># @modified 20220222 - Feature #4380: flux - return reason with 400</span>
                                <span class="c1"># Add the metric allowing for more user debug</span>
                                <span class="c1"># message = &#39;invalid timestamp - %s - %s&#39; % (str(timestamp_present), str(reason))</span>
                                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid timestamp - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">timestamp_present</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">reason</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
                                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                                <span class="k">return</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: invalid timestamp value found in POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_present</span><span class="p">)))</span>

                            <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_present</span><span class="p">))</span>
                                <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_timestamp&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_timestamp&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                            <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                            <span class="c1"># @modified 20220222 - Feature #4380: flux - return reason with 400</span>
                            <span class="c1"># Add the metric allowing for more user debug</span>
                            <span class="c1"># message = &#39;invalid timestamp&#39;</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                            <span class="k">return</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value_present</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">value_present</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">value_present</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                            <span class="c1"># valid_value is used as in terms of Python if value evalatuion</span>
                            <span class="c1"># if value was 0.0 (or 0) they evaluate as False</span>
                            <span class="n">valid_value</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="c1"># @added 20220222 - Feature #4284: flux - telegraf</span>
                            <span class="c1"># Drop telegraf metrics with a string or boolean value</span>
                            <span class="k">if</span> <span class="n">telegraf</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">add_dropped_metric</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                                        <span class="n">add_dropped_metric</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
                                        <span class="n">add_dropped_metric</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">if</span> <span class="n">add_dropped_metric</span><span class="p">:</span>
                                        <span class="n">dropped_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">metric_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]}</span>
                                        <span class="n">dropped_telegraf_non_numeric_value_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dropped_dict</span><span class="p">)</span>
                                        <span class="n">dropped_telegraf_non_numeric_value_base_names</span><span class="p">[</span><span class="n">original_base_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dropped_dict</span><span class="p">)</span>
                                        <span class="k">continue</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to determine if telegraf non-numeric metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                                    <span class="k">continue</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: invalid value from POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="c1"># @modified 20220222 - Feature #4284: flux - telegraf</span>
                                <span class="c1"># Never log POST data as it can be massive</span>
                                <span class="c1"># str(postData)))</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)))</span>

                            <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                            <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_present</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_present</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_value&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_value&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                            <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                            <span class="c1"># @modified 20220222 - Feature #4380: flux - return reason with 400</span>
                            <span class="c1"># Add the metric allowing for more user debug</span>
                            <span class="c1"># message = &#39;invalid value - %s&#39; % str(metric_data[&#39;value&#39;])</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                            <span class="k">return</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: no metric in the POST data - </span><span class="si">%s</span><span class="s1"> - returning 400&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="c1"># @modified 20220222 - Feature #4284: flux - telegraf</span>
                            <span class="c1"># Never log POST data as it can be massive</span>
                            <span class="c1"># str(postData)))</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)))</span>

                        <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;none.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.metric_name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.metric_name&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.metric_name - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                        <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                        <span class="c1"># @modified 20220222 - Feature #4380: flux - return reason with 400</span>
                        <span class="c1"># Add the metric allowing for more user debug</span>
                        <span class="c1"># message = &#39;invalid metric&#39;</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_value</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: no valid value in the POST data - </span><span class="si">%s</span><span class="s1"> - returning 400&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="c1"># @modified 20220222 - Feature #4284: flux - telegraf</span>
                            <span class="c1"># Never log POST data as it can be massive</span>
                            <span class="c1"># str(postData)))</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)))</span>

                        <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                        <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_present</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_present</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_value&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_value&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add entry to Redis set flux.listen.discarded.invalid_value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                        <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">value_present</span><span class="p">:</span>
                            <span class="c1"># @modified 20220222 - Feature #4380: flux - return reason with 400</span>
                            <span class="c1"># Add the metric allowing for more user debug</span>
                            <span class="c1"># message = &#39;no value parameter present&#39;</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no value parameter present - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># message = &#39;invalid value&#39;</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid value - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">)</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span><span class="p">:</span>
                        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

                    <span class="c1"># @added 20230223 - Feature #4840: flux - prometheus - x-test-only header</span>
                    <span class="k">if</span> <span class="n">test_only</span><span class="p">:</span>
                        <span class="n">test_only_metrics_submitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">original_base_name</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Queue the metric</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metric_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">backfill</span><span class="p">]</span>

                        <span class="c1"># @added 20201018 - Feature #3798: FLUX_PERSIST_QUEUE</span>
                        <span class="c1"># Add to data to the flux.queue Redis set</span>
                        <span class="k">if</span> <span class="n">FLUX_PERSIST_QUEUE</span> <span class="ow">and</span> <span class="n">metric_data</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.queue&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed adding data to Redis set flux.queue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                        <span class="c1"># @added 20220126 - Feature #4400: flux - quota</span>
                        <span class="k">if</span> <span class="n">namespace_quota</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namespace_metrics</span><span class="p">:</span>
                                    <span class="n">namespace_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">quota_namespace_metrics_redis_key</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">metric</span><span class="p">,</span> <span class="n">quota_namespace_metrics_redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error adding metric to quota_namespace_metrics_redis_key, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">namespace_quota_redis_key</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                                <span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">namespace_quota_redis_key</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add </span><span class="si">%s</span><span class="s1"> to Redis set </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">metric</span><span class="p">,</span> <span class="n">namespace_quota_redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                        <span class="c1"># @added 20210406 - Feature #4004: flux - aggregator.py and FLUX_AGGREGATE_NAMESPACES</span>
                        <span class="k">if</span> <span class="n">aggregate_metrics</span> <span class="ow">or</span> <span class="n">aggregate_namespaces_list</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">added_to_aggregation_queue</span><span class="p">,</span> <span class="n">return_status_code</span> <span class="o">=</span> <span class="n">add_to_aggregate_metric_queue</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">aggregate_metrics</span><span class="p">,</span> <span class="n">aggregate_namespaces_list</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">added_to_aggregation_queue</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">return_status_code</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>
                                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                                        <span class="k">return</span>
                                    <span class="k">if</span> <span class="n">return_status_code</span> <span class="o">==</span> <span class="mi">204</span><span class="p">:</span>
                                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_204</span>
                                        <span class="n">processed_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">original_base_name</span><span class="p">)</span>
                                        <span class="n">metrics_added_to_aggregation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">original_base_name</span><span class="p">)</span>
                                    <span class="k">continue</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error add_to_aggregate_metric_queue failed, returning 500 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                                <span class="k">return</span>

                        <span class="n">flux</span><span class="o">.</span><span class="n">httpMetricDataQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">metric_data</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                        <span class="n">processed_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">original_base_name</span><span class="p">)</span>

                        <span class="c1"># modified 20201016 - Feature #3788: snab_flux_load_test</span>
                        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: POST mulitple metric data added to flux.httpMetricDataQueue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">))</span>

                        <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_conn</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s1">&#39;flux.listen.added_to_queue&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="c1"># logger.error(&#39;error :: listen :: failed to increment to Redis key flux.listen.added_to_queue - %s&#39; % e)</span>
                            <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">incr_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.listen.added_to_queue&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: adding POST metric_data to the flux.httpMetricDataQueue queue - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">metric_data</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                        <span class="k">return</span>

                <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Added TIMINGS</span>
                <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                    <span class="n">end_metrics_processing_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: metrics_processing took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_metrics_processing_timer</span> <span class="o">-</span> <span class="n">start_metrics_processing_timer</span><span class="p">))</span>

            <span class="c1"># @added 20230223 - Feature #4840: flux - prometheus - x-test-only header</span>
            <span class="k">if</span> <span class="n">test_only</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: test_only request&#39;</span><span class="p">)</span>
                <span class="n">current_aligned_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                <span class="n">test_only_redis_key</span> <span class="o">=</span> <span class="s1">&#39;flux.prometheus.test_only.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_aligned_ts</span><span class="p">))</span>
                <span class="n">test_only_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_only_data</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">test_only_redis_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to hgetall </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">test_only_redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">test_only_data</span><span class="p">:</span>
                    <span class="n">existing_test_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">existing_test_metrics</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">test_only_data</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">existing_test_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">all_test_metrics</span> <span class="o">=</span> <span class="n">test_only_metrics_submitted</span> <span class="o">+</span> <span class="n">existing_test_metrics</span>
                    <span class="n">test_metrics_that_would_be_ingested</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_test_metrics</span><span class="p">))</span>
                    <span class="n">existing_dropped_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">existing_dropped_metrics</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">test_only_redis_key</span><span class="p">[</span><span class="s1">&#39;dropped&#39;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">existing_dropped_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">all_dropped_metrics</span> <span class="o">=</span> <span class="n">existing_dropped_metrics</span>
                    <span class="n">test_metrics_that_would_be_dropped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_dropped_metrics</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">test_metrics_that_would_be_ingested</span> <span class="o">=</span> <span class="n">test_only_metrics_submitted</span>
                    <span class="n">test_metrics_that_would_be_dropped</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ingest_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_metrics_that_would_be_ingested</span><span class="p">)</span>
                <span class="n">drop_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_metrics_that_would_be_dropped</span><span class="p">)</span>
                <span class="n">test_only_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">),</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;metric ingestion test, no metrics were ingested only counts are reported&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ingest_count&#39;</span><span class="p">:</span> <span class="n">ingest_count</span><span class="p">,</span>
                    <span class="s1">&#39;drop_count&#39;</span><span class="p">:</span> <span class="n">drop_count</span><span class="p">,</span>
                    <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">test_metrics_that_would_be_ingested</span><span class="p">))),</span>
                    <span class="s1">&#39;dropped&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_metrics_that_would_be_dropped</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: test_only creating Redis hash </span><span class="si">%s</span><span class="s1"> with ingest_count: </span><span class="si">%s</span><span class="s1">, drop_count: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">test_only_redis_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ingest_count</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">drop_count</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">test_only_redis_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">test_only_data</span><span class="p">)</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">test_only_redis_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to hset </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">test_only_redis_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: test_only request completed&#39;</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">test_only_data</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">rejected_metrics_over_quota</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;over quota - this account is allowed </span><span class="si">%s</span><span class="s1"> metrics and an additional </span><span class="si">%s</span><span class="s1"> new metrics were posted that have been rejected&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">namespace_quota</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rejected_metrics_over_quota</span><span class="p">)))</span>
                    <span class="n">notice_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> metrics were processed and </span><span class="si">%s</span><span class="s1"> metrics were rejected&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rejected_metrics_over_quota</span><span class="p">)))</span>

                    <span class="c1"># @added 20220202 - Feature #4412: flux - quota - thunder alert</span>
                    <span class="k">if</span> <span class="n">test_metric_quota_exceeded_alert</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;TEST - over quota - this account is allowed </span><span class="si">%s</span><span class="s1"> metrics and an additional </span><span class="si">%s</span><span class="s1"> new metrics were posted that have been rejected&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">namespace_quota</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rejected_metrics_over_quota</span><span class="p">)))</span>
                        <span class="n">notice_msg</span> <span class="o">=</span> <span class="s1">&#39;TEST - </span><span class="si">%s</span><span class="s1"> metrics were processed and </span><span class="si">%s</span><span class="s1"> metrics were rejected&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rejected_metrics_over_quota</span><span class="p">)))</span>

                    <span class="c1"># @added 20220302 - Feature #4400: flux - quota</span>
                    <span class="n">namespace_over_quota_redis_key</span> <span class="o">=</span> <span class="s1">&#39;flux.quota.namespace_rejected_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">check_namespace_quota</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rejected_metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">rejected_metric</span> <span class="ow">in</span> <span class="n">rejected_metrics_over_quota</span><span class="p">:</span>
                            <span class="n">rejected_metrics_dict</span><span class="p">[</span><span class="n">rejected_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespace_quota_key_reference_timestamp</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">namespace_over_quota_redis_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">rejected_metrics_dict</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to add </span><span class="si">%s</span><span class="s1"> rejected metrics to </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rejected_metrics_over_quota</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_over_quota_redis_key</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

                    <span class="c1"># @added 20220302 - Feature #4400: flux - quota</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">rejected_metrics_over_quota</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to sadd to Redis set flux.listen.over_quota.rejected_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="c1"># @added 20220428 - Feature #4536: Handle Redis failure</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEMCACHE_ENABLED</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="n">set_memcache_key</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux.listen.over_quota.rejected_metrics&#39;</span><span class="p">,</span> <span class="n">rejected_metrics_over_quota</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: worker :: failed to set memcache flux.listen.over_quota.rejected_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;worker :: set memcache flux.listen.over_quota.rejected_metrics key - </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">rejected_metrics_over_quota</span><span class="p">:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">})</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">processed_metrics</span><span class="p">:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">204</span><span class="p">})</span>
                    <span class="n">return_code</span> <span class="o">=</span> <span class="mi">207</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">return_code</span> <span class="o">=</span> <span class="mi">400</span>

                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">return_code</span><span class="p">,</span>
                        <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">notice_msg</span><span class="p">,</span>
                        <span class="s1">&#39;rejected metrics&#39;</span><span class="p">:</span> <span class="n">rejected_metrics_over_quota</span><span class="p">,</span>
                        <span class="s1">&#39;rejected metrics count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_metrics_over_quota</span><span class="p">),</span>
                        <span class="s1">&#39;processed metrics&#39;</span><span class="p">:</span> <span class="n">processed_metrics</span><span class="p">,</span>
                        <span class="s1">&#39;processed metrics count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_metrics</span><span class="p">),</span>
                        <span class="s1">&#39;submitted metrics count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span>
                        <span class="c1"># Do not report skipped_metrics or the skipped_metrics_count</span>
                        <span class="c1"># &#39;skipped_metrics&#39;: skipped_metrics,</span>
                        <span class="s1">&#39;defined skipped_metrics count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">skipped_metrics</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="c1"># Create a log_body for debugging because logging at</span>
                    <span class="c1"># telegraf 5s flush_interval is VERB-OVERISTY and</span>
                    <span class="c1"># overservability</span>
                    <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
                    <span class="c1"># log_body = body.copy()</span>
                    <span class="n">log_body</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">log_body</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;redacted&#39;</span>
                        <span class="n">log_body</span><span class="p">[</span><span class="s1">&#39;rejected metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;redacted&#39;</span>
                        <span class="n">log_body</span><span class="p">[</span><span class="s1">&#39;processed metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;redacted&#39;</span>
                        <span class="c1"># log_body[&#39;skipped_metrics&#39;] = &#39;redacted&#39;</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">devnull</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="k">del</span> <span class="n">devnull</span>

                    <span class="c1"># @added 20220222 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># Drop telegraf metrics with a string or boolean value</span>
                    <span class="k">if</span> <span class="n">telegraf</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_base_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># @modified 20220303 - Feature #4284: flux - telegraf</span>
                        <span class="c1"># Do not add non-numeric dropped metrics to the client</span>
                        <span class="c1"># response</span>
                        <span class="c1"># body[&#39;dropped non-numeric metrics&#39;] = dropped_telegraf_non_numeric_value_base_names</span>
                        <span class="c1"># body[&#39;dropped non-numeric metrics count&#39;] = len(dropped_telegraf_non_numeric_value_base_names)</span>
                        <span class="n">len_dropped_telegraf_non_numeric_value_base_names</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_base_names</span><span class="p">)</span>
                        <span class="n">log_body</span><span class="p">[</span><span class="s1">&#39;dropped non-numeric metrics count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">len_dropped_telegraf_non_numeric_value_base_names</span>
                        <span class="n">log_body</span><span class="p">[</span><span class="s1">&#39;dropped non-numeric metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;redacted&#39;</span>
                        <span class="c1"># @added 20220302 - Feature #4400: flux - quota</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.dropped_non_numeric_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_metrics</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to sadd to Redis set flux.listen.dropped_non_numeric_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="c1"># @added 20220202 - Feature #4412: flux - quota - thunder alert</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">THUNDER_ENABLED</span><span class="p">:</span>
                        <span class="c1"># Note expiry is hardcoded here but thunder will override it</span>
                        <span class="c1"># if there is an expiry declared in an external_settings</span>
                        <span class="c1"># context</span>
                        <span class="n">expiry</span> <span class="o">=</span> <span class="mi">3600</span>
                        <span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;alert&#39;</span>
                        <span class="n">event_type</span> <span class="o">=</span> <span class="s1">&#39;metric_quota_exceeded&#39;</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1"> metrics rejected as over quota&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">level</span><span class="p">,</span> <span class="n">check_namespace_quota</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rejected_metrics_over_quota</span><span class="p">)))</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;metric quota exceeded&#39;</span>
                        <span class="k">if</span> <span class="n">test_metric_quota_exceeded_alert</span><span class="p">:</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1"> - rejected </span><span class="si">%s</span><span class="s1"> metrics rejected as over quota - TEST&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">level</span><span class="p">,</span> <span class="n">check_namespace_quota</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rejected_metrics_over_quota</span><span class="p">)))</span>
                            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;metric quota exceeded - TEST&#39;</span>
                        <span class="n">thunder_event</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span><span class="p">,</span>
                            <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="n">event_type</span><span class="p">,</span>
                            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                            <span class="s1">&#39;app&#39;</span><span class="p">:</span> <span class="n">skyline_app</span><span class="p">,</span>
                            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">skyline_app</span><span class="p">,</span>
                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">(),</span>
                            <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="n">expiry</span><span class="p">,</span>
                            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="n">check_namespace_quota</span><span class="p">,</span>
                                <span class="s1">&#39;dropped_non_numeric_metrics&#39;</span><span class="p">:</span> <span class="n">dropped_telegraf_non_numeric_value_base_names</span><span class="p">,</span>
                                <span class="s1">&#39;processed_metrics&#39;</span><span class="p">:</span> <span class="n">processed_metrics</span><span class="p">,</span>
                                <span class="s1">&#39;processed_metrics_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_metrics</span><span class="p">),</span>
                                <span class="s1">&#39;rejected_metrics&#39;</span><span class="p">:</span> <span class="n">rejected_metrics_over_quota</span><span class="p">,</span>
                                <span class="s1">&#39;rejected_metrics_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_metrics_over_quota</span><span class="p">),</span>
                                <span class="c1"># &#39;skipped_metrics&#39;: skipped_metrics,</span>
                                <span class="s1">&#39;skipped_metrics_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">skipped_metrics</span><span class="p">),</span>
                                <span class="s1">&#39;submitted_metrics_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span>
                                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;over quota&#39;</span>
                            <span class="p">},</span>
                        <span class="p">}</span>
                        <span class="n">submitted</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Do not log overly verbose</span>
                            <span class="c1"># submitted = thunder_send_event(skyline_app, thunder_event, log=False)</span>
                            <span class="n">submitted</span> <span class="o">=</span> <span class="n">thunder_send_event</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">thunder_event</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error encounterd with thunder_send_event - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">submitted</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: send thunder event metrics_qouta_exceeded for </span><span class="si">%s</span><span class="s1"> metrics on namespace </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rejected_metrics_over_quota</span><span class="p">)),</span> <span class="n">check_namespace_quota</span><span class="p">))</span>

                    <span class="c1"># @added 20220222 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># Drop telegraf metrics with a string or boolean value</span>
                    <span class="k">if</span> <span class="n">telegraf</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_metrics</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.dropped_non_numeric_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_metrics</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to sadd to Redis set flux.listen.dropped_non_numeric_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="c1"># @modified 20220303 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># Do not add non-numeric dropped metrics to the client</span>
                    <span class="c1"># response</span>
                    <span class="c1">#     try:</span>
                    <span class="c1">#         redis_conn_decoded.hset(&#39;flux.telegraf.dropped_non_numeric_metrics&#39;, mapping=dropped_telegraf_non_numeric_value_metrics)</span>
                    <span class="c1">#     except Exception as err:</span>
                    <span class="c1">#         logger.error(traceback.format_exc())</span>
                    <span class="c1">#         logger.error(&#39;error :: listen :: failed to update flux.telegraf.dropped_non_numeric_metrics Redis hash - %s&#39; % (</span>
                    <span class="c1">#             err))</span>
                    <span class="c1"># if telegraf and len(dropped_telegraf_non_numeric_value_base_names) &gt; 0:</span>
                    <span class="c1">#     try:</span>
                    <span class="c1">#         redis_conn_decoded.hset(&#39;flux.telegraf.dropped_non_numeric_base_names&#39;, mapping=dropped_telegraf_non_numeric_value_base_names)</span>
                    <span class="c1">#     except Exception as err:</span>
                    <span class="c1">#         logger.error(traceback.format_exc())</span>
                    <span class="c1">#         logger.error(&#39;error :: listen :: failed to update flux.telegraf.dropped_non_numeric_base_names Redis hash - %s&#39; % (</span>
                    <span class="c1">#             err))</span>
                    <span class="c1">#     for dropped_metric in list(dropped_telegraf_non_numeric_value_base_names.keys()):</span>
                    <span class="c1">#         data.append({&#39;metric&#39;: dropped_metric, &#39;status&#39;: 400, &#39;reason&#39;: &#39;non-numeric value&#39;})</span>
                    <span class="c1">#     body[&#39;data&#39;] = data</span>

                    <span class="c1"># @added 20220303 - Feature #4400: flux - quota</span>
                    <span class="k">if</span> <span class="n">metrics_added_to_aggregation</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_conn</span><span class="o">.</span><span class="n">incrby</span><span class="p">(</span><span class="s1">&#39;flux.listen.added_to_aggregation_queue&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_added_to_aggregation</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to incrby to Redis key flux.listen.added_to_aggregation_queue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: </span><span class="si">%s</span><span class="s1">, returning </span><span class="si">%s</span><span class="s1"> on metric_namespace_prefix: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">message</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">return_code</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">check_namespace_quota</span><span class="p">)))</span>
                    <span class="c1"># logger.debug(&#39;debug :: listen :: %s&#39; % str(body))</span>
                    <span class="k">if</span> <span class="n">return_code</span> <span class="o">==</span> <span class="mi">207</span><span class="p">:</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_207</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: returning </span><span class="si">%s</span><span class="s1"> on metric_namespace_prefix: </span><span class="si">%s</span><span class="s1"> with sample of response: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">return_code</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">check_namespace_quota</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">log_body</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: error building 207 body, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                    <span class="k">return</span>

            <span class="c1"># @modified 20220208 - Feature #4284: flux - telegraf</span>
            <span class="c1"># Converted a single metric post to a multiple metric post.  Removed the</span>
            <span class="c1"># handling of a single metric POST format.</span>
            <span class="c1"># if not metrics:</span>

            <span class="c1"># @added 20220209 - Feature #4432: functions.metrics.skip_metric</span>
            <span class="k">if</span> <span class="n">not_skipped_metrics</span><span class="p">:</span>
                <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
                <span class="k">for</span> <span class="n">received_namespace</span> <span class="ow">in</span> <span class="n">received_namespaces</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                            <span class="n">start_flux_not_skipped_metrics_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: checking </span><span class="si">%s</span><span class="s1"> not_skipped_metrics to update flux.not_skipped_metrics keys for </span><span class="si">%s</span><span class="s1"> received_namespaces, checking </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_skipped_metrics</span><span class="p">)),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">received_namespaces</span><span class="p">)),</span>
                                <span class="n">received_namespace</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: not_skipped_metrics sample: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">not_skipped_metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: not_skipped_metrics_dict count: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_skipped_metrics_dict</span><span class="p">))))</span>
                        <span class="n">update_not_skipped_metrics</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">not_skipped_metrics</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">received_namespace</span><span class="p">):</span>
                                <span class="n">update_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="n">original_redis_not_skipped_metrics_dict</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="c1"># Only update not_skipped metrics every hour to save on</span>
                                        <span class="c1"># Redis overhead</span>
                                        <span class="n">last_update_timestamp_str</span> <span class="o">=</span> <span class="n">original_redis_not_skipped_metrics_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                                        <span class="k">if</span> <span class="n">last_update_timestamp_str</span><span class="p">:</span>
                                            <span class="n">last_update_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">last_update_timestamp_str</span><span class="p">))</span>
                                            <span class="k">if</span> <span class="p">(</span><span class="n">post_req_start</span> <span class="o">-</span> <span class="n">last_update_timestamp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3600</span><span class="p">:</span>
                                                <span class="n">update_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">update_entry</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="n">update_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">update_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">update_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="n">update_entry</span><span class="p">:</span>
                                    <span class="n">update_not_skipped_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">post_req_start</span>
                        <span class="k">if</span> <span class="n">update_not_skipped_metrics</span><span class="p">:</span>
                            <span class="n">flux_not_skipped_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;flux.not_skipped_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">received_namespace</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">flux_not_skipped_metrics_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">update_not_skipped_metrics</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to update </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">flux_not_skipped_metrics_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                            <span class="n">end_flux_not_skipped_metrics_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">update_not_skipped_metrics</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: updating </span><span class="si">%s</span><span class="s1"> took </span><span class="si">%.6f</span><span class="s1"> seconds to update with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">flux_not_skipped_metrics_key</span><span class="p">,</span>
                                    <span class="p">(</span><span class="n">end_flux_not_skipped_metrics_timer</span> <span class="o">-</span> <span class="n">start_flux_not_skipped_metrics_timer</span><span class="p">),</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">update_not_skipped_metrics</span><span class="p">))))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: no metrics to update in </span><span class="si">%s</span><span class="s1"> check took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">flux_not_skipped_metrics_key</span><span class="p">,</span> <span class="p">(</span><span class="n">end_flux_not_skipped_metrics_timer</span> <span class="o">-</span> <span class="n">start_flux_not_skipped_metrics_timer</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: an error occurred check flux.not_skipped_metrics to update - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">skipped_metrics</span><span class="p">:</span>
                <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
                <span class="k">for</span> <span class="n">received_namespace</span> <span class="ow">in</span> <span class="n">received_namespaces</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">flux_skipped_metrics_key</span> <span class="o">=</span> <span class="s1">&#39;flux.skipped_metrics.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">received_namespace</span>
                        <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                            <span class="n">start_flux_skipped_metrics_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                            <span class="n">skipped_metrics_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">skipped_metrics</span><span class="p">)))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: checking which of the </span><span class="si">%s</span><span class="s1"> skipped metrics need updating in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">skipped_metrics_count</span><span class="p">),</span> <span class="n">flux_skipped_metrics_key</span><span class="p">))</span>
                        <span class="n">update_skipped_metrics</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">skipped_metrics</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">received_namespace</span><span class="p">):</span>
                                <span class="n">update_entry</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">original_redis_skipped_metrics_dict</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="c1"># Only update skipped metrics every hour to save on</span>
                                        <span class="c1"># Redis overhead</span>
                                        <span class="n">last_update_timestamp_str</span> <span class="o">=</span> <span class="n">original_redis_skipped_metrics_dict</span><span class="p">[</span><span class="n">received_namespace</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span>
                                        <span class="k">if</span> <span class="n">last_update_timestamp_str</span><span class="p">:</span>
                                            <span class="n">last_update_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">last_update_timestamp_str</span><span class="p">))</span>
                                            <span class="k">if</span> <span class="p">(</span><span class="n">post_req_start</span> <span class="o">-</span> <span class="n">last_update_timestamp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3600</span><span class="p">:</span>
                                                <span class="n">update_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="n">update_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">update_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">update_entry</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="n">update_entry</span><span class="p">:</span>
                                    <span class="n">update_skipped_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">post_req_start</span>
                        <span class="k">if</span> <span class="n">update_skipped_metrics</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: </span><span class="si">%s</span><span class="s1"> skipped metrics need updating in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">update_skipped_metrics</span><span class="p">)),</span> <span class="n">flux_skipped_metrics_key</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">flux_skipped_metrics_key</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">update_skipped_metrics</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to update </span><span class="si">%s</span><span class="s1"> Redis hash - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">flux_skipped_metrics_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: no skipped metrics need updating in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_skipped_metrics_key</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                            <span class="n">end_flux_skipped_metrics_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: updating </span><span class="si">%s</span><span class="s1"> took </span><span class="si">%.6f</span><span class="s1"> seconds to update with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">flux_skipped_metrics_key</span><span class="p">,</span>
                                <span class="p">(</span><span class="n">end_flux_skipped_metrics_timer</span> <span class="o">-</span> <span class="n">start_flux_skipped_metrics_timer</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">update_skipped_metrics</span><span class="p">))))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: an error occurred check flux.skipped_metrics to update - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
            <span class="n">end_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: POST request took </span><span class="si">%.6f</span><span class="s1"> seconds to process </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">end_request_timer</span> <span class="o">-</span> <span class="n">start_request_timer</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">))))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to calculate request time - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># @added 20220222 - Feature #4284: flux - telegraf</span>
            <span class="c1"># Drop telegraf metrics with a string or boolean value, respond with a</span>
            <span class="c1"># 207</span>
            <span class="k">if</span> <span class="n">telegraf</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_base_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c1"># @added 20220302 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Drop telegraf metrics with a string or boolean value</span>
                <span class="c1"># @modified 20220303 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Do not add non-numeric dropped metrics to the client</span>
                <span class="c1"># response</span>
                <span class="n">respond_with_dropped_telegraf_non_numeric</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># try:</span>
                <span class="c1">#     redis_conn_decoded.hset(&#39;flux.telegraf.dropped_non_numeric_metrics&#39;, mapping=dropped_telegraf_non_numeric_value_metrics)</span>
                <span class="c1"># except Exception as err:</span>
                <span class="c1">#     logger.error(traceback.format_exc())</span>
                <span class="c1">#     logger.error(&#39;error :: listen :: failed to update flux.telegraf.dropped_non_numeric_metrics Redis hash - %s&#39; % (</span>
                <span class="c1">#         err))</span>
                <span class="c1"># try:</span>
                <span class="c1">#     redis_conn_decoded.hset(&#39;flux.telegraf.dropped_non_numeric_base_names&#39;, mapping=dropped_telegraf_non_numeric_value_base_names)</span>
                <span class="c1"># except Exception as err:</span>
                <span class="c1">#     logger.error(traceback.format_exc())</span>
                <span class="c1">#     logger.error(&#39;error :: listen :: failed to update flux.telegraf.dropped_non_numeric_base_names Redis hash - %s&#39; % (</span>
                <span class="c1">#         err))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.dropped_non_numeric_metrics&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_metrics</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to sadd to Redis set flux.listen.dropped_non_numeric_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># @modified 20220303 - Feature #4284: flux - telegraf</span>
                <span class="c1"># Do not add non-numeric dropped metrics to the client</span>
                <span class="c1"># response</span>
                <span class="n">respond_with_dropped_telegraf_non_numeric</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">respond_with_dropped_telegraf_non_numeric</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">return_code</span> <span class="o">=</span> <span class="mi">207</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">dropped_metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_base_names</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">dropped_metric</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;non-numeric value&#39;</span><span class="p">})</span>
                        <span class="n">notice_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> non-numeric value metrics were dropped&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_base_names</span><span class="p">))</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">return_code</span><span class="p">,</span>
                            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">notice_msg</span><span class="p">,</span>
                            <span class="s1">&#39;dropped non-numeric metrics&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_base_names</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                            <span class="s1">&#39;dropped non-numeric metrics count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_base_names</span><span class="p">),</span>
                            <span class="s1">&#39;processed metrics count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_metrics</span><span class="p">),</span>
                            <span class="s1">&#39;submitted metrics count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span>
                            <span class="c1"># &#39;skipped_metrics&#39;: skipped_metrics,</span>
                            <span class="s1">&#39;defined skipped_metrics_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">skipped_metrics</span><span class="p">)</span>
                        <span class="p">}</span>
                        <span class="c1"># @modified 20220722 - Task #4624: Change all dict copy to deepcopy</span>
                        <span class="c1"># log_body = body.copy()</span>
                        <span class="n">log_body</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">log_body</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;redacted&#39;</span>
                            <span class="n">log_body</span><span class="p">[</span><span class="s1">&#39;dropped non-numeric metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;redacted&#39;</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">devnull</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">devnull</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to json.dumps body: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dropped string value metrics count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_base_names</span><span class="p">)}</span>
                            <span class="n">return_code</span> <span class="o">=</span> <span class="mi">200</span>
                        <span class="k">if</span> <span class="n">return_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                        <span class="k">if</span> <span class="n">return_code</span> <span class="o">==</span> <span class="mi">207</span><span class="p">:</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_207</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;listen :: debug :: returning </span><span class="si">%s</span><span class="s1"> on metric_namespace_prefix: </span><span class="si">%s</span><span class="s1"> with for dropped_telegraf_non_numeric_value_base_names with sample of the response: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">return_code</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">check_namespace_quota</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">log_body</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to respond with non-numeric value metrics were dropped response: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

            <span class="c1"># @added 20220303 - Feature #4400: flux - quota</span>
            <span class="k">if</span> <span class="n">metrics_added_to_aggregation</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">incrby</span><span class="p">(</span><span class="s1">&#39;flux.listen.added_to_aggregation_queue&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_added_to_aggregation</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to incrby to Redis key flux.listen.added_to_aggregation_queue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">postData</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="c1"># @modified 20220222 - Feature #4284: flux - telegraf</span>
                    <span class="c1"># Never log POST data as it can be massive</span>
                    <span class="c1"># logger.error(&#39;error :: listen :: failed to json.dumps postData - %s&#39; % str(postData))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to json.dumps postData - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;postData&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: returning 200 on metric_data_post request for metric_namespace_prefix: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_204</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: metric_data_post return 204 - metrics: </span><span class="si">%s</span><span class="s1">, processed: </span><span class="si">%s</span><span class="s1"> (to aggregate </span><span class="si">%s</span><span class="s1">), skipped: </span><span class="si">%s</span><span class="s1">, dropped non-numeric: </span><span class="si">%s</span><span class="s1">, metric_namespace_prefix: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_metrics</span><span class="p">)),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_added_to_aggregation</span><span class="p">)),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">skipped_metrics</span><span class="p">)))),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dropped_telegraf_non_numeric_value_metrics</span><span class="p">)),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">)))</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: metric_data_post failed, returning 500 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span></div></div>


<span class="c1"># @added 20220405 - Feature #4516: flux - opentelemetry traces</span>
<div class="viewcode-block" id="OTLPTracePost"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.OTLPTracePost">[docs]</a><span class="k">class</span> <span class="nc">OTLPTracePost</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<div class="viewcode-block" id="OTLPTracePost.on_post"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.OTLPTracePost.on_post">[docs]</a>    <span class="k">def</span> <span class="nf">on_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The /flux/otlp/v1/trace endpoint is called via a POST with a content</span>
<span class="sd">        type of application/x-protobuf</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">FLUX_OTEL_ENABLED</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;otel traces not enabled&#39;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: OTLPTracePost :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
            <span class="k">return</span>

        <span class="n">trace_post_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
        <span class="n">start_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">metrics_added_to_aggregation</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_trace_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_timings_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_metrics</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: OTLPTracePost :: get_header(</span><span class="se">\&#39;</span><span class="s1">status</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;OK&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: OTLPTracePost :: </span><span class="si">%s</span><span class="s1">, returning 200&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                <span class="k">return</span>

            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: OTLPTracePost :: get_header(</span><span class="se">\&#39;</span><span class="s1">key</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no key passed&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: OTLPTracePost :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="n">keyValid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">keyValid</span><span class="p">,</span> <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="n">validate_key</span><span class="p">(</span><span class="s1">&#39;listen :: OTLPTracePost&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: OTLPTracePost :: could not validate the key from header - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keyValid</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: OTLPTracePost :: invalid key in header - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">key</span><span class="p">))</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid key&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: OTLPTracePost :: </span><span class="si">%s</span><span class="s1">, returning 401&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_401</span>
                <span class="k">return</span>

            <span class="c1"># Preserve the request for debugging</span>
            <span class="n">traceData_obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">traceData_obj</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: OTLPTracePost :: req.stream.read() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">content_encoding</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">content_encoding</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;content-encoding&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: OTLPTracePost :: get_header(</span><span class="se">\&#39;</span><span class="s1">content-encoding</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">content_encoding</span> <span class="o">==</span> <span class="s1">&#39;gzip&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">traceData_obj</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">traceData_obj</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: OTLPTracePost :: gzip.decompress(traceData_obj) failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">traceP</span> <span class="o">=</span> <span class="n">trace_pb2</span><span class="o">.</span><span class="n">TracesData</span><span class="p">()</span>
                <span class="n">traceP</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">traceData_obj</span><span class="p">)</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">pb_json_format</span><span class="o">.</span><span class="n">MessageToDict</span><span class="p">(</span><span class="n">traceP</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># logger.error(traceback.format_exc())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: OTLPTracePost :: could not parse OLTP trace data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">trace</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid OLTP trace data&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: OTLPTracePost :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>
            <span class="n">resourceSpans</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resourceSpans</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;resourceSpans&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">resourceSpans</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resourceSpans</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: OTLPTracePost :: could not parse trace[</span><span class="se">\&#39;</span><span class="s1">resourceSpans</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid OLTP trace data no resourceSpans&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: OTLPTracePost :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>
            <span class="n">timings</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">resourceSpans</span><span class="p">:</span>
                <span class="c1"># The service name, name and resulting metric is questionable in</span>
                <span class="c1"># terms of achieveing consistency across all types of naming</span>
                <span class="c1"># conventions</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">service_name</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">][</span><span class="s1">&#39;attributes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;stringValue&#39;</span><span class="p">]</span>
                    <span class="c1"># @modified 20220422 - Bug #4532: opentelemetry - rename InstrumentationLibrary to InstrumentationScope</span>
                    <span class="c1">#                      Task #4452: Update dependencies</span>
                    <span class="c1"># instrumentationLibrarySpans was deprecated and changed to</span>
                    <span class="c1"># scopeSpans between 1.10.0 and 1.11.0 wtf?</span>
                    <span class="n">use_scope</span> <span class="o">=</span> <span class="s1">&#39;instrumentationLibrarySpans&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">trace_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;instrumentationLibrarySpans&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;spans&#39;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">trace_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;scopeSpans&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;spans&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">trace_count</span><span class="p">:</span>
                            <span class="n">use_scope</span> <span class="o">=</span> <span class="s1">&#39;scopeSpans&#39;</span>
                    <span class="n">total_trace_count</span> <span class="o">=</span> <span class="n">total_trace_count</span> <span class="o">+</span> <span class="n">trace_count</span>
                    <span class="c1"># for span_dict in i[&#39;instrumentationLibrarySpans&#39;][0][&#39;spans&#39;]:</span>
                    <span class="k">for</span> <span class="n">span_dict</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="n">use_scope</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;spans&#39;</span><span class="p">]:</span>
                        <span class="n">db_system</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">attribute_dict</span> <span class="ow">in</span> <span class="n">span_dict</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">attribute_dict</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;service.name&#39;</span><span class="p">:</span>
                                <span class="n">service_name</span> <span class="o">=</span> <span class="n">attribute_dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;stringValue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">attribute_dict</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;db.system&#39;</span><span class="p">:</span>
                                <span class="n">db_system</span> <span class="o">=</span> <span class="n">attribute_dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;stringValue&#39;</span><span class="p">]</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">span_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;client&#39;</span>
                        <span class="k">if</span> <span class="n">span_dict</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPAN_KIND_SERVER&#39;</span><span class="p">:</span>
                            <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;server&#39;</span>
                        <span class="k">if</span> <span class="n">db_system</span><span class="p">:</span>
                            <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">db_system</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">metric_namespace_prefix</span><span class="p">:</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.otel.traces.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">metric_namespace_prefix</span><span class="p">,</span> <span class="n">service_name</span><span class="p">,</span>
                                <span class="n">kind</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;otel.traces.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">service_name</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="n">sanitised_metric</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ALLOWED_CHARS</span><span class="p">:</span>
                                <span class="n">sanitised_metric</span> <span class="o">=</span> <span class="n">sanitised_metric</span> <span class="o">+</span> <span class="n">c</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sanitised_metric</span><span class="p">)</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="n">total_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                        <span class="n">timing_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.seconds&#39;</span> <span class="o">%</span> <span class="n">metric</span>
                        <span class="n">timing_metric</span> <span class="o">=</span> <span class="n">timing_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">valid_metric_name</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">validate_metric_name</span><span class="p">(</span><span class="s1">&#39;listen :: OTLPTracePost&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: OTLPTracePost :: could validate_metric_name - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">reason</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                            <span class="n">valid_metric_name</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_metric_name</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">took</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">span_dict</span><span class="p">[</span><span class="s1">&#39;endTimeUnixNano&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">span_dict</span><span class="p">[</span><span class="s1">&#39;startTimeUnixNano&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">1000000000</span>
                        <span class="n">total_timings_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">metric_times</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">metric_times</span> <span class="o">=</span> <span class="n">timings</span><span class="p">[</span><span class="n">timing_metric</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">metric_times</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">metric_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">took</span><span class="p">)</span>
                        <span class="n">timings</span><span class="p">[</span><span class="n">timing_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_times</span>
                        <span class="k">if</span> <span class="n">span_dict</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPAN_KIND_SERVER&#39;</span><span class="p">:</span>
                            <span class="n">trace_count_metric</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.trace_count&#39;</span> <span class="o">%</span> <span class="n">metric</span>
                            <span class="n">trace_count_metric</span> <span class="o">=</span> <span class="n">trace_count_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                            <span class="n">trace_counts</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">trace_counts</span> <span class="o">=</span> <span class="n">timings</span><span class="p">[</span><span class="n">trace_count_metric</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">trace_counts</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">trace_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace_count</span><span class="p">)</span>
                            <span class="n">timings</span><span class="p">[</span><span class="n">trace_count_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace_counts</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: OTLPTracePost :: failed to iterate resourceSpans - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: OTLPTracePost :: resourceSpan: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                    <span class="k">return</span>
            <span class="n">agg_timings</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">timings</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">timings</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="n">agg_timings</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">status_codes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">agg_timings</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">agg_timings</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                    <span class="n">backfill</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">aggregate</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">metric_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace_post_start</span><span class="p">,</span> <span class="n">backfill</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">]</span>
                    <span class="n">added_to_aggregation_queue</span><span class="p">,</span> <span class="n">return_status_code</span> <span class="o">=</span> <span class="n">add_to_aggregate_metric_queue</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_data</span><span class="p">,</span> <span class="n">aggregate_metrics</span><span class="p">,</span> <span class="n">aggregate_namespaces_list</span><span class="p">)</span>
                    <span class="n">status_codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">return_status_code</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">added_to_aggregation_queue</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">return_status_code</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                            <span class="k">return</span>
                        <span class="k">if</span> <span class="n">return_status_code</span> <span class="o">==</span> <span class="mi">204</span><span class="p">:</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_204</span>
                            <span class="n">metrics_added_to_aggregation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: OTLPTracePost :: error add_to_aggregate_metric_queue failed, returning 500 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                    <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: OTLPTracePost :: error add_to_aggregate_metric_queue failed, returning 500 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">metrics_added_to_aggregation</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">redis_conn</span><span class="o">.</span><span class="n">incrby</span><span class="p">(</span><span class="s1">&#39;flux.listen.added_to_aggregation_queue&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_added_to_aggregation</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: OTLPTracePost :: failed to incrby to Redis key flux.listen.added_to_aggregation_queue - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">redis_conn</span><span class="o">.</span><span class="n">incrby</span><span class="p">(</span><span class="s1">&#39;flux.listen.otlp_traces.trace_count&#39;</span><span class="p">,</span> <span class="n">total_trace_count</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to incrby to Redis key flux.listen.otlp_traces.trace_count - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">redis_conn</span><span class="o">.</span><span class="n">incrby</span><span class="p">(</span><span class="s1">&#39;flux.listen.otlp_traces.timings_count&#39;</span><span class="p">,</span> <span class="n">total_timings_count</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to incrby to Redis key flux.listen.otlp_traces.timings_count - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">redis_conn</span><span class="o">.</span><span class="n">incrby</span><span class="p">(</span><span class="s1">&#39;flux.listen.otlp_traces.metrics&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_metrics</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to incrby to Redis key flux.listen.otlp_traces.metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_204</span>
        <span class="k">return</span></div></div>


<span class="c1"># @added 20221118 - Feature #4732: flux vortex</span>
<span class="c1">#                   Feature #4734: mirage_vortex</span>
<div class="viewcode-block" id="VortexDataPost"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.VortexDataPost">[docs]</a><span class="k">class</span> <span class="nc">VortexDataPost</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<div class="viewcode-block" id="VortexDataPost.on_post"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.VortexDataPost.on_post">[docs]</a>    <span class="k">def</span> <span class="nf">on_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The /flux/vortex endpoint is called via a POST with a json</span>
<span class="sd">        object as defined below, with the optional fill parameter to allow</span>
<span class="sd">        flux to backfill airgap data for a metric:</span>

<span class="sd">        For example::</span>

<span class="sd">            {</span>
<span class="sd">                &quot;key&quot;: &quot;apikey|str&quot;,                        # required</span>
<span class="sd">                &quot;metric&quot;: &quot;metric|str&quot;,                     # required</span>
<span class="sd">                &quot;timeout&quot;: seconds|int,                     # required</span>
<span class="sd">                &quot;timeseries&quot;: timeseries|[list,dict],       # required</span>
<span class="sd">                &quot;algorithms&quot;: {</span>
<span class="sd">                    &quot;default&quot;: {},</span>
<span class="sd">                    &quot;sigma&quot;: {&quot;consensus&quot;: 6},</span>
<span class="sd">                    &quot;matrixprofile&quot;: {&quot;window&quot;: },</span>
<span class="sd">                    &quot;spectral_residual&quot;: {},</span>
<span class="sd">                    &quot;dbscan&quot;: {},</span>
<span class="sd">                    &quot;lof&quot;: {},</span>
<span class="sd">                },                                          # optional</span>
<span class="sd">                &quot;consensus&quot;: [[&quot;sigma&quot;, &quot;sr&quot;], [&quot;sigma&quot;, &quot;matrixprofile&quot;]],</span>
<span class="sd">                &quot;consensus_count&quot;: 0,                       # optional</span>
<span class="sd">                &quot;check_all_consensuses&quot;: false,</span>
<span class="sd">                &quot;reference&quot;: &quot;a reference id for you|str&quot;   # optional</span>
<span class="sd">            }</span>

<span class="sd">        For example::</span>

<span class="sd">            {</span>
<span class="sd">                &quot;algorithms&quot;: {&quot;default&quot;: {}},</span>
<span class="sd">                &quot;key&quot;: &quot;1234567890abcdefghijklmnop&quot;,</span>
<span class="sd">                &quot;metric&quot;: &quot;prometheus_http_requests_total{alias=\\&quot;Prometheus\\&quot;, code=\\&quot;200\\&quot;, handler=\\&quot;/api/v1/query_range\\&quot;, instance=\\&quot;localhost:9090\\&quot;, job=\\&quot;prometheus\\&quot;}&quot;,</span>
<span class="sd">                &quot;timeout&quot;: 45,</span>
<span class="sd">                &quot;timeseries&quot;: [[1668689060, 23.3], ..., [1668689120, 20.9]],</span>
<span class="sd">            }</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># @modified 20230502 Feature #4732: flux vortex</span>
        <span class="c1">#                    Feature #4734: mirage_vortex</span>
        <span class="c1"># Handle cluster fqdn being different from the hostname</span>
        <span class="c1"># by determining the URL FQDN from REMOTE_SKYLINE_INSTANCES</span>
        <span class="c1"># def shard_host(metric, check_horizon_shards):</span>
        <span class="k">def</span> <span class="nf">shard_host</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">check_horizon_shards</span><span class="p">,</span> <span class="n">return_fqdn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the shard host to which a metric belongs.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_horizon_shards</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">this_host</span>
            <span class="n">metric_as_bytes</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">adler32</span><span class="p">(</span><span class="n">metric_as_bytes</span><span class="p">)</span>
            <span class="n">modulo_result</span> <span class="o">=</span> <span class="n">value</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_horizon_shards</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">shost</span> <span class="ow">in</span> <span class="n">check_horizon_shards</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">modulo_result</span> <span class="o">==</span> <span class="n">check_horizon_shards</span><span class="p">[</span><span class="n">shost</span><span class="p">]:</span>

                    <span class="c1"># @added 20230502 - Feature #4732: flux vortex</span>
                    <span class="c1">#                   Feature #4734: mirage_vortex</span>
                    <span class="c1"># Handle cluster fqdn being different from the hostname</span>
                    <span class="c1"># by determining the URL FQDN from REMOTE_SKYLINE_INSTANCES</span>
                    <span class="k">if</span> <span class="n">return_fqdn</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">shost</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                                <span class="k">return</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">return</span> <span class="n">shost</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">postData</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">post_req_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">request_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">post_req_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>

            <span class="c1"># @added 20220210 - Feature #4284: flux - telegraf</span>
            <span class="n">start_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

            <span class="c1"># @added 20210512 - Feature #4060: skyline.flux.worker.discarded metrics</span>
            <span class="c1"># Preserve the request for debugging</span>
            <span class="n">postData_obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">postData_obj</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: req.stream.read() failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="c1"># Allow for gzip data</span>
            <span class="c1"># DEBUG</span>
            <span class="c1"># all_headers = None</span>
            <span class="c1"># try:</span>
            <span class="c1">#     all_headers = str(req.headers)</span>
            <span class="c1"># except Exception as err:</span>
            <span class="c1">#     logger.error(&#39;listen :: req.headers() error - %s&#39; % str(err))</span>
            <span class="c1"># logger.info(&#39;debug :: listen :: headers - %s&#39; % str(all_headers))</span>
            <span class="n">content_encoding</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">content_encoding</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;content-encoding&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: get_header(</span><span class="se">\&#39;</span><span class="s1">content-encoding</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="c1"># if content_encoding:</span>
            <span class="c1">#     logger.info(&#39;debug :: listen :: content_encoding: %s&#39; % str(content_encoding))</span>
            <span class="c1"># else:</span>
            <span class="c1">#     logger.info(&#39;debug :: listen :: no content_encoding: %s&#39; % str(content_encoding))</span>
            <span class="k">if</span> <span class="n">content_encoding</span> <span class="o">==</span> <span class="s1">&#39;gzip&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: vortex :: content_encoding: </span><span class="si">%s</span><span class="s1">, decompressing&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">content_encoding</span><span class="p">))</span>
                    <span class="n">start_gzip_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">postData_obj</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">postData_obj</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: gzip.decompress(postData_obj) failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">TIMINGS</span><span class="p">:</span>
                    <span class="n">end_gzip_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: vortex :: gzip decompression took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_gzip_timer</span> <span class="o">-</span> <span class="n">start_gzip_timer</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">postData</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">postData_obj</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: vortex :: postData_obj: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData_obj</span><span class="p">))</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid json data&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: invalid post data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="c1"># logger.debug(&#39;debug :: listen :: vortex :: postData_obj: %s&#39; % str(postData_obj))</span>

            <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: vortex :: request arguments and POST data - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">)))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">postData</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: vortex :: no POST data recieved&#39;</span><span class="p">)</span>

                <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_parameters no POST data&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to add entry to Redis set flux.listen.discarded.invalid_parameters no POST data- </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_post_data&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData_obj</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to data to Redis set flux.listen.discarded.invalid_post_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no POST data received&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20211018 - Feature #4284: flux - telegraf</span>
            <span class="c1"># Allow the key to be passed as a HTTP header rather than in the json</span>
            <span class="c1"># payload</span>
            <span class="n">header_apikey</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header_apikey</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: get_header(</span><span class="se">\&#39;</span><span class="s1">key</span><span class="se">\&#39;</span><span class="s1">) error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

            <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: POST status - ok&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s1">&#39;flux.listen.vortex&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: setex on flux.listen failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: could not validate the status key POST request argument - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                    <span class="k">return</span>

            <span class="c1"># @added 20200818 - Feature #3694: flux - POST multiple metrics</span>
            <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Allow the key to be passed as a HTTP header rather than in the json</span>
            <span class="c1"># payload</span>
            <span class="k">if</span> <span class="n">header_apikey</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">header_apikey</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no key passed&#39;</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="c1"># Never log POST data as it can be massive</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not determine the key from POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Added metric_namespace_prefix</span>
                <span class="n">keyValid</span><span class="p">,</span> <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="n">validate_key</span><span class="p">(</span><span class="s1">&#39;listen :: MetricDataPOST POST&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">keyValid</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: invalid key in POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
                    <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_key&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_key&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to add entry to Redis set flux.listen.discarded.invalid_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid key&#39;</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: vortex :: </span><span class="si">%s</span><span class="s1">, returning 401&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                    <span class="c1"># Return 401 if bad key</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_401</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: vortex :: valid key, metric_namespace_prefix set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: could not validate the key from POST data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">err</span><span class="p">))</span>
                <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_key&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_key&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to add entry to Redis set flux.listen.discarded.invalid_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid key&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: vortex :: </span><span class="si">%s</span><span class="s1">, returning 401&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_401</span>
                <span class="k">return</span>

            <span class="c1"># Allow FLUX_SELF_API_KEY requests to set the metric_namespace_prefix</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">FLUX_SELF_API_KEY</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric_namespace_prefix</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;metric_namespace_prefix&#39;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">request_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_namespace_prefix</span><span class="p">))</span>

            <span class="n">validated_key</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">validated_key</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;validate_key&#39;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: validate_key: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">validated_key</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">validated_key</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to determine validated_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">validated_key</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;key valid&quot;</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: validate_key returning 200&#39;</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to response to validate_key request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

            <span class="n">valid_post_keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;algorithms&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;timeseries&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s1">&#39;consensus&#39;</span><span class="p">,</span> <span class="s1">&#39;no_downsample&#39;</span><span class="p">,</span>
                <span class="c1"># @added 20230129</span>
                <span class="s1">&#39;override_7_day_limit&#39;</span><span class="p">,</span>
                <span class="c1"># @added 20230613 - Feature #4948: vortex - adtk algorithms</span>
                <span class="c1"># Changed the adtk algorithms to return a results dict</span>
                <span class="c1"># like other custom algorithms that vortex can run</span>
                <span class="s1">&#39;realtime_analysis&#39;</span><span class="p">,</span> <span class="s1">&#39;return_results&#39;</span><span class="p">,</span> <span class="s1">&#39;check_all_consensuses&#39;</span><span class="p">,</span>
                <span class="c1"># @added 20230616 - Feature #4952: vortex - consensus_count</span>
                <span class="s1">&#39;consensus_count&#39;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="c1"># Allow FLUX_SELF_API_KEY requests to pass additional parameters</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">FLUX_SELF_API_KEY</span><span class="p">:</span>
                <span class="n">valid_post_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;save_training_data_on_false&#39;</span><span class="p">)</span>
                <span class="n">valid_post_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;shard_test&#39;</span><span class="p">)</span>
                <span class="n">valid_post_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;metric_namespace_prefix&#39;</span><span class="p">)</span>
                <span class="n">valid_post_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;send_to_ionosphere&#39;</span><span class="p">)</span>
                <span class="n">valid_post_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;return_image_urls&#39;</span><span class="p">)</span>
                <span class="n">valid_post_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;trigger_anomaly&#39;</span><span class="p">)</span>
                <span class="n">valid_post_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;algorithms_test_only&#39;</span><span class="p">)</span>
                <span class="n">valid_post_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;processing_shard_url&#39;</span><span class="p">)</span>

            <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
            <span class="n">invalid_post_key</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">post_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">postData</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">post_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_post_keys</span><span class="p">:</span>
                    <span class="n">invalid</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">invalid_post_key</span> <span class="o">=</span> <span class="n">post_key</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">invalid</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">post_key</span> <span class="o">==</span> <span class="s1">&#39;algorithms&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="n">post_key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">invalid</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">invalid_post_key</span> <span class="o">=</span> <span class="n">post_key</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">post_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="n">post_key</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">invalid</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">invalid_post_key</span> <span class="o">=</span> <span class="n">post_key</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">post_key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="n">post_key</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">post_key</span> <span class="o">==</span> <span class="s1">&#39;timeseries&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="n">post_key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="n">post_key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                                <span class="n">invalid</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">invalid_post_key</span> <span class="o">=</span> <span class="n">post_key</span>
                                <span class="k">break</span>

            <span class="k">if</span> <span class="n">invalid</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_parameters&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to add entry to Redis set flux.listen.discarded.invalid_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid POST element passed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">invalid_post_key</span><span class="p">)</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="c1"># Determine if the number of algorithms declared breaches the</span>
            <span class="c1"># maximum</span>
            <span class="n">algorithms_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">algorithms_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">algorithms_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="s1">&#39;algorithms&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">algorithms_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">algorithms_count</span><span class="p">:</span>
                <span class="n">algorithms_err</span> <span class="o">=</span> <span class="s1">&#39;no algorithms passed in POST data&#39;</span>
            <span class="k">if</span> <span class="n">algorithms_count</span> <span class="o">&gt;</span> <span class="n">VORTEX_MAX_ALGORITHMS</span><span class="p">:</span>
                <span class="n">algorithms_err</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> algorithms passed in POST data, max allowed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">algorithms_count</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">VORTEX_MAX_ALGORITHMS</span><span class="p">))</span>
            <span class="c1"># Allow FLUX_SELF_API_KEY requests to breach maximum</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">FLUX_SELF_API_KEY</span><span class="p">:</span>
                <span class="n">algorithms_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">algorithms_err</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_parameters&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to add entry to Redis set flux.listen.discarded.invalid_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">algorithms_err</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: request_id: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="c1"># Determine if the POST data has a metric and timeseries element</span>
            <span class="n">invalid_timestamp_err_message</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">post_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;timeseries&#39;</span><span class="p">]:</span>
                <span class="n">bad_element</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">bad_format</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">invalid_time_format</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">timeseries_list</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">timeseries_dict</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="n">post_key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">LOCAL_DEBUG</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: listen :: vortex :: </span><span class="si">%s</span><span class="s1"> is set in the POST data&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_key</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: </span><span class="si">%s</span><span class="s1"> was not passed in the request POST data - returning 400 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">post_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">bad_element</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">bad_element</span> <span class="ow">and</span> <span class="n">post_key</span> <span class="o">==</span> <span class="s1">&#39;timeseries&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">bad_element</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: </span><span class="si">%s</span><span class="s1"> was not passed as a list or dict - returning 400&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">post_key</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">timeseries_list</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">timeseries_dict</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">bad_element</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">timeseries_list</span><span class="p">:</span>
                                <span class="n">first_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">timeseries_dict</span><span class="p">:</span>
                                <span class="n">first_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">invalid_time_format</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">bad_element</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">invalid_timestamp_err_message</span> <span class="o">=</span> <span class="s1">&#39;invalid timestamps in </span><span class="si">%s</span><span class="s1">, expected unix timestamps&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">post_key</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: </span><span class="si">%s</span><span class="s1"> does not contain unix timestamps - returning 400 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">post_key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">bad_element</span><span class="p">:</span>
                    <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_parameters&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to add entry to Redis set flux.listen.discarded.invalid_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;invalid </span><span class="si">%s</span><span class="s1"> element&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">invalid_time_format</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">invalid_timestamp_err_message</span><span class="p">)</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                    <span class="k">return</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: handling request_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
            <span class="n">original_request_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">original_request_id</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_id</span>
            <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;metric_namespace_prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_namespace_prefix</span>
            <span class="n">added_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="n">shard_test</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">VORTEX_ALLOWED_SHARD_TEST_KEYS</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shard_test</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;shard_test&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">shard_test</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: shard_test: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">shard_test</span><span class="p">))</span>
                        <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;shard_test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shard_test</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">shard_test</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">shard_test</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;added&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">added_at</span>
            <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;source_app&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flux&#39;</span>

            <span class="n">wait_for</span> <span class="o">=</span> <span class="mi">60</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wait_for</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">wait_for</span> <span class="o">=</span> <span class="mi">60</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">wait_for</span> <span class="o">=</span> <span class="mi">60</span>

            <span class="n">local_metric</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">shost</span> <span class="o">=</span> <span class="n">this_host</span>

            <span class="n">authorized_shard_request</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">shard_request</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shard_request</span> <span class="o">=</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;shard_request&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">shard_request</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">shard_request</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shard_request</span> <span class="o">==</span> <span class="n">FLUX_SELF_API_KEY</span><span class="p">:</span>
                    <span class="n">authorized_shard_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;warning :: listen :: vortex :: unauthorized shard request made - postData (excl. timeseries):  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">))</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_403</span>
                    <span class="k">return</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;shard_request&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                    <span class="k">return</span>
            <span class="k">if</span> <span class="n">authorized_shard_request</span> <span class="ow">and</span> <span class="n">original_request_id</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: authorized_shard_request so switching back to the original_request_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">original_request_id</span><span class="p">))</span>
                <span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">original_request_id</span><span class="p">)</span>
                <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_id</span>

            <span class="n">processing_shard</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">shost</span> <span class="o">=</span> <span class="n">this_host</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">authorized_shard_request</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">HORIZON_SHARDS</span> <span class="ow">or</span> <span class="n">HORIZON_TEST_SHARDS</span> <span class="ow">or</span> <span class="n">shard_test</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
                        <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;originating_shard&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HORIZON_SHARD</span>
                        <span class="n">shost</span> <span class="o">=</span> <span class="n">shard_host</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">HORIZON_SHARDS</span><span class="p">)</span>
                        <span class="n">processing_shard</span> <span class="o">=</span> <span class="n">HORIZON_SHARDS</span><span class="p">[</span><span class="n">shost</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">HORIZON_TEST_SHARDS</span> <span class="ow">and</span> <span class="n">shard_test</span><span class="p">:</span>
                        <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;horizon_test_shard&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;originating_shard&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HORIZON_TEST_SHARD</span>
                        <span class="n">shost</span> <span class="o">=</span> <span class="n">shard_host</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">)</span>
                        <span class="n">processing_shard</span> <span class="o">=</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">[</span><span class="n">shost</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">shost</span> <span class="o">!=</span> <span class="n">this_host</span><span class="p">:</span>
                        <span class="n">local_metric</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;processing_shard&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processing_shard</span>
                    <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;shard_host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shost</span>
                    <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;origin_host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">host</span>
                    <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;origin_scheme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">scheme</span>
                    <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;shard_request&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FLUX_SELF_API_KEY</span>

<span class="c1">#            postData[&#39;local_metric&#39;] = local_metric</span>
<span class="c1">#            postData[&#39;origin_host&#39;] = req.host</span>
<span class="c1">#            postData[&#39;origin_scheme&#39;] = req.scheme</span>
<span class="c1">#            postData[&#39;origin_uri&#39;] = req.uri</span>
<span class="c1">#            postData[&#39;origin_url&#39;] = req.url</span>

            <span class="k">if</span> <span class="n">VORTEX_TIMESERIES_JSON_TO_DISK</span> <span class="ow">and</span> <span class="n">local_metric</span><span class="p">:</span>
                <span class="n">jsonfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/flux/vortex/data/</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_DIR</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Using a JSON string</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">postData</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsonfile</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to save request json to </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">jsonfile</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="n">shard_results_url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">added</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">local_metric</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">added</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s1">&#39;flux.vortex&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">added</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: added </span><span class="si">%s</span><span class="s1"> to flux.vortex&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to add entry to Redis hash flux.vortex - </span><span class="si">%s</span><span class="s1">, postData (excl timeseries): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">)))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: returning 500&#39;</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Send request to shardOffload to shard</span>
                <span class="n">origin_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
                <span class="n">origin_hostname</span> <span class="o">=</span> <span class="n">origin_host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">origin_fqdn</span> <span class="o">=</span> <span class="n">origin_host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">original_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                <span class="n">processing_shard_url</span> <span class="o">=</span> <span class="n">original_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">origin_hostname</span><span class="p">,</span> <span class="n">shost</span><span class="p">)</span>

                <span class="c1"># @added 20230502 - Feature #4732: flux vortex</span>
                <span class="c1">#                   Feature #4734: mirage_vortex</span>
                <span class="c1"># Handle cluster fqdn being different from the hostname</span>
                <span class="c1"># by determining the URL FQDN from REMOTE_SKYLINE_INSTANCES</span>
                <span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
                    <span class="n">processing_shard_fqdn_url</span> <span class="o">=</span> <span class="n">shard_host</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">HORIZON_SHARDS</span><span class="p">,</span> <span class="n">return_fqdn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">processing_shard_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/flux/vortex&#39;</span> <span class="o">%</span> <span class="n">processing_shard_fqdn_url</span>
                <span class="k">if</span> <span class="n">HORIZON_TEST_SHARDS</span> <span class="ow">and</span> <span class="n">shard_test</span><span class="p">:</span>
                    <span class="n">processing_shard_fqdn_url</span> <span class="o">=</span> <span class="n">shard_host</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">,</span> <span class="n">return_fqdn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">processing_shard_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/flux/vortex&#39;</span> <span class="o">%</span> <span class="n">processing_shard_fqdn_url</span>

                <span class="c1"># Handle reverse proxy stripping flux</span>
                <span class="k">if</span> <span class="s1">&#39;flux/vortex&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">processing_shard_url</span><span class="p">:</span>
                    <span class="n">processing_shard_url</span> <span class="o">=</span> <span class="n">processing_shard_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;vortex&#39;</span><span class="p">,</span> <span class="s1">&#39;flux/vortex&#39;</span><span class="p">)</span>
                <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;shard_host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shost</span>
                <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;processing_shard_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processing_shard_url</span>
                <span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: making shard processing request to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">processing_shard_url</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;content-encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;gzip&#39;</span><span class="p">,</span> <span class="s2">&quot;content-type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
                    <span class="n">request_body</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">postData</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="n">r_timeout</span> <span class="o">=</span> <span class="n">wait_for</span> <span class="o">-</span> <span class="mi">5</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">processing_shard_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request_body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">r_timeout</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: shard processing request got response with code </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to make shard request to </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">processing_shard_url</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: returning 500&#39;</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">response_json</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                        <span class="n">shard_results_url</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;results_url&#39;</span><span class="p">]</span>
                        <span class="n">retries</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: got shard_results_url: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">shard_results_url</span><span class="p">))</span>
                        <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to get results_url from shard response - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">err</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: returning 500&#39;</span><span class="p">)</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="n">shard_results_url</span><span class="p">:</span>
                        <span class="n">added</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">added</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="n">local_metric</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to add entry to Redis hash flux.vortex, postData (excl timeseries): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to add shard processing request, postData (excl timeseries): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: returning 500&#39;</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                <span class="k">return</span>

            <span class="n">time_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">local_metric</span> <span class="ow">and</span> <span class="n">authorized_shard_request</span><span class="p">:</span>
                <span class="n">end_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: accepted shard request took </span><span class="si">%.6f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">end_request_timer</span> <span class="o">-</span> <span class="n">start_request_timer</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to calculate request time - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">/flux/vortex_results?request_id=</span><span class="si">%s</span><span class="s1">&amp;retries=-1&amp;timeout=</span><span class="si">%s</span><span class="s1">&amp;shard=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wait_for</span> <span class="o">-</span> <span class="mi">5</span><span class="p">),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="s1">&#39;processing_shard&#39;</span><span class="p">]))</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;results_url&#39;</span><span class="p">:</span> <span class="n">results_url</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to return results_url - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                    <span class="k">return</span>
                <span class="k">return</span>

            <span class="c1"># Return immediately, do not hold the request open waiting for the</span>
            <span class="c1"># result as this causes all the workers to be unavailable.  Return</span>
            <span class="c1"># the 303 redirect to /flux/vortex_results</span>
            <span class="n">end_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: request took </span><span class="si">%.6f</span><span class="s1"> seconds to process&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">end_request_timer</span> <span class="o">-</span> <span class="n">start_request_timer</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to calculate request time - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;/flux/vortex_results?request_id=</span><span class="si">%s</span><span class="s1">&amp;retries=1&amp;timeout=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wait_for</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">authorized_shard_request</span><span class="p">:</span>
                <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;shard=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="s1">&#39;processing_shard&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">shard_results_url</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;shard=&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uri</span><span class="p">:</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;shard=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="s1">&#39;processing_shard&#39;</span><span class="p">]))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: returning request_id: </span><span class="si">%s</span><span class="s1">, redirecting to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">request_id</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_for</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">uri</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_303</span>
                <span class="c1"># raise falcon.HTTPSeeOther(&#39;/flux/vortex_results&#39;, headers={&#39;request_id&#39;: request_id, &#39;retries&#39;: 1, &#39;timeout&#39;: wait_for})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: raise falcon.HTTPSeeOther - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                <span class="k">return</span>
            <span class="k">return</span>

            <span class="k">while</span> <span class="n">time_now</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">post_req_start</span> <span class="o">+</span> <span class="n">wait_for</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">result_str</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">local_metric</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result_str</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;mirage.vortex&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result_str</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">results</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">result_str</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to literal_eval </span><span class="si">%s</span><span class="s1"> data from mirage.vortex - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to get results for </span><span class="si">%s</span><span class="s1">, postData (excl timeseries): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">)))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: returning 500&#39;</span><span class="p">)</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                            <span class="k">return</span>
                    <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">time_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s%s</span><span class="s1">/flux/vortex_results?request_id=</span><span class="si">%s</span><span class="s1">&amp;retries=-1&amp;timeout=</span><span class="si">%s</span><span class="s1">&amp;shard=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">req</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="n">origin_fqdn</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wait_for</span> <span class="o">-</span> <span class="mi">5</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">processing_shard</span><span class="p">))</span>
                        <span class="n">new_shard_results_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;retries=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shard_results_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">retries</span><span class="p">))</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new_shard_results_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">r_timeout</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to request shard_results_url: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">shard_results_url</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to get results for </span><span class="si">%s</span><span class="s1">, postData (excl timeseries): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">)))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: returning 500&#39;</span><span class="p">)</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">results</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                            <span class="k">if</span> <span class="s1">&#39;results&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                                <span class="k">break</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to get results from response from shard_results_url: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">shard_results_url</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">time_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">end_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: request took </span><span class="si">%.6f</span><span class="s1"> seconds to process&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">end_request_timer</span> <span class="o">-</span> <span class="n">start_request_timer</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to calculate request time - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;/flux/vortex_results?request_id=</span><span class="si">%s</span><span class="s1">&amp;retries=1&amp;timeout=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wait_for</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">authorized_shard_request</span><span class="p">:</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;shard=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">postData</span><span class="p">[</span><span class="s1">&#39;processing_shard&#39;</span><span class="p">]))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: no results for request_id: </span><span class="si">%s</span><span class="s1">, redirecting to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_for</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">uri</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_303</span>
                    <span class="c1"># raise falcon.HTTPSeeOther(&#39;/flux/vortex_results&#39;, headers={&#39;request_id&#39;: request_id, &#39;retries&#39;: 1, &#39;timeout&#39;: wait_for})</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: raise falcon.HTTPSeeOther - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                    <span class="k">return</span>
                <span class="k">return</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;timeseries&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="c1"># Remove the key</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;mirage.vortex&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: vortex :: failed to hdel </span><span class="si">%s</span><span class="s1"> from mirage.vortex - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

                <span class="n">postData_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">postData</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">postData_keys</span><span class="p">:</span>
                        <span class="n">postData</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                <span class="n">remove_keys</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;shard_request&#39;</span><span class="p">,</span> <span class="s1">&#39;processing_shard_url&#39;</span><span class="p">,</span> <span class="s1">&#39;shard_host&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;origin_host&#39;</span><span class="p">,</span> <span class="s1">&#39;origin_scheme&#39;</span><span class="p">,</span> <span class="s1">&#39;local_metric&#39;</span><span class="p">,</span> <span class="s1">&#39;origin_uri&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;origin_url&#39;</span><span class="p">,</span> <span class="s1">&#39;shard_test&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">remove_key</span> <span class="ow">in</span> <span class="n">remove_keys</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">postData</span><span class="p">[</span><span class="n">remove_key</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">postData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="n">remove_key</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">postData</span><span class="p">)</span>

            <span class="n">end_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: request_id: </span><span class="si">%s</span><span class="s1">, took </span><span class="si">%.6f</span><span class="s1"> seconds to process&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="p">(</span><span class="n">end_request_timer</span> <span class="o">-</span> <span class="n">start_request_timer</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: vortex :: failed to calculate request time - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: request failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex :: returning 500&#39;</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
            <span class="k">return</span>

        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_204</span>
        <span class="k">return</span></div></div>


<span class="c1"># @added 20221118 - Feature #4732: flux vortex</span>
<span class="c1">#                   Feature #4734: mirage_vortex</span>
<div class="viewcode-block" id="VortexResults"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.VortexResults">[docs]</a><span class="k">class</span> <span class="nc">VortexResults</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<div class="viewcode-block" id="VortexResults.on_get"><a class="viewcode-back" href="../../skyline.flux.html#flux.listen.VortexResults.on_get">[docs]</a>    <span class="k">def</span> <span class="nf">on_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The /flux/vortex_results endpoint is called via a GET with headers and a</span>
<span class="sd">        URI parameter of retries.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># @modified 20230510 Feature #4732: flux vortex</span>
        <span class="c1">#                    Feature #4734: mirage_vortex</span>
        <span class="c1"># Handle cluster fqdn being different from the hostname</span>
        <span class="c1"># by determining the URL FQDN from REMOTE_SKYLINE_INSTANCES</span>
        <span class="c1"># def shard_host(metric, check_horizon_shards):</span>
        <span class="k">def</span> <span class="nf">shard_fqdn</span><span class="p">(</span><span class="n">shard</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the fqdn of the shard</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">shost</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">HORIZON_SHARDS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">shard</span> <span class="o">==</span> <span class="n">HORIZON_SHARDS</span><span class="p">[</span><span class="n">shost</span><span class="p">]:</span>
                    <span class="k">break</span>
            
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">REMOTE_SKYLINE_INSTANCES</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shost</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">start_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
        <span class="n">start_request</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

        <span class="n">validGetArguments</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">,</span> <span class="s1">&#39;retries&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;shard&#39;</span><span class="p">]</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="mi">29</span>
        <span class="n">shard</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;query_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">request_param_key</span><span class="p">,</span> <span class="n">request_param_value</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">validGetArguments</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex_results :: invalid key in request arguments - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>
                        <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_parameters&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex_results :: failed to add entry to Redis set flux.listen.discarded.invalid_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

                        <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Invalid parameter received - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                        <span class="k">return</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex_results :: validating request arguments - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>

                    <span class="c1"># @added 20210511 - Feature #4060: skyline.flux.worker.discarded metrics</span>
                    <span class="n">unique_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.listen.discarded.invalid_parameters&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">FLUX_VERBOSE_LOGGING</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: added </span><span class="si">%s</span><span class="s1"> to Redis set flux.listen.discarded.invalid_parameters&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_value</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex_results :: failed to add entry to Redis set flux.listen.discarded.invalid_parameters - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

                    <span class="c1"># @added 20220118 - Feature #4380: flux - return reason with 400</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Invalid parameters&#39;</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                    <span class="k">return</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;request_id&#39;</span><span class="p">:</span>
                        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;retries&#39;</span><span class="p">:</span>
                        <span class="n">retries</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span>
                        <span class="n">wait_for</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex_results :: could not validate the </span><span class="si">%s</span><span class="s1"> key in the GET request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                    <span class="k">return</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;shard&#39;</span><span class="p">:</span>
                        <span class="n">shard</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">request_param_value</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex_results :: could not validate the </span><span class="si">%s</span><span class="s1"> key in the GET request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">request_param_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">)))</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                    <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">request_id</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query_string</span><span class="p">))</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no request_id&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
                <span class="k">return</span>

            <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">shard_request</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">local_shard_number</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">shost</span> <span class="o">=</span> <span class="n">this_host</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shard</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">shard_request</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">shard_request</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">HORIZON_SHARDS</span> <span class="ow">or</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
                        <span class="n">local_shard_number</span> <span class="o">=</span> <span class="n">HORIZON_SHARDS</span><span class="p">[</span><span class="n">this_host</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">local_shard_number</span> <span class="o">!=</span> <span class="n">shard</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">hshost</span> <span class="ow">in</span> <span class="n">HORIZON_SHARDS</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">HORIZON_SHARDS</span><span class="p">[</span><span class="n">hshost</span><span class="p">]</span> <span class="o">==</span> <span class="n">shard</span><span class="p">:</span>
                                    <span class="n">shost</span> <span class="o">=</span> <span class="n">hshost</span>
                                    <span class="k">break</span>
                    <span class="k">if</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">:</span>
                        <span class="n">local_shard_number</span> <span class="o">=</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">[</span><span class="n">this_host</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">local_shard_number</span> <span class="o">!=</span> <span class="n">shard</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">hshost</span> <span class="ow">in</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">[</span><span class="n">hshost</span><span class="p">]</span> <span class="o">==</span> <span class="n">shard</span><span class="p">:</span>
                                    <span class="n">shost</span> <span class="o">=</span> <span class="n">hshost</span>
                                    <span class="k">break</span>
                        <span class="k">if</span> <span class="n">shost</span> <span class="o">!=</span> <span class="n">this_host</span><span class="p">:</span>
                            <span class="n">shost</span> <span class="o">=</span> <span class="n">this_host</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">shard_request</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: request_id: </span><span class="si">%s</span><span class="s1">, retries: </span><span class="si">%s</span><span class="s1">, timeout: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">retries</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">wait_for</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: request_id: </span><span class="si">%s</span><span class="s1">, retries: </span><span class="si">%s</span><span class="s1">, timeout: </span><span class="si">%s</span><span class="s1">, shard: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">retries</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">wait_for</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">shard</span><span class="p">)))</span>

            <span class="n">time_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">time_now</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">start_request</span> <span class="o">+</span> <span class="n">wait_for</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">result_str</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">shost</span> <span class="o">==</span> <span class="n">this_host</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result_str</span> <span class="o">=</span> <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s1">&#39;mirage.vortex&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result_str</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">results</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">result_str</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex_results :: failed to literal_eval </span><span class="si">%s</span><span class="s1"> data from mirage.vortex - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">request_id</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: returning 500&#39;</span><span class="p">)</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                            <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">origin_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
                    <span class="n">origin_hostname</span> <span class="o">=</span> <span class="n">origin_host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># origin_fqdn = origin_host.split(&#39;.&#39;, maxsplit=1)[1]</span>
                    <span class="n">original_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                    <span class="n">processing_shard_url</span> <span class="o">=</span> <span class="n">original_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">origin_hostname</span><span class="p">,</span> <span class="n">shost</span><span class="p">)</span>

                    <span class="c1"># @added 20230502 - Feature #4732: flux vortex</span>
                    <span class="c1">#                   Feature #4734: mirage_vortex</span>
                    <span class="c1"># Handle cluster fqdn being different from the hostname</span>
                    <span class="c1"># by determining the URL FQDN from REMOTE_SKYLINE_INSTANCES</span>
                    <span class="n">origin_host_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">shard_request</span><span class="p">:</span>
                        <span class="n">processing_shard_fqdn_url</span> <span class="o">=</span> <span class="n">shard_fqdn</span><span class="p">(</span><span class="n">shard</span><span class="p">)</span>
                        <span class="n">processing_shard_url</span> <span class="o">=</span> <span class="n">original_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">origin_host_url</span><span class="p">,</span> <span class="n">processing_shard_fqdn_url</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;flux/vortex&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">processing_shard_url</span><span class="p">:</span>
                        <span class="n">processing_shard_url</span> <span class="o">=</span> <span class="n">processing_shard_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;vortex&#39;</span><span class="p">,</span> <span class="s1">&#39;flux/vortex&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">retries</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">HORIZON_TEST_SHARDS</span><span class="p">:</span>
                        <span class="n">r_timeout</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">r_timeout</span> <span class="o">=</span> <span class="n">wait_for</span> <span class="o">-</span> <span class="mi">5</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">processing_shard_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">r_timeout</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex_results :: failed to request processing_shard_url: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">processing_shard_url</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: returning 500&#39;</span><span class="p">)</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">results</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                            <span class="k">if</span> <span class="s1">&#39;results&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                                <span class="k">break</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex :: failed to get results from response from processing_shard_url: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">processing_shard_url</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                    <span class="c1"># Remove the key</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">redis_conn_decoded</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s1">&#39;mirage.vortex&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

                    <span class="n">remove_keys</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s1">&#39;shard_request&#39;</span><span class="p">,</span> <span class="s1">&#39;processing_shard_url&#39;</span><span class="p">,</span> <span class="s1">&#39;shard_host&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;origin_host&#39;</span><span class="p">,</span> <span class="s1">&#39;origin_scheme&#39;</span><span class="p">,</span> <span class="s1">&#39;local_metric&#39;</span><span class="p">,</span> <span class="s1">&#39;origin_uri&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;origin_url&#39;</span><span class="p">,</span> <span class="s1">&#39;shard_test&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">remove_key</span> <span class="ow">in</span> <span class="n">remove_keys</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">results</span><span class="p">[</span><span class="n">remove_key</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="n">remove_key</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                    <span class="k">break</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">time_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">end_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: request took </span><span class="si">%.6f</span><span class="s1"> seconds to process before redirection&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">end_request_timer</span> <span class="o">-</span> <span class="n">start_request_timer</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex_results :: failed to calculate request time - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">retries</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">retry_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">/flux/vortex_results?request_id=</span><span class="si">%s</span><span class="s1">&amp;timeout=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wait_for</span><span class="p">))</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;request_id&#39;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
                        <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;No results were returned . The request can be retried later, results will be available for 1 hour.&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;retry_url&#39;</span><span class="p">:</span> <span class="n">retry_url</span><span class="p">}</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                    <span class="n">end_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: request_id: </span><span class="si">%s</span><span class="s1"> no results returned after 3 retries, took </span><span class="si">%.6f</span><span class="s1"> seconds to process&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">request_id</span><span class="p">,</span> <span class="p">(</span><span class="n">end_request_timer</span> <span class="o">-</span> <span class="n">start_request_timer</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to calculate request time - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
                    <span class="k">return</span>

                <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;/flux/vortex_results?request_id=</span><span class="si">%s</span><span class="s1">&amp;retries=</span><span class="si">%s</span><span class="s1">&amp;timeout=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">retries</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">wait_for</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">shard_request</span><span class="p">:</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;shard=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">shard</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: no results for request_id: </span><span class="si">%s</span><span class="s1">, redirecting to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_for</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">uri</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_303</span>
                <span class="k">return</span>

            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>

            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">end_request_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: request_id: </span><span class="si">%s</span><span class="s1"> results returned, took </span><span class="si">%.6f</span><span class="s1"> seconds to process&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span> <span class="p">(</span><span class="n">end_request_timer</span> <span class="o">-</span> <span class="n">start_request_timer</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: failed to calculate request time - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
            <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_400</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
            <span class="k">return</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: listen :: vortex_results :: request failed - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;listen :: vortex_results :: returning 500&#39;</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_500</span>
            <span class="k">return</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>