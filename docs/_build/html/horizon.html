<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Horizon &mdash; Skyline 4.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="_static/skyline.styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Analyzer" href="analyzer.html" />
    <link rel="prev" title="Strictly increasing monotonicity" href="monotonic-metrics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Skyline
          </a>
              <div class="version">
                4.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="anomify-cutting-edge-skyline.html">Anomify - cutting edge Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Horizon</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#listeners">Listeners</a></li>
<li class="toctree-l2"><a class="reference internal" href="#workers">Workers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#roombas">Roombas</a></li>
<li class="toctree-l2"><a class="reference internal" href="#horizon-shards">HORIZON_SHARDS</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="ionosphere_inference.html">Ionosphere inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="ionosphere_learn_repetitive_patterns.html">Ionosphere learning from repetitive patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="vortex.html">Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="thunder/index.html">Thunder</a></li>
<li class="toctree-l1"><a class="reference internal" href="vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="SNAB.html">SNAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="external_settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.EXTERNAL_SETTINGS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="skyline_metrics.html"><span class="skyblue">Sky</span><span class="red">line</span> metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="opentelemetry.html">opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Trouble shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="whats-new.html">What’s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="skyline.html">skyline package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Skyline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Horizon</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/horizon.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="horizon">
<h1>Horizon<a class="headerlink" href="#horizon" title="Permalink to this heading"></a></h1>
<p>The Horizon service is responsible for collecting, cleaning, and formatting
incoming data. It consists of Listeners, Workers, and Roombas. Horizon can be
started, stopped, and restarted with the <cite>bin/horizon.d</cite> script.</p>
<section id="listeners">
<h2>Listeners<a class="headerlink" href="#listeners" title="Permalink to this heading"></a></h2>
<p>Listeners are responsible for listening to incoming data. There are currently
two types: a TCP-pickle listener on port 2024, and a UDP-messagepack listener
on port 2025. The Listeners are easily extendible. Once they read a metric from
their respective sockets, they put it on a shared queue that the Workers read
from. For more on the Listeners, see [Getting Data Into Skyline](getting-data-into-skyline.html).</p>
</section>
<section id="workers">
<h2>Workers<a class="headerlink" href="#workers" title="Permalink to this heading"></a></h2>
<p>The workers are responsible for processing metrics off the queue and inserting
them into Redis. They work by popping metrics off of the queue, encoding them
into Messagepack, and appending them onto the respective Redis key of the metric.</p>
</section>
<section id="roombas">
<h2>Roombas<a class="headerlink" href="#roombas" title="Permalink to this heading"></a></h2>
<p>The Roombas are responsible for trimming and cleaning the data in Redis. You
will only have a finite amount of memory on your server, and so if you just let
the Workers append all day long, you would run out of memory. The Roomba cycles
through each metric in Redis and cuts it down so it is as long as
<cite>settings.FULL_DURATION</cite>. It also dedupes and purges old metrics.</p>
</section>
<section id="horizon-shards">
<h2>HORIZON_SHARDS<a class="headerlink" href="#horizon-shards" title="Permalink to this heading"></a></h2>
<p>This is an advanced feature related to running multiple, distributed Skyline
servers (and Graphite instances) in a replicated fashion.  This allows for all
the Skyline servers to receiver all metrics but only analyze those metrics that
are assigned to the specific server (shard).  This enables all Skyline servers
that are running Horizon to receive the entire metric population stream from
multiple Graphite carbon-relays and have Horizon drop (not submit to their Redis
instance) any metrics that do not belong to their shard.</p>
<p>In order to achieve this replicated configuration, Graphite also needs to be
configured and run appropriately to allow the metrics to be forwarded to the
remote Graphite servers.  To achieve this an additional carbon-relay-b instance
needs to be run on each Graphite server.  This additional carbon-relay-b
receives metrics from all the other Graphite servers and only relays them to the
Horizon shard listen process (default port 2026) and the local Graphite
carbon-cache.  The primary Graphite carbon-relay process on each Graphite server
relays metrics to the normal horizon listen process (default port 2024), to the
local carbon-cache and to each remote carbon-relay-b instance.</p>
<p>The carbon-relay-b only relays metrics locally.</p>
<p>This Graphite/Horizon mesh configuration achieves:</p>
<ul class="simple">
<li><p>all metrics on all Graphite servers</p></li>
<li><p>each Skyline server receiving all metrics</p></li>
<li><p>each Skyline server Horizon only submitting the metrics assigned to its shard
for analysis</p></li>
</ul>
<p>This allows the cluster to be reconfigured to should any server or service fail.
If a Skyline server/shard is lost/fails, it can be removed from the
<a class="reference internal" href="skyline.html#settings.HORIZON_SHARDS" title="settings.HORIZON_SHARDS"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.HORIZON_SHARDS</span></code></a> and the metric population will be resharded to
only the remaining online shards.  Although the Skyline shard server will not
have the metrics from the other shard in Redis, with the
<a class="reference internal" href="skyline.html#settings.MIRAGE_AUTOFILL_TOOSHORT" title="settings.MIRAGE_AUTOFILL_TOOSHORT"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.MIRAGE_AUTOFILL_TOOSHORT</span></code></a> feature enabled, the Skyline Analyzer
process will automatically initiate population of the FULL_DURATION data into
its Redis datastore by adding the newly assigned metrics to mirage.populate_redis
Redis set (queue).  Mirage will then populate Redis with the FULL_DURATION data
from Graphite.</p>
<p>When the shards reassignment is in process, the Skyline cluster should be
considered to be running in a degraded state until the failed shard is brought
back online and all shard reassignment is complete.  For this configuration to
work in times of failure each Skyline server in the cluster must be able to
handle (number_of_metrics_per_shard + (100/number_of_horizon_shards)) to handle
a failure and shard reassignment.  Using other appropriate load management
Skyline configuration options like <a class="reference internal" href="skyline.html#settings.ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS" title="settings.ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.ANALYZER_DYNAMICALLY_ANALYZE_LOW_PRIORITY_METRICS</span></code></a>
and possibly adjusting the namespaces in <a class="reference internal" href="skyline.html#settings.SKYLINE_FEEDBACK_NAMESPACES" title="settings.SKYLINE_FEEDBACK_NAMESPACES"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.SKYLINE_FEEDBACK_NAMESPACES</span></code></a>,
etc allows Skyline to manage the load in a best effort manage until the cluster
has been restored to normal configuration.</p>
<p>There are many other different configuration strategies that can be employed run
achieve HA and clustering with Skyline and Graphite which can augment the
management of load and failover such as haproxy, MariaDB Galera clustering, etc.
However, the Skyline/Graphite clustering design outlined here is aimed at
ensuring that each Skyline/Graphite server has all the data and can handle any
shard assignment.</p>
<p>HORIZON_SHARDS related settings.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">HORIZON_SHARDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;skyline-server-1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;skyline-server-2&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;skyline-server-3&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">HORIZON_SHARD_PICKLE_PORT</span> <span class="o">=</span> <span class="mi">2026</span>
</pre></div>
</div>
<p>Shards are 0 indexed.</p>
<p>If enabled the metric population is divided between the <code class="docutils literal notranslate"><span class="pre">number_of_horizon_shards</span></code>
declared in <a class="reference internal" href="skyline.html#settings.HORIZON_SHARDS" title="settings.HORIZON_SHARDS"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.HORIZON_SHARDS</span></code></a> by calculating the <code class="docutils literal notranslate"><span class="pre">zlib.alder32</span></code>
hash value (an integer) and applying a modulo to it to determine if the metric
belongs to the Horizon shard number assigned to that server.</p>
<p>Although <code class="docutils literal notranslate"><span class="pre">zlib.alder32</span></code> is not a cryptographic hash it is <strong>fast</strong> and
computes the same value across all Python version and platforms so it does the
job.  Further the distribution of metrics is not an exact equal division of the
metrics, but it is good enough.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="monotonic-metrics.html" class="btn btn-neutral float-left" title="Strictly increasing monotonicity" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="analyzer.html" class="btn btn-neutral float-right" title="Analyzer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2023, Gary Wilson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>